<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fraction Explorer: Adventure Learning Game</title>
    <style>
        /* Base Styles */
        body {
            font-family: 'Arial Rounded MT Bold', 'Arial', sans-serif;
            background-color: #f0f8ff;
            margin: 0;
            padding: 0;
            overflow: hidden;
            color: #333;
        }
        
        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            max-width: 1200px;
            margin: 0 auto;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
        }
        
        /* Character Styles */
        .character {
            position: absolute;
            transition: transform 0.5s ease;
        }
        
        .character-bubble {
            position: absolute;
            background-color: white;
            border-radius: 15px;
            padding: 10px 15px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            max-width: 250px;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 10;
        }
        
        /* Screen Styles */
        .screen {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease;
            opacity: 0;
            pointer-events: none;
            background-size: cover;
            background-position: center;
            padding: 20px;
            box-sizing: border-box;
        }
        
        .screen.visible {
            opacity: 1;
            pointer-events: all;
        }
        
        .screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        /* Welcome Screen */
        #welcomeScreen {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            text-align: center;
        }
        
        #welcomeScreen h1 {
            font-size: 3em;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.4);
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        /* Game Screen */
        #gameScreen {
            background: linear-gradient(to bottom, #a1c4fd 0%, #c2e9fb 100%);
        }
        
        /* Quiz Screen */
        #quizScreen {
            background: linear-gradient(to bottom, #fbc2eb 0%, #a6c1ee 100%);
            padding-top: 50px;
        }
        
        /* Reward Screen */
        #rewardScreen {
            background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
            text-align: center;
        }
        
        /* Button Styles */
        .button {
            background-color: #4b0082;
            color: white;
            border: none;
            border-radius: 30px;
            padding: 12px 30px;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            font-family: 'Arial Rounded MT Bold', 'Arial', sans-serif;
        }
        
        .button:hover {
            background-color: #6a0dad;
            transform: translateY(-3px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.3);
        }
        
        .button:active {
            transform: translateY(1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        /* Display Elements */
        .display-box {
            background-color: white;
            border-radius: 15px;
            padding: 20px;
            margin: 10px 0;
            width: 80%;
            max-width: 600px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .title {
            font-size: 1.8em;
            color: #4b0082;
            margin-bottom: 15px;
        }
        
        /* Fraction Representation */
        .fraction-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 20px 0;
        }
        
        .fraction-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        .fraction {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0 15px;
            font-size: 2em;
            color: #4b0082;
        }
        
        .numerator, .denominator {
            padding: 5px 15px;
        }
        
        .fraction-line {
            width: 100%;
            height: 3px;
            background-color: #4b0082;
            margin: 5px 0;
        }
        
        /* Visual Representation */
        #fractionVisual {
            width: 300px;
            height: 300px;
            position: relative;
            margin: 20px auto;
        }
        
        /* Quiz Options */
        .quiz-options {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin: 20px 0;
        }
        
        .quiz-option {
            background-color: white;
            border: 2px solid #4b0082;
            border-radius: 15px;
            padding: 10px 20px;
            margin: 10px;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .quiz-option:hover {
            background-color: #f0e6ff;
            transform: scale(1.05);
        }
        
        .quiz-option.selected {
            background-color: #d0b6fa;
            transform: scale(1.1);
        }
        
        .quiz-option.correct {
            background-color: #a1ffa1;
            border-color: #00aa00;
        }
        
        .quiz-option.incorrect {
            background-color: #ffb6b6;
            border-color: #aa0000;
        }
        
        /* Learning Path */
        .learning-path {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
            width: 80%;
            max-width: 600px;
        }
        
        .path-segment {
            width: 30px;
            height: 30px;
            margin: 0 10px;
            background-color: #ccc;
            border-radius: 50%;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .path-segment.completed {
            background-color: #00aa00;
        }
        
        .path-segment.current {
            background-color: #4b0082;
            transform: scale(1.2);
            box-shadow: 0 0 10px rgba(75, 0, 130, 0.5);
        }
        
        /* Parameter Controls */
        .parameter-controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin: 20px 0;
            width: 80%;
            max-width: 600px;
        }
        
        .parameter-control {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 10px;
            width: 150px;
        }
        
        .parameter-label {
            font-size: 1em;
            margin-bottom: 5px;
            color: #4b0082;
        }
        
        .parameter-value {
            font-size: 1.2em;
            margin-bottom: 5px;
            color: #333;
        }
        
        .parameter-slider {
            width: 100%;
            margin-top: 5px;
        }
        
        /* Hint System */
        .hint {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background-color: white;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            max-width: 300px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        /* Celebration Effects */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .star {
            position: absolute;
            opacity: 1;
            pointer-events: none;
            z-index: 100;
        }
        
        .bubble {
            position: absolute;
            border-radius: 50%;
            pointer-events: none;
            z-index: 100;
        }
        
        /* Responsive Styles */
        @media (max-width: 768px) {
            .display-box {
                width: 95%;
            }
            
            .fraction {
                font-size: 1.5em;
            }
            
            #fractionVisual {
                width: 200px;
                height: 200px;
            }
            
            .button {
                padding: 10px 20px;
                font-size: 1em;
            }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <!-- Welcome Screen -->
        <div id="welcomeScreen" class="screen visible">
            <h1>Fraction Explorer</h1>
            <div class="display-box">
                <div class="title">Welcome to the Fraction Adventure!</div>
                <p>Join Professor Numerator and Frac the Explorer as you discover the amazing world of fractions!</p>
                <p>Learn how parts make a whole and solve exciting fraction puzzles!</p>
            </div>
            <button id="startButton" class="button">Start Adventure!</button>
        </div>
        
        <!-- Game Screen -->
        <div id="gameScreen" class="screen hidden">
            <div class="learning-path" id="learningPath"></div>
            <div class="display-box">
                <div class="title" id="levelTitle">Level 1: Introduction to Fractions</div>
                <div class="fraction-display">
                    <div class="fraction-wrapper">
                        <div class="fraction">
                            <div class="numerator" id="fractionNumerator">1</div>
                            <div class="fraction-line"></div>
                            <div class="denominator" id="fractionDenominator">2</div>
                        </div>
                    </div>
                    <div id="fractionVisual"></div>
                </div>
                <p id="fractionDescription">A fraction shows part of a whole. The number on top (numerator) tells us how many parts we have. The number on the bottom (denominator) tells us how many equal parts make up the whole.</p>
            </div>
            <div class="parameter-controls">
                <div class="parameter-control">
                    <div class="parameter-label">Numerator</div>
                    <div class="parameter-value" id="numeratorValue">1</div>
                    <input type="range" min="1" max="10" value="1" class="parameter-slider" id="numeratorSlider">
                </div>
                <div class="parameter-control">
                    <div class="parameter-label">Denominator</div>
                    <div class="parameter-value" id="denominatorValue">2</div>
                    <input type="range" min="2" max="12" value="2" class="parameter-slider" id="denominatorSlider">
                </div>
                <div class="parameter-control">
                    <div class="parameter-label">Visualization</div>
                    <select id="visualizationSelect">
                        <option value="pie">Pie Chart</option>
                        <option value="bar">Bars</option>
                        <option value="grid">Grid</option>
                        <option value="number-line">Number Line</option>
                    </select>
                </div>
            </div>
            <div class="button-container">
                <button id="hintButton" class="button">Hint</button>
                <button id="quizButton" class="button">Take Quiz</button>
            </div>
            <div id="hintText" class="hint">Try changing the numerator and denominator to see how the fraction changes!</div>
        </div>
        
        <!-- Quiz Screen -->
        <div id="quizScreen" class="screen hidden">
            <div class="display-box">
                <div class="title">Fraction Quiz Challenge</div>
                <div id="quizQuestion">What fraction of the shape is colored?</div>
                <div id="quizVisual" style="margin: 20px auto;"></div>
                <div class="quiz-options" id="quizOptions"></div>
            </div>
            <button id="checkAnswerButton" class="button">Check Answer</button>
            <div id="quizProfessorBubble" class="character-bubble" style="bottom: 150px; left: 50%; transform: translateX(-50%);">Select your answer!</div>
        </div>
        
        <!-- Reward Screen -->
        <div id="rewardScreen" class="screen hidden">
            <div class="display-box">
                <div class="title">Great Job!</div>
                <div id="rewardText">You're amazing with fractions!</div>
                <div id="rewardAnimation"></div>
            </div>
            <button id="continueButton" class="button">Continue Learning</button>
        </div>
        
        <!-- Characters -->
        <div id="professorCharacter" class="character" style="bottom: 20px; left: 20px; display: none;">
            <div id="professorBubble" class="character-bubble" style="bottom: 150px; left: 50px;"></div>
        </div>
        <div id="fracCharacter" class="character" style="bottom: 20px; right: 20px; display: none;">
            <div id="fracBubble" class="character-bubble" style="bottom: 150px; right: 50px;"></div>
        </div>
    </div>

    <script>
        // Audio Context for Sound Effects
        let audioContext;
        
        // Initialize Audio Context on user interaction
        document.addEventListener('click', function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                document.removeEventListener('click', initAudio);
            }
        }, { once: true });
        
        // Game State
        const gameState = {
            currentLevel: 1,
            maxLevel: 5,
            progress: 0,
            score: 0,
            currentQuiz: {
                question: "",
                options: [],
                correctAnswer: "",
                userAnswer: ""
            },
            settings: {
                soundVolume: 0.5,
                visualType: "pie"
            },
            animations: {
                stars: [],
                bubbles: [],
                timers: []
            }
        };
        
        // DOM Elements
        const elements = {
            screens: {
                welcomeScreen: document.getElementById('welcomeScreen'),
                gameScreen: document.getElementById('gameScreen'),
                quizScreen: document.getElementById('quizScreen'),
                rewardScreen: document.getElementById('rewardScreen')
            },
            buttons: {
                startButton: document.getElementById('startButton'),
                hintButton: document.getElementById('hintButton'),
                quizButton: document.getElementById('quizButton'),
                checkAnswerButton: document.getElementById('checkAnswerButton'),
                continueButton: document.getElementById('continueButton')
            },
            displays: {
                levelTitle: document.getElementById('levelTitle'),
                fractionNumerator: document.getElementById('fractionNumerator'),
                fractionDenominator: document.getElementById('fractionDenominator'),
                fractionDescription: document.getElementById('fractionDescription'),
                fractionVisual: document.getElementById('fractionVisual'),
                numeratorValue: document.getElementById('numeratorValue'),
                denominatorValue: document.getElementById('denominatorValue'),
                visualizationSelect: document.getElementById('visualizationSelect'),
                quizQuestion: document.getElementById('quizQuestion'),
                quizVisual: document.getElementById('quizVisual'),
                quizOptions: document.getElementById('quizOptions'),
                rewardText: document.getElementById('rewardText'),
                rewardAnimation: document.getElementById('rewardAnimation'),
                learningPath: document.getElementById('learningPath'),
                hintText: document.getElementById('hintText')
            },
            controls: {
                numeratorSlider: document.getElementById('numeratorSlider'),
                denominatorSlider: document.getElementById('denominatorSlider')
            },
            characters: {
                professorCharacter: document.getElementById('professorCharacter'),
                fracCharacter: document.getElementById('fracCharacter'),
                professorBubble: document.getElementById('professorBubble'),
                fracBubble: document.getElementById('fracBubble'),
                quizProfessorBubble: document.getElementById('quizProfessorBubble')
            }
        };
        
        // Level Data
        const levelData = [
            {
                title: "Level 1: Introduction to Fractions",
                description: "A fraction shows part of a whole. The number on top (numerator) tells us how many parts we have. The number on the bottom (denominator) tells us how many equal parts make up the whole.",
                defaultFraction: { numerator: 1, denominator: 2 },
                visualization: "pie"
            },
            {
                title: "Level 2: Equivalent Fractions",
                description: "Equivalent fractions are fractions that represent the same value, even though they look different. For example, 1/2 is equivalent to 2/4 and 3/6.",
                defaultFraction: { numerator: 1, denominator: 2 },
                visualization: "bar"
            },
            {
                title: "Level 3: Comparing Fractions",
                description: "We can compare fractions to see which is greater. Fractions with the same denominator are easy to compare - just look at the numerators!",
                defaultFraction: { numerator: 3, denominator: 4 },
                visualization: "pie"
            },
            {
                title: "Level 4: Adding Fractions",
                description: "When adding fractions with the same denominator, we add the numerators but keep the denominator the same.",
                defaultFraction: { numerator: 1, denominator: 4 },
                visualization: "bar"
            },
            {
                title: "Level 5: Fractions in Real Life",
                description: "Fractions are everywhere! We use them for cooking (1/2 cup of sugar), telling time (quarter past eight), and sharing (half of a pizza).",
                defaultFraction: { numerator: 3, denominator: 4 },
                visualization: "grid"
            }
        ];
        
        // Quiz Data
        const quizData = [
            {
                type: "identify",
                generate: function() {
                    const denominator = Math.floor(Math.random() * 4) + 2; // 2 to 5
                    const numerator = Math.floor(Math.random() * (denominator - 1)) + 1; // 1 to denominator-1
                    
                    return {
                        question: "What fraction of the shape is colored?",
                        visual: { type: "pie", numerator, denominator },
                        options: generateOptions(numerator, denominator),
                        correctAnswer: `${numerator}/${denominator}`
                    };
                }
            },
            {
                type: "equivalent",
                generate: function() {
                    const baseDenominator = Math.floor(Math.random() * 4) + 2; // 2 to 5
                    const baseNumerator = Math.floor(Math.random() * (baseDenominator - 1)) + 1; // 1 to denominator-1
                    const multiplier = Math.floor(Math.random() * 3) + 2; // 2 to 4
                    
                    return {
                        question: `Which fraction is equivalent to ${baseNumerator}/${baseDenominator}?`,
                        visual: { type: "bar", numerator: baseNumerator, denominator: baseDenominator },
                        options: generateEquivalentOptions(baseNumerator, baseDenominator, multiplier),
                        correctAnswer: `${baseNumerator * multiplier}/${baseDenominator * multiplier}`
                    };
                }
            },
            {
                type: "compare",
                generate: function() {
                    const denominator = Math.floor(Math.random() * 4) + 2; // 2 to 5
                    const numerator1 = Math.floor(Math.random() * (denominator - 1)) + 1; // 1 to denominator-1
                    let numerator2;
                    
                    do {
                        numerator2 = Math.floor(Math.random() * (denominator - 1)) + 1;
                    } while (numerator2 === numerator1);
                    
                    const fraction1 = `${numerator1}/${denominator}`;
                    const fraction2 = `${numerator2}/${denominator}`;
                    
                    return {
                        question: `Which fraction is greater?`,
                        visual: { type: "comparison", numerator1, numerator2, denominator },
                        options: [fraction1, fraction2],
                        correctAnswer: numerator1 > numerator2 ? fraction1 : fraction2
                    };
                }
            },
            {
                type: "addition",
                generate: function() {
                    const denominator = Math.floor(Math.random() * 4) + 2; // 2 to 5
                    const numerator1 = Math.floor(Math.random() * (denominator - 1)) + 1; // 1 to denominator-1
                    const numerator2 = Math.floor(Math.random() * (denominator - numerator1)) + 1; // Ensure sum <= denominator
                    const sum = numerator1 + numerator2;
                    
                    return {
                        question: `What is ${numerator1}/${denominator} + ${numerator2}/${denominator}?`,
                        visual: { type: "addition", numerator1, numerator2, denominator },
                        options: generateAdditionOptions(numerator1, numerator2, denominator),
                        correctAnswer: `${sum}/${denominator}`
                    };
                }
            },
            {
                type: "realLife",
                generate: function() {
                    const scenarios = [
                        {
                            question: "If you eat 2 pieces of a pizza that has 8 equal slices, what fraction of the pizza have you eaten?",
                            options: ["2/8", "6/8", "2/6", "1/4"],
                            correctAnswer: "2/8"
                        },
                        {
                            question: "If a recipe calls for 3/4 cup of sugar and you want to make half the recipe, how much sugar do you need?",
                            options: ["3/8 cup", "6/4 cup", "1/4 cup", "2/4 cup"],
                            correctAnswer: "3/8 cup"
                        },
                        {
                            question: "If you've completed 3 out of 5 homework problems, what fraction of your homework have you completed?",
                            options: ["2/5", "3/5", "3/8", "2/3"],
                            correctAnswer: "3/5"
                        }
                    ];
                    
                    const scenario = scenarios[Math.floor(Math.random() * scenarios.length)];
                    
                    return {
                        question: scenario.question,
                        visual: { type: "realLife" },
                        options: scenario.options,
                        correctAnswer: scenario.correctAnswer
                    };
                }
            }
        ];
        
        // Generate Options for Identify Quiz
        function generateOptions(numerator, denominator) {
            const correctAnswer = `${numerator}/${denominator}`;
            const options = [correctAnswer];
            
            // Add incorrect options
            while (options.length < 4) {
                let newNumerator = Math.floor(Math.random() * denominator) + 1;
                let newDenominator = Math.floor(Math.random() * 6) + 2; // 2 to 7
                
                const newOption = `${newNumerator}/${newDenominator}`;
                
                if (!options.includes(newOption) && newOption !== correctAnswer) {
                    options.push(newOption);
                }
            }
            
            return shuffleArray(options);
        }
        
        // Generate Options for Equivalent Fractions Quiz
        function generateEquivalentOptions(numerator, denominator, multiplier) {
            const correctAnswer = `${numerator * multiplier}/${denominator * multiplier}`;
            const options = [correctAnswer];
            
            // Add incorrect options
            while (options.length < 4) {
                let newNumerator = Math.floor(Math.random() * 10) + 1;
                let newDenominator = Math.floor(Math.random() * 10) + 2;
                
                // Ensure it's not equivalent
                if (newNumerator / newDenominator !== numerator / denominator) {
                    const newOption = `${newNumerator}/${newDenominator}`;
                    
                    if (!options.includes(newOption)) {
                        options.push(newOption);
                    }
                }
            }
            
            return shuffleArray(options);
        }
        
        // Generate Options for Addition Quiz
        function generateAdditionOptions(numerator1, numerator2, denominator) {
            const sum = numerator1 + numerator2;
            const correctAnswer = `${sum}/${denominator}`;
            const options = [correctAnswer];
            
            // Add incorrect options
            options.push(`${numerator1 + numerator2}/${denominator + 1}`); // Wrong denominator
            options.push(`${numerator1 * numerator2}/${denominator}`); // Multiplication instead of addition
            options.push(`${Math.abs(numerator1 - numerator2)}/${denominator}`); // Subtraction instead of addition
            
            return shuffleArray(options);
        }
        
        // Initialize Game
        function initGame() {
            // Create learning path
            createLearningPath();
            
            // Set up event listeners
            elements.buttons.startButton.addEventListener('click', startGame);
            elements.buttons.hintButton.addEventListener('click', toggleHint);
            elements.buttons.quizButton.addEventListener('click', startQuiz);
            elements.buttons.checkAnswerButton.addEventListener('click', checkQuizAnswer);
            elements.buttons.continueButton.addEventListener('click', continueGame);
            
            // Parameter controls
            elements.controls.numeratorSlider.addEventListener('input', updateFraction);
            elements.controls.denominatorSlider.addEventListener('input', updateFraction);
            elements.displays.visualizationSelect.addEventListener('change', updateVisualization);
            
            // Show the welcome screen
            showScreen('welcomeScreen');
        }
        
        // Start the game
        function startGame() {
            // Show professor character
            elements.characters.professorCharacter.style.display = 'block';
            elements.characters.fracCharacter.style.display = 'block';
            
            // Welcome message
            showMessage(elements.characters.professorBubble, "Welcome to Fraction Explorer! I'm Professor Numerator!");
            
            setTimeout(() => {
                showMessage(elements.characters.fracBubble, "And I'm Frac! We'll help you discover the amazing world of fractions!");
                
                setTimeout(() => {
                    // Load the first level
                    loadLevel(gameState.currentLevel);
                    
                    // Show the game screen
                    showScreen('gameScreen');
                }, 3000);
            }, 3000);
            
            // Play button sound
            playButtonSound();
        }
        
        // Load a level
        function loadLevel(level) {
            const levelIndex = level - 1;
            
            if (levelIndex >= 0 && levelIndex < levelData.length) {
                const currentLevel = levelData[levelIndex];
                
                // Set level title and description
                elements.displays.levelTitle.textContent = currentLevel.title;
                elements.displays.fractionDescription.textContent = currentLevel.description;
                
                // Set default fraction
                elements.controls.numeratorSlider.value = currentLevel.defaultFraction.numerator;
                elements.controls.denominatorSlider.value = currentLevel.defaultFraction.denominator;
                
                // Update display
                updateFraction();
                
                // Set visualization
                elements.displays.visualizationSelect.value = currentLevel.visualization;
                updateVisualization();
                
                // Update learning path
                updateLearningPath();
                
                // Show level introduction
                if (level === 1) {
                    setTimeout(() => {
                        showMessage(elements.characters.professorBubble, "Fractions show parts of a whole. Try changing the numerator and denominator!");
                    }, 1000);
                    
                    setTimeout(() => {
                        showMessage(elements.characters.fracBubble, "The top number (numerator) shows how many parts we have. The bottom number (denominator) shows the total number of equal parts.");
                    }, 4000);
                } else {
                    setTimeout(() => {
                        showMessage(elements.characters.professorBubble, currentLevel.description);
                    }, 1000);
                }
            }
        }
        
        // Update fraction display
        function updateFraction() {
            const numerator = parseInt(elements.controls.numeratorSlider.value);
            const denominator = parseInt(elements.controls.denominatorSlider.value);
            
            // Ensure numerator <= denominator
            if (numerator > denominator) {
                elements.controls.numeratorSlider.value = denominator;
                return updateFraction();
            }
            
            // Update display
            elements.displays.fractionNumerator.textContent = numerator;
            elements.displays.fractionDenominator.textContent = denominator;
            elements.displays.numeratorValue.textContent = numerator;
            elements.displays.denominatorValue.textContent = denominator;
            
            // Update visualization
            updateVisualization();
            
            // Play tick sound
            playTickSound();
        }
        
        // Update visualization
        function updateVisualization() {
            const visualType = elements.displays.visualizationSelect.value;
            const numerator = parseInt(elements.controls.numeratorSlider.value);
            const denominator = parseInt(elements.controls.denominatorSlider.value);
            
            // Clear previous visualization
            elements.displays.fractionVisual.innerHTML = '';
            
            // Create visualization based on type
            switch (visualType) {
                case "pie":
                    createPieVisualization(numerator, denominator);
                    break;
                case "bar":
                    createBarVisualization(numerator, denominator);
                    break;
                case "grid":
                    createGridVisualization(numerator, denominator);
                    break;
                case "number-line":
                    createNumberLineVisualization(numerator, denominator);
                    break;
            }
            
            // Play select sound
            playSelectSound();
        }
        
        // Create Pie Chart Visualization
        function createPieVisualization(numerator, denominator) {
            const container = elements.displays.fractionVisual;
            const size = container.clientWidth;
            const radius = size / 2 - 10;
            const centerX = size / 2;
            const centerY = size / 2;
            
            // Create SVG
            const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            svg.setAttribute("width", size);
            svg.setAttribute("height", size);
            
            // Create pie segments
            const angleStep = 2 * Math.PI / denominator;
            
            for (let i = 0; i < denominator; i++) {
                const startAngle = i * angleStep;
                const endAngle = (i + 1) * angleStep;
                
                // Calculate coordinates
                const x1 = centerX + radius * Math.cos(startAngle);
                const y1 = centerY + radius * Math.sin(startAngle);
                const x2 = centerX + radius * Math.cos(endAngle);
                const y2 = centerY + radius * Math.sin(endAngle);
                
                // Create path for arc
                const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                
                // Arc parameters
                const largeArcFlag = endAngle - startAngle <= Math.PI ? 0 : 1;
                
                // Path command
                const d = [
                    "M", centerX, centerY,
                    "L", x1, y1,
                    "A", radius, radius, 0, largeArcFlag, 1, x2, y2,
                    "Z"
                ].join(" ");
                
                path.setAttribute("d", d);
                path.setAttribute("fill", i < numerator ? "#4b0082" : "#e0e0e0");
                path.setAttribute("stroke", "white");
                path.setAttribute("stroke-width", "2");
                
                svg.appendChild(path);
            }
            
            container.appendChild(svg);
        }
        
        // Create Bar Visualization
        function createBarVisualization(numerator, denominator) {
            const container = elements.displays.fractionVisual;
            const width = container.clientWidth;
            const height = container.clientHeight;
            const barHeight = height - 20;
            const barWidth = width * 0.7;
            const segmentHeight = barHeight / denominator;
            
            // Create SVG
            const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            svg.setAttribute("width", width);
            svg.setAttribute("height", height);
            
            // Create segments
            for (let i = 0; i < denominator; i++) {
                const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                rect.setAttribute("x", (width - barWidth) / 2);
                rect.setAttribute("y", 10 + i * segmentHeight);
                rect.setAttribute("width", barWidth);
                rect.setAttribute("height", segmentHeight);
                rect.setAttribute("fill", i < numerator ? "#4b0082" : "#e0e0e0");
                rect.setAttribute("stroke", "white");
                rect.setAttribute("stroke-width", "1");
                
                svg.appendChild(rect);
            }
            
            container.appendChild(svg);
        }
        
        // Create Grid Visualization
        function createGridVisualization(numerator, denominator) {
            const container = elements.displays.fractionVisual;
            const size = container.clientWidth;
            
            // Calculate grid dimensions
            let cols, rows;
            
            if (denominator <= 4) {
                cols = 2;
                rows = 2;
            } else if (denominator <= 9) {
                cols = 3;
                rows = 3;
            } else if (denominator <= 16) {
                cols = 4;
                rows = 4;
            } else {
                cols = 5;
                rows = 5;
            }
            
            // Create SVG
            const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            svg.setAttribute("width", size);
            svg.setAttribute("height", size);
            
            // Cell size
            const cellSize = (size - 20) / Math.max(cols, rows);
            const offsetX = (size - cols * cellSize) / 2;
            const offsetY = (size - rows * cellSize) / 2;
            
            // Create grid cells
            let cellCount = 0;
            
            for (let row = 0; row < rows; row++) {
                for (let col = 0; col < cols; col++) {
                    if (cellCount < denominator) {
                        const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                        rect.setAttribute("x", offsetX + col * cellSize);
                        rect.setAttribute("y", offsetY + row * cellSize);
                        rect.setAttribute("width", cellSize);
                        rect.setAttribute("height", cellSize);
                        rect.setAttribute("fill", cellCount < numerator ? "#4b0082" : "#e0e0e0");
                        rect.setAttribute("stroke", "white");
                        rect.setAttribute("stroke-width", "2");
                        
                        svg.appendChild(rect);
                        cellCount++;
                    }
                }
            }
            
            container.appendChild(svg);
        }
        
        // Create Number Line Visualization
        function createNumberLineVisualization(numerator, denominator) {
            const container = elements.displays.fractionVisual;
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            // Create SVG
            const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            svg.setAttribute("width", width);
            svg.setAttribute("height", height);
            
            // Number line parameters
            const lineY = height / 2;
            const lineLength = width - 40;
            const lineStart = 20;
            const lineEnd = lineStart + lineLength;
            const tickHeight = 10;
            const tickSpacing = lineLength / denominator;
            
            // Draw main line
            const mainLine = document.createElementNS("http://www.w3.org/2000/svg", "line");
            mainLine.setAttribute("x1", lineStart);
            mainLine.setAttribute("y1", lineY);
            mainLine.setAttribute("x2", lineEnd);
            mainLine.setAttribute("y2", lineY);
            mainLine.setAttribute("stroke", "#333");
            mainLine.setAttribute("stroke-width", "2");
            svg.appendChild(mainLine);
            
            // Draw ticks and labels
            for (let i = 0; i <= denominator; i++) {
                const x = lineStart + i * tickSpacing;
                
                // Tick mark
                const tick = document.createElementNS("http://www.w3.org/2000/svg", "line");
                tick.setAttribute("x1", x);
                tick.setAttribute("y1", lineY - tickHeight);
                tick.setAttribute("x2", x);
                tick.setAttribute("y2", lineY + tickHeight);
                tick.setAttribute("stroke", "#333");
                tick.setAttribute("stroke-width", "2");
                svg.appendChild(tick);
                
                // Label
                const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
                text.setAttribute("x", x);
                text.setAttribute("y", lineY + tickHeight + 15);
                text.setAttribute("text-anchor", "middle");
                text.setAttribute("font-size", "12");
                text.textContent = i + "/" + denominator;
                svg.appendChild(text);
            }
            
            // Highlight the fraction
            if (numerator <= denominator) {
                const marker = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                marker.setAttribute("cx", lineStart + numerator * tickSpacing);
                marker.setAttribute("cy", lineY);
                marker.setAttribute("r", "8");
                marker.setAttribute("fill", "#4b0082");
                svg.appendChild(marker);
            }
            
            container.appendChild(svg);
        }
        
        // Start the Quiz
        function startQuiz() {
            // Show the quiz screen
            showScreen('quizScreen');
            
            // Generate quiz question
            generateQuizQuestion();
            
            // Play button sound
            playButtonSound();
        }
        
        // Generate Quiz Question
        function generateQuizQuestion() {
            // Clear previous answers
            gameState.currentQuiz.userAnswer = "";
            
            // Determine quiz type based on level
            const quizTypes = [
                ["identify"],                              // Level 1
                ["identify", "equivalent"],                // Level 2
                ["identify", "equivalent", "compare"],     // Level 3
                ["identify", "equivalent", "compare", "addition"], // Level 4
                ["identify", "equivalent", "compare", "addition", "realLife"] // Level 5
            ];
            
            const availableTypes = quizTypes[Math.min(gameState.currentLevel - 1, quizTypes.length - 1)];
            const quizType = availableTypes[Math.floor(Math.random() * availableTypes.length)];
            
            // Find the quiz generator
            const quiz = quizData.find(q => q.type === quizType);
            
            if (quiz) {
                // Generate quiz data
                const quizData = quiz.generate();
                
                // Store in game state
                gameState.currentQuiz.question = quizData.question;
                gameState.currentQuiz.options = quizData.options;
                gameState.currentQuiz.correctAnswer = quizData.correctAnswer;
                
                // Update display
                elements.displays.quizQuestion.textContent = quizData.question;
                
                // Create visual
                createQuizVisual(quizData.visual);
                
                // Create options
                createQuizOptions(quizData.options);
                
                // Show message
                showMessage(elements.characters.quizProfessorBubble, "Choose the correct answer!");
            }
        }
        
        // Create Quiz Visual
        function createQuizVisual(visualData) {
            const container = elements.displays.quizVisual;
            container.innerHTML = '';
            
            if (!visualData) return;
            
            switch (visualData.type) {
                case "pie":
                    createPieVisualization(visualData.numerator, visualData.denominator, container);
                    break;
                case "bar":
                    createBarVisualization(visualData.numerator, visualData.denominator, container);
                    break;
                case "comparison":
                    createComparisonVisual(visualData.numerator1, visualData.numerator2, visualData.denominator, container);
                    break;
                case "addition":
                    createAdditionVisual(visualData.numerator1, visualData.numerator2, visualData.denominator, container);
                    break;
                case "realLife":
                    createRealLifeVisual(container);
                    break;
            }
        }
        
        // Create Comparison Visual
        function createComparisonVisual(numerator1, numerator2, denominator, customContainer) {
            const container = customContainer || elements.displays.fractionVisual;
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            // Create SVG
            const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            svg.setAttribute("width", width);
            svg.setAttribute("height", height);
            
            // Two pie charts
            const pieSize = Math.min(width / 2 - 20, height - 40);
            const pieRadius = pieSize / 2;
            
            // First pie
            const centerX1 = width / 4;
            const centerY1 = height / 2;
            
            // Second pie
            const centerX2 = 3 * width / 4;
            const centerY2 = height / 2;
            
            // Create pie segments for first pie
            const angleStep = 2 * Math.PI / denominator;
            
            for (let i = 0; i < denominator; i++) {
                const startAngle = i * angleStep;
                const endAngle = (i + 1) * angleStep;
                
                // Calculate coordinates
                const x1 = centerX1 + pieRadius * Math.cos(startAngle);
                const y1 = centerY1 + pieRadius * Math.sin(startAngle);
                const x2 = centerX1 + pieRadius * Math.cos(endAngle);
                const y2 = centerY1 + pieRadius * Math.sin(endAngle);
                
                // Create path for arc
                const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                
                // Arc parameters
                const largeArcFlag = endAngle - startAngle <= Math.PI ? 0 : 1;
                
                // Path command
                const d = [
                    "M", centerX1, centerY1,
                    "L", x1, y1,
                    "A", pieRadius, pieRadius, 0, largeArcFlag, 1, x2, y2,
                    "Z"
                ].join(" ");
                
                path.setAttribute("d", d);
                path.setAttribute("fill", i < numerator1 ? "#4b0082" : "#e0e0e0");
                path.setAttribute("stroke", "white");
                path.setAttribute("stroke-width", "2");
                
                svg.appendChild(path);
            }
            
            // Create pie segments for second pie
            for (let i = 0; i < denominator; i++) {
                const startAngle = i * angleStep;
                const endAngle = (i + 1) * angleStep;
                
                // Calculate coordinates
                const x1 = centerX2 + pieRadius * Math.cos(startAngle);
                const y1 = centerY2 + pieRadius * Math.sin(startAngle);
                const x2 = centerX2 + pieRadius * Math.cos(endAngle);
                const y2 = centerY2 + pieRadius * Math.sin(endAngle);
                
                // Create path for arc
                const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                
                // Arc parameters
                const largeArcFlag = endAngle - startAngle <= Math.PI ? 0 : 1;
                
                // Path command
                const d = [
                    "M", centerX2, centerY2,
                    "L", x1, y1,
                    "A", pieRadius, pieRadius, 0, largeArcFlag, 1, x2, y2,
                    "Z"
                ].join(" ");
                
                path.setAttribute("d", d);
                path.setAttribute("fill", i < numerator2 ? "#4CAF50" : "#e0e0e0");
                path.setAttribute("stroke", "white");
                path.setAttribute("stroke-width", "2");
                
                svg.appendChild(path);
            }
            
            // Add labels
            const text1 = document.createElementNS("http://www.w3.org/2000/svg", "text");
            text1.setAttribute("x", centerX1);
            text1.setAttribute("y", 20);
            text1.setAttribute("text-anchor", "middle");
            text1.setAttribute("font-size", "16");
            text1.setAttribute("fill", "#4b0082");
            text1.textContent = `${numerator1}/${denominator}`;
            svg.appendChild(text1);
            
            const text2 = document.createElementNS("http://www.w3.org/2000/svg", "text");
            text2.setAttribute("x", centerX2);
            text2.setAttribute("y", 20);
            text2.setAttribute("text-anchor", "middle");
            text2.setAttribute("font-size", "16");
            text2.setAttribute("fill", "#4CAF50");
            text2.textContent = `${numerator2}/${denominator}`;
            svg.appendChild(text2);
            
            container.appendChild(svg);
        }
        
        // Create Addition Visual
        function createAdditionVisual(numerator1, numerator2, denominator, customContainer) {
            const container = customContainer || elements.displays.fractionVisual;
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            // Create SVG
            const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            svg.setAttribute("width", width);
            svg.setAttribute("height", height);
            
            // Three bars
            const barWidth = width / 3 - 20;
            const barHeight = height - 60;
            const segmentHeight = barHeight / denominator;
            
            // First bar
            for (let i = 0; i < denominator; i++) {
                const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                rect.setAttribute("x", 10);
                rect.setAttribute("y", 30 + i * segmentHeight);
                rect.setAttribute("width", barWidth);
                rect.setAttribute("height", segmentHeight);
                rect.setAttribute("fill", i < numerator1 ? "#4b0082" : "#e0e0e0");
                rect.setAttribute("stroke", "white");
                rect.setAttribute("stroke-width", "1");
                
                svg.appendChild(rect);
            }
            
            // Plus sign
            const plus = document.createElementNS("http://www.w3.org/2000/svg", "text");
            plus.setAttribute("x", width / 3 + 10);
            plus.setAttribute("y", height / 2);
            plus.setAttribute("text-anchor", "middle");
            plus.setAttribute("font-size", "24");
            plus.setAttribute("fill", "#333");
            plus.textContent = "+";
            svg.appendChild(plus);
            
            // Second bar
            for (let i = 0; i < denominator; i++) {
                const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                rect.setAttribute("x", width / 3 + 20);
                rect.setAttribute("y", 30 + i * segmentHeight);
                rect.setAttribute("width", barWidth);
                rect.setAttribute("height", segmentHeight);
                rect.setAttribute("fill", i < numerator2 ? "#4CAF50" : "#e0e0e0");
                rect.setAttribute("stroke", "white");
                rect.setAttribute("stroke-width", "1");
                
                svg.appendChild(rect);
            }
            
            // Equals sign
            const equals = document.createElementNS("http://www.w3.org/2000/svg", "text");
            equals.setAttribute("x", 2 * width / 3 + 10);
            equals.setAttribute("y", height / 2);
            equals.setAttribute("text-anchor", "middle");
            equals.setAttribute("font-size", "24");
            equals.setAttribute("fill", "#333");
            equals.textContent = "=";
            svg.appendChild(equals);
            
            // Third bar (result)
            for (let i = 0; i < denominator; i++) {
                const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                rect.setAttribute("x", 2 * width / 3 + 20);
                rect.setAttribute("y", 30 + i * segmentHeight);
                rect.setAttribute("width", barWidth);
                rect.setAttribute("height", segmentHeight);
                
                // Color based on contribution
                let fill = "#e0e0e0";
                if (i < numerator1) {
                    fill = "#4b0082";
                } else if (i < numerator1 + numerator2) {
                    fill = "#4CAF50";
                }
                
                rect.setAttribute("fill", fill);
                rect.setAttribute("stroke", "white");
                rect.setAttribute("stroke-width", "1");
                
                svg.appendChild(rect);
            }
            
            // Add labels
            const text1 = document.createElementNS("http://www.w3.org/2000/svg", "text");
            text1.setAttribute("x", barWidth / 2 + 10);
            text1.setAttribute("y", 20);
            text1.setAttribute("text-anchor", "middle");
            text1.setAttribute("font-size", "16");
            text1.setAttribute("fill", "#4b0082");
            text1.textContent = `${numerator1}/${denominator}`;
            svg.appendChild(text1);
            
            const text2 = document.createElementNS("http://www.w3.org/2000/svg", "text");
            text2.setAttribute("x", width / 3 + barWidth / 2 + 20);
            text2.setAttribute("y", 20);
            text2.setAttribute("text-anchor", "middle");
            text2.setAttribute("font-size", "16");
            text2.setAttribute("fill", "#4CAF50");
            text2.textContent = `${numerator2}/${denominator}`;
            svg.appendChild(text2);
            
            const text3 = document.createElementNS("http://www.w3.org/2000/svg", "text");
            text3.setAttribute("x", 2 * width / 3 + barWidth / 2 + 20);
            text3.setAttribute("y", 20);
            text3.setAttribute("text-anchor", "middle");
            text3.setAttribute("font-size", "16");
            text3.setAttribute("fill", "#333");
            text3.textContent = `?`;
            svg.appendChild(text3);
            
            container.appendChild(svg);
        }
        
        // Create Real Life Visual
        function createRealLifeVisual(customContainer) {
            const container = customContainer || elements.displays.fractionVisual;
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            // Create SVG
            const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            svg.setAttribute("width", width);
            svg.setAttribute("height", height);
            
            // Draw a pizza
            const centerX = width / 2;
            const centerY = height / 2;
            const radius = Math.min(width, height) / 2 - 20;
            
            // Pizza base (circle)
            const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            circle.setAttribute("cx", centerX);
            circle.setAttribute("cy", centerY);
            circle.setAttribute("r", radius);
            circle.setAttribute("fill", "#FFA500");
            circle.setAttribute("stroke", "#8B4513");
            circle.setAttribute("stroke-width", "3");
            svg.appendChild(circle);
            
            // Pizza slices (8 slices)
            const sliceCount = 8;
            const angleStep = 2 * Math.PI / sliceCount;
            
            for (let i = 0; i < sliceCount; i++) {
                const angle = i * angleStep;
                
                // Slice line
                const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                line.setAttribute("x1", centerX);
                line.setAttribute("y1", centerY);
                line.setAttribute("x2", centerX + radius * Math.cos(angle));
                line.setAttribute("y2", centerY + radius * Math.sin(angle));
                line.setAttribute("stroke", "#8B4513");
                line.setAttribute("stroke-width", "2");
                svg.appendChild(line);
                
                // Add pepperoni (random placement in each slice)
                for (let p = 0; p < 3; p++) {
                    const pepperoniRadius = radius / 10;
                    const distance = (Math.random() * 0.6 + 0.2) * radius;
                    const pepperoniAngle = angle + Math.random() * angleStep;
                    
                    const pepperoni = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                    pepperoni.setAttribute("cx", centerX + distance * Math.cos(pepperoniAngle));
                    pepperoni.setAttribute("cy", centerY + distance * Math.sin(pepperoniAngle));
                    pepperoni.setAttribute("r", pepperoniRadius);
                    pepperoni.setAttribute("fill", "#FF0000");
                    svg.appendChild(pepperoni);
                }
            }
            
            // Label
            const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
            text.setAttribute("x", centerX);
            text.setAttribute("y", centerY - radius - 10);
            text.setAttribute("text-anchor", "middle");
            text.setAttribute("font-size", "18");
            text.setAttribute("fill", "#333");
            text.textContent = "Pizza with 8 slices";
            svg.appendChild(text);
            
            container.appendChild(svg);
        }
        
        // Create Quiz Options
        function createQuizOptions(options) {
            const container = elements.displays.quizOptions;
            container.innerHTML = '';
            
            options.forEach(option => {
                const optionElement = document.createElement('div');
                optionElement.className = 'quiz-option';
                optionElement.textContent = option;
                optionElement.addEventListener('click', function() {
                    selectQuizOption(this);
                });
                container.appendChild(optionElement);
            });
        }
        
        // Select a quiz option
        function selectQuizOption(optionElement) {
            // Clear any previous selections
            const options = elements.displays.quizOptions.querySelectorAll('.quiz-option');
            options.forEach(option => {
                option.classList.remove('selected');
            });
            
            // Select the clicked option
            optionElement.classList.add('selected');
            
            // Store user's answer
            gameState.currentQuiz.userAnswer = optionElement.textContent;
        }
        
        // Check quiz answer
        function checkQuizAnswer() {
            if (!gameState.currentQuiz.userAnswer) {
                // No answer selected
                showMessage(elements.characters.quizProfessorBubble, "Please select an answer first!");
                return;
            }
            
            // Check if the answer is correct
            if (gameState.currentQuiz.userAnswer === gameState.currentQuiz.correctAnswer) {
                // Correct answer
                playSuccessSound();
                createParticleEffect();
                
                // Show celebration message
                showMessage(elements.characters.quizProfessorBubble, "Excellent! That's correct!");
                
                // Increment score
                gameState.score++;
                
                // Proceed to next question or end quiz
                if (gameState.score >= 5) {
                    // Quiz completed
                    setTimeout(() => {
                        completeQuiz();
                    }, 2000);
                } else {
                    // Next question
                    setTimeout(() => {
                        generateQuizQuestion();
                    }, 2000);
                }
            } else {
                // Incorrect answer
                playErrorSound();
                
                // Show hint message
                showMessage(elements.characters.quizProfessorBubble, `Not quite. The correct answer is ${gameState.currentQuiz.correctAnswer}.`);
                
                // Highlight correct answer
                const options = elements.displays.quizOptions.querySelectorAll('.quiz-option');
                options.forEach(option => {
                    if (option.textContent === gameState.currentQuiz.correctAnswer) {
                        option.classList.add('correct');
                    } else if (option.classList.contains('selected')) {
                        option.classList.add('incorrect');
                    }
                });
                
                // Next question after delay
                setTimeout(() => {
                    generateQuizQuestion();
                }, 3000);
            }
        }
        
        // Complete the quiz
        function completeQuiz() {
            // Show reward screen
            showScreen('rewardScreen');
            
            // Set reward text based on score
            if (gameState.score >= 5) {
                elements.displays.rewardText.textContent = "Amazing! You're a Fraction Master!";
            } else if (gameState.score >= 3) {
                elements.displays.rewardText.textContent = "Great job! You're getting really good with fractions!";
            } else {
                elements.displays.rewardText.textContent = "Good effort! Keep practicing to master fractions!";
            }
            
            // Create celebration animation
            createRewardAnimation();
        }
        
        // Continue game after quiz
        function continueGame() {
            // Reset game state for next session
            gameState.currentLevel = Math.min(gameState.currentLevel + 1, gameState.maxLevel);
            gameState.score = 0;
            gameState.progress = 0;
            
            // Load the next level
            loadLevel(gameState.currentLevel);
            
            // Show the game screen
            showScreen('gameScreen');
        }
        
        // Show a screen
        function showScreen(screenName) {
            // Hide all screens
            Object.values(elements.screens).forEach(screen => {
                screen.classList.remove('visible');
                screen.classList.add('hidden');
            });
            
            // Show the requested screen
            elements.screens[screenName].classList.remove('hidden');
            elements.screens[screenName].classList.add('visible');
        }
        
        // Toggle hint visibility
        function toggleHint() {
            const hintText = elements.displays.hintText;
            
            if (hintText.style.opacity === '1') {
                hintText.style.opacity = '0';
            } else {
                hintText.style.opacity = '1';
                
                // Auto-hide after 5 seconds
                setTimeout(() => {
                    hintText.style.opacity = '0';
                }, 5000);
            }
        }
        
        // Show a character message
        function showMessage(bubbleElement, message) {
            // Set the message text
            bubbleElement.textContent = message;
            
            // Show the bubble
            bubbleElement.style.opacity = '1';
            
            // Auto-hide after delay based on message length
            const delay = Math.max(3000, message.length * 50);
            setTimeout(() => {
                bubbleElement.style.opacity = '0';
            }, delay);
        }
        
        // Create learning path
        function createLearningPath() {
            const pathContainer = elements.displays.learningPath;
            
            // Clear any existing segments
            pathContainer.innerHTML = '';
            
            // Create segments for each level
            for (let i = 0; i < gameState.maxLevel; i++) {
                const segment = document.createElement('div');
                segment.className = 'path-segment';
                segment.setAttribute('data-level', i + 1);
                pathContainer.appendChild(segment);
            }
        }
        
        // Update learning path
        function updateLearningPath() {
            const segments = elements.displays.learningPath.querySelectorAll('.path-segment');
            
            segments.forEach((segment, index) => {
                const level = index + 1;
                
                if (level < gameState.currentLevel) {
                    segment.className = 'path-segment completed';
                } else if (level === gameState.currentLevel) {
                    segment.className = 'path-segment current';
                } else {
                    segment.className = 'path-segment';
                }
            });
        }
        
        // Helper function to shuffle an array (Fisher-Yates algorithm)
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
        
        // Create celebration particle effect
        function createParticleEffect() {
            // Clear any existing particles
            clearParticles();
            
            // Create stars or bubbles
            const particleCount = 30;
            const particleTypes = ['star', 'bubble'];
            
            for (let i = 0; i < particleCount; i++) {
                const particleType = particleTypes[Math.floor(Math.random() * particleTypes.length)];
                createParticle(particleType);
            }
        }
        
        // Create a single particle
        function createParticle(type) {
            const container = document.getElementById('game-container');
            
            if (type === 'star') {
                // Create a star
                const star = document.createElement('div');
                star.className = 'star';
                
                // Random position
                const x = Math.random() * window.innerWidth;
                const y = Math.random() * window.innerHeight;
                
                // Random size
                const size = Math.random() * 30 + 10;
                
                // Star SVG
                star.innerHTML = `
                    <svg width="${size}" height="${size}" viewBox="0 0 51 48">
                        <path fill="#FFD700" d="m25,1 6,17h18l-14,11 5,17-15-10-15,10 5-17-14-11h18z"/>
                    </svg>
                `;
                
                star.style.left = `${x}px`;
                star.style.top = `${y}px`;
                container.appendChild(star);
                
                // Animation
                const angle = Math.random() * Math.PI * 2;
                const speed = Math.random() * 5 + 2;
                const dx = Math.cos(angle) * speed;
                const dy = Math.sin(angle) * speed;
                
                let opacity = 1;
                let posX = x;
                let posY = y;
                
                const animation = setInterval(() => {
                    opacity -= 0.01;
                    posX += dx;
                    posY += dy;
                    
                    star.style.opacity = opacity;
                    star.style.left = `${posX}px`;
                    star.style.top = `${posY}px`;
                    
                    if (opacity <= 0) {
                        clearInterval(animation);
                        star.remove();
                    }
                }, 20);
                
                gameState.animations.stars.push(star);
                gameState.animations.timers.push(animation);
            } else {
                // Create a bubble
                const bubble = document.createElement('div');
                bubble.className = 'bubble';
                
                // Random position
                const x = Math.random() * window.innerWidth;
                const y = window.innerHeight + 20;
                
                // Random size
                const size = Math.random() * 40 + 20;
                
                // Random color
                const colors = ['#FF9A00', '#4b0082', '#4CAF50', '#f44336', '#2196F3'];
                const color = colors[Math.floor(Math.random() * colors.length)];
                
                bubble.style.width = `${size}px`;
                bubble.style.height = `${size}px`;
                bubble.style.backgroundColor = color;
                bubble.style.left = `${x}px`;
                bubble.style.top = `${y}px`;
                bubble.style.opacity = '0.7';
                container.appendChild(bubble);
                
                // Animation
                const speed = Math.random() * 3 + 1;
                let posY = y;
                
                const animation = setInterval(() => {
                    posY -= speed;
                    bubble.style.top = `${posY}px`;
                    
                    if (posY < -size) {
                        clearInterval(animation);
                        bubble.remove();
                    }
                }, 20);
                
                gameState.animations.bubbles.push(bubble);
                gameState.animations.timers.push(animation);
            }
        }
        
        // Clear all particles
        function clearParticles() {
            // Clear all animation timers
            gameState.animations.timers.forEach(timer => {
                clearInterval(timer);
            });
            
            // Remove all stars and bubbles
            gameState.animations.stars.forEach(star => {
                if (star.parentNode) {
                    star.remove();
                }
            });
            
            gameState.animations.bubbles.forEach(bubble => {
                if (bubble.parentNode) {
                    bubble.remove();
                }
            });
            
            // Reset arrays
            gameState.animations.stars = [];
            gameState.animations.bubbles = [];
            gameState.animations.timers = [];
        }
        
        // Create reward animation
        function createRewardAnimation() {
            const container = elements.displays.rewardAnimation;
            
            // Clear container
            container.innerHTML = '';
            
            // Create canvas for celebration
            const canvas = document.createElement('canvas');
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            container.appendChild(canvas);
            
            const ctx = canvas.getContext('2d');
            
            // Characters
            const professorImage = createCharacterImage('professor');
            const fracImage = createCharacterImage('frac');
            
            // Draw characters
            ctx.drawImage(professorImage, 50, 50, 150, 150);
            ctx.drawImage(fracImage, canvas.width - 200, 50, 150, 150);
            
            // Celebration text
            ctx.font = '30px Arial, sans-serif';
            ctx.fillStyle = '#4b0082';
            ctx.textAlign = 'center';
            ctx.fillText('Congratulations!', canvas.width / 2, 50);
            
            // Trophy
            drawTrophy(ctx, canvas.width / 2, canvas.height / 2);
            
            // Start particle animation
            createParticleEffect();
            
            // Play celebration sound
            playCelebrationSound();
        }
        
        // Create character image
        function createCharacterImage(character) {
            const canvas = document.createElement('canvas');
            canvas.width = 150;
            canvas.height = 150;
            const ctx = canvas.getContext('2d');
            
            if (character === 'professor') {
                // Draw professor
                // Body
                ctx.fillStyle = '#1E88E5';
                ctx.beginPath();
                ctx.ellipse(75, 95, 30, 35, 0, 0, Math.PI * 2);
                ctx.fill();
                
                // Head
                ctx.fillStyle = '#FFD700';
                ctx.beginPath();
                ctx.arc(75, 45, 20, 0, Math.PI * 2);
                ctx.fill();
                
                // Eyes
                ctx.fillStyle = 'white';
                ctx.beginPath();
                ctx.arc(67, 40, 4, 0, Math.PI * 2);
                ctx.arc(83, 40, 4, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = 'black';
                ctx.beginPath();
                ctx.arc(67, 40, 2, 0, Math.PI * 2);
                ctx.arc(83, 40, 2, 0, Math.PI * 2);
                ctx.fill();
                
                // Glasses
                ctx.strokeStyle = 'black';
                ctx.lineWidth = 1.5;
                ctx.beginPath();
                ctx.arc(67, 40, 6, 0, Math.PI * 2);
                ctx.stroke();
                ctx.beginPath();
                ctx.arc(83, 40, 6, 0, Math.PI * 2);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(73, 40);
                ctx.lineTo(77, 40);
                ctx.stroke();
                
                // Smile
                ctx.beginPath();
                ctx.moveTo(65, 50);
                ctx.quadraticCurveTo(75, 60, 85, 50);
                ctx.stroke();
                
                // Beard
                ctx.fillStyle = '#A0522D';
                ctx.beginPath();
                ctx.moveTo(65, 55);
                ctx.quadraticCurveTo(75, 70, 85, 55);
                ctx.quadraticCurveTo(75, 60, 65, 55);
                ctx.fill();
                
                // Hair
                ctx.beginPath();
                ctx.moveTo(55, 35);
                ctx.quadraticCurveTo(75, 15, 95, 35);
                ctx.quadraticCurveTo(75, 25, 55, 35);
                ctx.fill();
                
                // Arms
                ctx.strokeStyle = '#FFD700';
                ctx.lineWidth = 5;
                ctx.lineCap = 'round';
                ctx.beginPath();
                ctx.moveTo(55, 85);
                ctx.lineTo(40, 75);
                ctx.moveTo(95, 85);
                ctx.lineTo(110, 75);
                ctx.stroke();
                
                // Legs
                ctx.strokeStyle = '#1E88E5';
                ctx.lineWidth = 8;
                ctx.beginPath();
                ctx.moveTo(65, 130);
                ctx.lineTo(60, 145);
                ctx.moveTo(85, 130);
                ctx.lineTo(90, 145);
                ctx.stroke();
            } else {
                // Draw Frac
                // Body
                ctx.fillStyle = '#FF6D00';
                ctx.beginPath();
                ctx.ellipse(75, 95, 25, 30, 0, 0, Math.PI * 2);
                ctx.fill();
                
                // Head
                ctx.fillStyle = '#FFEB3B';
                ctx.beginPath();
                ctx.arc(75, 45, 20, 0, Math.PI * 2);
                ctx.fill();
                
                // Eyes
                ctx.fillStyle = 'white';
                ctx.beginPath();
                ctx.arc(67, 40, 4, 0, Math.PI * 2);
                ctx.arc(83, 40, 4, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = 'black';
                ctx.beginPath();
                ctx.arc(67, 40, 2, 0, Math.PI * 2);
                ctx.arc(83, 40, 2, 0, Math.PI * 2);
                ctx.fill();
                
                // Smile
                ctx.beginPath();
                ctx.moveTo(65, 50);
                ctx.quadraticCurveTo(75, 60, 85, 50);
                ctx.stroke();
                
                // Arms
                ctx.strokeStyle = '#FFEB3B';
                ctx.lineWidth = 5;
                ctx.lineCap = 'round';
                ctx.beginPath();
                ctx.moveTo(55, 85);
                ctx.lineTo(40, 95);
                ctx.moveTo(95, 85);
                ctx.lineTo(110, 95);
                ctx.stroke();
                
                // Legs
                ctx.strokeStyle = '#FF6D00';
                ctx.lineWidth = 8;
                ctx.beginPath();
                ctx.moveTo(65, 125);
                ctx.lineTo(60, 140);
                ctx.moveTo(85, 125);
                ctx.lineTo(90, 140);
                ctx.stroke();
                
                // Fraction symbol
                ctx.strokeStyle = 'black';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(65, 30);
                ctx.lineTo(85, 30);
                ctx.stroke();
                
                ctx.fillStyle = 'black';
                ctx.font = '10px Arial, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('1', 75, 27);
                ctx.fillText('2', 75, 40);
            }
            
            return canvas;
        }
        
        // Draw trophy
        function drawTrophy(ctx, x, y) {
            // Trophy base
            ctx.fillStyle = '#FFD700';
            
            // Cup
            ctx.beginPath();
            ctx.moveTo(x - 30, y - 50);
            ctx.lineTo(x + 30, y - 50);
            ctx.quadraticCurveTo(x + 50, y - 50, x + 50, y - 30);
            ctx.quadraticCurveTo(x + 50, y, x + 30, y);
            ctx.quadraticCurveTo(x + 15, y + 10, x + 15, y + 30);
            ctx.lineTo(x - 15, y + 30);
            ctx.quadraticCurveTo(x - 15, y + 10, x - 30, y);
            ctx.quadraticCurveTo(x - 50, y, x - 50, y - 30);
            ctx.quadraticCurveTo(x - 50, y - 50, x - 30, y - 50);
            ctx.fill();
            
            // Base
            ctx.fillStyle = '#A67C00';
            ctx.beginPath();
            ctx.rect(x - 25, y + 30, 50, 10);
            ctx.fill();
            
            ctx.fillStyle = '#8D6E00';
            ctx.beginPath();
            ctx.rect(x - 35, y + 40, 70, 10);
            ctx.fill();
            
            // Fraction symbol
            ctx.strokeStyle = '#4b0082';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(x - 15, y - 20);
            ctx.lineTo(x + 15, y - 20);
            ctx.stroke();
            
            ctx.fillStyle = '#4b0082';
            ctx.font = '20px Arial, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('1', x, y - 25);
            ctx.fillText('2', x, y - 5);
        }
        
        // Sound functions
        function playButtonSound() {
            if (audioContext && gameState.settings.soundVolume > 0) {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
                
                gainNode.gain.setValueAtTime(gameState.settings.soundVolume, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.3);
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.3);
            }
        }
        
        function playTickSound() {
            if (audioContext && gameState.settings.soundVolume > 0) {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(880, audioContext.currentTime);
                
                gainNode.gain.setValueAtTime(gameState.settings.soundVolume * 0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.1);
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.1);
            }
        }
        
        function playSelectSound() {
            if (audioContext && gameState.settings.soundVolume > 0) {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(660, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(880, audioContext.currentTime + 0.1);
                
                gainNode.gain.setValueAtTime(gameState.settings.soundVolume * 0.5, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.2);
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.2);
            }
        }
        
        function playSuccessSound() {
            if (audioContext && gameState.settings.soundVolume > 0) {
                const notes = [523.25, 659.25, 783.99, 1046.50]; // C5, E5, G5, C6
                
                notes.forEach((frequency, index) => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime + index * 0.1);
                    
                    gainNode.gain.setValueAtTime(0, audioContext.currentTime + index * 0.1);
                    gainNode.gain.linearRampToValueAtTime(gameState.settings.soundVolume * 0.5, audioContext.currentTime + index * 0.1 + 0.01);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + index * 0.1 + 0.3);
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.start(audioContext.currentTime + index * 0.1);
                    oscillator.stop(audioContext.currentTime + index * 0.1 + 0.3);
                });
            }
        }
        
        function playErrorSound() {
            if (audioContext && gameState.settings.soundVolume > 0) {
                const frequencies = [349.23, 329.63, 311.13]; // F4, E4, D#4/Eb4
                
                frequencies.forEach((frequency, index) => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime + index * 0.15);
                    
                    gainNode.gain.setValueAtTime(0, audioContext.currentTime + index * 0.15);
                    gainNode.gain.linearRampToValueAtTime(gameState.settings.soundVolume * 0.5, audioContext.currentTime + index * 0.15 + 0.01);
                    gainNode.gain.linearRampToValueAtTime(0.001, audioContext.currentTime + index * 0.15 + 0.3);
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.start(audioContext.currentTime + index * 0.15);
                    oscillator.stop(audioContext.currentTime + index * 0.15 + 0.3);
                });
            }
        }
        
        function playCelebrationSound() {
            if (audioContext && gameState.settings.soundVolume > 0) {
                // Major scale ascending and then chord
                const notes = [
                    { freq: 523.25, time: 0 },    // C5
                    { freq: 587.33, time: 0.15 }, // D5
                    { freq: 659.25, time: 0.3 },  // E5
                    { freq: 698.46, time: 0.45 }, // F5
                    { freq: 783.99, time: 0.6 },  // G5
                    { freq: 880.00, time: 0.75 }, // A5
                    { freq: 987.77, time: 0.9 },  // B5
                    { freq: 1046.50, time: 1.05 }, // C6
                    // Final chord
                    { freq: 523.25, time: 1.3 }, // C5
                    { freq: 659.25, time: 1.3 }, // E5
                    { freq: 783.99, time: 1.3 }, // G5
                    { freq: 1046.50, time: 1.3 }  // C6
                ];
                
                notes.forEach(note => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(note.freq, audioContext.currentTime + note.time);
                    
                    gainNode.gain.setValueAtTime(0, audioContext.currentTime + note.time);
                    gainNode.gain.linearRampToValueAtTime(gameState.settings.soundVolume * 0.3, audioContext.currentTime + note.time + 0.01);
                    
                    // Longer sustain for the final chord
                    if (note.time === 1.3) {
                        gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + note.time + 1.0);
                        oscillator.start(audioContext.currentTime + note.time);
                        oscillator.stop(audioContext.currentTime + note.time + 1.0);
                    } else {
                        gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + note.time + 0.2);
                        oscillator.start(audioContext.currentTime + note.time);
                        oscillator.stop(audioContext.currentTime + note.time + 0.2);
                    }
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                });
            }
        }
        
        // Initialize the game when the window loads
        window.addEventListener('load', initGame);
    </script>
</body>
</html>
