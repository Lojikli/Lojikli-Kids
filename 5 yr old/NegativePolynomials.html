<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polynomial Adventure: The Quest for Positive Exponents</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.min.js"></script>
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #ff9a76;
            --tertiary-color: #6ecb63;
            --quaternary-color: #ffec5f;
            --background-color: #f5f5f5;
            --text-color: #333;
            --card-color: #ffffff;
            --success-color: #66bb6a;
            --error-color: #ef5350;
            --hint-color: #7986cb;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Arial Rounded MT Bold', 'Arial', sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            overflow-x: hidden;
            min-height: 100vh;
        }

        .game-container {
            display: flex;
            flex-direction: column;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            color: var(--primary-color);
            font-size: 36px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .character-container {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .character {
            width: 150px;
            height: 150px;
            position: relative;
            margin: 0 10px;
        }

        .character-speech {
            position: absolute;
            top: -80px;
            left: 50%;
            transform: translateX(-50%);
            background-color: white;
            padding: 10px 15px;
            border-radius: 15px;
            font-size: 14px;
            max-width: 200px;
            border: 2px solid var(--primary-color);
            box-shadow: 3px 3px 5px rgba(0, 0, 0, 0.1);
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .character-speech:after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 10px 10px 0;
            border-style: solid;
            border-color: white transparent transparent;
        }

        .visualization-container {
            width: 100%;
            height: 300px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .controls-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            margin-bottom: 20px;
            background-color: var(--card-color);
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .control-group {
            flex: 1;
            min-width: 250px;
            margin: 10px;
        }

        .control-title {
            font-size: 18px;
            color: var(--primary-color);
            margin-bottom: 10px;
            font-weight: bold;
        }

        .slider-container {
            margin-bottom: 15px;
        }

        .slider-label {
            display: block;
            margin-bottom: 5px;
        }

        .slider {
            width: 100%;
            height: 25px;
            background: #d3d3d3;
            outline: none;
            border-radius: 15px;
        }

        .quiz-container {
            background-color: var(--card-color);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .quiz-header {
            font-size: 24px;
            color: var(--primary-color);
            margin-bottom: 15px;
            text-align: center;
        }

        .problem-container {
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 10px;
        }

        .answer-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .term-answer {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #e9ecef;
            padding: 10px 15px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .fraction-input {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100px;
        }

        .numerator, .denominator {
            width: 80px;
            height: 40px;
            text-align: center;
            font-size: 18px;
            margin: 2px;
            border: 2px solid var(--primary-color);
            border-radius: 5px;
        }

        .fraction-line {
            width: 80px;
            height: 2px;
            background-color: black;
            margin: 5px 0;
        }

        .variable-input {
            width: 60px;
            height: 40px;
            font-size: 18px;
            text-align: center;
            margin: 2px;
            border: 2px solid var(--secondary-color);
            border-radius: 5px;
        }

        .exponent-input {
            width: 50px;
            height: 30px;
            font-size: 16px;
            text-align: center;
            margin: 2px;
            border: 2px solid var(--tertiary-color);
            border-radius: 5px;
            position: relative;
            top: -10px;
        }

        .variable-selector {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }

        .variable-btn {
            background-color: var(--quaternary-color);
            border: none;
            color: var(--text-color);
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: transform 0.1s, box-shadow 0.1s;
        }

        .variable-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .variable-btn:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .action-btns {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 24px;
            font-size: 18px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.1s, box-shadow 0.1s;
        }

        .check-btn {
            background-color: var(--success-color);
            color: white;
        }

        .hint-btn {
            background-color: var(--hint-color);
            color: white;
        }

        .new-problem-btn {
            background-color: var(--primary-color);
            color: white;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .btn:active {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .result-message {
            text-align: center;
            margin: 20px 0;
            font-size: 20px;
            padding: 10px;
            border-radius: 10px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .hint-panel {
            background-color: var(--hint-color);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }

        .hint-title {
            font-size: 18px;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .progress-container {
            margin-top: 20px;
            background-color: var(--card-color);
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .progress-title {
            font-size: 18px;
            color: var(--primary-color);
            margin-bottom: 10px;
            text-align: center;
        }

        .progress-bar-container {
            width: 100%;
            height: 30px;
            background-color: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background-color: var(--tertiary-color);
            width: 0%;
            transition: width 0.5s ease;
        }

        .score-display {
            text-align: right;
            margin-top: 5px;
            font-size: 16px;
            color: var(--text-color);
        }

        @media (max-width: 768px) {
            .header {
                font-size: 28px;
            }
            
            .visualization-container {
                height: 250px;
            }
            
            .control-group {
                min-width: 100%;
            }
            
            .problem-container {
                font-size: 20px;
            }
            
            .variable-btn {
                font-size: 16px;
                padding: 6px 10px;
            }
        }

        .character-svg {
            width: 100%;
            height: 100%;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: var(--card-color);
            margin: 10% auto;
            padding: 20px;
            border-radius: 15px;
            width: 80%;
            max-width: 600px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
        }

        .modal-title {
            color: var(--primary-color);
            font-size: 24px;
            margin-bottom: 15px;
        }

        .modal-text {
            font-size: 16px;
            line-height: 1.5;
            margin-bottom: 20px;
        }

        .character-info {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .character-img {
            width: 80px;
            height: 80px;
            margin-right: 15px;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1 class="header">Polynomial Adventure: The Quest for Positive Exponents</h1>
        
        <div class="character-container">
            <div class="character" id="professor-poly">
                <svg class="character-svg" viewBox="0 0 100 100">
                    <!-- Professor Poly -->
                    <circle cx="50" cy="50" r="40" fill="#4a6fa5" />
                    <circle cx="35" cy="40" r="5" fill="white" />
                    <circle cx="35" cy="40" r="2" fill="black" />
                    <circle cx="65" cy="40" r="5" fill="white" />
                    <circle cx="65" cy="40" r="2" fill="black" />
                    <path d="M 35 65 Q 50 75 65 65" stroke="white" stroke-width="3" fill="transparent" />
                    <ellipse cx="50" cy="30" rx="10" ry="5" fill="white" transform="rotate(-10, 50, 30)" />
                </svg>
                <div class="character-speech" id="professor-speech">
                    Welcome to our Polynomial Adventure! I'm Professor Poly!
                </div>
            </div>
            
            <div class="character" id="variable-vicky">
                <svg class="character-svg" viewBox="0 0 100 100">
                    <!-- Variable Vicky -->
                    <circle cx="50" cy="50" r="40" fill="#ff9a76" />
                    <circle cx="35" cy="40" r="5" fill="white" />
                    <circle cx="35" cy="40" r="2" fill="black" />
                    <circle cx="65" cy="40" r="5" fill="white" />
                    <circle cx="65" cy="40" r="2" fill="black" />
                    <path d="M 35 60 Q 50 70 65 60" stroke="white" stroke-width="3" fill="transparent" />
                    <path d="M 30 25 L 50 15 L 70 25" stroke="black" stroke-width="2" fill="transparent" />
                    <path d="M 50 15 L 50 30" stroke="black" stroke-width="2" fill="transparent" />
                </svg>
                <div class="character-speech" id="vicky-speech">
                    I'm Variable Vicky! I'll help you learn about variables from around the world!
                </div>
            </div>
            
            <div class="character" id="exponent-eddie">
                <svg class="character-svg" viewBox="0 0 100 100">
                    <!-- Exponent Eddie -->
                    <circle cx="50" cy="50" r="40" fill="#6ecb63" />
                    <circle cx="35" cy="40" r="5" fill="white" />
                    <circle cx="35" cy="40" r="2" fill="black" />
                    <circle cx="65" cy="40" r="5" fill="white" />
                    <circle cx="65" cy="40" r="2" fill="black" />
                    <path d="M 35 65 Q 50 55 65 65" stroke="white" stroke-width="3" fill="transparent" />
                    <text x="40" y="30" font-size="20" font-weight="bold">x<tspan baseline-shift="super" font-size="15">2</tspan></text>
                </svg>
                <div class="character-speech" id="eddie-speech">
                    I'm Exponent Eddie! Let's turn negative exponents into positive ones!
                </div>
            </div>
        </div>
        
        <div class="visualization-container" id="visualization">
            <!-- Three.js visualization will be rendered here -->
        </div>
        
        <div class="controls-container">
            <div class="control-group">
                <div class="control-title">Problem Settings</div>
                <div class="slider-container">
                    <label class="slider-label" for="terms-slider">Number of Terms: <span id="terms-value">3</span></label>
                    <input type="range" min="1" max="5" value="3" class="slider" id="terms-slider">
                </div>
                <div class="slider-container">
                    <label class="slider-label" for="difficulty-slider">Difficulty Level: <span id="difficulty-value">2</span></label>
                    <input type="range" min="1" max="4" value="2" class="slider" id="difficulty-slider">
                </div>
            </div>
            
            <div class="control-group">
                <div class="control-title">Visualization Settings</div>
                <div class="slider-container">
                    <label class="slider-label" for="speed-slider">Animation Speed: <span id="speed-value">5</span></label>
                    <input type="range" min="1" max="10" value="5" class="slider" id="speed-slider">
                </div>
                <div class="slider-container">
                    <label class="slider-label" for="color-slider">Color Theme: <span id="color-value">Vibrant</span></label>
                    <input type="range" min="1" max="3" value="1" class="slider" id="color-slider">
                </div>
            </div>
            
            <div class="control-group">
                <div class="control-title">Characters</div>
                <div class="slider-container">
                    <label class="slider-label" for="character-slider">Character Help Level: <span id="character-value">Medium</span></label>
                    <input type="range" min="1" max="3" value="2" class="slider" id="character-slider">
                </div>
                <button class="btn" id="intro-btn" style="margin-top: 10px; background-color: var(--quaternary-color); color: var(--text-color);">Meet the Characters</button>
            </div>
        </div>
        
        <div class="quiz-container">
            <h2 class="quiz-header">Polynomial Challenge</h2>
            <div class="problem-container" id="problem-display">
                Loading problem...
            </div>
            
            <div class="variable-selector" id="variable-buttons">
                <!-- Variable buttons will be added here dynamically -->
            </div>
            
            <div class="answer-container" id="answer-container">
                <!-- Answer inputs will be added here dynamically -->
            </div>
            
            <div class="action-btns">
                <button class="btn hint-btn" id="hint-btn">Get Hint</button>
                <button class="btn check-btn" id="check-btn">Check Answer</button>
                <button class="btn new-problem-btn" id="new-problem-btn">New Problem</button>
            </div>
            
            <div class="result-message" id="result-message"></div>
            
            <div class="hint-panel" id="hint-panel">
                <div class="hint-title">Helpful Hint:</div>
                <div id="hint-content"></div>
            </div>
        </div>
        
        <div class="progress-container">
            <div class="progress-title">Your Learning Progress</div>
            <div class="progress-bar-container">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
            <div class="score-display">
                Score: <span id="correct-count">0</span> / <span id="total-count">0</span>
            </div>
        </div>
    </div>
    
    <div id="characters-modal" class="modal">
        <div class="modal-content">
            <span class="close" id="close-modal">&times;</span>
            <h2 class="modal-title">Meet Your Polynomial Friends!</h2>
            
            <div class="character-info">
                <svg class="character-img" viewBox="0 0 100 100">
                    <!-- Professor Poly -->
                    <circle cx="50" cy="50" r="40" fill="#4a6fa5" />
                    <circle cx="35" cy="40" r="5" fill="white" />
                    <circle cx="35" cy="40" r="2" fill="black" />
                    <circle cx="65" cy="40" r="5" fill="white" />
                    <circle cx="65" cy="40" r="2" fill="black" />
                    <path d="M 35 65 Q 50 75 65 65" stroke="white" stroke-width="3" fill="transparent" />
                    <ellipse cx="50" cy="30" rx="10" ry="5" fill="white" transform="rotate(-10, 50, 30)" />
                </svg>
                <div>
                    <h3>Professor Poly</h3>
                    <p>A wise mathematician who loves to teach about polynomials. Professor Poly will guide you through your journey of converting negative exponents to positive ones!</p>
                </div>
            </div>
            
            <div class="character-info">
                <svg class="character-img" viewBox="0 0 100 100">
                    <!-- Variable Vicky -->
                    <circle cx="50" cy="50" r="40" fill="#ff9a76" />
                    <circle cx="35" cy="40" r="5" fill="white" />
                    <circle cx="35" cy="40" r="2" fill="black" />
                    <circle cx="65" cy="40" r="5" fill="white" />
                    <circle cx="65" cy="40" r="2" fill="black" />
                    <path d="M 35 60 Q 50 70 65 60" stroke="white" stroke-width="3" fill="transparent" />
                    <path d="M 30 25 L 50 15 L 70 25" stroke="black" stroke-width="2" fill="transparent" />
                    <path d="M 50 15 L 50 30" stroke="black" stroke-width="2" fill="transparent" />
                </svg>
                <div>
                    <h3>Variable Vicky</h3>
                    <p>A world traveler who knows variables from many languages and alphabets. She'll help you learn about the meaning and origin of the special symbols we use in math!</p>
                </div>
            </div>
            
            <div class="character-info">
                <svg class="character-img" viewBox="0 0 100 100">
                    <!-- Exponent Eddie -->
                    <circle cx="50" cy="50" r="40" fill="#6ecb63" />
                    <circle cx="35" cy="40" r="5" fill="white" />
                    <circle cx="35" cy="40" r="2" fill="black" />
                    <circle cx="65" cy="40" r="5" fill="white" />
                    <circle cx="65" cy="40" r="2" fill="black" />
                    <path d="M 35 65 Q 50 55 65 65" stroke="white" stroke-width="3" fill="transparent" />
                    <text x="40" y="30" font-size="20" font-weight="bold">x<tspan baseline-shift="super" font-size="15">2</tspan></text>
                </svg>
                <div>
                    <h3>Exponent Eddie</h3>
                    <p>An energetic character who understands the power of exponents! Eddie will show you the secret connection between negative and positive exponents.</p>
                </div>
            </div>
            
            <div class="modal-text">
                <p>Together, these friends will help you master polynomials and learn how to convert negative exponents to positive ones. Are you ready for the adventure?</p>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let scene, camera, renderer, mixer;
        let currentProblem = null;
        let score = { correct: 0, total: 0 };
        let variablesInfo = {};
        let animationSpeed = 5;
        let colorTheme = 1;
        let helpLevel = 2;
        let objects = [];

        // Character variables
        const characterMessages = {
            professor: [
                "Remember: a negative exponent means 'one divided by'!",
                "When we move a term from the numerator to the denominator (or vice versa), we change the sign of the exponent.",
                "To eliminate negative exponents, move the term to the other side of the fraction!",
                "x^-3 is the same as 1/x^3. They're just different ways of writing the same thing!"
            ],
            vicky: [
                "Variables can be from any language! Math is truly international.",
                "Different symbols have been used throughout history to represent unknown quantities.",
                "The letters we use in math often come from different alphabets, like Greek or Hebrew!",
                "Every culture has contributed to mathematics in its own unique way."
            ],
            eddie: [
                "Exponents show how many times to multiply a number by itself!",
                "Negative exponents are just a shorthand way of writing fractions.",
                "The rules of exponents work the same way for positive and negative powers!",
                "Converting between negative and positive exponents helps us understand math better."
            ]
        };

        // Special characters from various alphabets
        const specialCharacters = [
            { symbol: "α", name: "alpha", origin: "Greek", meaning: "First letter of the Greek alphabet, often used for angles or coefficients" },
            { symbol: "β", name: "beta", origin: "Greek", meaning: "Second letter of the Greek alphabet, used for angles or coefficients" },
            { symbol: "γ", name: "gamma", origin: "Greek", meaning: "Third letter of the Greek alphabet, often used for angles or functions" },
            { symbol: "δ", name: "delta", origin: "Greek", meaning: "Fourth letter of the Greek alphabet, represents change or difference" },
            { symbol: "θ", name: "theta", origin: "Greek", meaning: "Eighth letter of the Greek alphabet, often used for angles" },
            { symbol: "λ", name: "lambda", origin: "Greek", meaning: "Eleventh letter of the Greek alphabet, used in physics and calculus" },
            { symbol: "π", name: "pi", origin: "Greek", meaning: "The ratio of a circle's circumference to its diameter (approximately 3.14159)" },
            { symbol: "φ", name: "phi", origin: "Greek", meaning: "21st letter of the Greek alphabet, represents the golden ratio" },
            { symbol: "א", name: "alef", origin: "Hebrew", meaning: "First letter of the Hebrew alphabet, used in set theory" },
            { symbol: "ℵ", name: "aleph", origin: "Hebrew (mathematical)", meaning: "Used to represent infinite cardinalities in mathematics" },
            { symbol: "ש", name: "shin", origin: "Hebrew", meaning: "21st letter of the Hebrew alphabet" },
            { symbol: "ب", name: "ba", origin: "Arabic", meaning: "Second letter of the Arabic alphabet" },
            { symbol: "ج", name: "jim", origin: "Arabic", meaning: "Fifth letter of the Arabic alphabet" },
            { symbol: "म", name: "ma", origin: "Devanagari", meaning: "A consonant in the Devanagari script used in Hindi and Sanskrit" },
            { symbol: "क", name: "ka", origin: "Devanagari", meaning: "A consonant in the Devanagari script used in Hindi and Sanskrit" },
            { symbol: "ξ", name: "xi", origin: "Greek", meaning: "The 14th letter of the Greek alphabet, often used in mathematics" },
            { symbol: "ψ", name: "psi", origin: "Greek", meaning: "The 23rd letter of the Greek alphabet, used in physics and psychology" },
            { symbol: "ω", name: "omega", origin: "Greek", meaning: "The 24th and last letter of the Greek alphabet, represents the end" },
            { symbol: "ζ", name: "zeta", origin: "Greek", meaning: "The 6th letter of the Greek alphabet, used in mathematics" },
            { symbol: "χ", name: "chi", origin: "Greek", meaning: "The 22nd letter of the Greek alphabet, used in statistics" }
        ];

        // Latin alphabet and numbers for variable selection
        const latinAlphabet = ["a", "b", "c", "d", "e", "f", "g", "h", "i", "j", "k", "l", "m", "n", "o", "p", "q", "r", "s", "t", "u", "v", "w", "x", "y", "z"];
        const numbers = ["1", "2", "3", "4", "5", "6", "7", "8", "9"];

        // Initialize the game when the page loads
        window.onload = initGame;

        function initGame() {
            initThreeJS();
            setupEventListeners();
            updateControlLabels();
            showCharacterIntroductions();
            generateNewProblem();
        }

        // Initialize Three.js visualization
        function initThreeJS() {
            // Create scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf0f8ff);

            // Create camera
            camera = new THREE.PerspectiveCamera(75, document.getElementById('visualization').offsetWidth / document.getElementById('visualization').offsetHeight, 0.1, 1000);
            camera.position.z = 5;

            // Create renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(document.getElementById('visualization').offsetWidth, document.getElementById('visualization').offsetHeight);
            document.getElementById('visualization').appendChild(renderer.domElement);

            // Add lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(0, 1, 1);
            scene.add(directionalLight);

            // Handle window resize
            window.addEventListener('resize', () => {
                camera.aspect = document.getElementById('visualization').offsetWidth / document.getElementById('visualization').offsetHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(document.getElementById('visualization').offsetWidth, document.getElementById('visualization').offsetHeight);
            });

            // Start animation loop
            animate();
        }

        // Animation loop
        function animate() {
            requestAnimationFrame(animate);
            
            // Rotate objects based on animation speed
            objects.forEach((obj) => {
                obj.rotation.x += 0.001 * animationSpeed;
                obj.rotation.y += 0.002 * animationSpeed;
            });
            
            renderer.render(scene, camera);
        }

        // Setup event listeners for controls and buttons
        function setupEventListeners() {
            // Slider event listeners
            document.getElementById('terms-slider').addEventListener('input', function() {
                document.getElementById('terms-value').textContent = this.value;
            });
            
            document.getElementById('difficulty-slider').addEventListener('input', function() {
                const difficultyLabels = ["Very Easy", "Easy", "Medium", "Hard"];
                document.getElementById('difficulty-value').textContent = difficultyLabels[this.value - 1];
            });
            
            document.getElementById('speed-slider').addEventListener('input', function() {
                document.getElementById('speed-value').textContent = this.value;
                animationSpeed = parseInt(this.value);
            });
            
            document.getElementById('color-slider').addEventListener('input', function() {
                const colorLabels = ["Vibrant", "Pastel", "Monochrome"];
                document.getElementById('color-value').textContent = colorLabels[this.value - 1];
                colorTheme = parseInt(this.value);
                updateVisualization();
            });
            
            document.getElementById('character-slider').addEventListener('input', function() {
                const helpLabels = ["Minimal", "Medium", "Maximum"];
                document.getElementById('character-value').textContent = helpLabels[this.value - 1];
                helpLevel = parseInt(this.value);
            });
            
            // Button event listeners
            document.getElementById('hint-btn').addEventListener('click', showHint);
            document.getElementById('check-btn').addEventListener('click', checkAnswer);
            document.getElementById('new-problem-btn').addEventListener('click', generateNewProblem);
            document.getElementById('intro-btn').addEventListener('click', showCharactersModal);
            document.getElementById('close-modal').addEventListener('click', hideCharactersModal);
            
            // Close modal when clicking outside of it
            window.addEventListener('click', function(event) {
                if (event.target === document.getElementById('characters-modal')) {
                    hideCharactersModal();
                }
            });
        }

        // Update control labels based on slider values
        function updateControlLabels() {
            document.getElementById('terms-value').textContent = document.getElementById('terms-slider').value;
            
            const difficultyLabels = ["Very Easy", "Easy", "Medium", "Hard"];
            document.getElementById('difficulty-value').textContent = difficultyLabels[document.getElementById('difficulty-slider').value - 1];
            
            document.getElementById('speed-value').textContent = document.getElementById('speed-slider').value;
            
            const colorLabels = ["Vibrant", "Pastel", "Monochrome"];
            document.getElementById('color-value').textContent = colorLabels[document.getElementById('color-slider').value - 1];
            
            const helpLabels = ["Minimal", "Medium", "Maximum"];
            document.getElementById('character-value').textContent = helpLabels[document.getElementById('character-slider').value - 1];
        }

        // Show character introductions with animations
        function showCharacterIntroductions() {
            const speeches = [
                document.getElementById('professor-speech'),
                document.getElementById('vicky-speech'),
                document.getElementById('eddie-speech')
            ];
            
            // Clear any existing timeouts
            speeches.forEach(s => {
                s.style.opacity = 0;
            });
            
            // Show speech bubbles sequentially
            setTimeout(() => {
                speeches[0].style.opacity = 1;
                setTimeout(() => {
                    speeches[0].style.opacity = 0;
                    speeches[1].style.opacity = 1;
                    setTimeout(() => {
                        speeches[1].style.opacity = 0;
                        speeches[2].style.opacity = 1;
                        setTimeout(() => {
                            speeches[2].style.opacity = 0;
                        }, 3000);
                    }, 3000);
                }, 3000);
            }, 1000);
        }

        // Generate a new polynomial problem
        function generateNewProblem() {
            // Clear previous problem
            clearProblemDisplay();

            // Hide hint panel
            document.getElementById('hint-panel').style.display = 'none';
            
            // Reset result message
            const resultMessage = document.getElementById('result-message');
            resultMessage.textContent = '';
            resultMessage.style.opacity = 0;
            resultMessage.style.backgroundColor = '';
            
            // Get problem settings
            const numTerms = parseInt(document.getElementById('terms-slider').value);
            const difficulty = parseInt(document.getElementById('difficulty-slider').value);
            
            // Generate problem
            currentProblem = createPolynomialProblem(numTerms, difficulty);
            
            // Display problem
            displayProblem(currentProblem);
            
            // Create input fields for answers
            createAnswerInputs(currentProblem);
            
            // Create variable buttons
            createVariableButtons(currentProblem);
            
            // Update visualization
            updateVisualization();
            
            // Show random character message
            showRandomCharacterMessage();
        }

        // Create a polynomial problem with negative exponents
        function createPolynomialProblem(numTerms, difficulty) {
            const terms = [];
            const usedVariables = new Set();
            
            // Select random variables from the special characters list
            const availableVariables = [...specialCharacters];
            
            // Add some Latin alphabet letters if there aren't enough special characters
            if (availableVariables.length < numTerms) {
                latinAlphabet.forEach(letter => {
                    availableVariables.push({
                        symbol: letter,
                        name: letter,
                        origin: "Latin",
                        meaning: `A letter from the Latin alphabet, commonly used in algebra.`
                    });
                });
            }
            
            // Function to get a random variable not already used
            function getRandomVariable() {
                if (availableVariables.length === 0) return null;
                
                const randomIndex = Math.floor(Math.random() * availableVariables.length);
                const variable = availableVariables[randomIndex];
                
                // Ensure we don't use the same variable twice in a single problem
                if (usedVariables.has(variable.symbol)) {
                    availableVariables.splice(randomIndex, 1);
                    return getRandomVariable();
                }
                
                usedVariables.add(variable.symbol);
                return variable;
            }
            
            // Store information about the variables used
            variablesInfo = {};
            
            // Create terms based on difficulty
            for (let i = 0; i < numTerms; i++) {
                // For each term, decide if it will have a negative exponent
                const hasNegativeExponent = Math.random() < 0.7; // 70% chance of negative exponent
                
                // Create coefficient (numerator and denominator)
                let numerator, denominator;
                
                if (difficulty === 1) {
                    // Very easy: Simple integer coefficients, mostly 1
                    numerator = Math.random() < 0.7 ? 1 : Math.floor(Math.random() * 3) + 1;
                    denominator = 1;
                } else if (difficulty === 2) {
                    // Easy: Simple integer coefficients
                    numerator = Math.floor(Math.random() * 5) + 1;
                    denominator = Math.random() < 0.3 ? Math.floor(Math.random() * 3) + 1 : 1;
                } else if (difficulty === 3) {
                    // Medium: More complex fractions
                    numerator = Math.floor(Math.random() * 7) + 1;
                    denominator = Math.random() < 0.6 ? Math.floor(Math.random() * 5) + 1 : 1;
                } else {
                    // Hard: Complex fractions
                    numerator = Math.floor(Math.random() * 9) + 1;
                    denominator = Math.floor(Math.random() * 7) + 1;
                }
                
                // Simplify the fraction
                const gcd = findGCD(numerator, denominator);
                numerator /= gcd;
                denominator /= gcd;
                
                // Get a random variable
                const variable = getRandomVariable();
                
                // Store variable info
                if (variable) {
                    variablesInfo[variable.symbol] = {
                        name: variable.name,
                        origin: variable.origin,
                        meaning: variable.meaning
                    };
                }
                
                // Create exponent
                let exponent;
                if (hasNegativeExponent) {
                    // Negative exponent based on difficulty
                    if (difficulty === 1) {
                        exponent = -1;
                    } else if (difficulty === 2) {
                        exponent = Math.random() < 0.7 ? -1 : -2;
                    } else if (difficulty === 3) {
                        exponent = -(Math.floor(Math.random() * 3) + 1);
                    } else {
                        exponent = -(Math.floor(Math.random() * 4) + 1);
                    }
                } else {
                    // Positive exponent based on difficulty
                    if (difficulty === 1) {
                        exponent = 1;
                    } else if (difficulty === 2) {
                        exponent = Math.floor(Math.random() * 2) + 1;
                    } else if (difficulty === 3) {
                        exponent = Math.floor(Math.random() * 3) + 1;
                    } else {
                        exponent = Math.floor(Math.random() * 4) + 1;
                    }
                }
                
                // Add term to the list
                terms.push({
                    numerator,
                    denominator,
                    variable: variable ? variable.symbol : "x",
                    exponent
                });
            }
            
            return {
                terms,
                difficulty
            };
        }

        // Find the greatest common divisor (for fraction simplification)
        function findGCD(a, b) {
            a = Math.abs(a);
            b = Math.abs(b);
            while (b) {
                const temp = b;
                b = a % b;
                a = temp;
            }
            return a;
        }

        // Display the polynomial problem
        function displayProblem(problem) {
            const problemDisplay = document.getElementById('problem-display');
            problemDisplay.innerHTML = '';
            
            const instructions = document.createElement('p');
            instructions.textContent = "Convert this expression to have only positive exponents:";
            instructions.style.marginBottom = '10px';
            instructions.style.fontSize = '18px';
            problemDisplay.appendChild(instructions);
            
            const expressionContainer = document.createElement('div');
            expressionContainer.style.fontSize = '28px';
            expressionContainer.style.fontWeight = 'bold';
            
            // Build the expression HTML
            let expressionHTML = '';
            
            problem.terms.forEach((term, index) => {
                // Add plus sign between terms (except the first one)
                if (index > 0) {
                    expressionHTML += ' + ';
                }
                
                // Add coefficient if not 1
                if (term.numerator === 1 && term.denominator === 1) {
                    // No coefficient needed
                } else if (term.denominator === 1) {
                    expressionHTML += term.numerator;
                } else {
                    expressionHTML += `<span style="display:inline-block;text-align:center;vertical-align:middle;">
                        <span style="display:block;">${term.numerator}</span>
                        <span style="display:block;border-top:2px solid black;padding-top:2px;">${term.denominator}</span>
                    </span>`;
                }
                
                // Add variable and exponent
                expressionHTML += term.variable;
                if (term.exponent !== 1) {
                    expressionHTML += `<sup>${term.exponent}</sup>`;
                }
            });
            
            expressionContainer.innerHTML = expressionHTML;
            problemDisplay.appendChild(expressionContainer);
        }

        // Create input fields for the answer
        function createAnswerInputs(problem) {
            const answerContainer = document.getElementById('answer-container');
            answerContainer.innerHTML = '';
            
            problem.terms.forEach((term, index) => {
                const termAnswer = document.createElement('div');
                termAnswer.className = 'term-answer';
                
                // Term label
                const termLabel = document.createElement('div');
                termLabel.textContent = `Term ${index + 1}`;
                termLabel.style.marginBottom = '5px';
                termLabel.style.fontWeight = 'bold';
                termAnswer.appendChild(termLabel);
                
                // Fraction input (coefficient)
                const fractionInput = document.createElement('div');
                fractionInput.className = 'fraction-input';
                
                const numeratorInput = document.createElement('input');
                numeratorInput.type = 'number';
                numeratorInput.className = 'numerator';
                numeratorInput.id = `numerator-${index}`;
                numeratorInput.min = '0';
                
                const fractionLine = document.createElement('div');
                fractionLine.className = 'fraction-line';
                
                const denominatorInput = document.createElement('input');
                denominatorInput.type = 'number';
                denominatorInput.className = 'denominator';
                denominatorInput.id = `denominator-${index}`;
                denominatorInput.min = '1';
                denominatorInput.value = '1';
                
                fractionInput.appendChild(numeratorInput);
                fractionInput.appendChild(fractionLine);
                fractionInput.appendChild(denominatorInput);
                termAnswer.appendChild(fractionInput);
                
                // Variable input
                const variableContainer = document.createElement('div');
                variableContainer.style.display = 'flex';
                variableContainer.style.alignItems = 'center';
                variableContainer.style.marginTop = '10px';
                
                const variableInput = document.createElement('input');
                variableInput.type = 'text';
                variableInput.className = 'variable-input';
                variableInput.id = `variable-${index}`;
                variableInput.readOnly = true; // Set to readonly since we'll use buttons
                
                const exponentInput = document.createElement('input');
                exponentInput.type = 'number';
                exponentInput.className = 'exponent-input';
                exponentInput.id = `exponent-${index}`;
                exponentInput.min = '0'; // Only positive exponents allowed in the answer
                
                variableContainer.appendChild(variableInput);
                variableContainer.appendChild(exponentInput);
                termAnswer.appendChild(variableContainer);
                
                answerContainer.appendChild(termAnswer);
            });
        }

        // Create variable selection buttons
        function createVariableButtons(problem) {
            const variableButtons = document.getElementById('variable-buttons');
            variableButtons.innerHTML = '';
            
            // Add a header for the variables section
            const header = document.createElement('div');
            header.textContent = 'Click to select a variable:';
            header.style.width = '100%';
            header.style.textAlign = 'center';
            header.style.marginBottom = '10px';
            header.style.fontWeight = 'bold';
            variableButtons.appendChild(header);
            
            // Get unique variables used in the problem
            const uniqueVariables = new Set();
            problem.terms.forEach(term => {
                uniqueVariables.add(term.variable);
            });
            
            // Create buttons for each variable
            uniqueVariables.forEach(variable => {
                const btn = document.createElement('button');
                btn.className = 'variable-btn';
                btn.textContent = variable;
                btn.addEventListener('click', function() {
                    // Find the currently selected input field
                    const selectedInput = document.activeElement;
                    if (selectedInput && selectedInput.id && selectedInput.id.startsWith('variable-')) {
                        selectedInput.value = variable;
                    } else {
                        // If no input is selected, find the first empty one
                        for (let i = 0; i < problem.terms.length; i++) {
                            const input = document.getElementById(`variable-${i}`);
                            if (!input.value) {
                                input.value = variable;
                                break;
                            }
                        }
                    }
                });
                variableButtons.appendChild(btn);
            });
        }

        // Update the Three.js visualization
        function updateVisualization() {
            // Clear existing objects
            objects.forEach(obj => {
                scene.remove(obj);
            });
            objects = [];
            
            if (!currentProblem) return;
            
            // Get color scheme based on theme
            let colors;
            if (colorTheme === 1) { // Vibrant
                colors = [0xff5733, 0x33ff57, 0x3357ff, 0xff33f5, 0xf5ff33];
            } else if (colorTheme === 2) { // Pastel
                colors = [0xffb6c1, 0xadd8e6, 0xb0e0e6, 0xdda0dd, 0xffdab9];
            } else { // Monochrome
                colors = [0x333333, 0x555555, 0x777777, 0x999999, 0xbbbbbb];
            }
            
            // Create 3D objects to represent the polynomial terms
            currentProblem.terms.forEach((term, index) => {
                let geometry;
                
                // Select geometry based on exponent value
                if (term.exponent < 0) {
                    // Negative exponent: sphere (representing division)
                    geometry = new THREE.SphereGeometry(0.4, 32, 32);
                } else if (term.exponent === 0) {
                    // Zero exponent: box (representing constant)
                    geometry = new THREE.BoxGeometry(0.6, 0.6, 0.6);
                } else {
                    // Positive exponent: different shapes based on value
                    if (term.exponent === 1) {
                        geometry = new THREE.ConeGeometry(0.3, 0.6, 32);
                    } else if (term.exponent === 2) {
                        geometry = new THREE.TorusGeometry(0.3, 0.1, 16, 32);
                    } else {
                        geometry = new THREE.OctahedronGeometry(0.4);
                    }
                }
                
                // Create material with color based on index
                const color = colors[index % colors.length];
                const material = new THREE.MeshPhongMaterial({ color, shininess: 100 });
                
                // Create mesh
                const mesh = new THREE.Mesh(geometry, material);
                
                // Position the object
                const spacing = 1.2;
                const xPos = (index - (currentProblem.terms.length - 1) / 2) * spacing;
                mesh.position.set(xPos, 0, 0);
                
                // Add object to scene
                scene.add(mesh);
                objects.push(mesh);
            });
        }

        // Show a hint for the current problem
        function showHint() {
            const hintPanel = document.getElementById('hint-panel');
            const hintContent = document.getElementById('hint-content');
            
            if (!currentProblem) return;
            
            // Generate hint based on the problem
            let hint = "<p>To convert negative exponents to positive exponents, remember:</p>";
            hint += "<ul style='margin-left: 20px;'>";
            hint += "<li>x<sup>-n</sup> = 1 / x<sup>n</sup></li>";
            hint += "<li>When a term with a negative exponent is in the numerator, move it to the denominator and make the exponent positive.</li>";
            hint += "<li>When a term with a negative exponent is in the denominator, move it to the numerator and make the exponent positive.</li>";
            hint += "</ul>";
            
            // Add specific hints for the current problem
            hint += "<p style='margin-top: 10px;'>For this problem:</p>";
            
            currentProblem.terms.forEach((term, index) => {
                if (term.exponent < 0) {
                    const posExponent = -term.exponent;
                    
                    // Generate hint
                    hint += `<p>Term ${index + 1}: ${term.variable}<sup>${term.exponent}</sup> = 1/${term.variable}<sup>${posExponent}</sup></p>`;
                    
                    // If the term already has a fraction coefficient, explain how to combine
                    if (term.denominator !== 1) {
                        hint += `<p>Since this term already has a fraction coefficient (${term.numerator}/${term.denominator}), you'll need to combine it with the new fraction from the negative exponent.</p>`;
                    }
                } else {
                    hint += `<p>Term ${index + 1}: The exponent is already positive, so no conversion needed.</p>`;
                }
            });
            
            // Add variable information for a random variable in the problem
            const variableKeys = Object.keys(variablesInfo);
            if (variableKeys.length > 0) {
                const randomVar = variableKeys[Math.floor(Math.random() * variableKeys.length)];
                const varInfo = variablesInfo[randomVar];
                
                hint += `<p style='margin-top: 10px;'><strong>Did you know?</strong> The symbol "${randomVar}" (${varInfo.name}) is from the ${varInfo.origin} alphabet. ${varInfo.meaning}</p>`;
            }
            
            hintContent.innerHTML = hint;
            hintPanel.style.display = 'block';
        }

        // Check the user's answer
        function checkAnswer() {
            if (!currentProblem) return;
            
            const resultMessage = document.getElementById('result-message');
            let allCorrect = true;
            
            // Check each term
            const correctAnswers = [];
            currentProblem.terms.forEach((term, index) => {
                // Get user inputs
                const numerator = parseInt(document.getElementById(`numerator-${index}`).value) || 0;
                const denominator = parseInt(document.getElementById(`denominator-${index}`).value) || 1;
                const variable = document.getElementById(`variable-${index}`).value;
                const exponent = parseInt(document.getElementById(`exponent-${index}`).value) || 0;
                
                // Calculate correct answer
                let correctNumerator = term.numerator;
                let correctDenominator = term.denominator;
                let correctExponent = term.exponent;
                
                // If exponent is negative, adjust the fraction and make exponent positive
                if (term.exponent < 0) {
                    correctExponent = -term.exponent;
                    // Flip the position (numerator to denominator or vice versa)
                    [correctNumerator, correctDenominator] = [correctDenominator, correctNumerator * Math.pow(1, -term.exponent)];
                }
                
                // Simplify the fraction
                const gcd = findGCD(correctNumerator, correctDenominator);
                correctNumerator /= gcd;
                correctDenominator /= gcd;
                
                // Store correct answer
                correctAnswers.push({
                    numerator: correctNumerator,
                    denominator: correctDenominator,
                    variable: term.variable,
                    exponent: correctExponent
                });
                
                // Check if the answer is correct
                const fractionCorrect = numerator === correctNumerator && denominator === correctDenominator;
                const variableCorrect = variable === term.variable;
                const exponentCorrect = exponent === correctExponent;
                
                if (!fractionCorrect || !variableCorrect || !exponentCorrect) {
                    allCorrect = false;
                }
            });
            
            // Update score and display result
            score.total++;
            document.getElementById('total-count').textContent = score.total;
            
            if (allCorrect) {
                score.correct++;
                document.getElementById('correct-count').textContent = score.correct;
                resultMessage.textContent = "Correct! Great job!";
                resultMessage.style.backgroundColor = "rgba(102, 187, 106, 0.2)";
                
                // Show congratulatory character message
                showCharacterMessage('professor', "Excellent work! You've mastered the conversion of negative exponents!");
            } else {
                resultMessage.textContent = "Not quite right. Try again or check the hint!";
                resultMessage.style.backgroundColor = "rgba(239, 83, 80, 0.2)";
                
                // Show encouraging character message
                showCharacterMessage('eddie', "Keep trying! Remember that negative exponents move between the numerator and denominator.");
            }
            
            resultMessage.style.opacity = 1;
            
            // Update progress bar
            updateProgress();
        }

        // Update the progress bar based on score
        function updateProgress() {
            const progressBar = document.getElementById('progress-bar');
            const percentage = score.total > 0 ? (score.correct / score.total) * 100 : 0;
            progressBar.style.width = `${percentage}%`;
        }

        // Show a random character message
        function showRandomCharacterMessage() {
            const characters = ['professor', 'vicky', 'eddie'];
            const character = characters[Math.floor(Math.random() * characters.length)];
            
            // Only show message if help level is medium or maximum
            if (helpLevel >= 2) {
                showCharacterMessage(character);
            }
        }

        // Show a message from a character
        function showCharacterMessage(character, customMessage = null) {
            const messages = characterMessages[character];
            let message = customMessage;
            
            if (!message) {
                message = messages[Math.floor(Math.random() * messages.length)];
            }
            
            let speechBubble;
            if (character === 'professor') {
                speechBubble = document.getElementById('professor-speech');
            } else if (character === 'vicky') {
                speechBubble = document.getElementById('vicky-speech');
            } else {
                speechBubble = document.getElementById('eddie-speech');
            }
            
            speechBubble.textContent = message;
            speechBubble.style.opacity = 1;
            
            setTimeout(() => {
                speechBubble.style.opacity = 0;
            }, 5000);
        }

        // Show the character modal
        function showCharactersModal() {
            document.getElementById('characters-modal').style.display = 'block';
        }

        // Hide the character modal
        function hideCharactersModal() {
            document.getElementById('characters-modal').style.display = 'none';
        }

        // Clear the problem display
        function clearProblemDisplay() {
            document.getElementById('problem-display').innerHTML = 'Loading new problem...';
            document.getElementById('answer-container').innerHTML = '';
            document.getElementById('variable-buttons').innerHTML = '';
        }
    </script>
</body>
</html>
