<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Musical Maestro - Piano Learning Game with Midi</title>
    <style>
        :root {
            --white-key-width: min(40px, 8vw);
            --black-key-width: calc(var(--white-key-width) * 0.6);
            --white-key-height: min(120px, 25vh);
            --canvas-height: min(400px, 60vh);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #1a1a1a;
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .game-container {
            width: 100%;
            max-width: 1000px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .piano-container {
            width: 100%;
            position: relative;
            height: var(--white-key-height);
            display: flex;
            justify-content: flex-start;  /* Change from center to flex-start */
            padding-left: 0%;  /* Add padding to center the piano while keeping C in correct position */
        }




        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
        }

        .controls select, .controls button {
            padding: 8px 16px;
            border-radius: 4px;
            border: none;
            background: #333;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }

        .controls button:hover {
            background: #444;
        }

        .stats {
            font-size: 18px;
            font-weight: bold;
            text-align: center;
        }

        #gameCanvas {
            width: 100%;
            height: var(--canvas-height);
            background: black;
            border-radius: 4px;
        }



        .white-key {
            width: var(--white-key-width);
            height: var(--white-key-height);
            background: white;
            border: 1px solid #ccc;
            position: relative;
            cursor: pointer;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 5px;
            color: #333;
            font-size: 12px;
        }

        .black-key {
            width: var(--black-key-width);
            height: calc(var(--white-key-height) * 0.6);
            background: black;
            position: absolute;
            cursor: pointer;
            z-index: 1;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 5px;
            color: white;
            font-size: 10px;
        }

        .white-key.active {
            background: #FFD700;
        }

        .black-key.active {
            background: #A0522D;
        }

        .white-key.hint {
            background: #FFE87C;
        }

        .black-key.hint {
            background: #8B4513;
        }

        .judgment {
            position: absolute;
            font-weight: bold;
            animation: fadeUp 0.5s ease-out;
            pointer-events: none;
        }

        @keyframes fadeUp {
            0% {
                opacity: 1;
                transform: translateY(0);
            }
            100% {
                opacity: 0;
                transform: translateY(-30px);
            }
        }

        @media (max-width: 600px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .controls select, .controls button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="controls">
            <select id="songSelect">
                <option>Baa Baa Black Sheep</option>
                <option>Baby Shark</option>
                <option>Do-Re-Mi</option>
                <option>Frère Jacques</option>
                <option>Für Elise (Simple)</option>
                <option>Hakuna Matata</option>
                <option>Happy Birthday</option>
                <option>Head, Shoulders, Knees and Toes</option>
                <option>Hot Cross Buns</option>
                <option>If You're Happy and You Know It</option>
                <option>Itsy Bitsy Spider</option>
                <option>Let It Go (Chorus)</option>
                <option>London Bridge</option>
                <option>Mary Had a Little Lamb</option>
                <option>Ode to Joy</option>
                <option>Old MacDonald</option>
                <option>Row Row Row Your Boat</option>
                <option>The Wheels on the Bus</option>
                <option>Three Blind Mice</option>
                <option>Twinkle Twinkle Little Star</option>
            </select>
            <button id="startButton">▶ Start</button>
            <button id="resetButton">↺ Reset</button>
            <button id="hintButton">💡 Hints</button>
            <button id="midiButton">🎹 Enable MIDI</button>
            <div class="tempo-control">
                <label for="tempoSlider">Speed:</label>
                <input type="range" id="tempoSlider" min="0.1" max="2.0" step="0.1" value="0.5">
                <span id="tempoValue">0.5x</span>
            </div>
        <div class="stats" id="stats">
            Score: 0 | Combo: 0 | Max Combo: 0
        </div>
        <canvas id="gameCanvas"></canvas>
        <div id="pianoContainer" class="piano-container"></div>
    </div>

    <script>
        // Constants
// Constants for piano keys
        const WHITE_KEYS = [
            // Lower octaves
            'C2', 'D2', 'E2', 'F2', 'G2', 'A2', 'B2',
            'C3', 'D3', 'E3', 'F3', 'G3', 'A3', 'B3',
            // Middle range (original)
            'C4', 'D4', 'E4', 'F4', 'G4', 'A4', 'B4',
            'C5', 'D5', 'E5', 'F5', 'G5', 'A5', 'B5',
            // Higher octaves
            'C6', 'D6', 'E6', 'F6', 'G6', 'A6', 'B6',
            'C7'
        ];

        const BLACK_KEYS = [
            // Lower octaves
            'C#2', 'D#2', 'F#2', 'G#2', 'A#2',
            'C#3', 'D#3', 'F#3', 'G#3', 'A#3',
            // Middle range (original)
            'C#4', 'D#4', 'F#4', 'G#4', 'A#4',
            'C#5', 'D#5', 'F#5', 'G#5', 'A#5',
            // Higher octaves
            'C#6', 'D#6', 'F#6', 'G#6', 'A#6'
        ];

        // Expanded keyboard mapping
        const KEYBOARD_MAP = {
            // Lower octave
            'z': 'C4', 's': 'C#4', 'x': 'D4', 'd': 'D#4', 'c': 'E4',
            'v': 'F4', 'g': 'F#4', 'b': 'G4', 'h': 'G#4', 'n': 'A4',
            'j': 'A#4', 'm': 'B4',
            // Middle octave
            ',': 'C5', 'l': 'C#5', '.': 'D5', ';': 'D#5', '/': 'E5',
            // Higher octave (new mappings)
            'q': 'F5', '2': 'F#5', 'w': 'G5', '3': 'G#5', 'e': 'A5',
            '4': 'A#5', 'r': 'B5', 't': 'C6', '6': 'C#6', 'y': 'D6',
            '7': 'D#6', 'u': 'E6',
            // Highest notes
            'i': 'F6', '9': 'F#6', 'o': 'G6', '0': 'G#6', 'p': 'A6',
            '-': 'A#6', '[': 'B6', ']': 'C7'
        };
// Complete song collection
        const SONGS = {
            "Mary Had a Little Lamb": [
                // First verse
                ['E4', 1], ['D4', 1], ['C4', 1], ['D4', 1],
                ['E4', 1], ['E4', 1], ['E4', 2],
                ['D4', 1], ['D4', 1], ['D4', 2],
                ['E4', 1], ['G4', 1], ['G4', 2],
                // Second verse
                ['E4', 1], ['D4', 1], ['C4', 1], ['D4', 1],
                ['E4', 1], ['E4', 1], ['E4', 1], ['E4', 1],
                ['D4', 1], ['D4', 1], ['E4', 1], ['D4', 1],
                ['C4', 2], ['C4', 2]
            ],
            
            "Twinkle Twinkle Little Star": [
                // First part
                ['C4', 1], ['C4', 1], ['G4', 1], ['G4', 1],
                ['A4', 1], ['A4', 1], ['G4', 2],
                ['F4', 1], ['F4', 1], ['E4', 1], ['E4', 1],
                ['D4', 1], ['D4', 1], ['C4', 2],
                // Second part
                ['G4', 1], ['G4', 1], ['F4', 1], ['F4', 1],
                ['E4', 1], ['E4', 1], ['D4', 2],
                ['G4', 1], ['G4', 1], ['F4', 1], ['F4', 1],
                ['E4', 1], ['E4', 1], ['D4', 2],
                // Final part
                ['C4', 1], ['C4', 1], ['G4', 1], ['G4', 1],
                ['A4', 1], ['A4', 1], ['G4', 2],
                ['F4', 1], ['F4', 1], ['E4', 1], ['E4', 1],
                ['D4', 1], ['D4', 1], ['C4', 2]
            ],
            
            "Happy Birthday": [
                ['G4', 0.5], ['G4', 0.5],  // Hap-py
                ['A4', 1],                  // birth-
                ['G4', 1],                  // day
                ['C5', 1],                  // to
                ['B4', 2],                  // you
                
                ['G4', 0.5], ['G4', 0.5],  // Hap-py
                ['A4', 1],                  // birth-
                ['G4', 1],                  // day
                ['D5', 1],                  // to
                ['C5', 2],                  // you
                
                ['G4', 0.5], ['G4', 0.5],  // Hap-py
                ['G5', 1],                  // birth-
                ['E5', 1],                  // day
                ['C5', 1],                  // dear
                ['B4', 1],                  // [name]
                ['A4', 1],                  // [name]
                
                ['F5', 0.5], ['F5', 0.5],  // Hap-py
                ['E5', 1],                  // birth-
                ['C5', 1],                  // day
                ['D5', 1],                  // to
                ['C5', 2]                   // you
            ],

            "Baby Shark": [
                // Baby Shark
                ['D4', 1], ['E4', 1], ['G4', 1], ['G4', 1], ['G4', 1], ['G4', 1],
                ['D4', 1], ['E4', 1], ['G4', 1], ['G4', 1], ['G4', 1], ['G4', 1],
                ['D4', 1], ['E4', 1], ['G4', 1], ['G4', 1], ['G4', 1], ['G4', 1],
                ['G4', 2],
                // Mommy Shark
                ['D4', 1], ['E4', 1], ['G4', 1], ['G4', 1], ['G4', 1], ['G4', 1],
                ['D4', 1], ['E4', 1], ['G4', 1], ['G4', 1], ['G4', 1], ['G4', 1],
                ['D4', 1], ['E4', 1], ['G4', 1], ['G4', 1], ['G4', 1], ['G4', 1],
                ['G4', 2],
                // Daddy Shark
                ['D4', 1], ['E4', 1], ['G4', 1], ['G4', 1], ['G4', 1], ['G4', 1],
                ['D4', 1], ['E4', 1], ['G4', 1], ['G4', 1], ['G4', 1], ['G4', 1],
                ['D4', 1], ['E4', 1], ['G4', 1], ['G4', 1], ['G4', 1], ['G4', 1],
                ['G4', 2]
            ],

            "Let It Go (Chorus)": [
                // Let it go
                ['E4', 1], ['E4', 1], ['F4', 0.5], ['G4', 0.5], 
                ['G4', 1], ['F4', 0.5], ['E4', 0.5],
                ['F4', 1], ['G4', 1], ['A4', 1], ['A4', 1],
                ['G4', 2],
                // Let it go
                ['E4', 1], ['E4', 1], ['F4', 0.5], ['G4', 0.5], 
                ['G4', 1], ['F4', 0.5], ['E4', 0.5],
                ['F4', 1], ['G4', 1], ['A4', 1], ['A4', 1],
                ['G4', 2],
                // Can't hold it back anymore
                ['G4', 1], ['A4', 1], ['G4', 1], ['F4', 1],
                ['E4', 1], ['F4', 1], ['G4', 1], ['A4', 1],
                ['A#4', 1], ['A4', 1], ['G4', 1], ['F4', 1],
                ['G4', 2]
            ],

            "Ode to Joy": [
                // First phrase
                ['E4', 1], ['E4', 1], ['F4', 1], ['G4', 1],
                ['G4', 1], ['F4', 1], ['E4', 1], ['D4', 1],
                ['C4', 1], ['C4', 1], ['D4', 1], ['E4', 1],
                ['E4', 1.5], ['D4', 0.5], ['D4', 2],
                // Second phrase
                ['E4', 1], ['E4', 1], ['F4', 1], ['G4', 1],
                ['G4', 1], ['F4', 1], ['E4', 1], ['D4', 1],
                ['C4', 1], ['C4', 1], ['D4', 1], ['E4', 1],
                ['D4', 1.5], ['C4', 0.5], ['C4', 2],
                // Third phrase
                ['D4', 1], ['D4', 1], ['E4', 1], ['C4', 1],
                ['D4', 1], ['E4', 0.5], ['F4', 0.5], ['E4', 1], ['C4', 1],
                ['D4', 1], ['E4', 0.5], ['F4', 0.5], ['E4', 1], ['D4', 1],
                ['C4', 1], ['D4', 1], ['G3', 2]
            ],

            "Old MacDonald": [
                // First verse
                ['G4', 1], ['G4', 1], ['G4', 1], ['D4', 1],
                ['E4', 1], ['E4', 1], ['D4', 2],
                ['B4', 1], ['B4', 1], ['A4', 1], ['A4', 1],
                ['G4', 2], ['G4', 2],
                // E-I-E-I-O
                ['D4', 1], ['G4', 1], ['G4', 1], ['G4', 1],
                ['D4', 1], ['E4', 1], ['E4', 1], ['D4', 1],
                ['G4', 1], ['G4', 1], ['G4', 1], ['G4', 1],
                ['G4', 2]
            ],

            "Row Row Row Your Boat": [
                // Complete round
                ['C4', 1], ['C4', 1], ['C4', 1], ['D4', 0.5], ['E4', 1.5],
                ['E4', 1], ['D4', 0.5], ['E4', 1], ['F4', 0.5], ['G4', 2],
                ['C5', 0.5], ['C5', 0.5], ['G4', 0.5], ['G4', 0.5], ['E4', 0.5], ['E4', 0.5], ['C4', 1],
                ['G4', 0.5], ['F4', 0.5], ['E4', 0.5], ['D4', 0.5], ['C4', 2]
            ],

            "Hakuna Matata": [
                // Main theme
                ['G4', 1], ['E4', 1], ['G4', 1], ['G4', 1],
                ['A4', 0.5], ['G4', 0.5], ['F4', 1], ['E4', 1],
                ['D4', 1], ['E4', 1], ['F4', 1], ['G4', 1],
                // It means no worries
                ['C5', 1], ['B4', 1], ['A4', 1], ['G4', 1],
                ['F4', 1], ['E4', 1], ['D4', 2],
                // For the rest of your days
                ['G4', 1], ['A4', 1], ['B4', 1], ['C5', 1],
                ['B4', 1], ['A4', 1], ['G4', 2]
            ],

            "Hot Cross Buns": [
                // Complete pattern
                ['B4', 1], ['A4', 1], ['G4', 2],
                ['B4', 1], ['A4', 1], ['G4', 2],
                ['G4', 0.5], ['G4', 0.5], ['G4', 0.5], ['G4', 0.5],
                ['A4', 0.5], ['A4', 0.5], ['A4', 0.5], ['A4', 0.5],
                ['B4', 1], ['A4', 1], ['G4', 2],
                // Repeat
                ['B4', 1], ['A4', 1], ['G4', 2],
                ['B4', 1], ['A4', 1], ['G4', 2],
                ['G4', 0.5], ['G4', 0.5], ['G4', 0.5], ['G4', 0.5],
                ['A4', 0.5], ['A4', 0.5], ['A4', 0.5], ['A4', 0.5],
                ['B4', 1], ['A4', 1], ['G4', 2]
            ],

            "Für Elise (Simple)": [
                // Main theme
                ['E5', 1], ['D#5', 1], ['E5', 1], ['D#5', 1], ['E5', 1],
                ['B4', 1], ['D5', 1], ['C5', 1], ['A4', 2],
                // Second part
                ['C4', 1], ['E4', 1], ['A4', 1], ['B4', 2],
                ['E4', 1], ['G#4', 1], ['B4', 1], ['C5', 2],
                // Return to main theme
                ['E5', 1], ['D#5', 1], ['E5', 1], ['D#5', 1], ['E5', 1],
                ['B4', 1], ['D5', 1], ['C5', 1], ['A4', 2]
            ],

            "The Wheels on the Bus": [
                // Wheels go round
                ['G4', 1], ['C5', 1], ['C5', 1], ['C5', 1],
                ['A4', 1], ['A4', 1], ['G4', 2],
                ['F4', 1], ['F4', 1], ['E4', 1], ['E4', 1],
                ['D4', 1], ['D4', 1], ['C4', 2],
                // Wipers go swish
                ['G4', 1], ['C5', 1], ['C5', 1], ['C5', 1],
                ['A4', 1], ['A4', 1], ['G4', 2],
                ['F4', 1], ['F4', 1], ['E4', 1], ['E4', 1],
                ['D4', 1], ['D4', 1], ['C4', 2]
            ],

            "If You're Happy and You Know It": [
                // If you're happy
                ['G4', 1], ['G4', 1], ['G4', 1], ['E4', 1],
                ['C4', 1], ['C4', 1], ['A4', 2],
                // Clap your hands
                ['G4', 1], ['G4', 1], ['G4', 1], ['E4', 1],
                ['C4', 1], ['C4', 1], ['G4', 2],
                // You really want to show it
                ['G4', 1], ['G4', 1], ['G4', 1], ['E4', 1],
                ['C4', 1], ['E4', 1], ['G4', 1], ['E4', 1],
                // If you're happy
                ['C4', 1], ['C4', 1], ['E4', 1], ['G4', 1],
                ['G4', 2], ['C4', 2]
            ],




        // Continuing song collection
            "Head, Shoulders, Knees and Toes": [
                // First sequence
                ['C4', 1], ['E4', 1], ['F4', 1], ['G4', 1],
                ['C4', 1], ['E4', 1], ['G4', 2],
                ['G4', 0.5], ['A4', 0.5], ['G4', 0.5], ['F4', 0.5], ['E4', 1], ['C4', 1],
                // Repeat sequence
                ['C4', 1], ['E4', 1], ['F4', 1], ['G4', 1],
                ['C4', 1], ['E4', 1], ['G4', 2],
                ['G4', 0.5], ['A4', 0.5], ['G4', 0.5], ['F4', 0.5], ['E4', 1], ['C4', 1],
                // Final part
                ['G4', 1], ['G4', 1], ['E4', 1], ['C4', 1],
                ['G4', 1], ['F4', 1], ['E4', 1], ['C4', 2]
            ],

            "Do-Re-Mi": [
                // Do-Re-Mi
                ['C4', 1], ['D4', 1], ['E4', 1], ['C4', 1],
                ['E4', 1], ['C4', 1], ['E4', 2],
                // Fa-So-La
                ['D4', 1], ['E4', 1], ['F4', 1], ['D4', 1],
                ['F4', 1], ['D4', 1], ['F4', 2],
                // Ti-Do
                ['E4', 1], ['F4', 1], ['G4', 1], ['E4', 1],
                ['G4', 1], ['E4', 1], ['G4', 2],
                // Do-Ti-La-So-Fa-Mi-Re-Do
                ['C5', 1], ['B4', 1], ['A4', 1], ['G4', 1],
                ['F4', 1], ['E4', 1], ['D4', 1], ['C4', 2]
            ],

            "Itsy Bitsy Spider": [
                // Went up the water spout
                ['G4', 1], ['C5', 1], ['C5', 1], ['C5', 1],
                ['D5', 1], ['E5', 1], ['E5', 2],
                // Down came the rain
                ['E5', 1], ['D5', 1], ['C5', 1], ['D5', 1],
                ['E5', 1], ['C5', 1], ['C5', 2],
                // Out came the sun
                ['G4', 1], ['C5', 1], ['C5', 1], ['C5', 1],
                ['D5', 1], ['E5', 1], ['E5', 2],
                // And dried up all the rain
                ['E5', 1], ['D5', 1], ['C5', 1], ['D5', 1],
                ['E5', 1], ['C5', 1], ['C5', 2]
            ],

            "London Bridge": [
                // London Bridge is falling down
                ['G4', 1], ['A4', 1], ['G4', 1], ['F4', 1],
                ['E4', 1], ['F4', 1], ['G4', 2],
                // Falling down, falling down
                ['D4', 1], ['E4', 1], ['F4', 1], ['E4', 1],
                ['F4', 1], ['G4', 1], ['G4', 2],
                // London Bridge is falling down
                ['G4', 1], ['A4', 1], ['G4', 1], ['F4', 1],
                ['E4', 1], ['F4', 1], ['G4', 2],
                // My fair lady
                ['D4', 1], ['G4', 1], ['E4', 1], ['C4', 1],
                ['D4', 1], ['E4', 1], ['C4', 2]
            ],

            "Baa Baa Black Sheep": [
                // Baa baa black sheep, have you any wool
                ['G4', 1], ['G4', 1], ['D5', 1], ['D5', 1],
                ['E5', 1], ['E5', 1], ['D5', 2],
                // Yes sir, yes sir, three bags full
                ['C5', 1], ['C5', 1], ['B4', 1], ['B4', 1],
                ['A4', 1], ['A4', 1], ['G4', 2],
                // One for the master, one for the dame
                ['D5', 1], ['D5', 1], ['C5', 1], ['C5', 1],
                ['B4', 1], ['B4', 1], ['A4', 2],
                // One for the little boy who lives down the lane
                ['D5', 1], ['D5', 1], ['C5', 1], ['B4', 1],
                ['A4', 1], ['A4', 1], ['G4', 2]
            ],

            "Three Blind Mice": [
                // Three blind mice
                ['E4', 1], ['D4', 1], ['C4', 2],
                // Three blind mice
                ['E4', 1], ['D4', 1], ['C4', 2],
                // See how they run
                ['G4', 1], ['F4', 1], ['E4', 1], ['D4', 1],
                // See how they run
                ['G4', 1], ['F4', 1], ['E4', 1], ['D4', 1],
                // They all ran after the farmer's wife
                ['C4', 1], ['E4', 1], ['G4', 1], ['C5', 1],
                ['G4', 1], ['E4', 1], ['C4', 2],
                // Who cut off their tails with a carving knife
                ['C4', 1], ['E4', 1], ['G4', 1], ['C5', 1],
                ['G4', 1], ['E4', 1], ['C4', 2]
            ],

            "Frère Jacques": [
                // Frère Jacques (Are you sleeping)
                ['C4', 1], ['D4', 1], ['E4', 1], ['C4', 1],
                // Frère Jacques (Are you sleeping)
                ['C4', 1], ['D4', 1], ['E4', 1], ['C4', 1],
                // Dormez-vous? (Morning bells are)
                ['E4', 1], ['F4', 1], ['G4', 2],
                // Dormez-vous? (Morning bells are)
                ['E4', 1], ['F4', 1], ['G4', 2],
                // Sonnez les matines (Ringing, ringing)
                ['G4', 0.5], ['A4', 0.5], ['G4', 0.5], ['F4', 0.5], ['E4', 1], ['C4', 1],
                // Sonnez les matines (Ringing, ringing)
                ['G4', 0.5], ['A4', 0.5], ['G4', 0.5], ['F4', 0.5], ['E4', 1], ['C4', 1],
                // Din, dan, don (Ding, ding, dong)
                ['C4', 1], ['G3', 1], ['C4', 2],
                // Din, dan, don (Ding, ding, dong)
                ['C4', 1], ['G3', 1], ['C4', 2]
            ]
        };



        // Game state
        let gameState = {
            active: false,
            paused: false,
            score: 0,
            combo: 0,
            maxCombo: 0,
            currentSong: "Mary Had a Little Lamb",
            showHints: false,
            pressedKeys: new Set(),
            fallingNotes: [],
            noteSpeed: .5,
            currentNoteIndex: 0  // Track current position in song
        };


        // Add MIDI support
        let midiAccess = null;
        let midiEnabled = false;

        // MIDI note to key mapping
        const MIDI_TO_NOTE = {
            60: 'C4', 61: 'C#4', 62: 'D4', 63: 'D#4', 64: 'E4',
            65: 'F4', 66: 'F#4', 67: 'G4', 68: 'G#4', 69: 'A4',
            70: 'A#4', 71: 'B4', 72: 'C5', 73: 'C#5', 74: 'D5',
            75: 'D#5', 76: 'E5', 77: 'F5', 78: 'F#5', 79: 'G5',
            80: 'G#5', 81: 'A5', 82: 'A#5', 83: 'B5', 84: 'C6'
        };


// Generate MIDI note numbers for all keys (C2 = 36 to C7 = 96)
        for (let i = 36; i <= 96; i++) {
            const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            const noteName = noteNames[i % 12];
            const octave = Math.floor(i / 12) - 1;
            MIDI_TO_NOTE[i] = `${noteName}${octave}`;
        }        




// Add responsive sizing CSS
        const styles = `
            :root {
                --white-key-width: min(25px, 5vw);  /* Reduced width for more keys */
                --black-key-width: calc(var(--white-key-width) * 0.6);
                --white-key-height: min(120px, 25vh);
                --canvas-height: min(400px, 60vh);
            }

            .piano-container {
                width: 100%;
                overflow-x: auto;  /* Allow scrolling for smaller screens */
                position: relative;
                height: var(--white-key-height);
                display: flex;
                justify-content: flex-start;
                padding-bottom: 10px;  /* Space for scrollbar */
            }

            /* Add smooth scrolling */
            .piano-container {
                scroll-behavior: smooth;
            }

            /* Make keys slightly smaller on mobile */
            @media (max-width: 768px) {
                :root {
                    --white-key-width: min(20px, 4vw);
                }
            }

            /* Adjust for larger screens */
            @media (min-width: 1200px) {
                :root {
                    --white-key-width: min(30px, 6vw);
                }
            }

            /* Add visual indicator for middle C */
            .white-key[data-note="C4"]::after {
                content: "●";
                position: absolute;
                bottom: 5px;
                font-size: 8px;
                color: #666;
            }
        `;

        // Function to add styles to document
        function addStyles() {
            const styleSheet = document.createElement("style");
            styleSheet.textContent = styles;
            document.head.appendChild(styleSheet);
        }

        // Function to scroll to middle C on start
        function scrollToMiddleC() {
            const middleC = document.querySelector('[data-note="C4"]');
            if (middleC) {
                const container = document.querySelector('.piano-container');
                const scrollPos = middleC.offsetLeft - (container.clientWidth / 2) + (middleC.offsetWidth / 2);
                container.scrollTo(Math.max(0, scrollPos), 0);
            }
        }



        // Initialize MIDI
        async function initializeMIDI() {
            try {
                midiAccess = await navigator.requestMIDIAccess();
                midiEnabled = true;
                document.getElementById('midiButton').textContent = '🎹 MIDI Enabled';
                document.getElementById('midiButton').style.backgroundColor = '#4CAF50';
                
                // Set up MIDI input handling
                for (const input of midiAccess.inputs.values()) {
                    input.onmidimessage = handleMIDIMessage;
                }
                
                // Listen for MIDI device connections/disconnections
                midiAccess.onstatechange = (e) => {
                    if (e.port.type === 'input') {
                        if (e.port.state === 'connected') {
                            e.port.onmidimessage = handleMIDIMessage;
                        }
                    }
                };
            } catch (error) {
                console.error('MIDI access denied or not supported:', error);
                document.getElementById('midiButton').textContent = '❌ MIDI Not Available';
                document.getElementById('midiButton').style.backgroundColor = '#FF4444';
            }
        }

        // Handle MIDI messages
        function handleMIDIMessage(message) {
            const [command, note, velocity] = message.data;
            
            // Note on event (with velocity > 0)
            if ((command === 144) && (velocity > 0)) {
                const noteName = MIDI_TO_NOTE[note];
                if (noteName) {
                    handleNotePress(noteName);
                }
            }
            // Note off event (or note on with velocity 0)
            else if ((command === 128) || (command === 144 && velocity === 0)) {
                const noteName = MIDI_TO_NOTE[note];
                if (noteName) {
                    handleNoteRelease(noteName);
                }
            }
        }

        // Add MIDI button event listener
        document.getElementById('midiButton').addEventListener('click', async () => {
            if (!midiEnabled) {
                await initializeMIDI();
            }
        });





        // Canvas setup
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
        }

        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // Create piano keys
        const pianoContainer = document.getElementById('pianoContainer');

        function createPianoKeys() {
            // Create white keys
            WHITE_KEYS.forEach((note, index) => {
                const key = document.createElement('div');
                key.className = 'white-key';
                key.dataset.note = note;
                key.textContent = note;
                key.addEventListener('mousedown', () => handleNotePress(note));
                key.addEventListener('mouseup', () => handleNoteRelease(note));
                key.addEventListener('mouseleave', () => handleNoteRelease(note));
                pianoContainer.appendChild(key);
            });

            // Create black keys
            BLACK_KEYS.forEach(note => {
                const key = document.createElement('div');
                key.className = 'black-key';
                key.dataset.note = note;
                key.textContent = note;
                key.style.left = calculateBlackKeyPosition(note);
                key.addEventListener('mousedown', () => handleNotePress(note));
                key.addEventListener('mouseup', () => handleNoteRelease(note));
                key.addEventListener('mouseleave', () => handleNoteRelease(note));
                pianoContainer.appendChild(key);
            });
        }

// Fixed black key positioning calculation
        function calculateBlackKeyPosition(note) {
            // Parse the note and octave
            const baseNote = note.slice(0, -1);  // Get everything except the last character (octave)
            const octave = parseInt(note.slice(-1));  // Get the octave number
            
            // Calculate position based on note and octave
            let whiteKeysBeforeOctave = 0;
            
            // Count white keys before this octave
            if (octave > 2) {  // Assuming C2 is our starting octave
                whiteKeysBeforeOctave = (octave - 2) * 7;  // 7 white keys per octave
            }
            
            // Position within the octave
            let positionInOctave;
            switch(baseNote) {
                case 'C#': positionInOctave = 0.7; break;
                case 'D#': positionInOctave = 1.7; break;
                case 'F#': positionInOctave = 3.7; break;
                case 'G#': positionInOctave = 4.7; break;
                case 'A#': positionInOctave = 5.7; break;
                default: return '0px';
            }
            
            // Final position is the sum of keys before this octave plus position within octave
            const finalPosition = whiteKeysBeforeOctave + positionInOctave;
            
            return `calc(${finalPosition} * var(--white-key-width))`;
        }



        // Event handlers
        function handleNotePress(note) {
            if (!gameState.active || gameState.paused) return;
            
            gameState.pressedKeys.add(note);
            updateKeyDisplay();
            checkNoteHit(note);
        }

        function handleNoteRelease(note) {
            gameState.pressedKeys.delete(note);
            updateKeyDisplay();
        }

        function updateKeyDisplay() {
            document.querySelectorAll('.white-key, .black-key').forEach(key => {
                key.classList.remove('active', 'hint');
                
                if (gameState.pressedKeys.has(key.dataset.note)) {
                    key.classList.add('active');
                } else if (gameState.showHints && getCurrentNote() === key.dataset.note) {
                    key.classList.add('hint');
                }
            });
        }

        // Game logic

// Update the createFallingNote function
        function createFallingNote(note, duration) {
            const isBlack = note.includes('#');
            let x;
            
            if (isBlack) {
                x = calculateBlackKeyX(note);
            } else {
                // For white keys, find their index in the WHITE_KEYS array
                const whiteKeyIndex = WHITE_KEYS.indexOf(note);
                x = whiteKeyIndex * (canvas.width / WHITE_KEYS.length);
            }
            
            return {
                note,
                x,
                y: -50,
                width: isBlack ? 
                    (canvas.width / WHITE_KEYS.length * 0.6) :
                    (canvas.width / WHITE_KEYS.length),
                height: 40,
                duration,
                hit: false,
                missed: false
            };
        }


// Updated falling note position calculation
        function calculateBlackKeyX(note) {
            const baseNote = note.slice(0, -1);  // Get everything except the octave
            const octave = parseInt(note.slice(-1));
            const whiteKeysBeforeOctave = (octave - 2) * 7;  // 7 white keys per octave
            
            let positionInOctave;
            switch(baseNote) {
                case 'C#': positionInOctave = 0.7; break;
                case 'D#': positionInOctave = 1.7; break;
                case 'F#': positionInOctave = 3.7; break;
                case 'G#': positionInOctave = 4.7; break;
                case 'A#': positionInOctave = 5.7; break;
                default: return 0;
            }
            
            const finalPosition = whiteKeysBeforeOctave + positionInOctave;
            return (finalPosition * canvas.width / WHITE_KEYS.length);
        }


        function checkNoteHit(playedNote) {
            const hitWindow = 30;
            const perfectWindow = 15;
            
            for (let note of gameState.fallingNotes) {
                if (note.note === playedNote && !note.hit && !note.missed) {
                    const hitY = canvas.height - 50;
                    const distance = Math.abs(note.y - hitY);
                    
                    if (distance <= hitWindow) {
                        note.hit = true;
                        if (distance <= perfectWindow) {
                            showJudgment('PERFECT!', '#FFD700');
                            gameState.score += 100 * (gameState.combo + 1);
                        } else {
                            showJudgment('GOOD!', '#00FF00');
                            gameState.score += 50 * (gameState.combo + 1);
                        }
                        gameState.combo++;
                        gameState.maxCombo = Math.max(gameState.maxCombo, gameState.combo);
                        updateStats();
                        return;
                    }
                }
            }
            
            // Miss
            showJudgment('MISS!', '#FF0000');
            gameState.combo = 0;
            updateStats();
        }

        function showJudgment(text, color) {
            const judgment = document.createElement('div');
            judgment.className = 'judgment';
            judgment.style.color = color;
            judgment.textContent = text;
            judgment.style.left = '50%';
            judgment.style.top = '50%';
            judgment.style.transform = 'translate(-50%, -50%)';
            document.querySelector('.game-container').appendChild(judgment);
            
            setTimeout(() => judgment.remove(), 500);
        }

        function updateStats() {
            document.getElementById('stats').textContent = 
                `Score: ${gameState.score} | Combo: ${gameState.combo} | Max Combo: ${gameState.maxCombo}`;
        }

        function getCurrentNote() {
            return gameState.fallingNotes[0]?.note;
        }

        // Game loop
// Game loop
        function gameLoop() {
            if (!gameState.active || gameState.paused) return;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw hit line
            ctx.beginPath();
            ctx.strokeStyle = '#00FFFF';
            ctx.lineWidth = 2;
            ctx.moveTo(0, canvas.height - 50);
            ctx.lineTo(canvas.width, canvas.height - 50);
            ctx.stroke();
            
            // Update and draw falling notes
            gameState.fallingNotes = gameState.fallingNotes.filter(note => {
                note.y += gameState.noteSpeed;
                
                // Draw note
                ctx.fillStyle = note.hit ? '#00FF00' : 
                            note.missed ? '#FF0000' : '#FFFFFF';
                ctx.fillRect(note.x, note.y, note.width, note.height);
                
                // Check for misses
                if (note.y > canvas.height && !note.hit && !note.missed) {
                    note.missed = true;
                    gameState.combo = 0;
                    showJudgment('MISS!', '#FF0000');
                    updateStats();
                }
                
                return note.y < canvas.height + 50;
            });
            
            // Spawn new notes
            if (gameState.active && gameState.fallingNotes.length < 5) {
                const currentSongNotes = SONGS[gameState.currentSong];
                const lastNote = gameState.fallingNotes[gameState.fallingNotes.length - 1];
                const spacing = 100; // Vertical spacing between notes
                
                if (!lastNote || lastNote.y > spacing) {
                    // Get next note using currentNoteIndex
                    const nextNote = currentSongNotes[gameState.currentNoteIndex];
                    if (nextNote) {
                        gameState.fallingNotes.push(createFallingNote(nextNote[0], nextNote[1]));
                        gameState.currentNoteIndex++;
                        
                        // Reset index when we reach the end of the song
                        if (gameState.currentNoteIndex >= currentSongNotes.length) {
                            gameState.currentNoteIndex = 0;
                        }
                    }
                }
            }
            
            requestAnimationFrame(gameLoop);
        }

        // Game controls
        document.getElementById('startButton').addEventListener('click', toggleGame);
        document.getElementById('resetButton').addEventListener('click', resetGame);
        document.getElementById('hintButton').addEventListener('click', toggleHints);
        document.getElementById('songSelect').addEventListener('change', changeSong);

        // Keyboard events
        document.addEventListener('keydown', (event) => {
            const note = KEYBOARD_MAP[event.key.toLowerCase()];
            if (note && !gameState.pressedKeys.has(note)) {
                handleNotePress(note);
            }
        });

        document.addEventListener('keyup', (event) => {
            const note = KEYBOARD_MAP[event.key.toLowerCase()];
            if (note) {
                handleNoteRelease(note);
            }
        });

        // Touch events for mobile
        let touchStartY;
        document.addEventListener('touchstart', (event) => {
            touchStartY = event.touches[0].clientY;
            const element = document.elementFromPoint(
                event.touches[0].clientX,
                event.touches[0].clientY
            );
            if (element && element.dataset.note) {
                handleNotePress(element.dataset.note);
            }
        }, { passive: true });

        document.addEventListener('touchend', (event) => {
            const element = document.elementFromPoint(
                event.changedTouches[0].clientX,
                event.changedTouches[0].clientY
            );
            if (element && element.dataset.note) {
                handleNoteRelease(element.dataset.note);
            }
        }, { passive: true });

        // Game control functions
        function toggleGame() {
            if (!gameState.active) {
                startGame();
            } else {
                togglePause();
            }
        }

        function startGame() {
            gameState.active = true;
            gameState.paused = false;
            gameState.fallingNotes = [];
            gameState.currentNoteIndex = 0;  // Reset note index when starting new game
            document.getElementById('startButton').textContent = '⏸ Pause';
            gameLoop();
        }



        // Add tempo control
        const tempoSlider = document.getElementById('tempoSlider');
        const tempoValue = document.getElementById('tempoValue');

        tempoSlider.addEventListener('input', (e) => {
            const speed = parseFloat(e.target.value);
            gameState.noteSpeed = speed;
            tempoValue.textContent = `${speed.toFixed(1)}x`;
        });




// Set initial tempo
        gameState.noteSpeed = parseFloat(tempoSlider.value);
        tempoValue.textContent = `${gameState.noteSpeed.toFixed(1)}x`;

        // Add event listeners
        document.getElementById('startButton').addEventListener('click', toggleGame);
        document.getElementById('resetButton').addEventListener('click', resetGame);
        document.getElementById('songSelect').addEventListener('change', changeSong);


        function togglePause() {
            gameState.paused = !gameState.paused;
            document.getElementById('startButton').textContent = 
                gameState.paused ? '▶ Resume' : '⏸ Pause';
            if (!gameState.paused) {
                gameLoop();
            }
        }


// Reset function
        function resetGame() {
            gameState = {
                ...gameState,
                active: false,
                paused: false,
                score: 0,
                combo: 0,
                maxCombo: 0,
                fallingNotes: [],
                pressedKeys: new Set(),
                currentNoteIndex: 0  // Reset the note index
            };
            
            document.getElementById('startButton').textContent = '▶ Start';
            updateStats();
            updateKeyDisplay();
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function toggleHints() {
            gameState.showHints = !gameState.showHints;
            document.getElementById('hintButton').textContent = 
                gameState.showHints ? '💡 Hide Hints' : '💡 Show Hints';
            updateKeyDisplay();
        }

// Change song function
        function changeSong(event) {
            gameState.currentSong = event.target.value;
            gameState.currentNoteIndex = 0;  // Reset note index when changing songs
            resetGame();
        }

        // Visual effects
        function createParticles(x, y, color, count) {
            const particles = [];
            for (let i = 0; i < count; i++) {
                const angle = (Math.PI * 2 * i) / count;
                const speed = 2 + Math.random() * 2;
                particles.push({
                    x,
                    y,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed,
                    life: 1,
                    color
                });
            }
            return particles;
        }

        function updateParticles(particles) {
            return particles.filter(particle => {
                particle.x += particle.vx;
                particle.y += particle.vy;
                particle.vy += 0.1; // gravity
                particle.life -= 0.02;
                
                if (particle.life > 0) {
                    ctx.fillStyle = `rgba(${particle.color}, ${particle.life})`;
                    ctx.beginPath();
                    ctx.arc(particle.x, particle.y, 2, 0, Math.PI * 2);
                    ctx.fill();
                    return true;
                }
                return false;
            });
        }

        // Mobile responsiveness
        function checkMobileOrientation() {
            const warning = document.getElementById('orientationWarning') || 
                           document.createElement('div');
            warning.id = 'orientationWarning';
            warning.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                background: #ff4444;
                color: white;
                padding: 10px;
                text-align: center;
                display: none;
                z-index: 1000;
            `;
            warning.textContent = 'Please rotate your device to landscape mode for better gameplay';
            
            if (!document.getElementById('orientationWarning')) {
                document.body.appendChild(warning);
            }
            
            if (window.innerHeight > window.innerWidth && window.innerWidth < 768) {
                warning.style.display = 'block';
            } else {
                warning.style.display = 'none';
            }
        }

        window.addEventListener('resize', checkMobileOrientation);
        window.addEventListener('orientationchange', checkMobileOrientation);


    // Properly close the DOMContentLoaded listener
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize the game
            createPianoKeys();
            checkMobileOrientation();
            
            // Initialize tempo
            const tempoSlider = document.getElementById('tempoSlider');
            const tempoValue = document.getElementById('tempoValue');
            gameState.noteSpeed = parseFloat(tempoSlider.value);
            tempoValue.textContent = `${gameState.noteSpeed.toFixed(1)}x`;
            
            // Add event listeners
            tempoSlider.addEventListener('input', (e) => {
                const speed = parseFloat(e.target.value);
                gameState.noteSpeed = speed;
                tempoValue.textContent = `${speed.toFixed(1)}x`;
            });
        });
    </script>



<!-- Add some CSS for the tempo control -->
    <style>
        .tempo-control {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 5px;
        }
        
        .tempo-control input[type="range"] {
            width: 100px;
        }
    </style>


</body>
</html>