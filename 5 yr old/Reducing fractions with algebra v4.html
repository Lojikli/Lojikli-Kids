<!DOCTYPE html>
<html>
<head>
  <style>
    /* [Previous styles remain the same until .variable-term] */

    .variable-term {
      display: flex;
      align-items: baseline;
      margin: 0 2px;
      position: relative;
    }

    .exponent-input {
      position: absolute;
      top: -10px;
      left: 100%;
      width: 25px;
      height: 25px;
      font-size: 0.8rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      text-align: center;
      margin-left: 2px;
      background: transparent;
    }

    .exponent-display {
      position: absolute;
      top: -10px;
      left: 100%;
      font-size: 0.8rem;
      color: #000;
    }

    /* [Rest of previous styles remain the same] */
  </style>
</head>
<body>
  <!-- [Previous HTML remains the same] -->

  <script>
    // [Previous constants and variables remain the same]

    function simplifyFraction(term) {
      // Sort variables and combine like terms
      const simplified = {
        coefficient: term.coefficient,
        variables: [...term.variables]
      };
      
      // Sort variables alphabetically
      simplified.variables.sort((a, b) => a.var.localeCompare(b.var));
      
      // Combine like variables
      const combined = {};
      simplified.variables.forEach(v => {
        if (combined[v.var]) {
          combined[v.var] += v.power;
        } else {
          combined[v.var] = v.power;
        }
      });
      
      // Convert back to array format
      simplified.variables = Object.entries(combined).map(([v, power]) => ({
        var: v,
        power: power
      }));
      
      return simplified;
    }

    function areTermsEqual(term1, term2) {
      const simplified1 = simplifyFraction(term1);
      const simplified2 = simplifyFraction(term2);
      
      // Check coefficients
      if (simplified1.coefficient !== simplified2.coefficient) return false;
      
      // Check variables
      if (simplified1.variables.length !== simplified2.variables.length) return false;
      
      // Compare each variable and its power
      for (let i = 0; i < simplified1.variables.length; i++) {
        const var1 = simplified1.variables[i];
        const var2 = simplified2.variables[i];
        if (var1.var !== var2.var || var1.power !== var2.power) return false;
      }
      
      return true;
    }

    function getInputTerms() {
      function getTerms(containerId) {
        const container = document.getElementById(containerId);
        const coefficient = parseInt(container.querySelector('.coefficient-input').value) || 1;
        const variables = [];
        container.querySelectorAll('.variable-term').forEach(term => {
          const varInput = term.querySelector('.variable-input');
          const expInput = term.querySelector('.exponent-input');
          if (varInput.value) {
            variables.push({
              var: varInput.value,
              power: parseInt(expInput.value) || 1
            });
          }
        });
        return { coefficient, variables };
      }

      return {
        numerator: getTerms('numeratorContainer'),
        denominator: getTerms('denominatorContainer')
      };
    }

    function simplifyCompleteExpression(expr) {
      // Get GCD of coefficients
      const num = expr.numerator.coefficient;
      const den = expr.denominator.coefficient;
      const gcd = (a, b) => b ? gcd(b, a % b) : a;
      const coefficientGcd = gcd(num, den);
      
      // Simplify coefficients
      const simplified = {
        numerator: {
          coefficient: num / coefficientGcd,
          variables: [...expr.numerator.variables]
        },
        denominator: {
          coefficient: den / coefficientGcd,
          variables: [...expr.denominator.variables]
        }
      };
      
      // Simplify variables
      const numVars = {};
      const denVars = {};
      
      // Count variables in numerator
      simplified.numerator.variables.forEach(v => {
        numVars[v.var] = (numVars[v.var] || 0) + v.power;
      });
      
      // Count variables in denominator
      simplified.denominator.variables.forEach(v => {
        denVars[v.var] = (denVars[v.var] || 0) + v.power;
      });
      
      // Cancel out common variables
      Object.keys(numVars).forEach(v => {
        if (denVars[v]) {
          const min = Math.min(numVars[v], denVars[v]);
          numVars[v] -= min;
          denVars[v] -= min;
          if (numVars[v] === 0) delete numVars[v];
          if (denVars[v] === 0) delete denVars[v];
        }
      });
      
      // Convert back to array format
      simplified.numerator.variables = Object.entries(numVars)
        .filter(([_, power]) => power > 0)
        .map(([v, power]) => ({ var: v, power }))
        .sort((a, b) => a.var.localeCompare(b.var));
      
      simplified.denominator.variables = Object.entries(denVars)
        .filter(([_, power]) => power > 0)
        .map(([v, power]) => ({ var: v, power }))
        .sort((a, b) => a.var.localeCompare(b.var));
      
      return simplified;
    }

    function checkAnswer() {
      const userInput = getInputTerms();
      const simplifiedUser = simplifyCompleteExpression(userInput);
      const simplifiedProblem = simplifyCompleteExpression(currentProblem);
      
      const isCorrect = (
        simplifiedUser.numerator.coefficient === simplifiedProblem.numerator.coefficient &&
        simplifiedUser.denominator.coefficient === simplifiedProblem.denominator.coefficient &&
        areTermsEqual(simplifiedUser.numerator, simplifiedProblem.numerator) &&
        areTermsEqual(simplifiedUser.denominator, simplifiedProblem.denominator)
      );
      
      const feedback = document.getElementById('feedback');
      
      if (isCorrect) {
        feedback.textContent = 'Correct!';
        feedback.className = 'feedback correct';
        correctCount++;
        setTimeout(nextProblem, 1500);
      } else {
        feedback.textContent = 'Try again';
        feedback.className = 'feedback incorrect';
        incorrectCount++;
      }
      
      updateScore();
    }

    function addVariableTerm(target) {
      const container = document.getElementById(`${target}Container`);
      const newTerm = document.createElement('div');
      newTerm.className = 'variable-term animate-in';
      newTerm.innerHTML = `
        <input type="text" class="variable-input" placeholder="x" maxlength="1" pattern="[a-z]" oninput="validateVariable(this)">
        <input type="number" class="exponent-input" value="1" min="1" max="9" onchange="updateExponentDisplay(this)">
        <span class="exponent-display">ยน</span>
        <button class="btn remove" onclick="this.parentElement.remove()">ร</button>
      `;
      container.insertBefore(newTerm, container.lastElementChild);
    }

    function updateExponentDisplay(input) {
      const display = input.nextElementSibling;
      const power = parseInt(input.value) || 1;
      display.textContent = SUPERSCRIPTS[power - 1] || 'ยน';
    }

    // Add event listeners for exponent updates
    document.querySelectorAll('.exponent-input').forEach(input => {
      input.addEventListener('change', () => updateExponentDisplay(input));
      // Initial display
      updateExponentDisplay(input);
    });

    // [Rest of previous functions remain the same]

    // Initialize first problem
    generateProblem();
  </script>
</body>
</html>