<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Adventure: Limits and Asymptotes</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Comic Sans MS', cursive, sans-serif;
        }

        body {
            background-color: #f0f8ff;
            overflow-x: hidden;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        h2 {
            font-size: 1.8em;
            color: #4a4a9c;
            margin: 20px 0;
            border-bottom: 2px solid #4a4a9c;
            padding-bottom: 10px;
        }

        p {
            font-size: 1.2em;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .game-section {
            background-color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }

        .game-section:hover {
            transform: translateY(-5px);
        }

        .character {
            width: 100px;
            height: 100px;
            margin: 10px;
            display: inline-block;
            text-align: center;
        }

        .character img {
            width: 100%;
            height: auto;
        }

        .btn {
            background-color: #4a4a9c;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s;
        }

        .btn:hover {
            background-color: #6a6acc;
        }

        .btn-primary {
            background-color: #ff6b6b;
        }

        .btn-primary:hover {
            background-color: #ff8e8e;
        }

        canvas {
            border: 3px solid #4a4a9c;
            border-radius: 10px;
            margin: 10px auto;
            display: block;
        }

        #gameCanvas {
            margin: 20px auto;
            display: block;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin: 15px 0;
        }

        .slider-container {
            margin: 10px;
            width: 200px;
        }

        .slider-container label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #4a4a9c;
        }

        input[type="range"] {
            width: 100%;
        }

        .quiz-container {
            background-color: #e6f7ff;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }

        .quiz-question {
            font-size: 1.3em;
            margin-bottom: 15px;
            color: #4a4a9c;
        }

        .quiz-options {
            display: flex;
            flex-direction: column;
            margin-bottom: 15px;
        }

        .quiz-option {
            margin: 5px 0;
            padding: 10px;
            border: 2px solid #ccc;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .quiz-option:hover {
            background-color: #f0f0f0;
        }

        .feedback {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            display: none;
        }

        .correct {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .incorrect {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .character-dialogue {
            background-color: #fff;
            border: 2px solid #4a4a9c;
            border-radius: 15px;
            padding: 15px;
            margin: 10px 0;
            position: relative;
        }

        .character-dialogue:before {
            content: "";
            position: absolute;
            top: 20px;
            left: -15px;
            border-width: 8px;
            border-style: solid;
            border-color: transparent #4a4a9c transparent transparent;
        }

        .progress-container {
            width: 100%;
            height: 20px;
            background-color: #e0e0e0;
            border-radius: 10px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            width: 0;
            background: linear-gradient(135deg, #ff6b6b 0%, #ffa502 100%);
            border-radius: 10px;
            transition: width 0.5s;
        }

        .popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
        }

        .popup-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border-radius: 15px;
            max-width: 80%;
            max-height: 80%;
            overflow-y: auto;
        }

        .close-popup {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.5em;
            cursor: pointer;
        }

        .badge {
            display: inline-block;
            padding: 5px 10px;
            background-color: gold;
            color: #333;
            border-radius: 20px;
            margin: 5px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: center;
            }

            .slider-container {
                width: 80%;
            }
        }
        
        .tab-container {
            margin: 20px 0;
        }
        
        .tab-buttons {
            display: flex;
            overflow-x: auto;
            margin-bottom: 10px;
        }
        
        .tab-button {
            background-color: #e0e0e0;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            transition: background-color 0.3s;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
        }
        
        .tab-button.active {
            background-color: #4a4a9c;
            color: white;
        }
        
        .tab-content {
            display: none;
            padding: 15px;
            background-color: white;
            border-radius: 0 0 5px 5px;
            border: 2px solid #4a4a9c;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .celebration {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }
        
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #f00;
            animation: fall 5s linear forwards;
        }
        
        @keyframes fall {
            0% {
                transform: translateY(-100px) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        .character-container {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .character-avatar {
            width: 100px;
            height: 100px;
            margin-right: 15px;
            border-radius: 50%;
            background-color: #4a4a9c;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 40px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        #parameters-container {
            background-color: #fff;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .param-group {
            margin-bottom: 15px;
        }

        .param-label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #4a4a9c;
        }

        .param-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-bottom: 5px;
        }

        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
            margin-left: 5px;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        .advanced-toggle {
            background-color: transparent;
            border: none;
            color: #4a4a9c;
            text-decoration: underline;
            cursor: pointer;
            margin: 10px 0;
        }

        .advanced-params {
            display: none;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 5px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Math Adventure: Limits and Asymptotes</h1>
            <p>Join Professor Integer and friends on an exciting journey through the world of calculus!</p>
        </header>

        <div class="game-section">
            <div class="character-container">
                <div class="character-avatar">π</div>
                <div class="character-dialogue">
                    <p>Hello young mathematician! I'm Professor Integer, and I'll be your guide to the fascinating world of limits and asymptotes! These might sound like big words, but we'll make them fun and easy to understand.</p>
                </div>
            </div>

            <h2>Choose Your Adventure</h2>
            <div class="tab-container">
                <div class="tab-buttons">
                    <button class="tab-button active" onclick="openTab(event, 'intro')">Introduction</button>
                    <button class="tab-button" onclick="openTab(event, 'limits')">Limits</button>
                    <button class="tab-button" onclick="openTab(event, 'asymptotes')">Asymptotes</button>
                    <button class="tab-button" onclick="openTab(event, 'playground')">Math Playground</button>
                    <button class="tab-button" onclick="openTab(event, 'quiz')">Quiz Challenge</button>
                </div>

                <div id="intro" class="tab-content active">
                    <div class="character-container">
                        <div class="character-avatar">L</div>
                        <div class="character-dialogue">
                            <p>Hi there! I'm Lily Limit! I'm excited to show you how math can help us understand what happens when numbers get really, really big or really, really small!</p>
                        </div>
                    </div>

                    <p>Imagine you're walking toward a wall. Each step you take gets you closer to the wall, but you never actually touch it. In math, we call this special kind of approaching a <strong>limit</strong>!</p>

                    <div class="character-container">
                        <div class="character-avatar">A</div>
                        <div class="character-dialogue">
                            <p>And I'm Alex Asymptote! I'll show you what happens when lines almost touch but never quite meet. It's like having an invisible force field that keeps them apart!</p>
                        </div>
                    </div>

                    <p>When you see a roller coaster track that goes up and up but never quite reaches a certain line, that's an <strong>asymptote</strong>! It's like an invisible boundary that the track gets closer and closer to but never crosses.</p>

                    <div id="introCanvas" style="width: 100%; height: 300px;"></div>
                    
                    <button class="btn btn-primary" onclick="openTab(event, 'limits')">Start the Adventure!</button>
                </div>

                <div id="limits" class="tab-content">
                    <h2>Understanding Limits</h2>
                    
                    <div class="character-container">
                        <div class="character-avatar">L</div>
                        <div class="character-dialogue">
                            <p>A limit is what a function approaches as the input gets closer and closer to a specific value!</p>
                        </div>
                    </div>

                    <p>Imagine you have a robot that can take any number of steps toward a treasure chest. Each time, the robot moves half the remaining distance to the chest.</p>
                    <p>If the robot starts 10 feet away:</p>
                    <ul>
                        <li>First step: Moves 5 feet (now 5 feet away)</li>
                        <li>Second step: Moves 2.5 feet (now 2.5 feet away)</li>
                        <li>Third step: Moves 1.25 feet (now 1.25 feet away)</li>
                        <li>And so on...</li>
                    </ul>

                    <p>The robot keeps getting closer and closer to the treasure chest, but never quite reaches it! The <strong>limit</strong> of the robot's position is the treasure chest!</p>

                    <div id="limitCanvas" style="width: 100%; height: 300px;"></div>

                    <div class="controls">
                        <div class="slider-container">
                            <label for="stepsSlider">Number of Steps:</label>
                            <input type="range" id="stepsSlider" min="1" max="10" value="1" onchange="updateLimitDemo()">
                            <span id="stepsValue">1</span>
                        </div>
                    </div>

                    <h3>Approaching from Different Sides</h3>
                    <p>Sometimes a limit can be different depending on which direction you approach from!</p>
                    
                    <div id="approachCanvas" style="width: 100%; height: 300px;"></div>
                    
                    <div class="controls">
                        <div class="slider-container">
                            <label for="approachSlider">Approach x = 0 from:</label>
                            <input type="range" id="approachSlider" min="-0.9" max="0.9" step="0.1" value="-0.9" onchange="updateApproachDemo()">
                            <span id="approachValue">-0.9</span>
                        </div>
                    </div>
                    
                    <button class="btn" onclick="openTab(event, 'intro')">Back</button>
                    <button class="btn btn-primary" onclick="openTab(event, 'asymptotes')">Continue to Asymptotes</button>
                </div>

                <div id="asymptotes" class="tab-content">
                    <h2>Exploring Asymptotes</h2>
                    
                    <div class="character-container">
                        <div class="character-avatar">A</div>
                        <div class="character-dialogue">
                            <p>Asymptotes are special lines that a graph gets closer and closer to but never touches!</p>
                        </div>
                    </div>

                    <p>There are three types of asymptotes:</p>
                    <ol>
                        <li><strong>Vertical Asymptotes:</strong> These happen when the function value gets extremely large (or small) as x approaches a specific value.</li>
                        <li><strong>Horizontal Asymptotes:</strong> These happen when the function approaches a specific y-value as x gets extremely large (positive or negative).</li>
                        <li><strong>Slant Asymptotes:</strong> These are diagonal lines that the function approaches as x gets extremely large.</li>
                    </ol>

                    <div id="asymptoteCanvas" style="width: 100%; height: 300px;"></div>
                    
                    <div class="controls">
                        <div class="slider-container">
                            <label for="asymptoteTypeSlider">Asymptote Type:</label>
                            <input type="range" id="asymptoteTypeSlider" min="1" max="3" value="1" onchange="updateAsymptoteDemo()">
                            <span id="asymptoteTypeValue">Vertical</span>
                        </div>
                    </div>
                    
                    <h3>Vertical Asymptotes</h3>
                    <p>These occur when the denominator of a fraction equals zero. The function shoots up or down toward infinity!</p>
                    <p>For example, in the function f(x) = 1/(x-2), there's a vertical asymptote at x = 2 because we can't divide by zero.</p>
                    
                    <h3>Horizontal Asymptotes</h3>
                    <p>These show what happens to a function as x gets super big or super small. The function gets closer and closer to a horizontal line.</p>
                    <p>For example, f(x) = 3 + 1/x approaches the horizontal line y = 3 as x gets very large.</p>
                    
                    <h3>Slant Asymptotes</h3>
                    <p>These are diagonal lines that the function approaches as x gets very large or small.</p>
                    <p>For example, f(x) = (x² + 1)/x approaches the line y = x as x gets very large.</p>
                    
                    <button class="btn" onclick="openTab(event, 'limits')">Back</button>
                    <button class="btn btn-primary" onclick="openTab(event, 'playground')">Continue to Math Playground</button>
                </div>

                <div id="playground" class="tab-content">
                    <h2>Math Playground</h2>
                    
                    <div class="character-container">
                        <div class="character-avatar">π</div>
                        <div class="character-dialogue">
                            <p>Now it's time to play with math! Change the values below to see how limits and asymptotes work!</p>
                        </div>
                    </div>

                    <div id="playgroundCanvas" style="width: 100%; height: 400px;"></div>

                    <div id="parameters-container">
                        <h3>Function Parameters</h3>
                        <p>Change these values to explore different functions:</p>
                        
                        <div class="param-group">
                            <div class="param-label">
                                Function Type:
                                <div class="tooltip">ⓘ
                                    <span class="tooltiptext">Choose what kind of function to explore</span>
                                </div>
                            </div>
                            <select id="functionType" class="param-input" onchange="updateFunctionType()">
                                <option value="rational">Rational Function (p(x)/q(x))</option>
                                <option value="trig">Trigonometric Function</option>
                                <option value="log">Logarithmic Function</option>
                                <option value="exp">Exponential Function</option>
                                <option value="custom">Custom Function</option>
                            </select>
                        </div>
                        
                        <div id="rational-params">
                            <div class="param-group">
                                <div class="param-label">
                                    Numerator:
                                    <div class="tooltip">ⓘ
                                        <span class="tooltiptext">The polynomial on top (e.g., x², 2x+1)</span>
                                    </div>
                                </div>
                                <input type="text" id="numerator" class="param-input" value="1" onchange="updateFunction()">
                            </div>
                            
                            <div class="param-group">
                                <div class="param-label">
                                    Denominator:
                                    <div class="tooltip">ⓘ
                                        <span class="tooltiptext">The polynomial on bottom (e.g., x-2, x²-4)</span>
                                    </div>
                                </div>
                                <input type="text" id="denominator" class="param-input" value="x-2" onchange="updateFunction()">
                            </div>
                        </div>
                        
                        <div id="trig-params" style="display:none;">
                            <div class="param-group">
                                <div class="param-label">
                                    Amplitude:
                                    <div class="tooltip">ⓘ
                                        <span class="tooltiptext">How tall the waves are</span>
                                    </div>
                                </div>
                                <input type="number" id="amplitude" class="param-input" value="1" min="0.1" max="10" step="0.1" onchange="updateFunction()">
                            </div>
                            
                            <div class="param-group">
                                <div class="param-label">
                                    Period Factor:
                                    <div class="tooltip">ⓘ
                                        <span class="tooltiptext">How quickly the waves repeat</span>
                                    </div>
                                </div>
                                <input type="number" id="frequency" class="param-input" value="1" min="0.1" max="10" step="0.1" onchange="updateFunction()">
                            </div>
                        </div>
                        
                        <div id="log-params" style="display:none;">
                            <div class="param-group">
                                <div class="param-label">
                                    Base:
                                    <div class="tooltip">ⓘ
                                        <span class="tooltiptext">The base of the logarithm (e.g., 10, e, 2)</span>
                                    </div>
                                </div>
                                <select id="logBase" class="param-input" onchange="updateFunction()">
                                    <option value="10">10 (common log)</option>
                                    <option value="e">e (natural log)</option>
                                    <option value="2">2 (binary log)</option>
                                </select>
                            </div>
                            
                            <div class="param-group">
                                <div class="param-label">
                                    Shift:
                                    <div class="tooltip">ⓘ
                                        <span class="tooltiptext">Shift the function left or right</span>
                                    </div>
                                </div>
                                <input type="number" id="logShift" class="param-input" value="0" min="-10" max="10" step="0.5" onchange="updateFunction()">
                            </div>
                        </div>
                        
                        <div id="exp-params" style="display:none;">
                            <div class="param-group">
                                <div class="param-label">
                                    Base:
                                    <div class="tooltip">ⓘ
                                        <span class="tooltiptext">The base of the exponent (e.g., 10, e, 2)</span>
                                    </div>
                                </div>
                                <select id="expBase" class="param-input" onchange="updateFunction()">
                                    <option value="e">e (≈ 2.718...)</option>
                                    <option value="2">2</option>
                                    <option value="10">10</option>
                                </select>
                            </div>
                            
                            <div class="param-group">
                                <div class="param-label">
                                    Coefficient:
                                    <div class="tooltip">ⓘ
                                        <span class="tooltiptext">Multiplier for the exponent</span>
                                    </div>
                                </div>
                                <input type="number" id="expCoeff" class="param-input" value="1" min="-5" max="5" step="0.1" onchange="updateFunction()">
                            </div>
                        </div>
                        
                        <div id="custom-params" style="display:none;">
                            <div class="param-group">
                                <div class="param-label">
                                    Custom Formula:
                                    <div class="tooltip">ⓘ
                                        <span class="tooltiptext">Enter a formula using x (e.g., sin(x)/x, x^2-4)</span>
                                    </div>
                                </div>
                                <input type="text" id="customFormula" class="param-input" value="sin(x)/x" onchange="updateFunction()">
                            </div>
                        </div>
                        
                        <button class="advanced-toggle" id="advancedToggle" onclick="toggleAdvancedParams()">Show Advanced Options</button>
                        
                        <div class="advanced-params" id="advancedParams">
                            <div class="param-group">
                                <div class="param-label">
                                    X-Axis Range:
                                    <div class="tooltip">ⓘ
                                        <span class="tooltiptext">How far to zoom in or out on the x-axis</span>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 10px;">
                                    <input type="number" id="xMin" class="param-input" value="-10" min="-100" max="0" step="1" onchange="updateFunctionRange()" style="width: 45%;">
                                    <span>to</span>
                                    <input type="number" id="xMax" class="param-input" value="10" min="0" max="100" step="1" onchange="updateFunctionRange()" style="width: 45%;">
                                </div>
                            </div>
                            
                            <div class="param-group">
                                <div class="param-label">
                                    Y-Axis Range:
                                    <div class="tooltip">ⓘ
                                        <span class="tooltiptext">How far to zoom in or out on the y-axis</span>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 10px;">
                                    <input type="number" id="yMin" class="param-input" value="-10" min="-100" max="0" step="1" onchange="updateFunctionRange()" style="width: 45%;">
                                    <span>to</span>
                                    <input type="number" id="yMax" class="param-input" value="10" min="0" max="100" step="1" onchange="updateFunctionRange()" style="width: 45%;">
                                </div>
                            </div>
                            
                            <div class="param-group">
                                <div class="param-label">
                                    Show:
                                </div>
                                <div>
                                    <input type="checkbox" id="showAsymptotes" checked onchange="updateFunction()">
                                    <label for="showAsymptotes">Show Asymptotes</label>
                                </div>
                                <div>
                                    <input type="checkbox" id="showLimits" checked onchange="updateFunction()">
                                    <label for="showLimits">Show Limits</label>
                                </div>
                                <div>
                                    <input type="checkbox" id="showGrid" checked onchange="updateFunction()">
                                    <label for="showGrid">Show Grid</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <h3>What's Happening?</h3>
                    <div id="mathExplanation" class="character-dialogue">
                        <p>As you change the function, watch how the graph changes! Look for where the graph approaches lines but never touches them - those are the asymptotes!</p>
                    </div>
                    
                    <button class="btn" onclick="openTab(event, 'asymptotes')">Back</button>
                    <button class="btn btn-primary" onclick="openTab(event, 'quiz')">Test Your Knowledge</button>
                </div>

                <div id="quiz" class="tab-content">
                    <h2>Quiz Challenge</h2>
                    
                    <div class="character-container">
                        <div class="character-avatar">π</div>
                        <div class="character-dialogue">
                            <p>Let's see how much you've learned! Answer these questions to earn your Math Explorer badge!</p>
                        </div>
                    </div>

                    <div class="progress-container">
                        <div class="progress-bar" id="quizProgress"></div>
                    </div>

                    <div id="quizContainer">
                        <!-- Quiz questions will be loaded here -->
                    </div>
                    
                    <button class="btn" onclick="openTab(event, 'playground')">Back to Playground</button>
                </div>
            </div>
        </div>

        <div id="celebrationContainer" class="celebration"></div>

        <div id="congratsPopup" class="popup">
            <div class="popup-content">
                <span class="close-popup" onclick="closePopup('congratsPopup')">&times;</span>
                <h2>Congratulations!</h2>
                <p>You've earned your Math Explorer badge!</p>
                <div style="text-align: center; margin: 20px 0;">
                    <div class="badge">Limits & Asymptotes Master</div>
                </div>
                <div class="character-container">
                    <div class="character-avatar">π</div>
                    <div class="character-dialogue">
                        <p>Amazing job! You're on your way to becoming a calculus genius! Remember, limits and asymptotes are all around us - they help us understand what happens when things get really big or really small!</p>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="closePopup('congratsPopup')">Continue Exploring</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let p5Canvas;
        let currentQuestionIndex = 0;
        let quizScore = 0;
        const totalQuizQuestions = 5;
        let currentFunction = {
            type: 'rational',
            params: {
                numerator: '1',
                denominator: 'x-2',
                amplitude: 1,
                frequency: 1,
                logBase: 'e',
                logShift: 0,
                expBase: 'e',
                expCoeff: 1,
                customFormula: 'sin(x)/x'
            },
            range: {
                xMin: -10,
                xMax: 10,
                yMin: -10,
                yMax: 10
            },
            showAsymptotes: true,
            showLimits: true,
            showGrid: true
        };

        // P5.js sketch for introduction animation
        new p5(sketch => {
            let x = 0;
            let direction = 1;
            let graphY = [];
            
            sketch.setup = function() {
                const canvas = sketch.createCanvas(document.getElementById('introCanvas').offsetWidth, 300);
                canvas.parent('introCanvas');
                
                // Precompute graph points
                for (let i = 0; i < sketch.width; i++) {
                    let xVal = sketch.map(i, 0, sketch.width, -10, 10);
                    graphY[i] = 100 / (xVal + 3);
                }
            };
            
            sketch.draw = function() {
                sketch.background(240);
                sketch.noFill();
                
                // Draw coordinate system
                sketch.stroke(0);
                sketch.line(0, sketch.height/2, sketch.width, sketch.height/2); // x-axis
                sketch.line(sketch.width/2, 0, sketch.width/2, sketch.height); // y-axis
                
                // Draw tick marks
                for (let i = -5; i <= 5; i++) {
                    let xPos = sketch.map(i, -10, 10, 0, sketch.width);
                    sketch.line(xPos, sketch.height/2-5, xPos, sketch.height/2+5);
                    sketch.textAlign(sketch.CENTER);
                    sketch.textSize(12);
                    if (i !== 0) {
                        sketch.text(i, xPos, sketch.height/2+20);
                    }
                }
                
                for (let i = -5; i <= 5; i++) {
                    if (i === 0) continue;
                    let yPos = sketch.map(i, -10, 10, sketch.height, 0);
                    sketch.line(sketch.width/2-5, yPos, sketch.width/2+5, yPos);
                    sketch.textAlign(sketch.RIGHT);
                    sketch.text(i, sketch.width/2-10, yPos+4);
                }
                
                // Draw graph with vertical asymptote
                sketch.stroke(255, 0, 0);
                sketch.beginShape();
                for (let i = 0; i < sketch.width; i++) {
                    let xVal = sketch.map(i, 0, sketch.width, -10, 10);
                    if (Math.abs(xVal + 3) < 0.1) continue; // Skip near asymptote
                    
                    let y = sketch.map(graphY[i], -10, 10, sketch.height, 0);
                    if (y > 0 && y < sketch.height) {
                        sketch.vertex(i, y);
                    }
                }
                sketch.endShape();
                
                // Draw vertical asymptote
                sketch.stroke(0, 0, 255);
                sketch.setLineDash([5, 5]);
                let asymptoteX = sketch.map(-3, -10, 10, 0, sketch.width);
                sketch.line(asymptoteX, 0, asymptoteX, sketch.height);
                sketch.setLineDash([]);
                
                // Draw walking character approaching asymptote
                x += 0.5 * direction;
                if (x > asymptoteX - 30) {
                    direction = -1;
                } else if (x < 50) {
                    direction = 1;
                }
                
                sketch.fill(255, 100, 100);
                sketch.noStroke();
                sketch.ellipse(x, sketch.height - 50, 30, 30); // Head
                sketch.fill(0);
                sketch.ellipse(x + 5 * direction, sketch.height - 50, 5, 5); // Eye
                
                sketch.stroke(0);
                sketch.line(x, sketch.height - 35, x, sketch.height - 15); // Body
                sketch.line(x, sketch.height - 15, x + 10 * direction, sketch.height); // Leg
                sketch.line(x, sketch.height - 15, x - 10, sketch.height); // Other leg
                sketch.line(x, sketch.height - 30, x + 15 * direction, sketch.height - 20); // Arm
                
                // Add explanatory text
                sketch.noStroke();
                sketch.fill(0);
                sketch.textSize(14);
                sketch.textAlign(sketch.CENTER);
                sketch.text("Vertical Asymptote at x = -3", asymptoteX, 30);
                sketch.text("y = 1/(x+3)", sketch.width/2, 60);
                
                // Character speech bubble
                if (x > asymptoteX - 100 && direction > 0 || x < asymptoteX - 40 && direction < 0) {
                    sketch.fill(255);
                    sketch.stroke(0);
                    sketch.beginShape();
                    let bubbleX = x + 40 * direction;
                    let bubbleY = sketch.height - 70;
                    sketch.vertex(bubbleX, bubbleY);
                    sketch.vertex(bubbleX + 100 * direction, bubbleY);
                    sketch.vertex(bubbleX + 100 * direction, bubbleY - 40);
                    sketch.vertex(bubbleX, bubbleY - 40);
                    sketch.vertex(bubbleX, bubbleY);
                    sketch.endShape();
                    
                    sketch.fill(0);
                    sketch.noStroke();
                    sketch.textAlign(direction > 0 ? sketch.LEFT : sketch.RIGHT);
                    sketch.textSize(12);
                    sketch.text(direction > 0 ? "I can get closer and closer..." : "...but never touch the line!", 
                               bubbleX + 10 * direction, bubbleY - 20);
                }
            };
        });

        // P5.js sketch for limit demo
        new p5(sketch => {
            let steps = 1;
            
            sketch.setup = function() {
                const canvas = sketch.createCanvas(document.getElementById('limitCanvas').offsetWidth, 300);
                canvas.parent('limitCanvas');
            };
            
            sketch.draw = function() {
                sketch.background(240);
                
                // Draw ground
                sketch.fill(200);
                sketch.noStroke();
                sketch.rect(0, sketch.height - 50, sketch.width, 50);
                
                // Draw treasure chest
                let chestX = sketch.width - 100;
                sketch.fill(139, 69, 19);
                sketch.rect(chestX, sketch.height - 80, 60, 30);
                sketch.fill(255, 215, 0);
                sketch.rect(chestX + 10, sketch.height - 85, 40, 5);
                
                // Calculate robot position based on steps
                let startX = 100;
                let robotX = startX;
                let distance = chestX - startX;
                
                for (let i = 0; i < steps; i++) {
                    distance /= 2;
                    robotX += distance;
                }
                
                // Draw path
                sketch.stroke(100, 100, 255, 100);
                sketch.setLineDash([5, 5]);
                sketch.line(startX, sketch.height - 65, chestX, sketch.height - 65);
                sketch.setLineDash([]);
                
                // Draw markers for steps
                let d = chestX - startX;
                let x = startX;
                sketch.fill(0);
                sketch.textSize(12);
                sketch.textAlign(sketch.CENTER);
                
                for (let i = 0; i <= steps; i++) {
                    if (i > 0) {
                        d /= 2;
                        x += d;
                    }
                    
                    sketch.stroke(255, 0, 0);
                    sketch.line(x, sketch.height - 60, x, sketch.height - 70);
                    sketch.noStroke();
                    
                    if (i === 0) {
                        sketch.text("Start", x, sketch.height - 75);
                    } else {
                        sketch.text("Step " + i, x, sketch.height - 75);
                    }
                }
                
                // Draw robot
                sketch.fill(100, 100, 255);
                sketch.stroke(0);
                sketch.rect(robotX - 15, sketch.height - 100, 30, 50);
                
                // Robot head
                sketch.fill(200);
                sketch.rect(robotX - 10, sketch.height - 110, 20, 10);
                
                // Robot eyes
                sketch.fill(255, 0, 0);
                sketch.ellipse(robotX - 5, sketch.height - 105, 5, 5);
                sketch.ellipse(robotX + 5, sketch.height - 105, 5, 5);
                
                // Robot arms
                sketch.line(robotX - 15, sketch.height - 80, robotX - 25, sketch.height - 90);
                sketch.line(robotX + 15, sketch.height - 80, robotX + 25, sketch.height - 90);
                
                // Distance label
                sketch.noStroke();
                sketch.fill(0);
                sketch.textAlign(sketch.CENTER);
                sketch.text("Distance remaining: " + (chestX - robotX).toFixed(2) + " units", sketch.width/2, 30);
                
                // Draw the limit concept
                sketch.textSize(16);
                sketch.textAlign(sketch.CENTER);
                sketch.text("As the number of steps approaches infinity,", sketch.width/2, 60);
                sketch.text("the robot's position approaches the treasure chest!", sketch.width/2, 80);
                sketch.text("We write: lim (robot's position) = treasure chest", sketch.width/2, 110);
                sketch.text("n→∞", sketch.width/2 - 40, 125);
            };
            
            // Update function when slider changes
            window.updateLimitDemo = function() {
                steps = parseInt(document.getElementById('stepsSlider').value);
                document.getElementById('stepsValue').innerText = steps;
            };
        });
        
        // P5.js sketch for approaching from different sides demo
        new p5(sketch => {
            let xApproach = -0.9;
            
            sketch.setup = function() {
                const canvas = sketch.createCanvas(document.getElementById('approachCanvas').offsetWidth, 300);
                canvas.parent('approachCanvas');
            };
            
            sketch.draw = function() {
                sketch.background(240);
                
                // Draw coordinate system
                sketch.stroke(0);
                let xAxisY = sketch.height / 2;
                let yAxisX = sketch.width / 2;
                
                sketch.line(0, xAxisY, sketch.width, xAxisY); // x-axis
                sketch.line(yAxisX, 0, yAxisX, sketch.height); // y-axis
                
                // Draw tick marks
                for (let i = -5; i <= 5; i++) {
                    let xPos = sketch.map(i, -5, 5, 0, sketch.width);
                    sketch.line(xPos, xAxisY-5, xPos, xAxisY+5);
                    sketch.textAlign(sketch.CENTER);
                    sketch.textSize(12);
                    if (i !== 0) {
                        sketch.text(i, xPos, xAxisY+20);
                    }
                }
                
                for (let i = -5; i <= 5; i++) {
                    if (i === 0) continue;
                    let yPos = sketch.map(i, -5, 5, sketch.height, 0);
                    sketch.line(yAxisX-5, yPos, yAxisX+5, yPos);
                    sketch.textAlign(sketch.RIGHT);
                    sketch.text(i, yAxisX-10, yPos+4);
                }
                
                // Draw function f(x) = 1/x if x < 0, f(x) = 2 if x > 0
                sketch.stroke(255, 0, 0);
                sketch.noFill();
                
                // Left side of function
                sketch.beginShape();
                for (let i = 0; i < yAxisX; i++) {
                    let x = sketch.map(i, 0, yAxisX, -5, 0);
                    if (x === 0) continue;
                    let y = 1 / x;
                    let yScreen = sketch.map(y, -5, 5, sketch.height, 0);
                    if (yScreen > 0 && yScreen < sketch.height) {
                        sketch.vertex(i, yScreen);
                    }
                }
                sketch.endShape();
                
                // Right side of function
                sketch.beginShape();
                for (let i = yAxisX; i < sketch.width; i++) {
                    let x = sketch.map(i, yAxisX, sketch.width, 0, 5);
                    if (x === 0) continue;
                    let y = 2;
                    let yScreen = sketch.map(y, -5, 5, sketch.height, 0);
                    sketch.vertex(i, yScreen);
                }
                sketch.endShape();
                
                // Draw vertical asymptote
                sketch.stroke(0, 0, 255);
                sketch.setLineDash([5, 5]);
                sketch.line(yAxisX, 0, yAxisX, sketch.height);
                sketch.setLineDash([]);
                
                // Draw current x position
                let xPos = sketch.map(xApproach, -5, 5, 0, sketch.width);
                sketch.stroke(0, 200, 0);
                sketch.line(xPos, xAxisY, xPos, xApproach < 0 ? sketch.map(1/xApproach, -5, 5, sketch.height, 0) : sketch.map(2, -5, 5, sketch.height, 0));
                sketch.fill(0, 200, 0);
                sketch.ellipse(xPos, xApproach < 0 ? sketch.map(1/xApproach, -5, 5, sketch.height, 0) : sketch.map(2, -5, 5, sketch.height, 0), 8, 8);
                
                // Draw limit indicators
                sketch.fill(0);
                sketch.noStroke();
                sketch.textSize(14);
                sketch.textAlign(sketch.CENTER);
                
                if (xApproach < 0) {
                    sketch.text("As x → 0⁻, f(x) → -∞", sketch.width/2, 30);
                    let yVal = 1 / xApproach;
                    sketch.text("f(" + xApproach.toFixed(1) + ") = " + yVal.toFixed(2), sketch.width/2, 60);
                } else {
                    sketch.text("As x → 0⁺, f(x) → 2", sketch.width/2, 30);
                    sketch.text("f(" + xApproach.toFixed(1) + ") = 2", sketch.width/2, 60);
                }
                
                sketch.textSize(16);
                sketch.text("The limit depends on which side we approach from!", sketch.width/2, 270);
            };
            
            // Update function when slider changes
            window.updateApproachDemo = function() {
                xApproach = parseFloat(document.getElementById('approachSlider').value);
                document.getElementById('approachValue').innerText = xApproach.toFixed(1);
            };
        });
        
        // P5.js sketch for asymptote demo
        new p5(sketch => {
            let asymptoteType = 1; // 1: vertical, 2: horizontal, 3: slant
            
            sketch.setup = function() {
                const canvas = sketch.createCanvas(document.getElementById('asymptoteCanvas').offsetWidth, 300);
                canvas.parent('asymptoteCanvas');
            };
            
            sketch.draw = function() {
                sketch.background(240);
                
                // Draw coordinate system
                sketch.stroke(0);
                let xAxisY = sketch.height / 2;
                let yAxisX = sketch.width / 2;
                
                sketch.line(0, xAxisY, sketch.width, xAxisY); // x-axis
                sketch.line(yAxisX, 0, yAxisX, sketch.height); // y-axis
                
                // Draw tick marks
                for (let i = -5; i <= 5; i++) {
                    let xPos = sketch.map(i, -5, 5, 0, sketch.width);
                    sketch.line(xPos, xAxisY-5, xPos, xAxisY+5);
                    sketch.textAlign(sketch.CENTER);
                    sketch.textSize(12);
                    if (i !== 0) {
                        sketch.text(i, xPos, xAxisY+20);
                    }
                }
                
                for (let i = -5; i <= 5; i++) {
                    if (i === 0) continue;
                    let yPos = sketch.map(i, -5, 5, sketch.height, 0);
                    sketch.line(yAxisX-5, yPos, yAxisX+5, yPos);
                    sketch.textAlign(sketch.RIGHT);
                    sketch.text(i, yAxisX-10, yPos+4);
                }
                
                // Draw appropriate function and asymptote based on type
                if (asymptoteType === 1) {
                    // Vertical asymptote (1/(x-2))
                    let asymptoteX = 2;
                    let asymptoteXScreen = sketch.map(asymptoteX, -5, 5, 0, sketch.width);
                    
                    // Draw function
                    sketch.stroke(255, 0, 0);
                    sketch.noFill();
                    
                    sketch.beginShape();
                    for (let i = 0; i < asymptoteXScreen - 5; i++) {
                        let x = sketch.map(i, 0, sketch.width, -5, 5);
                        let y = 1 / (x - asymptoteX);
                        let yScreen = sketch.map(y, -5, 5, sketch.height, 0);
                        if (yScreen > 0 && yScreen < sketch.height) {
                            sketch.vertex(i, yScreen);
                        }
                    }
                    sketch.endShape();
                    
                    sketch.beginShape();
                    for (let i = asymptoteXScreen + 5; i < sketch.width; i++) {
                        let x = sketch.map(i, 0, sketch.width, -5, 5);
                        let y = 1 / (x - asymptoteX);
                        let yScreen = sketch.map(y, -5, 5, sketch.height, 0);
                        if (yScreen > 0 && yScreen < sketch.height) {
                            sketch.vertex(i, yScreen);
                        }
                    }
                    sketch.endShape();
                    
                    // Draw asymptote
                    sketch.stroke(0, 0, 255);
                    sketch.setLineDash([5, 5]);
                    sketch.line(asymptoteXScreen, 0, asymptoteXScreen, sketch.height);
                    sketch.setLineDash([]);
                    
                    // Add explanatory text
                    sketch.noStroke();
                    sketch.fill(0);
                    sketch.textSize(14);
                    sketch.textAlign(sketch.CENTER);
                    sketch.text("Vertical Asymptote at x = " + asymptoteX, sketch.width/2, 30);
                    sketch.text("f(x) = 1/(x-" + asymptoteX + ")", sketch.width/2, 60);
                    
                } else if (asymptoteType === 2) {
                    // Horizontal asymptote (3 + 1/x)
                    let asymptoteY = 3;
                    let asymptoteYScreen = sketch.map(asymptoteY, -5, 5, sketch.height, 0);
                    
                    // Draw function
                    sketch.stroke(255, 0, 0);
                    sketch.noFill();
                    
                    // Left side
                    sketch.beginShape();
                    for (let i = 0; i < yAxisX - 5; i++) {
                        let x = sketch.map(i, 0, sketch.width, -5, 5);
                        if (Math.abs(x) < 0.1) continue;
                        let y = asymptoteY + 1 / x;
                        let yScreen = sketch.map(y, -5, 5, sketch.height, 0);
                        if (yScreen > 0 && yScreen < sketch.height) {
                            sketch.vertex(i, yScreen);
                        }
                    }
                    sketch.endShape();
                    
                    // Right side
                    sketch.beginShape();
                    for (let i = yAxisX + 5; i < sketch.width; i++) {
                        let x = sketch.map(i, 0, sketch.width, -5, 5);
                        if (Math.abs(x) < 0.1) continue;
                        let y = asymptoteY + 1 / x;
                        let yScreen = sketch.map(y, -5, 5, sketch.height, 0);
                        if (yScreen > 0 && yScreen < sketch.height) {
                            sketch.vertex(i, yScreen);
                        }
                    }
                    sketch.endShape();
                    
                    // Draw asymptote
                    sketch.stroke(0, 0, 255);
                    sketch.setLineDash([5, 5]);
                    sketch.line(0, asymptoteYScreen, sketch.width, asymptoteYScreen);
                    sketch.setLineDash([]);
                    
                    // Add explanatory text
                    sketch.noStroke();
                    sketch.fill(0);
                    sketch.textSize(14);
                    sketch.textAlign(sketch.CENTER);
                    sketch.text("Horizontal Asymptote at y = " + asymptoteY, sketch.width/2, 30);
                    sketch.text("f(x) = " + asymptoteY + " + 1/x", sketch.width/2, 60);
                    
                } else if (asymptoteType === 3) {
                    // Slant asymptote ((x^2 + 1)/x)
                    
                    // Draw function
                    sketch.stroke(255, 0, 0);
                    sketch.noFill();
                    
                    // Left side
                    sketch.beginShape();
                    for (let i = 0; i < yAxisX - 5; i++) {
                        let x = sketch.map(i, 0, sketch.width, -5, 5);
                        if (Math.abs(x) < 0.1) continue;
                        let y = (x * x + 1) / x;
                        let yScreen = sketch.map(y, -5, 5, sketch.height, 0);
                        if (yScreen > 0 && yScreen < sketch.height) {
                            sketch.vertex(i, yScreen);
                        }
                    }
                    sketch.endShape();
                    
                    // Right side
                    sketch.beginShape();
                    for (let i = yAxisX + 5; i < sketch.width; i++) {
                        let x = sketch.map(i, 0, sketch.width, -5, 5);
                        if (Math.abs(x) < 0.1) continue;
                        let y = (x * x + 1) / x;
                        let yScreen = sketch.map(y, -5, 5, sketch.height, 0);
                        if (yScreen > 0 && yScreen < sketch.height) {
                            sketch.vertex(i, yScreen);
                        }
                    }
                    sketch.endShape();
                    
                    // Draw slant asymptote (y = x)
                    sketch.stroke(0, 0, 255);
                    sketch.setLineDash([5, 5]);
                    sketch.beginShape();
                    for (let i = 0; i < sketch.width; i++) {
                        let x = sketch.map(i, 0, sketch.width, -5, 5);
                        let y = x;
                        let yScreen = sketch.map(y, -5, 5, sketch.height, 0);
                        sketch.vertex(i, yScreen);
                    }
                    sketch.endShape();
                    sketch.setLineDash([]);
                    
                    // Add explanatory text
                    sketch.noStroke();
                    sketch.fill(0);
                    sketch.textSize(14);
                    sketch.textAlign(sketch.CENTER);
                    sketch.text("Slant Asymptote y = x", sketch.width/2, 30);
                    sketch.text("f(x) = (x² + 1)/x", sketch.width/2, 60);
                }
                
                sketch.textSize(16);
                sketch.text("As x gets larger, the function gets closer to the asymptote!", sketch.width/2, 270);
            };
            
            // Update function when slider changes
            window.updateAsymptoteDemo = function() {
                asymptoteType = parseInt(document.getElementById('asymptoteTypeSlider').value);
                let typeText = ["Vertical", "Horizontal", "Slant"][asymptoteType - 1];
                document.getElementById('asymptoteTypeValue').innerText = typeText;
            };
        });
        
        // P5.js sketch for playground
        let playgroundSketch = new p5(sketch => {
            let p5Inst = sketch; // Store p5 instance for external access
            p5Canvas = sketch; // Store globally
            
            sketch.setup = function() {
                const canvas = sketch.createCanvas(document.getElementById('playgroundCanvas').offsetWidth, 400);
                canvas.parent('playgroundCanvas');
            };
            
            sketch.draw = function() {
                sketch.background(240);
                
                let xMin = currentFunction.range.xMin;
                let xMax = currentFunction.range.xMax;
                let yMin = currentFunction.range.yMin;
                let yMax = currentFunction.range.yMax;
                
                // Draw grid if enabled
                if (currentFunction.showGrid) {
                    sketch.stroke(200);
                    sketch.strokeWeight(1);
                    
                    // Vertical grid lines
                    for (let x = Math.ceil(xMin); x <= Math.floor(xMax); x++) {
                        if (x === 0) continue;
                        let xScreen = sketch.map(x, xMin, xMax, 0, sketch.width);
                        sketch.line(xScreen, 0, xScreen, sketch.height);
                    }
                    
                    // Horizontal grid lines
                    for (let y = Math.ceil(yMin); y <= Math.floor(yMax); y++) {
                        if (y === 0) continue;
                        let yScreen = sketch.map(y, yMin, yMax, sketch.height, 0);
                        sketch.line(0, yScreen, sketch.width, yScreen);
                    }
                }
                
                // Draw coordinate axes
                sketch.stroke(0);
                sketch.strokeWeight(2);
                let xAxisY = sketch.map(0, yMin, yMax, sketch.height, 0);
                let yAxisX = sketch.map(0, xMin, xMax, 0, sketch.width);
                
                if (xAxisY >= 0 && xAxisY <= sketch.height) {
                    sketch.line(0, xAxisY, sketch.width, xAxisY);
                    
                    // Draw x-axis tick marks and labels
                    for (let x = Math.ceil(xMin); x <= Math.floor(xMax); x++) {
                        if (x === 0) continue;
                        let xScreen = sketch.map(x, xMin, xMax, 0, sketch.width);
                        sketch.line(xScreen, xAxisY - 5, xScreen, xAxisY + 5);
                        sketch.noStroke();
                        sketch.fill(0);
                        sketch.textAlign(sketch.CENTER);
                        sketch.textSize(12);
                        sketch.text(x, xScreen, xAxisY + 20);
                    }
                }
                
                if (yAxisX >= 0 && yAxisX <= sketch.width) {
                    sketch.stroke(0);
                    sketch.strokeWeight(2);
                    sketch.line(yAxisX, 0, yAxisX, sketch.height);
                    
                    // Draw y-axis tick marks and labels
                    for (let y = Math.ceil(yMin); y <= Math.floor(yMax); y++) {
                        if (y === 0) continue;
                        let yScreen = sketch.map(y, yMin, yMax, sketch.height, 0);
                        sketch.line(yAxisX - 5, yScreen, yAxisX + 5, yScreen);
                        sketch.noStroke();
                        sketch.fill(0);
                        sketch.textAlign(sketch.RIGHT);
                        sketch.textSize(12);
                        sketch.text(y, yAxisX - 10, yScreen + 4);
                    }
                }
                
                // Draw origin label
                if (xAxisY >= 0 && xAxisY <= sketch.height && yAxisX >= 0 && yAxisX <= sketch.width) {
                    sketch.noStroke();
                    sketch.fill(0);
                    sketch.textAlign(sketch.CENTER);
                    sketch.textSize(12);
                    sketch.text("0", yAxisX, xAxisY + 20);
                }
                
                try {
                    // Evaluate and draw function
                    let asymptotes = [];
                    
                    if (currentFunction.type === 'rational') {
                        // Find vertical asymptotes for rational functions
                        try {
                            // Use math.js to parse the denominator
                            const denomExpr = math.parse(currentFunction.params.denominator);
                            
                            // To find roots (potential asymptotes), solve denominator = 0
                            // This is a simple approach; for more complex functions, we'd need symbolic solving
                            for (let x = Math.ceil(xMin); x <= Math.floor(xMax); x++) {
                                try {
                                    const denomAtX = denomExpr.evaluate({x: x});
                                    const denomAtXPlus = denomExpr.evaluate({x: x + 0.001});
                                    
                                    // Check if denominator changes sign or is very close to zero
                                    if (Math.abs(denomAtX) < 0.01 || denomAtX * denomAtXPlus < 0) {
                                        asymptotes.push({type: 'vertical', value: x});
                                    }
                                } catch (e) {
                                    // Skip errors in evaluation
                                }
                            }
                        } catch (e) {
                            // If parsing fails, just skip finding asymptotes
                        }
                    }
                    
                    // Draw asymptotes if enabled
                    if (currentFunction.showAsymptotes) {
                        sketch.stroke(0, 0, 255);
                        sketch.strokeWeight(1);
                        sketch.setLineDash([5, 5]);
                        
                        // Draw detected vertical asymptotes
                        for (let asymptote of asymptotes) {
                            if (asymptote.type === 'vertical') {
                                let xScreen = sketch.map(asymptote.value, xMin, xMax, 0, sketch.width);
                                sketch.line(xScreen, 0, xScreen, sketch.height);
                            }
                        }
                        
                        // For rational functions, check for horizontal asymptotes
                        if (currentFunction.type === 'rational') {
                            try {
                                const numExpr = math.parse(currentFunction.params.numerator);
                                const denomExpr = math.parse(currentFunction.params.denominator);
                                
                                const numDegree = getPolynomialDegree(currentFunction.params.numerator);
                                const denomDegree = getPolynomialDegree(currentFunction.params.denominator);
                                
                                // If degree of numerator <= degree of denominator, might have horizontal asymptote
                                if (numDegree <= denomDegree) {
                                    // Evaluate at a very large x to approximate horizontal asymptote
                                    const largeX = 1000;
                                    const valueAtLargeX = evaluateFunction(largeX);
                                    
                                    if (!isNaN(valueAtLargeX) && isFinite(valueAtLargeX) &&
                                        valueAtLargeX >= yMin && valueAtLargeX <= yMax) {
                                        let yScreen = sketch.map(valueAtLargeX, yMin, yMax, sketch.height, 0);
                                        sketch.line(0, yScreen, sketch.width, yScreen);
                                    }
                                }
                            } catch (e) {
                                // Skip if analysis fails
                            }
                        }
                        
                        sketch.setLineDash([]);
                    }
                    
                    // Draw function
                    sketch.stroke(255, 0, 0);
                    sketch.strokeWeight(2);
                    sketch.noFill();
                    
                    // We'll draw the function as a series of connected points
                    let prevX = 0;
                    let prevY = 0;
                    let drawing = false;
                    
                    // For vertical asymptotes, we'll need to break the curve
                    let discontinuities = asymptotes.filter(a => a.type === 'vertical')
                                                    .map(a => a.value);
                    
                    const numPoints = 500; // Number of points to evaluate
                    
                    for (let i = 0; i <= numPoints; i++) {
                        let x = sketch.map(i, 0, numPoints, xMin, xMax);
                        
                        // Check if x is near a discontinuity
                        let nearDiscontinuity = discontinuities.some(d => Math.abs(x - d) < (xMax - xMin) / 100);
                        
                        if (nearDiscontinuity) {
                            // End the current line segment
                            if (drawing) {
                                sketch.endShape();
                                drawing = false;
                            }
                            continue;
                        }
                        
                        let y = evaluateFunction(x);
                        
                        // Check if y is valid
                        if (isNaN(y) || !isFinite(y)) {
                            if (drawing) {
                                sketch.endShape();
                                drawing = false;
                            }
                            continue;
                        }
                        
                        // Map to screen coordinates
                        let xScreen = sketch.map(x, xMin, xMax, 0, sketch.width);
                        let yScreen = sketch.map(y, yMin, yMax, sketch.height, 0);
                        
                        // Check if point is within visible area
                        if (yScreen < -100 || yScreen > sketch.height + 100) {
                            if (drawing) {
                                sketch.endShape();
                                drawing = false;
                            }
                            continue;
                        }
                        
                        // Start a new line segment if needed
                        if (!drawing) {
                            sketch.beginShape();
                            drawing = true;
                        }
                        
                        // If this is a valid point, add it to the shape
                        sketch.vertex(xScreen, yScreen);
                        
                        prevX = xScreen;
                        prevY = yScreen;
                    }
                    
                    if (drawing) {
                        sketch.endShape();
                    }
                    
                    // Update explanation
                    let explanation = "";
                    
                    if (currentFunction.type === 'rational') {
                        explanation = "This is a rational function f(x) = " + currentFunction.params.numerator + " / (" + currentFunction.params.denominator + ").";
                        
                        if (asymptotes.length > 0) {
                            explanation += " It has vertical asymptotes at x = " + asymptotes.map(a => a.value).join(", ") + ".";
                        }
                    } else if (currentFunction.type === 'trig') {
                        explanation = "This is a trigonometric function with amplitude " + currentFunction.params.amplitude + ".";
                    } else if (currentFunction.type === 'log') {
                        explanation = "This is a logarithmic function with a vertical asymptote at x = " + currentFunction.params.logShift + ".";
                    } else if (currentFunction.type === 'exp') {
                        explanation = "This is an exponential function approaching the x-axis as x gets smaller.";
                    } else if (currentFunction.type === 'custom') {
                        explanation = "This is your custom function: f(x) = " + currentFunction.params.customFormula;
                    }
                    
                    document.getElementById('mathExplanation').innerHTML = "<p>" + explanation + "</p>";
                } catch (err) {
                    console.log("Error in drawing function:", err);
                    document.getElementById('mathExplanation').innerHTML = "<p>Oops! There was an error. Try changing the function parameters.</p>";
                }
            };
            
            // Helper function to evaluate the current function at a given x value
            window.evaluateFunction = function(x) {
                try {
                    if (currentFunction.type === 'rational') {
                        // Use math.js to evaluate the rational function
                        const numExpr = math.parse(currentFunction.params.numerator);
                        const denomExpr = math.parse(currentFunction.params.denominator);
                        
                        const numVal = numExpr.evaluate({x: x});
                        const denomVal = denomExpr.evaluate({x: x});
                        
                        if (Math.abs(denomVal) < 1e-10) {
                            // Division by zero or very close to it
                            return NaN;
                        }
                        
                        return numVal / denomVal;
                    } else if (currentFunction.type === 'trig') {
                        const a = currentFunction.params.amplitude;
                        const b = currentFunction.params.frequency;
                        return a * Math.sin(b * x);
                    } else if (currentFunction.type === 'log') {
                        const base = currentFunction.params.logBase === 'e' ? Math.E : 
                                    parseFloat(currentFunction.params.logBase);
                        const shift = currentFunction.params.logShift;
                        
                        if (x - shift <= 0) {
                            return NaN; // Logarithm not defined for non-positive values
                        }
                        
                        return currentFunction.params.logBase === 'e' ? 
                               Math.log(x - shift) : Math.log(x - shift) / Math.log(base);
                    } else if (currentFunction.type === 'exp') {
                        const base = currentFunction.params.expBase === 'e' ? Math.E : 
                                    parseFloat(currentFunction.params.expBase);
                        const coeff = currentFunction.params.expCoeff;
                        
                        return coeff * (currentFunction.params.expBase === 'e' ? 
                                       Math.exp(x) : Math.pow(base, x));
                    } else if (currentFunction.type === 'custom') {
                        // Use math.js to evaluate the custom formula
                        return math.evaluate(currentFunction.params.customFormula, {x: x});
                    }
                    
                    return 0; // Default fallback
                } catch (e) {
                    console.log("Evaluation error:", e);
                    return NaN;
                }
            };
            
            // Helper function to estimate polynomial degree
            function getPolynomialDegree(polyStr) {
                try {
                    // Simple estimation by looking for the highest power of x
                    let highestDegree = 0;
                    
                    // Match patterns like x^2, x**2, x*x
                    const powMatches = polyStr.match(/x\^(\d+)|x\*\*(\d+)/g);
                    if (powMatches) {
                        for (let match of powMatches) {
                            const degree = parseInt(match.substring(2));
                            highestDegree = Math.max(highestDegree, degree);
                        }
                    }
                    
                    // Count consecutive multiplications of x
                    const multMatches = polyStr.match(/x(\*x)+/g);
                    if (multMatches) {
                        for (let match of multMatches) {
                            const degree = (match.match(/x/g) || []).length;
                            highestDegree = Math.max(highestDegree, degree);
                        }
                    }
                    
                    // Check for single x
                    if (polyStr.includes('x') && highestDegree === 0) {
                        highestDegree = 1;
                    }
                    
                    return highestDegree;
                } catch (e) {
                    return 0;
                }
            }
        });
        
        // Function to open a tab
        function openTab(evt, tabName) {
            // Hide all tab content
            let tabContents = document.getElementsByClassName("tab-content");
            for (let i = 0; i < tabContents.length; i++) {
                tabContents[i].classList.remove("active");
            }
            
            // Remove "active" class from all tab buttons
            let tabButtons = document.getElementsByClassName("tab-button");
            for (let i = 0; i < tabButtons.length; i++) {
                tabButtons[i].classList.remove("active");
            }
            
            // Show the selected tab content and add "active" class to the button
            document.getElementById(tabName).classList.add("active");
            if (evt && evt.currentTarget) {
                evt.currentTarget.classList.add("active");
            } else {
                // Find the button for this tab
                for (let i = 0; i < tabButtons.length; i++) {
                    if (tabButtons[i].getAttribute("onclick").includes(tabName)) {
                        tabButtons[i].classList.add("active");
                        break;
                    }
                }
            }
            
            // If opening the quiz tab, initialize the quiz
            if (tabName === 'quiz') {
                initQuiz();
            }
        }
        
        // Function to update function parameters
        window.updateFunction = function() {
            try {
                if (currentFunction.type === 'rational') {
                    currentFunction.params.numerator = document.getElementById('numerator').value;
                    currentFunction.params.denominator = document.getElementById('denominator').value;
                } else if (currentFunction.type === 'trig') {
                    currentFunction.params.amplitude = parseFloat(document.getElementById('amplitude').value);
                    currentFunction.params.frequency = parseFloat(document.getElementById('frequency').value);
                } else if (currentFunction.type === 'log') {
                    currentFunction.params.logBase = document.getElementById('logBase').value;
                    currentFunction.params.logShift = parseFloat(document.getElementById('logShift').value);
                } else if (currentFunction.type === 'exp') {
                    currentFunction.params.expBase = document.getElementById('expBase').value;
                    currentFunction.params.expCoeff = parseFloat(document.getElementById('expCoeff').value);
                } else if (currentFunction.type === 'custom') {
                    currentFunction.params.customFormula = document.getElementById('customFormula').value;
                }
                
                currentFunction.showAsymptotes = document.getElementById('showAsymptotes').checked;
                currentFunction.showLimits = document.getElementById('showLimits').checked;
                currentFunction.showGrid = document.getElementById('showGrid').checked;
            } catch (e) {
                console.log("Error updating function:", e);
            }
        };
        
        // Function to update function range
        window.updateFunctionRange = function() {
            try {
                currentFunction.range.xMin = parseFloat(document.getElementById('xMin').value);
                currentFunction.range.xMax = parseFloat(document.getElementById('xMax').value);
                currentFunction.range.yMin = parseFloat(document.getElementById('yMin').value);
                currentFunction.range.yMax = parseFloat(document.getElementById('yMax').value);
            } catch (e) {
                console.log("Error updating range:", e);
            }
        };
        
        // Function to update function type
        window.updateFunctionType = function() {
            currentFunction.type = document.getElementById('functionType').value;
            
            // Hide all parameter groups
            document.getElementById('rational-params').style.display = 'none';
            document.getElementById('trig-params').style.display = 'none';
            document.getElementById('log-params').style.display = 'none';
            document.getElementById('exp-params').style.display = 'none';
            document.getElementById('custom-params').style.display = 'none';
            
            // Show the relevant parameter group
            document.getElementById(currentFunction.type + '-params').style.display = 'block';
            
            updateFunction();
        };
        
        // Function to toggle advanced parameters
        window.toggleAdvancedParams = function() {
            const advancedParams = document.getElementById('advancedParams');
            const toggleButton = document.getElementById('advancedToggle');
            
            if (advancedParams.style.display === 'block') {
                advancedParams.style.display = 'none';
                toggleButton.innerText = 'Show Advanced Options';
            } else {
                advancedParams.style.display = 'block';
                toggleButton.innerText = 'Hide Advanced Options';
            }
        };
        
        // Quiz questions
        const quizQuestions = [
            {
                question: "What happens as x approaches a vertical asymptote?",
                options: [
                    "The function value approaches zero",
                    "The function value approaches infinity or negative infinity",
                    "The function becomes undefined",
                    "The function approaches a constant value"
                ],
                correctAnswer: 1,
                explanation: "As x gets closer and closer to a vertical asymptote, the function value grows without bound, approaching infinity or negative infinity."
            },
            {
                question: "What is a horizontal asymptote?",
                options: [
                    "A vertical line that the function never crosses",
                    "A horizontal line that the function gets closer to as x approaches infinity",
                    "A point where the function is undefined",
                    "The x-axis"
                ],
                correctAnswer: 1,
                explanation: "A horizontal asymptote is a horizontal line that the function approaches (gets closer and closer to) as x gets very large (approaches infinity) or very small (approaches negative infinity)."
            },
            {
                question: "What is the limit of 1/x as x approaches infinity?",
                options: [
                    "0",
                    "1",
                    "Infinity",
                    "The limit does not exist"
                ],
                correctAnswer: 0,
                explanation: "As x gets larger and larger, 1/x gets closer and closer to 0. For example, when x = 1000, 1/x = 0.001, and when x = 1,000,000, 1/x = 0.000001."
            },
            {
                question: "In the function f(x) = 1/(x-3), where is the vertical asymptote?",
                options: [
                    "x = 0",
                    "x = 1",
                    "x = 3",
                    "y = 0"
                ],
                correctAnswer: 2,
                explanation: "The vertical asymptote occurs where the denominator equals zero. In f(x) = 1/(x-3), the denominator is zero when x = 3."
            },
            {
                question: "What happens to the function f(x) = (2x² + 3x - 5)/(x² - 4) as x gets very large?",
                options: [
                    "It approaches 0",
                    "It approaches 1",
                    "It approaches 2",
                    "It approaches infinity"
                ],
                correctAnswer: 2,
                explanation: "For rational functions where the numerator and denominator have the same highest degree, the limit as x approaches infinity equals the ratio of the leading coefficients. In this case, the coefficient of x² in the numerator is 2, and in the denominator it's 1, so the limit is 2."
            }
        ];
        
        // Function to initialize the quiz
        function initQuiz() {
            currentQuestionIndex = 0;
            quizScore = 0;
            loadQuestion();
        }
        
        // Function to load a question
        function loadQuestion() {
            if (currentQuestionIndex < quizQuestions.length) {
                const questionData = quizQuestions[currentQuestionIndex];
                let quizHTML = `
                    <div class="quiz-question">
                        <strong>Question ${currentQuestionIndex + 1}/${quizQuestions.length}:</strong> ${questionData.question}
                    </div>
                    <div class="quiz-options">
                `;
                
                questionData.options.forEach((option, index) => {
                    quizHTML += `
                        <div class="quiz-option" onclick="checkAnswer(${index})">
                            ${String.fromCharCode(65 + index)}. ${option}
                        </div>
                    `;
                });
                
                quizHTML += `
                    </div>
                    <div id="feedback" class="feedback"></div>
                `;
                
                document.getElementById('quizContainer').innerHTML = quizHTML;
                
                // Update progress bar
                const progressPercent = (currentQuestionIndex / quizQuestions.length) * 100;
                document.getElementById('quizProgress').style.width = progressPercent + '%';
            } else {
                // Quiz completed
                let finalScore = (quizScore / quizQuestions.length) * 100;
                let resultHTML = `
                    <h3>Quiz Complete!</h3>
                    <p>You scored ${quizScore} out of ${quizQuestions.length} (${finalScore}%)</p>
                `;
                
                if (finalScore >= 80) {
                    resultHTML += `
                        <div class="character-container">
                            <div class="character-avatar">π</div>
                            <div class="character-dialogue">
                                <p>Amazing job! You're a math superstar! 🌟</p>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="showCongratulations()">Claim Your Badge</button>
                    `;
                } else {
                    resultHTML += `
                        <div class="character-container">
                            <div class="character-avatar">π</div>
                            <div class="character-dialogue">
                                <p>Good effort! Let's review what we've learned and try again!</p>
                            </div>
                        </div>
                        <button class="btn" onclick="initQuiz()">Try Again</button>
                    `;
                }
                
                document.getElementById('quizContainer').innerHTML = resultHTML;
                
                // Update progress bar to 100%
                document.getElementById('quizProgress').style.width = '100%';
            }
        }
        
        // Function to check the answer
        window.checkAnswer = function(selectedIndex) {
            const questionData = quizQuestions[currentQuestionIndex];
            const feedbackElement = document.getElementById('feedback');
            
            if (selectedIndex === questionData.correctAnswer) {
                feedbackElement.innerHTML = `<p>Correct! ${questionData.explanation}</p>`;
                feedbackElement.className = 'feedback correct';
                quizScore++;
            } else {
                feedbackElement.innerHTML = `<p>Not quite. ${questionData.explanation}</p>`;
                feedbackElement.className = 'feedback incorrect';
            }
            
            feedbackElement.style.display = 'block';
            
            // Disable clicking on options
            const options = document.getElementsByClassName('quiz-option');
            for (let i = 0; i < options.length; i++) {
                options[i].style.pointerEvents = 'none';
                
                // Highlight correct answer
                if (i === questionData.correctAnswer) {
                    options[i].style.backgroundColor = '#d4edda';
                    options[i].style.borderColor = '#c3e6cb';
                }
                
                // Highlight selected wrong answer
                if (i === selectedIndex && selectedIndex !== questionData.correctAnswer) {
                    options[i].style.backgroundColor = '#f8d7da';
                    options[i].style.borderColor = '#f5c6cb';
                }
            }
            
            // Add next button
            feedbackElement.innerHTML += `
                <button class="btn btn-primary" onclick="nextQuestion()" style="margin-top: 10px;">Next Question</button>
            `;
        };
        
        // Function to move to the next question
        window.nextQuestion = function() {
            currentQuestionIndex++;
            loadQuestion();
        };
        
        // Function to show congratulations
        window.showCongratulations = function() {
            // Create confetti effect
            createConfetti();
            
            // Show congratulations popup
            document.getElementById('congratsPopup').style.display = 'block';
        };
        
        // Function to close popup
        window.closePopup = function(popupId) {
            document.getElementById(popupId).style.display = 'none';
        };
        
        // Function to create confetti effect
        function createConfetti() {
            const confettiContainer = document.getElementById('celebrationContainer');
            confettiContainer.innerHTML = '';
            
            const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff'];
            
            for (let i = 0; i < 100; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.width = Math.random() * 10 + 5 + 'px';
                confetti.style.height = Math.random() * 10 + 5 + 'px';
                confetti.style.opacity = Math.random() + 0.5;
                confetti.style.animation = 'fall ' + (Math.random() * 3 + 2) + 's linear forwards';
                confetti.style.animationDelay = Math.random() * 2 + 's';
                
                confettiContainer.appendChild(confetti);
            }
            
            // Remove confetti after animation
            setTimeout(() => {
                confettiContainer.innerHTML = '';
            }, 5000);
        }
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize function type
            updateFunctionType();
            
            // Make playground responsive to window resizing
            window.addEventListener('resize', function() {
                if (playgroundSketch) {
                    playgroundSketch.resizeCanvas(document.getElementById('playgroundCanvas').offsetWidth, 400);
                }
            });
        });
    </script>
</body>
</html>