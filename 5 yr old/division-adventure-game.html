<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Division Adventure: Journey to Number Kingdom</title>
    <style>
        :root {
            --primary-color: #4e54c8;
            --secondary-color: #8f94fb;
            --tertiary-color: #ffd166;
            --success-color: #06d6a0;
            --warning-color: #ef476f;
            --neutral-color: #f1faee;
            --text-color: #1b1b3a;
            --light-text: #f1faee;
            --character-color: #8338ec;
            --border-radius: 12px;
            --shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            transition: var(--transition);
        }

        body {
            font-family: 'Comic Sans MS', 'Chalkboard SE', 'Comic Neue', sans-serif;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: var(--text-color);
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }

        /* Main Container Styles */
        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: var(--neutral-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            position: relative;
        }

        /* Header Styles */
        .header {
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: var(--light-text);
            padding: 15px 20px;
            text-align: center;
            position: relative;
        }

        .title {
            font-size: 2.5em;
            margin-bottom: 5px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
        }

        /* Main Content Area */
        .main-content {
            display: flex;
            min-height: 500px;
        }

        /* Character Column */
        .character-column {
            width: 30%;
            background-color: rgba(131, 56, 236, 0.1);
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            border-right: 2px dashed var(--primary-color);
        }

        .character-container {
            width: 100%;
            height: 250px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        /* Character SVG Styling */
        .character-svg {
            width: 150px;
            height: 150px;
        }

        .speech-bubble {
            position: relative;
            background: white;
            border-radius: 20px;
            padding: 15px;
            margin-top: 10px;
            max-width: 90%;
            box-shadow: var(--shadow);
            font-size: 1em;
            line-height: 1.4;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .speech-bubble::after {
            content: '';
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 0 15px 15px 15px;
            border-style: solid;
            border-color: white transparent;
        }

        /* Game Column */
        .game-column {
            width: 70%;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        /* Mode Selection Area */
        .mode-selection {
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .mode-button {
            background-color: var(--neutral-color);
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
            border-radius: var(--border-radius);
            padding: 10px 15px;
            font-size: 1em;
            cursor: pointer;
            font-family: inherit;
            font-weight: bold;
            min-width: 120px;
            text-align: center;
        }

        .mode-button.active {
            background-color: var(--primary-color);
            color: var(--light-text);
        }

        .mode-button:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow);
        }

        /* Game Area Styles */
        .game-area {
            flex-grow: 1;
            background-color: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        /* Visualization Styles */
        .visualization-container {
            width: 100%;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .division-objects {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 5px;
            margin-bottom: 15px;
        }

        .division-object {
            width: 40px;
            height: 40px;
            background-color: var(--tertiary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 2px solid var(--primary-color);
        }

        .division-groups {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        .division-group {
            border: 2px dashed var(--primary-color);
            border-radius: 10px;
            padding: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            min-width: 60px;
            min-height: 60px;
            background-color: rgba(78, 84, 200, 0.1);
        }

        /* Problem Display Styles */
        .problem-display {
            font-size: 2em;
            margin: 20px 0;
            background-color: rgba(255, 209, 102, 0.2);
            padding: 15px 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            font-family: monospace;
            position: relative;
        }

        /* Input Styles */
        .input-container {
            margin: 20px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }

        .answer-input {
            font-size: 1.5em;
            padding: 10px 15px;
            border: 3px solid var(--primary-color);
            border-radius: var(--border-radius);
            font-family: inherit;
            text-align: center;
            width: 150px;
            margin-bottom: 15px;
        }

        .answer-input:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(78, 84, 200, 0.3);
        }

        .submit-button {
            background-color: var(--tertiary-color);
            color: var(--text-color);
            border: none;
            border-radius: var(--border-radius);
            padding: 10px 20px;
            font-size: 1.2em;
            cursor: pointer;
            font-family: inherit;
            font-weight: bold;
            box-shadow: var(--shadow);
        }

        .submit-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        /* Feedback Message */
        .feedback-message {
            font-size: 1.2em;
            margin: 15px 0;
            padding: 10px;
            border-radius: var(--border-radius);
            text-align: center;
            min-height: 44px;
            font-weight: bold;
        }

        .feedback-correct {
            background-color: rgba(6, 214, 160, 0.2);
            color: #06814a;
        }

        .feedback-incorrect {
            background-color: rgba(239, 71, 111, 0.2);
            color: #c5365b;
        }

        /* Progress Indicators */
        .progress-indicators {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-top: 10px;
        }

        .score-display, .level-display {
            font-size: 1.2em;
            background-color: var(--primary-color);
            color: var(--light-text);
            padding: 8px 15px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        /* Long Division Tool Styles */
        .long-division-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            margin-top: 20px;
            font-family: monospace;
        }

        .division-problem {
            font-size: 1.8em;
            position: relative;
            padding-left: 60px;
            margin: 20px auto;
            width: fit-content;
        }

        .divisor {
            position: absolute;
            left: 10px;
            top: 10px;
        }

        .vertical-line {
            position: absolute;
            left: 45px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--primary-color);
        }

        .horizontal-line {
            position: absolute;
            left: 47px;
            right: 0;
            height: 2px;
            background: var(--primary-color);
        }

        .dividend {
            margin-top: 10px;
            padding-top: 10px;
        }

        .quotient-input {
            position: absolute;
            top: -30px;
            left: 47px;
            font-family: monospace;
            font-size: 1.8em;
            border: none;
            border-bottom: 2px dashed var(--primary-color);
            background: transparent;
            outline: none;
            width: calc(100% - 47px);
            padding: 0 0 0 8px;
        }

        .steps-display {
            font-family: monospace;
            font-size: 1.8em;
            margin-top: 10px;
            white-space: pre;
            color: var(--primary-color);
        }

        /* Quiz Mode Styles */
        .quiz-container {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .quiz-question {
            font-size: 1.3em;
            margin-bottom: 15px;
            text-align: center;
        }

        .quiz-options {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .quiz-option {
            background-color: var(--neutral-color);
            border: 2px solid var(--primary-color);
            border-radius: var(--border-radius);
            padding: 10px 15px;
            font-size: 1.1em;
            cursor: pointer;
            min-width: 80px;
            text-align: center;
        }

        .quiz-option:hover {
            background-color: rgba(78, 84, 200, 0.1);
        }

        .quiz-option.selected {
            background-color: var(--primary-color);
            color: var(--light-text);
        }

        .quiz-submit {
            background-color: var(--tertiary-color);
            color: var(--text-color);
            border: none;
            border-radius: var(--border-radius);
            padding: 10px 20px;
            font-size: 1.2em;
            cursor: pointer;
            font-family: inherit;
            font-weight: bold;
            box-shadow: var(--shadow);
            margin-top: 10px;
        }

        .quiz-submit:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        /* Settings Panel */
        .settings-panel {
            position: absolute;
            top: 0;
            right: -350px;
            width: 350px;
            height: 100%;
            background-color: white;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
            padding: 20px;
            z-index: 10;
            overflow-y: auto;
        }

        .settings-panel.open {
            right: 0;
        }

        .settings-toggle {
            position: absolute;
            top: 15px;
            right: 15px;
            background-color: var(--tertiary-color);
            color: var(--text-color);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.5em;
            z-index: 11;
            box-shadow: var(--shadow);
        }

        .settings-header {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
        }

        .settings-group {
            margin-bottom: 20px;
        }

        .settings-group-title {
            font-size: 1.2em;
            margin-bottom: 10px;
            color: var(--text-color);
        }

        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .settings-label {
            font-size: 1em;
        }

        .settings-input {
            width: 150px;
            padding: 5px 10px;
            border: 2px solid var(--primary-color);
            border-radius: var(--border-radius);
            font-family: inherit;
            text-align: center;
        }

        .settings-range {
            width: 150px;
        }

        .settings-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .settings-select {
            width: 150px;
            padding: 5px 10px;
            border: 2px solid var(--primary-color);
            border-radius: var(--border-radius);
            font-family: inherit;
        }

        .settings-button {
            background-color: var(--primary-color);
            color: var(--light-text);
            border: none;
            border-radius: var(--border-radius);
            padding: 8px 15px;
            font-size: 1em;
            cursor: pointer;
            font-family: inherit;
            width: 100%;
            margin-top: 10px;
        }

        .settings-button:hover {
            background-color: var(--secondary-color);
        }

        /* Animations */
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(-5px) rotate(1deg); }
            50% { transform: translateY(0) rotate(0deg); }
            75% { transform: translateY(5px) rotate(-1deg); }
        }

        .animate-bounce {
            animation: bounce 2s infinite;
        }

        .animate-spin {
            animation: rotate 3s linear infinite;
        }

        .animate-float {
            animation: float 4s ease-in-out infinite;
        }

        /* Responsive Design */
        @media (max-width: 900px) {
            .main-content {
                flex-direction: column;
            }

            .character-column, .game-column {
                width: 100%;
            }

            .character-column {
                border-right: none;
                border-bottom: 2px dashed var(--primary-color);
                min-height: 300px;
            }

            .settings-panel {
                width: 100%;
                right: -100%;
            }
        }

        @media (max-width: 600px) {
            .problem-display {
                font-size: 1.5em;
                padding: 10px 20px;
            }

            .division-problem {
                font-size: 1.5em;
            }

            .steps-display {
                font-size: 1.5em;
            }

            .title {
                font-size: 2em;
            }
        }

        /* Confetti Styles */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background-color: var(--tertiary-color);
            animation: fall 5s linear forwards;
            z-index: 1000;
        }

        @keyframes fall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
        }

        /* Advanced Visualization Styles */
        .division-tree {
            width: 100%;
            height: 200px;
            margin: 20px 0;
            position: relative;
        }

        .tree-node {
            position: absolute;
            background-color: var(--tertiary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 2px solid var(--primary-color);
            transition: all 0.5s ease;
        }

        .tree-connection {
            position: absolute;
            background-color: var(--primary-color);
            transform-origin: left center;
        }

        /* Help Button */
        .help-button {
            position: absolute;
            bottom: 15px;
            right: 15px;
            background-color: var(--primary-color);
            color: var(--light-text);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.5em;
            z-index: 11;
            box-shadow: var(--shadow);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 20px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow);
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: var(--text-color);
        }

        .modal-title {
            font-size: 1.5em;
            margin-bottom: 15px;
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
        }

        /* Progress Bar */
        .progress-bar-container {
            width: 100%;
            height: 15px;
            background-color: #e0e0e0;
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        /* Achievement Badge Styles */
        .achievements-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }

        .achievement-badge {
            width: 60px;
            height: 60px;
            background-color: #e0e0e0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            color: #999;
            position: relative;
            overflow: hidden;
        }

        .achievement-badge.unlocked {
            background-color: var(--tertiary-color);
            color: var(--text-color);
            box-shadow: var(--shadow);
        }

        .achievement-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--primary-color);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.7em;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .achievement-badge:hover .achievement-tooltip {
            opacity: 1;
            visibility: visible;
            bottom: calc(100% + 5px);
        }

        /* Results Screen */
        .results-screen {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: white;
            border-radius: var(--border-radius);
            padding: 20px;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 5;
        }

        .results-title {
            font-size: 2em;
            margin-bottom: 20px;
            color: var(--primary-color);
        }

        .results-score {
            font-size: 1.5em;
            margin-bottom: 15px;
        }

        .results-message {
            font-size: 1.2em;
            margin-bottom: 20px;
            text-align: center;
        }

        .results-button {
            background-color: var(--tertiary-color);
            color: var(--text-color);
            border: none;
            border-radius: var(--border-radius);
            padding: 10px 20px;
            font-size: 1.2em;
            cursor: pointer;
            font-family: inherit;
            font-weight: bold;
            box-shadow: var(--shadow);
            margin-top: 20px;
        }

        .results-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        /* Chart Styles */
        .chart-container {
            width: 100%;
            height: 200px;
            margin-top: 20px;
        }

        /* Tooltip Styles */
        .tooltip {
            position: relative;
            display: inline-block;
            margin-left: 5px;
            cursor: pointer;
        }

        .tooltip .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: var(--text-color);
            color: white;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.9em;
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header Section -->
        <header class="header">
            <h1 class="title">Division Adventure</h1>
            <h2 class="subtitle">Journey to Number Kingdom</h2>
            <button class="settings-toggle" id="settingsToggle">⚙️</button>
        </header>

        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Character Column -->
            <div class="character-column">
                <div class="character-container" id="characterContainer">
                    <!-- Character SVG will be inserted here by JavaScript -->
                </div>
                <div class="speech-bubble" id="speechBubble">
                    Welcome to the Division Adventure! I'm Professor Digit, and I'll help you learn all about division!
                </div>
                <div class="achievements-container" id="achievementsContainer">
                    <!-- Achievement badges will be inserted here by JavaScript -->
                </div>
            </div>

            <!-- Game Column -->
            <div class="game-column">
                <!-- Mode Selection Area -->
                <div class="mode-selection">
                    <button class="mode-button active" data-mode="learn">Learn</button>
                    <button class="mode-button" data-mode="practice">Practice</button>
                    <button class="mode-button" data-mode="longdivision">Long Division</button>
                    <button class="mode-button" data-mode="quiz">Quiz</button>
                    <button class="mode-button" data-mode="challenge">Challenge</button>
                </div>

                <!-- Progress Indicators -->
                <div class="progress-indicators">
                    <div class="level-display">Level: <span id="levelDisplay">1</span></div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                    </div>
                    <div class="score-display">Score: <span id="scoreDisplay">0</span></div>
                </div>

                <!-- Game Area -->
                <div class="game-area" id="gameArea">
                    <!-- Game content will be inserted here by JavaScript based on mode -->
                </div>
            </div>
        </div>

        <!-- Settings Panel -->
        <div class="settings-panel" id="settingsPanel">
            <h3 class="settings-header">Game Settings</h3>

            <!-- Difficulty Settings -->
            <div class="settings-group">
                <h4 class="settings-group-title">Difficulty Settings</h4>
                <div class="settings-row">
                    <label class="settings-label">Minimum Dividend:</label>
                    <input type="number" class="settings-input" id="minDividendSetting" min="1" max="100" value="1">
                </div>
                <div class="settings-row">
                    <label class="settings-label">Maximum Dividend:</label>
                    <input type="number" class="settings-input" id="maxDividendSetting" min="10" max="1000" value="50">
                </div>
                <div class="settings-row">
                    <label class="settings-label">Minimum Divisor:</label>
                    <input type="number" class="settings-input" id="minDivisorSetting" min="1" max="10" value="1">
                </div>
                <div class="settings-row">
                    <label class="settings-label">Maximum Divisor:</label>
                    <input type="number" class="settings-input" id="maxDivisorSetting" min="2" max="20" value="10">
                </div>
                <div class="settings-row">
                    <label class="settings-label">Allow Remainders:</label>
                    <input type="checkbox" class="settings-checkbox" id="allowRemaindersSetting">
                </div>
                <div class="settings-row">
                    <label class="settings-label">Time Limit (seconds):</label>
                    <input type="number" class="settings-input" id="timeLimitSetting" min="0" max="300" value="0">
                </div>
            </div>

            <!-- Visual Settings -->
            <div class="settings-group">
                <h4 class="settings-group-title">Visual Settings</h4>
                <div class="settings-row">
                    <label class="settings-label">Character:</label>
                    <select class="settings-select" id="characterSetting">
                        <option value="professor">Professor Digit</option>
                        <option value="robot">Math Bot</option>
                        <option value="wizard">Number Wizard</option>
                    </select>
                </div>
                <div class="settings-row">
                    <label class="settings-label">Theme Color:</label>
                    <select class="settings-select" id="themeSetting">
                        <option value="default">Default (Blue)</option>
                        <option value="green">Green</option>
                        <option value="purple">Purple</option>
                        <option value="orange">Orange</option>
                    </select>
                </div>
                <div class="settings-row">
                    <label class="settings-label">Animation Speed:</label>
                    <input type="range" class="settings-range" id="animationSpeedSetting" min="0.5" max="2" step="0.1" value="1">
                </div>
                <div class="settings-row">
                    <label class="settings-label">Show Hints:</label>
                    <input type="checkbox" class="settings-checkbox" id="showHintsSetting" checked>
                </div>
            </div>

            <!-- Learning Settings -->
            <div class="settings-group">
                <h4 class="settings-group-title">Learning Settings</h4>
                <div class="settings-row">
                    <label class="settings-label">Visualization Type:</label>
                    <select class="settings-select" id="visualizationSetting">
                        <option value="objects">Objects</option>
                        <option value="groups">Groups</option>
                        <option value="number-line">Number Line</option>
                        <option value="tree">Division Tree</option>
                    </select>
                </div>
                <div class="settings-row">
                    <label class="settings-label">Explanation Level:</label>
                    <select class="settings-select" id="explanationLevelSetting">
                        <option value="basic">Basic</option>
                        <option value="detailed">Detailed</option>
                        <option value="advanced">Advanced</option>
                    </select>
                </div>
                <div class="settings-row">
                    <label class="settings-label">Auto-Progress:</label>
                    <input type="checkbox" class="settings-checkbox" id="autoProgressSetting" checked>
                </div>
            </div>

            <!-- Apply Button -->
            <button class="settings-button" id="applySettingsButton">Apply Settings</button>
            <button class="settings-button" id="resetSettingsButton">Reset to Default</button>
        </div>

        <!-- Help Modal -->
        <div class="modal" id="helpModal">
            <div class="modal-content">
                <button class="modal-close" id="closeHelpModal">&times;</button>
                <h3 class="modal-title">How to Play Division Adventure</h3>
                <div id="helpContent">
                    <p><strong>What is Division?</strong></p>
                    <p>Division is sharing or grouping numbers into equal parts. It's the opposite of multiplication!</p>
                    
                    <p><strong>Game Modes:</strong></p>
                    <ul>
                        <li><strong>Learn Mode:</strong> Watch and interact with visual demonstrations of division concepts.</li>
                        <li><strong>Practice Mode:</strong> Solve division problems step by step with helpful visuals.</li>
                        <li><strong>Long Division Mode:</strong> Learn and practice the long division method for larger numbers.</li>
                        <li><strong>Quiz Mode:</strong> Test your division knowledge with multiple-choice questions.</li>
                        <li><strong>Challenge Mode:</strong> Race against the clock to solve division problems quickly.</li>
                    </ul>
                    
                    <p><strong>Controls:</strong></p>
                    <ul>
                        <li>Type your answers in the input boxes</li>
                        <li>Click or tap the "Check" button to submit your answer</li>
                        <li>Use the settings gear icon ⚙️ to customize the game</li>
                    </ul>
                    
                    <p><strong>Tips for Success:</strong></p>
                    <ul>
                        <li>Think of division as making equal groups</li>
                        <li>Use the visualization tools to see division in action</li>
                        <li>Practice multiplication facts to improve division skills</li>
                        <li>Take your time and don't rush through problems</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Results Modal -->
        <div class="results-screen" id="resultsScreen">
            <h2 class="results-title">Great Job!</h2>
            <div class="results-score">Your Score: <span id="finalScore">0</span></div>
            <div class="results-message" id="resultsMessage"></div>
            <div class="chart-container" id="resultsChart"></div>
            <button class="results-button" id="nextLevelButton">Next Level</button>
            <button class="results-button" id="retryButton">Try Again</button>
        </div>
    </div>

    <script>
        // Main Game Class
        class DivisionAdventure {
            constructor() {
                // Game state
                this.score = 0;
                this.level = 1;
                this.progress = 0;
                this.currentMode = 'learn';
                this.currentQuestion = null;
                this.questionsAnswered = 0;
                this.correctAnswers = 0;
                this.problemHistory = [];
                this.achievements = {
                    firstCorrect: false,
                    fiveInARow: false,
                    levelComplete: false,
                    speedyAnswer: false,
                    perfectScore: false,
                    divisorMaster: false,
                    remainderPro: false,
                    quizAce: false
                };
                
                // Settings (default values)
                this.settings = {
                    minDividend: 1,
                    maxDividend: 50,
                    minDivisor: 1,
                    maxDivisor: 10,
                    allowRemainders: false,
                    timeLimit: 0,
                    character: 'professor',
                    theme: 'default',
                    animationSpeed: 1,
                    showHints: true,
                    visualizationType: 'objects',
                    explanationLevel: 'basic',
                    autoProgress: true
                };
                
                // DOM Elements
                this.elements = {
                    gameArea: document.getElementById('gameArea'),
                    scoreDisplay: document.getElementById('scoreDisplay'),
                    levelDisplay: document.getElementById('levelDisplay'),
                    progressBar: document.getElementById('progressBar'),
                    characterContainer: document.getElementById('characterContainer'),
                    speechBubble: document.getElementById('speechBubble'),
                    settingsPanel: document.getElementById('settingsPanel'),
                    settingsToggle: document.getElementById('settingsToggle'),
                    modeButtons: document.querySelectorAll('.mode-button'),
                    helpModal: document.getElementById('helpModal'),
                    resultsScreen: document.getElementById('resultsScreen'),
                    achievementsContainer: document.getElementById('achievementsContainer')
                };
                
                // Initialize the game
                this.initializeCharacter();
                this.initializeAchievements();
                this.setupEventListeners();
                this.loadSettings();
                this.startMode('learn');
            }
            
            // Initialize character SVG based on settings
            initializeCharacter() {
                const characters = {
                    professor: `
                        <svg class="character-svg animate-float" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                            <!-- Head -->
                            <circle cx="100" cy="70" r="50" fill="#FFD8B6" />
                            <!-- Hair -->
                            <path d="M60 40 Q100 10 140 40 L140 60 Q100 90 60 60 Z" fill="#808080" />
                            <!-- Glasses -->
                            <circle cx="80" cy="65" r="15" fill="none" stroke="#333" stroke-width="3" />
                            <circle cx="120" cy="65" r="15" fill="none" stroke="#333" stroke-width="3" />
                            <line x1="95" y1="65" x2="105" y2="65" stroke="#333" stroke-width="3" />
                            <line x1="65" y1="65" x2="55" y2="60" stroke="#333" stroke-width="3" />
                            <line x1="135" y1="65" x2="145" y2="60" stroke="#333" stroke-width="3" />
                            <!-- Eyes -->
                            <circle cx="80" cy="65" r="5" fill="#333" />
                            <circle cx="120" cy="65" r="5" fill="#333" />
                            <!-- Smile -->
                            <path d="M75 85 Q100 100 125 85" fill="none" stroke="#333" stroke-width="3" stroke-linecap="round" />
                            <!-- Body -->
                            <rect x="75" y="120" width="50" height="60" fill="#8f94fb" rx="5" />
                            <rect x="65" y="120" width="10" height="50" fill="#FFD8B6" rx="5" />
                            <rect x="125" y="120" width="10" height="50" fill="#FFD8B6" rx="5" />
                            <!-- Bowtie -->
                            <path d="M90 125 L110 125 L100 135 Z" fill="#ff6b6b" />
                            <path d="M90 125 L110 125 L100 115 Z" fill="#ff6b6b" />
                        </svg>
                    `,
                    robot: `
                        <svg class="character-svg animate-float" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                            <!-- Head -->
                            <rect x="60" y="30" width="80" height="70" fill="#CCC" rx="10" />
                            <!-- Antenna -->
                            <line x1="100" y1="30" x2="100" y2="15" stroke="#333" stroke-width="3" />
                            <circle cx="100" cy="10" r="5" fill="#ff6b6b" />
                            <!-- Eyes -->
                            <circle cx="80" cy="55" r="10" fill="#4e54c8" />
                            <circle cx="120" cy="55" r="10" fill="#4e54c8" />
                            <circle cx="80" cy="55" r="5" fill="white" />
                            <circle cx="120" cy="55" r="5" fill="white" />
                            <!-- Mouth -->
                            <rect x="75" y="80" width="50" height="5" fill="#333" rx="2" />
                            <!-- Body -->
                            <rect x="70" y="100" width="60" height="70" fill="#8338ec" rx="5" />
                            <!-- Arms -->
                            <rect x="45" y="110" width="25" height="10" fill="#CCC" rx="5" />
                            <rect x="130" y="110" width="25" height="10" fill="#CCC" rx="5" />
                            <!-- Control panel -->
                            <rect x="85" y="115" width="30" height="20" fill="#EEE" rx="2" />
                            <circle cx="95" cy="125" r="3" fill="#ff6b6b" />
                            <circle cx="105" cy="125" r="3" fill="#06d6a0" />
                        </svg>
                    `,
                    wizard: `
                        <svg class="character-svg animate-float" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                            <!-- Hat -->
                            <path d="M50 70 L100 20 L150 70 Z" fill="#4e54c8" />
                            <path d="M60 70 L140 70 Q130 60 100 60 Q70 60 60 70 Z" fill="#4e54c8" />
                            <!-- Face -->
                            <circle cx="100" cy="90" r="30" fill="#FFD8B6" />
                            <!-- Beard -->
                            <path d="M70 90 Q100 150 130 90" fill="white" />
                            <!-- Eyes -->
                            <circle cx="85" cy="85" r="5" fill="#333" />
                            <circle cx="115" cy="85" r="5" fill="#333" />
                            <!-- Smile -->
                            <path d="M90 95 Q100 105 110 95" fill="none" stroke="#333" stroke-width="2" />
                            <!-- Body/Robe -->
                            <path d="M70 120 Q100 110 130 120 L130 180 L70 180 Z" fill="#8338ec" />
                            <!-- Stars on robe -->
                            <polygon points="85,140 87,145 93,145 88,150 90,155 85,152 80,155 82,150 77,145 83,145" fill="#ffd166" />
                            <polygon points="110,150 112,155 118,155 113,160 115,165 110,162 105,165 107,160 102,155 108,155" fill="#ffd166" />
                            <polygon points="95,165 97,170 103,170 98,175 100,180 95,177 90,180 92,175 87,170 93,170" fill="#ffd166" />
                        </svg>
                    `
                };
                
                this.elements.characterContainer.innerHTML = characters[this.settings.character];
            }
            
            // Initialize achievement badges
            initializeAchievements() {
                const achievements = [
                    { id: 'firstCorrect', icon: '1️⃣', tooltip: 'First Correct Answer' },
                    { id: 'fiveInARow', icon: '🔥', tooltip: '5 Correct Answers in a Row' },
                    { id: 'levelComplete', icon: '⭐', tooltip: 'Level Completed' },
                    { id: 'speedyAnswer', icon: '⚡', tooltip: 'Lightning Fast Answer' },
                    { id: 'perfectScore', icon: '🏆', tooltip: 'Perfect Score' },
                    { id: 'divisorMaster', icon: '🧮', tooltip: 'Divisor Master' },
                    { id: 'remainderPro', icon: 'R', tooltip: 'Remainder Pro' },
                    { id: 'quizAce', icon: '🎓', tooltip: 'Quiz Ace' }
                ];
                
                let badgesHTML = '';
                for (const achievement of achievements) {
                    badgesHTML += `
                        <div class="achievement-badge" id="${achievement.id}Badge">
                            ${achievement.icon}
                            <div class="achievement-tooltip">${achievement.tooltip}</div>
                        </div>
                    `;
                }
                
                this.elements.achievementsContainer.innerHTML = badgesHTML;
            }
            
            // Set up event listeners for buttons and interactions
            setupEventListeners() {
                // Mode button listeners
                this.elements.modeButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        this.elements.modeButtons.forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');
                        this.startMode(button.dataset.mode);
                    });
                });
                
                // Settings panel toggle
                this.elements.settingsToggle.addEventListener('click', () => {
                    this.elements.settingsPanel.classList.toggle('open');
                });
                
                // Apply settings button
                document.getElementById('applySettingsButton').addEventListener('click', () => {
                    this.saveSettings();
                    this.elements.settingsPanel.classList.remove('open');
                    this.restartCurrentMode();
                });
                
                // Reset settings button
                document.getElementById('resetSettingsButton').addEventListener('click', () => {
                    this.resetSettings();
                });
                
                // Help button (will be created dynamically)
                const helpButton = document.createElement('button');
                helpButton.className = 'help-button';
                helpButton.textContent = '?';
                helpButton.id = 'helpButton';
                document.querySelector('.app-container').appendChild(helpButton);
                
                document.getElementById('helpButton').addEventListener('click', () => {
                    document.getElementById('helpModal').style.display = 'flex';
                });
                
                // Close help modal
                document.getElementById('closeHelpModal').addEventListener('click', () => {
                    document.getElementById('helpModal').style.display = 'none';
                });
                
                // Results screen buttons
                document.getElementById('nextLevelButton').addEventListener('click', () => {
                    this.level++;
                    this.elements.levelDisplay.textContent = this.level;
                    this.elements.resultsScreen.style.display = 'none';
                    this.updateDifficultyForLevel();
                    this.restartCurrentMode();
                });
                
                document.getElementById('retryButton').addEventListener('click', () => {
                    this.elements.resultsScreen.style.display = 'none';
                    this.restartCurrentMode();
                });
                
                // Theme change listener
                document.getElementById('themeSetting').addEventListener('change', (e) => {
                    this.applyTheme(e.target.value);
                });
                
                // Character change listener
                document.getElementById('characterSetting').addEventListener('change', (e) => {
                    this.settings.character = e.target.value;
                    this.initializeCharacter();
                });
            }
            
            // Load settings from localStorage if available
            loadSettings() {
                const savedSettings = localStorage.getItem('divisionAdventureSettings');
                if (savedSettings) {
                    this.settings = JSON.parse(savedSettings);
                }
                
                // Set form values based on settings
                document.getElementById('minDividendSetting').value = this.settings.minDividend;
                document.getElementById('maxDividendSetting').value = this.settings.maxDividend;
                document.getElementById('minDivisorSetting').value = this.settings.minDivisor;
                document.getElementById('maxDivisorSetting').value = this.settings.maxDivisor;
                document.getElementById('allowRemaindersSetting').checked = this.settings.allowRemainders;
                document.getElementById('timeLimitSetting').value = this.settings.timeLimit;
                document.getElementById('characterSetting').value = this.settings.character;
                document.getElementById('themeSetting').value = this.settings.theme;
                document.getElementById('animationSpeedSetting').value = this.settings.animationSpeed;
                document.getElementById('showHintsSetting').checked = this.settings.showHints;
                document.getElementById('visualizationSetting').value = this.settings.visualizationType;
                document.getElementById('explanationLevelSetting').value = this.settings.explanationLevel;
                document.getElementById('autoProgressSetting').checked = this.settings.autoProgress;
                
                // Apply theme
                this.applyTheme(this.settings.theme);
            }
            
            // Save settings to localStorage
            saveSettings() {
                this.settings.minDividend = parseInt(document.getElementById('minDividendSetting').value);
                this.settings.maxDividend = parseInt(document.getElementById('maxDividendSetting').value);
                this.settings.minDivisor = parseInt(document.getElementById('minDivisorSetting').value);
                this.settings.maxDivisor = parseInt(document.getElementById('maxDivisorSetting').value);
                this.settings.allowRemainders = document.getElementById('allowRemaindersSetting').checked;
                this.settings.timeLimit = parseInt(document.getElementById('timeLimitSetting').value);
                this.settings.character = document.getElementById('characterSetting').value;
                this.settings.theme = document.getElementById('themeSetting').value;
                this.settings.animationSpeed = parseFloat(document.getElementById('animationSpeedSetting').value);
                this.settings.showHints = document.getElementById('showHintsSetting').checked;
                this.settings.visualizationType = document.getElementById('visualizationSetting').value;
                this.settings.explanationLevel = document.getElementById('explanationLevelSetting').value;
                this.settings.autoProgress = document.getElementById('autoProgressSetting').checked;
                
                localStorage.setItem('divisionAdventureSettings', JSON.stringify(this.settings));
            }
            
            // Reset settings to default
            resetSettings() {
                const defaultSettings = {
                    minDividend: 1,
                    maxDividend: 50,
                    minDivisor: 1,
                    maxDivisor: 10,
                    allowRemainders: false,
                    timeLimit: 0,
                    character: 'professor',
                    theme: 'default',
                    animationSpeed: 1,
                    showHints: true,
                    visualizationType: 'objects',
                    explanationLevel: 'basic',
                    autoProgress: true
                };
                
                this.settings = defaultSettings;
                
                // Update form values
                document.getElementById('minDividendSetting').value = defaultSettings.minDividend;
                document.getElementById('maxDividendSetting').value = defaultSettings.maxDividend;
                document.getElementById('minDivisorSetting').value = defaultSettings.minDivisor;
                document.getElementById('maxDivisorSetting').value = defaultSettings.maxDivisor;
                document.getElementById('allowRemaindersSetting').checked = defaultSettings.allowRemainders;
                document.getElementById('timeLimitSetting').value = defaultSettings.timeLimit;
                document.getElementById('characterSetting').value = defaultSettings.character;
                document.getElementById('themeSetting').value = defaultSettings.theme;
                document.getElementById('animationSpeedSetting').value = defaultSettings.animationSpeed;
                document.getElementById('showHintsSetting').checked = defaultSettings.showHints;
                document.getElementById('visualizationSetting').value = defaultSettings.visualizationType;
                document.getElementById('explanationLevelSetting').value = defaultSettings.explanationLevel;
                document.getElementById('autoProgressSetting').checked = defaultSettings.autoProgress;
                
                // Apply theme
                this.applyTheme(defaultSettings.theme);
                
                // Update character
                this.initializeCharacter();
            }
            
            // Apply theme colors
            applyTheme(theme) {
                const root = document.documentElement;
                
                const themes = {
                    default: {
                        primary: '#4e54c8',
                        secondary: '#8f94fb',
                        tertiary: '#ffd166',
                        character: '#8338ec'
                    },
                    green: {
                        primary: '#38b000',
                        secondary: '#70e000',
                        tertiary: '#ffdd00',
                        character: '#008000'
                    },
                    purple: {
                        primary: '#7209b7',
                        secondary: '#b5179e',
                        tertiary: '#f72585',
                        character: '#560bad'
                    },
                    orange: {
                        primary: '#fb5607',
                        secondary: '#ff9e00',
                        tertiary: '#ffbf69',
                        character: '#e85d04'
                    }
                };
                
                const selectedTheme = themes[theme] || themes.default;
                
                root.style.setProperty('--primary-color', selectedTheme.primary);
                root.style.setProperty('--secondary-color', selectedTheme.secondary);
                root.style.setProperty('--tertiary-color', selectedTheme.tertiary);
                root.style.setProperty('--character-color', selectedTheme.character);
            }
            
            // Start a specific game mode
            startMode(mode) {
                this.currentMode = mode;
                this.resetGame();
                
                // Set appropriate speech bubble text
                const speechTexts = {
                    learn: "Let's learn about division! Division is sharing into equal groups.",
                    practice: "Time to practice your division skills! Try to solve these problems.",
                    longdivision: "Long division helps us divide bigger numbers step by step.",
                    quiz: "Test your division knowledge with this fun quiz!",
                    challenge: "Challenge time! Let's see how quickly you can solve these problems."
                };
                
                this.setSpeechBubbleText(speechTexts[mode]);
                
                // Call the appropriate mode handler
                switch (mode) {
                    case 'learn':
                        this.startLearnMode();
                        break;
                    case 'practice':
                        this.startPracticeMode();
                        break;
                    case 'longdivision':
                        this.startLongDivisionMode();
                        break;
                    case 'quiz':
                        this.startQuizMode();
                        break;
                    case 'challenge':
                        this.startChallengeMode();
                        break;
                }
            }
            
            // Reset the game state
            resetGame() {
                this.elements.gameArea.innerHTML = '';
                this.questionsAnswered = 0;
                this.correctAnswers = 0;
                this.progress = 0;
                this.elements.progressBar.style.width = '0%';
                this.currentQuestion = null;
                this.problemHistory = [];
            }
            
            // Restart the current mode
            restartCurrentMode() {
                this.startMode(this.currentMode);
            }
            
            // Set speech bubble text with typing animation
            setSpeechBubbleText(text, speed = 50) {
                if (!text) return;
                
                const speechBubble = this.elements.speechBubble;
                speechBubble.textContent = '';
                
                // Adjust speed based on settings
                const typingSpeed = speed / this.settings.animationSpeed;
                
                let i = 0;
                const typeNextChar = () => {
                    if (i < text.length) {
                        speechBubble.textContent += text.charAt(i);
                        i++;
                        setTimeout(typeNextChar, typingSpeed);
                    }
                };
                
                typeNextChar();
            }
            
            // Generate a random division problem based on settings and level
            generateDivisionProblem() {
                // Adjust difficulty based on level
                const level = this.level;
                const minDividend = this.settings.minDividend * level;
                const maxDividend = Math.min(this.settings.maxDividend * level, 1000);
                const minDivisor = this.settings.minDivisor;
                const maxDivisor = Math.min(this.settings.maxDivisor + Math.floor(level/2), 20);
                
                let divisor, dividend, quotient, remainder;
                
                // Generate numbers based on whether remainders are allowed
                if (this.settings.allowRemainders) {
                    divisor = Math.floor(Math.random() * (maxDivisor - minDivisor + 1)) + minDivisor;
                    dividend = Math.floor(Math.random() * (maxDividend - minDividend + 1)) + minDividend;
                    quotient = Math.floor(dividend / divisor);
                    remainder = dividend % divisor;
                } else {
                    divisor = Math.floor(Math.random() * (maxDivisor - minDivisor + 1)) + minDivisor;
                    quotient = Math.floor(Math.random() * 10) + 1; // Random quotient between 1 and 10
                    dividend = divisor * quotient;
                }
                
                return {
                    divisor,
                    dividend,
                    quotient,
                    remainder: remainder || 0
                };
            }
            
            // Generate a random long division problem
            generateLongDivisionProblem() {
                // Adjust based on level
                const level = this.level;
                const digitCount = Math.min(level + 2, 6); // 3 to 6 digits based on level
                const maxDivisor = Math.min(9 + level, 20);
                
                const divisor = Math.floor(Math.random() * (maxDivisor - 2)) + 2;
                let dividend = '';
                
                // Generate a dividend with appropriate number of digits
                for (let i = 0; i < digitCount; i++) {
                    dividend += Math.floor(Math.random() * 9) + 1;
                }
                
                return {
                    divisor,
                    dividend: parseInt(dividend),
                    quotient: Math.floor(parseInt(dividend) / divisor),
                    remainder: parseInt(dividend) % divisor
                };
            }
            
            // Update UI to show current score and progress
            updateScore(increment = 0) {
                this.score += increment;
                this.elements.scoreDisplay.textContent = this.score;
                
                // Update progress bar
                const progressIncrement = 100 / 10; // 10 questions per level
                this.progress += progressIncrement;
                this.elements.progressBar.style.width = `${Math.min(this.progress, 100)}%`;
                
                // Check for level completion
                if (this.progress >= 100) {
                    this.completeLevel();
                }
            }
            
            // Show completion screen for current level
            completeLevel() {
                document.getElementById('finalScore').textContent = this.score;
                
                // Calculate accuracy
                const accuracy = this.questionsAnswered > 0 ? Math.round((this.correctAnswers / this.questionsAnswered) * 100) : 0;
                
                // Set results message based on accuracy
                let message = '';
                if (accuracy >= 90) {
                    message = 'Amazing work! Youre a division master!';
                    this.unlockAchievement('perfectScore');
                } else if (accuracy >= 70) {
                    message = 'Great job! Youre getting really good at division!';
                } else if (accuracy >= 50) {
                    message = 'Good effort! Keep practicing to improve even more.';
                } else {
                    message = 'Youre making progress! Lets try some more practice.';
                }
                
                document.getElementById('resultsMessage').textContent = message;
                this.elements.resultsScreen.style.display = 'flex';
                
                // Unlock achievement
                this.unlockAchievement('levelComplete');
            }
            
            // Update difficulty settings based on current level
            updateDifficultyForLevel() {
                // Implement level-based difficulty scaling here
                const newMinDividend = this.settings.minDividend + (this.level - 1) * 5;
                const newMaxDividend = this.settings.maxDividend + (this.level - 1) * 10;
                const newMaxDivisor = this.settings.maxDivisor + Math.floor((this.level - 1) / 2);
                
                document.getElementById('minDividendSetting').value = newMinDividend;
                document.getElementById('maxDividendSetting').value = newMaxDividend;
                document.getElementById('maxDivisorSetting').value = newMaxDivisor;
                
                this.saveSettings();
            }
            
// Unlock an achievement
unlockAchievement(achievementId) {
                if (!this.achievements[achievementId]) {
                    this.achievements[achievementId] = true;
                    
                    // Update the badge UI
                    const badge = document.getElementById(`${achievementId}Badge`);
                    if (badge) {
                        badge.classList.add('unlocked');
                        badge.classList.add('animate-bounce');
                        setTimeout(() => {
                            badge.classList.remove('animate-bounce');
                        }, 3000);
                    }
                    
                    // Show congratulatory message
                    this.setSpeechBubbleText(`Congratulations! You've earned the ${achievementId.replace(/([A-Z])/g, ' $1').toLowerCase()} achievement!`);
                }
            }
            
            // Check and update achievements based on performance
            checkAchievements(correct, answerTime) {
                // First correct answer
                if (correct && !this.achievements.firstCorrect) {
                    this.unlockAchievement('firstCorrect');
                }
                
                // Five correct answers in a row
                if (correct) {
                    this.correctStreak = (this.correctStreak || 0) + 1;
                    if (this.correctStreak >= 5 && !this.achievements.fiveInARow) {
                        this.unlockAchievement('fiveInARow');
                    }
                } else {
                    this.correctStreak = 0;
                }
                
                // Speedy answer (under 3 seconds)
                if (correct && answerTime < 3000 && !this.achievements.speedyAnswer) {
                    this.unlockAchievement('speedyAnswer');
                }
                
                // Divisor master (correctly divide by numbers > 10)
                if (correct && this.currentQuestion && this.currentQuestion.divisor > 10 && !this.achievements.divisorMaster) {
                    this.unlockAchievement('divisorMaster');
                }
                
                // Remainder pro (correctly handle remainders)
                if (correct && this.currentQuestion && this.currentQuestion.remainder > 0 && !this.achievements.remainderPro) {
                    this.unlockAchievement('remainderPro');
                }
                
                // Quiz ace (perfect score on a quiz)
                if (this.currentMode === 'quiz' && this.questionsAnswered === 5 && this.correctAnswers === 5 && !this.achievements.quizAce) {
                    this.unlockAchievement('quizAce');
                }
            }
            
            // Create visual representation of objects for division
            createObjectsVisualization(dividend, divisor) {
                const container = document.createElement('div');
                container.className = 'visualization-container';
                
                // Create objects
                const objectsContainer = document.createElement('div');
                objectsContainer.className = 'division-objects';
                
                for (let i = 0; i < dividend; i++) {
                    const object = document.createElement('div');
                    object.className = 'division-object';
                    object.textContent = i + 1;
                    objectsContainer.appendChild(object);
                }
                
                container.appendChild(objectsContainer);
                
                // Create groups
                const groupsContainer = document.createElement('div');
                groupsContainer.className = 'division-groups';
                
                for (let i = 0; i < divisor; i++) {
                    const group = document.createElement('div');
                    group.className = 'division-group';
                    groupsContainer.appendChild(group);
                }
                
                container.appendChild(groupsContainer);
                
                return container;
            }
            
            // Animate the division process
            animateDivision(container, dividend, divisor, delay = 500) {
                const objects = container.querySelectorAll('.division-object');
                const groups = container.querySelectorAll('.division-group');
                
                // Adjust delay based on animation speed setting
                const animationDelay = delay / this.settings.animationSpeed;
                
                let objectIndex = 0;
                let groupIndex = 0;
                
                // Calculate how many objects per group
                const objectsPerGroup = Math.floor(dividend / divisor);
                const remainder = dividend % divisor;
                
                const distributeNextObject = () => {
                    if (objectIndex < objects.length) {
                        const object = objects[objectIndex];
                        const group = groups[groupIndex];
                        
                        // Highlight the object
                        object.style.backgroundColor = 'var(--secondary-color)';
                        object.style.transform = 'scale(1.2)';
                        
                        setTimeout(() => {
                            // Move object to group
                            group.appendChild(object.cloneNode(true));
                            object.style.opacity = '0.3';
                            object.style.transform = 'scale(1)';
                            
                            // Increment counters
                            objectIndex++;
                            
                            // Move to next group after filling current one
                            if (objectIndex % objectsPerGroup === 0 && groupIndex < divisor - 1) {
                                groupIndex++;
                            }
                            
                            // Continue distribution
                            if (objectIndex < dividend - remainder) {
                                setTimeout(distributeNextObject, animationDelay);
                            } else {
                                // Highlight remainder if any
                                if (remainder > 0) {
                                    this.highlightRemainder(objects, dividend - remainder);
                                }
                            }
                        }, animationDelay);
                    }
                };
                
                // Start the animation
                setTimeout(distributeNextObject, animationDelay);
            }
            
            // Highlight remainder objects
            highlightRemainder(objects, startIndex) {
                for (let i = startIndex; i < objects.length; i++) {
                    objects[i].style.backgroundColor = 'var(--warning-color)';
                    objects[i].style.borderColor = 'var(--warning-color)';
                }
            }
            
            // Create a number line visualization for division
            createNumberLineVisualization(dividend, divisor) {
                const container = document.createElement('div');
                container.className = 'visualization-container';
                
                const numberLine = document.createElement('svg');
                numberLine.setAttribute('width', '100%');
                numberLine.setAttribute('height', '100');
                numberLine.setAttribute('viewBox', '0 0 500 100');
                
                // Draw the line
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', '50');
                line.setAttribute('y1', '50');
                line.setAttribute('x2', '450');
                line.setAttribute('y2', '50');
                line.setAttribute('stroke', 'var(--primary-color)');
                line.setAttribute('stroke-width', '2');
                numberLine.appendChild(line);
                
                // Draw ticks and numbers
                const totalTicks = dividend > 20 ? 10 : dividend;
                const tickSpacing = 400 / totalTicks;
                const valuePerTick = dividend / totalTicks;
                
                for (let i = 0; i <= totalTicks; i++) {
                    const x = 50 + i * tickSpacing;
                    
                    // Draw tick
                    const tick = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    tick.setAttribute('x1', x);
                    tick.setAttribute('y1', '45');
                    tick.setAttribute('x2', x);
                    tick.setAttribute('y2', '55');
                    tick.setAttribute('stroke', 'var(--primary-color)');
                    tick.setAttribute('stroke-width', '2');
                    numberLine.appendChild(tick);
                    
                    // Draw number
                    const number = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    number.setAttribute('x', x);
                    number.setAttribute('y', '70');
                    number.setAttribute('text-anchor', 'middle');
                    number.setAttribute('fill', 'var(--text-color)');
                    number.textContent = Math.round(i * valuePerTick);
                    numberLine.appendChild(number);
                }
                
                // Draw arrows for division points
                const quotient = Math.floor(dividend / divisor);
                const remainder = dividend % divisor;
                
                for (let i = 1; i <= divisor; i++) {
                    const x = 50 + (i * quotient * tickSpacing / valuePerTick);
                    if (x <= 450) {
                        // Draw arrow
                        const arrow = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                        arrow.setAttribute('d', `M ${x} 35 L ${x} 20 L ${x + 5} 25 L ${x} 20 L ${x - 5} 25`);
                        arrow.setAttribute('fill', 'none');
                        arrow.setAttribute('stroke', 'var(--tertiary-color)');
                        arrow.setAttribute('stroke-width', '2');
                        numberLine.appendChild(arrow);
                        
                        // Label
                        const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                        label.setAttribute('x', x);
                        label.setAttribute('y', '15');
                        label.setAttribute('text-anchor', 'middle');
                        label.setAttribute('fill', 'var(--tertiary-color)');
                        label.textContent = i;
                        numberLine.appendChild(label);
                    }
                }
                
                // Highlight remainder if any
                if (remainder > 0) {
                    const remainderX = 50 + ((divisor * quotient) * tickSpacing / valuePerTick);
                    const remainderWidth = remainder * tickSpacing / valuePerTick;
                    
                    const remainderRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                    remainderRect.setAttribute('x', remainderX);
                    remainderRect.setAttribute('y', '45');
                    remainderRect.setAttribute('width', remainderWidth);
                    remainderRect.setAttribute('height', '10');
                    remainderRect.setAttribute('fill', 'var(--warning-color)');
                    remainderRect.setAttribute('opacity', '0.5');
                    numberLine.appendChild(remainderRect);
                    
                    const remainderLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    remainderLabel.setAttribute('x', remainderX + remainderWidth / 2);
                    remainderLabel.setAttribute('y', '40');
                    remainderLabel.setAttribute('text-anchor', 'middle');
                    remainderLabel.setAttribute('fill', 'var(--warning-color)');
                    remainderLabel.textContent = `Remainder: ${remainder}`;
                    numberLine.appendChild(remainderLabel);
                }
                
                container.appendChild(numberLine);
                return container;
            }
            
            // Create a division tree visualization
            createDivisionTreeVisualization(dividend, divisor) {
                const container = document.createElement('div');
                container.className = 'visualization-container';
                
                const treeContainer = document.createElement('div');
                treeContainer.className = 'division-tree';
                
                // Create root node
                const rootNode = document.createElement('div');
                rootNode.className = 'tree-node';
                rootNode.textContent = dividend;
                rootNode.style.width = '50px';
                rootNode.style.height = '50px';
                rootNode.style.top = '10px';
                rootNode.style.left = '50%';
                rootNode.style.transform = 'translateX(-50%)';
                treeContainer.appendChild(rootNode);
                
                // Create branch nodes for each group
                const quotient = Math.floor(dividend / divisor);
                const remainder = dividend % divisor;
                
                const nodeSize = 40;
                const levelHeight = 80;
                
                for (let i = 0; i < divisor; i++) {
                    // Create connection line
                    const connection = document.createElement('div');
                    connection.className = 'tree-connection';
                    
                    const startX = parseFloat(rootNode.style.left) || 50;
                    const startY = parseFloat(rootNode.style.top) + nodeSize + 10;
                    
                    const endX = (100 / (divisor + 1)) * (i + 1);
                    const endY = levelHeight;
                    
                    const length = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2));
                    const angle = Math.atan2(endY - startY, endX - startX) * 180 / Math.PI;
                    
                    connection.style.width = `${length}px`;
                    connection.style.height = '2px';
                    connection.style.top = `${startY}px`;
                    connection.style.left = `${startX}%`;
                    connection.style.transform = `rotate(${angle}deg)`;
                    
                    treeContainer.appendChild(connection);
                    
                    // Create node for each group
                    const node = document.createElement('div');
                    node.className = 'tree-node';
                    node.textContent = quotient;
                    node.style.width = `${nodeSize}px`;
                    node.style.height = `${nodeSize}px`;
                    node.style.top = `${levelHeight}px`;
                    node.style.left = `${endX}%`;
                    node.style.transform = 'translateX(-50%)';
                    
                    treeContainer.appendChild(node);
                }
                
                // Add remainder node if needed
                if (remainder > 0) {
                    const remainderNode = document.createElement('div');
                    remainderNode.className = 'tree-node';
                    remainderNode.textContent = remainder;
                    remainderNode.style.width = `${nodeSize}px`;
                    remainderNode.style.height = `${nodeSize}px`;
                    remainderNode.style.top = `${levelHeight}px`;
                    remainderNode.style.left = '85%';
                    remainderNode.style.transform = 'translateX(-50%)';
                    remainderNode.style.backgroundColor = 'var(--warning-color)';
                    
                    const remainderConnection = document.createElement('div');
                    remainderConnection.className = 'tree-connection';
                    
                    const startX = parseFloat(rootNode.style.left) || 50;
                    const startY = parseFloat(rootNode.style.top) + nodeSize + 10;
                    
                    const endX = 85;
                    const endY = levelHeight;
                    
                    const length = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2));
                    const angle = Math.atan2(endY - startY, endX - startX) * 180 / Math.PI;
                    
                    remainderConnection.style.width = `${length}px`;
                    remainderConnection.style.height = '2px';
                    remainderConnection.style.top = `${startY}px`;
                    remainderConnection.style.left = `${startX}%`;
                    remainderConnection.style.transform = `rotate(${angle}deg)`;
                    
                    treeContainer.appendChild(remainderConnection);
                    treeContainer.appendChild(remainderNode);
                    
                    // Add remainder label
                    const remainderLabel = document.createElement('div');
                    remainderLabel.textContent = 'Remainder';
                    remainderLabel.style.position = 'absolute';
                    remainderLabel.style.top = `${levelHeight + nodeSize + 5}px`;
                    remainderLabel.style.left = '85%';
                    remainderLabel.style.transform = 'translateX(-50%)';
                    remainderLabel.style.color = 'var(--warning-color)';
                    remainderLabel.style.fontWeight = 'bold';
                    
                    treeContainer.appendChild(remainderLabel);
                }
                
                container.appendChild(treeContainer);
                return container;
            }
            
            // Create confetti animation for correct answers
            createConfetti() {
                const colors = ['#ffd166', 'var(--primary-color)', 'var(--secondary-color)', 'var(--tertiary-color)', 'var(--success-color)'];
                const confettiCount = 50;
                
                for (let i = 0; i < confettiCount; i++) {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    
                    confetti.style.left = `${Math.random() * 100}%`;
                    confetti.style.width = `${Math.random() * 10 + 5}px`;
                    confetti.style.height = `${Math.random() * 10 + 5}px`;
                    confetti.style.opacity = Math.random() + 0.5;
                    confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                    
                    document.body.appendChild(confetti);
                    
                    setTimeout(() => {
                        confetti.remove();
                    }, 5000);
                }
            }
            
            // Start Learn Mode
            startLearnMode() {
                // Generate a simple division problem to demonstrate
                const problem = this.generateDivisionProblem();
                this.currentQuestion = problem;
                
                const gameArea = this.elements.gameArea;
                gameArea.innerHTML = '';
                
                // Create lesson container
                const lessonContainer = document.createElement('div');
                lessonContainer.className = 'quiz-container';
                
                // Create lesson title
                const lessonTitle = document.createElement('h3');
                lessonTitle.className = 'quiz-question';
                lessonTitle.textContent = 'Understanding Division';
                lessonContainer.appendChild(lessonTitle);
                
                // Create explanation
                const explanation = document.createElement('p');
                explanation.style.marginBottom = '20px';
                explanation.style.textAlign = 'center';
                
                const basicExplanation = `Division is sharing a number into equal groups. When we divide ${problem.dividend} by ${problem.divisor}, we're asking how many equal groups of ${problem.divisor} we can make, or how many items will be in each group if we make ${problem.divisor} groups.`;
                
                const detailedExplanation = `Division is the process of splitting a number (the dividend) into equal parts based on another number (the divisor). In ${problem.dividend} ÷ ${problem.divisor}, we're finding how many times ${problem.divisor} goes into ${problem.dividend}. The result (${problem.quotient}) is called the quotient.${problem.remainder > 0 ? ` There's also a remainder of ${problem.remainder}, which is what's left over after making equal groups.` : ''}`;
                
                const advancedExplanation = `Division is the inverse operation of multiplication. When we calculate ${problem.dividend} ÷ ${problem.divisor}, we're finding a number that, when multiplied by ${problem.divisor}, gives us ${problem.dividend}${problem.remainder > 0 ? ` (plus a remainder of ${problem.remainder})` : ''}. Division helps us understand concepts like fractions, ratios, and rates of change.`;
                
                // Set explanation based on level setting
                if (this.settings.explanationLevel === 'basic') {
                    explanation.textContent = basicExplanation;
                } else if (this.settings.explanationLevel === 'detailed') {
                    explanation.textContent = detailedExplanation;
                } else {
                    explanation.textContent = advancedExplanation;
                }
                
                lessonContainer.appendChild(explanation);
                
                // Create problem display
                const problemDisplay = document.createElement('div');
                problemDisplay.className = 'problem-display';
                problemDisplay.textContent = `${problem.dividend} ÷ ${problem.divisor} = ${problem.quotient}${problem.remainder > 0 ? ` R${problem.remainder}` : ''}`;
                lessonContainer.appendChild(problemDisplay);
                
                // Create visualization based on settings
                let visualization;
                
                switch (this.settings.visualizationType) {
                    case 'objects':
                        visualization = this.createObjectsVisualization(problem.dividend, problem.divisor);
                        break;
                    case 'groups':
                        visualization = this.createObjectsVisualization(problem.dividend, problem.divisor);
                        break;
                    case 'number-line':
                        visualization = this.createNumberLineVisualization(problem.dividend, problem.divisor);
                        break;
                    case 'tree':
                        visualization = this.createDivisionTreeVisualization(problem.dividend, problem.divisor);
                        break;
                    default:
                        visualization = this.createObjectsVisualization(problem.dividend, problem.divisor);
                }
                
                lessonContainer.appendChild(visualization);
                
                // Create next button
                const nextButton = document.createElement('button');
                nextButton.className = 'submit-button';
                nextButton.textContent = 'Next Example';
                nextButton.style.marginTop = '20px';
                
                nextButton.addEventListener('click', () => {
                    this.questionsAnswered++;
                    this.updateScore(1);
                    this.startLearnMode();
                });
                
                lessonContainer.appendChild(nextButton);
                
                gameArea.appendChild(lessonContainer);
                
                // Animate the visualization if objects or groups
                if (['objects', 'groups'].includes(this.settings.visualizationType)) {
                    setTimeout(() => {
                        this.animateDivision(visualization, problem.dividend, problem.divisor);
                    }, 1000);
                }
            }
            
            // Start Practice Mode
            startPracticeMode() {
                // Generate a division problem
                const problem = this.generateDivisionProblem();
                this.currentQuestion = problem;
                
                const gameArea = this.elements.gameArea;
                gameArea.innerHTML = '';
                
                // Create practice container
                const practiceContainer = document.createElement('div');
                practiceContainer.className = 'visualization-container';
                
                // Create problem display
                const problemDisplay = document.createElement('div');
                problemDisplay.className = 'problem-display';
                problemDisplay.textContent = `${problem.dividend} ÷ ${problem.divisor} = ?${this.settings.allowRemainders ? ' (R?)' : ''}`;
                practiceContainer.appendChild(problemDisplay);
                
                // Create visualization based on settings
                let visualization;
                
                switch (this.settings.visualizationType) {
                    case 'objects':
                        visualization = this.createObjectsVisualization(problem.dividend, problem.divisor);
                        break;
                    case 'groups':
                        visualization = this.createObjectsVisualization(problem.dividend, problem.divisor);
                        break;
                    case 'number-line':
                        visualization = this.createNumberLineVisualization(problem.dividend, problem.divisor);
                        // Hide the answers in number line for practice mode
                        const arrows = visualization.querySelectorAll('path, text');
                        arrows.forEach(arrow => {
                            arrow.style.opacity = '0';
                        });
                        break;
                    case 'tree':
                        visualization = this.createDivisionTreeVisualization(problem.dividend, problem.divisor);
                        // Hide the answers in tree for practice mode
                        const nodes = visualization.querySelectorAll('.tree-node:not(:first-child)');
                        nodes.forEach(node => {
                            node.textContent = '?';
                        });
                        break;
                    default:
                        visualization = this.createObjectsVisualization(problem.dividend, problem.divisor);
                }
                
                practiceContainer.appendChild(visualization);
                
                // Create input container
                const inputContainer = document.createElement('div');
                inputContainer.className = 'input-container';
                
                // Create answer input
                const answerInput = document.createElement('input');
                answerInput.className = 'answer-input';
                answerInput.type = 'number';
                answerInput.placeholder = 'Answer';
                answerInput.min = '0';
                answerInput.max = '999';
                answerInput.step = '1';
                
                // Create remainder input if allowed
                let remainderInput;
                if (this.settings.allowRemainders) {
                    remainderInput = document.createElement('input');
                    remainderInput.className = 'answer-input';
                    remainderInput.type = 'number';
                    remainderInput.placeholder = 'Remainder';
                    remainderInput.min = '0';
                    remainderInput.max = '999';
                    remainderInput.step = '1';
                    remainderInput.style.marginLeft = '10px';
                }
                
                // Create input label container
                const inputLabelContainer = document.createElement('div');
                inputLabelContainer.style.display = 'flex';
                inputLabelContainer.style.alignItems = 'center';
                inputLabelContainer.style.justifyContent = 'center';
                inputLabelContainer.style.gap = '10px';
                inputLabelContainer.style.marginBottom = '15px';
                
                const answerLabel = document.createElement('label');
                answerLabel.textContent = 'Answer:';
                answerLabel.style.fontWeight = 'bold';
                
                inputLabelContainer.appendChild(answerLabel);
                inputLabelContainer.appendChild(answerInput);
                
                if (this.settings.allowRemainders) {
                    const remainderLabel = document.createElement('label');
                    remainderLabel.textContent = 'Remainder:';
                    remainderLabel.style.fontWeight = 'bold';
                    
                    inputLabelContainer.appendChild(remainderLabel);
                    inputLabelContainer.appendChild(remainderInput);
                }
                
                inputContainer.appendChild(inputLabelContainer);
                
                // Create submit button
                const submitButton = document.createElement('button');
                submitButton.className = 'submit-button';
                submitButton.textContent = 'Check';
                
                inputContainer.appendChild(submitButton);
                
                // Create feedback message
                const feedbackMessage = document.createElement('div');
                feedbackMessage.className = 'feedback-message';
                inputContainer.appendChild(feedbackMessage);
                
                // Create hint button if enabled
                if (this.settings.showHints) {
                    const hintButton = document.createElement('button');
                    hintButton.className = 'settings-button';
                    hintButton.textContent = 'Show Hint';
                    hintButton.style.marginTop = '15px';
                    
                    hintButton.addEventListener('click', () => {
                        // Show animation for objects/groups visualization
                        if (['objects', 'groups'].includes(this.settings.visualizationType)) {
                            this.animateDivision(visualization, problem.dividend, problem.divisor);
                        }
                        // Show partial answer hint
                        feedbackMessage.textContent = `Hint: ${problem.dividend} ÷ ${problem.divisor} is about ${Math.floor(problem.quotient / 10) * 10}...`;
                        feedbackMessage.className = 'feedback-message';
                    });
                    
                    inputContainer.appendChild(hintButton);
                }
                
                practiceContainer.appendChild(inputContainer);
                
                gameArea.appendChild(practiceContainer);
                
                // Focus on answer input
                answerInput.focus();
                
                // Submit answer on enter key
                answerInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        submitButton.click();
                    }
                });
                
                if (remainderInput) {
                    remainderInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            submitButton.click();
                        }
                    });
                }
                
                // Start time measurement for achievements
                const startTime = Date.now();
                
                // Handle submit button click
                submitButton.addEventListener('click', () => {
                    const answerTime = Date.now() - startTime;
                    const userAnswer = parseInt(answerInput.value);
                    const userRemainder = remainderInput ? parseInt(remainderInput.value) || 0 : 0;
                    
                    let isCorrect = false;
                    
                    if (!isNaN(userAnswer)) {
                        if (this.settings.allowRemainders) {
                            isCorrect = userAnswer === problem.quotient && userRemainder === problem.remainder;
                        } else {
                            isCorrect = userAnswer === problem.quotient;
                        }
                    }
                    
                    if (isCorrect) {
                        feedbackMessage.textContent = 'Correct! Great job!';
                        feedbackMessage.className = 'feedback-message feedback-correct';
                        this.createConfetti();
                        this.score++;
                        this.elements.scoreDisplay.textContent = this.score;
                        this.correctAnswers++;
                        
                        // Check achievements
                        this.checkAchievements(true, answerTime);
                        
                        // Move to next question
                        setTimeout(() => {
                            this.questionsAnswered++;
                            this.updateScore(1);
                            this.startPracticeMode();
                        }, 2000);
                    } else {
                        feedbackMessage.textContent = `Not quite. Try again! The answer is ${problem.quotient}${problem.remainder > 0 ? ` R${problem.remainder}` : ''}.`;
                        feedbackMessage.className = 'feedback-message feedback-incorrect';
                        
                        // Check achievements
                        this.checkAchievements(false, answerTime);
                        
                        // Move to next question after delay
                        setTimeout(() => {
                            this.questionsAnswered++;
                            this.updateScore(0);
                            this.startPracticeMode();
                        }, 3000);
                    }
                });
            }
            
            // Start Long Division Mode
            startLongDivisionMode() {
                // Generate a long division problem
                const problem = this.generateLongDivisionProblem();
                this.currentQuestion = problem;
                
                const gameArea = this.elements.gameArea;
                gameArea.innerHTML = '';
                
                // Create long division container
                const longDivisionContainer = document.createElement('div');
                longDivisionContainer.className = 'long-division-container';
                
                // Create division problem display
                const divisionProblem = document.createElement('div');
                divisionProblem.className = 'division-problem';
                
                // Add divisor
                const divisor = document.createElement('div');
                divisor.className = 'divisor';
                divisor.textContent = problem.divisor;
                
                // Add vertical line
                const verticalLine = document.createElement('div');
                verticalLine.className = 'vertical-line';
                
                // Add horizontal line
                const horizontalLine = document.createElement('div');
                horizontalLine.className = 'horizontal-line';
                
                // Add dividend
                const dividend = document.createElement('div');
                dividend.className = 'dividend';
                dividend.textContent = problem.dividend;
                
                // Add quotient input
                const quotientInput = document.createElement('input');
                quotientInput.className = 'quotient-input';
                quotientInput.id = 'quotient-input';
                quotientInput.maxLength = problem.dividend.toString().length;
                
                // Add steps display
                const stepsDisplay = document.createElement('div');
                stepsDisplay.className = 'steps-display';
                stepsDisplay.id = 'steps-display';
                
                // Add elements to division problem
                divisionProblem.appendChild(divisor);
                divisionProblem.appendChild(verticalLine);
                divisionProblem.appendChild(horizontalLine);
                divisionProblem.appendChild(dividend);
                divisionProblem.appendChild(quotientInput);
                divisionProblem.appendChild(stepsDisplay);
                
                longDivisionContainer.appendChild(divisionProblem);
                
                // Create feedback message
                const feedbackMessage = document.createElement('div');
                feedbackMessage.className = 'feedback-message';
                feedbackMessage.id = 'feedback-message';
                longDivisionContainer.appendChild(feedbackMessage);
                
                // Explanation of long division
                const explanation = document.createElement('div');
                explanation.style.margin = '20px 0';
                explanation.style.padding = '15px';
                explanation.style.backgroundColor = 'rgba(255, 209, 102, 0.2)';
                explanation.style.borderRadius = 'var(--border-radius)';
                
                if (this.settings.explanationLevel === 'basic') {
                    explanation.innerHTML = `
                        <p><strong>How to do Long Division:</strong></p>
                        <ol>
                            <li>Start from the left and find how many times the divisor goes into the first digit(s) of the dividend.</li>
                            <li>Write that number above the horizontal line.</li>
                            <li>Multiply this number by the divisor and write the result below the digits you used.</li>
                            <li>Subtract and bring down the next digit.</li>
                            <li>Repeat until you reach the end of the dividend.</li>
                        </ol>
                    `;
                } else if (this.settings.explanationLevel === 'detailed') {
                    explanation.innerHTML = `
                        <p><strong>Long Division Step-by-Step:</strong></p>
                        <ol>
                            <li>Look at the first digit of the dividend (${problem.dividend.toString()[0]}).</li>
                            <li>If it's smaller than the divisor (${problem.divisor}), include the next digit too.</li>
                            <li>Divide this number by the divisor and write the result above.</li>
                            <li>Multiply this result by the divisor and write it below the digits you used.</li>
                            <li>Subtract this product from the digits above it.</li>
                            <li>Bring down the next digit from the dividend.</li>
                            <li>Repeat steps 3-6 until you finish all digits.</li>
                            <li>Any final remainder is written as "R" after the quotient.</li>
                        </ol>
                    `;
                } else {
                    explanation.innerHTML = `
                        <p><strong>Understanding Long Division Algorithm:</strong></p>
                        <p>Long division is a standard algorithm that breaks down complex division problems into a series of simpler steps:</p>
                        <ol>
                            <li><strong>Divide:</strong> Find the largest multiple of the divisor that fits into the current dividend segment.</li>
                            <li><strong>Multiply:</strong> Multiply the quotient digit by the divisor.</li>
                            <li><strong>Subtract:</strong> Subtract the product from the current dividend segment.</li>
                            <li><strong>Bring Down:</strong> Bring down the next digit to create a new dividend segment.</li>
                        </ol>
                        <p>This process is essentially finding partial quotients and remainders at each step, gradually building the complete quotient.</p>
                    `;
                }
                
                longDivisionContainer.appendChild(explanation);
                
                gameArea.appendChild(longDivisionContainer);
                
                // Focus on quotient input
                quotientInput.focus();
                
                // Set up the long division interactive process
                this.setupLongDivisionInteraction(problem);
            }
            
            // Set up interactive long division steps
            setupLongDivisionInteraction(problem) {
                const quotientInput = document.getElementById('quotient-input');
                const stepsDisplay = document.getElementById('steps-display');
                const feedbackMessage = document.getElementById('feedback-message');
                
                const divisor = problem.divisor;
                const dividendStr = problem.dividend.toString();
                
                let currentStep = 0;
                let currentPosition = 0;
                let workingNumber = '';
                let quotientDigits = [];
                
                // Helper function to check if a number is divisible by the divisor
                const isDivisible = (num) => {
                    return num >= divisor;
                };
                
                // Process the first digit
                processNextDigit();
                
                // Function to process the next digit
                function processNextDigit() {
                    // Clear input
                    quotientInput.value = '';
                    
                    // Get next digit and append to working number
                    if (currentPosition < dividendStr.length) {
                        workingNumber += dividendStr[currentPosition];
                        currentPosition++;
                        
                        // If working number is still not divisible by divisor, get more digits
                        while (!isDivisible(parseInt(workingNumber)) && currentPosition < dividendStr.length) {
                            workingNumber += dividendStr[currentPosition];
                            currentPosition++;
                            // Add zero to quotient for each skipped position
                            if (parseInt(workingNumber) < divisor) {
                                quotientDigits.push(0);
                            }
                        }
                        
                        // Update feedback message
                        feedbackMessage.textContent = `How many times does ${divisor} go into ${workingNumber}?`;
                        feedbackMessage.className = 'feedback-message';
                        
                        // Set up event listener for quotient input
                        quotientInput.onkeypress = (e) => {
                            if (e.key === 'Enter') {
                                checkQuotientDigit();
                            }
                        };
                    } else {
                        // Division complete
                        finishDivision();
                    }
                }
                
                // Function to check the entered quotient digit
                function checkQuotientDigit() {
                    const userQuotient = parseInt(quotientInput.value);
                    if (isNaN(userQuotient)) {
                        feedbackMessage.textContent = 'Please enter a valid number';
                        feedbackMessage.className = 'feedback-message feedback-incorrect';
                        return;
                    }
                    
                    const workingNum = parseInt(workingNumber);
                    const correctQuotient = Math.floor(workingNum / divisor);
                    
                    if (userQuotient === correctQuotient) {
                        // Store the correct quotient digit
                        quotientDigits.push(correctQuotient);
                        
                        // Calculate the product
                        const product = correctQuotient * divisor;
                        
                        // Calculate the remainder
                        const remainder = workingNum - product;
                        
                        // Update steps display
                        const padding = ' '.repeat(currentStep);
                        stepsDisplay.textContent += padding + product.toString() + '\n';
                        
                        // Set working number to remainder
                        workingNumber = remainder.toString();
                        
                        // Display feedback
                        feedbackMessage.textContent = 'Correct!';
                        feedbackMessage.className = 'feedback-message feedback-correct';
                        
                        // Increment step counter
                        currentStep++;
                        
                        // Move to next digit after a delay
                        setTimeout(processNextDigit, 1000);
                    } else {
                        feedbackMessage.textContent = `Not quite. ${divisor} goes into ${workingNumber} ${correctQuotient} times.`;
                        feedbackMessage.className = 'feedback-message feedback-incorrect';
                    }
                }
                
                // Function to finish the division process
                function finishDivision() {
                    // Create final answer text
                    const quotient = quotientDigits.join('');
                    const remainder = parseInt(workingNumber);
                    
                    // Display final answer
                    quotientInput.value = quotient;
                    
                    // Update feedback message
                    if (remainder > 0) {
                        feedbackMessage.textContent = `Great job! The answer is ${quotient} with a remainder of ${remainder}.`;
                    } else {
                        feedbackMessage.textContent = `Great job! The answer is ${quotient} with no remainder.`;
                    }
                    feedbackMessage.className = 'feedback-message feedback-correct';
                    
                    // Create confetti
                    this.createConfetti();
                    
                    // Update score
                    this.score++;
                    this.elements.scoreDisplay.textContent = this.score;
                    
                    // Move to next problem after delay
                    setTimeout(() => {
                        this.questionsAnswered++;
                        this.updateScore(1);
                        this.startLongDivisionMode();
                    }, 3000);
                }
            }
            
            // Start Quiz Mode
            startQuizMode() {
                const gameArea = this.elements.gameArea;
                gameArea.innerHTML = '';
                
                // Initialize quiz state if not already initialized
                if (!this.quizState) {
                    this.quizState = {
                        questions: this.generateQuizQuestions(5), // Generate 5 quiz questions
                        currentQuestionIndex: 0,
                        score: 0
                    };
                }
                
                // Get current question
                const currentQuestion = this.quizState.questions[this.quizState.currentQuestionIndex];
                
                // Create quiz container
                const quizContainer = document.createElement('div');
                quizContainer.className = 'quiz-container';
                
                // Create question display
                const questionDisplay = document.createElement('div');
                questionDisplay.className = 'quiz-question';
                questionDisplay.textContent = currentQuestion.question;
                quizContainer.appendChild(questionDisplay);
                
                // Create options container
                const optionsContainer = document.createElement('div');
                optionsContainer.className = 'quiz-options';
                
                // Add options
                currentQuestion.options.forEach((option, index) => {
                    const optionElement = document.createElement('div');
                    optionElement.className = 'quiz-option';
                    optionElement.textContent = option;
                    optionElement.dataset.index = index;
                    
                    optionElement.addEventListener('click', () => {
                        // Remove selected class from all options
                        document.querySelectorAll('.quiz-option').forEach(opt => {
                            opt.classList.remove('selected');
                        });
                        
                        // Add selected class to clicked option
                        optionElement.classList.add('selected');
                    });
                    
                    optionsContainer.appendChild(optionElement);
                });
                
                quizContainer.appendChild(optionsContainer);
                
                // Create submit button
                const submitButton = document.createElement('button');
                submitButton.className = 'quiz-submit';
                submitButton.textContent = 'Submit Answer';
                submitButton.addEventListener('click', () => {
                    const selectedOption = document.querySelector('.quiz-option.selected');
                    
                    if (selectedOption) {
                        const selectedIndex = parseInt(selectedOption.dataset.index);
                        const isCorrect = selectedIndex === currentQuestion.correctIndex;
                        
                        // Display feedback
                        const feedbackMessage = document.createElement('div');
                        feedbackMessage.className = `feedback-message ${isCorrect ? 'feedback-correct' : 'feedback-incorrect'}`;
                        feedbackMessage.textContent = isCorrect 
                            ? 'Correct! Great job!' 
                            : `Incorrect. The correct answer is: ${currentQuestion.options[currentQuestion.correctIndex]}`;
                        
                        // Replace submit button with feedback
                        submitButton.replaceWith(feedbackMessage);
                        
                        // Update quiz state
                        if (isCorrect) {
                            this.quizState.score++;
                            this.createConfetti();
                            this.correctAnswers++;
                        }
                        
                        // Move to next question after delay
                        setTimeout(() => {
                            this.quizState.currentQuestionIndex++;
                            this.questionsAnswered++;
                            
                            // If there are more questions, show the next one
                            if (this.quizState.currentQuestionIndex < this.quizState.questions.length) {
                                this.startQuizMode();
                            } else {
                                // Quiz completed
                                this.completeQuiz();
                            }
                        }, 2000);
                    }
                });
                
                quizContainer.appendChild(submitButton);
                
                // Create visualization if appropriate for the question type
                if (currentQuestion.visualizationType) {
                    let visualization;
                    
                    switch (currentQuestion.visualizationType) {
                        case 'objects':
                            visualization = this.createObjectsVisualization(currentQuestion.dividend, currentQuestion.divisor);
                            quizContainer.appendChild(visualization);
                            break;
                        case 'number-line':
                            visualization = this.createNumberLineVisualization(currentQuestion.dividend, currentQuestion.divisor);
                            quizContainer.appendChild(visualization);
                            break;
                    }
                }
                
                gameArea.appendChild(quizContainer);
            }
            
            // Generate quiz questions
            generateQuizQuestions(count) {
                const questions = [];
                
                // Different types of quiz questions
                const questionTypes = [
                    'calculation',
                    'visualization',
                    'word-problem',
                    'remainder',
                    'concept'
                ];
                
                for (let i = 0; i < count; i++) {
                    // Choose question type based on level
                    const allowedTypes = questionTypes.slice(0, Math.min(2 + this.level, 5));
                    const questionType = allowedTypes[Math.floor(Math.random() * allowedTypes.length)];
                    
                    // Generate problem
                    const problem = this.generateDivisionProblem();
                    
                    let question = '';
                    let options = [];
                    let correctIndex = 0;
                    let visualizationType = null;
                    
                    switch (questionType) {
                        case 'calculation':
                            question = `What is ${problem.dividend} ÷ ${problem.divisor}?`;
                            correctIndex = 0;
                            options = [
                                `${problem.quotient}${problem.remainder > 0 ? ` R${problem.remainder}` : ''}`,
                                `${problem.quotient + 1}${problem.remainder > 0 ? ` R${problem.remainder - 1}` : ''}`,
                                `${problem.quotient - 1}${problem.remainder > 0 ? ` R${problem.remainder + 1}` : ' R1'}`,
                                `${problem.quotient * problem.divisor}`
                            ];
                            break;
                            
                        case 'visualization':
                            question = `If we divide ${problem.dividend} objects into ${problem.divisor} equal groups, how many objects will be in each group?`;
                            correctIndex = 0;
                            options = [
                                `${problem.quotient}${problem.remainder > 0 ? ` (with ${problem.remainder} left over)` : ''}`,
                                `${problem.quotient + 1}`,
                                `${problem.quotient - 1}`,
                                `${problem.divisor}`
                            ];
                            visualizationType = 'objects';
                            break;
                            
                        case 'word-problem':
                            const items = ['cookies', 'stickers', 'toys', 'candies', 'blocks'];
                            const item = items[Math.floor(Math.random() * items.length)];
                            
                            question = `If you have ${problem.dividend} ${item} and want to share them equally among ${problem.divisor} friends, how many ${item} will each friend get?`;
                            correctIndex = 0;
                            options = [
                                `${problem.quotient}${problem.remainder > 0 ? ` (with ${problem.remainder} left over)` : ''}`,
                                `${problem.quotient + 1}`,
                                `${Math.floor(problem.dividend / (problem.divisor + 1))}`,
                                `${problem.divisor}`
                            ];
                            break;
                            
                        case 'remainder':
                            question = `When ${problem.dividend} is divided by ${problem.divisor}, what is the remainder?`;
                            correctIndex = 0;
                            options = [
                                `${problem.remainder}`,
                                `${(problem.remainder + 1) % problem.divisor}`,
                                `${(problem.remainder + 2) % problem.divisor}`,
                                `0`
                            ];
                            visualizationType = 'number-line';
                            break;
                            
                        case 'concept':
                            const conceptQuestions = [
                                {
                                    question: `Which operation is the opposite of division?`,
                                    options: ['Multiplication', 'Addition', 'Subtraction', 'Exponentiation'],
                                    correctIndex: 0
                                },
                                {
                                    question: `If you divide a number by 1, what do you get?`,
                                    options: ['The same number', 'Always 1', 'Always 0', 'Half the number'],
                                    correctIndex: 0
                                },
                                {
                                    question: `What happens when you divide a number by itself?`,
                                    options: ['You get 1', 'You get 0', 'You get the number itself', 'You get 2'],
                                    correctIndex: 0
                                },
                                {
                                    question: `What do we call the number that is divided in a division problem?`,
                                    options: ['Dividend', 'Divisor', 'Quotient', 'Remainder'],
                                    correctIndex: 0
                                },
                                {
                                    question: `What do we call the result of a division problem?`,
                                    options: ['Quotient', 'Dividend', 'Divisor', 'Product'],
                                    correctIndex: 0
                                }
                            ];
                            
                            const selectedConcept = conceptQuestions[Math.floor(Math.random() * conceptQuestions.length)];
                            question = selectedConcept.question;
                            options = selectedConcept.options;
                            correctIndex = selectedConcept.correctIndex;
                            break;
                    }
                    
                    // Shuffle options (keeping track of correct answer)
                    const correctAnswer = options[correctIndex];
                    options = this.shuffleArray(options);
                    correctIndex = options.indexOf(correctAnswer);
                    
                    questions.push({
                        question,
                        options,
                        correctIndex,
                        visualizationType,
                        dividend: problem.dividend,
                        divisor: problem.divisor
                    });
                }
                
                return questions;
            }
            
            // Shuffle array (for quiz options)
            shuffleArray(array) {
                const newArray = [...array];
                for (let i = newArray.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
                }
                return newArray;
            }
            
            // Complete Quiz
            completeQuiz() {
                const gameArea = this.elements.gameArea;
                gameArea.innerHTML = '';
                
                // Create results container
                const resultsContainer = document.createElement('div');
                resultsContainer.className = 'quiz-container';
                
                // Create results title
                const resultsTitle = document.createElement('h2');
                resultsTitle.className = 'quiz-question';
                resultsTitle.textContent = 'Quiz Results';
                resultsContainer.appendChild(resultsTitle);
                
                // Create score display
                const scoreDisplay = document.createElement('div');
                scoreDisplay.className = 'problem-display';
                scoreDisplay.textContent = `You got ${this.quizState.score} out of ${this.quizState.questions.length} correct!`;
                resultsContainer.appendChild(scoreDisplay);
                
                // Calculate percentage
                const percentage = Math.round((this.quizState.score / this.quizState.questions.length) * 100);
                
                // Create feedback message based on score
                const feedbackMessage = document.createElement('div');
                feedbackMessage.className = 'feedback-message';
                
                if (percentage >= 90) {
                    feedbackMessage.textContent = 'Amazing! Youre a division master!';
                    feedbackMessage.classList.add('feedback-correct');
                    this.unlockAchievement('quizAce');
                } else if (percentage >= 70) {
                    feedbackMessage.textContent = 'Great job! Youre getting really good at division!';
                    feedbackMessage.classList.add('feedback-correct');
                } else if (percentage >= 50) {
                    feedbackMessage.textContent = 'Good effort! Keep practicing to improve your division skills.';
                } else {
                    feedbackMessage.textContent = 'Keep trying! With more practice, youll get better at division.';
                }
                
                resultsContainer.appendChild(feedbackMessage);
                
                // Create buttons
                const buttonContainer = document.createElement('div');
                buttonContainer.style.display = 'flex';
                buttonContainer.style.justifyContent = 'center';
                buttonContainer.style.gap = '20px';
                buttonContainer.style.marginTop = '20px';
                
                const tryAgainButton = document.createElement('button');
                tryAgainButton.className = 'submit-button';
                tryAgainButton.textContent = 'Try Again';
                tryAgainButton.addEventListener('click', () => {
                    // Reset quiz state
                    this.quizState = null;
                    this.startQuizMode();
                });
                
                const nextLevelButton = document.createElement('button');
                nextLevelButton.className = 'submit-button';
                nextLevelButton.textContent = 'Next Level';
                nextLevelButton.addEventListener('click', () => {
                    // Increase level and reset quiz state
                    this.level++;
                    this.elements.levelDisplay.textContent = this.level;
                    this.quizState = null;
                    this.updateDifficultyForLevel();
                    this.startQuizMode();
                });
                
                buttonContainer.appendChild(tryAgainButton);
                
                // Only show next level button if score is good enough
                if (percentage >= 60) {
                    buttonContainer.appendChild(nextLevelButton);
                }
                
                resultsContainer.appendChild(buttonContainer);
                
                // Update score
                this.updateScore(this.quizState.score);
                
                gameArea.appendChild(resultsContainer);
            }
            
            // Start Challenge Mode
            startChallengeMode() {
                const gameArea = this.elements.gameArea;
                gameArea.innerHTML = '';
                
                // Initialize challenge state
                if (!this.challengeState) {
                    this.challengeState = {
                        problems: [],
                        currentProblemIndex: 0,
                        startTime: Date.now(),
                        timeLimit: this.settings.timeLimit || 60, // Default 60 seconds if not set
                        score: 0
                    };
                    
                    // Generate 10 division problems
                    for (let i = 0; i < 10; i++) {
                        this.challengeState.problems.push(this.generateDivisionProblem());
                    }
                }
                
                // Get current problem
                const currentProblem = this.challengeState.problems[this.challengeState.currentProblemIndex];
                
                // Create challenge container
                const challengeContainer = document.createElement('div');
                challengeContainer.className = 'quiz-container';
                
                // Create timer if time limit is set
                if (this.challengeState.timeLimit > 0) {
                    const timerContainer = document.createElement('div');
                    timerContainer.className = 'progress-bar-container';
                    timerContainer.style.height = '20px';
                    
                    const timerBar = document.createElement('div');
                    timerBar.className = 'progress-bar';
                    timerBar.id = 'timer-bar';
                    timerBar.style.width = '100%';
                    timerBar.style.backgroundColor = 'var(--tertiary-color)';
                    
                    timerContainer.appendChild(timerBar);
                    challengeContainer.appendChild(timerContainer);
                    
                    // Start timer
                    this.startChallengeTimer();
                }
                
                // Create progress indicator
                const progressIndicator = document.createElement('div');
                progressIndicator.className = 'quiz-question';
                progressIndicator.textContent = `Problem ${this.challengeState.currentProblemIndex + 1} of ${this.challengeState.problems.length}`;
                challengeContainer.appendChild(progressIndicator);
                
                // Create problem display
                const problemDisplay = document.createElement('div');
                problemDisplay.className = 'problem-display';
                problemDisplay.style.fontSize = '2.5em';
                problemDisplay.textContent = `${currentProblem.dividend} ÷ ${currentProblem.divisor} = ?`;
                challengeContainer.appendChild(problemDisplay);
                
                // Create input container
                const inputContainer = document.createElement('div');
                inputContainer.className = 'input-container';
                
                // Create answer input
                const answerInput = document.createElement('input');
                answerInput.className = 'answer-input';
                answerInput.type = 'number';
                answerInput.placeholder = 'Answer';
                answerInput.min = '0';
                answerInput.max = '999';
                answerInput.step = '1';
                
                // Create remainder input if allowed
                let remainderInput;
                if (this.settings.allowRemainders) {
                    remainderInput = document.createElement('input');
                    remainderInput.className = 'answer-input';
                    remainderInput.type = 'number';
                    remainderInput.placeholder = 'Remainder';
                    remainderInput.min = '0';
                    remainderInput.max = '999';
                    remainderInput.step = '1';
                    remainderInput.style.marginLeft = '10px';
                }
                
                // Create input label container
                const inputLabelContainer = document.createElement('div');
                inputLabelContainer.style.display = 'flex';
                inputLabelContainer.style.alignItems = 'center';
                inputLabelContainer.style.justifyContent = 'center';
                inputLabelContainer.style.gap = '10px';
                inputLabelContainer.style.marginBottom = '15px';
                
                const answerLabel = document.createElement('label');
                answerLabel.textContent = 'Answer:';
                answerLabel.style.fontWeight = 'bold';
                
                inputLabelContainer.appendChild(answerLabel);
                inputLabelContainer.appendChild(answerInput);
                
                if (this.settings.allowRemainders) {
                    const remainderLabel = document.createElement('label');
                    remainderLabel.textContent = 'Remainder:';
                    remainderLabel.style.fontWeight = 'bold';
                    
                    inputLabelContainer.appendChild(remainderLabel);
                    inputLabelContainer.appendChild(remainderInput);
                }
                
                inputContainer.appendChild(inputLabelContainer);
                
                // Create submit button
                const submitButton = document.createElement('button');
                submitButton.className = 'submit-button';
                submitButton.textContent = 'Submit';
                
                inputContainer.appendChild(submitButton);
                
                // Create feedback message
                const feedbackMessage = document.createElement('div');
                feedbackMessage.className = 'feedback-message';
                inputContainer.appendChild(feedbackMessage);
                
                challengeContainer.appendChild(inputContainer);
                
                gameArea.appendChild(challengeContainer);
                
                // Focus on answer input
                answerInput.focus();
                
                // Submit answer on enter key
                answerInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        submitButton.click();
                    }
                });
                
                if (remainderInput) {
                    remainderInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            submitButton.click();
                        }
                    });
                }
                
                // Handle submit button click
                submitButton.addEventListener('click', () => {
                    const userAnswer = parseInt(answerInput.value);
                    const userRemainder = remainderInput ? parseInt(remainderInput.value) || 0 : 0;
                    
                    let isCorrect = false;
                    
                    if (!isNaN(userAnswer)) {
                        if (this.settings.allowRemainders) {
                            isCorrect = userAnswer === currentProblem.quotient && userRemainder === currentProblem.remainder;
                        } else {
                            isCorrect = userAnswer === currentProblem.quotient;
                        }
                    }
                    
                    if (isCorrect) {
                        feedbackMessage.textContent = 'Correct!';
                        feedbackMessage.className = 'feedback-message feedback-correct';
                        this.challengeState.score++;
                        this.correctAnswers++;
                    } else {
                        feedbackMessage.textContent = `The answer is ${currentProblem.quotient}${currentProblem.remainder > 0 ? ` R${currentProblem.remainder}` : ''}.`;
                        feedbackMessage.className = 'feedback-message feedback-incorrect';
                    }
                    
                    // Disable input and button
                    answerInput.disabled = true;
                    if (remainderInput) remainderInput.disabled = true;
                    submitButton.disabled = true;
                    
                    // Move to next problem after delay
                    setTimeout(() => {
                        this.challengeState.currentProblemIndex++;
                        this.questionsAnswered++;
                        
                        // If there are more problems, show the next one
                        if (this.challengeState.currentProblemIndex < this.challengeState.problems.length) {
                            this.startChallengeMode();
                        } else {
// Challenge complete
this.completeChallenge();
                        }
                    }, 1500);
                });
            }
            
            // Start challenge timer
            startChallengeTimer() {
                if (!this.challengeState || this.challengeState.timeLimit <= 0) return;
                
                const timerBar = document.getElementById('timer-bar');
                if (!timerBar) return;
                
                const startTime = this.challengeState.startTime;
                const timeLimit = this.challengeState.timeLimit * 1000; // Convert to milliseconds
                
                const updateTimer = () => {
                    const elapsedTime = Date.now() - startTime;
                    const remainingPercentage = Math.max(0, 100 - (elapsedTime / timeLimit) * 100);
                    
                    timerBar.style.width = `${remainingPercentage}%`;
                    
                    // Change color as time runs low
                    if (remainingPercentage < 25) {
                        timerBar.style.backgroundColor = 'var(--warning-color)';
                    } else if (remainingPercentage < 50) {
                        timerBar.style.backgroundColor = 'var(--tertiary-color)';
                    }
                    
                    // Check if time is up
                    if (elapsedTime >= timeLimit) {
                        this.completeChallenge();
                    } else if (this.currentMode === 'challenge') {
                        // Continue timer if still in challenge mode
                        requestAnimationFrame(updateTimer);
                    }
                };
                
                requestAnimationFrame(updateTimer);
            }
            
            // Complete Challenge
            completeChallenge() {
                const gameArea = this.elements.gameArea;
                gameArea.innerHTML = '';
                
                // Create results container
                const resultsContainer = document.createElement('div');
                resultsContainer.className = 'quiz-container';
                
                // Create results title
                const resultsTitle = document.createElement('h2');
                resultsTitle.className = 'quiz-question';
                resultsTitle.textContent = 'Challenge Results';
                resultsContainer.appendChild(resultsTitle);
                
                // Calculate time taken
                const timeTaken = (Date.now() - this.challengeState.startTime) / 1000; // in seconds
                
                // Create score display
                const scoreDisplay = document.createElement('div');
                scoreDisplay.className = 'problem-display';
                scoreDisplay.textContent = `You solved ${this.challengeState.score} out of ${this.challengeState.problems.length} problems!`;
                resultsContainer.appendChild(scoreDisplay);
                
                // Create time display
                const timeDisplay = document.createElement('div');
                timeDisplay.className = 'feedback-message';
                timeDisplay.textContent = `Time: ${timeTaken.toFixed(1)} seconds`;
                resultsContainer.appendChild(timeDisplay);
                
                // Calculate points
                const basePoints = this.challengeState.score * 10;
                const timeBonus = this.challengeState.timeLimit > 0 ? 
                    Math.max(0, Math.floor((this.challengeState.timeLimit - timeTaken) / 5) * 5) : 0;
                
                const totalPoints = basePoints + timeBonus;
                
                // Display points breakdown
                const pointsDisplay = document.createElement('div');
                pointsDisplay.className = 'feedback-message';
                pointsDisplay.innerHTML = `
                    <strong>Points:</strong><br>
                    Correct Answers: ${basePoints} points<br>
                    Time Bonus: ${timeBonus} points<br>
                    <span style="font-size: 1.2em; font-weight: bold;">Total: ${totalPoints} points</span>
                `;
                resultsContainer.appendChild(pointsDisplay);
                
                // Create feedback message based on score
                const feedbackMessage = document.createElement('div');
                feedbackMessage.className = 'feedback-message';
                
                const percentage = (this.challengeState.score / this.challengeState.problems.length) * 100;
                
                if (percentage >= 90) {
                    feedbackMessage.textContent = 'Amazing! Youre a division master!';
                    feedbackMessage.classList.add('feedback-correct');
                    this.unlockAchievement('speedyAnswer');
                } else if (percentage >= 70) {
                    feedbackMessage.textContent = 'Great job! Youre getting really good at division!';
                    feedbackMessage.classList.add('feedback-correct');
                } else if (percentage >= 50) {
                    feedbackMessage.textContent = 'Good effort! Keep practicing to improve your division skills.';
                } else {
                    feedbackMessage.textContent = 'Keep trying! With more practice, youll get better at division.';
                }
                
                resultsContainer.appendChild(feedbackMessage);
                
                // Create buttons
                const buttonContainer = document.createElement('div');
                buttonContainer.style.display = 'flex';
                buttonContainer.style.justifyContent = 'center';
                buttonContainer.style.gap = '20px';
                buttonContainer.style.marginTop = '20px';
                
                const tryAgainButton = document.createElement('button');
                tryAgainButton.className = 'submit-button';
                tryAgainButton.textContent = 'Try Again';
                tryAgainButton.addEventListener('click', () => {
                    // Reset challenge state
                    this.challengeState = null;
                    this.startChallengeMode();
                });
                
                const nextLevelButton = document.createElement('button');
                nextLevelButton.className = 'submit-button';
                nextLevelButton.textContent = 'Next Level';
                nextLevelButton.addEventListener('click', () => {
                    // Increase level and reset challenge state
                    this.level++;
                    this.elements.levelDisplay.textContent = this.level;
                    this.challengeState = null;
                    this.updateDifficultyForLevel();
                    this.startChallengeMode();
                });
                
                buttonContainer.appendChild(tryAgainButton);
                
                // Only show next level button if score is good enough
                if (percentage >= 60) {
                    buttonContainer.appendChild(nextLevelButton);
                }
                
                resultsContainer.appendChild(buttonContainer);
                
                // Update score
                this.updateScore(totalPoints);
                
                gameArea.appendChild(resultsContainer);
            }
        }

        // Character SVG Data
        const characterSVGs = {
            professor: `
                <svg class="character-svg animate-float" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                    <!-- Head -->
                    <circle cx="100" cy="70" r="50" fill="#FFD8B6" />
                    <!-- Hair -->
                    <path d="M60 40 Q100 10 140 40 L140 60 Q100 90 60 60 Z" fill="#808080" />
                    <!-- Glasses -->
                    <circle cx="80" cy="65" r="15" fill="none" stroke="#333" stroke-width="3" />
                    <circle cx="120" cy="65" r="15" fill="none" stroke="#333" stroke-width="3" />
                    <line x1="95" y1="65" x2="105" y2="65" stroke="#333" stroke-width="3" />
                    <line x1="65" y1="65" x2="55" y2="60" stroke="#333" stroke-width="3" />
                    <line x1="135" y1="65" x2="145" y2="60" stroke="#333" stroke-width="3" />
                    <!-- Eyes -->
                    <circle cx="80" cy="65" r="5" fill="#333" />
                    <circle cx="120" cy="65" r="5" fill="#333" />
                    <!-- Smile -->
                    <path d="M75 85 Q100 100 125 85" fill="none" stroke="#333" stroke-width="3" stroke-linecap="round" />
                    <!-- Body -->
                    <rect x="75" y="120" width="50" height="60" fill="#8f94fb" rx="5" />
                    <rect x="65" y="120" width="10" height="50" fill="#FFD8B6" rx="5" />
                    <rect x="125" y="120" width="10" height="50" fill="#FFD8B6" rx="5" />
                    <!-- Bowtie -->
                    <path d="M90 125 L110 125 L100 135 Z" fill="#ff6b6b" />
                    <path d="M90 125 L110 125 L100 115 Z" fill="#ff6b6b" />
                </svg>
            `,
            robot: `
                <svg class="character-svg animate-float" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                    <!-- Head -->
                    <rect x="60" y="30" width="80" height="70" fill="#CCC" rx="10" />
                    <!-- Antenna -->
                    <line x1="100" y1="30" x2="100" y2="15" stroke="#333" stroke-width="3" />
                    <circle cx="100" cy="10" r="5" fill="#ff6b6b" />
                    <!-- Eyes -->
                    <circle cx="80" cy="55" r="10" fill="#4e54c8" />
                    <circle cx="120" cy="55" r="10" fill="#4e54c8" />
                    <circle cx="80" cy="55" r="5" fill="white" />
                    <circle cx="120" cy="55" r="5" fill="white" />
                    <!-- Mouth -->
                    <rect x="75" y="80" width="50" height="5" fill="#333" rx="2" />
                    <!-- Body -->
                    <rect x="70" y="100" width="60" height="70" fill="#8338ec" rx="5" />
                    <!-- Arms -->
                    <rect x="45" y="110" width="25" height="10" fill="#CCC" rx="5" />
                    <rect x="130" y="110" width="25" height="10" fill="#CCC" rx="5" />
                    <!-- Control panel -->
                    <rect x="85" y="115" width="30" height="20" fill="#EEE" rx="2" />
                    <circle cx="95" cy="125" r="3" fill="#ff6b6b" />
                    <circle cx="105" cy="125" r="3" fill="#06d6a0" />
                </svg>
            `,
            wizard: `
                <svg class="character-svg animate-float" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                    <!-- Hat -->
                    <path d="M50 70 L100 20 L150 70 Z" fill="#4e54c8" />
                    <path d="M60 70 L140 70 Q130 60 100 60 Q70 60 60 70 Z" fill="#4e54c8" />
                    <!-- Face -->
                    <circle cx="100" cy="90" r="30" fill="#FFD8B6" />
                    <!-- Beard -->
                    <path d="M70 90 Q100 150 130 90" fill="white" />
                    <!-- Eyes -->
                    <circle cx="85" cy="85" r="5" fill="#333" />
                    <circle cx="115" cy="85" r="5" fill="#333" />
                    <!-- Smile -->
                    <path d="M90 95 Q100 105 110 95" fill="none" stroke="#333" stroke-width="2" />
                    <!-- Body/Robe -->
                    <path d="M70 120 Q100 110 130 120 L130 180 L70 180 Z" fill="#8338ec" />
                    <!-- Stars on robe -->
                    <polygon points="85,140 87,145 93,145 88,150 90,155 85,152 80,155 82,150 77,145 83,145" fill="#ffd166" />
                    <polygon points="110,150 112,155 118,155 113,160 115,165 110,162 105,165 107,160 102,155 108,155" fill="#ffd166" />
                    <polygon points="95,165 97,170 103,170 98,175 100,180 95,177 90,180 92,175 87,170 93,170" fill="#ffd166" />
                </svg>
            `
        };

        // Initialize the game when the document is loaded
        document.addEventListener('DOMContentLoaded', () => {
            // Create and initialize the game
            window.divisionGame = new DivisionAdventure();
        });
    </script>
</body>
</html>