<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Element Explorer: Chemistry Adventure</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap');
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Nunito', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden;
            color: #333;
        }
        
        #gameContainer {
            width: 95%;
            max-width: 1200px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin: 20px 0;
            overflow: hidden;
            position: relative;
            transition: all 0.3s ease;
        }
        
        header {
            background: linear-gradient(to right, #3a7bd5, #00d2ff);
            padding: 20px;
            text-align: center;
            color: white;
            position: relative;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        #mainMenuContainer, 
        #gameplayContainer, 
        #periodicTableContainer,
        #buildMoleculesContainer,
        #experimentLabContainer,
        #quizContainer,
        #reactionSimulatorContainer,
        #settingsContainer,
        #storyContainer {
            padding: 20px;
            display: none;
        }
        
        #mainMenuContainer {
            display: block;
            text-align: center;
            padding: 40px 20px;
        }
        
        .menu-button {
            background: linear-gradient(to right, #4facfe, #00f2fe);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 15px 30px;
            margin: 15px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            width: 300px;
            max-width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .menu-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }
        
        .menu-button:active {
            transform: translateY(1px);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .menu-button i {
            margin-right: 10px;
            font-size: 1.3rem;
        }
        
        .back-button {
            background: linear-gradient(to right, #ff9966, #ff5e62);
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 10px 20px;
            border: none;
            border-radius: 30px;
            color: white;
            cursor: pointer;
            font-weight: bold;
            z-index: 10;
            display: flex;
            align-items: center;
        }
        
        .back-button i {
            margin-right: 5px;
        }
        
        #characterContainer {
            position: fixed;
            bottom: 10px;
            right: 10px;
            width: 180px;
            height: 180px;
            z-index: 100;
        }
        
        #character {
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        #characterSpeech {
            position: absolute;
            top: -80px;
            left: -200px;
            background: white;
            border-radius: 15px;
            padding: 15px;
            width: 250px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            font-size: 14px;
            display: none;
            z-index: 101;
        }
        
        #characterSpeech:after {
            content: '';
            position: absolute;
            bottom: 15px;
            right: -10px;
            width: 20px;
            height: 20px;
            background: white;
            transform: rotate(45deg);
            box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.1);
        }
        
        /* Periodic Table Styles */
        #periodicTableGrid {
            display: grid;
            grid-template-columns: repeat(18, 1fr);
            gap: 3px;
            max-width: 100%;
            margin: 0 auto;
            perspective: 1000px;
        }
        
        .element {
            background-color: #f0f0f0;
            border-radius: 5px;
            padding: 5px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            aspect-ratio: 1/1;
            position: relative;
            transform-style: preserve-3d;
        }
        
        .element.highlight {
            animation: pulse 1.5s infinite;
            z-index: 10;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 5px 2px rgba(0, 255, 255, 0.5); }
            50% { box-shadow: 0 0 20px 5px rgba(0, 255, 255, 0.8); }
            100% { box-shadow: 0 0 5px 2px rgba(0, 255, 255, 0.5); }
        }
        
        .element:hover {
            transform: translateZ(20px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            z-index: 20;
        }
        
        .element .symbol {
            font-size: 1.2em;
            font-weight: bold;
        }
        
        .element .number {
            font-size: 0.7em;
            position: absolute;
            top: 2px;
            left: 5px;
        }
        
        .element .name {
            font-size: 0.6em;
            margin-top: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 100%;
        }
        
        /* Element category colors */
        .alkali-metal { background-color: #ffafaf; }
        .alkaline-earth { background-color: #ffddbf; }
        .transition-metal { background-color: #fff1bf; }
        .post-transition { background-color: #c8ffbf; }
        .metalloid { background-color: #bffffd; }
        .nonmetal { background-color: #bfcfff; }
        .halogen { background-color: #debfff; }
        .noble-gas { background-color: #ffbfe7; }
        .lanthanide { background-color: #ebebeb; }
        .actinide { background-color: #d1d1d1; }
        
        /* Element detail panel */
        #elementDetails {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: white;
            border-radius: 15px;
            padding: 20px;
            width: 80%;
            max-width: 600px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        #elementDetails.show {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }
        
        #elementDetails h2 {
            font-size: 2rem;
            margin-bottom: 10px;
            text-align: center;
        }
        
        #atomVisualizer {
            width: 300px;
            height: 300px;
            margin: 20px auto;
            position: relative;
        }
        
        .electron-shell {
            position: absolute;
            top: 50%;
            left: 50%;
            border: 1px solid rgba(0, 0, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }
        
        .electron {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #3498db;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: orbit linear infinite;
        }
        
        .nucleus {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50px;
            height: 50px;
            background: radial-gradient(circle, #e74c3c 60%, #c0392b);
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(231, 76, 60, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
            z-index: 10;
        }
        
        @keyframes orbit {
            from { transform: translate(-50%, -50%) rotate(0deg) translateX(var(--radius)) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg) translateX(var(--radius)) rotate(-360deg); }
        }
        
        #elementInfo {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            width: 100%;
            margin-top: 20px;
        }
        
        .info-item {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
        }
        
        .info-item h4 {
            margin-bottom: 5px;
            color: #666;
            font-size: 0.9rem;
        }
        
        .info-item p {
            font-size: 1.1rem;
            font-weight: bold;
        }
        
        #closeDetails {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }
        
        /* Molecule Builder Styles */
        #moleculeCanvas {
            border: 1px solid #ddd;
            border-radius: 10px;
            margin: 20px auto;
            background-color: #f9f9f9;
            display: block;
        }
        
        #moleculePalette {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .palette-element {
            padding: 10px 15px;
            background: linear-gradient(to bottom, #f7f7f7, #e7e7e7);
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            font-weight: bold;
        }
        
        .palette-element:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.15);
        }
        
        .palette-element:active {
            transform: translateY(0);
        }
        
        #moleculeControls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
        }
        
        .molecule-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 30px;
            background: linear-gradient(to right, #4facfe, #00f2fe);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .molecule-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.1);
        }
        
        #moleculesGallery {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        .gallery-item {
            padding: 10px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            width: 120px;
        }
        
        .gallery-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.15);
        }
        
        .gallery-item img {
            width: 80px;
            height: 80px;
            object-fit: contain;
            margin-bottom: 5px;
        }
        
        /* Quiz Styles */
        #quizContent {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        #questionContainer {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        #questionText {
            font-size: 1.3rem;
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        #answerOptions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        @media (max-width: 600px) {
            #answerOptions {
                grid-template-columns: 1fr;
            }
        }
        
        .answer-option {
            background: linear-gradient(to right, #f8f9fa, #e9ecef);
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.1rem;
        }
        
        .answer-option:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.05);
            border-color: #4facfe;
        }
        
        .answer-option.selected {
            background: linear-gradient(to right, #4facfe, #00f2fe);
            color: white;
            border-color: transparent;
        }
        
        .answer-option.correct {
            background: linear-gradient(to right, #67e26f, #00b09b);
            color: white;
            border-color: transparent;
        }
        
        .answer-option.incorrect {
            background: linear-gradient(to right, #ff6b6b, #ff8787);
            color: white;
            border-color: transparent;
        }
        
        #quizControls {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        #submitAnswer, #nextQuestion {
            padding: 12px 25px;
            border: none;
            border-radius: 30px;
            background: linear-gradient(to right, #4facfe, #00f2fe);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        #submitAnswer:hover, #nextQuestion:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        #nextQuestion {
            display: none;
            background: linear-gradient(to right, #67e26f, #00b09b);
        }
        
        #feedbackMessage {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            font-size: 1.1rem;
            text-align: center;
            display: none;
        }
        
        #quizProgress {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        #progressBar {
            flex-grow: 1;
            height: 10px;
            background: #e9ecef;
            border-radius: 5px;
            margin: 0 15px;
            overflow: hidden;
        }
        
        #progressFill {
            height: 100%;
            background: linear-gradient(to right, #4facfe, #00f2fe);
            width: 0%;
            transition: width 0.5s;
        }
        
        #scoreDisplay {
            font-weight: bold;
            font-size: 1.2rem;
            color: #4facfe;
        }
        
        /* Reaction Simulator Styles */
        #reactionCanvas {
            border: 1px solid #ddd;
            border-radius: 10px;
            margin: 20px auto;
            background-color: #f9f9f9;
            display: block;
        }
        
        #reactionControls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }
        
        .reaction-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 30px;
            background: linear-gradient(to right, #4facfe, #00f2fe);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .reaction-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.1);
        }
        
        #reactionSelector {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .reaction-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            width: 200px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .reaction-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        .reaction-card h4 {
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .reaction-card p {
            font-size: 0.9rem;
            color: #666;
        }
        
        /* Settings Panel Styles */
        #settingsPanel {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            margin: 0 auto;
        }
        
        .settings-group {
            margin-bottom: 30px;
        }
        
        .settings-group h3 {
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #f0f0f0;
            color: #333;
        }
        
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .setting-label {
            font-weight: bold;
            color: #555;
        }
        
        .setting-control {
            display: flex;
            align-items: center;
        }
        
        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #4facfe;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        /* Range slider */
        .range-slider {
            -webkit-appearance: none;
            width: 200px;
            height: 8px;
            border-radius: 5px;
            background: #d7dcdf;
            outline: none;
        }
        
        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4facfe;
            cursor: pointer;
        }
        
        .range-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4facfe;
            cursor: pointer;
        }
        
        .slider-value {
            width: 40px;
            text-align: center;
            margin-left: 10px;
        }
        
        /* Select dropdown */
        .select-dropdown {
            padding: 8px 12px;
            border-radius: 5px;
            border: 1px solid #ddd;
            background-color: white;
            cursor: pointer;
            min-width: 150px;
        }
        
        #saveSettings {
            background: linear-gradient(to right, #4facfe, #00f2fe);
            color: white;
            border: none;
            border-radius: 30px;
            padding: 12px 25px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            display: block;
            margin: 20px auto 0;
        }
        
        #saveSettings:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        /* Story Mode Styles */
        #storyContent {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        #storyScene {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            position: relative;
            min-height: 300px;
        }
        
        #sceneImage {
            width: 100%;
            height: 200px;
            background-position: center;
            background-size: cover;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        #sceneText {
            font-size: 1.2rem;
            line-height: 1.6;
            margin-bottom: 30px;
        }
        
        #choiceContainer {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .story-choice {
            background: linear-gradient(to right, #f8f9fa, #e9ecef);
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.1rem;
        }
        
        .story-choice:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.05);
            border-color: #4facfe;
        }
        
        /* Animations for gameplay */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideInUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Celebration effects */
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #f00;
            border-radius: 50%;
            animation: confettiFall 4s ease-out;
            z-index: 1000;
        }
        
        @keyframes confettiFall {
            0% {
                transform: translateY(-10vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }
        
        /* Overlay for modals */
        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }
        
        /* Modal for achievements and notifications */
        #notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            transform: translateX(150%);
            transition: transform 0.5s;
            z-index: 1000;
            display: flex;
            align-items: center;
        }
        
        #notification.show {
            transform: translateX(0);
        }
        
        #notification-icon {
            margin-right: 15px;
            width: 40px;
            height: 40px;
            background: linear-gradient(to right, #4facfe, #00f2fe);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.5rem;
        }
        
        #notification-text {
            font-weight: bold;
        }
        
        /* Loading screen */
        #loadingScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        #loadingMessage {
            margin-top: 20px;
            font-size: 1.5rem;
            color: white;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.2);
        }
        
        .spinner {
            width: 70px;
            height: 70px;
            border: 8px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: rotate 1s infinite linear;
        }
        
        /* Experiment Lab Styles */
        #experimentCanvas {
            border: 1px solid #ddd;
            border-radius: 10px;
            margin: 20px auto;
            background-color: #f9f9f9;
            display: block;
        }
        
        #labEquipment {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .equipment-item {
            background: white;
            border-radius: 10px;
            padding: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            width: 80px;
            height: 80px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .equipment-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.15);
        }
        
        #chemicalShelf {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .chemical-item {
            background: linear-gradient(to bottom, #f7f7f7, #e7e7e7);
            border-radius: 5px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            font-size: 0.9rem;
        }
        
        .chemical-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.15);
        }
        
        #experimentControls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
        }
        
        .experiment-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 30px;
            background: linear-gradient(to right, #4facfe, #00f2fe);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .experiment-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.1);
        }
        
        #experimentLog {
            background: white;
            border-radius: 10px;
            padding: 15px;
            max-height: 150px;
            overflow-y: auto;
            margin-top: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .log-entry {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.9rem;
        }
        
        /* Media queries for responsiveness */
        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }
            
            .menu-button {
                width: 250px;
                padding: 12px 25px;
                font-size: 1rem;
            }
            
            #periodicTableGrid {
                gap: 2px;
            }
            
            .element .symbol {
                font-size: 1em;
            }
            
            .element .number, .element .name {
                font-size: 0.6em;
            }
            
            #elementDetails {
                width: 95%;
                padding: 15px;
            }
            
            #atomVisualizer {
                width: 250px;
                height: 250px;
            }
            
            #elementInfo {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 480px) {
            h1 {
                font-size: 1.5rem;
            }
            
            .menu-button {
                width: 100%;
                max-width: 300px;
                margin: 10px;
            }
            
            #periodicTableGrid {
                grid-template-columns: repeat(9, 1fr);
            }
            
            .element .symbol {
                font-size: 0.85em;
            }
            
            .element .number {
                font-size: 0.5em;
            }
            
            .element .name {
                display: none;
            }
            
            #atomVisualizer {
                width: 200px;
                height: 200px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen">
        <div class="spinner"></div>
        <div id="loadingMessage">Loading Element Explorer...</div>
    </div>
    
    <!-- Game Container -->
    <div id="gameContainer">
        <header>
            <h1>Element Explorer: Chemistry Adventure</h1>
            <p>Discover the amazing world of atoms and molecules!</p>
        </header>
        
        <!-- Main Menu -->
        <div id="mainMenuContainer">
            <button class="menu-button" onclick="startPeriodicTable()">
                <i>üîç</i> Explore Periodic Table
            </button>
            <button class="menu-button" onclick="startBuildMolecules()">
                <i>üß™</i> Build Molecules
            </button>
            <button class="menu-button" onclick="startExperimentLab()">
                <i>üî¨</i> Experiment Lab
            </button>
            <button class="menu-button" onclick="startQuiz()">
                <i>‚ùì</i> Element Quiz
            </button>
            <button class="menu-button" onclick="startReactionSimulator()">
                <i>‚ö°</i> Reaction Simulator
            </button>
            <button class="menu-button" onclick="startStoryMode()">
                <i>üìñ</i> Story Adventure
            </button>
            <button class="menu-button" onclick="openSettings()">
                <i>‚öôÔ∏è</i> Settings
            </button>
        </div>
        
        <!-- Periodic Table Container -->
        <div id="periodicTableContainer">
            <button class="back-button" onclick="goToMainMenu()">
                <i>‚Üê</i> Back
            </button>
            <h2 style="text-align: center; margin-bottom: 20px;">The Periodic Table of Elements</h2>
            <div id="periodicTableGrid"></div>
            
            <!-- Element Details Panel -->
            <div id="elementDetails">
                <button id="closeDetails">√ó</button>
                <h2 id="detailsTitle">Element Name</h2>
                <div id="atomVisualizer">
                    <div class="nucleus">0</div>
                    <!-- Electron shells will be added dynamically -->
                </div>
                <div id="elementInfo">
                    <!-- Element info will be added dynamically -->
                </div>
            </div>
        </div>
        
        <!-- Build Molecules Container -->
        <div id="buildMoleculesContainer">
            <button class="back-button" onclick="goToMainMenu()">
                <i>‚Üê</i> Back
            </button>
            <h2 style="text-align: center; margin-bottom: 20px;">Molecule Builder</h2>
            <div id="moleculePalette">
                <!-- Elements will be added dynamically -->
            </div>
            <canvas id="moleculeCanvas" width="600" height="400"></canvas>
            <div id="moleculeControls">
                <button class="molecule-btn" id="clearMolecule">Clear</button>
                <button class="molecule-btn" id="saveMolecule">Save</button>
            </div>
            <h3 style="text-align: center; margin: 30px 0 10px;">Molecule Gallery</h3>
            <div id="moleculesGallery">
                <!-- Saved and preset molecules will appear here -->
            </div>
        </div>
        
        <!-- Experiment Lab Container -->
        <div id="experimentLabContainer">
            <button class="back-button" onclick="goToMainMenu()">
                <i>‚Üê</i> Back
            </button>
            <h2 style="text-align: center; margin-bottom: 20px;">Chemistry Lab</h2>
            <div id="labEquipment">
                <!-- Lab equipment will be added dynamically -->
            </div>
            <div id="chemicalShelf">
                <!-- Chemicals will be added dynamically -->
            </div>
            <canvas id="experimentCanvas" width="600" height="400"></canvas>
            <div id="experimentControls">
                <button class="experiment-btn" id="startExperiment">Start Experiment</button>
                <button class="experiment-btn" id="resetExperiment">Reset</button>
            </div>
            <div id="experimentLog">
                <div class="log-entry">Welcome to the Chemistry Lab! Select equipment and chemicals to begin.</div>
            </div>
        </div>
        
        <!-- Quiz Container -->
        <div id="quizContainer">
            <button class="back-button" onclick="goToMainMenu()">
                <i>‚Üê</i> Back
            </button>
            <div id="quizContent">
                <div id="quizProgress">
                    <span>Question <span id="currentQuestion">1</span>/<span id="totalQuestions">10</span></span>
                    <div id="progressBar">
                        <div id="progressFill"></div>
                    </div>
                    <span id="scoreDisplay">Score: 0</span>
                </div>
                <div id="questionContainer">
                    <h3 id="questionText">What is the chemical symbol for Hydrogen?</h3>
                    <div id="answerOptions">
                        <!-- Answer options will be added dynamically -->
                    </div>
                </div>
                <div id="feedbackMessage"></div>
                <div id="quizControls">
                    <button id="submitAnswer">Submit Answer</button>
                    <button id="nextQuestion">Next Question</button>
                </div>
            </div>
        </div>
        
        <!-- Reaction Simulator Container -->
        <div id="reactionSimulatorContainer">
            <button class="back-button" onclick="goToMainMenu()">
                <i>‚Üê</i> Back
            </button>
            <h2 style="text-align: center; margin-bottom: 20px;">Chemical Reactions</h2>
            <div id="reactionSelector">
                <!-- Reaction options will be added dynamically -->
            </div>
            <canvas id="reactionCanvas" width="600" height="400"></canvas>
            <div id="reactionControls">
                <button class="reaction-btn" id="startReaction">Start Reaction</button>
                <button class="reaction-btn" id="slowDownReaction">Slow Down</button>
                <button class="reaction-btn" id="speedUpReaction">Speed Up</button>
                <button class="reaction-btn" id="resetReaction">Reset</button>
            </div>
        </div>
        
        <!-- Settings Container -->
        <div id="settingsContainer">
            <button class="back-button" onclick="goToMainMenu()">
                <i>‚Üê</i> Back
            </button>
            <h2 style="text-align: center; margin-bottom: 20px;">Game Settings</h2>
            <div id="settingsPanel">
                <!-- Audio Settings -->
                <div class="settings-group">
                    <h3>Audio Settings</h3>
                    <div class="setting-item">
                        <span class="setting-label">Sound Effects</span>
                        <div class="setting-control">
                            <label class="toggle-switch">
                                <input type="checkbox" id="soundEffectsToggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">Background Music</span>
                        <div class="setting-control">
                            <label class="toggle-switch">
                                <input type="checkbox" id="backgroundMusicToggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">Volume</span>
                        <div class="setting-control">
                            <input type="range" min="0" max="100" value="70" class="range-slider" id="volumeSlider">
                            <span class="slider-value" id="volumeValue">70%</span>
                        </div>
                    </div>
                </div>
                
                <!-- Difficulty Settings -->
                <div class="settings-group">
                    <h3>Difficulty Settings</h3>
                    <div class="setting-item">
                        <span class="setting-label">Game Difficulty</span>
                        <div class="setting-control">
                            <select class="select-dropdown" id="difficultySelect">
                                <option value="easy">Easy (Age 5-7)</option>
                                <option value="medium">Medium (Age 8-10)</option>
                                <option value="hard">Hard (Age 11+)</option>
                                <option value="genius">Genius (Advanced)</option>
                            </select>
                        </div>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">Quiz Time Limit</span>
                        <div class="setting-control">
                            <input type="range" min="0" max="60" value="30" class="range-slider" id="quizTimerSlider">
                            <span class="slider-value" id="quizTimerValue">30s</span>
                        </div>
                    </div>
                </div>
                
                <!-- Display Settings -->
                <div class="settings-group">
                    <h3>Display Settings</h3>
                    <div class="setting-item">
                        <span class="setting-label">Show Helper Character</span>
                        <div class="setting-control">
                            <label class="toggle-switch">
                                <input type="checkbox" id="characterToggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">Text Size</span>
                        <div class="setting-control">
                            <select class="select-dropdown" id="textSizeSelect">
                                <option value="small">Small</option>
                                <option value="medium" selected>Medium</option>
                                <option value="large">Large</option>
                            </select>
                        </div>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">Color Theme</span>
                        <div class="setting-control">
                            <select class="select-dropdown" id="themeSelect">
                                <option value="default" selected>Default</option>
                                <option value="contrast">High Contrast</option>
                                <option value="dark">Dark Mode</option>
                                <option value="fun">Fun & Colorful</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Advanced Settings -->
                <div class="settings-group">
                    <h3>Learning Settings</h3>
                    <div class="setting-item">
                        <span class="setting-label">Show Advanced Concepts</span>
                        <div class="setting-control">
                            <label class="toggle-switch">
                                <input type="checkbox" id="advancedConceptsToggle">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">Learning Focus</span>
                        <div class="setting-control">
                            <select class="select-dropdown" id="learningFocusSelect">
                                <option value="basic">Basic Elements</option>
                                <option value="molecules">Molecules & Compounds</option>
                                <option value="reactions">Chemical Reactions</option>
                                <option value="all" selected>All Topics</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <button id="saveSettings">Save Settings</button>
            </div>
        </div>
        
        <!-- Story Mode Container -->
        <div id="storyContainer">
            <button class="back-button" onclick="goToMainMenu()">
                <i>‚Üê</i> Back
            </button>
            <div id="storyContent">
                <div id="storyScene">
                    <div id="sceneImage"></div>
                    <div id="sceneText"></div>
                    <div id="choiceContainer">
                        <!-- Choices will be added dynamically -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Character Helper -->
    <div id="characterContainer">
        <div id="character">
            <svg width="180" height="180" viewBox="0 0 200 200">
                <!-- Professor Atom character -->
                <circle cx="100" cy="100" r="35" fill="#4facfe" stroke="#333" stroke-width="2" />
                <circle cx="100" cy="100" r="60" fill="none" stroke="#333" stroke-width="1" stroke-dasharray="5,5" />
                <circle cx="100" cy="100" r="85" fill="none" stroke="#333" stroke-width="1" stroke-dasharray="5,5" />
                
                <!-- Electron animations -->
                <circle cx="100" cy="40" r="8" fill="#3498db">
                    <animateTransform
                        attributeName="transform"
                        type="rotate"
                        from="0 100 100"
                        to="360 100 100"
                        dur="3s"
                        repeatCount="indefinite" />
                </circle>
                
                <circle cx="160" cy="100" r="8" fill="#3498db">
                    <animateTransform
                        attributeName="transform"
                        type="rotate"
                        from="0 100 100"
                        to="360 100 100"
                        dur="5s"
                        repeatCount="indefinite" />
                </circle>
                
                <circle cx="100" cy="185" r="8" fill="#3498db">
                    <animateTransform
                        attributeName="transform"
                        type="rotate"
                        from="0 100 100"
                        to="360 100 100"
                        dur="7s"
                        repeatCount="indefinite" />
                </circle>
                
                <!-- Face features -->
                <circle cx="90" cy="90" r="5" fill="white" />
                <circle cx="110" cy="90" r="5" fill="white" />
                <circle cx="90" cy="90" r="2" fill="black" />
                <circle cx="110" cy="90" r="2" fill="black" />
                <path d="M85 110 Q100 125 115 110" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" />
                
                <!-- Glasses -->
                <circle cx="90" cy="90" r="10" fill="none" stroke="white" stroke-width="2" />
                <circle cx="110" cy="90" r="10" fill="none" stroke="white" stroke-width="2" />
                <line x1="100" y1="90" x2="100" y2="90" stroke="white" stroke-width="2" />
            </svg>
        </div>
        <div id="characterSpeech"></div>
    </div>
    
    <!-- Overlay for modals -->
    <div id="overlay"></div>
    
    <!-- Notification -->
    <div id="notification">
        <div id="notification-icon">üèÜ</div>
        <div id="notification-text">Achievement unlocked!</div>
    </div>

    <script>
        // Game state and settings
        const gameState = {
            sound: true,
            music: true,
            volume: 70,
            difficulty: 'easy',
            quizTimer: 30,
            showCharacter: true,
            textSize: 'medium',
            theme: 'default',
            advancedConcepts: false,
            learningFocus: 'all',
            discoveredElements: [],
            builtMolecules: [],
            completedExperiments: [],
            quizScore: 0,
            totalQuestions: 0,
            storyProgress: 0
        };
        
        // Audio context and sounds
        let audioContext;
        const sounds = {};
        
        // Game elements and data
        const elements = [
            { number: 1, symbol: 'H', name: 'Hydrogen', category: 'nonmetal', state: 'gas', weight: 1.008, electrons: [1], color: '#FFFFFF', description: "The lightest element that makes up water and stars!" },
            { number: 2, symbol: 'He', name: 'Helium', category: 'noble-gas', state: 'gas', weight: 4.0026, electrons: [2], color: '#D9FFFF', description: "This gas makes balloons float and gives a funny voice!" },
            { number: 3, symbol: 'Li', name: 'Lithium', category: 'alkali-metal', state: 'solid', weight: 6.94, electrons: [2, 1], color: '#CC80FF', description: "Used in batteries and helps treat some mood problems." },
            { number: 4, symbol: 'Be', name: 'Beryllium', category: 'alkaline-earth', state: 'solid', weight: 9.0122, electrons: [2, 2], color: '#C2FF00', description: "A lightweight metal used in spacecraft and X-ray machines." },
            { number: 5, symbol: 'B', name: 'Boron', category: 'metalloid', state: 'solid', weight: 10.81, electrons: [2, 3], color: '#FFB5B5', description: "Used in cleaning products and makes plants grow better." },
            { number: 6, symbol: 'C', name: 'Carbon', category: 'nonmetal', state: 'solid', weight: 12.011, electrons: [2, 4], color: '#909090', description: "The building block of all life and found in diamonds!" },
            { number: 7, symbol: 'N', name: 'Nitrogen', category: 'nonmetal', state: 'gas', weight: 14.007, electrons: [2, 5], color: '#3050F8', description: "Makes up most of the air we breathe and helps plants grow." },
            { number: 8, symbol: 'O', name: 'Oxygen', category: 'nonmetal', state: 'gas', weight: 15.999, electrons: [2, 6], color: '#FF0D0D', description: "We need this gas to breathe and it makes up water too!" },
            { number: 9, symbol: 'F', name: 'Fluorine', category: 'halogen', state: 'gas', weight: 18.998, electrons: [2, 7], color: '#90E050', description: "The most reactive element and helps protect teeth." },
            { number: 10, symbol: 'Ne', name: 'Neon', category: 'noble-gas', state: 'gas', weight: 20.180, electrons: [2, 8], color: '#B3E3F5', description: "Makes bright glowing signs and never reacts with others." },
            { number: 11, symbol: 'Na', name: 'Sodium', category: 'alkali-metal', state: 'solid', weight: 22.990, electrons: [2, 8, 1], color: '#AB5CF2', description: "A reactive metal that explodes in water and is in salt!" },
            { number: 12, symbol: 'Mg', name: 'Magnesium', category: 'alkaline-earth', state: 'solid', weight: 24.305, electrons: [2, 8, 2], color: '#8AFF00', description: "Burns with a bright light and helps our bones stay strong." },
            { number: 13, symbol: 'Al', name: 'Aluminum', category: 'post-transition', state: 'solid', weight: 26.982, electrons: [2, 8, 3], color: '#BFA6A6', description: "A lightweight metal used for foil, cans, and airplanes." },
            { number: 14, symbol: 'Si', name: 'Silicon', category: 'metalloid', state: 'solid', weight: 28.085, electrons: [2, 8, 4], color: '#F0C8A0', description: "Used in computer chips and is found in sand and glass." },
            { number: 15, symbol: 'P', name: 'Phosphorus', category: 'nonmetal', state: 'solid', weight: 30.974, electrons: [2, 8, 5], color: '#FF8000', description: "Glows in the dark and helps build strong bones and teeth." },
            { number: 16, symbol: 'S', name: 'Sulfur', category: 'nonmetal', state: 'solid', weight: 32.06, electrons: [2, 8, 6], color: '#FFFF30', description: "A yellow element with a strong smell like rotten eggs." },
            { number: 17, symbol: 'Cl', name: 'Chlorine', category: 'halogen', state: 'gas', weight: 35.45, electrons: [2, 8, 7], color: '#1FF01F', description: "Used to clean swimming pools and is part of table salt." },
            { number: 18, symbol: 'Ar', name: 'Argon', category: 'noble-gas', state: 'gas', weight: 39.948, electrons: [2, 8, 8], color: '#80D1E3', description: "An invisible gas used in light bulbs that doesn't react." },
            { number: 19, symbol: 'K', name: 'Potassium', category: 'alkali-metal', state: 'solid', weight: 39.098, electrons: [2, 8, 8, 1], color: '#8F40D4', description: "A reactive metal important for heart and muscle health." },
            { number: 20, symbol: 'Ca', name: 'Calcium', category: 'alkaline-earth', state: 'solid', weight: 40.078, electrons: [2, 8, 8, 2], color: '#3DFF00', description: "Makes bones and teeth strong and is found in milk!" }
        ];
        
        // Molecules data
        const molecules = [
            { 
                name: 'Water (H‚ÇÇO)',
                formula: 'H2O',
                components: [
                    { element: 'H', count: 2, positions: [[150, 180], [250, 180]] },
                    { element: 'O', count: 1, positions: [[200, 120]] }
                ],
                bonds: [
                    { from: [0, 0], to: [1, 0], type: 'single' },
                    { from: [0, 0], to: [0, 1], type: 'single' }
                ],
                description: 'Water is essential for all life. It covers 71% of Earth\'s surface and makes up about 60% of the human body.'
            },
            {
                name: 'Carbon Dioxide (CO‚ÇÇ)',
                formula: 'CO2',
                components: [
                    { element: 'C', count: 1, positions: [[200, 150]] },
                    { element: 'O', count: 2, positions: [[140, 150], [260, 150]] }
                ],
                bonds: [
                    { from: [0, 0], to: [1, 0], type: 'double' },
                    { from: [0, 0], to: [1, 1], type: 'double' }
                ],
                description: 'Carbon dioxide is used by plants for photosynthesis and is what we breathe out. It\'s also what makes soda fizzy!'
            },
            {
                name: 'Methane (CH‚ÇÑ)',
                formula: 'CH4',
                components: [
                    { element: 'C', count: 1, positions: [[200, 150]] },
                    { element: 'H', count: 4, positions: [[200, 90], [260, 150], [200, 210], [140, 150]] }
                ],
                bonds: [
                    { from: [0, 0], to: [1, 0], type: 'single' },
                    { from: [0, 0], to: [1, 1], type: 'single' },
                    { from: [0, 0], to: [1, 2], type: 'single' },
                    { from: [0, 0], to: [1, 3], type: 'single' }
                ],
                description: 'Methane is the simplest hydrocarbon and is the main component of natural gas. It\'s also produced by some animals!'
            }
        ];
        
        // Quiz questions
        const quizQuestions = {
            easy: [
                {
                    question: "What is the chemical symbol for Hydrogen?",
                    options: ["H", "He", "Hy", "Ho"],
                    correctAnswer: 0,
                    explanation: "Hydrogen's symbol is H. It's the first element on the periodic table!"
                },
                {
                    question: "Which element helps plants grow and is part of the air we breathe?",
                    options: ["Oxygen", "Nitrogen", "Carbon", "Helium"],
                    correctAnswer: 1,
                    explanation: "Nitrogen makes up about 78% of our atmosphere and is essential for plant growth."
                },
                {
                    question: "What element is most important for strong bones and teeth?",
                    options: ["Iron", "Sodium", "Calcium", "Potassium"],
                    correctAnswer: 2,
                    explanation: "Calcium is vital for building strong bones and teeth. That's why milk is good for you!"
                },
                {
                    question: "Which of these is NOT a state of matter?",
                    options: ["Solid", "Liquid", "Gas", "Element"],
                    correctAnswer: 3,
                    explanation: "Element is not a state of matter. The three basic states are solid, liquid, and gas."
                },
                {
                    question: "What element makes up most of the Sun?",
                    options: ["Oxygen", "Carbon", "Helium", "Hydrogen"],
                    correctAnswer: 3,
                    explanation: "The Sun is mostly made of Hydrogen, which is the most abundant element in the universe!"
                }
            ],
            medium: [
                {
                    question: "How many atoms of Hydrogen are in a water (H‚ÇÇO) molecule?",
                    options: ["1", "2", "3", "4"],
                    correctAnswer: 1,
                    explanation: "Water (H‚ÇÇO) has 2 Hydrogen atoms and 1 Oxygen atom."
                },
                {
                    question: "Which element is a noble gas that makes balloons float?",
                    options: ["Hydrogen", "Oxygen", "Helium", "Neon"],
                    correctAnswer: 2,
                    explanation: "Helium is a noble gas that is lighter than air, making balloons float upward."
                },
                {
                    question: "What happens when atoms share electrons?",
                    options: ["They form a crystal", "They form a chemical bond", "They change color", "They become magnetic"],
                    correctAnswer: 1,
                    explanation: "When atoms share electrons, they form a chemical bond called a covalent bond."
                },
                {
                    question: "Which element is needed for us to breathe?",
                    options: ["Nitrogen", "Hydrogen", "Carbon", "Oxygen"],
                    correctAnswer: 3,
                    explanation: "Oxygen is essential for human respiration. We breathe it in and exhale carbon dioxide."
                },
                {
                    question: "What is the center of an atom called?",
                    options: ["Nucleus", "Core", "Electron", "Neutron"],
                    correctAnswer: 0,
                    explanation: "The center of an atom is called the nucleus, which contains protons and neutrons."
                }
            ],
            hard: [
                {
                    question: "What are the particles with a negative charge called in an atom?",
                    options: ["Protons", "Neutrons", "Electrons", "Ions"],
                    correctAnswer: 2,
                    explanation: "Electrons have a negative charge and orbit around the nucleus of an atom."
                },
                {
                    question: "Which group of elements rarely reacts with other elements?",
                    options: ["Alkali metals", "Halogens", "Noble gases", "Transition metals"],
                    correctAnswer: 2,
                    explanation: "Noble gases have full outer electron shells, making them very stable and unreactive."
                },
                {
                    question: "What is the chemical formula for table salt?",
                    options: ["H2O", "CO2", "NaCl", "C6H12O6"],
                    correctAnswer: 2,
                    explanation: "Table salt is sodium chloride (NaCl), made of sodium (Na) and chlorine (Cl) atoms."
                },
                {
                    question: "What's the chemical process where plants make their own food using sunlight?",
                    options: ["Digestion", "Photosynthesis", "Respiration", "Fermentation"],
                    correctAnswer: 1,
                    explanation: "Photosynthesis is the process where plants use sunlight, water, and carbon dioxide to create oxygen and energy in the form of sugar."
                },
                {
                    question: "What happens to atoms during a chemical reaction?",
                    options: ["They disappear", "They change into different elements", "They rearrange to form new substances", "They always split apart"],
                    correctAnswer: 2,
                    explanation: "In chemical reactions, atoms are rearranged to form new substances with different properties, but the atoms themselves don't change into different elements."
                }
            ],
            genius: [
                {
                    question: "What is the property that describes how easily an atom gives up electrons?",
                    options: ["Conductivity", "Electronegativity", "Ionization energy", "Electron affinity"],
                    correctAnswer: 2,
                    explanation: "Ionization energy is the energy required to remove an electron from an atom. Lower ionization energy means an atom more easily gives up electrons."
                },
                {
                    question: "Which quantum number describes the shape of an electron orbital?",
                    options: ["Principal quantum number (n)", "Azimuthal quantum number (‚Ñì)", "Magnetic quantum number (m‚Ñì)", "Spin quantum number (ms)"],
                    correctAnswer: 1,
                    explanation: "The azimuthal quantum number (‚Ñì) determines the shape of the orbital. For example, s orbitals (‚Ñì=0) are spherical, while p orbitals (‚Ñì=1) are dumbbell-shaped."
                },
                {
                    question: "What principle states that no two electrons in an atom can have the same four quantum numbers?",
                    options: ["Heisenberg Uncertainty Principle", "Aufbau Principle", "Pauli Exclusion Principle", "Hund's Rule"],
                    correctAnswer: 2,
                    explanation: "The Pauli Exclusion Principle states that no two electrons in an atom can share all four quantum numbers, which limits how electrons fill orbitals."
                },
                {
                    question: "What causes the periodic trends in element properties?",
                    options: ["Neutron count", "Changes in atomic mass", "Nuclear charge and electron shielding", "Temperature variations"],
                    correctAnswer: 2,
                    explanation: "Periodic trends are primarily caused by changes in nuclear charge (number of protons) and electron shielding effects as you move across and down the periodic table."
                },
                {
                    question: "What type of bond forms when electrons are completely transferred from one atom to another?",
                    options: ["Covalent bond", "Hydrogen bond", "Ionic bond", "Metallic bond"],
                    correctAnswer: 2,
                    explanation: "Ionic bonds form when one atom completely transfers electrons to another atom, creating positively and negatively charged ions that attract each other."
                }
            ]
        };
        
        // Chemical reactions data
        const reactions = [
            {
                name: "Water Formation",
                reactants: ["H", "H", "O"],
                products: ["H2O"],
                equation: "2H + O ‚Üí H2O",
                description: "Hydrogen and oxygen combine to form water in this synthesis reaction.",
                energyChange: "Exothermic (releases energy)"
            },
            {
                name: "Salt Formation",
                reactants: ["Na", "Cl"],
                products: ["NaCl"],
                equation: "Na + Cl ‚Üí NaCl",
                description: "Sodium and chlorine react vigorously to form table salt (sodium chloride).",
                energyChange: "Exothermic (releases energy)"
            },
            {
                name: "Carbon Dioxide Formation",
                reactants: ["C", "O", "O"],
                products: ["CO2"],
                equation: "C + 2O ‚Üí CO2",
                description: "Carbon combines with oxygen to form carbon dioxide, which is what we exhale.",
                energyChange: "Exothermic (releases energy)"
            }
        ];
        
        // Story scenes data
        const storyScenes = [
            {
                text: "Welcome to Atom Academy! I'm Professor Atom, and I'll be your guide through the amazing world of chemistry. Our mission is to explore the universe of elements and molecules. Are you ready for an adventure?",
                background: "linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%)",
                choices: [
                    { text: "Yes! Let's explore atoms!", nextScene: 1 },
                    { text: "Tell me more about the academy first", nextScene: 2 }
                ]
            },
            {
                text: "Excellent! Let's start with the building blocks of everything - atoms! Atoms are tiny particles that make up all matter. They have a nucleus in the center with protons and neutrons, and electrons that orbit around it. First, let's explore Hydrogen, the simplest atom!",
                background: "linear-gradient(135deg, #fccb90 0%, #d57eeb 100%)",
                choices: [
                    { text: "Let's look at Hydrogen!", nextScene: 3 },
                    { text: "What makes atoms different from each other?", nextScene: 4 }
                ]
            },
            {
                text: "Atom Academy was founded to help young scientists like you understand the building blocks of our universe. Here, we explore elements, build molecules, conduct experiments, and discover the wonders of chemistry. Everything you see, touch, and feel is made of atoms!",
                background: "linear-gradient(135deg, #f093fb 0%, #f5576c 100%)",
                choices: [
                    { text: "Cool! I'm ready to start learning now.", nextScene: 1 },
                    { text: "What will I learn here?", nextScene: 5 }
                ]
            },
            {
                text: "This is Hydrogen! It's the lightest and most abundant element in the universe. It has just 1 proton in its nucleus and 1 electron orbiting around it. Hydrogen is special because it powers stars like our Sun and combines with oxygen to make water!",
                background: "linear-gradient(135deg, #5ee7df 0%, #b490ca 100%)",
                choices: [
                    { text: "What other elements are important?", nextScene: 6 },
                    { text: "How do elements combine?", nextScene: 7 }
                ]
            },
            {
                text: "Great question! Atoms differ by the number of protons in their nucleus. This number is called the atomic number. Hydrogen has 1 proton, Helium has 2, and so on. The atomic number determines what element it is! Elements are organized in the Periodic Table based on their properties.",
                background: "linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%)",
                choices: [
                    { text: "Tell me about the Periodic Table!", nextScene: 8 },
                    { text: "Let's look at Hydrogen now.", nextScene: 3 }
                ]
            },
            {
                text: "At Atom Academy, you'll discover elements on the Periodic Table, build molecules, understand chemical reactions, and see how chemistry shapes our world. You'll learn why salt crystals form cubes, how soap cleans, why fire burns, and countless other mysteries explained by chemistry!",
                background: "linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)",
                choices: [
                    { text: "Let's start with atoms!", nextScene: 1 },
                    { text: "Show me the Periodic Table.", nextScene: 8 }
                ]
            },
            {
                text: "Oxygen, Carbon, and Nitrogen are super important! Oxygen helps us breathe, Carbon is the backbone of all living things, and Nitrogen is essential for plants to grow. These elements, along with Hydrogen, make up most of your body!",
                background: "linear-gradient(135deg, #f6d365 0%, #fda085 100%)",
                choices: [
                    { text: "How do these elements combine?", nextScene: 7 },
                    { text: "Show me the Periodic Table.", nextScene: 8 }
                ]
            },
            {
                text: "Elements join together by sharing or exchanging electrons to form molecules! For example, when two Hydrogen atoms and one Oxygen atom share electrons, they create a water molecule (H‚ÇÇO). This process of joining atoms is called a chemical bond.",
                background: "linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%)",
                choices: [
                    { text: "Let's build some molecules!", nextScene: 9 },
                    { text: "Tell me about different types of bonds.", nextScene: 10 }
                ]
            },
            {
                text: "The Periodic Table is like a map of all elements, organized by their properties. Elements in the same column have similar behaviors. Metals are on the left, non-metals on the right, and there's a staircase of metalloids in between. Each row represents a new electron shell!",
                background: "linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%)",
                choices: [
                    { text: "Let's explore the Periodic Table!", nextScene: 11 },
                    { text: "Tell me about electron shells.", nextScene: 12 }
                ]
            },
            {
                text: "Building molecules is like connecting LEGO blocks! Let's build water (H‚ÇÇO). We'll need two hydrogen atoms and one oxygen atom. The oxygen shares electrons with both hydrogen atoms, forming a bent shape that gives water its special properties!",
                background: "linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)",
                choices: [
                    { text: "Let's go to the Molecule Builder!", nextScene: 13 },
                    { text: "What other molecules can we build?", nextScene: 14 }
                ]
            },
            {
                text: "There are mainly two types of chemical bonds: Covalent bonds form when atoms share electrons, like in water or oxygen gas. Ionic bonds form when electrons transfer completely from one atom to another, like in table salt (NaCl) where sodium gives an electron to chlorine.",
                background: "linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%)",
                choices: [
                    { text: "Let's see some examples!", nextScene: 15 },
                    { text: "How do these bonds affect properties?", nextScene: 16 }
                ]
            }
        ];
        
        // DOM elements and initialization
        document.addEventListener('DOMContentLoaded', function() {
            initializeGame();
        });
        
        function initializeGame() {
            // Initialize audio context
            try {
                window.AudioContext = window.AudioContext || window.webkitAudioContext;
                audioContext = new AudioContext();
                createSounds();
            } catch(e) {
                console.warn('Web Audio API is not supported in this browser', e);
            }
            
            // Setup settings controls
            document.getElementById('volumeSlider').addEventListener('input', function() {
                const value = this.value;
                document.getElementById('volumeValue').textContent = value + '%';
                gameState.volume = parseInt(value);
                updateVolume();
            });
            
            document.getElementById('quizTimerSlider').addEventListener('input', function() {
                const value = this.value;
                document.getElementById('quizTimerValue').textContent = value + 's';
                gameState.quizTimer = parseInt(value);
            });
            
            document.getElementById('soundEffectsToggle').addEventListener('change', function() {
                gameState.sound = this.checked;
                if (this.checked) {
                    playSound('toggle');
                }
            });
            
            // Control buttons
            document.getElementById('startExperiment').addEventListener('click', () => {
                if (labState.placedEquipment.length === 0) {
                    showCharacterSpeech("Place some equipment and add chemicals first!");
                    playSound('error');
                    return;
                }
                
                // Check containers for potential reactions
                let reactionFound = false;
                
                labState.placedEquipment.forEach(item => {
                    if (item.equipment.canHold && item.chemicals.length > 0) {
                        reactionFound = checkReactions(item) || reactionFound;
                    }
                });
                
                if (!reactionFound) {
                    addLogEntry("No reaction occurred. Try different combinations of chemicals!");
                    showCharacterSpeech("No reaction occurred. Try mixing different chemicals!");
                }
            });
            
            document.getElementById('resetExperiment').addEventListener('click', () => {
                labState.placedEquipment = [];
                labState.usedChemicals = [];
                drawLab();
                playSound('whoosh');
                addLogEntry("Lab table cleared. Ready for a new experiment!");
                showCharacterSpeech("Lab cleared! What experiment would you like to try next?");
            });
            
            // Function to draw the lab
            function drawLab() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Draw lab table background
                ctx.fillStyle = '#f9f9f9';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Draw grid lines
                ctx.strokeStyle = '#ddd';
                ctx.lineWidth = 1;
                
                for (let x = 0; x < canvas.width; x += 50) {
                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, canvas.height);
                    ctx.stroke();
                }
                
                for (let y = 0; y < canvas.height; y += 50) {
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(canvas.width, y);
                    ctx.stroke();
                }
                
                // Draw placed equipment
                labState.placedEquipment.forEach(item => {
                    const { equipment, x, y, chemicals } = item;
                    
                    // Draw equipment
                    ctx.fillStyle = '#ddd';
                    
                    if (equipment.name === 'Beaker') {
                        // Draw beaker
                        ctx.fillStyle = '#eee';
                        ctx.fillRect(x, y + 10, equipment.width, equipment.height - 10);
                        ctx.strokeStyle = '#aaa';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(x, y + 10, equipment.width, equipment.height - 10);
                        
                        // Draw beaker rim
                        ctx.fillRect(x - 5, y, equipment.width + 10, 10);
                        ctx.strokeRect(x - 5, y, equipment.width + 10, 10);
                        
                        // Draw chemicals if any
                        if (chemicals.length > 0) {
                            // Determine color mixing
                            let mixedColor = chemicals[0].color;
                            if (chemicals.length > 1) {
                                // Simple color mixing (not accurate chemistry)
                                mixedColor = mixColors(chemicals.map(c => c.color));
                            }
                            
                            // Fill beaker with chemical
                            ctx.fillStyle = mixedColor;
                            const fillHeight = Math.min(equipment.height - 15, 10 + chemicals.length * 10);
                            ctx.fillRect(x + 2, y + equipment.height - fillHeight, equipment.width - 4, fillHeight);
                            
                            // Draw bubbles if a reaction is occurring
                            if (chemicals.some(c => c.reactive) && chemicals.length > 1) {
                                drawBubbles(x + 10, y + equipment.height - fillHeight, equipment.width - 20, fillHeight);
                            }
                        }
                    } else if (equipment.name === 'Test Tube') {
                        // Draw test tube
                        ctx.fillStyle = '#eee';
                        ctx.fillRect(x, y, equipment.width, equipment.height);
                        ctx.strokeStyle = '#aaa';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(x, y, equipment.width, equipment.height);
                        
                        // Draw rounded bottom
                        ctx.beginPath();
                        ctx.arc(x + equipment.width / 2, y + equipment.height, equipment.width / 2, Math.PI, 0, true);
                        ctx.fillStyle = '#eee';
                        ctx.fill();
                        ctx.strokeStyle = '#aaa';
                        ctx.stroke();
                        
                        // Draw chemicals if any
                        if (chemicals.length > 0) {
                            // Determine color mixing
                            let mixedColor = chemicals[0].color;
                            if (chemicals.length > 1) {
                                mixedColor = mixColors(chemicals.map(c => c.color));
                            }
                            
                            // Fill test tube with chemical
                            ctx.fillStyle = mixedColor;
                            const fillHeight = Math.min(equipment.height, chemicals.length * 15);
                            ctx.fillRect(x + 2, y + equipment.height - fillHeight, equipment.width - 4, fillHeight);
                            
                            // Draw rounded bottom with chemical
                            ctx.beginPath();
                            ctx.arc(x + equipment.width / 2, y + equipment.height, equipment.width / 2 - 2, Math.PI, 0, true);
                            ctx.fillStyle = mixedColor;
                            ctx.fill();
                            
                            // Draw bubbles if a reaction is occurring
                            if (chemicals.some(c => c.reactive) && chemicals.length > 1) {
                                drawBubbles(x + 2, y + equipment.height - fillHeight, equipment.width - 4, fillHeight);
                            }
                        }
                    } else if (equipment.name === 'Bunsen Burner') {
                        // Draw burner base
                        ctx.fillStyle = '#666';
                        ctx.fillRect(x, y + 40, equipment.width, equipment.height - 40);
                        
                        // Draw burner tube
                        ctx.fillStyle = '#999';
                        ctx.fillRect(x + 15, y, 10, 40);
                        
                        // Draw flame
                        const flameHeight = 30;
                        ctx.beginPath();
                        ctx.moveTo(x + 15, y);
                        ctx.lineTo(x + 25, y);
                        ctx.lineTo(x + 20, y - flameHeight);
                        ctx.closePath();
                        ctx.fillStyle = 'rgba(255, 160, 0, 0.7)';
                        ctx.fill();
                    } else if (equipment.name === 'Thermometer') {
                        // Draw thermometer tube
                        ctx.fillStyle = '#eee';
                        ctx.fillRect(x, y, equipment.width, equipment.height);
                        ctx.strokeStyle = '#aaa';
                        ctx.lineWidth = 1;
                        ctx.strokeRect(x, y, equipment.width, equipment.height);
                        
                        // Draw bulb
                        ctx.beginPath();
                        ctx.arc(x + equipment.width / 2, y + equipment.height, equipment.width, 0, Math.PI, true);
                        ctx.fillStyle = '#f55';
                        ctx.fill();
                        ctx.strokeStyle = '#aaa';
                        ctx.stroke();
                        
                        // Draw temperature line
                        ctx.fillStyle = '#f55';
                        ctx.fillRect(x + equipment.width / 3, y + 20, equipment.width / 3, equipment.height - 20);
                    } else if (equipment.name === 'Stirring Rod') {
                        // Draw stirring rod
                        ctx.fillStyle = '#ddd';
                        ctx.fillRect(x, y, equipment.width, equipment.height);
                        ctx.strokeStyle = '#aaa';
                        ctx.lineWidth = 1;
                        ctx.strokeRect(x, y, equipment.width, equipment.height);
                    } else {
                        // Generic equipment representation
                        ctx.fillRect(x, y, equipment.width, equipment.height);
                        ctx.strokeStyle = '#aaa';
                        ctx.lineWidth = 1;
                        ctx.strokeRect(x, y, equipment.width, equipment.height);
                    }
                    
                    // Draw equipment name
                    ctx.fillStyle = '#333';
                    ctx.font = '10px Nunito';
                    ctx.textAlign = 'center';
                    ctx.fillText(equipment.name, x + equipment.width / 2, y - 5);
                });
            }
            
            // Function to draw bubbles for reactions
            function drawBubbles(x, y, width, height) {
                ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
                
                // Draw random bubbles
                for (let i = 0; i < 10; i++) {
                    const bubbleX = x + Math.random() * width;
                    const bubbleY = y + Math.random() * height;
                    const bubbleSize = 2 + Math.random() * 5;
                    
                    ctx.beginPath();
                    ctx.arc(bubbleX, bubbleY, bubbleSize, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
            
            // Function to add entry to experiment log
            function addLogEntry(text) {
                const entry = document.createElement('div');
                entry.className = 'log-entry';
                entry.textContent = text;
                
                experimentLog.insertBefore(entry, experimentLog.firstChild);
                
                // Limit log entries
                if (experimentLog.children.length > 10) {
                    experimentLog.removeChild(experimentLog.lastChild);
                }
            }
            
            // Function to check for reactions
            function checkReactions(container) {
                if (container.chemicals.length < 2) {
                    return false;
                }
                
                // Get chemical names
                const chemicalNames = container.chemicals.map(c => c.name);
                
                // Check for matching experiment
                for (const experiment of experiments) {
                    // Check if all required components are present
                    const allComponentsPresent = experiment.components.every(component => 
                        chemicalNames.some(name => name.includes(component))
                    );
                    
                    if (allComponentsPresent) {
                        // Trigger reaction
                        addLogEntry(`Reaction detected: ${experiment.result}`);
                        addLogEntry(`Observation: ${experiment.observation}`);
                        
                        playSound('reaction');
                        createConfetti(20);
                        
                        showCharacterSpeech(`Wow! ${experiment.result} ${experiment.observation}`);
                        
                        // Add to completed experiments if new
                        const experimentKey = experiment.components.sort().join('-');
                        if (!gameState.completedExperiments.includes(experimentKey)) {
                            gameState.completedExperiments.push(experimentKey);
                            showNotification("New Reaction Discovered!", "üß™");
                        }
                        
                        return true;
                    }
                }
                
                return false;
            }
            
            // Function to mix colors
            function mixColors(colors) {
                if (colors.length === 0) return '#ffffff';
                if (colors.length === 1) return colors[0];
                
                // Simple color mixing (not chemically accurate)
                let r = 0, g = 0, b = 0;
                
                colors.forEach(color => {
                    // Convert hex to rgb
                    const hex = color.replace('#', '');
                    const rgb = parseInt(hex, 16);
                    
                    r += (rgb >> 16) & 255;
                    g += (rgb >> 8) & 255;
                    b += rgb & 255;
                });
                
                // Average the colors
                r = Math.floor(r / colors.length);
                g = Math.floor(g / colors.length);
                b = Math.floor(b / colors.length);
                
                // Convert back to hex
                return `#${((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1)}`;
            }
            
            // Initial drawing
            drawLab();
        }
            
            document.getElementById('backgroundMusicToggle').addEventListener('change', function() {
                gameState.music = this.checked;
                // Toggle background music if implemented
            });
            
            document.getElementById('characterToggle').addEventListener('change', function() {
                gameState.showCharacter = this.checked;
                document.getElementById('characterContainer').style.display = this.checked ? 'block' : 'none';
                if (this.checked) {
                    playSound('toggle');
                }
            });
            
            document.getElementById('saveSettings').addEventListener('click', function() {
                gameState.difficulty = document.getElementById('difficultySelect').value;
                gameState.textSize = document.getElementById('textSizeSelect').value;
                gameState.theme = document.getElementById('themeSelect').value;
                gameState.advancedConcepts = document.getElementById('advancedConceptsToggle').checked;
                gameState.learningFocus = document.getElementById('learningFocusSelect').value;
                
                applySettings();
                showCharacterSpeech("Settings saved! Your changes have been applied.");
                playSound('success');
                createConfetti(20);
                
                // Return to main menu after a short delay
                setTimeout(() => {
                    goToMainMenu();
                }, 1500);
            });
            
            // Apply initial settings
            applySettings();
            
            // Initialize Periodic Table
            createPeriodicTable();
            
            // Initialize Molecule Builder
            setupMoleculeBuilder();
            
            // Initialize Quiz
            setupQuiz();
            
            // Initialize Reaction Simulator
            setupReactionSimulator();
            
            // Initialize Experiment Lab
            setupExperimentLab();
            
            // Show character with welcome message
            setTimeout(() => {
                showCharacterSpeech("Welcome to Element Explorer! I'm Professor Atom. Click on the menu options to start your chemistry adventure!");
            }, 1000);
            
            // Hide loading screen
            setTimeout(() => {
                document.getElementById('loadingScreen').style.opacity = 0;
                setTimeout(() => {
                    document.getElementById('loadingScreen').style.display = 'none';
                }, 500);
                playSound('startup');
            }, 1500);
        }
        
        // Navigation functions
        function goToMainMenu() {
            hideAllContainers();
            document.getElementById('mainMenuContainer').style.display = 'block';
            playSound('click');
            
            // Show random character tip
            const tips = [
                "Click on 'Explore Periodic Table' to learn about elements!",
                "Did you know water is made of hydrogen and oxygen atoms?",
                "Try the 'Build Molecules' section to create your own compounds!",
                "Challenge yourself with the 'Element Quiz' to test your knowledge!",
                "All matter in the universe is made of atoms. Even you!"
            ];
            
            showCharacterSpeech(tips[Math.floor(Math.random() * tips.length)]);
        }
        
        function hideAllContainers() {
            const containers = [
                'mainMenuContainer',
                'periodicTableContainer',
                'buildMoleculesContainer',
                'experimentLabContainer',
                'quizContainer',
                'reactionSimulatorContainer',
                'settingsContainer',
                'storyContainer'
            ];
            
            containers.forEach(id => {
                document.getElementById(id).style.display = 'none';
            });
            
            // Hide element details if open
            document.getElementById('elementDetails').classList.remove('show');
            document.getElementById('overlay').style.display = 'none';
        }
        
        function startPeriodicTable() {
            hideAllContainers();
            document.getElementById('periodicTableContainer').style.display = 'block';
            playSound('click');
            
            showCharacterSpeech("Welcome to the Periodic Table! Click on any element to learn more about it. The colors show different element categories.");
        }
        
        function startBuildMolecules() {
            hideAllContainers();
            document.getElementById('buildMoleculesContainer').style.display = 'block';
            playSound('click');
            
            showCharacterSpeech("Let's build molecules! Select elements from the palette and place them on the canvas. Connect them to form bonds!");
        }
        
        function startExperimentLab() {
            hideAllContainers();
            document.getElementById('experimentLabContainer').style.display = 'block';
            playSound('click');
            
            showCharacterSpeech("Welcome to the Chemistry Lab! Select equipment and chemicals to conduct experiments. What will you discover today?");
        }
        
        function startQuiz() {
            hideAllContainers();
            document.getElementById('quizContainer').style.display = 'block';
            playSound('click');
            
            // Reset quiz state
            gameState.quizScore = 0;
            gameState.totalQuestions = 0;
            
            // Load questions based on difficulty
            loadQuizQuestion();
            
            showCharacterSpeech("Time to test your knowledge! Answer questions about elements and chemistry concepts. Good luck!");
        }
        
        function startReactionSimulator() {
            hideAllContainers();
            document.getElementById('reactionSimulatorContainer').style.display = 'block';
            playSound('click');
            
            showCharacterSpeech("Watch chemistry in action! Select a reaction and see how atoms rearrange to form new substances.");
        }
        
        function startStoryMode() {
            hideAllContainers();
            document.getElementById('storyContainer').style.display = 'block';
            playSound('click');
            
            // Load first story scene or saved progress
            loadStoryScene(gameState.storyProgress || 0);
            
            showCharacterSpeech("Join me on an adventure through the world of chemistry! Make choices and discover the secrets of atoms and molecules.");
        }
        
        function openSettings() {
            hideAllContainers();
            document.getElementById('settingsContainer').style.display = 'block';
            playSound('click');
            
            // Reset settings UI to match current state
            document.getElementById('soundEffectsToggle').checked = gameState.sound;
            document.getElementById('backgroundMusicToggle').checked = gameState.music;
            document.getElementById('volumeSlider').value = gameState.volume;
            document.getElementById('volumeValue').textContent = gameState.volume + '%';
            document.getElementById('difficultySelect').value = gameState.difficulty;
            document.getElementById('quizTimerSlider').value = gameState.quizTimer;
            document.getElementById('quizTimerValue').textContent = gameState.quizTimer + 's';
            document.getElementById('characterToggle').checked = gameState.showCharacter;
            document.getElementById('textSizeSelect').value = gameState.textSize;
            document.getElementById('themeSelect').value = gameState.theme;
            document.getElementById('advancedConceptsToggle').checked = gameState.advancedConcepts;
            document.getElementById('learningFocusSelect').value = gameState.learningFocus;
            
            showCharacterSpeech("Customize your experience! Adjust sound, difficulty, and display settings to match your preferences.");
        }
        
        // Periodic Table functions
        function createPeriodicTable() {
            const grid = document.getElementById('periodicTableGrid');
            
            // Clear existing content
            grid.innerHTML = '';
            
            // Array to track element positions
            const positions = [];
            for (let i = 0; i < 10; i++) {
                positions[i] = Array(18).fill(null);
            }
            
            // Define positions for main group elements
            // This is a simplified layout for educational purposes
            elements.forEach(element => {
                let row, col;
                
                if (element.number <= 2) {
                    // First period (H and He)
                    row = 0;
                    col = element.number === 1 ? 0 : 17;
                } else if (element.number <= 10) {
                    // Second period (Li to Ne)
                    row = 1;
                    col = (element.number - 3) % 8;
                    if (element.number >= 5) col += 10;
                } else if (element.number <= 18) {
                    // Third period (Na to Ar)
                    row = 2;
                    col = (element.number - 11) % 8;
                    if (element.number >= 13) col += 10;
                } else {
                    // Fourth period (K and Ca only in this simplified version)
                    row = 3;
                    col = (element.number - 19) % 8;
                }
                
                positions[row][col] = element;
            });
            
            // Create elements in the grid
            for (let row = 0; row < 10; row++) {
                for (let col = 0; col < 18; col++) {
                    const element = positions[row][col];
                    
                    // Create empty cell or element
                    const cell = document.createElement('div');
                    
                    if (element) {
                        cell.className = `element ${element.category}`;
                        cell.innerHTML = `
                            <span class="number">${element.number}</span>
                            <span class="symbol">${element.symbol}</span>
                            <span class="name">${element.name}</span>
                        `;
                        cell.addEventListener('click', () => showElementDetails(element));
                    } else {
                        cell.className = 'element empty';
                        cell.style.visibility = 'hidden';
                    }
                    
                    grid.appendChild(cell);
                }
            }
            
            // Element details panel setup
            document.getElementById('closeDetails').addEventListener('click', hideElementDetails);
            document.getElementById('overlay').addEventListener('click', hideElementDetails);
        }
        
        function showElementDetails(element) {
            const detailsPanel = document.getElementById('elementDetails');
            const overlay = document.getElementById('overlay');
            
            // Update details content
            document.getElementById('detailsTitle').textContent = `${element.name} (${element.symbol})`;
            
            // Clear previous electron shells
            const atomVisualizer = document.getElementById('atomVisualizer');
            while (atomVisualizer.childNodes.length > 1) {
                atomVisualizer.removeChild(atomVisualizer.lastChild);
            }
            
            // Update nucleus
            const nucleus = atomVisualizer.querySelector('.nucleus');
            nucleus.textContent = element.number;
            
            // Create electron shells
            element.electrons.forEach((electronCount, shellIndex) => {
                const shellRadius = 30 + (shellIndex * 30);
                
                // Create shell
                const shell = document.createElement('div');
                shell.className = 'electron-shell';
                shell.style.width = `${shellRadius * 2}px`;
                shell.style.height = `${shellRadius * 2}px`;
                atomVisualizer.appendChild(shell);
                
                // Create electrons in the shell
                for (let i = 0; i < electronCount; i++) {
                    const electron = document.createElement('div');
                    electron.className = 'electron';
                    
                    // Position electrons evenly around the shell
                    const angle = (i / electronCount) * Math.PI * 2;
                    const orbitDuration = 5 + (shellIndex * 2); // Outer shells orbit slower
                    
                    electron.style.setProperty('--radius', `${shellRadius}px`);
                    electron.style.animation = `orbit ${orbitDuration}s linear infinite`;
                    electron.style.animationDelay = `${(i / electronCount) * orbitDuration}s`;
                    
                    // Initial position
                    electron.style.transform = `translate(-50%, -50%) rotate(${angle}rad) translateX(${shellRadius}px) rotate(${-angle}rad)`;
                    
                    atomVisualizer.appendChild(electron);
                }
            });
            
            // Update element info
            const elementInfo = document.getElementById('elementInfo');
            elementInfo.innerHTML = `
                <div class="info-item">
                    <h4>Atomic Number</h4>
                    <p>${element.number}</p>
                </div>
                <div class="info-item">
                    <h4>Atomic Weight</h4>
                    <p>${element.weight} u</p>
                </div>
                <div class="info-item">
                    <h4>Category</h4>
                    <p>${element.category.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())}</p>
                </div>
                <div class="info-item">
                    <h4>State at Room Temp</h4>
                    <p>${element.state.charAt(0).toUpperCase() + element.state.slice(1)}</p>
                </div>
                <div class="info-item" style="grid-column: span 2;">
                    <h4>Fun Fact</h4>
                    <p>${element.description}</p>
                </div>
            `;
            
            // Show the details panel
            overlay.style.display = 'block';
            detailsPanel.classList.add('show');
            
            // Play sound
            playSound('pop');
            
            // Add to discovered elements
            if (!gameState.discoveredElements.includes(element.symbol)) {
                gameState.discoveredElements.push(element.symbol);
                
                // Show achievement notification if it's a new discovery
                showNotification("New Element Discovered!", "üîç");
            }
            
            // Show character speech
            showCharacterSpeech(`This is ${element.name} (${element.symbol})! ${element.description}`);
        }
        
        function hideElementDetails() {
            document.getElementById('elementDetails').classList.remove('show');
            document.getElementById('overlay').style.display = 'none';
            
            // Play sound
            playSound('click');
        }
        
        // Molecule Builder functions
        function setupMoleculeBuilder() {
            const canvas = document.getElementById('moleculeCanvas');
            const ctx = canvas.getContext('2d');
            const palette = document.getElementById('moleculePalette');
            const gallery = document.getElementById('moleculesGallery');
            
            // Initialize molecule builder state
            const builderState = {
                selectedElement: null,
                placedElements: [],
                bonds: [],
                draggingElement: null,
                dragOffsetX: 0,
                dragOffsetY: 0
            };
            
            // Populate element palette
            const commonElements = ['H', 'O', 'C', 'N', 'Cl', 'Na', 'Mg', 'S', 'P', 'Ca'];
            commonElements.forEach(symbol => {
                const element = elements.find(e => e.symbol === symbol);
                if (element) {
                    const btn = document.createElement('div');
                    btn.className = 'palette-element';
                    btn.textContent = element.symbol;
                    btn.style.backgroundColor = element.color;
                    btn.style.color = element.color === '#FFFFFF' ? '#000' : '#FFF';
                    
                    btn.addEventListener('click', () => {
                        builderState.selectedElement = element;
                        
                        // Highlight selected element
                        document.querySelectorAll('.palette-element').forEach(el => {
                            el.style.boxShadow = 'none';
                        });
                        btn.style.boxShadow = '0 0 8px 3px rgba(0, 255, 255, 0.7)';
                        
                        playSound('click');
                        showCharacterSpeech(`Selected ${element.name}! Click on the canvas to place it.`);
                    });
                    
                    palette.appendChild(btn);
                }
            });
            
            // Add control buttons event listeners
            document.getElementById('clearMolecule').addEventListener('click', () => {
                builderState.placedElements = [];
                builderState.bonds = [];
                drawMolecule();
                playSound('whoosh');
                showCharacterSpeech("Canvas cleared! Start building a new molecule.");
            });
            
            document.getElementById('saveMolecule').addEventListener('click', () => {
                if (builderState.placedElements.length < 2) {
                    showCharacterSpeech("You need at least two atoms to make a molecule!");
                    playSound('error');
                    return;
                }
                
                // Create a simple formula from placed elements
                const elementCounts = {};
                builderState.placedElements.forEach(placed => {
                    const symbol = placed.element.symbol;
                    elementCounts[symbol] = (elementCounts[symbol] || 0) + 1;
                });
                
                let formula = '';
                for (const symbol in elementCounts) {
                    formula += symbol;
                    if (elementCounts[symbol] > 1) {
                        formula += elementCounts[symbol];
                    }
                }
                
                // Check if this is a known molecule
                let knownMolecule = molecules.find(m => m.formula === formula);
                let moleculeName = knownMolecule ? knownMolecule.name : formula;
                
                // Save the molecule
                const savedMolecule = {
                    name: moleculeName,
                    formula: formula,
                    elements: builderState.placedElements.map(p => ({
                        symbol: p.element.symbol,
                        x: p.x,
                        y: p.y
                    })),
                    bonds: builderState.bonds.map(b => ({
                        from: b.from,
                        to: b.to,
                        type: b.type
                    }))
                };
                
                gameState.builtMolecules.push(savedMolecule);
                
                // Add to gallery
                addMoleculeToGallery(savedMolecule);
                
                playSound('success');
                createConfetti(10);
                showCharacterSpeech(`Great job! You built ${moleculeName}!`);
                
                if (knownMolecule) {
                    setTimeout(() => {
                        showCharacterSpeech(knownMolecule.description);
                    }, 3000);
                }
            });
            
            // Canvas event listeners for molecule building
            canvas.addEventListener('click', (e) => {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                if (builderState.selectedElement) {
                    // Place element
                    builderState.placedElements.push({
                        element: builderState.selectedElement,
                        x: x,
                        y: y
                    });
                    
                    drawMolecule();
                    playSound('pop');
                } else {
                    // Check if clicking on an element (for creating bonds)
                    const clickedElementIndex = builderState.placedElements.findIndex(placed => {
                        const dx = placed.x - x;
                        const dy = placed.y - y;
                        return Math.sqrt(dx * dx + dy * dy) < 20; // 20px radius
                    });
                    
                    if (clickedElementIndex !== -1) {
                        // Toggle bond creation mode
                        if (builderState.bondStartElement === undefined) {
                            builderState.bondStartElement = clickedElementIndex;
                            playSound('click');
                        } else {
                            // Create bond between two elements
                            if (builderState.bondStartElement !== clickedElementIndex) {
                                const bondExists = builderState.bonds.findIndex(bond => 
                                    (bond.from === builderState.bondStartElement && bond.to === clickedElementIndex) ||
                                    (bond.from === clickedElementIndex && bond.to === builderState.bondStartElement)
                                );
                                
                                if (bondExists === -1) {
                                    // Create new bond
                                    builderState.bonds.push({
                                        from: builderState.bondStartElement,
                                        to: clickedElementIndex,
                                        type: 'single'
                                    });
                                    
                                    playSound('connect');
                                } else {
                                    // Upgrade bond type
                                    const bond = builderState.bonds[bondExists];
                                    if (bond.type === 'single') {
                                        bond.type = 'double';
                                    } else if (bond.type === 'double') {
                                        bond.type = 'triple';
                                    } else {
                                        // Remove bond if triple
                                        builderState.bonds.splice(bondExists, 1);
                                    }
                                    
                                    playSound('connect');
                                }
                            }
                            
                            builderState.bondStartElement = undefined;
                        }
                        
                        drawMolecule();
                    }
                }
            });
            
            canvas.addEventListener('mousedown', (e) => {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                // Check if clicking on an element (for dragging)
                for (let i = 0; i < builderState.placedElements.length; i++) {
                    const placed = builderState.placedElements[i];
                    const dx = placed.x - x;
                    const dy = placed.y - y;
                    
                    if (Math.sqrt(dx * dx + dy * dy) < 20) { // 20px radius
                        builderState.draggingElement = i;
                        builderState.dragOffsetX = dx;
                        builderState.dragOffsetY = dy;
                        break;
                    }
                }
            });
            
            canvas.addEventListener('mousemove', (e) => {
                if (builderState.draggingElement !== null) {
                    const rect = canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    builderState.placedElements[builderState.draggingElement].x = x + builderState.dragOffsetX;
                    builderState.placedElements[builderState.draggingElement].y = y + builderState.dragOffsetY;
                    
                    drawMolecule();
                }
            });
            
            canvas.addEventListener('mouseup', () => {
                builderState.draggingElement = null;
            });
            
            canvas.addEventListener('mouseleave', () => {
                builderState.draggingElement = null;
            });
            
            // Function to draw molecule on canvas
            function drawMolecule() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Draw bonds
                builderState.bonds.forEach(bond => {
                    const from = builderState.placedElements[bond.from];
                    const to = builderState.placedElements[bond.to];
                    
                    const dx = to.x - from.x;
                    const dy = to.y - from.y;
                    const angle = Math.atan2(dy, dx);
                    
                    // Draw different bond types
                    if (bond.type === 'single') {
                        ctx.beginPath();
                        ctx.moveTo(from.x, from.y);
                        ctx.lineTo(to.x, to.y);
                        ctx.strokeStyle = '#000';
                        ctx.lineWidth = 2;
                        ctx.stroke();
                    } else if (bond.type === 'double') {
                        const offset = 3;
                        
                        ctx.beginPath();
                        ctx.moveTo(from.x + offset * Math.sin(angle), from.y - offset * Math.cos(angle));
                        ctx.lineTo(to.x + offset * Math.sin(angle), to.y - offset * Math.cos(angle));
                        ctx.strokeStyle = '#000';
                        ctx.lineWidth = 2;
                        ctx.stroke();
                        
                        ctx.beginPath();
                        ctx.moveTo(from.x - offset * Math.sin(angle), from.y + offset * Math.cos(angle));
                        ctx.lineTo(to.x - offset * Math.sin(angle), to.y + offset * Math.cos(angle));
                        ctx.strokeStyle = '#000';
                        ctx.lineWidth = 2;
                        ctx.stroke();
                    } else if (bond.type === 'triple') {
                        const offset = 4;
                        
                        ctx.beginPath();
                        ctx.moveTo(from.x, from.y);
                        ctx.lineTo(to.x, to.y);
                        ctx.strokeStyle = '#000';
                        ctx.lineWidth = 2;
                        ctx.stroke();
                        
                        ctx.beginPath();
                        ctx.moveTo(from.x + offset * Math.sin(angle), from.y - offset * Math.cos(angle));
                        ctx.lineTo(to.x + offset * Math.sin(angle), to.y - offset * Math.cos(angle));
                        ctx.strokeStyle = '#000';
                        ctx.lineWidth = 2;
                        ctx.stroke();
                        
                        ctx.beginPath();
                        ctx.moveTo(from.x - offset * Math.sin(angle), from.y + offset * Math.cos(angle));
                        ctx.lineTo(to.x - offset * Math.sin(angle), to.y + offset * Math.cos(angle));
                        ctx.strokeStyle = '#000';
                        ctx.lineWidth = 2;
                        ctx.stroke();
                    }
                });
                
                // Draw elements
                builderState.placedElements.forEach((placed, index) => {
                    // Draw circle for atom
                    ctx.beginPath();
                    ctx.arc(placed.x, placed.y, 20, 0, Math.PI * 2);
                    ctx.fillStyle = placed.element.color;
                    ctx.fill();
                    ctx.strokeStyle = '#000';
                    ctx.lineWidth = 1;
                    ctx.stroke();
                    
                    // Draw element symbol
                    ctx.fillStyle = placed.element.color === '#FFFFFF' ? '#000' : '#FFF';
                    ctx.font = 'bold 16px Nunito';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(placed.element.symbol, placed.x, placed.y);
                    
                    // Highlight if this is start of bond
                    if (builderState.bondStartElement === index) {
                        ctx.beginPath();
                        ctx.arc(placed.x, placed.y, 23, 0, Math.PI * 2);
                        ctx.strokeStyle = '#00ffff';
                        ctx.lineWidth = 2;
                        ctx.stroke();
                    }
                });
            }
            
            // Function to add molecule to gallery
            function addMoleculeToGallery(molecule) {
                const item = document.createElement('div');
                item.className = 'gallery-item';
                
                // Create mini canvas for molecule preview
                const canvas = document.createElement('canvas');
                canvas.width = 80;
                canvas.height = 80;
                const ctx = canvas.getContext('2d');
                
                // Draw mini representation
                drawMiniMolecule(ctx, molecule);
                
                item.appendChild(canvas);
                
                // Add name
                const nameSpan = document.createElement('span');
                nameSpan.textContent = molecule.name;
                item.appendChild(nameSpan);
                
                // Add click event to load this molecule
                item.addEventListener('click', () => {
                    loadMolecule(molecule);
                    playSound('pop');
                });
                
                gallery.appendChild(item);
            }
            
            // Function to draw mini molecule for gallery
            function drawMiniMolecule(ctx, molecule) {
                // Calculate boundaries
                let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
                
                molecule.elements.forEach(el => {
                    minX = Math.min(minX, el.x);
                    minY = Math.min(minY, el.y);
                    maxX = Math.max(maxX, el.x);
                    maxY = Math.max(maxY, el.y);
                });
                
                const width = maxX - minX;
                const height = maxY - minY;
                const scale = Math.min(60 / width, 60 / height) || 1;
                const offsetX = 40 - ((minX + maxX) / 2) * scale;
                const offsetY = 40 - ((minY + maxY) / 2) * scale;
                
                // Draw bonds
                molecule.bonds.forEach(bond => {
                    const from = molecule.elements[bond.from];
                    const to = molecule.elements[bond.to];
                    
                    ctx.beginPath();
                    ctx.moveTo(from.x * scale + offsetX, from.y * scale + offsetY);
                    ctx.lineTo(to.x * scale + offsetX, to.y * scale + offsetY);
                    ctx.strokeStyle = '#000';
                    ctx.lineWidth = 1;
                    ctx.stroke();
                });
                
                // Draw elements
                molecule.elements.forEach(el => {
                    const element = elements.find(e => e.symbol === el.symbol);
                    
                    // Draw circle for atom
                    ctx.beginPath();
                    ctx.arc(el.x * scale + offsetX, el.y * scale + offsetY, 10, 0, Math.PI * 2);
                    ctx.fillStyle = element.color;
                    ctx.fill();
                    ctx.strokeStyle = '#000';
                    ctx.lineWidth = 0.5;
                    ctx.stroke();
                    
                    // Draw element symbol
                    ctx.fillStyle = element.color === '#FFFFFF' ? '#000' : '#FFF';
                    ctx.font = 'bold 8px Nunito';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(element.symbol, el.x * scale + offsetX, el.y * scale + offsetY);
                });
            }
            
            // Function to load molecule from gallery
            function loadMolecule(molecule) {
                builderState.placedElements = molecule.elements.map(el => {
                    const element = elements.find(e => e.symbol === el.symbol);
                    return {
                        element: element,
                        x: el.x,
                        y: el.y
                    };
                });
                
                builderState.bonds = molecule.bonds;
                drawMolecule();
                
                showCharacterSpeech(`Loaded ${molecule.name}! You can modify it or use it as a starting point.`);
            }
            
            // Add preset molecules to gallery
            molecules.forEach(molecule => {
                // Convert format
                const convertedMolecule = {
                    name: molecule.name,
                    formula: molecule.formula,
                    elements: [],
                    bonds: []
                };
                
                // Extract elements
                molecule.components.forEach((component, componentIndex) => {
                    for (let i = 0; i < component.count; i++) {
                        const element = elements.find(e => e.symbol === component.element);
                        const pos = component.positions[i] || [Math.random() * 200 + 200, Math.random() * 200 + 100];
                        
                        convertedMolecule.elements.push({
                            symbol: component.element,
                            x: pos[0],
                            y: pos[1]
                        });
                    }
                });
                
                // Extract bonds
                molecule.bonds.forEach(bond => {
                    const fromComponent = bond.from[0];
                    const fromIndex = bond.from[1];
                    const toComponent = bond.to[0];
                    const toIndex = bond.to[1];
                    
                    // Calculate actual element indices
                    let fromElementIndex = 0;
                    for (let i = 0; i < fromComponent; i++) {
                        fromElementIndex += molecule.components[i].count;
                    }
                    fromElementIndex += fromIndex;
                    
                    let toElementIndex = 0;
                    for (let i = 0; i < toComponent; i++) {
                        toElementIndex += molecule.components[i].count;
                    }
                    toElementIndex += toIndex;
                    
                    convertedMolecule.bonds.push({
                        from: fromElementIndex,
                        to: toElementIndex,
                        type: bond.type
                    });
                });
                
                addMoleculeToGallery(convertedMolecule);
            });
            
            // Initial drawing
            drawMolecule();
        }
        
        // Quiz functions
        function setupQuiz() {
            const submitBtn = document.getElementById('submitAnswer');
            const nextBtn = document.getElementById('nextQuestion');
            
            submitBtn.addEventListener('click', checkAnswer);
            nextBtn.addEventListener('click', loadQuizQuestion);
            
            // Load initial question
            loadQuizQuestion();
        }
        
        function loadQuizQuestion() {
            // Reset state
            document.getElementById('submitAnswer').style.display = 'block';
            document.getElementById('nextQuestion').style.display = 'none';
            document.getElementById('feedbackMessage').style.display = 'none';
            
            // Get questions based on difficulty
            const questions = quizQuestions[gameState.difficulty];
            
            // Get random question
            const questionIndex = Math.floor(Math.random() * questions.length);
            const question = questions[questionIndex];
            
            // Update UI
            document.getElementById('questionText').textContent = question.question;
            
            // Create answer options
            const answerOptions = document.getElementById('answerOptions');
            answerOptions.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'answer-option';
                optionDiv.textContent = option;
                optionDiv.dataset.index = index;
                
                optionDiv.addEventListener('click', () => {
                    // Deselect all options
                    document.querySelectorAll('.answer-option').forEach(option => {
                        option.classList.remove('selected');
                    });
                    
                    // Select this option
                    optionDiv.classList.add('selected');
                    
                    playSound('click');
                });
                
                answerOptions.appendChild(optionDiv);
            });
            
            // Update progress
            gameState.totalQuestions++;
            document.getElementById('currentQuestion').textContent = gameState.totalQuestions;
            document.getElementById('totalQuestions').textContent = '10';
            
            // Update progress bar
            const progressPercentage = (gameState.totalQuestions - 1) * 10;
            document.getElementById('progressFill').style.width = `${progressPercentage}%`;
            
            // Store current question for checking answer
            gameState.currentQuestion = question;
            
            // Character tip
            showCharacterSpeech("Think carefully about this question. You can do it!");
        }
        
        function checkAnswer() {
            const selectedOption = document.querySelector('.answer-option.selected');
            
            if (!selectedOption) {
                showCharacterSpeech("Please select an answer first!");
                playSound('error');
                return;
            }
            
            const selectedIndex = parseInt(selectedOption.dataset.index);
            const correctIndex = gameState.currentQuestion.correctAnswer;
            
            // Mark correct and incorrect answers
            document.querySelectorAll('.answer-option').forEach((option, index) => {
                if (index === correctIndex) {
                    option.classList.add('correct');
                } else if (index === selectedIndex && selectedIndex !== correctIndex) {
                    option.classList.add('incorrect');
                }
            });
            
            // Display feedback
            const feedbackMessage = document.getElementById('feedbackMessage');
            feedbackMessage.style.display = 'block';
            
            if (selectedIndex === correctIndex) {
                feedbackMessage.textContent = `Correct! ${gameState.currentQuestion.explanation}`;
                feedbackMessage.style.backgroundColor = 'rgba(103, 226, 111, 0.2)';
                feedbackMessage.style.border = '1px solid #67e26f';
                
                // Update score
                gameState.quizScore++;
                document.getElementById('scoreDisplay').textContent = `Score: ${gameState.quizScore}`;
                
                // Play sound and celebration
                playSound('success');
                createConfetti(10);
                
                showCharacterSpeech("Great job! That's correct!");
            } else {
                feedbackMessage.textContent = `Not quite! The correct answer is: ${gameState.currentQuestion.options[correctIndex]}. ${gameState.currentQuestion.explanation}`;
                feedbackMessage.style.backgroundColor = 'rgba(255, 107, 107, 0.2)';
                feedbackMessage.style.border = '1px solid #ff6b6b';
                
                playSound('error');
                showCharacterSpeech("That's not right. Let's learn from this and try again!");
            }
            
            // Show next question button
            document.getElementById('submitAnswer').style.display = 'none';
            document.getElementById('nextQuestion').style.display = 'block';
            
            // End quiz if reached 10 questions
            if (gameState.totalQuestions >= 10) {
                document.getElementById('nextQuestion').textContent = 'See Results';
                document.getElementById('nextQuestion').removeEventListener('click', loadQuizQuestion);
                document.getElementById('nextQuestion').addEventListener('click', showQuizResults);
            }
        }
        
        function showQuizResults() {
            // Clear question display
            document.getElementById('questionContainer').innerHTML = `
                <h2 style="text-align: center; margin-bottom: 30px;">Quiz Results</h2>
                <div style="text-align: center; font-size: 1.5rem; margin-bottom: 20px;">
                    You scored <span style="color: #4facfe; font-weight: bold;">${gameState.quizScore}</span> out of 10!
                </div>
                <div style="text-align: center; margin-bottom: 30px;">
                    ${getQuizResultMessage(gameState.quizScore)}
                </div>
                <button class="menu-button" style="margin: 0 auto;" onclick="startQuiz()">Play Again</button>
                <button class="menu-button" style="margin: 15px auto 0;" onclick="goToMainMenu()">Back to Main Menu</button>
            `;
            
            document.getElementById('quizProgress').style.display = 'none';
            document.getElementById('feedbackMessage').style.display = 'none';
            document.getElementById('quizControls').style.display = 'none';
            
            // Celebration if score is good
            if (gameState.quizScore >= 7) {
                createConfetti(50);
                playSound('success');
                
                showCharacterSpeech("Fantastic job! You're becoming a chemistry expert!");
            } else {
                showCharacterSpeech("Good effort! Keep exploring the games to learn more about chemistry!");
            }
        }
        
        function getQuizResultMessage(score) {
            if (score >= 9) {
                return "Amazing! You're a chemistry genius! üåü";
            } else if (score >= 7) {
                return "Great job! You know your elements very well! üéâ";
            } else if (score >= 5) {
                return "Good effort! Keep exploring to learn more! üëç";
            } else {
                return "Keep learning! The more you play, the better you'll get! üí™";
            }
        }
        
        // Reaction Simulator functions
        function setupReactionSimulator() {
            const canvas = document.getElementById('reactionCanvas');
            const ctx = canvas.getContext('2d');
            const reactionSelector = document.getElementById('reactionSelector');
            
            // Simulator state
            const simState = {
                particles: [],
                reactionSpeed: 1,
                animationRunning: false,
                selectedReaction: null,
                animationId: null
            };
            
            // Setup reaction selector
            reactions.forEach(reaction => {
                const card = document.createElement('div');
                card.className = 'reaction-card';
                
                card.innerHTML = `
                    <h4>${reaction.name}</h4>
                    <p>${reaction.equation}</p>
                `;
                
                card.addEventListener('click', () => {
                    simState.selectedReaction = reaction;
                    
                    // Highlight selected reaction
                    document.querySelectorAll('.reaction-card').forEach(card => {
                        card.style.boxShadow = '0 5px 15px rgba(0,0,0,0.1)';
                    });
                    card.style.boxShadow = '0 0 10px 3px rgba(0, 255, 255, 0.7)';
                    
                    resetReaction();
                    setupReaction(reaction);
                    
                    playSound('click');
                    showCharacterSpeech(`Selected ${reaction.name}! ${reaction.description}`);
                });
                
                reactionSelector.appendChild(card);
            });
            
            // Setup control buttons
            document.getElementById('startReaction').addEventListener('click', () => {
                if (!simState.selectedReaction) {
                    showCharacterSpeech("Please select a reaction first!");
                    playSound('error');
                    return;
                }
                
                if (simState.animationRunning) {
                    return;
                }
                
                startReactionAnimation();
                playSound('whoosh');
                showCharacterSpeech("Reaction started! Watch how the atoms rearrange to form new molecules!");
            });
            
            document.getElementById('resetReaction').addEventListener('click', () => {
                resetReaction();
                playSound('click');
                showCharacterSpeech("Reaction reset! You can start again.");
            });
            
            document.getElementById('slowDownReaction').addEventListener('click', () => {
                if (simState.reactionSpeed > 0.5) {
                    simState.reactionSpeed -= 0.25;
                    playSound('click');
                    showCharacterSpeech(`Slowed down! Now at ${simState.reactionSpeed}x speed.`);
                }
            });
            
            document.getElementById('speedUpReaction').addEventListener('click', () => {
                if (simState.reactionSpeed < 2) {
                    simState.reactionSpeed += 0.25;
                    playSound('click');
                    showCharacterSpeech(`Sped up! Now at ${simState.reactionSpeed}x speed.`);
                }
            });
            
            function setupReaction(reaction) {
                // Clear canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Create particles for reactants
                simState.particles = [];
                
                reaction.reactants.forEach((symbol, index) => {
                    const element = elements.find(e => e.symbol === symbol);
                    
                    // Position reactants on left side
                    const x = 100 + (index % 2) * 50;
                    const y = 150 + Math.floor(index / 2) * 80;
                    
                    simState.particles.push({
                        symbol: symbol,
                        element: element,
                        x: x,
                        y: y,
                        radius: 20,
                        velocityX: 0,
                        velocityY: 0,
                        reacted: false
                    });
                });
                
                // Draw initial state
                drawReaction();
                
                // Draw reaction equation
                ctx.font = 'bold 20px Nunito';
                ctx.fillStyle = '#333';
                ctx.textAlign = 'center';
                ctx.fillText(reaction.equation, canvas.width / 2, 50);
                
                // Draw reaction info
                ctx.font = '16px Nunito';
                ctx.fillText(reaction.description, canvas.width / 2, canvas.height - 30);
                ctx.fillText(reaction.energyChange, canvas.width / 2, canvas.height - 10);
            }
            
            function startReactionAnimation() {
                simState.animationRunning = true;
                
                // Set particles in motion
                simState.particles.forEach((particle, index) => {
                    // Move particles toward center with some randomness
                    particle.velocityX = (canvas.width / 2 - particle.x) / 100 + (Math.random() * 2 - 1);
                    particle.velocityY = (canvas.height / 2 - particle.y) / 100 + (Math.random() * 2 - 1);
                });
                
                // Start animation loop
                animate();
            }
            
            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Check if all particles have reached center
                let allAtCenter = true;
                
                simState.particles.forEach(particle => {
                    // Move particles
                    particle.x += particle.velocityX * simState.reactionSpeed;
                    particle.y += particle.velocityY * simState.reactionSpeed;
                    
                    // Check if at center (reaction zone)
                    const distFromCenter = Math.sqrt(
                        Math.pow(particle.x - canvas.width / 2, 2) + 
                        Math.pow(particle.y - canvas.height / 2, 2)
                    );
                    
                    if (distFromCenter > 50) {
                        allAtCenter = false;
                    }
                    
                    // Draw particle
                    ctx.beginPath();
                    ctx.arc(particle.x, particle.y, particle.radius, 0, Math.PI * 2);
                    ctx.fillStyle = particle.element.color;
                    ctx.fill();
                    ctx.strokeStyle = '#000';
                    ctx.lineWidth = 1;
                    ctx.stroke();
                    
                    // Draw element symbol
                    ctx.fillStyle = particle.element.color === '#FFFFFF' ? '#000' : '#FFF';
                    ctx.font = 'bold 16px Nunito';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(particle.symbol, particle.x, particle.y);
                });
                
                // Draw reaction equation
                ctx.font = 'bold 20px Nunito';
                ctx.fillStyle = '#333';
                ctx.textAlign = 'center';
                ctx.fillText(simState.selectedReaction.equation, canvas.width / 2, 50);
                
                // Draw reaction zone
                ctx.beginPath();
                ctx.arc(canvas.width / 2, canvas.height / 2, 50, 0, Math.PI * 2);
                ctx.strokeStyle = 'rgba(255, 0, 0, 0.3)';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // Transition to products if all at center
                if (allAtCenter && !simState.reacted) {
                    createReactionEffects();
                    transitionToProducts();
                    simState.reacted = true;
                    return;
                }
                
                // Continue animation if not complete
                if (simState.animationRunning) {
                    simState.animationId = requestAnimationFrame(animate);
                }
            }
            
            function createReactionEffects() {
                // Flash effect
                const overlay = document.createElement('div');
                overlay.style.position = 'absolute';
                overlay.style.top = '0';
                overlay.style.left = '0';
                overlay.style.width = '100%';
                overlay.style.height = '100%';
                overlay.style.backgroundColor = 'rgba(255, 255, 0, 0.3)';
                overlay.style.zIndex = '100';
                overlay.style.pointerEvents = 'none';
                
                document.body.appendChild(overlay);
                
                // Play sound
                playSound('explosion');
                
                // Remove overlay after flash
                setTimeout(() => {
                    document.body.removeChild(overlay);
                }, 300);
            }
            
            function transitionToProducts() {
                // Clear particles
                simState.particles = [];
                
                // Create product particles
                simState.selectedReaction.products.forEach((formula, index) => {
                    // Extract elements from formula
                    const elements = extractElementsFromFormula(formula);
                    
                    // Create a cluster of particles for the product
                    const centerX = canvas.width / 2;
                    const centerY = canvas.height / 2;
                    
                    elements.forEach((symbol, elIndex) => {
                        const element = elements.find(e => e.symbol === symbol) || elements[0];
                        
                        // Position in a cluster
                        const angle = (elIndex / elements.length) * Math.PI * 2;
                        const distance = elements.length > 1 ? 30 : 0;
                        
                        const x = centerX + Math.cos(angle) * distance;
                        const y = centerY + Math.sin(angle) * distance;
                        
                        simState.particles.push({
                            symbol: symbol,
                            element: element,
                            x: x,
                            y: y,
                            targetX: canvas.width - 100 - (index % 2) * 50,
                            targetY: 150 + Math.floor(index / 2) * 80,
                            radius: 20,
                            velocityX: 0,
                            velocityY: 0
                        });
                    });
                });
                
                // Set up motion toward right side
                simState.particles.forEach(particle => {
                    particle.velocityX = (particle.targetX - particle.x) / 100;
                    particle.velocityY = (particle.targetY - particle.y) / 100;
                });
                
                // Start product animation
                animateProducts();
            }
            
            function animateProducts() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Check if all particles have reached targets
                let allAtTarget = true;
                
                simState.particles.forEach(particle => {
                    // Move particles
                    particle.x += particle.velocityX * simState.reactionSpeed;
                    particle.y += particle.velocityY * simState.reactionSpeed;
                    
                    // Check if at target
                    const distFromTarget = Math.sqrt(
                        Math.pow(particle.x - particle.targetX, 2) + 
                        Math.pow(particle.y - particle.targetY, 2)
                    );
                    
                    if (distFromTarget > 5) {
                        allAtTarget = false;
                    }
                    
                    // Draw particle
                    ctx.beginPath();
                    ctx.arc(particle.x, particle.y, particle.radius, 0, Math.PI * 2);
                    ctx.fillStyle = particle.element.color;
                    ctx.fill();
                    ctx.strokeStyle = '#000';
                    ctx.lineWidth = 1;
                    ctx.stroke();
                    
                    // Draw element symbol
                    ctx.fillStyle = particle.element.color === '#FFFFFF' ? '#000' : '#FFF';
                    ctx.font = 'bold 16px Nunito';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(particle.symbol, particle.x, particle.y);
                });
                
                // Draw reaction equation
                ctx.font = 'bold 20px Nunito';
                ctx.fillStyle = '#333';
                ctx.textAlign = 'center';
                ctx.fillText(simState.selectedReaction.equation, canvas.width / 2, 50);
                
                // Draw reaction info
                ctx.font = '16px Nunito';
                ctx.fillText(simState.selectedReaction.description, canvas.width / 2, canvas.height - 30);
                ctx.fillText(simState.selectedReaction.energyChange, canvas.width / 2, canvas.height - 10);
                
                // End animation if complete
                if (allAtTarget) {
                    simState.animationRunning = false;
                    
                    // Draw bonds between product elements
                    drawProductBonds();
                    
                    showCharacterSpeech("Reaction complete! The atoms have rearranged to form new molecules!");
                    return;
                }
                
                // Continue animation
                simState.animationId = requestAnimationFrame(animateProducts);
            }
            
            function drawProductBonds() {
                // Group particles by product
                const productGroups = [];
                let currentGroup = [];
                
                simState.particles.forEach(particle => {
                    if (currentGroup.length === 0 || 
                        Math.sqrt(Math.pow(particle.x - currentGroup[0].x, 2) + 
                                Math.pow(particle.y - currentGroup[0].y, 2)) < 60) {
                        currentGroup.push(particle);
                    } else {
                        productGroups.push([...currentGroup]);
                        currentGroup = [particle];
                    }
                });
                
                if (currentGroup.length > 0) {
                    productGroups.push(currentGroup);
                }
                
                // Draw bonds within each group
                productGroups.forEach(group => {
                    if (group.length > 1) {
                        // Draw bonds from first element to all others
                        for (let i = 1; i < group.length; i++) {
                            ctx.beginPath();
                            ctx.moveTo(group[0].x, group[0].y);
                            ctx.lineTo(group[i].x, group[i].y);
                            ctx.strokeStyle = '#000';
                            ctx.lineWidth = 2;
                            ctx.stroke();
                        }
                    }
                });
            }
            
            function resetReaction() {
                // Stop animation
                if (simState.animationId) {
                    cancelAnimationFrame(simState.animationId);
                }
                
                simState.animationRunning = false;
                simState.reacted = false;
                
                // Reset reaction display
                if (simState.selectedReaction) {
                    setupReaction(simState.selectedReaction);
                } else {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.font = '20px Nunito';
                    ctx.fillStyle = '#333';
                    ctx.textAlign = 'center';
                    ctx.fillText('Select a reaction to begin', canvas.width / 2, canvas.height / 2);
                }
            }
            
            function drawReaction() {
                // Clear canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Draw particles
                simState.particles.forEach(particle => {
                    ctx.beginPath();
                    ctx.arc(particle.x, particle.y, particle.radius, 0, Math.PI * 2);
                    ctx.fillStyle = particle.element.color;
                    ctx.fill();
                    ctx.strokeStyle = '#000';
                    ctx.lineWidth = 1;
                    ctx.stroke();
                    
                    // Draw element symbol
                    ctx.fillStyle = particle.element.color === '#FFFFFF' ? '#000' : '#FFF';
                    ctx.font = 'bold 16px Nunito';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(particle.symbol, particle.x, particle.y);
                });
                
                // Draw reaction arrow
                ctx.beginPath();
                ctx.moveTo(canvas.width / 2 - 100, canvas.height / 2);
                ctx.lineTo(canvas.width / 2 + 100, canvas.height / 2);
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // Draw arrowhead
                ctx.beginPath();
                ctx.moveTo(canvas.width / 2 + 100, canvas.height / 2);
                ctx.lineTo(canvas.width / 2 + 90, canvas.height / 2 - 10);
                ctx.lineTo(canvas.width / 2 + 90, canvas.height / 2 + 10);
                ctx.closePath();
                ctx.fillStyle = '#333';
                ctx.fill();
            }
            
            function extractElementsFromFormula(formula) {
                // Simple formula parser (not comprehensive)
                const result = [];
                let currentElement = '';
                let currentCount = '';
                
                for (let i = 0; i < formula.length; i++) {
                    const char = formula[i];
                    
                    if (char >= 'A' && char <= 'Z') {
                        // New element starts
                        if (currentElement) {
                            // Add previous element
                            const count = currentCount ? parseInt(currentCount) : 1;
                            for (let j = 0; j < count; j++) {
                                result.push(currentElement);
                            }
                            currentElement = '';
                            currentCount = '';
                        }
                        currentElement = char;
                    } else if (char >= 'a' && char <= 'z') {
                        // Continue current element
                        currentElement += char;
                    } else if (char >= '0' && char <= '9') {
                        // Element count
                        currentCount += char;
                    }
                }
                
                // Add last element
                if (currentElement) {
                    const count = currentCount ? parseInt(currentCount) : 1;
                    for (let j = 0; j < count; j++) {
                        result.push(currentElement);
                    }
                }
                
                return result;
            }
            
            // Initial setup
            resetReaction();
        }
        
        // Experiment Lab functions
        function setupExperimentLab() {
            const canvas = document.getElementById('experimentCanvas');
            const ctx = canvas.getContext('2d');
            const labEquipment = document.getElementById('labEquipment');
            const chemicalShelf = document.getElementById('chemicalShelf');
            const experimentLog = document.getElementById('experimentLog');
            
            // Lab state
            const labState = {
                selectedEquipment: null,
                placedEquipment: [],
                selectedChemical: null,
                usedChemicals: [],
                experimentRunning: false
            };
            
            // Equipment data
            const equipment = [
                { name: 'Beaker', width: 80, height: 60, canHold: true },
                { name: 'Test Tube', width: 20, height: 80, canHold: true },
                { name: 'Bunsen Burner', width: 40, height: 60, canHeat: true },
                { name: 'Thermometer', width: 10, height: 80, canMeasure: true },
                { name: 'Stirring Rod', width: 60, height: 10, canMix: true }
            ];
            
            // Chemicals data
            const chemicals = [
                { name: 'Water (H‚ÇÇO)', color: '#a8d5ff', reactive: false },
                { name: 'Sodium (Na)', color: '#c6c6c6', reactive: true },
                { name: 'Vinegar (CH‚ÇÉCOOH)', color: '#f0f0d0', reactive: true },
                { name: 'Baking Soda (NaHCO‚ÇÉ)', color: '#ffffff', reactive: true },
                { name: 'Copper Sulfate (CuSO‚ÇÑ)', color: '#4287f5', reactive: false },
                { name: 'Phenolphthalein', color: '#ffddf0', reactive: false }
            ];
            
            // Experiment results data
            const experiments = [
                {
                    components: ['Sodium', 'Water'],
                    result: "The sodium reacts vigorously with water, producing hydrogen gas and sodium hydroxide!",
                    observation: "Bubbles form rapidly and the solution heats up. This is an exothermic reaction!"
                },
                {
                    components: ['Vinegar', 'Baking Soda'],
                    result: "The vinegar and baking soda react to produce carbon dioxide gas!",
                    observation: "Fizzing occurs as CO‚ÇÇ bubbles escape. This is the classic volcano reaction!"
                },
                {
                    components: ['Phenolphthalein', 'Baking Soda', 'Water'],
                    result: "The solution turns pink!",
                    observation: "Phenolphthalein is an indicator that turns pink in basic solutions. Baking soda in water is basic."
                }
            ];
            
            // Setup equipment selection
            equipment.forEach(item => {
                const equipmentItem = document.createElement('div');
                equipmentItem.className = 'equipment-item';
                equipmentItem.textContent = item.name;
                
                equipmentItem.addEventListener('click', () => {
                    labState.selectedEquipment = item;
                    labState.selectedChemical = null;
                    
                    // Highlight selected equipment
                    document.querySelectorAll('.equipment-item').forEach(el => {
                        el.style.boxShadow = '0 3px 10px rgba(0,0,0,0.1)';
                    });
                    equipmentItem.style.boxShadow = '0 0 8px 3px rgba(0, 255, 255, 0.7)';
                    
                    // Remove highlight from chemicals
                    document.querySelectorAll('.chemical-item').forEach(el => {
                        el.style.boxShadow = 'none';
                    });
                    
                    playSound('click');
                    showCharacterSpeech(`Selected ${item.name}! Click on the lab table to place it.`);
                });
                
                labEquipment.appendChild(equipmentItem);
            });
            
            // Setup chemical selection
            chemicals.forEach(chemical => {
                const chemicalItem = document.createElement('div');
                chemicalItem.className = 'chemical-item';
                chemicalItem.textContent = chemical.name;
                chemicalItem.style.backgroundColor = chemical.color;
                chemicalItem.style.color = chemical.color === '#ffffff' ? '#000' : '#FFF';
                
                chemicalItem.addEventListener('click', () => {
                    labState.selectedChemical = chemical;
                    labState.selectedEquipment = null;
                    
                    // Highlight selected chemical
                    document.querySelectorAll('.chemical-item').forEach(el => {
                        el.style.boxShadow = 'none';
                    });
                    chemicalItem.style.boxShadow = '0 0 8px 3px rgba(0, 255, 255, 0.7)';
                    
                    // Remove highlight from equipment
                    document.querySelectorAll('.equipment-item').forEach(el => {
                        el.style.boxShadow = '0 3px 10px rgba(0,0,0,0.1)';
                    });
                    
                    playSound('click');
                    showCharacterSpeech(`Selected ${chemical.name}! Click on a container to add it.`);
                });
                
                chemicalShelf.appendChild(chemicalItem);
            });
            
            // Canvas click event
            canvas.addEventListener('click', (e) => {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                if (labState.selectedEquipment) {
                    // Place equipment
                    labState.placedEquipment.push({
                        equipment: labState.selectedEquipment,
                        x: x - labState.selectedEquipment.width / 2,
                        y: y - labState.selectedEquipment.height / 2,
                        chemicals: []
                    });
                    
                    drawLab();
                    playSound('pop');
                    addLogEntry(`Placed ${labState.selectedEquipment.name} on the table.`);
                } else if (labState.selectedChemical) {
                    // Find if clicked on a container
                    const container = labState.placedEquipment.find(item => {
                        return item.equipment.canHold && 
                               x >= item.x && x <= item.x + item.equipment.width &&
                               y >= item.y && y <= item.y + item.equipment.height;
                    });
                    
                    if (container) {
                        // Add chemical to container
                        container.chemicals.push(labState.selectedChemical);
                        labState.usedChemicals.push(labState.selectedChemical.name);
                        
                        drawLab();
                        playSound('splash');
                        addLogEntry(`Added ${labState.selectedChemical.name} to the ${container.equipment.name}.`);
                        
                        // Check for reaction based on chemicals in this container
                        checkReactions(container);
                    } else {
                        playSound('error');
                        showCharacterSpeech("You need to add chemicals to a container like a beaker or test tube!");
                    }
                
                