<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Long Division Adventures</title>
    <style>
        /* Base styles with colorful theme for children */
        body {
            font-family: 'Comic Sans MS', sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #c2e9fb 0%, #a1c4fd 100%);
            color: #333;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            display: flex;
        }
        
        /* Main content area with division problem */
        .math-area {
            flex: 1;
            padding-right: 20px;
        }
        
        /* Instruction area on the right */
        .instruction-area {
            width: 300px;
            border-left: 2px dashed #5b6afd;
            padding-left: 20px;
            position: relative;
        }
        
        /* Header & Game Info */
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .game-title {
            color: #5b6afd;
            font-size: 32px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        .game-info {
            display: flex;
            gap: 20px;
        }
        
        .score, .level {
            background-color: #5b6afd;
            color: white;
            padding: 10px 20px;
            border-radius: 50px;
            font-size: 18px;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        /* Division Problem Area */
        .division-problem {
            position: relative;
            margin: 80px auto 60px;
            max-width: 500px;
        }
        
        /* Proper division symbol styling */
        .division-symbol {
            position: relative;
            display: flex;
            font-family: monospace;
            font-size: 40px;
        }
        
        /* The "bracket" part of long division symbol */
        .long-division-symbol {
            position: relative;
            width: 10px;
            margin-right: 20px;
        }
        
        .long-division-symbol::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 3px;
            background-color: #5b6afd;
        }
        
        .long-division-symbol::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            height: 3px;
            width: 30px;
            background-color: #5b6afd;
        }
        
        /* Number display */
        .divisor {
            position: absolute;
            left: -40px;
            top: 10px;
            font-size: 40px;
            color: #ff7979;
            font-weight: bold;
        }
        
        .dividend-container {
            display: flex;
            margin-top: 10px;
        }
        
        .dividend-digit {
            width: 40px;
            height: 50px;
            text-align: center;
            color: #ff7979;
            font-weight: bold;
            margin-right: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Quotient display at top */
        .quotient-container {
            display: flex;
            position: absolute;
            top: -60px;
            left: 30px;
        }
        
        .quotient-digit {
            width: 45px;
            height: 45px;
            margin-right: 5px;
            transition: all 0.3s ease;
        }
        
        .quotient-input {
            width: 42px;
            height: 42px;
            font-size: 32px;
            text-align: center;
            border: 3px solid #5b6afd;
            border-radius: 10px;
            background-color: #f0f8ff;
            color: #5b6afd;
            font-family: monospace;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .quotient-input:focus {
            outline: none;
            box-shadow: 0 0 10px 4px rgba(91, 106, 253, 0.4);
            transform: scale(1.05);
        }
        
        .quotient-input.highlight {
            animation: pulse 1s infinite;
            border-color: gold;
            box-shadow: 0 0 15px 5px rgba(255, 215, 0, 0.5);
        }
        
        /* Work area display */
        .work-area {
            font-family: monospace;
            font-size: 36px;
            margin-top: 20px;
            color: #5b6afd;
            position: relative;
            min-height: 200px;
        }
        
        .work-step {
            display: flex;
            margin-top: 5px;
            position: relative;
        }
        
        .work-row {
            display: flex;
        }
        
        .work-digit {
            width: 40px;
            height: 45px;
            text-align: center;
            margin-right: 5px;
            padding-left: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .subtraction-line {
            height: 2px;
            background-color: #5b6afd;
            margin: 5px 0;
            padding-left: 30px;
        }
        
        /* Current step input */
        .current-step {
            display: flex;
            margin-top: 30px;
            align-items: center;
            background-color: rgba(91, 106, 253, 0.1);
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        
        .step-prompt {
            font-size: 20px;
            font-weight: bold;
            margin-right: 15px;
            color: #5b6afd;
            text-shadow: 1px 1px 1px rgba(255,255,255,0.8);
        }
        
        .step-input-container {
            display: flex;
        }
        
        .step-input {
            width: 40px;
            height: 40px;
            font-size: 30px;
            text-align: center;
            border: 2px solid #5b6afd;
            border-radius: 8px;
            margin-right: 5px;
            background-color: #f0f8ff;
            color: #5b6afd;
            font-family: monospace;
        }
        
        .step-input:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(91, 106, 253, 0.3);
        }
        
        /* Bring down animation */
        @keyframes bringDown {
            0% { transform: translateY(-20px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }
        
        .bringing-down {
            animation: bringDown 0.5s ease-out forwards;
        }
        
        /* Navigation buttons */
        .navigation {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }
        
        .nav-button {
            padding: 12px 30px;
            font-size: 18px;
            font-weight: bold;
            background-color: #5b6afd;
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .nav-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 10px rgba(0,0,0,0.2);
        }
        
        .nav-button:active {
            transform: translateY(1px);
            box-shadow: 0 2px 3px rgba(0,0,0,0.2);
        }
        
        .nav-button:disabled {
            background-color: #a1a5c9;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .help-button {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background-color: #5b6afd;
            color: white;
            font-size: 24px;
            font-weight: bold;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        /* Feedback area */
        .feedback {
            text-align: center;
            font-size: 24px;
            margin: 20px 0;
            min-height: 30px;
            transition: all 0.3s ease;
        }
        
        .feedback.correct {
            color: #2ecc71;
        }
        
        .feedback.incorrect {
            color: #e74c3c;
        }
        
        /* Instructions in the right panel */
        .instruction-panel {
            background-color: #f0f8ff;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        
        .instruction-title {
            color: #5b6afd;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .instruction-step {
            margin-bottom: 10px;
            display: flex;
            align-items: flex-start;
        }
        
        .step-number {
            background-color: #5b6afd;
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            flex-shrink: 0;
        }
        
        .step-text {
            flex: 1;
        }
        
        .current-instruction {
            background-color: rgba(91, 106, 253, 0.2);
            border-left: 4px solid #5b6afd;
            padding: 10px;
            border-radius: 0 10px 10px 0;
            font-weight: bold;
        }
        
        /* Animations */
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        .celebrating {
            animation: pulse 0.5s ease infinite;
        }
        
        /* Confetti animation */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background-color: #f0f;
            clip-path: polygon(50% 0%, 90% 20%, 100% 60%, 75% 100%, 25% 100%, 0% 60%, 10% 20%);
            animation: fall 5s linear forwards;
            z-index: 1000;
        }
        
        @keyframes fall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
        }
        
        .red { background-color: #ff5252; }
        .blue { background-color: #5b6afd; }
        .green { background-color: #2ecc71; }
        .yellow { background-color: #f1c40f; }
        .purple { background-color: #9b59b6; }
        
        /* Award badges */
        .awards {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }
        
        .award {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            opacity: 0.3;
            transition: all 0.3s ease;
        }
        
        .award.earned {
            opacity: 1;
            background-color: gold;
            animation: pulse 0.5s ease;
        }
        
        /* Help modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 600px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        .modal-title {
            font-size: 24px;
            color: #5b6afd;
            margin-bottom: 20px;
        }
        
        .close-button {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 24px;
            cursor: pointer;
            color: #5b6afd;
        }
        
        /* Tutorial step highlight */
        .highlight {
            box-shadow: 0 0 10px 3px gold;
            animation: pulse 1s infinite;
        }
        
        /* Responsive design */
        @media (max-width: 900px) {
            .container {
                flex-direction: column;
            }
            
            .math-area {
                padding-right: 0;
            }
            
            .instruction-area {
                width: auto;
                border-left: none;
                border-top: 2px dashed #5b6afd;
                padding-left: 0;
                padding-top: 20px;
                margin-top: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Main game container -->
    <div class="container">
        <!-- Left side - Math area -->
        <div class="math-area">
            <!-- Game header with title and score -->
            <div class="game-header">
                <div class="game-title">Long Division Adventures</div>
                <div class="game-info">
                    <div class="level">Level: <span id="level">1</span></div>
                    <div class="score">Score: <span id="score">0</span></div>
                </div>
            </div>
            
            <!-- Division problem display -->
            <div class="division-problem">
                <div class="division-symbol">
                    <div class="divisor" id="divisor">2</div>
                    <div class="long-division-symbol"></div>
                    <div class="quotient-container" id="quotient-container">
                        <!-- Quotient inputs will be generated here -->
                    </div>
                    <div class="dividend-container" id="dividend-container">
                        <!-- Dividend digits will be displayed here -->
                    </div>
                </div>
                
                <!-- Work area to display steps -->
                <div class="work-area" id="work-area"></div>
                
                <!-- Current step input -->
                <div class="current-step" id="current-step">
                    <div class="step-prompt" id="step-prompt">Multiply the divisor by your answer:</div>
                    <div class="step-input-container" id="step-input-container">
                        <!-- Step inputs will be generated here -->
                    </div>
                </div>
            </div>
            
            <!-- Feedback display -->
            <div class="feedback" id="feedback"></div>
            
            <!-- Navigation buttons -->
            <div class="navigation">
                <button class="nav-button" id="prev-button">Previous</button>
                <button class="nav-button" id="check-button">Check</button>
                <button class="nav-button" id="next-button">Next</button>
                <button class="nav-button" id="new-problem-button">New Problem</button>
            </div>
            
            <!-- Achievement badges -->
            <div class="awards">
                <div class="award" id="award-speed" title="Speed Solver">‚ö°</div>
                <div class="award" id="award-streak" title="Streak Master">üî•</div>
                <div class="award" id="award-perfect" title="Perfect Solution">üåü</div>
                <div class="award" id="award-level" title="Level Master">üèÜ</div>
            </div>
        </div>
        
        <!-- Right side - Instruction area -->
        <div class="instruction-area">
            <!-- Help button -->
            <button class="help-button" id="help-button">?</button>
            
            <div class="instruction-panel">
                <div class="instruction-title">How to Solve Long Division</div>
                <div class="instruction-steps" id="instruction-steps">
                    <div class="instruction-step">
                        <div class="step-number">1</div>
                        <div class="step-text">Divide the first digit(s) of the dividend by the divisor</div>
                    </div>
                    <div class="instruction-step">
                        <div class="step-number">2</div>
                        <div class="step-text">Multiply your answer by the divisor</div>
                    </div>
                    <div class="instruction-step">
                        <div class="step-number">3</div>
                        <div class="step-text">Subtract this product from the dividend digits</div>
                    </div>
                    <div class="instruction-step">
                        <div class="step-number">4</div>
                        <div class="step-text">Bring down the next digit</div>
                    </div>
                    <div class="instruction-step">
                        <div class="step-number">5</div>
                        <div class="step-text">Repeat until you finish all digits</div>
                    </div>
                </div>
            </div>
            
            <div class="instruction-panel">
                <div class="instruction-title">Current Step Instructions</div>
                <div id="current-instruction" class="current-instruction">
                    Look at the first digit(s) of the dividend. How many times does the divisor go into it?
                </div>
            </div>
            
            <div class="instruction-panel">
                <div class="instruction-title">Tips & Tricks</div>
                <ul>
                    <li>Press Enter to check your answer</li>
                    <li>Press Space for a new problem when done</li>
                    <li>If you're stuck, try a smaller number first</li>
                    <li>Remember: the remainder must be smaller than the divisor</li>
                </ul>
            </div>
        </div>
    </div>
    
    <!-- Help modal -->
    <div class="modal" id="help-modal">
        <div class="modal-content">
            <div class="modal-title">How to Play Long Division Adventures</div>
            <span class="close-button" id="close-button">&times;</span>
            <p>Welcome to Long Division Adventures! Here's how to play:</p>
            <ol>
                <li>Look at the division problem. The number inside the bracket is called the divisor, and the number to the right is the dividend.</li>
                <li>Think about how many times the divisor goes into the first digit(s) of the dividend. Type your answer in the top box.</li>
                <li>Multiply your answer by the divisor and type it in the step input boxes.</li>
                <li>Click "Check" to see if you're correct.</li>
                <li>Continue with the next steps until you complete the division.</li>
                <li>Earn stars and badges for being fast and accurate!</li>
            </ol>
            <p>Need help? Just click the "?" button anytime!</p>
            <button class="nav-button" id="start-tutorial">Start Tutorial</button>
        </div>
    </div>

    <script>
        class LongDivisionGame {
            constructor() {
                // Game state
                this.score = 0;
                this.level = 1;
                this.streak = 0;
                this.divisor = 2;
                this.dividend = 1254110;
                this.currentStep = 0;
                this.currentSubStep = 0; // 0: quotient, 1: multiply, 2: subtract, 3: bring down
                this.steps = [];
                this.solution = [];
                this.quotientInputs = [];
                this.stepInputs = [];
                this.tutorialMode = false;
                this.autoCheckEnabled = true; // Auto-checking enabled by default
                this.awards = {
                    speed: false,
                    streak: false,
                    perfect: false,
                    level: false
                };
                
                // Timing for speed award
                this.startTime = null;
                
                // Get DOM elements
                this.elements = {
                    divisor: document.getElementById('divisor'),
                    dividendContainer: document.getElementById('dividend-container'),
                    quotientContainer: document.getElementById('quotient-container'),
                    workArea: document.getElementById('work-area'),
                    feedback: document.getElementById('feedback'),
                    score: document.getElementById('score'),
                    level: document.getElementById('level'),
                    prevButton: document.getElementById('prev-button'),
                    checkButton: document.getElementById('check-button'),
                    nextButton: document.getElementById('next-button'),
                    newProblemButton: document.getElementById('new-problem-button'),
                    awardSpeed: document.getElementById('award-speed'),
                    awardStreak: document.getElementById('award-streak'),
                    awardPerfect: document.getElementById('award-perfect'),
                    awardLevel: document.getElementById('award-level'),
                    helpButton: document.getElementById('help-button'),
                    modal: document.getElementById('help-modal'),
                    closeButton: document.getElementById('close-button'),
                    startTutorial: document.getElementById('start-tutorial'),
                    stepPrompt: document.getElementById('step-prompt'),
                    stepInputContainer: document.getElementById('step-input-container'),
                    currentStep: document.getElementById('current-step'),
                    currentInstruction: document.getElementById('current-instruction'),
                    instructionSteps: document.getElementById('instruction-steps')
                };
                
                // Initialize the game
                this.setupEventListeners();
                this.showHelp(); // Show help on first load
                this.generateProblem();
            }
            
            // Setup event listeners for buttons and inputs
            setupEventListeners() {
                this.elements.prevButton.addEventListener('click', () => this.navigateToPreviousStep());
                this.elements.checkButton.addEventListener('click', () => this.checkCurrentStep());
                this.elements.nextButton.addEventListener('click', () => this.navigateToNextStep());
                this.elements.newProblemButton.addEventListener('click', () => this.generateProblem());
                this.elements.helpButton.addEventListener('click', () => this.showHelp());
                this.elements.closeButton.addEventListener('click', () => this.closeHelp());
                this.elements.startTutorial.addEventListener('click', () => this.startTutorial());
                
                // Add keyboard support for the whole game
                document.addEventListener('keydown', (e) => {
                    // Enter key - check answer (same as clicking "Check" button)
                    if (e.key === 'Enter') {
                        this.checkCurrentStep();
                    }
                    // Space key - start new problem (when problem is complete)
                    else if (e.key === ' ' && this.currentStep >= this.solution.length) {
                        this.generateProblem();
                    }
                });
                
                // Add button hover effects
                const buttons = document.querySelectorAll('.nav-button');
                buttons.forEach(button => {
                    button.addEventListener('mouseenter', () => {
                        if (!button.disabled) {
                            button.style.transform = 'translateY(-3px)';
                            button.style.boxShadow = '0 7px 10px rgba(0,0,0,0.2)';
                        }
                    });
                    button.addEventListener('mouseleave', () => {
                        if (!button.disabled) {
                            button.style.transform = '';
                            button.style.boxShadow = '';
                        }
                    });
                });
                
                // Disable the previous button initially
                this.elements.prevButton.disabled = true;
                this.elements.nextButton.disabled = true;
            }
            
            // Show help modal
            showHelp() {
                this.elements.modal.style.display = 'flex';
            }
            
            // Close help modal
            closeHelp() {
                this.elements.modal.style.display = 'none';
            }
            
            // Start tutorial mode
            startTutorial() {
                this.tutorialMode = true;
                this.closeHelp();
                this.generateProblem(true); // Generate a simple problem for tutorial
                
                // Highlight the divisor
                this.elements.divisor.classList.add('highlight');
                this.elements.feedback.textContent = "This is the divisor - the number we're dividing by";
                this.elements.currentInstruction.textContent = "The divisor is the number we're dividing by";
                
                // Create a sequence of tutorial steps
                setTimeout(() => {
                    this.elements.divisor.classList.remove('highlight');
                    this.elements.dividendContainer.classList.add('highlight');
                    this.elements.feedback.textContent = "This is the dividend - the number we're dividing";
                    this.elements.currentInstruction.textContent = "The dividend is the number we're dividing";
                    
                    setTimeout(() => {
                        this.elements.dividendContainer.classList.remove('highlight');
                        this.elements.quotientContainer.classList.add('highlight');
                        this.elements.feedback.textContent = "Let's fill in the quotient - how many times does the divisor go into each part of the dividend?";
                        this.elements.currentInstruction.textContent = "How many times does the divisor go into the first part of the dividend?";
                        
                        setTimeout(() => {
                            this.elements.quotientContainer.classList.remove('highlight');
                            this.elements.currentStep.classList.add('highlight');
                            this.elements.feedback.textContent = "Now enter the product (divisor √ó your answer)";
                            this.elements.currentInstruction.textContent = "Multiply the divisor by your answer to get the product";
                            
                            setTimeout(() => {
                                this.elements.currentStep.classList.remove('highlight');
                                this.elements.checkButton.classList.add('highlight');
                                this.elements.feedback.textContent = "Click 'Check' to see if you're right";
                                this.elements.currentInstruction.textContent = "Check your answer by clicking the Check button";
                                
                                setTimeout(() => {
                                    this.elements.checkButton.classList.remove('highlight');
                                    this.elements.feedback.textContent = "Try solving the problem! Check the right side for help.";
                                    this.updateCurrentInstruction();
                                }, 3000);
                            }, 5000);
                        }, 5000);
                    }, 3000);
                }, 3000);
            }
            
            // Generate a new division problem
            generateProblem(isTutorial = false) {
                // Reset button states
                this.elements.prevButton.disabled = true;
                this.elements.nextButton.disabled = true;
                
                // Set divisor based on level (increase difficulty with level)
                if (isTutorial) {
                    this.divisor = 2;
                    this.dividend = 426; // Simple 3-digit number for tutorial
                } else {
                    this.divisor = Math.min(2 + Math.floor(this.level / 2), 9);
                    
                    // Generate a dividend with digits appropriate for the level
                    const digits = 3 + Math.min(this.level, 5);
                    let dividend = '';
                    
                    for (let i = 0; i < digits; i++) {
                        dividend += Math.floor(Math.random() * 10).toString();
                    }
                    
                    // Make sure first digit isn't 0
                    if (dividend[0] === '0') {
                        dividend = (parseInt(dividend[0]) + 1) + dividend.substring(1);
                    }
                    
                    this.dividend = parseInt(dividend);
                }
                
                // Update display
                this.elements.divisor.textContent = this.divisor;
                
                // Clear previous dividend
                this.elements.dividendContainer.innerHTML = '';
                
                // Create dividend digits display
                const dividendStr = this.dividend.toString();
                for (let i = 0; i < dividendStr.length; i++) {
                    const digitDiv = document.createElement('div');
                    digitDiv.className = 'dividend-digit';
                    digitDiv.textContent = dividendStr[i];
                    this.elements.dividendContainer.appendChild(digitDiv);
                }
                
                // Clear previous quotient
                this.elements.quotientContainer.innerHTML = '';
                this.quotientInputs = [];
                
                // Create quotient input boxes
                for (let i = 0; i < dividendStr.length; i++) {
                    const digitDiv = document.createElement('div');
                    digitDiv.className = 'quotient-digit';
                    
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'quotient-input';
                    input.maxLength = 1;
                    input.dataset.position = i;
                    
                    // Only allow numbers
                    input.addEventListener('input', (e) => {
                        e.target.value = e.target.value.replace(/\D/g, '');
                        if (e.target.value) {
                            const nextInput = document.querySelector(`.quotient-input[data-position="${parseInt(e.target.dataset.position) + 1}"]`);
                            if (nextInput) nextInput.focus();
                        }
                    });
                    
                    // Add keydown event for better keyboard navigation
                    input.addEventListener('keydown', (e) => {
                        // Left arrow key
                        if (e.key === 'ArrowLeft') {
                            const prevInput = document.querySelector(`.quotient-input[data-position="${parseInt(e.target.dataset.position) - 1}"]`);
                            if (prevInput) prevInput.focus();
                        }
                        // Right arrow key
                        else if (e.key === 'ArrowRight') {
                            const nextInput = document.querySelector(`.quotient-input[data-position="${parseInt(e.target.dataset.position) + 1}"]`);
                            if (nextInput) nextInput.focus();
                        }
                    });
                    
                    digitDiv.appendChild(input);
                    this.elements.quotientContainer.appendChild(digitDiv);
                    this.quotientInputs.push(input);
                }
                
                // Calculate the solution
                this.calculateSolution();
                
                // Reset game state
                this.currentStep = 0;
                this.currentSubStep = 0;
                this.steps = [];
                this.elements.workArea.innerHTML = '';
                this.elements.feedback.textContent = '';
                this.elements.feedback.className = 'feedback';
                
                // Update instruction in the right panel
                this.updateCurrentInstruction();
                
                // Create input for first step
                this.updateStepInputs();
                
                // Start the timer for speed award
                this.startTime = new Date().getTime();
                
                // Reset perfect solution tracker
                this.perfectSolution = true;
                
                // Focus on first quotient input
                if (this.quotientInputs.length > 0) {
                    setTimeout(() => this.quotientInputs[0].focus(), 100);
                }
            }
            
            // Update the current instruction based on the current sub-step
            updateCurrentInstruction() {
                if (this.currentStep >= this.solution.length) {
                    this.elements.currentInstruction.textContent = "Great job! You've completed the division. Try a new problem!";
                    return;
                }
                
                const currentSolution = this.solution[this.currentStep];
                
                // Remove 'current-instruction' class from all instruction steps
                const steps = this.elements.instructionSteps.querySelectorAll('.instruction-step');
                steps.forEach(step => {
                    step.classList.remove('current-instruction');
                });
                
                // Highlight the current instruction step
                if (steps[this.currentSubStep]) {
                    steps[this.currentSubStep].classList.add('current-instruction');
                }
                
                // Update detailed instruction text
                if (this.currentSubStep === 0) {
                    const workingNumber = currentSolution.subtractFrom.toString();
                    this.elements.currentInstruction.textContent = 
                        `How many times does ${this.divisor} go into ${workingNumber}? Enter this digit in the quotient.`;
                } else if (this.currentSubStep === 1) {
                    this.elements.currentInstruction.textContent = 
                        `Multiply ${this.divisor} √ó ${currentSolution.quotientDigit} = ${currentSolution.product}. Enter the product.`;
                } else if (this.currentSubStep === 2) {
                    this.elements.currentInstruction.textContent = 
                        `Subtract ${currentSolution.subtractFrom} - ${currentSolution.product} = ${currentSolution.remainder}. Enter the remainder.`;
                } else if (this.currentSubStep === 3) {
                    if (currentSolution.bringDown !== null) {
                        this.elements.currentInstruction.textContent = 
                            `Bring down the next digit (${currentSolution.bringDown}) to continue the division.`;
                    } else {
                        this.elements.currentInstruction.textContent = 
                            "Division is complete! The final answer is in the quotient.";
                    }
                }
            }
            
            // Calculate the solution for the division problem
            calculateSolution() {
                this.solution = [];
                let workingNumber = '';
                let dividend = this.dividend.toString();
                let quotient = '';
                let position = 0;
                
                for (let i = 0; i < dividend.length; i++) {
                    workingNumber += dividend[i];
                    let num = parseInt(workingNumber);
                    
                    if (num >= this.divisor) {
                        let quotientDigit = Math.floor(num / this.divisor);
                        let product = quotientDigit * this.divisor;
                        let remainder = num % this.divisor;
                        
                        quotient += quotientDigit.toString();
                        
                        this.solution.push({
                            position: position,
                            quotientDigit: quotientDigit,
                            subtractFrom: num,
                            product: product,
                            remainder: remainder,
                            bringDown: i < dividend.length - 1 ? dividend[i+1] : null
                        });
                        
                        position = i + 1;
                        workingNumber = remainder.toString();
                    } else if (workingNumber === '0' || i > 0) {
                        quotient += '0';
                    }
                }
                
                console.log('Solution:', this.solution);
            }
            
            // Update the step input boxes based on current step
            updateStepInputs() {
                // Clear previous inputs
                this.elements.stepInputContainer.innerHTML = '';
                this.stepInputs = [];
                
                if (this.currentStep >= this.solution.length) {
                    this.elements.stepPrompt.textContent = "Division complete!";
                    return;
                }
                
                const currentSolution = this.solution[this.currentStep];
                
                // Update prompt based on current sub-step
                if (this.currentSubStep === 0) {
                    this.elements.stepPrompt.textContent = "Enter the quotient digit:";
                    
                    // No need to create an input here - we'll use the quotient input at the top instead
                    // Just highlight the current quotient input to show where to type
                    const currentQuotientInput = this.quotientInputs[currentSolution.position];
                    if (currentQuotientInput) {
                        currentQuotientInput.classList.add('highlight');
                        setTimeout(() => currentQuotientInput.focus(), 100);
                        
                        // Add auto-check event listener
                        if (this.autoCheckEnabled) {
                            const autoCheckHandler = (e) => {
                                if (e.target.value) {
                                    // Remove the event listener first to prevent multiple triggers
                                    e.target.removeEventListener('input', autoCheckHandler);
                                    this.checkCurrentStep();
                                }
                            };
                            currentQuotientInput.addEventListener('input', autoCheckHandler);
                        }
                    }
                    
                } else if (this.currentSubStep === 1) {
                    this.elements.stepPrompt.textContent = `Multiply ${this.divisor} √ó ${currentSolution.quotientDigit} =`;
                    
                    // Create inputs for product digits
                    const productStr = currentSolution.product.toString();
                    for (let i = 0; i < productStr.length; i++) {
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.className = 'step-input';
                        input.maxLength = 1;
                        input.dataset.position = i;
                        
                        input.addEventListener('input', (e) => {
                            e.target.value = e.target.value.replace(/\D/g, '');
                            if (e.target.value) {
                                const nextInput = document.querySelector(`.step-input[data-position="${parseInt(e.target.dataset.position) + 1}"]`);
                                if (nextInput) {
                                    nextInput.focus();
                                } else if (this.autoCheckEnabled && i === productStr.length - 1) {
                                    // Auto-check when the last digit is entered
                                    this.checkCurrentStep();
                                }
                            }
                        });
                        
                        this.elements.stepInputContainer.appendChild(input);
                        this.stepInputs.push(input);
                    }
                    
                    setTimeout(() => this.stepInputs[0].focus(), 100);
                    
                } else if (this.currentSubStep === 2) {
                    this.elements.stepPrompt.textContent = `Subtract and find remainder:`;
                    
                    // Create inputs for remainder digits
                    const remainderStr = currentSolution.remainder.toString();
                    for (let i = 0; i < remainderStr.length; i++) {
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.className = 'step-input';
                        input.maxLength = 1;
                        input.dataset.position = i;
                        
                        input.addEventListener('input', (e) => {
                            e.target.value = e.target.value.replace(/\D/g, '');
                            if (e.target.value) {
                                const nextInput = document.querySelector(`.step-input[data-position="${parseInt(e.target.dataset.position) + 1}"]`);
                                if (nextInput) {
                                    nextInput.focus();
                                } else if (this.autoCheckEnabled && i === remainderStr.length - 1) {
                                    // Auto-check when the last digit is entered
                                    this.checkCurrentStep();
                                }
                            }
                        });
                        
                        this.elements.stepInputContainer.appendChild(input);
                        this.stepInputs.push(input);
                    }
                    
                    setTimeout(() => this.stepInputs[0].focus(), 100);
                    
                } else if (this.currentSubStep === 3) {
                    if (currentSolution.bringDown !== null) {
                        this.elements.stepPrompt.textContent = `Bring down the next digit:`;
                        
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.className = 'step-input';
                        input.maxLength = 1;
                        
                        input.addEventListener('input', (e) => {
                            e.target.value = e.target.value.replace(/\D/g, '');
                            if (e.target.value && this.autoCheckEnabled) {
                                // Auto-check when digit is entered
                                this.checkCurrentStep();
                            }
                        });
                        
                        this.elements.stepInputContainer.appendChild(input);
                        this.stepInputs.push(input);
                        setTimeout(() => input.focus(), 100);
                    } else {
                        // No more digits to bring down, division is complete
                        this.currentSubStep = 0;
                        this.elements.stepPrompt.textContent = "Division complete!";
                        this.completeLevel();
                    }
                }
                
                // Update instruction in right panel
                this.updateCurrentInstruction();
            }
            
            // Check the current step
            checkCurrentStep() {
                if (this.currentStep >= this.solution.length) {
                    return;
                }
                
                const currentSolution = this.solution[this.currentStep];
                let isCorrect = false;
                let inputValue = '';
                
                // Check based on current sub-step
                if (this.currentSubStep === 0) {
                    // Get value from quotient input
                    const currentQuotientInput = this.quotientInputs[currentSolution.position];
                    inputValue = currentQuotientInput.value;
                    
                    // Remove highlight
                    currentQuotientInput.classList.remove('highlight');
                    
                    // Check quotient digit
                    isCorrect = parseInt(inputValue) === currentSolution.quotientDigit;
                    
                    if (isCorrect) {
                        // Play success sound
                        this.playSound('correct');
                        
                        // Move to next sub-step
                        this.currentSubStep = 1;
                        this.updateStepInputs();
                        
                        // Show success feedback with animation
                        this.showFeedback('Correct! Now multiply.', true);
                    }
                } else if (this.currentSubStep === 1) {
                    // Get the value from step inputs
                    this.stepInputs.forEach(input => {
                        inputValue += input.value;
                    });
                    
                    // Check multiplication
                    isCorrect = parseInt(inputValue) === currentSolution.product;
                    
                    if (isCorrect) {
                        // Play success sound
                        this.playSound('correct');
                        
                        // Show multiplication step in work area with animation
                        this.showMultiplicationStep(currentSolution);
                        
                        // Move to next sub-step
                        this.currentSubStep = 2;
                        this.updateStepInputs();
                        
                        // Show success feedback with animation
                        this.showFeedback('Correct! Now subtract.', true);
                    }
                } else if (this.currentSubStep === 2) {
                    // Get the value from step inputs
                    this.stepInputs.forEach(input => {
                        inputValue += input.value;
                    });
                    
                    // Check subtraction/remainder
                    isCorrect = parseInt(inputValue) === currentSolution.remainder;
                    
                    if (isCorrect) {
                        // Play success sound
                        this.playSound('correct');
                        
                        // Show subtraction result in work area with animation
                        this.showSubtractionStep(currentSolution);
                        
                        // Move to next sub-step
                        this.currentSubStep = 3;
                        this.updateStepInputs();
                        
                        // Show success feedback
                        if (currentSolution.bringDown !== null) {
                            this.showFeedback('Correct! Now bring down the next digit.', true);
                        } else {
                            this.showFeedback('Correct! Division complete!', true);
                        }
                    }
                } else if (this.currentSubStep === 3) {
                    // Get the value from step inputs
                    this.stepInputs.forEach(input => {
                        inputValue += input.value;
                    });
                    
                    // Check bring down
                    isCorrect = inputValue === currentSolution.bringDown;
                    
                    if (isCorrect) {
                        // Play success sound
                        this.playSound('correct');
                        
                        // Show bring down in work area with animation
                        this.showBringDownStep(currentSolution);
                        
                        // Prepare for next step
                        this.currentStep++;
                        this.currentSubStep = 0;
                        
                        // Enable previous button
                        this.elements.prevButton.disabled = false;
                        
                        // Update step inputs for new step
                        if (this.currentStep < this.solution.length) {
                            this.updateStepInputs();
                            // Show success feedback with animation
                            this.showFeedback('Good job! Continue with the next step.', true);
                        } else {
                            // Division is complete
                            this.completeLevel();
                        }
                    }
                }
                
                if (!isCorrect) {
                    // Play error sound
                    this.playSound('incorrect');
                    
                    // Show error feedback with animation
                    this.showFeedback('Try again! ü§î', false);
                    
                    // Mark as not perfect solution
                    this.perfectSolution = false;
                    
                    // Shake the input(s) to indicate error
                    if (this.currentSubStep === 0) {
                        // Shake quotient input
                        const currentQuotientInput = this.quotientInputs[currentSolution.position];
                        if (currentQuotientInput) {
                            currentQuotientInput.style.animation = 'none';
                            setTimeout(() => {
                                currentQuotientInput.style.animation = 'shake 0.5s';
                                currentQuotientInput.focus();
                            }, 10);
                        }
                    } else {
                        // Shake step inputs
                        this.stepInputs.forEach(input => {
                            input.style.animation = 'none';
                            setTimeout(() => {
                                input.style.animation = 'shake 0.5s';
                            }, 10);
                        });
                        // Focus on the first empty input
                        for (let i = 0; i < this.stepInputs.length; i++) {
                            if (!this.stepInputs[i].value) {
                                setTimeout(() => this.stepInputs[i].focus(), 500);
                                break;
                            }
                        }
                    }
                }
            }
            
            // Show feedback with animation
            showFeedback(message, isCorrect) {
                this.elements.feedback.textContent = message;
                this.elements.feedback.className = isCorrect ? 'feedback correct' : 'feedback incorrect';
                
                // Add animation
                this.elements.feedback.style.animation = 'none';
                setTimeout(() => {
                    this.elements.feedback.style.animation = 'bounce 0.5s';
                }, 10);
            }
            
            // Play sound effects
            playSound(type) {
                try {
                    // Create audio element
                    const audio = new Audio();
                    
                    if (type === 'correct') {
                        audio.src = 'data:audio/mp3;base64,SUQzAwAAAAAAJlRQRTEAAAAcAAAAU291bmRKYXkuY29tIFNvdW5kIEVmZmVjdHNUWFhYAAAAEwAAAw=='; // Short success sound
                    } else if (type === 'incorrect') {
                        audio.src = 'data:audio/mp3;base64,SUQzAwAAAAAAJlRQRTEAAAAcAAAAU291bmRKYXkuY29tIFNvdW5kIEVmZmVjdHNUWFhYAAAAEwAAAw=='; // Short error sound
                    } else if (type === 'levelUp') {
                        audio.src = 'data:audio/mp3;base64,SUQzAwAAAAAAJlRQRTEAAAAcAAAAU291bmRKYXkuY29tIFNvdW5kIEVmZmVjdHNUWFhYAAAAEwAAAw=='; // Level up sound
                    }
                    
                    // Play the sound
                    audio.play().catch(e => console.log('Audio play failed:', e));
                } catch (error) {
                    console.log('Sound playback error:', error);
                    // Continue game even if sound fails
                }
            }
            
            // Show multiplication step in work area
            showMultiplicationStep(step) {
                const stepContainer = document.createElement('div');
                stepContainer.className = 'work-step';
                
                // Create container for the product
                const productRow = document.createElement('div');
                productRow.className = 'work-row';
                
                // Add spacing based on position
                for (let i = 0; i < step.position; i++) {
                    const spacer = document.createElement('div');
                    spacer.className = 'work-digit';
                    productRow.appendChild(spacer);
                }
                
                // Add product digits
                const productStr = step.product.toString();
                for (let i = 0; i < productStr.length; i++) {
                    const digitDiv = document.createElement('div');
                    digitDiv.className = 'work-digit';
                    digitDiv.textContent = productStr[i];
                    productRow.appendChild(digitDiv);
                }
                
                stepContainer.appendChild(productRow);
                this.elements.workArea.appendChild(stepContainer);
            }
            
            // Show subtraction step in work area
            showSubtractionStep(step) {
                // Add subtraction line
                const lineDiv = document.createElement('div');
                lineDiv.className = 'subtraction-line';
                lineDiv.style.width = `${step.subtractFrom.toString().length * 45}px`;
                lineDiv.style.marginLeft = `${step.position * 45}px`;
                this.elements.workArea.appendChild(lineDiv);
                
                // Add remainder
                const remainderRow = document.createElement('div');
                remainderRow.className = 'work-row';
                
                // Add spacing based on position
                for (let i = 0; i < step.position; i++) {
                    const spacer = document.createElement('div');
                    spacer.className = 'work-digit';
                    remainderRow.appendChild(spacer);
                }
                
                // Add remainder digits
                const remainderStr = step.remainder.toString();
                for (let i = 0; i < remainderStr.length; i++) {
                    const digitDiv = document.createElement('div');
                    digitDiv.className = 'work-digit';
                    digitDiv.textContent = remainderStr[i];
                    remainderRow.appendChild(digitDiv);
                }
                
                this.elements.workArea.appendChild(remainderRow);
            }
            
            // Show bring down step in work area
            showBringDownStep(step) {
                // Create container for the bring down result
                const bringDownRow = document.createElement('div');
                bringDownRow.className = 'work-row';
                
                // Combine the remainder with the brought down digit
                const newNumber = step.remainder.toString() + step.bringDown;
                
                // Add spacing based on position
                for (let i = 0; i < step.position; i++) {
                    const spacer = document.createElement('div');
                    spacer.className = 'work-digit';
                    bringDownRow.appendChild(spacer);
                }
                
                // Add the new number digits
                for (let i = 0; i < newNumber.length; i++) {
                    const digitDiv = document.createElement('div');
                    digitDiv.className = 'work-digit';
                    digitDiv.textContent = newNumber[i];
                    
                    // Animate the brought down digit
                    if (i === newNumber.length - 1) {
                        digitDiv.classList.add('bringing-down');
                    }
                    
                    bringDownRow.appendChild(digitDiv);
                }
                
                this.elements.workArea.appendChild(bringDownRow);
            }
            
            // Navigate to the previous step
            navigateToPreviousStep() {
                // Not implemented in this version - would require more complex state tracking
                // For a children's game, keeping it simple with forward progression
            }
            
            // Navigate to the next step
            navigateToNextStep() {
                // Not implemented in this version - would require more complex state tracking
                // For a children's game, keeping it simple with step-by-step progression
            }
            
            // Complete the level
            completeLevel() {
                // Update score and streak
                this.score++;
                this.streak++;
                this.elements.score.textContent = this.score;
                
                // Calculate time taken
                const endTime = new Date().getTime();
                const timeTaken = (endTime - this.startTime) / 1000; // in seconds
                
                // Check for awards
                this.checkAwards(timeTaken);
                
                // Play celebration sound
                this.playSound('levelUp');
                
                // Show completion feedback with animation
                this.elements.feedback.textContent = `Amazing job! Division complete in ${Math.round(timeTaken)} seconds! üéâ`;
                this.elements.feedback.className = 'feedback correct celebrating';
                
                // Update instruction in the right panel
                this.elements.currentInstruction.textContent = `Excellent! You solved it in ${Math.round(timeTaken)} seconds. Ready for the next challenge?`;
                
                // Create celebration effect
                this.createConfetti();
                
                // Add animation to the final answer
                this.quotientInputs.forEach(input => {
                    if (input.value) {
                        input.classList.add('celebrating');
                        setTimeout(() => {
                            input.classList.remove('celebrating');
                        }, 3000);
                    }
                });
                
                // Check for level up
                if (this.score % 3 === 0) {
                    this.levelUp();
                }
                
                // Enable the next problem button and highlight it
                this.elements.newProblemButton.disabled = false;
                this.elements.newProblemButton.classList.add('celebrating');
                
                // Auto-generate new problem after 5 seconds if user doesn't click
                const autoNewTimeout = setTimeout(() => {
                    if (this.currentStep >= this.solution.length) {  // Check if we're still on the completed problem
                        this.generateProblem();
                    }
                }, 5000);
                
                // Clear timeout if user clicks the button
                this.elements.newProblemButton.addEventListener('click', () => {
                    clearTimeout(autoNewTimeout);
                }, { once: true });
                
                // Give a hint about keyboard shortcut
                setTimeout(() => {
                    this.showFeedback('Press SPACE for a new problem!', true);
                }, 3000);
            }
            
            // Level up
            levelUp() {
                this.level++;
                this.elements.level.textContent = this.level;
                this.elements.level.parentElement.classList.add('celebrating');
                
                // Show level up message
                this.elements.feedback.textContent = `Level Up! You're now at level ${this.level}! üöÄ`;
                
                // Update instruction in the right panel
                this.elements.currentInstruction.textContent = `You leveled up! Now at level ${this.level} with slightly harder problems.`;
                
                // Reset celebration after a delay
                setTimeout(() => {
                    this.elements.level.parentElement.classList.remove('celebrating');
                }, 3000);
                
                // Award level badge every 5 levels
                if (this.level % 5 === 0) {
                    this.awardBadge('level');
                }
            }
            
            // Check for awards
            checkAwards(timeTaken) {
                // Speed award - complete within 30 seconds
                if (timeTaken < 30 && !this.awards.speed) {
                    this.awardBadge('speed');
                }
                
                // Streak award - 5 consecutive correct solutions
                if (this.streak >= 5 && !this.awards.streak) {
                    this.awardBadge('streak');
                }
                
                // Perfect solution award - no mistakes
                if (this.perfectSolution && !this.awards.perfect) {
                    this.awardBadge('perfect');
                }
            }
            
            // Award a badge
            awardBadge(type) {
                this.awards[type] = true;
                const badge = this.elements[`award${type.charAt(0).toUpperCase() + type.slice(1)}`];
                
                badge.classList.add('earned');
                
                // Show award message
                let message = '';
                switch(type) {
                    case 'speed':
                        message = 'Speed Solver Award Earned! ‚ö°';
                        break;
                    case 'streak':
                        message = '5 in a Row! Streak Master Award Earned! üî•';
                        break;
                    case 'perfect':
                        message = 'Perfect Solution Award Earned! üåü';
                        break;
                    case 'level':
                        message = 'Level Master Award Earned! üèÜ';
                        break;
                }
                
                // Add award message to feedback
                setTimeout(() => {
                    this.elements.feedback.textContent = message;
                    
                    // Also update instruction panel
                    this.elements.currentInstruction.textContent = message + " Keep up the great work!";
                }, 2000);
            }
            
            // Create celebration confetti
            createConfetti() {
                const colors = ['red', 'blue', 'green', 'yellow', 'purple'];
                const confettiCount = 100;
                
                for (let i = 0; i < confettiCount; i++) {
                    const confetti = document.createElement('div');
                    confetti.className = `confetti ${colors[Math.floor(Math.random() * colors.length)]}`;
                    
                    // Random position
                    confetti.style.left = Math.random() * 100 + 'vw';
                    
                    // Random size
                    const size = Math.random() * 10 + 5;
                    confetti.style.width = size + 'px';
                    confetti.style.height = size + 'px';
                    
                    // Random rotation
                    confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                    
                    // Random delay
                    confetti.style.animationDelay = Math.random() * 2 + 's';
                    
                    document.body.appendChild(confetti);
                    
                    // Remove after animation
                    setTimeout(() => {
                        confetti.remove();
                    }, 5000);
                }
            }
        }
        
        // Initialize the game when the page loads
        window.addEventListener('load', () => new LongDivisionGame());
    </script>
</body>
</html>