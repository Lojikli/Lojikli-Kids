<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FOIL Friends: Factoring Binomials Adventure</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"></script>
    <style>
        body {
            font-family: 'Comic Sans MS', 'Chalkboard SE', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f8ff;
            color: #333;
            overflow-x: hidden;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: #6a5acd;
            color: white;
            text-align: center;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        h1 {
            font-size: 2.5em;
            margin: 0;
        }
        
        h2 {
            font-size: 1.8em;
            color: #6a5acd;
            border-bottom: 3px solid #ffa500;
            padding-bottom: 10px;
        }
        
        .character {
            width: 150px;
            height: 150px;
            margin: 10px;
            display: inline-block;
            vertical-align: top;
            text-align: center;
        }
        
        .character-name {
            font-size: 1.2em;
            font-weight: bold;
            margin-top: 5px;
        }
        
        .game-section {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .explanation {
            font-size: 1.2em;
            line-height: 1.6;
        }
        
        button {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 12px 24px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 10px 5px;
            cursor: pointer;
            border-radius: 8px;
            font-family: 'Comic Sans MS', 'Chalkboard SE', sans-serif;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        .controls {
            background-color: #e6e6fa;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .parameter {
            margin: 10px 0;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .parameter label {
            width: 200px;
            font-weight: bold;
        }
        
        .parameter input, .parameter select {
            width: 150px;
            padding: 8px;
            border: 2px solid #aaa;
            border-radius: 5px;
            font-size: 16px;
            font-family: 'Comic Sans MS', 'Chalkboard SE', sans-serif;
        }
        
        #canvas-container {
            text-align: center;
            margin: 20px 0;
        }
        
        .quiz-container {
            background-color: #fffacd;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .quiz-question {
            font-size: 1.3em;
            margin-bottom: 15px;
        }
        
        .quiz-options {
            margin-bottom: 20px;
        }
        
        .quiz-option {
            background-color: white;
            border: 2px solid #6a5acd;
            border-radius: 5px;
            padding: 10px;
            margin: 5px 0;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .quiz-option:hover {
            background-color: #e6e6fa;
        }
        
        .quiz-feedback {
            font-size: 1.2em;
            font-weight: bold;
            min-height: 30px;
            margin: 10px 0;
        }
        
        .certificate {
            border: 5px solid gold;
            background-color: #fffdf0;
            padding: 20px;
            text-align: center;
            display: none;
            margin-top: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .certificate h2 {
            color: #ff8c00;
            border-bottom: none;
        }
        
        .tab {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
            border-radius: 8px 8px 0 0;
        }
        
        .tab button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
            color: #333;
            margin: 0;
            border-radius: 0;
        }
        
        .tab button:hover {
            background-color: #ddd;
        }
        
        .tab button.active {
            background-color: #6a5acd;
            color: white;
        }
        
        .tabcontent {
            display: none;
            padding: 20px;
            border: 1px solid #ccc;
            border-top: none;
            border-radius: 0 0 8px 8px;
            background-color: white;
        }
        
        .story-container {
            background-color: #e6f7ff;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            font-size: 1.2em;
            line-height: 1.6;
        }
        
        .speech-bubble {
            position: relative;
            background-color: #fff;
            border-radius: 20px;
            padding: 20px;
            margin: 30px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .speech-bubble:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 30px;
            width: 0;
            height: 0;
            border: 20px solid transparent;
            border-top-color: #fff;
            border-bottom: 0;
            margin-left: -20px;
            margin-bottom: -20px;
        }
        
        .progress-bar {
            width: 100%;
            background-color: #f1f1f1;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .progress {
            height: 30px;
            background-color: #4CAF50;
            border-radius: 5px;
            text-align: center;
            line-height: 30px;
            color: white;
            transition: width 0.3s;
        }
        
        .star {
            color: gold;
            font-size: 24px;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.3);
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
            border-bottom: 1px dotted #6a5acd;
            cursor: help;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        .formula-box {
            background-color: #f5f5dc;
            border: 2px solid #daa520;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
            font-size: 1.3em;
        }
        
        .celebration {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
        }
        
        @media (max-width: 768px) {
            header {
                padding: 15px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .parameter {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .parameter label {
                width: 100%;
                margin-bottom: 5px;
            }
            
            .parameter input, .parameter select {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>FOIL Friends: Factoring Binomials Adventure</h1>
            <p>A fun journey into the world of algebra!</p>
        </header>
        
        <div class="tab">
            <button class="tablinks active" onclick="openTab(event, 'Story')">Story</button>
            <button class="tablinks" onclick="openTab(event, 'Learn')">Learn</button>
            <button class="tablinks" onclick="openTab(event, 'Play')">Play</button>
            <button class="tablinks" onclick="openTab(event, 'Quiz')">Quiz</button>
            <button class="tablinks" onclick="openTab(event, 'Settings')">Settings</button>
        </div>
        
        <div id="Story" class="tabcontent" style="display: block;">
            <h2>The Algebra Kingdom</h2>
            
            <div class="story-container">
                <p>Welcome to the magical Algebra Kingdom! In this enchanted land, numbers and letters live together in harmony, creating the beautiful magic of mathematics.</p>
                
                <div class="character" id="prof-foil-container"></div>
                
                <div class="speech-bubble">
                    <p>"Hello there, young mathematician! I'm Professor FOIL, the royal mathematician of Algebra Kingdom. Today, I'm going to show you a special kind of magic called 'factoring binomials.'"</p>
                </div>
                
                <p>Professor FOIL introduces you to his friends:</p>
                
                <div style="text-align: center;">
                    <div class="character" id="first-container"></div>
                    <div class="character" id="outer-container"></div>
                    <div class="character" id="inner-container"></div>
                    <div class="character" id="last-container"></div>
                </div>
                
                <div class="speech-bubble">
                    <p>"These are the FOIL Friends! F stands for First, O for Outer, I for Inner, and L for Last. Together, they help us understand how to multiply and factor binomial expressions."</p>
                </div>
                
                <p>Professor FOIL waves his calculator wand, and suddenly the kingdom transforms into a giant mathematical playground.</p>
                
                <div class="speech-bubble">
                    <p>"Our kingdom has a problem! The Evil Polynomial has cast a spell that's mixing up all our binomials! To break this spell, we must learn how to factor polynomials back into their original binomial forms."</p>
                </div>
                
                <p>Are you ready to join Professor FOIL and the FOIL Friends on this mathematical adventure? Click on 'Learn' to begin your training!</p>
            </div>
            
            <button onclick="openTab(event, 'Learn')">Start Learning!</button>
        </div>
        
        <div id="Learn" class="tabcontent">
            <h2>Learning the FOIL Method</h2>
            
            <div class="game-section">
                <h3>What are Binomials?</h3>
                
                <div class="explanation">
                    <p>A <span class="tooltip">binomial<span class="tooltiptext">An expression with two terms</span></span> is a mathematical expression that has two terms, like <strong>x + 3</strong> or <strong>2y - 5</strong>.</p>
                    
                    <p>When we multiply two binomials together, we get a <span class="tooltip">polynomial<span class="tooltiptext">An expression with multiple terms</span></span> with up to four terms. For example:</p>
                    
                    <div class="formula-box">
                        (x + 3)(x + 2) = x² + 5x + 6
                    </div>
                    
                    <p>Factoring is the reverse process - we start with the polynomial and find the binomials that were multiplied together.</p>
                </div>
                
                <h3>The FOIL Method</h3>
                
                <div class="explanation">
                    <p>FOIL is a method to help us remember how to multiply binomials. It stands for:</p>
                    
                    <ul>
                        <li><strong>F</strong>irst: Multiply the first terms of each binomial</li>
                        <li><strong>O</strong>uter: Multiply the first term of the first binomial with the last term of the second</li>
                        <li><strong>I</strong>nner: Multiply the last term of the first binomial with the first term of the second</li>
                        <li><strong>L</strong>ast: Multiply the last terms of each binomial</li>
                    </ul>
                    
                    <p>Let's see this with an example: (x + 3)(x + 2)</p>
                    
                    <div class="formula-box">
                        F: x × x = x²<br>
                        O: x × 2 = 2x<br>
                        I: 3 × x = 3x<br>
                        L: 3 × 2 = 6
                    </div>
                    
                    <p>Then we combine like terms: x² + 2x + 3x + 6 = x² + 5x + 6</p>
                </div>
                
                <h3>Factoring Binomials</h3>
                
                <div class="explanation">
                    <p>Factoring is the reverse of FOIL. We start with a polynomial like x² + 5x + 6 and want to find the two binomials that multiply to give us this.</p>
                    
                    <p>When factoring a quadratic in the form x² + bx + c, we need to find two numbers that:</p>
                    <ol>
                        <li>Multiply to give us c (the last term)</li>
                        <li>Add up to give us b (the middle term's coefficient)</li>
                    </ol>
                    
                    <p>For x² + 5x + 6:</p>
                    <ul>
                        <li>We need two numbers that multiply to give 6 (which could be 1×6 or 2×3)</li>
                        <li>And these same two numbers need to add up to 5</li>
                        <li>2 + 3 = 5, so our numbers are 2 and 3</li>
                    </ul>
                    
                    <p>So the factored form is (x + 2)(x + 3)</p>
                </div>
                
                <h3>Let's Try Another Example</h3>
                
                <div class="explanation">
                    <p>Let's factor x² + 7x + 12</p>
                    
                    <p>We need two numbers that:</p>
                    <ol>
                        <li>Multiply to give 12 (possibilities: 1×12, 2×6, 3×4)</li>
                        <li>Add up to give 7</li>
                    </ol>
                    
                    <p>3 + 4 = 7, so our numbers are 3 and 4.</p>
                    
                    <div class="formula-box">
                        x² + 7x + 12 = (x + 3)(x + 4)
                    </div>
                </div>
                
                <h3>Advanced: Factoring with Negative Numbers</h3>
                
                <div class="explanation">
                    <p>Sometimes our polynomial might look like x² - 3x + 2</p>
                    
                    <p>We need two numbers that:</p>
                    <ol>
                        <li>Multiply to give 2 (possibilities: 1×2)</li>
                        <li>Add up to give -3</li>
                    </ol>
                    
                    <p>The numbers must be negative since their sum is negative. -1 + (-2) = -3, and -1 × (-2) = 2.</p>
                    
                    <div class="formula-box">
                        x² - 3x + 2 = (x - 1)(x - 2)
                    </div>
                </div>
            </div>
            
            <button onclick="openTab(event, 'Play')">Let's Play!</button>
        </div>
        
        <div id="Play" class="tabcontent">
            <h2>Factoring Practice Zone</h2>
            
            <div class="game-section">
                <h3>Interactive Binomial Blocks</h3>
                <p>Drag and drop the blocks to factor the polynomial!</p>
                
                <div id="canvas-container"></div>
                
                <div class="controls">
                    <h3>Challenge Level</h3>
                    <div class="parameter">
                        <label for="difficultyLevel">Difficulty:</label>
                        <select id="difficultyLevel" onchange="updateDifficulty()">
                            <option value="easy">Easy (Positive Integers)</option>
                            <option value="medium">Medium (Positive & Negative)</option>
                            <option value="hard">Hard (Fractions & Decimals)</option>
                        </select>
                    </div>
                    
                    <div class="parameter">
                        <label for="showHints">Show Hints:</label>
                        <input type="checkbox" id="showHints" checked onchange="updateSettings()">
                    </div>
                    
                    <button onclick="generateNewProblem()">New Problem</button>
                    <button onclick="showHint()">Give Me A Hint</button>
                    <button onclick="checkAnswer()">Check My Answer</button>
                </div>
                
                <div id="hint-display" style="margin: 20px 0; font-size: 1.2em; color: #6a5acd;"></div>
                <div id="feedback-display" style="margin: 20px 0; font-size: 1.2em; font-weight: bold;"></div>
                
                <div class="progress-bar">
                    <div id="progress" class="progress" style="width: 0%;">0%</div>
                </div>
            </div>
            
            <button onclick="openTab(event, 'Quiz')">Take the Quiz!</button>
        </div>
        
        <div id="Quiz" class="tabcontent">
            <h2>FOIL Master Quiz</h2>
            
            <div class="quiz-container">
                <div id="quiz-progress" style="margin-bottom: 20px;">
                    Question: <span id="current-question">1</span>/<span id="total-questions">5</span>
                </div>
                
                <div id="quiz-question" class="quiz-question"></div>
                
                <div id="quiz-options" class="quiz-options"></div>
                
                <div id="quiz-feedback" class="quiz-feedback"></div>
                
                <button id="next-question" onclick="nextQuestion()" style="display: none;">Next Question</button>
                
                <div class="progress-bar">
                    <div id="quiz-progress-bar" class="progress" style="width: 0%;">0%</div>
                </div>
            </div>
            
            <div id="certificate" class="certificate">
                <h2>Certificate of Achievement</h2>
                <p>This certifies that</p>
                <h3 id="student-name">Math Explorer</h3>
                <p>has successfully completed the</p>
                <h3>FOIL Friends: Factoring Binomials Adventure</h3>
                <p>and is now officially a</p>
                <h3>Binomial Factoring Master</h3>
                <div id="certificate-stars" style="margin: 20px 0;"></div>
                <button onclick="printCertificate()">Print Certificate</button>
            </div>
        </div>
        
        <div id="Settings" class="tabcontent">
            <h2>Game Settings</h2>
            
            <div class="game-section">
                <h3>Customize Your Experience</h3>
                
                <div class="parameter">
                    <label for="playerName">Your Name:</label>
                    <input type="text" id="playerName" placeholder="Math Explorer" onchange="updateSettings()">
                </div>
                
                <div class="parameter">
                    <label for="characterColor">Professor FOIL Color:</label>
                    <input type="color" id="characterColor" value="#6a5acd" onchange="updateSettings()">
                </div>
                
                <div class="parameter">
                    <label for="soundEnabled">Sound Effects:</label>
                    <input type="checkbox" id="soundEnabled" checked onchange="updateSettings()">
                </div>
                
                <div class="parameter">
                    <label for="animationSpeed">Animation Speed:</label>
                    <input type="range" id="animationSpeed" min="1" max="10" value="5" onchange="updateSettings()">
                </div>
                
                <h3>Advanced Learning Settings</h3>
                
                <div class="parameter">
                    <label for="maxCoefficient">Maximum Coefficient:</label>
                    <input type="number" id="maxCoefficient" min="1" max="20" value="10" onchange="updateSettings()">
                </div>
                
                <div class="parameter">
                    <label for="allowDecimals">Allow Decimals:</label>
                    <input type="checkbox" id="allowDecimals" onchange="updateSettings()">
                </div>
                
                <div class="parameter">
                    <label for="allowFractions">Allow Fractions:</label>
                    <input type="checkbox" id="allowFractions" onchange="updateSettings()">
                </div>
                
                <div class="parameter">
                    <label for="polynomialType">Polynomial Type:</label>
                    <select id="polynomialType" onchange="updateSettings()">
                        <option value="trinomial">Trinomial (x² + bx + c)</option>
                        <option value="difference_of_squares">Difference of Squares (x² - c²)</option>
                        <option value="perfect_square">Perfect Square (x² + 2ax + a²)</option>
                    </select>
                </div>
                
                <h3>Reset Game</h3>
                <button onclick="resetGame()">Reset All Progress</button>
            </div>
        </div>
        
        <div id="celebration"></div>
    </div>
    
    <script>
        let p5Instance;
        let gameState = {
            score: 0,
            totalProblems: 0,
            correctProblems: 0,
            currentProblem: null,
            userAnswer: {
                binomial1: {x: 1, constant: 0},
                binomial2: {x: 1, constant: 0}
            },
            settings: {
                difficulty: 'easy',
                showHints: true,
                playerName: 'Math Explorer',
                characterColor: '#6a5acd',
                soundEnabled: true,
                animationSpeed: 5,
                maxCoefficient: 10,
                allowDecimals: false,
                allowFractions: false,
                polynomialType: 'trinomial'
            },
            quizState: {
                currentQuestion: 0,
                correctAnswers: 0,
                questions: []
            }
        };
        
        // Initialize the game when the page loads
        window.onload = function() {
            initializeGame();
            generateNewProblem();
            generateQuizQuestions();
            loadNextQuestion();
            
            // Create p5 instance
            p5Instance = new p5(binomialSketch, 'canvas-container');
        };
        
        function binomialSketch(p) {
            let blocks = [];
            let draggingBlock = null;
            let dropZones = [];
            let blockSize = 60;
            let canvasWidth = 600;
            let canvasHeight = 400;
            
            p.setup = function() {
                let canvas = p.createCanvas(canvasWidth, canvasHeight);
                
                // Create drop zones
                dropZones = [
                    {x: 150, y: 200, width: 120, height: 80, label: "First Binomial", filled: false},
                    {x: 350, y: 200, width: 120, height: 80, label: "Second Binomial", filled: false}
                ];
                
                // Create blocks based on current problem
                resetBlocks();
            };
            
            p.draw = function() {
                p.background(240, 248, 255);
                
                // Draw polynomial to factor
                p.textSize(24);
                p.textAlign(p.CENTER, p.CENTER);
                p.fill(106, 90, 205);
                
                if (gameState.currentProblem) {
                    let problem = `Factor: ${formatPolynomial(gameState.currentProblem.polynomial)}`;
                    p.text(problem, canvasWidth/2, 50);
                }
                
                // Draw drop zones
                for (let zone of dropZones) {
                    if (zone.filled) {
                        p.fill(200, 255, 200);
                    } else {
                        p.fill(255, 255, 255);
                    }
                    p.stroke(100);
                    p.rect(zone.x, zone.y, zone.width, zone.height, 10);
                    
                    p.fill(100);
                    p.textSize(16);
                    p.text(zone.label, zone.x + zone.width/2, zone.y - 15);
                }
                
                // Draw blocks
                for (let block of blocks) {
                    if (block === draggingBlock) continue; // Draw dragging block last
                    
                    p.fill(block.color);
                    p.stroke(50);
                    p.rect(block.x, block.y, blockSize, blockSize, 10);
                    
                    p.fill(255);
                    p.textSize(20);
                    p.textAlign(p.CENTER, p.CENTER);
                    p.text(block.value, block.x + blockSize/2, block.y + blockSize/2);
                }
                
                // Draw the dragging block on top
                if (draggingBlock) {
                    p.fill(draggingBlock.color);
                    p.stroke(50);
                    p.rect(draggingBlock.x, draggingBlock.y, blockSize, blockSize, 10);
                    
                    p.fill(255);
                    p.textSize(20);
                    p.textAlign(p.CENTER, p.CENTER);
                    p.text(draggingBlock.value, draggingBlock.x + blockSize/2, draggingBlock.y + blockSize/2);
                }
                
                // Draw current answer
                p.fill(0);
                p.textSize(20);
                p.textAlign(p.CENTER, p.CENTER);
                let answer = `(${formatBinomial(gameState.userAnswer.binomial1)})`;
                answer += ` × (${formatBinomial(gameState.userAnswer.binomial2)})`;
                p.text(answer, canvasWidth/2, canvasHeight - 40);
            };
            
            p.mousePressed = function() {
                // Check if a block is being clicked
                for (let i = blocks.length - 1; i >= 0; i--) {
                    let block = blocks[i];
                    if (p.mouseX > block.x && p.mouseX < block.x + blockSize &&
                        p.mouseY > block.y && p.mouseY < block.y + blockSize) {
                        draggingBlock = block;
                        // Move this block to the end of the array so it's drawn on top
                        blocks.splice(i, 1);
                        blocks.push(block);
                        break;
                    }
                }
            };
            
            p.mouseDragged = function() {
                if (draggingBlock) {
                    draggingBlock.x = p.mouseX - blockSize/2;
                    draggingBlock.y = p.mouseY - blockSize/2;
                }
            };
            
            p.mouseReleased = function() {
                if (draggingBlock) {
                    // Check if block is dropped on a zone
                    for (let zone of dropZones) {
                        if (p.mouseX > zone.x && p.mouseX < zone.x + zone.width &&
                            p.mouseY > zone.y && p.mouseY < zone.y + zone.height) {
                            
                            // Update user answer based on the zone
                            if (zone.label === "First Binomial") {
                                if (draggingBlock.type === 'coefficient') {
                                    gameState.userAnswer.binomial1.x = draggingBlock.numValue;
                                } else {
                                    gameState.userAnswer.binomial1.constant = draggingBlock.numValue;
                                }
                                zone.filled = true;
                            } else if (zone.label === "Second Binomial") {
                                if (draggingBlock.type === 'coefficient') {
                                    gameState.userAnswer.binomial2.x = draggingBlock.numValue;
                                } else {
                                    gameState.userAnswer.binomial2.constant = draggingBlock.numValue;
                                }
                                zone.filled = true;
                            }
                            
                            // Reset block position
                            draggingBlock.x = draggingBlock.originalX;
                            draggingBlock.y = draggingBlock.originalY;
                            break;
                        }
                    }
                    
                    draggingBlock = null;
                }
            };
            
            this.resetBlocks = function() {
                resetBlocks();
            };
            
            function resetBlocks() {
                blocks = [];
                
                // Reset drop zones
                for (let zone of dropZones) {
                    zone.filled = false;
                }
                
                // If no problem, return
                if (!gameState.currentProblem) return;
                
                // Generate some coefficient blocks
                let coefficients = [-3, -2, -1, 1, 2, 3, 4, 5];
                for (let i = 0; i < 4; i++) {
                    let value = coefficients[Math.floor(Math.random() * coefficients.length)];
                    let display = value === 1 ? "" : (value === -1 ? "-" : value.toString());
                    
                    blocks.push({
                        x: 50 + i * 70,
                        y: 100,
                        originalX: 50 + i * 70,
                        originalY: 100,
                        value: display + "x",
                        numValue: value,
                        type: 'coefficient',
                        color: p.color(255, 165, 0, 200) // Orange
                    });
                }
                
                // Generate some constant blocks
                let constants = [-6, -5, -4, -3, -2, -1, 1, 2, 3, 4, 5, 6];
                for (let i = 0; i < 4; i++) {
                    let value = constants[Math.floor(Math.random() * constants.length)];
                    
                    blocks.push({
                        x: 50 + i * 70,
                        y: 170,
                        originalX: 50 + i * 70,
                        originalY: 170,
                        value: value.toString(),
                        numValue: value,
                        type: 'constant',
                        color: p.color(106, 90, 205, 200) // Purple
                    });
                }
                
                // Add correct blocks for the solution
                let solution = gameState.currentProblem.solution;
                
                // First binomial's coefficient
                blocks.push({
                    x: 400,
                    y: 100,
                    originalX: 400,
                    originalY: 100,
                    value: solution.factor1.a === 1 ? "x" : (solution.factor1.a === -1 ? "-x" : solution.factor1.a + "x"),
                    numValue: solution.factor1.a,
                    type: 'coefficient',
                    color: p.color(255, 165, 0, 200) // Orange
                });
                
                // First binomial's constant
                blocks.push({
                    x: 400,
                    y: 170,
                    originalX: 400,
                    originalY: 170,
                    value: solution.factor1.b.toString(),
                    numValue: solution.factor1.b,
                    type: 'constant',
                    color: p.color(106, 90, 205, 200) // Purple
                });
                
                // Second binomial's coefficient
                blocks.push({
                    x: 470,
                    y: 100,
                    originalX: 470,
                    originalY: 100,
                    value: solution.factor2.a === 1 ? "x" : (solution.factor2.a === -1 ? "-x" : solution.factor2.a + "x"),
                    numValue: solution.factor2.a,
                    type: 'coefficient',
                    color: p.color(255, 165, 0, 200) // Orange
                });
                
                // Second binomial's constant
                blocks.push({
                    x: 470,
                    y: 170,
                    originalX: 470,
                    originalY: 170,
                    value: solution.factor2.b.toString(),
                    numValue: solution.factor2.b,
                    type: 'constant',
                    color: p.color(106, 90, 205, 200) // Purple
                });
                
                // Shuffle the blocks
                for (let i = blocks.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [blocks[i], blocks[j]] = [blocks[j], blocks[i]];
                    
                    // Update original positions
                    blocks[i].x = blocks[i].originalX;
                    blocks[i].y = blocks[i].originalY;
                    blocks[j].x = blocks[j].originalX;
                    blocks[j].y = blocks[j].originalY;
                }
            }
        }
        
        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            
            if (evt) {
                evt.currentTarget.className += " active";
            }
        }
        
        function initializeGame() {
            // Initialize game characters
            const profFoil = new p5(character('prof-foil-container', 'Professor FOIL', '#6a5acd', 'wizard'));
            const firstChar = new p5(character('first-container', 'First', '#FF5733', 'circle'));
            const outerChar = new p5(character('outer-container', 'Outer', '#33FF57', 'square'));
            const innerChar = new p5(character('inner-container', 'Inner', '#3357FF', 'triangle'));
            const lastChar = new p5(character('last-container', 'Last', '#FF33FF', 'star'));
            
            // Load saved state if exists
            const savedState = localStorage.getItem('foilGameState');
            if (savedState) {
                gameState = JSON.parse(savedState);
                
                // Update UI based on saved state
                document.getElementById('difficultyLevel').value = gameState.settings.difficulty;
                document.getElementById('showHints').checked = gameState.settings.showHints;
                document.getElementById('playerName').value = gameState.settings.playerName;
                document.getElementById('characterColor').value = gameState.settings.characterColor;
                document.getElementById('soundEnabled').checked = gameState.settings.soundEnabled;
                document.getElementById('animationSpeed').value = gameState.settings.animationSpeed;
                document.getElementById('maxCoefficient').value = gameState.settings.maxCoefficient;
                document.getElementById('allowDecimals').checked = gameState.settings.allowDecimals;
                document.getElementById('allowFractions').checked = gameState.settings.allowFractions;
                document.getElementById('polynomialType').value = gameState.settings.polynomialType;
                
                // Update progress
                updateProgress();
            }
        }
        
        function character(containerId, name, color, shape) {
            return function(p) {
                p.setup = function() {
                    let canvas = p.createCanvas(120, 120);
                    canvas.parent(containerId);
                };
                
                p.draw = function() {
                    p.background(255);
                    p.fill(color);
                    p.stroke(0);
                    p.strokeWeight(2);
                    
                    // Draw character based on shape
                    switch(shape) {
                        case 'wizard':
                            drawWizard(p, color);
                            break;
                        case 'circle':
                            p.ellipse(60, 60, 80, 80);
                            break;
                        case 'square':
                            p.rect(20, 20, 80, 80);
                            break;
                        case 'triangle':
                            p.triangle(60, 20, 20, 100, 100, 100);
                            break;
                        case 'star':
                            drawStar(p, 60, 60, 40, 20, 5);
                            break;
                    }
                    
                    // Draw face
                    if (shape !== 'wizard') {
                        p.fill(0);
                        p.ellipse(50, 50, 10, 10); // Left eye
                        p.ellipse(70, 50, 10, 10); // Right eye
                        p.noFill();
                        p.stroke(0);
                        p.strokeWeight(2);
                        p.arc(60, 70, 40, 20, 0, p.PI); // Smile
                    }
                    
                    // Add name
                    p.fill(0);
                    p.noStroke();
                    p.textSize(14);
                    p.textAlign(p.CENTER);
                    p.text(name, 60, 140);
                };
                
                function drawWizard(p, color) {
                    // Wizard hat
                    p.fill(color);
                    p.triangle(60, 10, 30, 60, 90, 60);
                    
                    // Hat band
                    p.fill(255, 215, 0);
                    p.rect(30, 50, 60, 10);
                    
                    // Wizard face
                    p.fill(255, 222, 173);
                    p.ellipse(60, 80, 60, 70);
                    
                    // Eyes
                    p.fill(255);
                    p.ellipse(50, 70, 15, 10);
                    p.ellipse(70, 70, 15, 10);
                    
                    p.fill(0);
                    p.ellipse(50, 70, 5, 5);
                    p.ellipse(70, 70, 5, 5);
                    
                    // Beard
                    p.fill(200);
                    p.arc(60, 90, 40, 30, 0, p.PI);
                    
                    // Glasses
                    p.noFill();
                    p.stroke(0);
                    p.strokeWeight(2);
                    p.ellipse(50, 70, 20, 15);
                    p.ellipse(70, 70, 20, 15);
                    p.line(60, 70, 60, 70);
                }
                
                function drawStar(p, x, y, radius1, radius2, npoints) {
                    let angle = p.TWO_PI / npoints;
                    let halfAngle = angle / 2.0;
                    p.beginShape();
                    for (let a = 0; a < p.TWO_PI; a += angle) {
                        let sx = x + p.cos(a) * radius1;
                        let sy = y + p.sin(a) * radius1;
                        p.vertex(sx, sy);
                        sx = x + p.cos(a + halfAngle) * radius2;
                        sy = y + p.sin(a + halfAngle) * radius2;
                        p.vertex(sx, sy);
                    }
                    p.endShape(p.CLOSE);
                }
            };
        }
        
        function generateNewProblem() {
            const difficulty = gameState.settings.difficulty;
            
            let problem = {
                polynomial: {},
                solution: {
                    factor1: {a: 1, b: 0},
                    factor2: {a: 1, b: 0}
                }
            };
            
            // Generate binomial factors based on difficulty
            if (difficulty === 'easy') {
                problem.solution.factor1.a = 1;
                problem.solution.factor2.a = 1;
                problem.solution.factor1.b = getRandomInt(1, 6);
                problem.solution.factor2.b = getRandomInt(1, 6);
            } else if (difficulty === 'medium') {
                problem.solution.factor1.a = 1;
                problem.solution.factor2.a = 1;
                problem.solution.factor1.b = getRandomInt(-6, 6);
                problem.solution.factor2.b = getRandomInt(-6, 6);
                
                // Ensure at least one is negative
                if (problem.solution.factor1.b > 0 && problem.solution.factor2.b > 0) {
                    if (Math.random() < 0.5) {
                        problem.solution.factor1.b *= -1;
                    } else {
                        problem.solution.factor2.b *= -1;
                    }
                }
            } else { // hard
                problem.solution.factor1.a = Math.random() < 0.7 ? 1 : getRandomInt(2, 3);
                problem.solution.factor2.a = Math.random() < 0.7 ? 1 : getRandomInt(2, 3);
                problem.solution.factor1.b = getRandomInt(-8, 8);
                problem.solution.factor2.b = getRandomInt(-8, 8);
            }
            
            // Compute polynomial from factors
            problem.polynomial = computePolynomial(problem.solution.factor1, problem.solution.factor2);
            
            // Set as current problem
            gameState.currentProblem = problem;
            gameState.totalProblems++;
            gameState.userAnswer = {
                binomial1: {x: 1, constant: 0},
                binomial2: {x: 1, constant: 0}
            };
            
            // Reset hint and feedback displays
            document.getElementById('hint-display').innerText = '';
            document.getElementById('feedback-display').innerText = '';
            
            // Update progress
            updateProgress();
            
            // Reset the blocks in the canvas
            if (p5Instance && p5Instance.resetBlocks) {
                p5Instance.resetBlocks();
            }
            
            // Save game state
            saveGameState();
            
            return problem;
        }
        
        function computePolynomial(factor1, factor2) {
            // (ax + b)(cx + d) = acx² + (ad + bc)x + bd
            let a = factor1.a;
            let b = factor1.b;
            let c = factor2.a;
            let d = factor2.b;
            
            return {
                x2: a * c,
                x: a * d + b * c,
                constant: b * d
            };
        }
        
        function formatPolynomial(poly) {
            let result = '';
            
            // x² term
            if (poly.x2 !== 0) {
                if (poly.x2 === 1) {
                    result += 'x²';
                } else if (poly.x2 === -1) {
                    result += '-x²';
                } else {
                    result += poly.x2 + 'x²';
                }
            }
            
            // x term
            if (poly.x !== 0) {
                if (poly.x > 0 && result !== '') {
                    result += ' + ';
                } else if (poly.x < 0) {
                    result += ' - ';
                }
                
                let coefficient = Math.abs(poly.x);
                if (coefficient === 1) {
                    result += 'x';
                } else {
                    result += coefficient + 'x';
                }
            }
            
            // Constant term
            if (poly.constant !== 0) {
                if (poly.constant > 0 && result !== '') {
                    result += ' + ';
                } else if (poly.constant < 0) {
                    result += ' - ';
                }
                
                result += Math.abs(poly.constant);
            }
            
            // Handle zero polynomial
            if (result === '') {
                result = '0';
            }
            
            return result;
        }
        
        function formatBinomial(binomial) {
            let result = '';
            
            // x term
            if (binomial.x !== 0) {
                if (binomial.x === 1) {
                    result += 'x';
                } else if (binomial.x === -1) {
                    result += '-x';
                } else {
                    result += binomial.x + 'x';
                }
            }
            
            // Constant term
            if (binomial.constant !== 0) {
                if (binomial.constant > 0 && result !== '') {
                    result += ' + ';
                } else if (binomial.constant < 0) {
                    result += ' - ';
                }
                
                result += Math.abs(binomial.constant);
            }
            
            // Handle zero binomial
            if (result === '') {
                result = '0';
            }
            
            return result;
        }
        
        function getRandomInt(min, max) {
            min = Math.ceil(min);
            max = Math.floor(max);
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }
        
        function checkAnswer() {
            const userAns = gameState.userAnswer;
            const solution = gameState.currentProblem.solution;
            
            // Calculate the polynomial from user's answer
            const userPoly = computePolynomial(userAns.binomial1, userAns.binomial2);
            const targetPoly = gameState.currentProblem.polynomial;
            
            const feedback = document.getElementById('feedback-display');
            
            if (userPoly.x2 === targetPoly.x2 && userPoly.x === targetPoly.x && userPoly.constant === targetPoly.constant) {
                feedback.innerText = '✅ Correct! Great job factoring!';
                feedback.style.color = 'green';
                
                gameState.correctProblems++;
                updateProgress();
                
                // Celebrate
                createConfetti();
                
                // Give them a chance to see the success before generating a new problem
                setTimeout(generateNewProblem, 2000);
            } else {
                feedback.innerText = '❌ Not quite. Keep trying!';
                feedback.style.color = 'red';
                
                // Give a specific hint about what's wrong
                if (userPoly.constant !== targetPoly.constant) {
                    feedback.innerText += ' Check the constant term.';
                } else if (userPoly.x !== targetPoly.x) {
                    feedback.innerText += ' Check the coefficient of x.';
                } else {
                    feedback.innerText += ' Check your calculations.';
                }
            }
            
            // Save game state
            saveGameState();
        }
        
        function showHint() {
            const problem = gameState.currentProblem;
            const hintDisplay = document.getElementById('hint-display');
            
            if (!problem) return;
            
            const p = problem.polynomial;
            
            // Determine what hint to give based on problem type
            if (p.x2 === 1) { // If the x² coefficient is 1
                hintDisplay.innerHTML = `Find two numbers that:<br>
                    1. Multiply to give ${p.constant}<br>
                    2. Add up to give ${p.x}`;
            } else {
                hintDisplay.innerHTML = `For ${formatPolynomial(p)}:<br>
                    1. The product of the constants must be ${p.constant}<br>
                    2. The sum of the outer and inner products must be ${p.x}x`;
            }
        }
        
        function updateDifficulty() {
            gameState.settings.difficulty = document.getElementById('difficultyLevel').value;
            generateNewProblem();
        }
        
        function updateSettings() {
            gameState.settings.showHints = document.getElementById('showHints').checked;
            gameState.settings.playerName = document.getElementById('playerName').value || 'Math Explorer';
            gameState.settings.characterColor = document.getElementById('characterColor').value;
            gameState.settings.soundEnabled = document.getElementById('soundEnabled').checked;
            gameState.settings.animationSpeed = parseInt(document.getElementById('animationSpeed').value);
            gameState.settings.maxCoefficient = parseInt(document.getElementById('maxCoefficient').value);
            gameState.settings.allowDecimals = document.getElementById('allowDecimals').checked;
            gameState.settings.allowFractions = document.getElementById('allowFractions').checked;
            gameState.settings.polynomialType = document.getElementById('polynomialType').value;
            
            // Update student name in certificate
            document.getElementById('student-name').innerText = gameState.settings.playerName;
            
            // Save game state
            saveGameState();
        }
        
        function updateProgress() {
            let percent = 0;
            if (gameState.totalProblems > 0) {
                percent = Math.round((gameState.correctProblems / gameState.totalProblems) * 100);
            }
            
            const progress = document.getElementById('progress');
            progress.style.width = percent + '%';
            progress.innerText = percent + '%';
            
            // If they've solved at least 10 problems with 80% accuracy, enable the certificate
            if (gameState.totalProblems >= 10 && percent >= 80) {
                document.getElementById('certificate').style.display = 'block';
                
                // Add stars based on performance
                const starsContainer = document.getElementById('certificate-stars');
                starsContainer.innerHTML = '';
                
                let stars = 3; // Default
                if (percent >= 95) stars = 5;
                else if (percent >= 90) stars = 4;
                
                for (let i = 0; i < stars; i++) {
                    starsContainer.innerHTML += '<span class="star">★</span>';
                }
            }
        }
        
        function resetGame() {
            if (confirm('Are you sure you want to reset all progress? This cannot be undone.')) {
                localStorage.removeItem('foilGameState');
                location.reload();
            }
        }
        
        function saveGameState() {
            localStorage.setItem('foilGameState', JSON.stringify(gameState));
        }
        
        function createConfetti() {
            const celebration = document.getElementById('celebration');
            celebration.innerHTML = '';
            
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.style.position = 'absolute';
                confetti.style.width = Math.random() * 10 + 5 + 'px';
                confetti.style.height = Math.random() * 10 + 5 + 'px';
                confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
                confetti.style.borderRadius = Math.random() < 0.5 ? '50%' : '0';
                confetti.style.top = '-10px';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                
                // Add animation
                confetti.style.animation = `fall ${Math.random() * 3 + 2}s linear forwards`;
                
                celebration.appendChild(confetti);
                
                // Remove after animation
                setTimeout(() => {
                    confetti.remove();
                }, 5000);
            }
            
            // Add animation keyframes
            if (!document.getElementById('confetti-animation')) {
                const style = document.createElement('style');
                style.id = 'confetti-animation';
                style.innerHTML = `
                @keyframes fall {
                    0% {
                        transform: translateY(0) rotate(0deg);
                        opacity: 1;
                    }
                    100% {
                        transform: translateY(100vh) rotate(720deg);
                        opacity: 0;
                    }
                }`;
                document.head.appendChild(style);
            }
        }
        
        function printCertificate() {
            const certificateDiv = document.getElementById('certificate');
            const printWindow = window.open('', '', 'width=800,height=600');
            printWindow.document.write('<html><head><title>Certificate</title>');
            printWindow.document.write('<style>body { font-family: Comic Sans MS, Chalkboard SE, sans-serif; text-align: center; padding: 50px; border: 10px solid gold; } h2 { color: #ff8c00; } .star { color: gold; font-size: 36px; }</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write(certificateDiv.innerHTML);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.print();
        }
        
        // Quiz functionality
        function generateQuizQuestions() {
            gameState.quizState.questions = [
                {
                    question: "What does FOIL stand for?",
                    options: [
                        "First, Outside, Inside, Last",
                        "First, Outer, Inner, Last",
                        "Find, Organize, Identify, List",
                        "Factor, Order, Isolate, Link"
                    ],
                    correctIndex: 1,
                    explanation: "FOIL stands for First, Outer, Inner, Last. It helps us remember the order of multiplication when dealing with binomials."
                },
                {
                    question: "What is the factored form of x² + 7x + 12?",
                    options: [
                        "(x + 3)(x + 4)",
                        "(x + 6)(x + 1)",
                        "(x + 2)(x + 6)",
                        "(x + 12)(x + 1)"
                    ],
                    correctIndex: 0,
                    explanation: "We need two numbers that multiply to give 12 and add up to give 7. 3 × 4 = 12 and 3 + 4 = 7, so the factored form is (x + 3)(x + 4)."
                },
                {
                    question: "To factor x² - 5x + 6, what numbers do we need?",
                    options: [
                        "Two numbers that multiply to give 6 and add up to give -5",
                        "Two numbers that multiply to give -6 and add up to give 5",
                        "Two numbers that multiply to give 6 and subtract to give 5",
                        "Two numbers that multiply to give -6 and subtract to give -5"
                    ],
                    correctIndex: 0,
                    explanation: "We need two numbers that multiply to give 6 and add up to give -5. -2 × -3 = 6 and -2 + (-3) = -5, so the factored form is (x - 2)(x - 3)."
                },
                {
                    question: "Which of these polynomials can be factored into two binomials with integer coefficients?",
                    options: [
                        "x² + 5x + 7",
                        "x² - 4x + 4",
                        "x² + x - 1",
                        "x² + 3x + 1"
                    ],
                    correctIndex: 1,
                    explanation: "x² - 4x + 4 can be factored as (x - 2)(x - 2) or (x - 2)². This is a perfect square trinomial."
                },
                {
                    question: "When factoring x² - 9, what method would you use?",
                    options: [
                        "FOIL method",
                        "Difference of squares: (a + b)(a - b)",
                        "Perfect square trinomial formula",
                        "Quadratic formula"
                    ],
                    correctIndex: 1,
                    explanation: "x² - 9 = x² - 3² is a difference of squares which factors as (x + 3)(x - 3) using the formula a² - b² = (a + b)(a - b)."
                }
            ];
        }
        
        function loadNextQuestion() {
            const quizState = gameState.quizState;
            
            if (quizState.currentQuestion >= quizState.questions.length) {
                // Quiz is complete, show results
                const scorePercent = Math.round((quizState.correctAnswers / quizState.questions.length) * 100);
                
                document.getElementById('quiz-question').innerText = `Quiz Complete!`;
                document.getElementById('quiz-options').innerHTML = `<p>You scored ${quizState.correctAnswers} out of ${quizState.questions.length} (${scorePercent}%).</p>`;
                
                // Show feedback based on score
                const feedback = document.getElementById('quiz-feedback');
                if (scorePercent >= 80) {
                    feedback.innerText = "Excellent work! You're a FOIL master!";
                    feedback.style.color = "green";
                } else if (scorePercent >= 60) {
                    feedback.innerText = "Good job! With a bit more practice, you'll be a FOIL expert!";
                    feedback.style.color = "blue";
                } else {
                    feedback.innerText = "Keep practicing! The FOIL method takes time to master.";
                    feedback.style.color = "orange";
                }
                
                // Hide next button
                document.getElementById('next-question').style.display = "none";
                
                // Show certificate if they did well
                if (scorePercent >= 70) {
                    document.getElementById('certificate').style.display = 'block';
                }
                
                return;
            }
            
            const question = quizState.questions[quizState.currentQuestion];
            
            // Update question counter
            document.getElementById('current-question').innerText = quizState.currentQuestion + 1;
            document.getElementById('total-questions').innerText = quizState.questions.length;
            
            // Update progress bar
            const percent = (quizState.currentQuestion / quizState.questions.length) * 100;
            document.getElementById('quiz-progress-bar').style.width = percent + '%';
            document.getElementById('quiz-progress-bar').innerText = Math.round(percent) + '%';
            
            // Display question
            document.getElementById('quiz-question').innerText = question.question;
            
            // Display options
            const optionsContainer = document.getElementById('quiz-options');
            optionsContainer.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'quiz-option';
                optionElement.innerText = option;
                optionElement.onclick = function() { selectAnswer(index); };
                optionsContainer.appendChild(optionElement);
            });
            
            // Clear feedback
            document.getElementById('quiz-feedback').innerText = '';
            
            // Hide next button
            document.getElementById('next-question').style.display = "none";
        }
        
        function selectAnswer(index) {
            const quizState = gameState.quizState;
            const question = quizState.questions[quizState.currentQuestion];
            
            // Disable all options
            const options = document.getElementsByClassName('quiz-option');
            for (let i = 0; i < options.length; i++) {
                options[i].style.pointerEvents = 'none';
                
                if (i === question.correctIndex) {
                    options[i].style.backgroundColor = '#90EE90'; // Light green
                    options[i].style.borderColor = 'green';
                } else if (i === index && index !== question.correctIndex) {
                    options[i].style.backgroundColor = '#FFB6C1'; // Light red
                    options[i].style.borderColor = 'red';
                }
            }
            
            // Show feedback
            const feedback = document.getElementById('quiz-feedback');
            if (index === question.correctIndex) {
                feedback.innerText = "Correct! " + question.explanation;
                feedback.style.color = "green";
                quizState.correctAnswers++;
                
                // Small celebration
                createConfetti();
            } else {
                feedback.innerText = "Not quite. " + question.explanation;
                feedback.style.color = "red";
            }
            
            // Show next button
            document.getElementById('next-question').style.display = "inline-block";
        }
        
        function nextQuestion() {
            gameState.quizState.currentQuestion++;
            loadNextQuestion();
        }
    </script>
</body>
</html>
