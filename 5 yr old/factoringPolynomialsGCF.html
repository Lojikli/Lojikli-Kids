<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polynomial Pals: Factoring Adventure</title>
    <style>
        :root {
            --primary-color: #4a6baf;
            --secondary-color: #ff8a5c;
            --background-color: #f2f7ff;
            --success-color: #5cb85c;
            --error-color: #d9534f;
            --hint-color: #9575cd;
            --button-color: #5c94e6;
            --character-color: #ffca28;
            --nav-button-color: #7986cb;
        }
        
        * {
            box-sizing: border-box;
            font-family: 'Arial Rounded MT Bold', 'Comic Sans MS', 'Chalkboard SE', sans-serif;
        }
        
        body {
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden;
        }
        
        #game-container {
            width: 95%;
            max-width: 900px;
            margin: 20px auto;
            background-color: white;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            position: relative;
        }
        
        .header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 25px;
            text-align: center;
            border-bottom: 5px dashed var(--secondary-color);
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .header p {
            font-size: 1.2rem;
            margin: 5px 0 0;
        }
        
        .game-area {
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .problem-container {
            background-color: #f9f9f9;
            border: 3px solid var(--primary-color);
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            font-size: 2.5rem;
            text-align: center;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            position: relative;
        }
        
        .answer-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            margin: 15px 0;
        }
        
        #answer-input {
            font-size: 1.8rem;
            padding: 10px 15px;
            border: 3px solid var(--primary-color);
            border-radius: 15px;
            width: 80%;
            text-align: center;
            background-color: #f9f9f9;
        }
        
        .keyboard {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin: 15px 0;
            gap: 10px;
            width: 100%;
        }
        
        .key {
            background-color: var(--button-color);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 10px 15px;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 50px;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .key:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .key:active {
            transform: scale(0.95);
        }
        
        .operation-key {
            background-color: var(--secondary-color);
        }
        
        .clear-key {
            background-color: var(--error-color);
        }
        
        .submit-key {
            background-color: var(--success-color);
            padding: 10px 20px;
        }
        
        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin: 15px 0;
        }
        
        .nav-button {
            background-color: var(--nav-button-color);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 10px 20px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .nav-button:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .nav-button:active {
            transform: scale(0.95);
        }
        
        .nav-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .game-controls {
            display: flex;
            justify-content: space-between;
            width: 100%;
            padding: 10px 20px;
            background-color: #f0f0f0;
            border-radius: 15px;
            margin: 15px 0;
        }
        
        .score-container, .timer-container {
            display: flex;
            align-items: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .score-value, .timer-value {
            margin-left: 10px;
            background-color: white;
            padding: 5px 15px;
            border-radius: 10px;
            border: 2px solid var(--primary-color);
        }
        
        .hint-button {
            background-color: var(--hint-color);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 10px 20px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 10px 0;
        }
        
        .hint-button:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .hint-area {
            background-color: #f9f9f9;
            border: 3px dashed var(--hint-color);
            border-radius: 15px;
            padding: 15px;
            margin: 15px 0;
            width: 100%;
            display: none;
            overflow-y: auto;
            max-height: 200px;
        }
        
        .hint-area h3 {
            color: var(--hint-color);
            margin-top: 0;
        }
        
        .character-info {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .character-card {
            background-color: white;
            border: 2px solid var(--character-color);
            border-radius: 10px;
            padding: 10px;
            width: calc(33.33% - 10px);
            min-width: 150px;
        }
        
        .character-card h4 {
            margin: 0 0 5px 0;
            color: var(--character-color);
        }
        
        .feedback {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px 40px;
            border-radius: 15px;
            color: white;
            font-size: 2rem;
            font-weight: bold;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            z-index: 100;
            display: none;
        }
        
        .success {
            background-color: var(--success-color);
        }
        
        .error {
            background-color: var(--error-color);
        }
        
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #f00;
            border-radius: 50%;
            pointer-events: none;
        }
        
        .character {
            position: absolute;
            bottom: 20px;
            width: 120px;
            height: 120px;
            z-index: 10;
            transition: all 0.5s ease;
        }
        
        .character.left {
            left: 20px;
            transform: translateX(-150px);
        }
        
        .character.right {
            right: 20px;
            transform: translateX(150px);
        }
        
        .character.active {
            transform: translateX(0);
        }
        
        .character-speech {
            position: absolute;
            background-color: white;
            border: 2px solid #333;
            border-radius: 15px;
            padding: 10px 15px;
            max-width: 200px;
            font-size: 0.9rem;
            z-index: 11;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .character.left .character-speech {
            top: -80px;
            left: 0;
        }
        
        .character.right .character-speech {
            top: -80px;
            right: 0;
        }
        
        .character-speech:after {
            content: '';
            position: absolute;
            bottom: -10px;
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 10px solid #333;
        }
        
        .character.left .character-speech:after {
            left: 20px;
        }
        
        .character.right .character-speech:after {
            right: 20px;
        }
        
        .speech-active {
            opacity: 1;
        }
        
        .shake {
            animation: shake 0.5s;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        .settings-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(255, 255, 255, 0.7);
            border: 2px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 20;
        }
        
        .settings-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .settings-content {
            background-color: white;
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .settings-header h2 {
            margin: 0;
            color: var(--primary-color);
        }
        
        .close-settings {
            background-color: var(--error-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        .settings-group {
            margin-bottom: 20px;
        }
        
        .settings-group h3 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .settings-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .settings-label {
            flex: 1;
        }
        
        .settings-control {
            flex: 2;
        }
        
        input[type="range"] {
            width: 100%;
        }
        
        input[type="checkbox"] {
            width: 20px;
            height: 20px;
        }
        
        select {
            width: 100%;
            padding: 5px;
            border: 2px solid var(--primary-color);
            border-radius: 5px;
        }
        
        .level-display {
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary-color);
            margin: 10px 0;
        }
        
        /* Character SVGs */
        .pi-character {
            display: block;
            width: 100%;
            height: 100%;
        }
        
        .alpha-character {
            display: block;
            width: 100%;
            height: 100%;
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .problem-container {
                font-size: 2rem;
            }
            
            #answer-input {
                font-size: 1.5rem;
            }
            
            .key {
                font-size: 1.2rem;
                min-width: 40px;
                min-height: 40px;
            }
            
            .character-card {
                width: calc(50% - 10px);
                min-width: 120px;
            }
        }
        
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.8rem;
            }
            
            .problem-container {
                font-size: 1.8rem;
            }
            
            .character-card {
                width: 100%;
            }
            
            .character {
                width: 100px;
                height: 100px;
            }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div class="header">
            <h1>Polynomial Pals: Factoring Adventure</h1>
            <p>Factor the expression and have fun!</p>
        </div>
        
        <div class="settings-button" id="settings-button">⚙️</div>
        
        <div class="game-area">
            <div class="game-controls">
                <div class="score-container">
                    Score: <span class="score-value" id="score-value">0</span>
                </div>
                <div class="level-display">Level: <span id="level-text">Beginner</span></div>
                <div class="timer-container">
                    Time: <span class="timer-value" id="timer-value">60</span>
                </div>
            </div>
            
            <div class="problem-container" id="problem-display">
                Ready to play!
            </div>
            
            <div class="answer-container">
                <input type="text" id="answer-input" placeholder="Type your answer here" readonly>
            </div>
            
            <div class="keyboard" id="keyboard">
                <!-- Will be filled with JavaScript -->
            </div>
            
            <div class="navigation-buttons">
                <button class="nav-button" id="prev-button" disabled>Previous</button>
                <button class="nav-button" id="next-button">Next Problem</button>
            </div>
            
            <button class="hint-button" id="hint-button">Show Hints & Character Info</button>
            
            <div class="hint-area" id="hint-area">
                <h3>Hints & Character Information</h3>
                <p class="current-hint" id="current-hint">Factor out the common term to simplify the expression.</p>
                <div class="character-info" id="character-info">
                    <!-- Will be filled with JavaScript -->
                </div>
            </div>
        </div>
        
        <div class="character left" id="pi-character">
            <svg class="pi-character" viewBox="0 0 120 120">
                <circle cx="60" cy="60" r="50" fill="#FFD700" />
                <text x="60" y="80" fill="#333" font-size="70" text-anchor="middle">π</text>
                <!-- Eyes -->
                <circle cx="40" cy="40" r="5" fill="#333" />
                <circle cx="80" cy="40" r="5" fill="#333" />
                <!-- Mouth -->
                <path d="M40,70 Q60,90 80,70" stroke="#333" stroke-width="3" fill="none" />
            </svg>
            <div class="character-speech" id="pi-speech">
                Hi! I'm Pi! Let's factor some polynomials together!
            </div>
        </div>
        
        <div class="character right" id="alpha-character">
            <svg class="alpha-character" viewBox="0 0 120 120">
                <circle cx="60" cy="60" r="50" fill="#9575CD" />
                <text x="60" y="80" fill="#333" font-size="70" text-anchor="middle">α</text>
                <!-- Eyes -->
                <circle cx="40" cy="40" r="5" fill="#333" />
                <circle cx="80" cy="40" r="5" fill="#333" />
                <!-- Mouth -->
                <path d="M40,70 Q60,50 80,70" stroke="#333" stroke-width="3" fill="none" />
            </svg>
            <div class="character-speech" id="alpha-speech">
                I'm Alpha! Find the common factors to solve these puzzles!
            </div>
        </div>
    </div>
    
    <div class="feedback" id="feedback"></div>
    
    <div class="settings-panel" id="settings-panel">
        <div class="settings-content">
            <div class="settings-header">
                <h2>Game Settings</h2>
                <button class="close-settings" id="close-settings">✖</button>
            </div>
            
            <div class="settings-group">
                <h3>Difficulty Level</h3>
                <div class="settings-row">
                    <div class="settings-label">Difficulty:</div>
                    <div class="settings-control">
                        <select id="difficulty-select">
                            <option value="beginner">Beginner</option>
                            <option value="intermediate">Intermediate</option>
                            <option value="advanced">Advanced</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="settings-group">
                <h3>Game Settings</h3>
                <div class="settings-row">
                    <div class="settings-label">Game Time (seconds):</div>
                    <div class="settings-control">
                        <input type="range" id="game-time" min="30" max="120" step="10" value="60">
                        <span id="game-time-display">60</span>
                    </div>
                </div>
                <div class="settings-row">
                    <div class="settings-label">Points per Correct Answer:</div>
                    <div class="settings-control">
                        <input type="range" id="points-per-answer" min="1" max="10" value="5">
                        <span id="points-display">5</span>
                    </div>
                </div>
            </div>
            
            <div class="settings-group">
                <h3>Character Settings</h3>
                <div class="settings-row">
                    <div class="settings-label">Show Characters:</div>
                    <div class="settings-control">
                        <input type="checkbox" id="show-characters" checked>
                    </div>
                </div>
                <div class="settings-row">
                    <div class="settings-label">Character Speech:</div>
                    <div class="settings-control">
                        <input type="checkbox" id="character-speech" checked>
                    </div>
                </div>
            </div>
            
            <div class="settings-group">
                <h3>Symbol Settings</h3>
                <div class="settings-row">
                    <div class="settings-label">Use Greek Symbols:</div>
                    <div class="settings-control">
                        <input type="checkbox" id="use-greek" checked>
                    </div>
                </div>
                <div class="settings-row">
                    <div class="settings-label">Use Latin Symbols:</div>
                    <div class="settings-control">
                        <input type="checkbox" id="use-latin" checked>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Game variables
        let score = 0;
        let timer = 180;
        let timerInterval;
        let currentProblem = {};
        let problemHistory = [];
        let currentProblemIndex = -1;
        let gameActive = false;
        let pointsPerCorrectAnswer = 5;
        let difficulty = "beginner";
        
        // Character sets
        const characterSets = {
            english: ['a', 'b', 'c', 'm', 'n', 'p', 'x', 'y', 'z'],
            greek: ['α', 'β', 'γ', 'δ', 'θ', 'λ', 'π', 'φ', 'ω'],
            hindi: ['क', 'ख', 'ग', 'घ', 'च', 'छ', 'ज', 'झ', 'ञ'],
            japanese: ['ア', 'イ', 'ウ', 'エ', 'オ', 'カ', 'キ', 'ク', 'ケ']
        };
        
        // Operation keys for the keyboard
        const operationKeys = [
            { symbol: '+', description: 'Addition operator' },
            { symbol: '-', description: 'Subtraction operator' },
            { symbol: '(', description: 'Opening parenthesis' },
            { symbol: ')', description: 'Closing parenthesis' }
        ];
        
        // Character information for hints
        const charInfo = {
            a: { name: 'a', language: 'Latin/English', description: 'First letter of the English alphabet, often used as a variable in algebra.' },
            b: { name: 'b', language: 'Latin/English', description: 'Second letter of the English alphabet, commonly used as a variable in expressions.' },
            c: { name: 'c', language: 'Latin/English', description: 'Third letter of the English alphabet, frequently represents a constant in math.' },
            m: { name: 'm', language: 'Latin/English', description: 'Often used to represent slope in linear equations or for counting.' },
            n: { name: 'n', language: 'Latin/English', description: 'Commonly used for counting or as a variable in sequences.' },
            p: { name: 'p', language: 'Latin/English', description: 'Often represents probability or a parameter in equations.' },
            x: { name: 'x', language: 'Latin/English', description: 'Most common variable in algebra, represents an unknown value.' },
            y: { name: 'y', language: 'Latin/English', description: 'Frequently paired with x in coordinate systems and equations.' },
            z: { name: 'z', language: 'Latin/English', description: 'Often used as a third variable after x and y, or for complex numbers.' },
            
            'α': { name: 'Alpha', language: 'Greek', description: 'First letter of the Greek alphabet, often used in math and physics.' },
            'β': { name: 'Beta', language: 'Greek', description: 'Second letter of the Greek alphabet, used in various mathematical contexts.' },
            'γ': { name: 'Gamma', language: 'Greek', description: 'Third letter of the Greek alphabet, appears in many mathematical functions.' },
            'δ': { name: 'Delta', language: 'Greek', description: 'Fourth letter of the Greek alphabet, often represents change or difference.' },
            'θ': { name: 'Theta', language: 'Greek', description: 'Eighth letter of the Greek alphabet, commonly used for angles.' },
            'λ': { name: 'Lambda', language: 'Greek', description: 'Eleventh letter of the Greek alphabet, used in calculus and physics.' },
            'π': { name: 'Pi', language: 'Greek', description: 'The famous constant (3.14159...) representing the ratio of a circle\'s circumference to its diameter.' },
            'φ': { name: 'Phi', language: 'Greek', description: 'Twenty-first letter of the Greek alphabet, represents the golden ratio.' },
            'ω': { name: 'Omega', language: 'Greek', description: 'Last letter of the Greek alphabet, often used in mathematics and physics.' },
            
            'क': { name: 'Ka', language: 'Hindi/Devanagari', description: 'First consonant in the Hindi alphabet, used as a variable in this game.' },
            'ख': { name: 'Kha', language: 'Hindi/Devanagari', description: 'Second consonant in the Hindi alphabet, representing a variable here.' },
            'ग': { name: 'Ga', language: 'Hindi/Devanagari', description: 'Third consonant in the Hindi alphabet, used as a mathematical symbol here.' },
            'घ': { name: 'Gha', language: 'Hindi/Devanagari', description: 'Fourth consonant in the Hindi alphabet, represents a variable in this context.' },
            'च': { name: 'Cha', language: 'Hindi/Devanagari', description: 'Fifth consonant in the Hindi alphabet, used as a mathematical term here.' },
            'छ': { name: 'Chha', language: 'Hindi/Devanagari', description: 'Sixth consonant in the Hindi alphabet, representing a variable in our problems.' },
            'ज': { name: 'Ja', language: 'Hindi/Devanagari', description: 'Seventh consonant in the Hindi alphabet, used in our mathematical expressions.' },
            'झ': { name: 'Jha', language: 'Hindi/Devanagari', description: 'Eighth consonant in the Hindi alphabet, represents a term in our equations.' },
            'ञ': { name: 'Nya', language: 'Hindi/Devanagari', description: 'Ninth consonant in the Hindi alphabet, used as a variable in this game.' },
            
            'ア': { name: 'A (a)', language: 'Japanese/Katakana', description: 'First character in the Japanese katakana syllabary, used as a variable here.' },
            'イ': { name: 'I (i)', language: 'Japanese/Katakana', description: 'Second character in the Japanese katakana syllabary, represents a variable.' },
            'ウ': { name: 'U (u)', language: 'Japanese/Katakana', description: 'Third character in the Japanese katakana syllabary, used in our expressions.' },
            'エ': { name: 'E (e)', language: 'Japanese/Katakana', description: 'Fourth character in the Japanese katakana syllabary, represents a term here.' },
            'オ': { name: 'O (o)', language: 'Japanese/Katakana', description: 'Fifth character in the Japanese katakana syllabary, used as a variable.' },
            'カ': { name: 'Ka (ka)', language: 'Japanese/Katakana', description: 'Sixth character in the Japanese katakana syllabary, used in our problems.' },
            'キ': { name: 'Ki (ki)', language: 'Japanese/Katakana', description: 'Seventh character in the Japanese katakana syllabary, represents a term.' },
            'ク': { name: 'Ku (ku)', language: 'Japanese/Katakana', description: 'Eighth character in the Japanese katakana syllabary, used as a variable.' },
            'ケ': { name: 'Ke (ke)', language: 'Japanese/Katakana', description: 'Ninth character in the Japanese katakana syllabary, represents a value.' }
        };

        // DOM elements
        const problemDisplay = document.getElementById('problem-display');
        const answerInput = document.getElementById('answer-input');
        const keyboard = document.getElementById('keyboard');
        const scoreValue = document.getElementById('score-value');
        const timerValue = document.getElementById('timer-value');
        const levelText = document.getElementById('level-text');
        const hintButton = document.getElementById('hint-button');
        const hintArea = document.getElementById('hint-area');
        const currentHint = document.getElementById('current-hint');
        const characterInfoElement = document.getElementById('character-info');
        const feedback = document.getElementById('feedback');
        const piCharacter = document.getElementById('pi-character');
        const alphaCharacter = document.getElementById('alpha-character');
        const piSpeech = document.getElementById('pi-speech');
        const alphaSpeech = document.getElementById('alpha-speech');
        const settingsButton = document.getElementById('settings-button');
        const settingsPanel = document.getElementById('settings-panel');
        const closeSettings = document.getElementById('close-settings');
        const difficultySelect = document.getElementById('difficulty-select');
        const gameTimeInput = document.getElementById('game-time');
        const gameTimeDisplay = document.getElementById('game-time-display');
        const pointsInput = document.getElementById('points-per-answer');
        const pointsDisplay = document.getElementById('points-display');
        const showCharactersCheckbox = document.getElementById('show-characters');
        const characterSpeechCheckbox = document.getElementById('character-speech');
        const useGreekCheckbox = document.getElementById('use-greek');
        const useLatinCheckbox = document.getElementById('use-latin');
        const prevButton = document.getElementById('prev-button');
        const nextButton = document.getElementById('next-button');
        
        // Initialize the game
        function initGame() {
            // Set up event listeners
            hintButton.addEventListener('click', toggleHintArea);
            settingsButton.addEventListener('click', openSettings);
            closeSettings.addEventListener('click', closeSettingsPanel);
            prevButton.addEventListener('click', previousProblem);
            nextButton.addEventListener('click', nextProblem);
            
            // Settings event listeners
            difficultySelect.addEventListener('change', updateDifficulty);
            gameTimeInput.addEventListener('input', updateGameTime);
            pointsInput.addEventListener('input', updatePoints);
            showCharactersCheckbox.addEventListener('change', toggleCharacters);
            useGreekCheckbox.addEventListener('change', updateCharacterSets);
            useLatinCheckbox.addEventListener('change', updateCharacterSets);
            
            // Use settings immediately
            timer = parseInt(gameTimeInput.value);
            timerValue.textContent = timer;
            pointsPerCorrectAnswer = parseInt(pointsInput.value);
            
            // Show characters with animation
            setTimeout(() => {
                if (showCharactersCheckbox.checked) {
                    piCharacter.classList.add('active');
                    setTimeout(() => {
                        alphaCharacter.classList.add('active');
                        
                        // Show initial speech bubbles
                        setTimeout(() => {
                            if (characterSpeechCheckbox.checked) {
                                piSpeech.classList.add('speech-active');
                                
                                setTimeout(() => {
                                    piSpeech.classList.remove('speech-active');
                                    alphaSpeech.classList.add('speech-active');
                                    
                                    setTimeout(() => {
                                        alphaSpeech.classList.remove('speech-active');
                                        generateNewProblem();
                                        startGame();
                                    }, 3000);
                                }, 3000);
                            } else {
                                generateNewProblem();
                                startGame();
                            }
                        }, 500);
                    }, 300);
                } else {
                    generateNewProblem();
                    startGame();
                }
            }, 500);
        }
        
        // Open settings panel
        function openSettings() {
            settingsPanel.style.opacity = '1';
            settingsPanel.style.pointerEvents = 'auto';
        }
        
        // Close settings panel
        function closeSettingsPanel() {
            settingsPanel.style.opacity = '0';
            settingsPanel.style.pointerEvents = 'none';
        }
        
        // Update difficulty setting
        function updateDifficulty() {
            difficulty = difficultySelect.value;
            levelText.textContent = difficulty.charAt(0).toUpperCase() + difficulty.slice(1);
            if (gameActive) {
                generateNewProblem();
            }
        }
        
        // Update game time setting
        function updateGameTime() {
            timer = parseInt(gameTimeInput.value);
            timerValue.textContent = timer;
            gameTimeDisplay.textContent = timer;
        }
        
        // Update points setting
        function updatePoints() {
            pointsPerCorrectAnswer = parseInt(pointsInput.value);
            pointsDisplay.textContent = pointsPerCorrectAnswer;
        }
        
        // Toggle character visibility
        function toggleCharacters() {
            if (showCharactersCheckbox.checked) {
                piCharacter.classList.add('active');
                alphaCharacter.classList.add('active');
            } else {
                piCharacter.classList.remove('active');
                alphaCharacter.classList.remove('active');
            }
        }
        
        // Update character sets
        function updateCharacterSets() {
            if (gameActive) {
                generateNewProblem();
            }
        }
        
        // Generate a new unique problem
        function generateNewProblem() {
            const problem = generateProblem();
            currentProblem = problem;
            problemHistory.push(problem);
            currentProblemIndex = problemHistory.length - 1;
            
            displayProblem(problem);
            updateNavigationButtons();
        }
        
        // Display the current problem
        function displayProblem(problem) {
            problemDisplay.textContent = problem.problem;
            answerInput.value = '';
            
            // Extract characters used in this problem
            const problemChars = extractCharactersFromProblem(problem.problem);
            
            // Build keyboard with only relevant characters
            buildKeyboard(problemChars);
            
            // Update hint based on difficulty
            updateHint(problemChars);
            
            // Character reactions to new problem
            showCharacterReaction(problem.problem);
        }
        
        // Extract unique characters from a problem
        function extractCharactersFromProblem(problemText) {
            const chars = new Set();
            for (let i = 0; i < problemText.length; i++) {
                const char = problemText[i];
                // Only add letters (not operators or spaces)
                if (!/[+\-() ]/.test(char)) {
                    chars.add(char);
                }
            }
            return Array.from(chars);
        }
        
        // Build the keyboard with specific characters
        function buildKeyboard(chars) {
            keyboard.innerHTML = '';
            
            // Add character keys (max 3)
            const limitedChars = chars.slice(0, 3);
            
            limitedChars.forEach(char => {
                const keyButton = document.createElement('button');
                keyButton.className = 'key';
                keyButton.textContent = char;
                keyButton.addEventListener('click', () => {
                    answerInput.value += char;
                });
                keyboard.appendChild(keyButton);
            });
            
            // Add operation keys
            operationKeys.forEach(op => {
                const keyButton = document.createElement('button');
                keyButton.className = 'key operation-key';
                keyButton.textContent = op.symbol;
                keyButton.addEventListener('click', () => {
                    answerInput.value += op.symbol;
                });
                keyboard.appendChild(keyButton);
            });
            
            // Add clear and submit buttons
            const clearButton = document.createElement('button');
            clearButton.className = 'key clear-key';
            clearButton.textContent = 'Clear';
            clearButton.addEventListener('click', () => {
                answerInput.value = '';
            });
            keyboard.appendChild(clearButton);
            
            const submitButton = document.createElement('button');
            submitButton.className = 'key submit-key';
            submitButton.textContent = 'Submit';
            submitButton.addEventListener('click', checkAnswer);
            keyboard.appendChild(submitButton);
            
            // Update character info in hint area
            updateCharacterInfo(chars);
        }
        
        // Update character information in the hint area
        function updateCharacterInfo(chars) {
            characterInfoElement.innerHTML = '';
            
            chars.forEach(char => {
                if (charInfo[char]) {
                    const card = document.createElement('div');
                    card.className = 'character-card';
                    
                    const charName = document.createElement('h4');
                    charName.textContent = `${char} - ${charInfo[char].name}`;
                    
                    const langInfo = document.createElement('p');
                    langInfo.textContent = `Language: ${charInfo[char].language}`;
                    
                    const descInfo = document.createElement('p');
                    descInfo.textContent = charInfo[char].description;
                    
                    card.appendChild(charName);
                    card.appendChild(langInfo);
                    card.appendChild(descInfo);
                    
                    characterInfoElement.appendChild(card);
                }
            });
        }
        
        // Update hint text based on problem and difficulty
        function updateHint(problemChars) {
            switch (difficulty) {
                case 'beginner':
                    currentHint.textContent = `Look for the common factor. Which letter appears in all terms?`;
                    break;
                case 'intermediate':
                    currentHint.textContent = `Find the common factor in each term, then group what's left inside parentheses.`;
                    break;
                case 'advanced':
                    currentHint.textContent = `Try factoring by grouping or finding patterns that can be factored.`;
                    break;
            }
        }
        
        // Show character speech reaction
        function showCharacterReaction(problemText) {
            if (characterSpeechCheckbox.checked) {
                const speeches = [
                    `Can you factor ${problemText}?`,
                    `What's common in all terms?`,
                    `Factor out the common terms!`,
                    `Look for patterns in ${problemText}`,
                    `What variables appear multiple times?`
                ];
                
                const randomSpeech = speeches[Math.floor(Math.random() * speeches.length)];
                
                if (Math.random() < 0.5) {
                    showCharacterSpeech(piCharacter, piSpeech, randomSpeech);
                } else {
                    showCharacterSpeech(alphaCharacter, alphaSpeech, randomSpeech);
                }
            }
        }
        
        // Toggle the hint area visibility
        function toggleHintArea() {
            if (hintArea.style.display === 'block') {
                hintArea.style.display = 'none';
                hintButton.textContent = 'Show Hints & Character Info';
            } else {
                hintArea.style.display = 'block';
                hintButton.textContent = 'Hide Hints & Character Info';
            }
        }
        
        // Generate a factoring problem based on difficulty
        function generateProblem() {
            let availableCharSets = [];
            
            if (useLatinCheckbox.checked) {
                availableCharSets.push(characterSets.english);
            }
            
            if (useGreekCheckbox.checked) {
                availableCharSets.push(characterSets.greek);
            }
            
            // Ensure we have at least one character set
            if (availableCharSets.length === 0) {
                availableCharSets.push(characterSets.english);
                useLatinCheckbox.checked = true;
            }
            
            // Flatten all available character sets
            const allChars = availableCharSets.flat();
            
            // Shuffle and get random characters
            const shuffled = [...allChars].sort(() => 0.5 - Math.random());
            const a = shuffled[0];
            const b = shuffled[1];
            const c = shuffled[2];
            
            let problem = '';
            let solution = '';
            
            // Generate problem based on difficulty
            switch (difficulty) {
                case 'beginner':
                    // Simple factoring like ab + ac = a(b + c)
                    problem = `${a}${b} + ${a}${c}`;
                    solution = `${a}(${b} + ${c})`;
                    break;
                    
                case 'intermediate':
                    // Slightly more complex like ab + ac - ad = a(b + c - d)
                    const d = shuffled[3];
                    problem = `${a}${b} + ${a}${c} - ${a}${d}`;
                    solution = `${a}(${b} + ${c} - ${d})`;
                    break;
                    
                case 'advanced':
                    // More complex patterns
                    const randomType = Math.floor(Math.random() * 3);
                    
                    if (randomType === 0) {
                        // Like ac + bc + ad + bd = (a + b)(c + d)
                        const d = shuffled[3];
                        problem = `${a}${c} + ${b}${c} + ${a}${d} + ${b}${d}`;
                        solution = `(${a} + ${b})(${c} + ${d})`;
                    } else if (randomType === 1) {
                        // Like ab - ac + b - c = (a + 1)(b - c)
                        problem = `${a}${b} - ${a}${c} + ${b} - ${c}`;
                        solution = `(${a} + 1)(${b} - ${c})`;
                    } else {
                        // Like ab - bc - ad + cd = (a - c)(b - d)
                        const d = shuffled[3];
                        problem = `${a}${b} - ${b}${c} - ${a}${d} + ${c}${d}`;
                        solution = `(${a} - ${c})(${b} - ${d})`;
                    }
                    break;
            }
            
            return { problem, solution };
        }
        
        // Show character speech bubble
        function showCharacterSpeech(character, speechBubble, text) {
            speechBubble.textContent = text;
            speechBubble.classList.add('speech-active');
            
            setTimeout(() => {
                speechBubble.classList.remove('speech-active');
            }, 4000);
        }
        
        // Start the game timer
        function startGame() {
            gameActive = true;
            
            // Reset timer and score
            clearInterval(timerInterval);
            timer = parseInt(gameTimeInput.value);
            timerValue.textContent = timer;
            score = 0;
            scoreValue.textContent = score;
            
            // Start the countdown
            timerInterval = setInterval(() => {
                timer--;
                timerValue.textContent = timer;
                
                if (timer <= 0) {
                    endGame();
                }
            }, 1000);
        }
        
        // End the game
        function endGame() {
            clearInterval(timerInterval);
            gameActive = false;
            
            // Display end game message
            problemDisplay.textContent = `Game Over! Final Score: ${score}`;
            answerInput.value = '';
            
            // Character reactions
            if (characterSpeechCheckbox.checked) {
                if (score > 50) {
                    showCharacterSpeech(piCharacter, piSpeech, `Amazing job! Score: ${score}! You're a factoring genius!`);
                    setTimeout(() => {
                        showCharacterSpeech(alphaCharacter, alphaSpeech, `Want to play again? Click the problem to start!`);
                    }, 4500);
                } else if (score > 25) {
                    showCharacterSpeech(alphaCharacter, alphaSpeech, `Great work! Score: ${score}! Keep practicing!`);
                    setTimeout(() => {
                        showCharacterSpeech(piCharacter, piSpeech, `Ready for another round? Click to play again!`);
                    }, 4500);
                } else {
                    showCharacterSpeech(piCharacter, piSpeech, `Good effort! Score: ${score}. Factoring takes practice!`);
                    setTimeout(() => {
                        showCharacterSpeech(alphaCharacter, alphaSpeech, `Let's try again! Click to start a new game!`);
                    }, 4500);
                }
            }
            
            // Allow clicking the problem area to restart
            problemDisplay.style.cursor = 'pointer';
            problemDisplay.addEventListener('click', function restartHandler() {
                problemDisplay.style.cursor = 'default';
                problemDisplay.removeEventListener('click', restartHandler);
                
                // Reset problem history
                problemHistory = [];
                currentProblemIndex = -1;
                
                // Generate new problem
                generateNewProblem();
                startGame();
            });
        }
        
        // Check the submitted answer
        function checkAnswer() {
            if (!gameActive) return;
            
            const userAnswer = answerInput.value;
            
            // Normalize both answers for comparison (remove spaces)
            const normalizedUserAnswer = userAnswer.replace(/\s+/g, '');
            const normalizedSolution = currentProblem.solution.replace(/\s+/g, '');
            
            // Check for alternative correct forms (commutative property)
            let isCorrect = false;
            
            // Direct match after normalization
            if (normalizedUserAnswer === normalizedSolution) {
                isCorrect = true;
            }
            
            // For beginner problems like a(b + c), also accept a(c + b)
            if (difficulty === "beginner" && !isCorrect) {
                // Extract the pattern a(b + c)
                const match = currentProblem.solution.match(/^(\S+)\((\S+)\s*\+\s*(\S+)\)$/);
                if (match) {
                    const [_, factor, term1, term2] = match;
                    // Check if user entered a(c + b) instead of a(b + c)
                    const alternativeSolution = `${factor}(${term2} + ${term1})`;
                    const normalizedAlternative = alternativeSolution.replace(/\s+/g, '');
                    
                    if (normalizedUserAnswer === normalizedAlternative) {
                        isCorrect = true;
                    }
                }
            }
            
            // Check if the answer is correct
            if (isCorrect) {
                // Correct answer
                showFeedback('Correct!', 'success');
                score += pointsPerCorrectAnswer;
                scoreValue.textContent = score;
                
                // Create confetti effect
                createConfetti();
                
                // Character reactions
                if (characterSpeechCheckbox.checked) {
                    const speeches = [
                        "Great job! You got it right!",
                        "Perfect factoring!",
                        "Excellent work!",
                        "That's correct! You're amazing!",
                        "Wonderful! Keep it up!"
                    ];
                    
                    const randomSpeech = speeches[Math.floor(Math.random() * speeches.length)];
                    
                    if (Math.random() < 0.5) {
                        showCharacterSpeech(piCharacter, piSpeech, randomSpeech);
                    } else {
                        showCharacterSpeech(alphaCharacter, alphaSpeech, randomSpeech);
                    }
                }
                
                // Move to next problem after delay
                setTimeout(() => {
                    generateNewProblem();
                }, 1500);
            } else {
                // Incorrect answer
                showFeedback('Try again!', 'error');
                
                // Shake the problem display
                problemDisplay.classList.add('shake');
                setTimeout(() => {
                    problemDisplay.classList.remove('shake');
                }, 500);
                
                // Character reactions
                if (characterSpeechCheckbox.checked) {
                    const speeches = [
                        "Not quite right. Try again!",
                        "Look for the common factor!",
                        "Almost there! Check your work.",
                        "You're close! Look carefully.",
                        "Try factoring out the common term."
                    ];
                    
                    const randomSpeech = speeches[Math.floor(Math.random() * speeches.length)];
                    
                    if (Math.random() < 0.5) {
                        showCharacterSpeech(piCharacter, piSpeech, randomSpeech);
                    } else {
                        showCharacterSpeech(alphaCharacter, alphaSpeech, randomSpeech);
                    }
                }
            }
        }
        
        // Show feedback message
        function showFeedback(message, type) {
            feedback.textContent = message;
            feedback.className = `feedback ${type}`;
            feedback.style.display = 'block';
            
            setTimeout(() => {
                feedback.style.display = 'none';
            }, 1500);
        }
        
        // Create confetti effect for correct answers
        function createConfetti() {
            const confettiCount = 100;
            const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff'];
            
            for (let i = 0; i < confettiCount; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = `${Math.random() * 100}%`;
                confetti.style.top = `-10px`;
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                
                document.body.appendChild(confetti);
                
                // Animate falling
                const animationDuration = 1000 + Math.random() * 2000;
                confetti.style.transition = `top ${animationDuration}ms ease-out, left ${animationDuration}ms ease-out, opacity ${animationDuration}ms ease-out`;
                
                setTimeout(() => {
                    confetti.style.top = `${window.innerHeight}px`;
                    confetti.style.left = `${parseInt(confetti.style.left) + (Math.random() * 100 - 50)}px`;
                    confetti.style.opacity = '0';
                    
                    setTimeout(() => {
                        confetti.remove();
                    }, animationDuration);
                }, 10);
            }
        }
        
        // Navigate to previous problem
        function previousProblem() {
            if (currentProblemIndex > 0) {
                currentProblemIndex--;
                currentProblem = problemHistory[currentProblemIndex];
                displayProblem(currentProblem);
                updateNavigationButtons();
            }
        }
        
        // Navigate to next problem
        function nextProblem() {
            if (currentProblemIndex < problemHistory.length - 1) {
                // Show next problem in history
                currentProblemIndex++;
                currentProblem = problemHistory[currentProblemIndex];
                displayProblem(currentProblem);
            } else {
                // Generate a new problem
                generateNewProblem();
            }
            updateNavigationButtons();
        }
        
        // Update navigation button states
        function updateNavigationButtons() {
            prevButton.disabled = currentProblemIndex <= 0;
            nextButton.textContent = currentProblemIndex < problemHistory.length - 1 ? "Next Problem" : "New Problem";
        }
        
        // Initialize the game on load
        window.addEventListener('load', initGame);
    </script>
</body>
</html>
