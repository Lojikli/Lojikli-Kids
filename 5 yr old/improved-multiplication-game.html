<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Stars: Multiplication</title>
    <style>
        /* Fun, colorful theme for children */
        body {
            font-family: 'Comic Sans MS',  sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #c4e0f9 0%, #add8e6 100%);
            color: #333;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        /* Header & Game Info */
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .game-title {
            color: #4682b4;
            font-size: 32px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        .game-info {
            display: flex;
            gap: 20px;
        }
        
        .score, .level {
            background-color: #4682b4;
            color: white;
            padding: 10px 20px;
            border-radius: 50px;
            font-size: 18px;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .level-description {
            position: absolute;
            top: 60px;
            right: 20px;
            background-color: #3cb371;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        /* Problem Display Area */
        .problem-display {
            position: relative;
            margin: 20px auto;
            max-width: 500px;
            background-color: #f0f8ff;
            border-radius: 15px;
            padding: 20px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
        }
        
        .multiplication-problem {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            font-family: 'Comic Sans MS', cursive, sans-serif;
            font-size: 40px;
            font-weight: bold;
            color: #4682b4;
        }
        
        .problem-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            position: relative;
        }
        
        .operator {
            margin-right: 10px;
            font-size: 40px;
        }
        
        .number-container {
            display: flex;
        }
        
        .digit {
            width: 50px;
            height: 60px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            margin: 0 5px;
            border-radius: 8px;
            background-color: rgba(255,255,255,0.7);
        }
        
        .digit.operand {
            color: #4682b4;
        }
        
        .digit.highlighted {
            background-color: rgba(255, 255, 0, 0.3);
            box-shadow: 0 0 10px yellow;
        }
        
        .digit.result {
            color: #3cb371;
        }
        
        .carry {
            position: absolute;
            top: -25px;
            right: 5px;
            font-size: 22px;
            color: #ff7f50;
            background-color: rgba(255,255,255,0.7);
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .carry.visible {
            opacity: 1;
        }
        
        .line {
            height: 5px;
            background-color: #4682b4;
            margin: 10px 0;
            width: 100%;
            border-radius: 5px;
        }
        
        /* Work Area */
        .work-area {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }
        
        .partial-product {
            display: flex;
            margin: 5px 0;
            color: #3cb371;
            font-family: 'Comic Sans MS', cursive, sans-serif;
            font-size: 40px;
        }
        
        /* Improved Step Input Area */
        .current-step {
            display: flex;
            flex-direction: column;
            margin-top: 20px;
            align-items: center;
            background-color: rgba(70, 130, 180, 0.1);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            position: relative;
            overflow: hidden;
        }
        
        .step-title {
            font-size: 26px;
            font-weight: bold;
            color: #4682b4;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .step-prompt {
            font-size: 22px;
            color: #4682b4;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
            line-height: 1.4;
            max-width: 400px;
        }
        
        .step-input-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }
        
        .step-graphic {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            position: relative;
        }
        
        .step-number {
            font-size: 30px;
            margin: 0 15px;
        }
        
        .step-symbol {
            font-size: 30px;
            margin: 0 15px;
        }
        
        .step-equals {
            font-size: 30px;
            margin: 0 15px;
        }
        
        .multiplication-highlight {
            display: flex;
            align-items: center;
            position: relative;
        }
        
        .x-symbol {
            font-size: 30px;
            margin: 0 10px;
        }
        
        .step-input {
            width: 60px;
            height: 60px;
            font-size: 36px;
            text-align: center;
            border: 3px solid #4682b4;
            border-radius: 10px;
            margin: 0 5px;
            background-color: white;
            color: #3cb371;
            font-family: 'Comic Sans MS', cursive, sans-serif;
            caret-color: #4682b4;
        }
        
        .step-input:focus {
            outline: none;
            box-shadow: 0 0 0 5px rgba(70, 130, 180, 0.3);
            transform: scale(1.05);
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0 5px;
            position: relative;
        }
        
        .input-label {
            font-size: 18px;
            font-weight: bold;
            color: #4682b4;
            margin-bottom: 5px;
        }
        
        .input-hint {
            font-size: 16px;
            color: #3cb371;
            margin-top: 5px;
            text-align: center;
        }
        
        .carry-input {
            width: 40px;
            height: 40px;
            font-size: 22px;
            border: 3px solid #ff7f50;
            border-radius: 50%;
            text-align: center;
            background-color: white;
            color: #ff7f50;
            position: absolute;
            top: -50px;
            right: 15px;
            caret-color: #ff7f50;
        }
        
        .carry-input:focus {
            outline: none;
            box-shadow: 0 0 0 5px rgba(255, 127, 80, 0.3);
        }
        
        .carry-arrow {
            position: absolute;
            color: #ff7f50;
            font-size: 24px;
            top: -25px;
            right: 27px;
        }
        
        .carry-explanation {
            position: absolute;
            background-color: rgba(255, 127, 80, 0.15);
            border: 2px dashed #ff7f50;
            color: #ff7f50;
            font-size: 14px;
            font-weight: bold;
            border-radius: 10px;
            padding: 5px 10px;
            top: -80px;
            left: 160px
            right: -50px;
            max-width: 160px;
            text-align: center;
        }
        
        /* Help arrows and indicators */
        .pointing-arrow {
            font-size: 24px;
            color: #ff7f50;
            margin: 5px;
            animation: bounce 1s infinite;
        }
        
        .direction-hint {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 8px 12px;
            border-radius: 20px;
            color: #4682b4;
            font-size: 16px;
            display: flex;
            align-items: center;
            border: 2px solid #4682b4;
            font-weight: bold;
        }
        
        .direction-icon {
            margin-right: 5px;
        }
        
        /* Feedback area */
        .feedback {
            text-align: center;
            font-size: 28px;
            margin: 20px 0;
            min-height: 40px;
            transition: all 0.3s ease;
            font-weight: bold;
        }
        
        .feedback.correct {
            color: #3cb371;
        }
        
        .feedback.incorrect {
            color: #ff7f50;
        }
        
        /* Navigation buttons */
        .navigation {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }
        
        .nav-button {
            padding: 15px 30px;
            font-size: 20px;
            font-weight: bold;
            background-color: #4682b4;
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .nav-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 10px rgba(0,0,0,0.2);
        }
        
        .nav-button:active {
            transform: translateY(1px);
            box-shadow: 0 2px 3px rgba(0,0,0,0.2);
        }
        
        .nav-button:disabled {
            background-color: #b0c4de;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .help-button {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background-color: #4682b4;
            color: white;
            font-size: 30px;
            font-weight: bold;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        /* Achievement stars */
        .awards {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }
        
        .award {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            opacity: 0.3;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .award.earned {
            opacity: 1;
            background-color: gold;
            animation: pulse 0.5s ease;
        }
        
        .award-tooltip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 10px;
            font-size: 14px;
            bottom: 70px;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        
        .award:hover .award-tooltip {
            opacity: 1;
        }
        
        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            position: relative;
        }
        
        .modal-title {
            font-size: 28px;
            color: #4682b4;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .close-button {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 30px;
            cursor: pointer;
            color: #4682b4;
        }
        
        /* Quick Start Modal */
        .quick-start-modal {
            text-align: center;
        }
        
        .quick-start-modal p {
            margin-bottom: 20px;
            font-size: 18px;
        }
        
        .quick-start-button {
            font-size: 24px;
            padding: 15px 40px;
            margin-top: 20px;
        }
        
        .math-tip {
            background-color: #f0f8ff;
            padding: 15px;
            border-radius: 15px;
            margin: 15px 0;
            border-left: 5px solid #4682b4;
            font-size: 18px;
        }
        
        .example-image {
            max-width: 100%;
            margin: 10px 0;
            border-radius: 10px;
            border: 2px solid #4682b4;
        }
        
        /* Carrying Guide */
        .carrying-guide {
            margin: 20px 0;
            padding: 15px;
            background-color: rgba(255, 127, 80, 0.1);
            border-radius: 15px;
            border-left: 5px solid #ff7f50;
        }
        
        .carrying-title {
            font-weight: bold;
            color: #ff7f50;
            margin-bottom: 10px;
            font-size: 20px;
        }
        
        .carrying-steps {
            display: flex;
            align-items: center;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .carrying-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            max-width: 150px;
        }
        
        .step-number-circle {
            width: 30px;
            height: 30px;
            background-color: #ff7f50;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .carrying-text {
            font-size: 16px;
        }
        
        /* Visual helper elements */
        .multiply-together {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin: 10px 0;
            position: relative;
        }
        
        .multiply-arrow {
            position: absolute;
            color: #ff7f50;
            font-size: 18px;
            animation: floatArrow 2s infinite;
        }
        
        .right-to-left-hint {
            background-color: rgba(255, 255, 255, 0.9);
            border: 2px dashed #ff7f50;
            border-radius: 8px;
            padding: 5px 10px;
            position: absolute;
            top: -5px;
            right: 5px;
            font-size: 14px;
            color: #ff7f50;
            font-weight: bold;
            z-index: 10;
        }
        
        /* Level Badge */
        .level-badge {
            position: absolute;
            top: 10px;
            right: 90px;
            background-color: gold;
            color: #333;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 10;
        }
        
        /* Better Animations */
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        @keyframes floatArrow {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }
        
        .celebrating {
            animation: pulse 0.5s ease infinite;
        }
        
        /* Celebration elements */
        .confetti {
            position: fixed;
            width: 15px;
            height: 15px;
            background-color: #f0f;
            clip-path: polygon(50% 0%, 90% 20%, 100% 60%, 75% 100%, 25% 100%, 0% 60%, 10% 20%);
            animation: fall 5s linear forwards;
            z-index: 1000;
        }
        
        @keyframes fall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
        }
        
        .red { background-color: #ff7f50; }
        .blue { background-color: #4682b4; }
        .green { background-color: #3cb371; }
        .yellow { background-color: #ffd700; }
        .purple { background-color: #9370db; }
        
        /* Highlight for active elements */
        .highlight {
            box-shadow: 0 0 15px 5px gold;
            animation: pulse 1.5s infinite;
            z-index: 5;
        }
        
        /* Mascot character */
        .mascot {
            position: absolute;
            width: 100px;
            height: 100px;
            bottom: -20px;
            left: -30px;
            z-index: 10;
            animation: bounce 2s infinite;
        }
        
        .mascot-speech {
            position: absolute;
            background-color: white;
            border: 2px solid #4682b4;
            border-radius: 15px;
            padding: 10px;
            font-size: 14px;
            width: 170px;
            left: -30px;
            bottom: 50px;
            z-index: 11;
            line-height: 1.4;
        }
        
        .mascot-speech:after {
            content: '';
            position: absolute;
            left: -10px;
            bottom: 10px;
            width: 0;
            height: 0;
            border-top: 10px solid transparent;
            border-bottom: 10px solid transparent;
            border-right: 10px solid white;
        }
        
        /* Better step visualization */
        .step-visualization {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
        }
        
        /* Progress indicator */
        .progress-bar {
            width: 90%;
            height: 15px;
            background-color: #e0e0e0;
            border-radius: 10px;
            margin: 20px auto;
            position: relative;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #3cb371;
            border-radius: 10px;
            transition: width 0.5s ease;
        }
        
        .progress-step {
            position: absolute;
            top: -20px;
            font-size: 12px;
            color: #4682b4;
            transform: translateX(-50%);
        }
        
        /* Paper-like grid for multiplication */
        .grid-background {
            background-image: linear-gradient(#e5e5e5 1px, transparent 1px), 
                              linear-gradient(90deg, #e5e5e5 1px, transparent 1px);
            background-size: 60px 60px;
            background-position: -1px -1px;
            opacity: 0.3;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
        }
        
        /* Level selector */
        .level-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 10px 0;
        }
        
        .level-btn {
            padding: 8px 16px;
            background-color: #e0e0e0;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .level-btn.active {
            background-color: #4682b4;
            color: white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        /* Level description tooltip */
        .level-info {
            font-size: 14px;
            margin: 0 10px;
            color: #4682b4;
            cursor: help;
            position: relative;
        }
        
        .level-info-tooltip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 10px;
            font-size: 14px;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
            z-index: 100;
        }
        
        .level-info:hover .level-info-tooltip {
            opacity: 1;
        }
        
        /* Highlighter animation */
        @keyframes highlightDigit {
            0% { background-color: rgba(255, 255, 0, 0); }
            50% { background-color: rgba(255, 255, 0, 0.5); }
            100% { background-color: rgba(255, 255, 0, 0); }
        }
        
        .highlight-animation {
            animation: highlightDigit 1.5s ease infinite;
        }
        
        /* Paper-like elements */
        .paper-container {
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            position: relative;
            overflow: hidden;
        }
        
        /* Improved carrying visualization */
        .carry-visualization {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        .carry-demo {
            position: relative;
            margin: 0 20px;
            font-size: 30px;
            font-weight: bold;
        }
        
        .carry-arrow-demo {
            color: #ff7f50;
            font-size: 30px;
            margin: 0 10px;
        }
        
        .carry-number {
            position: absolute;
            top: -25px;
            color: #ff7f50;
            font-size: 20px;
        }
        
        /* Level completion modal */
        .level-complete-modal .modal-content {
            background: linear-gradient(135deg, #fff 0%, #f0f8ff 100%);
            text-align: center;
        }
        
        .level-complete-title {
            font-size: 36px;
            color: #3cb371;
            margin-bottom: 20px;
        }
        
        .level-complete-stars {
            font-size: 50px;
            margin: 20px 0;
        }
        
        .level-complete-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }
        
        .next-level-btn {
            background-color: #3cb371;
        }
    </style>
</head>
<body>
    <!-- Main game container -->
    <div class="container">
        <!-- Game header with title and score -->
        <div class="game-header">
            <div class="game-title">Math Stars: Multiplication</div>
            <div class="game-info">
                <div class="level">Level: <span id="level">1</span></div>
                <div class="score">Score: <span id="score">0</span></div>
            </div>
        </div>
        
        <!-- Level description badge -->
        <div class="level-description" id="level-description">1-digit √ó 1-digit</div>
        
        <!-- Help button -->
        <button class="help-button" id="help-button">?</button>
        
        <!-- Problem display area -->
        <div class="problem-display">
            <div class="grid-background"></div>
            <div class="direction-hint">
                <span class="direction-icon">üëâ</span> Always work right to left!
            </div>
            <div class="multiplication-problem" id="multiplication-problem">
                <!-- Problem will be generated here by JavaScript -->
            </div>
            
            <!-- Current step input with improved clarity -->
            <div class="current-step" id="current-step">
                <div class="step-title">Let's Multiply!</div>
                <div class="step-visualization" id="step-visualization">
                    <!-- Visual representation of current step -->
                </div>
                <div class="step-prompt" id="step-prompt">What is 2 √ó 3?</div>
                <div class="step-input-container" id="step-input-container">
                    <!-- Step inputs will be generated here -->
                </div>
                
                <!-- Mascot helper -->
                <img src="https://cdn-icons-png.flaticon.com/512/3771/3771417.png" class="mascot" id="mascot">
                <div class="mascot-speech" id="mascot-speech">
                    Let's multiply these numbers together!
                </div>
            </div>
        </div>
        
        <!-- Progress indicator -->
        <div class="progress-bar">
            <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
        </div>
        
        <!-- Feedback display -->
        <div class="feedback" id="feedback"></div>
        
        <!-- Navigation buttons -->
        <div class="navigation">
            <button class="nav-button" id="check-button">Check My Answer</button>
            <button class="nav-button" id="hint-button">Help Me</button>
            <button class="nav-button" id="new-problem-button">New Problem</button>
        </div>
        
<!-- Achievement stars -->
<div class="awards">
    <div class="award" id="award-speed">
        ‚≠ê
        <div class="award-tooltip">Speed Star: Complete problems quickly</div>
    </div>
    <div class="award" id="award-streak">
        üî•
        <div class="award-tooltip">Streak Star: Solve 5 in a row</div>
    </div>
    <div class="award" id="award-perfect">
        üåü
        <div class="award-tooltip">Perfect Star: No mistakes</div>
    </div>
    <div class="award" id="award-level">
        üëë
        <div class="award-tooltip">Level Master: Complete all levels</div>
    </div>
</div>
</div>

<!-- Quick Start Modal -->
<div class="modal" id="quick-start-modal">
<div class="modal-content quick-start-modal">
    <div class="modal-title">Welcome to Math Stars: Multiplication!</div>
    <p>We'll learn multiplication step-by-step, just like on paper!</p>
    
    <div class="level-selector">
        <button class="level-btn active" data-level="1">Level 1</button>
        <button class="level-btn" data-level="2">Level 2</button>
        <button class="level-btn" data-level="3">Level 3</button>
        <span class="level-info">‚ÑπÔ∏è
            <div class="level-info-tooltip">
                Level 1: 1-digit √ó 1-digit<br>
                Level 2: 1-digit √ó 2-digit<br>
                Level 3: 2-digit √ó 2-digit
            </div>
        </span>
    </div>
    
    <div class="math-tip">
        <strong>How to Multiply:</strong>
        <ol>
            <li>We always start from the right side (ones place)</li>
            <li>Multiply each digit pair</li>
            <li>When the answer is bigger than 9, write down the ones place and carry the tens digit</li>
        </ol>
    </div>
    
    <div class="carrying-guide">
        <div class="carrying-title">How Carrying Works:</div>
        <div class="carrying-steps">
            <div class="carrying-step">
                <div class="step-number-circle">1</div>
                <div class="carrying-text">Multiply: 8 √ó 7 = 56</div>
            </div>
            <div class="carrying-step">
                <div class="step-number-circle">2</div>
                <div class="carrying-text">Write down 6</div>
            </div>
            <div class="carrying-step">
                <div class="step-number-circle">3</div>
                <div class="carrying-text">Carry the 5 above the next column</div>
            </div>
        </div>
        
        <div class="carry-visualization">
            <div class="carry-demo">
                <span class="carry-number">5</span>
                <span>8 √ó 7 = 56</span>
            </div>
            <div class="carry-arrow-demo">‚Üí</div>
            <div class="carry-demo">
                Write 6, carry 5
            </div>
        </div>
    </div>
    
    <p>Ready to become a multiplication star? Let's go!</p>
    <button class="nav-button quick-start-button" id="start-game-button">Start!</button>
</div>
</div>

<!-- Help modal with improved carrying explanation -->
<div class="modal" id="help-modal">
<div class="modal-content">
    <div class="modal-title">How To Multiply Numbers</div>
    <span class="close-button" id="close-button">√ó</span>
    
    <div class="math-tip">
        <strong>The Big Idea:</strong> Multiplication is just repeated addition. When we write 4 √ó 3, we're adding 4 three times: 4 + 4 + 4 = 12
    </div>
    
    <p><strong>Basic Steps:</strong></p>
    <ol>
        <li>Always work from right to left, just like in real math problems</li>
        <li>Multiply the digits together one by one</li>
        <li>When you get a number bigger than 9, write down the ones digit and carry the tens digit</li>
    </ol>
    
    <div class="carrying-guide">
        <div class="carrying-title">Carrying Made Simple:</div>
        <p>When you multiply digits and get a two-digit answer:</p>
        <div class="carrying-steps">
            <div class="carrying-step">
                <div class="step-number-circle">1</div>
                <div class="carrying-text">Write the ones digit (right digit) in the answer</div>
            </div>
            <div class="carrying-step">
                <div class="step-number-circle">2</div>
                <div class="carrying-text">The tens digit (left digit) gets carried to the next column</div>
            </div>
        </div>
        
        <div class="paper-container">
            <div class="carry-visualization">
                <div class="carry-demo">
                    <span class="carry-number">2</span>
                    <span>6 √ó 5 = 30</span>
                </div>
                <div class="carry-arrow-demo">‚Üí</div>
                <div class="carry-demo">
                    <span>Write 0, carry 3</span>
                </div>
            </div>
        </div>
    </div>
    
    <p><strong>For larger problems (Level 2 & 3):</strong></p>
    <ol>
        <li>First multiply each digit of the top number by the ones digit of the bottom number</li>
        <li>Then multiply each digit of the top number by the tens digit of the bottom number</li>
        <li>Write this second result one place to the left (adding a zero at the end)</li>
        <li>Add the partial products together to get your final answer</li>
    </ol>
    
    <button class="nav-button" id="start-tutorial">Show Me Step-by-Step</button>
</div>
</div>

<!-- Level complete modal -->
<div class="modal" id="level-complete-modal">
<div class="modal-content level-complete-modal">
    <div class="level-complete-title">Level Complete!</div>
    <div class="level-complete-stars">‚≠ê‚≠ê‚≠ê</div>
    <p>Congratulations! You've mastered this level of multiplication!</p>
    <div class="level-complete-buttons">
        <button class="nav-button" id="replay-level-button">Replay Level</button>
        <button class="nav-button next-level-btn" id="next-level-button">Next Level</button>
    </div>
</div>
</div>

<script>
class MultiplicationGame {
    constructor() {
        // Game state
        this.score = 0;
        this.level = 1;
        this.streak = 0;
        this.multiplier = 0;  // First number (top)
        this.multiplicand = 0; // Second number (bottom)
        this.currentStep = 0;
        this.currentDigit = 0;
        this.totalSteps = 0;
        this.currentRow = 0;
        this.steps = [];
        this.solution = [];
        this.stepInputs = [];
        this.carryInputs = [];
        this.tutorialMode = false;
        this.perfectSolution = true;
        this.problemsCompleted = 0;
        this.levelConfig = {
            1: {
                name: "1-digit √ó 1-digit",
                multiplierDigits: 1,
                multiplicandDigits: 1,
                problemsToComplete: 5
            },
            2: {
                name: "1-digit √ó 2-digit",
                multiplierDigits: 2,
                multiplicandDigits: 1,
                problemsToComplete: 5
            },
            3: {
                name: "2-digit √ó 2-digit",
                multiplierDigits: 2,
                multiplicandDigits: 2,
                problemsToComplete: 5
            }
        };
        this.awards = {
            speed: false,
            streak: false,
            perfect: false,
            level: false
        };
        
        // Mascot messages
        this.mascotMessages = {
            start: [
                "Let's multiply these numbers!",
                "We always start from the right side!",
                "Ready to solve this step by step!",
                "You've got this!",
                "Math is fun when we break it down!"
            ],
            correct: [
                "Great job!",
                "You're a math star!",
                "Perfect!",
                "You're so smart!",
                "Amazing work!",
                "Keep it up!"
            ],
            incorrect: [
                "Try again! You can do it!",
                "Almost there!",
                "Let me help you!",
                "Think carefully!",
                "Check your multiplication!"
            ],
            hint: [
                "Multiply the digits together!",
                "Remember to carry the tens digit!",
                "Count carefully!",
                "Try using your fingers to count!",
                "Think of multiplication as repeated addition!"
            ],
            carry: [
                "Don't forget to carry! The tens digit goes on top.",
                "When you get a two-digit answer, the first digit gets carried.",
                "Carrying is like saving the tens digit for the next column.",
                "The carried number adds to the next multiplication step."
            ]
        };
        
        // Extra level-specific mascot messages
        this.levelMessages = {
            1: [
                "Simple one-digit multiplication!",
                "Just multiply the numbers together!",
                "What's the product of these numbers?"
            ],
            2: [
                "Now we're working with a 2-digit number on top!",
                "Remember to multiply each digit and carry when needed!",
                "Start with the ones place, then move to the tens place."
            ],
            3: [
                "This is multi-digit multiplication!",
                "We'll make partial products and add them up.",
                "Take it one step at a time, working right to left."
            ]
        };
        
        // Timing for speed award
        this.startTime = null;
        
        // Get DOM elements
        this.elements = {
            multiplicationProblem: document.getElementById('multiplication-problem'),
            feedback: document.getElementById('feedback'),
            score: document.getElementById('score'),
            level: document.getElementById('level'),
            levelDescription: document.getElementById('level-description'),
            checkButton: document.getElementById('check-button'),
            hintButton: document.getElementById('hint-button'),
            newProblemButton: document.getElementById('new-problem-button'),
            awardSpeed: document.getElementById('award-speed'),
            awardStreak: document.getElementById('award-streak'),
            awardPerfect: document.getElementById('award-perfect'),
            awardLevel: document.getElementById('award-level'),
            helpButton: document.getElementById('help-button'),
            modal: document.getElementById('help-modal'),
            quickStartModal: document.getElementById('quick-start-modal'),
            levelCompleteModal: document.getElementById('level-complete-modal'),
            closeButton: document.getElementById('close-button'),
            startTutorial: document.getElementById('start-tutorial'),
            startGameButton: document.getElementById('start-game-button'),
            stepPrompt: document.getElementById('step-prompt'),
            stepInputContainer: document.getElementById('step-input-container'),
            stepVisualization: document.getElementById('step-visualization'),
            currentStep: document.getElementById('current-step'),
            mascot: document.getElementById('mascot'),
            mascotSpeech: document.getElementById('mascot-speech'),
            progressFill: document.getElementById('progress-fill'),
            replayLevelButton: document.getElementById('replay-level-button'),
            nextLevelButton: document.getElementById('next-level-button')
        };
        
        // Initialize the game
        this.setupEventListeners();
        
        // Show quick start screen
        this.showQuickStart();
    }
    
    // Setup event listeners for buttons and inputs
    setupEventListeners() {
        this.elements.checkButton.addEventListener('click', () => this.checkCurrentStep());
        this.elements.hintButton.addEventListener('click', () => this.showHint());
        this.elements.newProblemButton.addEventListener('click', () => this.generateProblem());
        this.elements.helpButton.addEventListener('click', () => this.showHelp());
        this.elements.closeButton.addEventListener('click', () => this.closeHelp());
        this.elements.startTutorial.addEventListener('click', () => this.startTutorial());
        this.elements.startGameButton.addEventListener('click', () => this.startGame());
        this.elements.replayLevelButton.addEventListener('click', () => this.replayLevel());
        this.elements.nextLevelButton.addEventListener('click', () => this.nextLevel());
        
        // Level selector in quick start
        document.querySelectorAll('.level-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                // Remove active class from all buttons
                document.querySelectorAll('.level-btn').forEach(b => {
                    b.classList.remove('active');
                });
                
                // Add active class to clicked button
                e.target.classList.add('active');
                
                // Set level
                this.level = parseInt(e.target.dataset.level);
            });
        });
        
        // Add keyboard support
        document.addEventListener('keydown', (e) => {
            // Enter key - check answer
            if (e.key === 'Enter') {
                this.checkCurrentStep();
            }
            // Space key - new problem when complete
            else if (e.key === ' ' && this.currentStep >= this.solution.length) {
                this.generateProblem();
            }
        });
    }
    
    // Show quick start modal
    showQuickStart() {
        this.elements.quickStartModal.style.display = 'flex';
    }
    
    // Start the game from quick start
    startGame() {
        this.elements.quickStartModal.style.display = 'none';
        this.updateLevelDescription();
        this.generateProblem();
    }
    
    // Update the level description badge
    updateLevelDescription() {
        const levelConfig = this.levelConfig[this.level];
        this.elements.levelDescription.textContent = levelConfig.name;
        this.elements.level.textContent = this.level;
        
        // Reset problem counter for new level
        this.problemsCompleted = 0;
    }
    
    // Show help modal
    showHelp() {
        this.elements.modal.style.display = 'flex';
    }
    
    // Close help modal
    closeHelp() {
        this.elements.modal.style.display = 'none';
    }
    
    // Replay current level
    replayLevel() {
        this.elements.levelCompleteModal.style.display = 'none';
        this.problemsCompleted = 0;
        this.generateProblem();
    }
    
    // Go to next level
    nextLevel() {
        this.elements.levelCompleteModal.style.display = 'none';
        if (this.level < Object.keys(this.levelConfig).length) {
            this.level++;
            this.updateLevelDescription();
            this.problemsCompleted = 0;
            this.generateProblem();
        } else {
            // Game completed - award level master badge
            this.awardBadge('level');
            this.generateProblem();
        }
    }
    
    // Show hint for current step
    showHint() {
        if (this.currentStep >= this.solution.length) {
            return;
        }
        
        // Get current solution step
        const currentSolution = this.solution[this.currentStep];
        
        // Specific hints based on step type and level
        let hintMessage = "";
        
        if (currentSolution.type === 'addition') {
            hintMessage = "Add all the numbers in this column together!";
        } else {
            const digitStepIndex = currentSolution.partialProduct.length - 1 - this.currentDigit;
            const digitStep = currentSolution.partialProduct[digitStepIndex];
            
            // Highlight the digits being multiplied
            this.highlightMultiplicationDigits(currentSolution, digitStep);
            
            if (this.level === 1) {
                hintMessage = `What is ${digitStep.multiplierDigit} √ó ${digitStep.multiplicandDigit}?`;
            } else if (digitStep.product > 9) {
                // Provide carrying hint
                hintMessage = this.mascotMessages.carry[Math.floor(Math.random() * this.mascotMessages.carry.length)];
            } else {
                hintMessage = `Multiply ${digitStep.multiplierDigit} √ó ${digitStep.multiplicandDigit} and write the answer.`;
            }
        }
        
        // Show hint in mascot speech bubble
        this.elements.mascotSpeech.textContent = hintMessage;
        
        // Make mascot bounce to draw attention
        this.elements.mascot.style.animation = 'none';
        setTimeout(() => {
            this.elements.mascot.style.animation = 'bounce 2s infinite';
        }, 10);
    }
    
    // Highlight the digits being multiplied
    highlightMultiplicationDigits(stepSolution, digitStep) {
        // Clear previous highlights
        document.querySelectorAll('.digit.highlighted').forEach(el => {
            el.classList.remove('highlighted');
            el.classList.remove('highlight-animation');
        });
        
        // Find the digits to highlight
        const multiplierPosition = digitStep.multiplierPosition;
        const multiplicandPosition = stepSolution.multiplicandPosition;
        
        if (multiplierPosition >= 0) {
            // Get all digit elements
            const digitElements = document.querySelectorAll('.digit.operand');
            
            // Calculate positions to highlight (from right to left)
            const topRowDigits = this.multiplier.toString().length;
            const bottomRowDigits = this.multiplicand.toString().length;
            
            // Top number digit (multiplier)
            const topDigitIndex = topRowDigits - 1 - multiplierPosition;
            if (topDigitIndex >= 0 && topDigitIndex < digitElements.length / 2) {
                digitElements[topDigitIndex].classList.add('highlighted');
                digitElements[topDigitIndex].classList.add('highlight-animation');
            }
            
            // Bottom number digit (multiplicand)
            const bottomDigitIndex = topRowDigits + (bottomRowDigits - 1 - multiplicandPosition);
            if (bottomDigitIndex >= topRowDigits && bottomDigitIndex < digitElements.length) {
                digitElements[bottomDigitIndex].classList.add('highlighted');
                digitElements[bottomDigitIndex].classList.add('highlight-animation');
            }
        }
    }
    
    // Start tutorial mode
    startTutorial() {
        this.tutorialMode = true;
        this.closeHelp();
        
        // Generate a simple problem based on current level
        this.generateProblem(true);
        
        // Display tutorial message
        this.elements.feedback.textContent = "Let me show you how to multiply!";
        this.elements.feedback.className = 'feedback correct';
        
        // Show mascot tutorial message
        this.elements.mascotSpeech.textContent = "I'll guide you through each step!";
    }
    
    // Generate a random mascot message
    getMascotMessage(type) {
        const messages = this.mascotMessages[type];
        return messages[Math.floor(Math.random() * messages.length)];
    }
    
    // Get level-specific mascot message
    getLevelMessage() {
        const messages = this.levelMessages[this.level];
        return messages[Math.floor(Math.random() * messages.length)];
    }
    
    // Generate a new multiplication problem
    generateProblem(isTutorial = false) {
        // Reset game state
        this.currentStep = 0;
        this.currentDigit = 0;
        this.currentRow = 0;
        this.steps = [];
        this.solution = [];
        this.stepInputs = [];
        this.carryInputs = [];
        
        // Current level configuration
        const levelConfig = this.levelConfig[this.level];
        
        // Generate numbers based on level
        if (isTutorial) {
            // Simple tutorial problems for each level
            switch(this.level) {
                case 1:
                    this.multiplier = 7;
                    this.multiplicand = 8;
                    break;
                case 2:
                    this.multiplier = 24;
                    this.multiplicand = 6;
                    break;
                case 3:
                    this.multiplier = 32;
                    this.multiplicand = 21;
                    break;
                default:
                    this.multiplier = 7;
                    this.multiplicand = 8;
            }
        } else {
            // Generate random numbers with appropriate number of digits
            this.multiplier = this.generateRandomNumber(levelConfig.multiplierDigits);
            this.multiplicand = this.generateRandomNumber(levelConfig.multiplicandDigits);
            
            // Swap if needed to ensure correct orientation based on level
            if (this.level === 2) {
                // For level 2, multiplicand should be 1 digit and multiplier should be 2 digits
                if (String(this.multiplicand).length > String(this.multiplier).length) {
                    [this.multiplier, this.multiplicand] = [this.multiplicand, this.multiplier];
                }
            }
        }
        
        // Set up the problem display
        this.setupProblemDisplay();
        
        // Calculate solution steps
        this.calculateSolution();
        
        // Update step inputs for first step
        this.updateStepInputs();
        
        // Start the timer for speed award
        this.startTime = new Date().getTime();
        
        // Reset perfect solution tracker
        this.perfectSolution = true;
        
        // Show level-specific message in mascot speech bubble
        this.elements.mascotSpeech.textContent = this.getLevelMessage();
        
        // Reset progress bar
        this.updateProgressBar();
        
        // Focus on first input
        if (this.stepInputs.length > 0) {
            setTimeout(() => this.stepInputs[0].focus(), 100);
        }
    }
    
    // Generate a random number with specified number of digits
    generateRandomNumber(digits) {
        const min = Math.pow(10, digits - 1);
        const max = Math.pow(10, digits) - 1;
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }
    
    // Setup the problem display
    setupProblemDisplay() {
        // Clear previous problem
        this.elements.multiplicationProblem.innerHTML = '';
        
        // Create top row (multiplier)
        const topRow = document.createElement('div');
        topRow.className = 'problem-row';
        this.elements.multiplicationProblem.appendChild(topRow);
        
        // Create multiplication operator and container for top number
        const operator = document.createElement('div');
        operator.className = 'operator';
        operator.innerText = '';
        topRow.appendChild(operator);
        
        const topNumberContainer = document.createElement('div');
        topNumberContainer.className = 'number-container';
        topRow.appendChild(topNumberContainer);
        
        // Add digits for top number
        const multiplierStr = this.multiplier.toString();
        for (let i = 0; i < multiplierStr.length; i++) {
            const digitDiv = document.createElement('div');
            digitDiv.className = 'digit operand';
            digitDiv.innerText = multiplierStr[i];
            topNumberContainer.appendChild(digitDiv);
        }
        
        // Create bottom row (multiplicand)
        const bottomRow = document.createElement('div');
        bottomRow.className = 'problem-row';
        this.elements.multiplicationProblem.appendChild(bottomRow);
        
        // Create multiplication operator and container for bottom number
        const bottomOperator = document.createElement('div');
        bottomOperator.className = 'operator';
        bottomOperator.innerText = '√ó';
        bottomRow.appendChild(bottomOperator);
        
        const bottomNumberContainer = document.createElement('div');
        bottomNumberContainer.className = 'number-container';
        bottomRow.appendChild(bottomNumberContainer);
        
        // Add digits for bottom number
        const multiplicandStr = this.multiplicand.toString();
        for (let i = 0; i < multiplicandStr.length; i++) {
            const digitDiv = document.createElement('div');
            digitDiv.className = 'digit operand';
            digitDiv.innerText = multiplicandStr[i];
            bottomNumberContainer.appendChild(digitDiv);
        }
        
        // Add multiplication line
        const line = document.createElement('div');
        line.className = 'line';
        this.elements.multiplicationProblem.appendChild(line);
        
        // Create work area for partial products
        const workArea = document.createElement('div');
        workArea.className = 'work-area';
        workArea.id = 'work-area';
        this.elements.multiplicationProblem.appendChild(workArea);
    }
    
    // Calculate all steps for the solution
    calculateSolution() {
        this.solution = [];
        
        // Convert numbers to strings for easier digit manipulation
        const multiplierStr = this.multiplier.toString();
        const multiplicandStr = this.multiplicand.toString();
        
        // For each digit in the multiplicand (from right to left)
        for (let i = multiplicandStr.length - 1; i >= 0; i--) {
            const multiplicandDigit = parseInt(multiplicandStr[i]);
            let carry = 0;
            let partialProduct = [];
            
            // For each digit in the multiplier (from right to left)
            for (let j = multiplierStr.length - 1; j >= 0; j--) {
                const multiplierDigit = parseInt(multiplierStr[j]);
                
                // Multiply the digits and add any carry
                const product = multiplierDigit * multiplicandDigit + carry;
                
                // The result digit is the ones place
                const resultDigit = product % 10;
                
                // The new carry is the tens place (if any)
                carry = Math.floor(product / 10);
                
                // Add this step to partial product (in reverse order)
                partialProduct.unshift({
                    multiplierPosition: j,
                    multiplicandPosition: i,
                    multiplierDigit: multiplierDigit,
                    multiplicandDigit: multiplicandDigit,
                    product: product,
                    resultDigit: resultDigit,
                    carry: carry
                });
            }
            
            // If there's still a carry, add it as the leftmost digit
            if (carry > 0) {
                partialProduct.unshift({
                    multiplierPosition: -1, // Beyond leftmost position
                    multiplicandPosition: i,
                    multiplierDigit: 0,
                    multiplicandDigit: multiplicandDigit,
                    product: carry,
                    resultDigit: carry,
                    carry: 0
                });
            }
            
            // Add partial product row to solution
            this.solution.push({
                multiplicandPosition: i,
                multiplicandDigit: multiplicandDigit,
                partialProduct: partialProduct,
                shifts: multiplicandStr.length - 1 - i // Number of right shifts
            });
        }
        
        // Add the final addition step if there's more than one multiplicand digit
        if (multiplicandStr.length > 1) {
            // Calculate final addition of partial products
            const finalResult = this.multiplier * this.multiplicand;
            this.solution.push({
                type: 'addition',
                result: finalResult.toString()
            });
        }
        
        // Calculate total steps for progress bar
        this.totalSteps = 0;
        for (const step of this.solution) {
            if (step.type === 'addition') {
                this.totalSteps += 1;
            } else {
                this.totalSteps += step.partialProduct.length;
            }
        }
    }
    
    // Update progress bar
    updateProgressBar() {
        // Calculate current progress
        let completedSteps = 0;
        
        for (let i = 0; i < this.currentStep; i++) {
            if (this.solution[i].type === 'addition') {
                completedSteps += 1;
            } else {
                completedSteps += this.solution[i].partialProduct.length;
            }
        }
        
        completedSteps += this.currentDigit;
        
        // Calculate percentage and update progress bar
        const progressPercentage = (completedSteps / this.totalSteps) * 100;
        this.elements.progressFill.style.width = `${progressPercentage}%`;
    }
    
    // Update the step inputs with improved clarity
    updateStepInputs() {
        // Clear previous inputs and visualization
        this.elements.stepInputContainer.innerHTML = '';
        this.elements.stepVisualization.innerHTML = '';
        this.stepInputs = [];
        this.carryInputs = [];
        
        // Update progress
        this.updateProgressBar();
        
        if (this.currentStep >= this.solution.length) {
            // All steps complete
            this.elements.stepPrompt.textContent = "Multiplication complete!";
            
            // Add celebration visual
            const celebration = document.createElement('div');
            celebration.className = 'multiply-together';
            celebration.innerHTML = `
                <span>${this.multiplier} √ó ${this.multiplicand} = ${this.multiplier * this.multiplicand}</span>
                <span style="margin-left: 10px; font-size: 40px;">üéâ</span>
            `;
            this.elements.stepVisualization.appendChild(celebration);

            return;
                }
                
                const currentSolution = this.solution[this.currentStep];
                
                // Check if it's the final addition step
                if (currentSolution.type === 'addition') {
                    this.updateAdditionStepInputs();
                    return;
                }
                
                // Single-digit multiplication of partial product
                const currentPartialProduct = currentSolution.partialProduct;
                
                if (this.currentDigit >= currentPartialProduct.length) {
                    // All digits in current partial product are done
                    // Move to next partial product
                    this.currentStep++;
                    this.currentDigit = 0;
                    this.updateStepInputs();
                    return;
                }
                
                // Get the current digit step
                // Important: We need to access from the end to go right-to-left
                const digitStepIndex = currentPartialProduct.length - 1 - this.currentDigit;
                const digitStep = currentPartialProduct[digitStepIndex];
                
                // Highlight the digits being multiplied
                this.highlightMultiplicationDigits(currentSolution, digitStep);
                
                // Create step prompt with improved clarity
                const multiplicandPosition = currentSolution.multiplicandPosition;
                const multiplicandDigit = currentSolution.multiplicandDigit;
                const multiplierPosition = digitStep.multiplierPosition;
                
                // If it's a valid position (not a carry-only step)
                if (multiplierPosition >= 0) {
                    const multiplierDigit = digitStep.multiplierDigit;
                    
                    // Create clear visual step presentation
                    const stepGraphic = document.createElement('div');
                    stepGraphic.className = 'step-graphic';
                    
                    // Add right-to-left hint for larger problems
                    if (this.level > 1) {
                        const rightToLeftHint = document.createElement('div');
                        rightToLeftHint.className = 'right-to-left-hint';
                        rightToLeftHint.innerHTML = 'üëà Working right to left';
                        stepGraphic.appendChild(rightToLeftHint);
                    }
                    
                    // Create multiplication visualization
                    const multiplicationHighlight = document.createElement('div');
                    multiplicationHighlight.className = 'multiplication-highlight';
                    
                    const firstNumber = document.createElement('div');
                    firstNumber.className = 'step-number';
                    firstNumber.textContent = multiplierDigit;
                    
                    const xSymbol = document.createElement('div');
                    xSymbol.className = 'x-symbol';
                    xSymbol.textContent = '√ó';
                    
                    const secondNumber = document.createElement('div');
                    secondNumber.className = 'step-number';
                    secondNumber.textContent = multiplicandDigit;
                    
                    const equalsSymbol = document.createElement('div');
                    equalsSymbol.className = 'step-equals';
                    equalsSymbol.textContent = '=';
                    
                    multiplicationHighlight.appendChild(firstNumber);
                    multiplicationHighlight.appendChild(xSymbol);
                    multiplicationHighlight.appendChild(secondNumber);
                    multiplicationHighlight.appendChild(equalsSymbol);
                    
                    stepGraphic.appendChild(multiplicationHighlight);
                    this.elements.stepVisualization.appendChild(stepGraphic);
                    
                    // Clearer step prompt with level-specific instructions
                    if (this.level === 1) {
                        this.elements.stepPrompt.textContent = `What is ${multiplierDigit} √ó ${multiplicandDigit}?`;
                    } else {
                        // Add column position info for clarity
                        const positionInfo = this.currentDigit === 0 ? 
                            "(ones column)" : 
                            this.currentDigit === 1 ? 
                            "(tens column)" : 
                            "(hundreds column)";
                            
                        this.elements.stepPrompt.innerHTML = `Multiply the digits: ${multiplierDigit} √ó ${multiplicandDigit}<br><span style="font-size: 18px; color: #666;">${positionInfo}</span>`;
                    }
                    
                    // Create input with better labels based on product size
                    const product = digitStep.product;
                    
                    // Create a container to hold the input groups
                    const inputsContainer = document.createElement('div');
                    inputsContainer.className = 'step-input-container';
                    
                    // For single digit product (just one input)
                    if (product < 10) {
                        // Create container with clear label
                        const inputGroup = document.createElement('div');
                        inputGroup.className = 'input-group';
                        
                        const inputLabel = document.createElement('div');
                        inputLabel.className = 'input-label';
                        inputLabel.textContent = 'Write:';
                        
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.className = 'step-input';
                        input.maxLength = 1;
                        input.placeholder = "?";
                        
                        // Add event listener for input
                        input.addEventListener('input', (e) => {
                            e.target.value = e.target.value.replace(/\D/g, '');
                            if (e.target.value) {
                                // Auto-check when digit is entered
                                setTimeout(() => this.checkCurrentStep(), 300);
                            }
                        });
                        
                        // Add hint for clarity
                        const inputHint = document.createElement('div');
                        inputHint.className = 'input-hint';
                        inputHint.textContent = `${multiplierDigit} √ó ${multiplicandDigit}`;
                        
                        inputGroup.appendChild(inputLabel);
                        inputGroup.appendChild(input);
                        inputGroup.appendChild(inputHint);
                        inputsContainer.appendChild(inputGroup);
                        
                        this.stepInputs.push(input);
                    } 
                    // For double digit product (result and carry)
                    else {
                        // Clearer labels and organization
                        const resultGroup = document.createElement('div');
                        resultGroup.className = 'input-group';
                        resultGroup.style.position = 'relative';
                        
                        const resultLabel = document.createElement('div');
                        resultLabel.className = 'input-label';
                        resultLabel.textContent = 'Write Down:';
                        
                        // Input for ones place (result digit)
                        const resultInput = document.createElement('input');
                        resultInput.type = 'text';
                        resultInput.className = 'step-input';
                        resultInput.maxLength = 1;
                        resultInput.placeholder = "?";
                        
                        // Carry explanation for clarity
                        const carryExplanation = document.createElement('div');
                        carryExplanation.className = 'carry-explanation';
                        carryExplanation.textContent = "When product is 10+, write ones digit here & carry tens digit";
                        resultGroup.appendChild(carryExplanation);
                        
                        // Carry input with arrow for clarity
                        const carryArrow = document.createElement('div');
                        carryArrow.className = 'carry-arrow';
                        carryArrow.innerHTML = '‚Üë';
                        resultGroup.appendChild(carryArrow);
                        
                        const carryInput = document.createElement('input');
                        carryInput.type = 'text';
                        carryInput.className = 'carry-input';
                        carryInput.maxLength = 1;
                        carryInput.placeholder = "?";
                        
                        // Helpful hint text
                        const resultHint = document.createElement('div');
                        resultHint.className = 'input-hint';
                        resultHint.innerHTML = `${multiplierDigit} √ó ${multiplicandDigit} = <span style="color: #ff7f50;">?</span><span style="color: #3cb371;">?</span>`;
                        
                        // Event listeners for inputs
                        resultInput.addEventListener('input', (e) => {
                            e.target.value = e.target.value.replace(/\D/g, '');
                            if (e.target.value) {
                                carryInput.focus();
                            }
                        });
                        
                        carryInput.addEventListener('input', (e) => {
                            e.target.value = e.target.value.replace(/\D/g, '');
                            if (e.target.value) {
                                // Auto-check when carry is entered
                                setTimeout(() => this.checkCurrentStep(), 300);
                            }
                        });
                        
                        resultGroup.appendChild(resultLabel);
                        resultGroup.appendChild(resultInput);
                        resultGroup.appendChild(carryInput);
                        resultGroup.appendChild(resultHint);
                        
                        inputsContainer.appendChild(resultGroup);
                        
                        this.stepInputs.push(resultInput);
                        this.carryInputs.push(carryInput);
                    }
                    
                    this.elements.stepInputContainer.appendChild(inputsContainer);
                } else {
                    // This is just placing the final carry
                    this.elements.stepPrompt.textContent = `Write down the carried number:`;
                    
                    // Create visual for carry
                    const stepGraphic = document.createElement('div');
                    stepGraphic.className = 'step-graphic';
                    
                    const carryVisual = document.createElement('div');
                    carryVisual.className = 'step-number';
                    carryVisual.innerHTML = `<span style="color: #ff7f50; font-size: 36px;">‚Üë</span>`;
                    stepGraphic.appendChild(carryVisual);
                    
                    this.elements.stepVisualization.appendChild(stepGraphic);
                    
                    // Simple carry input with clear label
                    const inputGroup = document.createElement('div');
                    inputGroup.className = 'input-group';
                    
                    const inputLabel = document.createElement('div');
                    inputLabel.className = 'input-label';
                    inputLabel.textContent = 'Carry:';
                    
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'step-input';
                    input.style.borderColor = '#ff7f50';
                    input.style.color = '#ff7f50';
                    input.maxLength = 1;
                    input.placeholder = "?";
                    
                    input.addEventListener('input', (e) => {
                        e.target.value = e.target.value.replace(/\D/g, '');
                        if (e.target.value) {
                            // Auto-check when digit is entered
                            setTimeout(() => this.checkCurrentStep(), 300);
                        }
                    });
                    
                    inputGroup.appendChild(inputLabel);
                    inputGroup.appendChild(input);
                    this.elements.stepInputContainer.appendChild(inputGroup);
                    this.stepInputs.push(input);
                }
                
                // Focus on first input
                if (this.stepInputs.length > 0) {
                    setTimeout(() => this.stepInputs[0].focus(), 100);
                }
            }
            
            // Update inputs for the final addition step with better clarity
            updateAdditionStepInputs() {
                this.elements.stepPrompt.textContent = "Add up all the numbers to get the final answer:";
                
                // Create clearer visual for addition step
                const stepGraphic = document.createElement('div');
                stepGraphic.className = 'step-graphic';
                
                const additionVisual = document.createElement('div');
                additionVisual.className = 'step-number';
                additionVisual.innerHTML = 'Now add everything up! <span style="color: #3cb371;">+</span>';
                stepGraphic.appendChild(additionVisual);
                
                // Add right-to-left hint
                const rightToLeftHint = document.createElement('div');
                rightToLeftHint.className = 'right-to-left-hint';
                rightToLeftHint.innerHTML = 'üëà Working right to left';
                stepGraphic.appendChild(rightToLeftHint);
                
                this.elements.stepVisualization.appendChild(stepGraphic);
                
                // Create a container with better organization
                const inputsContainer = document.createElement('div');
                inputsContainer.className = 'step-input-container';
                this.elements.stepInputContainer.appendChild(inputsContainer);
                
                // Create input for each digit of the result
                const finalResult = this.solution[this.currentStep].result;
                
                // Create inputs in reverse order (right to left) with better position markers
                for (let i = finalResult.length - 1; i >= 0; i--) {
                    const inputGroup = document.createElement('div');
                    inputGroup.className = 'input-group';
                    
                    const positionLabel = document.createElement('div');
                    positionLabel.className = 'input-label';
                    positionLabel.textContent = i === finalResult.length - 1 ? 'Ones' : 
                                               i === finalResult.length - 2 ? 'Tens' : 
                                               i === finalResult.length - 3 ? 'Hundreds' : 
                                               `Position ${finalResult.length - i}`;
                    
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'step-input';
                    input.maxLength = 1;
                    input.placeholder = "?";
                    input.dataset.position = i;
                    
                    inputGroup.appendChild(positionLabel);
                    inputGroup.appendChild(input);
                    inputsContainer.appendChild(inputGroup);
                    
                    input.addEventListener('input', (e) => {
                        e.target.value = e.target.value.replace(/\D/g, '');
                        if (e.target.value) {
                            // Find previous input (going right to left)
                            const prevPosition = parseInt(e.target.dataset.position) - 1;
                            if (prevPosition >= 0) {
                                const prevInput = document.querySelector(`.step-input[data-position="${prevPosition}"]`);
                                if (prevInput) {
                                    prevInput.focus();
                                }
                            } else {
                                // Auto-check when last digit is entered
                                setTimeout(() => this.checkCurrentStep(), 300);
                            }
                        }
                    });
                    
                    this.stepInputs.push(input);
                }
                
                // Focus on rightmost input (first to fill)
                if (this.stepInputs.length > 0) {
                    setTimeout(() => this.stepInputs[0].focus(), 100);
                }
            }
            
            // Check current step input with improved feedback
            checkCurrentStep() {
                if (this.currentStep >= this.solution.length) {
                    return;
                }
                
                const currentSolution = this.solution[this.currentStep];
                let isCorrect = false;
                
                // Check if it's the final addition step
                if (currentSolution.type === 'addition') {
                    // For addition, we need to get the user inputs and compare with expected result
                    const finalResult = currentSolution.result;
                    let userAnswer = '';
                    
                    // Build the user answer by getting input values from right to left
                    for (let i = this.stepInputs.length - 1; i >= 0; i--) {
                        userAnswer += this.stepInputs[i].value || '';
                    }
                    
                    isCorrect = userAnswer === finalResult;
                    
                    if (isCorrect) {
                        // Show final answer in work area
                        this.showFinalAnswer(finalResult);
                        
                        // Move to next step (completion)
                        this.currentStep++;
                        this.showFeedback("Great job! You've completed the multiplication!", true);
                        
                        // Update mascot message
                        this.elements.mascotSpeech.textContent = this.getMascotMessage('correct');
                        
                        // Complete the problem
                        this.completeProblem();
                    } else {
                        this.showFeedback("Try again! Check your addition.", false);
                        this.perfectSolution = false;
                        
                        // Update mascot message
                        this.elements.mascotSpeech.textContent = this.getMascotMessage('incorrect');
                        
                        // Shake the inputs
                        this.shakeInputs(this.stepInputs);
                    }
                } 
                else {
                    // Check partial product step
                    const currentPartialProduct = currentSolution.partialProduct;
                    const digitStepIndex = currentPartialProduct.length - 1 - this.currentDigit;
                    const digitStep = currentPartialProduct[digitStepIndex];
                    
                    if (this.stepInputs.length === 1 && this.carryInputs.length === 0) {
                        // Single digit result
                        isCorrect = parseInt(this.stepInputs[0].value || '0') === digitStep.resultDigit;
                    } else {
                        // Double digit result with carry
                        const resultDigit = parseInt(this.stepInputs[0].value || '0');
                        const carryDigit = parseInt(this.carryInputs[0].value || '0');
                        
                        isCorrect = (resultDigit === digitStep.resultDigit && carryDigit === digitStep.carry);
                    }
                    
                    if (isCorrect) {
                        // If this is the first digit in a partial product, create a new row
                        if (this.currentDigit === 0) {
                            this.createPartialProductRow(currentSolution);
                        }
                        
                        // Show the correct digit in the work area
                        this.showDigitInPartialProduct(currentSolution, digitStep);
                        
                        // Move to next digit
                        this.currentDigit++;
                        
                        // Update inputs for next digit
                        this.updateStepInputs();
                        
                        // Show success feedback
                        this.showFeedback("Correct! Keep going.", true);
                        
                        // Update mascot message
                        this.elements.mascotSpeech.textContent = this.getMascotMessage('correct');
                    } else {
                        this.showFeedback("Not quite right. Try again!", false);
                        this.perfectSolution = false;
                        
                        // Update mascot message
                        this.elements.mascotSpeech.textContent = this.getMascotMessage('incorrect');
                        
                        // Shake the inputs
                        if (this.carryInputs.length === 0) {
                            this.shakeInputs(this.stepInputs);
                        } else {
                            this.shakeInputs([...this.stepInputs, ...this.carryInputs]);
                        }
                    }
                }
            }
            
            // Create a new row for partial product
            createPartialProductRow(stepSolution) {
                const workArea = document.getElementById('work-area');
                const rowIndex = this.solution.indexOf(stepSolution);
                
                const partialProductRow = document.createElement('div');
                partialProductRow.className = 'partial-product';
                partialProductRow.id = `partial-product-${rowIndex}`;
                
                // Add the correct spacing based on shift value
                const shifts = stepSolution.shifts;
                for (let i = 0; i < shifts; i++) {
                    const spacer = document.createElement('div');
                    spacer.className = 'digit';
                    spacer.innerHTML = '&nbsp;';
                    partialProductRow.appendChild(spacer);
                }
                
                workArea.appendChild(partialProductRow);
                
                // If it's a multi-row multiplication, add a line before final answer
                if (rowIndex === this.solution.length - 2 && this.solution[this.solution.length - 1].type === 'addition') {
                    const line = document.createElement('div');
                    line.className = 'line';
                    workArea.appendChild(line);
                }
            }
            
            // Show a digit in the partial product
            showDigitInPartialProduct(stepSolution, digitStep) {
                const rowIndex = this.solution.indexOf(stepSolution);
                const partialProductRow = document.getElementById(`partial-product-${rowIndex}`);
                
                // Create digit div for this result
                const digitDiv = document.createElement('div');
                digitDiv.className = 'digit result';
                digitDiv.textContent = digitStep.resultDigit;
                
                // Add to beginning of row (partial products go right-to-left)
                partialProductRow.insertBefore(digitDiv, partialProductRow.firstChild);
                
                // If there's a carry, show it above
                if (digitStep.carry > 0) {
                    const carryDiv = document.createElement('div');
                    carryDiv.className = 'carry';
                    carryDiv.textContent = digitStep.carry;
                    digitDiv.appendChild(carryDiv);
                    
                    // Make carry visible with slight delay for animation
                    setTimeout(() => {
                        carryDiv.classList.add('visible');
                    }, 300);
                }
            }
            
            // Show final answer
            showFinalAnswer(result) {
                const workArea = document.getElementById('work-area');
                
                const finalRow = document.createElement('div');
                finalRow.className = 'partial-product';
                
                // Add each digit of the result (right to left)
                for (let i = result.length - 1; i >= 0; i--) {
                    const digitDiv = document.createElement('div');
                    digitDiv.className = 'digit result';
                    digitDiv.textContent = result[i];
                    finalRow.insertBefore(digitDiv, finalRow.firstChild);
                }
                
                workArea.appendChild(finalRow);
            }
            
            // Show feedback with animation
            showFeedback(message, isCorrect) {
                this.elements.feedback.textContent = message;
                this.elements.feedback.className = isCorrect ? 'feedback correct' : 'feedback incorrect';
                
                // Add animation
                this.elements.feedback.style.animation = 'none';
                setTimeout(() => {
                    this.elements.feedback.style.animation = 'bounce 0.5s';
                }, 10);
            }
            
            // Shake inputs to indicate error
            shakeInputs(inputs) {
                inputs.forEach(input => {
                    input.style.animation = 'none';
                    setTimeout(() => {
                        input.style.animation = 'shake 0.5s';
                    }, 10);
                });
            }
            
            // Complete the problem with celebration
            completeProblem() {
                // Update score and streak
                this.score += this.level * 2;
                this.streak++;
                this.problemsCompleted++;
                this.elements.score.textContent = this.score;
                
                // Calculate time taken
                const endTime = new Date().getTime();
                const timeTaken = (endTime - this.startTime) / 1000; // in seconds
                
                // Check for awards
                this.checkAwards(timeTaken);
                
                // Show completion feedback
                this.elements.feedback.textContent = `Excellent! You solved ${this.multiplier} √ó ${this.multiplicand} = ${this.multiplier * this.multiplicand}! üéâ`;
                this.elements.feedback.className = 'feedback correct celebrating';
                
                // Create celebration effects
                this.createConfetti();
                
                // Update mascot
                this.elements.mascotSpeech.textContent = "Woohoo! You're amazing at multiplication!";
                
                // Highlight new problem button
                this.elements.newProblemButton.classList.add('celebrating');
                
                // Check if level is complete
                const levelConfig = this.levelConfig[this.level];
                if (this.problemsCompleted >= levelConfig.problemsToComplete) {
                    // Show level complete modal after a short delay
                    setTimeout(() => {
                        this.showLevelComplete();
                    }, 1500);
                } else {
                    // Give a hint about new problem
                    setTimeout(() => {
                        this.showFeedback(`Problem ${this.problemsCompleted}/${levelConfig.problemsToComplete} complete! Ready for another?`, true);
                    }, 3000);
                }
            }
            
            // Show level complete modal
            showLevelComplete() {
                const modal = document.getElementById('level-complete-modal');
                modal.style.display = 'flex';
                
                // Disable next level button on max level
                if (this.level >= Object.keys(this.levelConfig).length) {
                    document.getElementById('next-level-button').disabled = true;
                    document.getElementById('next-level-button').style.backgroundColor = '#b0c4de';
                } else {
                    document.getElementById('next-level-button').disabled = false;
                    document.getElementById('next-level-button').style.backgroundColor = '#3cb371';
                }
            }
            
            // Check for awards
            checkAwards(timeTaken) {
                // Speed award - complete within level-appropriate time
                const timeLimit = 25 + (this.level * 10); // More time for higher levels
                if (timeTaken < timeLimit && !this.awards.speed) {
                    this.awardBadge('speed');
                }
                
                // Streak award - 5 consecutive correct solutions
                if (this.streak >= 5 && !this.awards.streak) {
                    this.awardBadge('streak');
                }
                
                // Perfect solution award - no mistakes
                if (this.perfectSolution && !this.awards.perfect) {
                    this.awardBadge('perfect');
                }
                
                // Level master award - complete all levels
                if (this.level === Object.keys(this.levelConfig).length && 
                    this.problemsCompleted >= this.levelConfig[this.level].problemsToComplete &&
                    !this.awards.level) {
                    this.awardBadge('level');
                }
            }
            
            // Award a badge with celebration
            awardBadge(type) {
                this.awards[type] = true;
                const badge = this.elements[`award${type.charAt(0).toUpperCase() + type.slice(1)}`];
                
                badge.classList.add('earned');
                
                // Show award message
                let message = '';
                switch(type) {
                    case 'speed':
                        message = 'Speed Star Earned! ‚≠ê';
                        break;
                    case 'streak':
                        message = '5 in a Row! Streak Star Earned! üî•';
                        break;
                    case 'perfect':
                        message = 'Perfect Star Earned! No mistakes! üåü';
                        break;
                    case 'level':
                        message = 'Level Master Crown Earned! You completed all levels! üëë';
                        break;
                }
                
                // Add award message with delay
                setTimeout(() => {
                    this.elements.feedback.textContent = message;
                    
                    // Update mascot message
                    this.elements.mascotSpeech.textContent = "You earned a new badge! Keep collecting them all!";
                }, 2000);
            }
            
            // Create celebration confetti
            createConfetti() {
                const colors = ['red', 'blue', 'green', 'yellow', 'purple'];
                const confettiCount = 100;
                
                for (let i = 0; i < confettiCount; i++) {
                    const confetti = document.createElement('div');
                    confetti.className = `confetti ${colors[Math.floor(Math.random() * colors.length)]}`;
                    
                    // Random position
                    confetti.style.left = Math.random() * 100 + 'vw';
                    
                    // Random size
                    const size = Math.random() * 10 + 5;
                    confetti.style.width = size + 'px';
                    confetti.style.height = size + 'px';
                    
                    // Random rotation
                    confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                    
                    // Random delay
                    confetti.style.animationDelay = Math.random() * 2 + 's';
                    
                    document.body.appendChild(confetti);
                    
                    // Remove after animation
                    setTimeout(() => {
                        confetti.remove();
                    }, 5000);
                }
            }
        }
        
        // Initialize the game when the page loads
        window.addEventListener('load', () => new MultiplicationGame());
    </script>
</body>
</html>
