<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magnetic Explorer: Adventure Learning Game</title>
    <style>
        /* Global Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial Rounded MT Bold', 'Arial', sans-serif;
        }
        
        body {
            background-color: #f0f8ff;
            overflow: hidden;
            touch-action: manipulation;
        }
        
        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            max-width: 100%;
            overflow: hidden;
        }
        
        /* Screen Styles */
        .screen {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
            z-index: 10;
        }
        
        .screen.visible {
            opacity: 1;
            pointer-events: all;
        }
        
        .screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        /* Start Screen */
        #startScreen {
            background: linear-gradient(to bottom, #6a11cb, #2575fc);
            color: white;
            text-align: center;
        }
        
        #startScreen h1 {
            font-size: 4em;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        #startScreen h2 {
            font-size: 2em;
            margin-bottom: 40px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        /* Game Screen */
        #gameScreen {
            background-color: #f0f8ff;
            overflow: hidden;
        }
        
        /* Lab Background */
        #labBackground {
            position: absolute;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, #c9d6ff, #e2e2e2);
            z-index: -1;
        }
        
        /* Experiment Area */
        #experimentArea {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 70%;
            background-color: #ffffff;
            border-radius: 20px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        /* Quiz Screen */
        #quizScreen {
            background-color: #f5f5f5;
            color: #333;
            text-align: center;
            padding: 20px;
        }
        
        #quizContainer {
            background-color: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 800px;
        }
        
        #quizHeader {
            font-size: 2em;
            margin-bottom: 20px;
            color: #2a70e0;
        }
        
        #quizQuestion {
            font-size: 1.5em;
            margin-bottom: 30px;
            line-height: 1.4;
        }
        
        #quizOptions {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .quiz-option {
            background-color: #e8f0fe;
            border: 2px solid #b8d0f8;
            border-radius: 10px;
            padding: 15px;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .quiz-option:hover {
            background-color: #d2e3fc;
            transform: translateY(-2px);
        }
        
        .quiz-option.selected {
            background-color: #b8d0f8;
            border-color: #83aef7;
        }
        
        .quiz-option.correct {
            background-color: #a5d6a7;
            border-color: #4caf50;
        }
        
        .quiz-option.incorrect {
            background-color: #ef9a9a;
            border-color: #e57373;
        }
        
        #checkAnswerButton {
            background-color: #2a70e0;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 15px 30px;
            font-size: 1.2em;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        
        #checkAnswerButton:hover {
            background-color: #1e5bb5;
        }
        
        /* Reward Screen */
        #rewardScreen {
            background: linear-gradient(to bottom, #00c6fb, #005bea);
            color: white;
            text-align: center;
        }
        
        #rewardContainer {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }
        
        #rewardText {
            font-size: 2.5em;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        #rewardAnimation {
            width: 300px;
            height: 300px;
            position: relative;
        }
        
        #continueButton {
            background-color: #ffcc00;
            color: #333;
            border: none;
            border-radius: 10px;
            padding: 15px 30px;
            font-size: 1.2em;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-top: 20px;
        }
        
        #continueButton:hover {
            background-color: #ffbb00;
        }
        
        /* Settings Screen */
        #settingsScreen {
            background-color: #f5f5f5;
            color: #333;
            padding: 20px;
        }
        
        #settingsContainer {
            background-color: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 800px;
        }
        
        #settingsHeader {
            font-size: 2em;
            margin-bottom: 30px;
            color: #2a70e0;
            text-align: center;
        }
        
        .settings-group {
            margin-bottom: 25px;
        }
        
        .settings-label {
            font-size: 1.2em;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .slider-container {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .slider {
            flex-grow: 1;
            height: 15px;
            -webkit-appearance: none;
            appearance: none;
            background: #e0e0e0;
            outline: none;
            border-radius: 10px;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: #2a70e0;
            cursor: pointer;
        }
        
        .slider-value {
            width: 40px;
            text-align: center;
            font-size: 1.1em;
        }
        
        .settings-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }
        
        .settings-button {
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        #saveSettingsButton {
            background-color: #2a70e0;
            color: white;
            border: none;
        }
        
        #saveSettingsButton:hover {
            background-color: #1e5bb5;
        }
        
        #cancelSettingsButton {
            background-color: #f5f5f5;
            color: #333;
            border: 1px solid #ddd;
        }
        
        #cancelSettingsButton:hover {
            background-color: #e0e0e0;
        }
        
        /* HUD Elements */
        #hud {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 15px;
            z-index: 5;
            display: flex;
            justify-content: space-between;
            pointer-events: none;
        }
        
        #hudLeft {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        #hudRight {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .hud-button {
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            pointer-events: auto;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .hud-button:hover {
            background-color: rgba(255, 255, 255, 1);
            transform: scale(1.05);
        }
        
        .hud-button svg {
            width: 24px;
            height: 24px;
            fill: #333;
        }
        
        #scoreDisplay {
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            padding: 5px 15px;
            font-size: 1.2em;
            font-weight: bold;
            color: #2a70e0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        /* Learning Path */
        #learningPath {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 5;
        }
        
        .path-segment {
            width: 30px;
            height: 10px;
            background-color: rgba(255, 255, 255, 0.5);
            border-radius: 5px;
            transition: all 0.3s ease;
        }
        
        .path-segment.current {
            background-color: #2a70e0;
            box-shadow: 0 0 10px rgba(42, 112, 224, 0.5);
        }
        
        .path-segment.completed {
            background-color: #4caf50;
        }
        
        /* Hint System */
        #hintContainer {
            position: absolute;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 15px;
            max-width: 80%;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            z-index: 20;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        #hintText {
            font-size: 1.1em;
            color: #333;
            text-align: center;
        }
        
        /* Character Styles */
        .character {
            position: absolute;
            z-index: 5;
            transition: all 0.5s ease;
        }
        
        #professor {
            bottom: 20px;
            left: 20px;
            width: 120px;
            height: 120px;
        }
        
        #maggie {
            bottom: 20px;
            right: 20px;
            width: 120px;
            height: 120px;
        }
        
        .speech-bubble {
            position: absolute;
            background-color: white;
            border-radius: 20px;
            padding: 15px;
            max-width: 250px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 25;
            font-size: 1.1em;
            color: #333;
        }
        
        #professorBubble {
            bottom: 150px;
            left: 50px;
        }
        
        #maggieBubble {
            bottom: 150px;
            right: 50px;
        }
        
        /* Interactive Elements */
        .magnet {
            position: absolute;
            cursor: grab;
            transition: transform 0.2s ease;
            z-index: 10;
        }
        
        .magnet.north {
            background-color: #e53935;
        }
        
        .magnet.south {
            background-color: #1e88e5;
        }
        
        .magnet:active {
            cursor: grabbing;
        }
        
        .object {
            position: absolute;
            z-index: 9;
        }
        
        /* Magnetic Field Visualizer */
        #fieldVisualizer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            pointer-events: none;
        }
        
        /* Buttons */
        .button {
            background-color: #2a70e0;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 15px 30px;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .button:hover {
            background-color: #1e5bb5;
            transform: translateY(-2px);
        }
        
        /* Particles and Effects */
        .particle {
            position: absolute;
            pointer-events: none;
            z-index: 100;
        }
        
        .star {
            position: absolute;
            pointer-events: none;
            z-index: 100;
        }
        
        .bubble {
            position: absolute;
            pointer-events: none;
            z-index: 100;
            border-radius: 50%;
        }
        
        /* Animations */
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            #startScreen h1 {
                font-size: 3em;
            }
            
            #startScreen h2 {
                font-size: 1.5em;
            }
            
            #experimentArea {
                width: 95%;
                height: 60%;
            }
            
            .character {
                transform: scale(0.8);
            }
            
            #professor {
                left: 10px;
            }
            
            #maggie {
                right: 10px;
            }
            
            .speech-bubble {
                max-width: 200px;
                font-size: 1em;
            }
        }
        
        @media (max-width: 480px) {
            #startScreen h1 {
                font-size: 2.5em;
            }
            
            #startScreen h2 {
                font-size: 1.2em;
            }
            
            .character {
                transform: scale(0.7);
            }
            
            .speech-bubble {
                max-width: 180px;
                font-size: 0.9em;
                padding: 10px;
            }
            
            #quizHeader {
                font-size: 1.5em;
            }
            
            #quizQuestion {
                font-size: 1.2em;
            }
            
            .quiz-option {
                font-size: 1em;
            }
            
            #rewardText {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <!-- Start Screen -->
        <div id="startScreen" class="screen visible">
            <h1>Magnetic Explorer</h1>
            <h2>Discover the Amazing Power of Magnets!</h2>
            <button id="startButton" class="button">Start Adventure</button>
        </div>
        
        <!-- Game Screen -->
        <div id="gameScreen" class="screen hidden">
            <div id="labBackground"></div>
            <div id="experimentArea">
                <canvas id="fieldVisualizer"></canvas>
            </div>
            
            <!-- HUD Elements -->
            <div id="hud">
                <div id="hudLeft">
                    <div id="settingsButton" class="hud-button">
                        <svg viewBox="0 0 24 24">
                            <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/>
                        </svg>
                    </div>
                    <div id="hintButton" class="hud-button">
                        <svg viewBox="0 0 24 24">
                            <path d="M11,18H13V16H11V18M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,6A4,4 0 0,0 8,10H10A2,2 0 0,1 12,8A2,2 0 0,1 14,10C14,12 11,11.75 11,15H13C13,12.75 16,12.5 16,10A4,4 0 0,0 12,6Z"/>
                        </svg>
                    </div>
                </div>
                <div id="hudRight">
                    <div id="scoreDisplay">Score: 0</div>
                    <div id="quizButton" class="hud-button">
                        <svg viewBox="0 0 24 24">
                            <path d="M20,2H4A2,2 0 0,0 2,4V22L6,18H20A2,2 0 0,0 22,16V4A2,2 0 0,0 20,2M20,16H6L4,18V4H20"/>
                            <path d="M11,13H13V7H11M11,15H13V17H11"/>
                        </svg>
                    </div>
                </div>
            </div>
            
            <!-- Learning Path -->
            <div id="learningPath"></div>
            
            <!-- Characters -->
            <div id="professor" class="character">
                <!-- Professor character visual -->
            </div>
            <div id="professorBubble" class="speech-bubble"></div>
            
            <div id="maggie" class="character">
                <!-- Maggie character visual -->
            </div>
            <div id="maggieBubble" class="speech-bubble"></div>
            
            <!-- Hint System -->
            <div id="hintContainer">
                <p id="hintText"></p>
            </div>
        </div>
        
        <!-- Quiz Screen -->
        <div id="quizScreen" class="screen hidden">
            <div id="quizContainer">
                <h2 id="quizHeader">Magnet Quiz</h2>
                <p id="quizQuestion"></p>
                <div id="quizOptions"></div>
                <button id="checkAnswerButton" class="button">Check Answer</button>
            </div>
        </div>
        
        <!-- Reward Screen -->
        <div id="rewardScreen" class="screen hidden">
            <div id="rewardContainer">
                <h2 id="rewardText"></h2>
                <div id="rewardAnimation"></div>
                <button id="continueButton" class="button">Continue</button>
            </div>
        </div>
        
        <!-- Settings Screen -->
        <div id="settingsScreen" class="screen hidden">
            <div id="settingsContainer">
                <h2 id="settingsHeader">Game Settings</h2>
                
                <div class="settings-group">
                    <p class="settings-label">Magnetic Field Strength</p>
                    <div class="slider-container">
                        <input type="range" min="1" max="10" value="5" class="slider" id="fieldStrengthSlider">
                        <span class="slider-value" id="fieldStrengthValue">5</span>
                    </div>
                </div>
                
                <div class="settings-group">
                    <p class="settings-label">Magnetic Field Visibility</p>
                    <div class="slider-container">
                        <input type="range" min="0" max="10" value="7" class="slider" id="fieldVisibilitySlider">
                        <span class="slider-value" id="fieldVisibilityValue">7</span>
                    </div>
                </div>
                
                <div class="settings-group">
                    <p class="settings-label">Sound Volume</p>
                    <div class="slider-container">
                        <input type="range" min="0" max="10" value="7" class="slider" id="soundVolumeSlider">
                        <span class="slider-value" id="soundVolumeValue">7</span>
                    </div>
                </div>
                
                <div class="settings-group">
                    <p class="settings-label">Game Speed</p>
                    <div class="slider-container">
                        <input type="range" min="1" max="10" value="5" class="slider" id="gameSpeedSlider">
                        <span class="slider-value" id="gameSpeedValue">5</span>
                    </div>
                </div>
                
                <div class="settings-group">
                    <p class="settings-label">Learning Difficulty</p>
                    <div class="slider-container">
                        <input type="range" min="1" max="10" value="3" class="slider" id="difficultySlider">
                        <span class="slider-value" id="difficultyValue">3</span>
                    </div>
                </div>
                
                <div class="settings-buttons">
                    <button id="saveSettingsButton" class="settings-button">Save Settings</button>
                    <button id="cancelSettingsButton" class="settings-button">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Game initialization
        document.addEventListener('DOMContentLoaded', function() {
            // Global game state
            const gameState = {
                currentLevel: 1,
                maxLevel: 5,
                score: 0,
                progress: 0,
                magnets: [],
                objects: [],
                currentQuiz: {
                    question: '',
                    options: [],
                    correctAnswer: '',
                    userAnswer: null
                },
                settings: {
                    fieldStrength: 5,
                    fieldVisibility: 7,
                    soundVolume: 7,
                    gameSpeed: 5,
                    difficulty: 3
                },
                animations: {
                    stars: [],
                    bubbles: [],
                    timers: []
                }
            };
            
            // DOM Elements
            const elements = {
                screens: {
                    startScreen: document.getElementById('startScreen'),
                    gameScreen: document.getElementById('gameScreen'),
                    quizScreen: document.getElementById('quizScreen'),
                    rewardScreen: document.getElementById('rewardScreen'),
                    settingsScreen: document.getElementById('settingsScreen')
                },
                buttons: {
                    startButton: document.getElementById('startButton'),
                    quizButton: document.getElementById('quizButton'),
                    checkAnswerButton: document.getElementById('checkAnswerButton'),
                    continueButton: document.getElementById('continueButton'),
                    settingsButton: document.getElementById('settingsButton'),
                    hintButton: document.getElementById('hintButton'),
                    saveSettingsButton: document.getElementById('saveSettingsButton'),
                    cancelSettingsButton: document.getElementById('cancelSettingsButton')
                },
                displays: {
                    scoreDisplay: document.getElementById('scoreDisplay'),
                    experimentArea: document.getElementById('experimentArea'),
                    fieldVisualizer: document.getElementById('fieldVisualizer'),
                    learningPath: document.getElementById('learningPath'),
                    quizQuestion: document.getElementById('quizQuestion'),
                    quizOptions: document.getElementById('quizOptions'),
                    rewardText: document.getElementById('rewardText'),
                    rewardAnimation: document.getElementById('rewardAnimation'),
                    hintContainer: document.getElementById('hintContainer'),
                    hintText: document.getElementById('hintText')
                },
                characters: {
                    professor: document.getElementById('professor'),
                    professorBubble: document.getElementById('professorBubble'),
                    maggie: document.getElementById('maggie'),
                    maggieBubble: document.getElementById('maggieBubble')
                },
                settings: {
                    fieldStrengthSlider: document.getElementById('fieldStrengthSlider'),
                    fieldStrengthValue: document.getElementById('fieldStrengthValue'),
                    fieldVisibilitySlider: document.getElementById('fieldVisibilitySlider'),
                    fieldVisibilityValue: document.getElementById('fieldVisibilityValue'),
                    soundVolumeSlider: document.getElementById('soundVolumeSlider'),
                    soundVolumeValue: document.getElementById('soundVolumeValue'),
                    gameSpeedSlider: document.getElementById('gameSpeedSlider'),
                    gameSpeedValue: document.getElementById('gameSpeedValue'),
                    difficultySlider: document.getElementById('difficultySlider'),
                    difficultyValue: document.getElementById('difficultyValue')
                }
            };
            
            // Game Audio Context
            let audioContext;
            try {
                window.AudioContext = window.AudioContext || window.webkitAudioContext;
                audioContext = new AudioContext();
            } catch (e) {
                console.warn('Web Audio API is not supported in this browser');
            }
            
            // Initialize the game
            function initGame() {
                // Initialize game UI
                initializeUI();
                
                // Create learning path
                createLearningPath();
                
                // Initialize characters
                initializeCharacters();
                
                // Initialize settings listeners
                initializeSettingsListeners();
                
                // Initialize field visualizer
                initializeFieldVisualizer();
                
                // Load first level
                // We'll do this when the start button is clicked
            }
            
            // Initialize the game UI and event listeners
            function initializeUI() {
                // Start button
                elements.buttons.startButton.addEventListener('click', function() {
                    playButtonSound();
                    startGame();
                });
                
                // Quiz button
                elements.buttons.quizButton.addEventListener('click', function() {
                    playButtonSound();
                    startQuiz();
                });
                
                // Check answer button
                elements.buttons.checkAnswerButton.addEventListener('click', function() {
                    playSelectSound();
                    checkQuizAnswer();
                });
                
                // Continue button
                elements.buttons.continueButton.addEventListener('click', function() {
                    playButtonSound();
                    continueGame();
                });
                
                // Settings button
                elements.buttons.settingsButton.addEventListener('click', function() {
                    playButtonSound();
                    showScreen('settingsScreen');
                });
                
                // Hint button
                elements.buttons.hintButton.addEventListener('click', function() {
                    playButtonSound();
                    toggleHint();
                });
                
                // Save settings button
                elements.buttons.saveSettingsButton.addEventListener('click', function() {
                    playButtonSound();
                    saveSettings();
                    showScreen('gameScreen');
                });
                
                // Cancel settings button
                elements.buttons.cancelSettingsButton.addEventListener('click', function() {
                    playButtonSound();
                    showScreen('gameScreen');
                });
                
                // Update score display
                updateScoreDisplay();
            }
            
            // Initialize the settings sliders and their displays
            function initializeSettingsListeners() {
                // Field strength slider
                elements.settings.fieldStrengthSlider.addEventListener('input', function() {
                    elements.settings.fieldStrengthValue.textContent = this.value;
                    playTickSound();
                });
                
                // Field visibility slider
                elements.settings.fieldVisibilitySlider.addEventListener('input', function() {
                    elements.settings.fieldVisibilityValue.textContent = this.value;
                    playTickSound();
                });
                
                // Sound volume slider
                elements.settings.soundVolumeSlider.addEventListener('input', function() {
                    elements.settings.soundVolumeValue.textContent = this.value;
                    gameState.settings.soundVolume = parseInt(this.value);
                    playTickSound();
                });
                
                // Game speed slider
                elements.settings.gameSpeedSlider.addEventListener('input', function() {
                    elements.settings.gameSpeedValue.textContent = this.value;
                    playTickSound();
                });
                
                // Difficulty slider
                elements.settings.difficultySlider.addEventListener('input', function() {
                    elements.settings.difficultyValue.textContent = this.value;
                    playTickSound();
                });
                
                // Set initial values
                elements.settings.fieldStrengthValue.textContent = elements.settings.fieldStrengthSlider.value;
                elements.settings.fieldVisibilityValue.textContent = elements.settings.fieldVisibilitySlider.value;
                elements.settings.soundVolumeValue.textContent = elements.settings.soundVolumeSlider.value;
                elements.settings.gameSpeedValue.textContent = elements.settings.gameSpeedSlider.value;
                elements.settings.difficultyValue.textContent = elements.settings.difficultySlider.value;
            }
            
            // Save current settings
            function saveSettings() {
                gameState.settings.fieldStrength = parseInt(elements.settings.fieldStrengthSlider.value);
                gameState.settings.fieldVisibility = parseInt(elements.settings.fieldVisibilitySlider.value);
                gameState.settings.soundVolume = parseInt(elements.settings.soundVolumeSlider.value);
                gameState.settings.gameSpeed = parseInt(elements.settings.gameSpeedSlider.value);
                gameState.settings.difficulty = parseInt(elements.settings.difficultySlider.value);
                
                // Update visuals based on new settings
                updateFieldVisualizer();
                
                // Show success message
                showMessage(elements.characters.professorBubble, "Settings saved! Let's continue our magnetic adventure!");
            }
            
            // Initialize the game characters
            function initializeCharacters() {
                // Create professor character
                drawProfessor();
                
                // Create Maggie character
                drawMaggie();
            }
            
            // Draw the professor character
            function drawProfessor() {
                const professorSvg = `
                    <svg width="120" height="120" viewBox="0 0 120 120">
                        <!-- Body -->
                        <ellipse cx="60" cy="80" rx="25" ry="30" fill="#1E88E5"/>
                        
                        <!-- Head -->
                        <circle cx="60" cy="40" r="20" fill="#FFD700"/>
                        
                        <!-- Eyes -->
                        <circle cx="52" cy="35" r="4" fill="white"/>
                        <circle cx="68" cy="35" r="4" fill="white"/>
                        <circle cx="52" cy="35" r="2" fill="black"/>
                        <circle cx="68" cy="35" r="2" fill="black"/>
                        
                        <!-- Glasses -->
                        <circle cx="52" cy="35" r="6" fill="none" stroke="black" stroke-width="1.5"/>
                        <circle cx="68" cy="35" r="6" fill="none" stroke="black" stroke-width="1.5"/>
                        <line x1="58" y1="35" x2="62" y2="35" stroke="black" stroke-width="1.5"/>
                        
                        <!-- Smile -->
                        <path d="M50,45 Q60,55 70,45" fill="none" stroke="black" stroke-width="1.5"/>
                        
                        <!-- Beard -->
                        <path d="M50,50 Q60,65 70,50 Q60,55 50,50" fill="#A0522D"/>
                        
                        <!-- Hair -->
                        <path d="M40,30 Q60,10 80,30 Q60,20 40,30" fill="#A0522D"/>
                        
                        <!-- Arms -->
                        <line x1="40" y1="70" x2="25" y2="60" stroke="#FFD700" stroke-width="5" stroke-linecap="round"/>
                        <line x1="80" y1="70" x2="95" y2="60" stroke="#FFD700" stroke-width="5" stroke-linecap="round"/>
                        
                        <!-- Legs -->
                        <line x1="50" y1="110" x2="45" y2="115" stroke="#1E88E5" stroke-width="8" stroke-linecap="round"/>
                        <line x1="70" y1="110" x2="75" y2="115" stroke="#1E88E5" stroke-width="8" stroke-linecap="round"/>
                    </svg>
                `;
                
                elements.characters.professor.innerHTML = professorSvg;
            }
            
            // Draw Maggie character (the magnet mascot)
            function drawMaggie() {
                const maggieSvg = `
                    <svg width="120" height="120" viewBox="0 0 120 120">
                        <!-- Body (horseshoe magnet) -->
                        <path d="M40,40 L40,80 Q60,100 80,80 L80,40" fill="none" stroke="#FF5252" stroke-width="8" stroke-linecap="round"/>
                        
                        <!-- Head -->
                        <circle cx="60" cy="30" r="18" fill="#FF5252"/>
                        
                        <!-- Eyes -->
                        <circle cx="52" cy="25" r="4" fill="white"/>
                        <circle cx="68" cy="25" r="4" fill="white"/>
                        <circle cx="52" cy="25" r="2" fill="black"/>
                        <circle cx="68" cy="25" r="2" fill="black"/>
                        
                        <!-- Smile -->
                        <path d="M50,35 Q60,45 70,35" fill="none" stroke="black" stroke-width="1.5"/>
                        
                        <!-- N and S poles -->
                        <text x="36" y="55" font-family="Arial" font-size="16" font-weight="bold" fill="white">N</text>
                        <text x="76" y="55" font-family="Arial" font-size="16" font-weight="bold" fill="white">S</text>
                        
                        <!-- Arms -->
                        <line x1="45" y1="50" x2="30" y2="55" stroke="#FF5252" stroke-width="5" stroke-linecap="round"/>
                        <line x1="75" y1="50" x2="90" y2="55" stroke="#FF5252" stroke-width="5" stroke-linecap="round"/>
                    </svg>
                `;
                
                elements.characters.maggie.innerHTML = maggieSvg;
            }
            
            // Initialize the magnetic field visualizer
            function initializeFieldVisualizer() {
                const canvas = elements.displays.fieldVisualizer;
                const ctx = canvas.getContext('2d');
                
                // Set canvas size to match parent
                canvas.width = elements.displays.experimentArea.clientWidth;
                canvas.height = elements.displays.experimentArea.clientHeight;
                
                // Resize handler
                window.addEventListener('resize', function() {
                    canvas.width = elements.displays.experimentArea.clientWidth;
                    canvas.height = elements.displays.experimentArea.clientHeight;
                    updateFieldVisualizer();
                });
                
                // Initial draw
                updateFieldVisualizer();
            }
            
            // Update the magnetic field visualization
            function updateFieldVisualizer() {
                const canvas = elements.displays.fieldVisualizer;
                const ctx = canvas.getContext('2d');
                
                // Clear canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Skip if no magnets
                if (gameState.magnets.length === 0) return;
                
                // Draw field lines based on magnets
                const fieldDensity = gameState.settings.fieldVisibility / 10;
                const fieldStrength = gameState.settings.fieldStrength;
                
                if (fieldDensity <= 0) return; // Don't draw if visibility is 0
                
                // Configure field appearance
                ctx.strokeStyle = 'rgba(0, 75, 255, 0.3)';
                ctx.lineWidth = 1.5;
                
                // Draw field lines from each magnet
                gameState.magnets.forEach(magnet => {
                    const startX = magnet.x;
                    const startY = magnet.y;
                    const type = magnet.type; // 'north' or 'south'
                    
                    // Draw multiple field lines
                    for (let angle = 0; angle < 360; angle += 30 / fieldDensity) {
                        ctx.beginPath();
                        let x = startX;
                        let y = startY;
                        
                        // Starting direction based on magnet pole
                        let direction = angle * (Math.PI / 180);
                        if (type === 'south') {
                            direction += Math.PI; // Opposite direction for south pole
                        }
                        
                        // Draw curved field line
                        ctx.moveTo(x, y);
                        
                        for (let i = 0; i < 30; i++) {
                            // Calculate field influence from all magnets
                            const totalForce = calculateFieldForce(x, y, magnet);
                            
                            // Advance along the field line
                            const step = 5;
                            x += Math.cos(direction) * step;
                            y += Math.sin(direction) * step;
                            
                            // Update direction based on field
                            direction += totalForce * 0.1 * fieldStrength / 5;
                            
                            // Draw line segment
                            ctx.lineTo(x, y);
                            
                            // Stop if out of bounds
                            if (x < 0 || x > canvas.width || y < 0 || y > canvas.height) {
                                break;
                            }
                        }
                        
                        ctx.stroke();
                    }
                });
            }
            
            // Calculate magnetic field force at a point
            function calculateFieldForce(x, y, excludeMagnet) {
                let forceX = 0;
                let forceY = 0;
                
                gameState.magnets.forEach(magnet => {
                    if (magnet === excludeMagnet) return;
                    
                    const dx = x - magnet.x;
                    const dy = y - magnet.y;
                    const distanceSquared = dx * dx + dy * dy;
                    if (distanceSquared < 100) return; // Too close
                    
                    const distance = Math.sqrt(distanceSquared);
                    const force = 1000 / distanceSquared; // Inverse square law
                    
                    // Direction depends on magnet pole
                    const polarity = magnet.type === 'north' ? 1 : -1;
                    
                    forceX += (dx / distance) * force * polarity;
                    forceY += (dy / distance) * force * polarity;
                });
                
                return Math.atan2(forceY, forceX);
            }
            
            // Start the game
            function startGame() {
                // Show game screen
                showScreen('gameScreen');
                
                // Load first level
                loadLevel(gameState.currentLevel);
                
                // Welcome message
                setTimeout(() => {
                    showMessage(elements.characters.professorBubble, "Welcome to Magnetic Explorer! I'm Professor Pole. Let's learn about magnets!");
                }, 500);
                
                setTimeout(() => {
                    showMessage(elements.characters.maggieBubble, "Hi! I'm Maggie! I'll help you discover the amazing power of magnets!");
                }, 3000);
                
                // Update learning path
                updateLearningPath();
            }
            
            // Load a level
            function loadLevel(level) {
                gameState.currentLevel = level;
                
                // Clear existing magnets and objects
                gameState.magnets = [];
                gameState.objects = [];
                
                // Remove existing elements
                clearExperimentArea();
                
                // Create level content based on level number
                createLevelContent(level);
                
                // Update learning path indicator
                updateLearningPath();
                
                // Show level intro
                showLevelIntro(level);
            }
            
            // Clear experiment area of interactive elements
            function clearExperimentArea() {
                // Remove all magnets
                const magnets = document.querySelectorAll('.magnet');
                magnets.forEach(magnet => magnet.remove());
                
                // Remove all objects
                const objects = document.querySelectorAll('.object');
                objects.forEach(object => object.remove());
            }
            
            // Create level content
            function createLevelContent(level) {
                switch(level) {
                    case 1:
                        createLevel1();
                        break;
                    case 2:
                        createLevel2();
                        break;
                    case 3:
                        createLevel3();
                        break;
                    case 4:
                        createLevel4();
                        break;
                    case 5:
                        createLevel5();
                        break;
                    default:
                        createLevel1();
                }
            }
            
            // Level 1: Introduction to Magnets
            function createLevel1() {
                // Create a bar magnet
                createMagnet('bar', 'north', 200, 200);
                
                // Create some magnetic objects
                createObject('paper_clip', 400, 150);
                createObject('coin', 350, 250);
                createObject('plastic', 450, 300);
                
                // Set hint text
                elements.displays.hintText.textContent = "Drag the magnet close to different objects. Some objects are attracted to magnets, and some are not!";
            }
            
            // Level 2: Magnetic Poles
            function createLevel2() {
                // Create two bar magnets
                createMagnet('bar', 'north', 150, 200);
                createMagnet('bar', 'south', 450, 200);
                
                // Set hint text
                elements.displays.hintText.textContent = "Magnets have two poles: North (N) and South (S). Like poles repel, and unlike poles attract!";
            }
            
            // Level 3: Magnetic Fields
            function createLevel3() {
                // Create a horseshoe magnet
                createMagnet('horseshoe', 'north', 300, 200);
                
                // Create iron filings visualization
                createObject('iron_filings', 300, 300);
                
                // Set hint text
                elements.displays.hintText.textContent = "Magnets create invisible magnetic fields around them. The field is stronger near the poles!";
            }
            
            // Level 4: Electromagnets
            function createLevel4() {
                // Create an electromagnet
                createMagnet('electromagnet', 'north', 300, 200);
                
                // Create power switch
                createObject('switch', 150, 300);
                
                // Create magnetic objects
                createObject('paper_clip', 400, 150);
                createObject('paper_clip', 450, 200);
                createObject('paper_clip', 400, 250);
                
                // Set hint text
                elements.displays.hintText.textContent = "Electromagnets use electricity to create magnetic fields. Use the switch to turn it on and off!";
            }
            
            // Level 5: Advanced Magnetic Concepts
            function createLevel5() {
                // Create compass
                createObject('compass', 300, 150);
                
                // Create Earth model
                createObject('earth', 300, 300);
                
                // Create bar magnet
                createMagnet('bar', 'north', 150, 300);
                
                // Set hint text
                elements.displays.hintText.textContent = "Earth itself is like a giant magnet! A compass needle is a tiny magnet that aligns with Earth's magnetic field.";
            }
            
            // Create a magnet element
            function createMagnet(shape, pole, x, y) {
                const experimentArea = elements.displays.experimentArea;
                const magnet = document.createElement('div');
                magnet.className = `magnet ${pole}`;
                magnet.style.position = 'absolute';
                magnet.style.left = `${x}px`;
                magnet.style.top = `${y}px`;
                
                // Create SVG based on shape and pole
                let magnetSvg = '';
                if (shape === 'bar') {
                    magnetSvg = `
                        <svg width="100" height="30" viewBox="0 0 100 30">
                            <rect x="0" y="0" width="100" height="30" rx="5" ry="5" fill="${pole === 'north' ? '#e53935' : '#1e88e5'}"/>
                            <text x="${pole === 'north' ? '10' : '80'}" y="20" font-family="Arial" font-size="16" font-weight="bold" fill="white">${pole === 'north' ? 'N' : 'S'}</text>
                            <text x="${pole === 'north' ? '80' : '10'}" y="20" font-family="Arial" font-size="16" font-weight="bold" fill="white">${pole === 'north' ? 'S' : 'N'}</text>
                        </svg>
                    `;
                } else if (shape === 'horseshoe') {
                    magnetSvg = `
                        <svg width="80" height="80" viewBox="0 0 80 80">
                            <path d="M10,10 L10,50 Q40,80 70,50 L70,10" fill="none" stroke="${pole === 'north' ? '#e53935' : '#1e88e5'}" stroke-width="10" stroke-linecap="round"/>
                            <text x="5" y="30" font-family="Arial" font-size="14" font-weight="bold" fill="white">${pole === 'north' ? 'N' : 'S'}</text>
                            <text x="65" y="30" font-family="Arial" font-size="14" font-weight="bold" fill="white">${pole === 'north' ? 'S' : 'N'}</text>
                        </svg>
                    `;
                } else if (shape === 'electromagnet') {
                    magnetSvg = `
                        <svg width="100" height="60" viewBox="0 0 100 60">
                            <rect x="0" y="15" width="100" height="30" rx="5" ry="5" fill="#795548"/>
                            <path d="M10,15 Q10,0 20,0 L80,0 Q90,0 90,15" fill="none" stroke="#ff9800" stroke-width="3"/>
                            <path d="M10,45 Q10,60 20,60 L80,60 Q90,60 90,45" fill="none" stroke="#ff9800" stroke-width="3"/>
                            <text x="${pole === 'north' ? '10' : '80'}" y="35" font-family="Arial" font-size="16" font-weight="bold" fill="white">${pole === 'north' ? 'N' : 'S'}</text>
                            <text x="${pole === 'north' ? '80' : '10'}" y="35" font-family="Arial" font-size="16" font-weight="bold" fill="white">${pole === 'north' ? 'S' : 'N'}</text>
                        </svg>
                    `;
                }
                
                magnet.innerHTML = magnetSvg;
                experimentArea.appendChild(magnet);
                
                // Make magnet draggable
                makeDraggable(magnet);
                
                // Add to game state
                gameState.magnets.push({
                    element: magnet,
                    type: pole,
                    shape: shape,
                    x: x,
                    y: y
                });
                
                return magnet;
            }
            
            // Create an object element
            function createObject(type, x, y) {
                const experimentArea = elements.displays.experimentArea;
                const object = document.createElement('div');
                object.className = `object ${type}`;
                object.style.position = 'absolute';
                object.style.left = `${x}px`;
                object.style.top = `${y}px`;
                
                // Create SVG based on object type
                let objectSvg = '';
                let isMagnetic = false;
                
                if (type === 'paper_clip') {
                    objectSvg = `
                        <svg width="30" height="60" viewBox="0 0 30 60">
                            <path d="M10,10 L10,40 Q10,50 20,50 Q30,50 30,40 L30,30 Q30,20 20,20 L10,20" fill="none" stroke="#9e9e9e" stroke-width="3" stroke-linecap="round"/>
                        </svg>
                    `;
                    isMagnetic = true;
                } else if (type === 'coin') {
                    objectSvg = `
                        <svg width="40" height="40" viewBox="0 0 40 40">
                            <circle cx="20" cy="20" r="18" fill="#ffc107" stroke="#ff8f00" stroke-width="2"/>
                            <circle cx="20" cy="20" r="12" fill="none" stroke="#ff8f00" stroke-width="1"/>
                        </svg>
                    `;
                    isMagnetic = false;
                } else if (type === 'plastic') {
                    objectSvg = `
                        <svg width="60" height="40" viewBox="0 0 60 40">
                            <rect x="5" y="5" width="50" height="30" rx="5" ry="5" fill="#4caf50"/>
                        </svg>
                    `;
                    isMagnetic = false;
                } else if (type === 'iron_filings') {
                    objectSvg = `
                        <svg width="200" height="100" viewBox="0 0 200 100">
                            <rect x="0" y="0" width="200" height="100" fill="rgba(240, 240, 240, 0.5)"/>
                            ${Array.from({length: 200}, () => {
                                const fileX = Math.random() * 200;
                                const fileY = Math.random() * 100;
                                return `<line x1="${fileX}" y1="${fileY}" x2="${fileX + Math.random() * 4 - 2}" y2="${fileY + Math.random() * 4 - 2}" stroke="#9e9e9e" stroke-width="1"/>`;
                            }).join('')}
                        </svg>
                    `;
                    isMagnetic = true;
                } else if (type === 'switch') {
                    objectSvg = `
                        <svg width="60" height="40" viewBox="0 0 60 40" class="power-switch" data-state="off">
                            <rect x="5" y="10" width="50" height="20" rx="10" ry="10" fill="#e0e0e0" stroke="#bdbdbd" stroke-width="2"/>
                            <circle cx="20" cy="20" r="10" fill="#f44336"/>
                            <text x="30" y="25" font-family="Arial" font-size="10" text-anchor="middle" fill="#424242">OFF</text>
                        </svg>
                    `;
                    isMagnetic = false;
                } else if (type === 'compass') {
                    objectSvg = `
                        <svg width="80" height="80" viewBox="0 0 80 80" class="compass">
                            <circle cx="40" cy="40" r="35" fill="white" stroke="#424242" stroke-width="2"/>
                            <path d="M40,15 L35,40 L40,65 L45,40 Z" fill="#f44336" stroke="#424242" stroke-width="1" class="compass-needle"/>
                            <text x="40" y="25" font-family="Arial" font-size="10" text-anchor="middle" fill="#424242">N</text>
                            <text x="40" y="60" font-family="Arial" font-size="10" text-anchor="middle" fill="#424242">S</text>
                            <text x="60" y="40" font-family="Arial" font-size="10" text-anchor="middle" fill="#424242">E</text>
                            <text x="20" y="40" font-family="Arial" font-size="10" text-anchor="middle" fill="#424242">W</text>
                        </svg>
                    `;
                    isMagnetic = true;
                } else if (type === 'earth') {
                    objectSvg = `
                        <svg width="100" height="100" viewBox="0 0 100 100">
                            <circle cx="50" cy="50" r="40" fill="#2196f3" stroke="#1565c0" stroke-width="2"/>
                            <path d="M30,25 Q50,10 70,25 Q90,50 70,75 Q50,90 30,75 Q10,50 30,25" fill="#4caf50" stroke="#1b5e20" stroke-width="1"/>
                            <path d="M50,10 L50,90" stroke="#f44336" stroke-width="1" stroke-dasharray="4,4"/>
                            <text x="50" y="15" font-family="Arial" font-size="8" text-anchor="middle" fill="white">N</text>
                            <text x="50" y="95" font-family="Arial" font-size="8" text-anchor="middle" fill="white">S</text>
                        </svg>
                    `;
                    isMagnetic = false;
                }
                
                object.innerHTML = objectSvg;
                experimentArea.appendChild(object);
                
                // Add event listener for switch
                if (type === 'switch') {
                    const switchSvg = object.querySelector('.power-switch');
                    switchSvg.addEventListener('click', function() {
                        playButtonSound();
                        const currentState = this.getAttribute('data-state');
                        if (currentState === 'off') {
                            this.setAttribute('data-state', 'on');
                            this.querySelector('circle').setAttribute('cx', '40');
                            this.querySelector('circle').setAttribute('fill', '#4caf50');
                            this.querySelector('text').textContent = 'ON';
                            // Turn on electromagnet
                            activateElectromagnet(true);
                        } else {
                            this.setAttribute('data-state', 'off');
                            this.querySelector('circle').setAttribute('cx', '20');
                            this.querySelector('circle').setAttribute('fill', '#f44336');
                            this.querySelector('text').textContent = 'OFF';
                            // Turn off electromagnet
                            activateElectromagnet(false);
                        }
                    });
                }
                
                // Add to game state
                gameState.objects.push({
                    element: object,
                    type: type,
                    x: x,
                    y: y,
                    isMagnetic: isMagnetic
                });
                
                return object;
            }
            
            // Activate/deactivate electromagnet
            function activateElectromagnet(activate) {
                gameState.magnets.forEach(magnet => {
                    if (magnet.shape === 'electromagnet') {
                        if (activate) {
                            magnet.element.style.opacity = '1';
                            magnet.active = true;
                        } else {
                            magnet.element.style.opacity = '0.5';
                            magnet.active = false;
                        }
                    }
                });
                
                // Update field visualization
                updateFieldVisualizer();
                
                // Create success effect if activated
                if (activate) {
                    playSuccessSound();
                    createParticleEffect();
                    showMessage(elements.characters.maggieBubble, "The electromagnet is now active! See how it attracts magnetic objects!");
                } else {
                    showMessage(elements.characters.maggieBubble, "The electromagnet is now turned off. It no longer creates a magnetic field.");
                }
            }
            
            // Make an element draggable
            function makeDraggable(element) {
                let offsetX, offsetY, isDragging = false;
                
                element.addEventListener('mousedown', startDrag);
                element.addEventListener('touchstart', startDrag);
                
                function startDrag(e) {
                    e.preventDefault();
                    
                    // Get touch or mouse position
                    const clientX = e.clientX || e.touches[0].clientX;
                    const clientY = e.clientY || e.touches[0].clientY;
                    
                    // Calculate offset
                    const rect = element.getBoundingClientRect();
                    offsetX = clientX - rect.left;
                    offsetY = clientY - rect.top;
                    
                    // Start dragging
                    isDragging = true;
                    
                    // Add move and end event listeners
                    document.addEventListener('mousemove', drag);
                    document.addEventListener('touchmove', drag);
                    document.addEventListener('mouseup', endDrag);
                    document.addEventListener('touchend', endDrag);
                    
                    // Change cursor and visual feedback
                    element.style.cursor = 'grabbing';
                    element.style.zIndex = '100';
                    playSelectSound();
                }
                
                function drag(e) {
                    if (!isDragging) return;
                    
                    // Get touch or mouse position
                    const clientX = e.clientX || e.touches[0].clientX;
                    const clientY = e.clientY || e.touches[0].clientY;
                    
                    // Calculate new position
                    const containerRect = elements.displays.experimentArea.getBoundingClientRect();
                    const elementRect = element.getBoundingClientRect();
                    
                    let newLeft = clientX - containerRect.left - offsetX;
                    let newTop = clientY - containerRect.top - offsetY;
                    
                    // Constrain to container
                    newLeft = Math.max(0, Math.min(containerRect.width - elementRect.width, newLeft));
                    newTop = Math.max(0, Math.min(containerRect.height - elementRect.height, newTop));
                    
                    // Update position
                    element.style.left = `${newLeft}px`;
                    element.style.top = `${newTop}px`;
                    
                    // Update game state
                    updateMagnetPosition(element, newLeft, newTop);
                    
                    // Check for interactions
                    checkMagneticInteractions();
                }
                
                function endDrag() {
                    if (!isDragging) return;
                    
                    // End dragging
                    isDragging = false;
                    
                    // Remove event listeners
                    document.removeEventListener('mousemove', drag);
                    document.removeEventListener('touchmove', drag);
                    document.removeEventListener('mouseup', endDrag);
                    document.removeEventListener('touchend', endDrag);
                    
                    // Reset cursor and visual feedback
                    element.style.cursor = 'grab';
                    element.style.zIndex = '10';
                }
            }
            
            // Update magnet position in game state
            function updateMagnetPosition(element, x, y) {
                const magnet = gameState.magnets.find(m => m.element === element);
                if (magnet) {
                    magnet.x = x + element.clientWidth / 2;
                    magnet.y = y + element.clientHeight / 2;
                    
                    // Update field visualizer
                    updateFieldVisualizer();
                }
            }
            
            // Check for interactions between magnets and objects
            function checkMagneticInteractions() {
                gameState.magnets.forEach(magnet => {
                    if (magnet.shape === 'electromagnet' && !magnet.active) return;
                    
                    gameState.objects.forEach(object => {
                        if (!object.isMagnetic) return;
                        
                        // Calculate distance
                        const dx = magnet.x - object.x;
                        const dy = magnet.y - object.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        // Check for interaction
                        if (distance < 100) {
                            // Create magnetic attraction
                            attractObject(object, magnet, distance);
                        }
                    });
                    
                    // Check magnet-to-magnet interactions
                    gameState.magnets.forEach(otherMagnet => {
                        if (magnet === otherMagnet) return;
                        if (otherMagnet.shape === 'electromagnet' && !otherMagnet.active) return;
                        
                        // Calculate distance
                        const dx = magnet.x - otherMagnet.x;
                        const dy = magnet.y - otherMagnet.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        // Check for interaction
                        if (distance < 150) {
                            // Create magnetic attraction or repulsion
                            magnetToMagnetInteraction(magnet, otherMagnet, distance);
                        }
                    });
                });
                
                // Special case for compass
                updateCompass();
            }
            
            // Attract a magnetic object to a magnet
            function attractObject(object, magnet, distance) {
                if (object.type === 'iron_filings') {
                    // Create iron filing pattern
                    updateIronFilings(object, magnet);
                    return;
                }
                
                // Calculate attraction strength (inverse square law)
                const strength = Math.min(1, 1000 / (distance * distance));
                
                // Move object slightly toward magnet
                if (distance > 30) {
                    const dx = magnet.x - object.x;
                    const dy = magnet.y - object.y;
                    const angle = Math.atan2(dy, dx);
                    
                    const moveX = Math.cos(angle) * strength * 2;
                    const moveY = Math.sin(angle) * strength * 2;
                    
                    object.x += moveX;
                    object.y += moveY;
                    
                    object.element.style.left = `${object.x - object.element.clientWidth / 2}px`;
                    object.element.style.top = `${object.y - object.element.clientHeight / 2}px`;
                    
                    // Add subtle animation
                    object.element.style.transition = 'transform 0.2s ease';
                    object.element.style.transform = `rotate(${Math.sin(Date.now() / 300) * 5}deg)`;
                }
                
                // If the object is very close, show success
                if (distance < 50 && !object.hasInteracted) {
                    object.hasInteracted = true;
                    playSuccessSound();
                    createParticleEffect();
                    showMessage(elements.characters.maggieBubble, "Great job! You've discovered magnetic attraction!");
                    
                    // Increase score
                    gameState.score++;
                    updateScoreDisplay();
                }
            }
            
            // Update iron filings visualization
            function updateIronFilings(filings, magnet) {
                // Create pattern based on magnetic field
                const filingSvg = filings.element.querySelector('svg');
                const lines = filingSvg.querySelectorAll('line');
                
                // Calculate magnet direction
                const magnetAngle = magnet.type === 'north' ? 0 : Math.PI;
                
                // Update each filing
                lines.forEach(line => {
                    const x = parseFloat(line.getAttribute('x1'));
                    const y = parseFloat(line.getAttribute('y1'));
                    
                    // Calculate distance to magnet
                    const dx = x - (magnet.x - filings.x + filings.element.clientWidth / 2);
                    const dy = y - (magnet.y - filings.y + filings.element.clientHeight / 2);
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < 100) {
                        // Calculate angle from magnet
                        const angle = Math.atan2(dy, dx) + magnetAngle;
                        
                        // Calculate new endpoint
                        const length = 3 + (1 - Math.min(1, distance / 100)) * 5;
                        const newX = x + Math.cos(angle) * length;
                        const newY = y + Math.sin(angle) * length;
                        
                        // Update line
                        line.setAttribute('x2', newX);
                        line.setAttribute('y2', newY);
                        line.setAttribute('stroke', '#616161');
                        line.setAttribute('stroke-width', 1.5);
                    }
                });
                
                // Show success message if not already shown
                if (!filings.hasInteracted) {
                    filings.hasInteracted = true;
                    playSuccessSound();
                    createParticleEffect();
                    showMessage(elements.characters.maggieBubble, "Look at that! The iron filings show us the magnetic field lines!");
                    
                    // Increase score
                    gameState.score++;
                    updateScoreDisplay();
                }
            }
            
            // Handle magnet-to-magnet interactions
            function magnetToMagnetInteraction(magnet1, magnet2, distance) {
                // Check pole alignment
                const samePoles = magnet1.type === magnet2.type;
                
                // Calculate force (inverse square law)
                const strength = Math.min(1, 3000 / (distance * distance));
                
                // Calculate direction
                const dx = magnet2.x - magnet1.x;
                const dy = magnet2.y - magnet1.y;
                const angle = Math.atan2(dy, dx);
                
                // Apply visual feedback
                if (samePoles) {
                    // Repulsion - subtle push away
                    magnet1.element.style.transition = 'transform 0.2s ease';
                    magnet1.element.style.transform = `translate(${-Math.cos(angle) * strength * 10}px, ${-Math.sin(angle) * strength * 10}px)`;
                    
                    // Show effect if strong interaction
                    if (strength > 0.5 && !magnet1.hasRepelled) {
                        magnet1.hasRepelled = true;
                        playErrorSound();
                        showMessage(elements.characters.professorBubble, "Look at that! Like poles repel each other!");
                        
                        // Increase score
                        gameState.score++;
                        updateScoreDisplay();
                    }
                } else {
                    // Attraction - subtle pull toward
                    magnet1.element.style.transition = 'transform 0.2s ease';
                    magnet1.element.style.transform = `translate(${Math.cos(angle) * strength * 10}px, ${Math.sin(angle) * strength * 10}px)`;
                    
                    // Show effect if strong interaction
                    if (strength > 0.5 && !magnet1.hasAttracted) {
                        magnet1.hasAttracted = true;
                        playSuccessSound();
                        createParticleEffect();
                        showMessage(elements.characters.professorBubble, "Excellent! Unlike poles attract each other!");
                        
                        // Increase score
                        gameState.score++;
                        updateScoreDisplay();
                    }
                }
                
                // Reset transform after a delay
                setTimeout(() => {
                    magnet1.element.style.transform = 'translate(0, 0)';
                }, 300);
            }
            
            // Update compass direction
            function updateCompass() {
                const compass = gameState.objects.find(obj => obj.type === 'compass');
                if (!compass) return;
                
                // Get compass needle
                const needle = compass.element.querySelector('.compass-needle');
                if (!needle) return;
                
                // Default - align with Earth's magnetic field (North)
                let targetAngle = 0;
                
                // Check for nearby magnets
                let strongestInfluence = 0;
                
                gameState.magnets.forEach(magnet => {
                    if (magnet.shape === 'electromagnet' && !magnet.active) return;
                    
                    // Calculate distance and angle
                    const dx = magnet.x - compass.x;
                    const dy = magnet.y - compass.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    // Calculate influence strength (inverse square law)
                    const strength = 10000 / (distance * distance);
                    
                    // Check if this magnet has stronger influence
                    if (strength > strongestInfluence) {
                        strongestInfluence = strength;
                        
                        // Calculate angle to magnet
                        let angle = Math.atan2(dy, dx) * (180 / Math.PI);
                        
                        // Adjust based on magnet pole
                        if (magnet.type === 'north') {
                            angle -= 90; // North pole attracts south end of needle
                        } else {
                            angle += 90; // South pole attracts north end of needle
                        }
                        
                        targetAngle = angle;
                    }
                });
                
                // Apply rotation
                needle.style.transition = 'transform 0.5s ease';
                needle.style.transformOrigin = 'center';
                needle.style.transform = `rotate(${targetAngle}deg)`;
                
                // Show success message if compass has rotated
                if (strongestInfluence > 1 && !compass.hasInteracted) {
                    compass.hasInteracted = true;
                    playSuccessSound();
                    createParticleEffect();
                    showMessage(elements.characters.professorBubble, "The compass needle is a tiny magnet that aligns with magnetic fields!");
                    
                    // Increase score
                    gameState.score++;
                    updateScoreDisplay();
                }
            }
            
            // Show level introduction
            function showLevelIntro(level) {
                // Define level messages
                const levelIntros = [
                    "", // Level 0 (not used)
                    "Level 1: Welcome to Magnetic Explorer! Let's learn what magnetic attraction is. Try moving the magnet near different objects.",
                    "Level 2: Now let's learn about magnetic poles! Each magnet has a North (N) and South (S) pole. Try bringing the magnets together in different ways.",
                    "Level 3: Let's explore magnetic fields! The iron filings will help us see the invisible magnetic field lines.",
                    "Level 4: Time to discover electromagnets! These special magnets use electricity to create magnetic fields. Use the switch to turn it on and off.",
                    "Level 5: Let's learn how Earth's magnetism works! Our planet is like a giant magnet with North and South magnetic poles."
                ];
                
                // Show intro message
                const message = levelIntros[level] || "Let's explore magnets!";
                showMessage(elements.characters.professorBubble, message);
            }
            
            // Start quiz mode
            function startQuiz() {
                // Show quiz screen
                showScreen('quizScreen');
                
                // Generate question based on current level
                generateQuizQuestion();
                
                // Play sound
                playButtonSound();
            }
            
            // Generate a quiz question
            function generateQuizQuestion() {
                // Clear previous state
                gameState.currentQuiz.userAnswer = null;
                elements.displays.quizOptions.innerHTML = '';
                
                // Create question based on current level and difficulty
                const level = gameState.currentLevel;
                const difficulty = gameState.settings.difficulty;
                
                // Define questions for each level
                const questions = [
                    [], // Level 0 (not used)
                    [ // Level 1 questions
                        {
                            question: "Which of these objects would be attracted to a magnet?",
                            options: ["Paper clip", "Plastic toy", "Wooden block", "Rubber eraser"],
                            correctAnswer: "Paper clip"
                        },
                        {
                            question: "What happens when you bring a magnet close to a paper clip?",
                            options: ["The paper clip is attracted to the magnet", "The paper clip is pushed away", "Nothing happens", "The paper clip changes color"],
                            correctAnswer: "The paper clip is attracted to the magnet"
                        },
                        {
                            question: "Magnets can attract objects made of:",
                            options: ["Iron", "Plastic", "Wood", "Glass"],
                            correctAnswer: "Iron"
                        }
                    ],
                    [ // Level 2 questions
                        {
                            question: "What happens when you bring the North pole of one magnet close to the North pole of another magnet?",
                            options: ["They repel each other", "They attract each other", "Nothing happens", "They cancel each other out"],
                            correctAnswer: "They repel each other"
                        },
                        {
                            question: "What happens when you bring the North pole of one magnet close to the South pole of another magnet?",
                            options: ["They attract each other", "They repel each other", "Nothing happens", "They spin around"],
                            correctAnswer: "They attract each other"
                        },
                        {
                            question: "Every magnet has:",
                            options: ["Both a North and South pole", "Only a North pole", "Only a South pole", "Neither pole"],
                            correctAnswer: "Both a North and South pole"
                        }
                    ],
                    [ // Level 3 questions
                        {
                            question: "What are the invisible lines around a magnet called?",
                            options: ["Magnetic field lines", "Magic lines", "Gravity waves", "Electric circuits"],
                            correctAnswer: "Magnetic field lines"
                        },
                        {
                            question: "Where is a magnet's magnetic field strongest?",
                            options: ["At the poles", "In the middle", "Everywhere equally", "Outside the magnet"],
                            correctAnswer: "At the poles"
                        },
                        {
                            question: "What do iron filings do when placed near a magnet?",
                            options: ["Align with the magnetic field lines", "Bounce away from the magnet", "Dissolve", "Form a circle"],
                            correctAnswer: "Align with the magnetic field lines"
                        }
                    ],
                    [ // Level 4 questions
                        {
                            question: "What does an electromagnet use to create a magnetic field?",
                            options: ["Electricity", "Gravity", "Light", "Sound"],
                            correctAnswer: "Electricity"
                        },
                        {
                            question: "What happens when you turn off the power to an electromagnet?",
                            options: ["It loses its magnetic field", "It gets stronger", "It changes poles", "It heats up"],
                            correctAnswer: "It loses its magnetic field"
                        },
                        {
                            question: "Which of these is an advantage of electromagnets over permanent magnets?",
                            options: ["You can turn them on and off", "They are always stronger", "They are smaller", "They last forever"],
                            correctAnswer: "You can turn them on and off"
                        }
                    ],
                    [ // Level 5 questions
                        {
                            question: "What is Earth's magnetic field like?",
                            options: ["Like a giant bar magnet", "Like lightning", "Like gravity", "Like light"],
                            correctAnswer: "Like a giant bar magnet"
                        },
                        {
                            question: "What does a compass needle do?",
                            options: ["Points toward Earth's magnetic North", "Points toward the Sun", "Spins randomly", "Points toward the equator"],
                            correctAnswer: "Points toward Earth's magnetic North"
                        },
                        {
                            question: "Earth's magnetic North pole is:",
                            options: ["Near the geographic North pole", "Near the geographic South pole", "At the equator", "In outer space"],
                            correctAnswer: "Near the geographic North pole"
                        }
                    ]
                ];
                
                // Advanced questions for higher difficulty
                const advancedQuestions = [
                    [], // Level 0 (not used)
                    [ // Level 1 advanced
                        {
                            question: "Which of these metals is NOT magnetic?",
                            options: ["Aluminum", "Iron", "Nickel", "Cobalt"],
                            correctAnswer: "Aluminum"
                        }
                    ],
                    [ // Level 2 advanced
                        {
                            question: "If you cut a magnet in half, what happens to the poles?",
                            options: ["Each half becomes a complete magnet with N and S poles", "One half has only N, the other only S", "The magnetism disappears", "The poles switch places"],
                            correctAnswer: "Each half becomes a complete magnet with N and S poles"
                        }
                    ],
                    [ // Level 3 advanced
                        {
                            question: "Magnetic field lines:",
                            options: ["Flow from North to South outside the magnet", "Flow from South to North outside the magnet", "Form perfect circles", "Only exist inside the magnet"],
                            correctAnswer: "Flow from North to South outside the magnet"
                        }
                    ],
                    [ // Level 4 advanced
                        {
                            question: "What is inside a simple electromagnet?",
                            options: ["A coil of wire wrapped around an iron core", "A battery inside a magnet", "Two permanent magnets that spin", "A glowing crystal"],
                            correctAnswer: "A coil of wire wrapped around an iron core"
                        }
                    ],
                    [ // Level 5 advanced
                        {
                            question: "Earth's magnetic field helps protect us from:",
                            options: ["Solar radiation", "Gravity", "Rain", "Sound waves"],
                            correctAnswer: "Solar radiation"
                        }
                    ]
                ];
                
                // Choose question set based on difficulty
                let questionSet = questions[level] || questions[1];
                if (difficulty > 5 && advancedQuestions[level] && advancedQuestions[level].length > 0) {
                    // Add advanced questions for higher difficulty levels
                    questionSet = questionSet.concat(advancedQuestions[level]);
                }
                
                // Randomly select a question
                const randomIndex = Math.floor(Math.random() * questionSet.length);
                const quizQuestion = questionSet[randomIndex];
                
                // Set current quiz
                gameState.currentQuiz.question = quizQuestion.question;
                gameState.currentQuiz.options = quizQuestion.options;
                gameState.currentQuiz.correctAnswer = quizQuestion.correctAnswer;
                
                // Display question
                elements.displays.quizQuestion.textContent = quizQuestion.question;
                
                // Create options
                quizQuestion.options.forEach(option => {
                    const optionElement = document.createElement('div');
                    optionElement.className = 'quiz-option';
                    optionElement.textContent = option;
                    optionElement.addEventListener('click', function() {
                        selectQuizOption(this);
                    });
                    elements.displays.quizOptions.appendChild(optionElement);
                });
            }
            
            // Select a quiz option
            function selectQuizOption(optionElement) {
                // Play sound
                playSelectSound();
                
                // Clear any previous selections
                const options = elements.displays.quizOptions.querySelectorAll('.quiz-option');
                options.forEach(option => {
                    option.classList.remove('selected');
                });
                
                // Select the clicked option
                optionElement.classList.add('selected');
                
                // Store user's answer
                gameState.currentQuiz.userAnswer = optionElement.textContent;
            }
            
            // Check quiz answer
            function checkQuizAnswer() {
                if (!gameState.currentQuiz.userAnswer) {
                    // No answer selected
                    showMessage(elements.characters.professorBubble, "Please select an answer first!");
                    return;
                }
                
                // Check if the answer is correct
                if (gameState.currentQuiz.userAnswer === gameState.currentQuiz.correctAnswer) {
                    // Correct answer
                    playSuccessSound();
                    createParticleEffect();
                    
                    // Show celebration message
                    showMessage(elements.characters.professorBubble, "Excellent! That's correct!");
                    
                    // Increment score
                    gameState.score++;
                    
                    // Proceed to next question or end quiz
                    if (gameState.score >= 5) {
                        // Quiz completed
                        setTimeout(() => {
                            completeQuiz();
                        }, 2000);
                    } else {
                        // Next question
                        setTimeout(() => {
                            generateQuizQuestion();
                        }, 2000);
                    }
                } else {
                    // Incorrect answer
                    playErrorSound();
                    
                    // Show hint message
                    showMessage(elements.characters.professorBubble, `Not quite. The correct answer is ${gameState.currentQuiz.correctAnswer}.`);
                    
                    // Highlight correct answer
                    const options = elements.displays.quizOptions.querySelectorAll('.quiz-option');
                    options.forEach(option => {
                        if (option.textContent === gameState.currentQuiz.correctAnswer) {
                            option.classList.add('correct');
                        } else if (option.classList.contains('selected')) {
                            option.classList.add('incorrect');
                        }
                    });
                    
                    // Next question after delay
                    setTimeout(() => {
                        generateQuizQuestion();
                    }, 3000);
                }
            }
            
            // Complete the quiz
            function completeQuiz() {
                // Show reward screen
                showScreen('rewardScreen');
                
                // Set reward text based on score
                if (gameState.score >= 5) {
                    elements.displays.rewardText.textContent = "Amazing! You're a Magnet Master!";
                } else if (gameState.score >= 3) {
                    elements.displays.rewardText.textContent = "Great job! You're getting really good with magnets!";
                } else {
                    elements.displays.rewardText.textContent = "Good effort! Keep practicing to master magnetism!";
                }
                
                // Create celebration animation
                createRewardAnimation();
            }
            
            // Continue game after quiz
            function continueGame() {
                // Reset game state for next session
                gameState.currentLevel = Math.min(gameState.currentLevel + 1, gameState.maxLevel);
                gameState.score = 0;
                gameState.progress = 0;
                
                // Load the next level
                loadLevel(gameState.currentLevel);
                
                // Show the game screen
                showScreen('gameScreen');
            }
            
            // Show a screen
            function showScreen(screenName) {
                // Hide all screens
                Object.values(elements.screens).forEach(screen => {
                    screen.classList.remove('visible');
                    screen.classList.add('hidden');
                });
                
                // Show the requested screen
                elements.screens[screenName].classList.remove('hidden');
                elements.screens[screenName].classList.add('visible');
            }
            
            // Toggle hint visibility
            function toggleHint() {
                const hintContainer = elements.displays.hintContainer;
                
                if (hintContainer.style.opacity === '1') {
                    hintContainer.style.opacity = '0';
                } else {
                    hintContainer.style.opacity = '1';
                    
                    // Auto-hide after 5 seconds
                    setTimeout(() => {
                        hintContainer.style.opacity = '0';
                    }, 5000);
                }
            }
            
            // Show a character message
            function showMessage(bubbleElement, message) {
                // Set the message text
                bubbleElement.textContent = message;
                
                // Show the bubble
                bubbleElement.style.opacity = '1';
                
                // Auto-hide after delay based on message length
                const delay = Math.max(3000, message.length * 50);
                setTimeout(() => {
                    bubbleElement.style.opacity = '0';
                }, delay);
            }
            
            // Create learning path
            function createLearningPath() {
                const pathContainer = elements.displays.learningPath;
                
                // Clear any existing segments
                pathContainer.innerHTML = '';
                
                // Create segments for each level
                for (let i = 0; i < gameState.maxLevel; i++) {
                    const segment = document.createElement('div');
                    segment.className = 'path-segment';
                    segment.setAttribute('data-level', i + 1);
                    pathContainer.appendChild(segment);
                }
            }
            
            // Update learning path
            // Update learning path
function updateLearningPath() {
    const segments = elements.displays.learningPath.querySelectorAll('.path-segment');
    
    segments.forEach((segment, index) => {
        const level = index + 1;
        
        if (level < gameState.currentLevel) {
            segment.className = 'path-segment completed';
        } else if (level === gameState.currentLevel) {
            segment.className = 'path-segment current';
        } else {
            segment.className = 'path-segment';
        }
    });
}

// Update score display
function updateScoreDisplay() {
    elements.displays.scoreDisplay.textContent = `Score: ${gameState.score}`;
}

// Create celebration particle effect
function createParticleEffect() {
    // Clear any existing particles
    clearParticles();
    
    // Create stars or bubbles
    const particleCount = 30;
    const particleTypes = ['star', 'bubble'];
    
    for (let i = 0; i < particleCount; i++) {
        const particleType = particleTypes[Math.floor(Math.random() * particleTypes.length)];
        createParticle(particleType);
    }
}

// Create a single particle
function createParticle(type) {
    const container = document.getElementById('game-container');
    
    if (type === 'star') {
        // Create a star
        const star = document.createElement('div');
        star.className = 'star';
        
        // Random position
        const x = Math.random() * window.innerWidth;
        const y = Math.random() * window.innerHeight;
        
        // Random size
        const size = Math.random() * 30 + 10;
        
        // Star SVG
        star.innerHTML = `
            <svg width="${size}" height="${size}" viewBox="0 0 51 48">
                <path fill="#FFD700" d="m25,1 6,17h18l-14,11 5,17-15-10-15,10 5-17-14-11h18z"/>
            </svg>
        `;
        
        star.style.left = `${x}px`;
        star.style.top = `${y}px`;
        container.appendChild(star);
        
        // Animation
        const angle = Math.random() * Math.PI * 2;
        const speed = Math.random() * 5 + 2;
        const dx = Math.cos(angle) * speed;
        const dy = Math.sin(angle) * speed;
        
        let opacity = 1;
        let posX = x;
        let posY = y;
        
        const animation = setInterval(() => {
            opacity -= 0.01;
            posX += dx;
            posY += dy;
            
            star.style.opacity = opacity;
            star.style.left = `${posX}px`;
            star.style.top = `${posY}px`;
            
            if (opacity <= 0) {
                clearInterval(animation);
                star.remove();
            }
        }, 20);
        
        gameState.animations.stars.push(star);
        gameState.animations.timers.push(animation);
    } else {
        // Create a bubble
        const bubble = document.createElement('div');
        bubble.className = 'bubble';
        
        // Random position
        const x = Math.random() * window.innerWidth;
        const y = window.innerHeight + 20;
        
        // Random size
        const size = Math.random() * 40 + 20;
        
        // Random color
        const colors = ['#FF5252', '#2196F3', '#4CAF50', '#FFC107', '#9C27B0'];
        const color = colors[Math.floor(Math.random() * colors.length)];
        
        bubble.style.width = `${size}px`;
        bubble.style.height = `${size}px`;
        bubble.style.backgroundColor = color;
        bubble.style.left = `${x}px`;
        bubble.style.top = `${y}px`;
        bubble.style.opacity = '0.7';
        container.appendChild(bubble);
        
        // Animation
        const speed = Math.random() * 3 + 1;
        let posY = y;
        
        const animation = setInterval(() => {
            posY -= speed;
            bubble.style.top = `${posY}px`;
            
            if (posY < -size) {
                clearInterval(animation);
                bubble.remove();
            }
        }, 20);
        
        gameState.animations.bubbles.push(bubble);
        gameState.animations.timers.push(animation);
    }
}

// Clear all particles
function clearParticles() {
    // Clear all animation timers
    gameState.animations.timers.forEach(timer => {
        clearInterval(timer);
    });
    
    // Remove all stars and bubbles
    gameState.animations.stars.forEach(star => {
        if (star.parentNode) {
            star.remove();
        }
    });
    
    gameState.animations.bubbles.forEach(bubble => {
        if (bubble.parentNode) {
            bubble.remove();
        }
    });
    
    // Reset arrays
    gameState.animations.stars = [];
    gameState.animations.bubbles = [];
    gameState.animations.timers = [];
}

// Create reward animation
function createRewardAnimation() {
    const container = elements.displays.rewardAnimation;
    
    // Clear container
    container.innerHTML = '';
    
    // Create canvas for celebration
    const canvas = document.createElement('canvas');
    canvas.width = container.clientWidth;
    canvas.height = container.clientHeight;
    container.appendChild(canvas);
    
    const ctx = canvas.getContext('2d');
    
    // Draw celebration background
    ctx.fillStyle = 'rgba(33, 150, 243, 0.1)';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Characters
    const professorImage = createCharacterImage('professor');
    const maggieImage = createCharacterImage('maggie');
    
    // Draw characters
    ctx.drawImage(professorImage, 50, 50, 150, 150);
    ctx.drawImage(maggieImage, canvas.width - 200, 50, 150, 150);
    
    // Celebration text
    ctx.font = '30px Arial, sans-serif';
    ctx.fillStyle = '#2a70e0';
    ctx.textAlign = 'center';
    ctx.fillText('Congratulations!', canvas.width / 2, 50);
    
    // Medal
    drawMedal(ctx, canvas.width / 2, canvas.height / 2);
    
    // Start particle animation
    createParticleEffect();
    
    // Play celebration sound
    playCelebrationSound();
}

// Create character image
function createCharacterImage(character) {
    const canvas = document.createElement('canvas');
    canvas.width = 150;
    canvas.height = 150;
    const ctx = canvas.getContext('2d');
    
    if (character === 'professor') {
        // Draw professor
        // Body
        ctx.fillStyle = '#1E88E5';
        ctx.beginPath();
        ctx.ellipse(75, 95, 30, 35, 0, 0, Math.PI * 2);
        ctx.fill();
        
        // Head
        ctx.fillStyle = '#FFD700';
        ctx.beginPath();
        ctx.arc(75, 45, 20, 0, Math.PI * 2);
        ctx.fill();
        
        // Eyes
        ctx.fillStyle = 'white';
        ctx.beginPath();
        ctx.arc(67, 40, 4, 0, Math.PI * 2);
        ctx.arc(83, 40, 4, 0, Math.PI * 2);
        ctx.fill();
        
        ctx.fillStyle = 'black';
        ctx.beginPath();
        ctx.arc(67, 40, 2, 0, Math.PI * 2);
        ctx.arc(83, 40, 2, 0, Math.PI * 2);
        ctx.fill();
        
        // Glasses
        ctx.strokeStyle = 'black';
        ctx.lineWidth = 1.5;
        ctx.beginPath();
        ctx.arc(67, 40, 6, 0, Math.PI * 2);
        ctx.stroke();
        ctx.beginPath();
        ctx.arc(83, 40, 6, 0, Math.PI * 2);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(73, 40);
        ctx.lineTo(77, 40);
        ctx.stroke();
        
        // Smile
        ctx.beginPath();
        ctx.moveTo(65, 50);
        ctx.quadraticCurveTo(75, 60, 85, 50);
        ctx.stroke();
        
        // Beard
        ctx.fillStyle = '#A0522D';
        ctx.beginPath();
        ctx.moveTo(65, 55);
        ctx.quadraticCurveTo(75, 70, 85, 55);
        ctx.quadraticCurveTo(75, 60, 65, 55);
        ctx.fill();
        
        // Hair
        ctx.beginPath();
        ctx.moveTo(55, 35);
        ctx.quadraticCurveTo(75, 15, 95, 35);
        ctx.quadraticCurveTo(75, 25, 55, 35);
        ctx.fill();
        
        // Arms
        ctx.strokeStyle = '#FFD700';
        ctx.lineWidth = 5;
        ctx.lineCap = 'round';
        ctx.beginPath();
        ctx.moveTo(55, 85);
        ctx.lineTo(40, 75);
        ctx.moveTo(95, 85);
        ctx.lineTo(110, 75);
        ctx.stroke();
        
        // Legs
        ctx.strokeStyle = '#1E88E5';
        ctx.lineWidth = 8;
        ctx.beginPath();
        ctx.moveTo(65, 130);
        ctx.lineTo(60, 145);
        ctx.moveTo(85, 130);
        ctx.lineTo(90, 145);
        ctx.stroke();
    } else {
        // Draw Maggie
        // Body (horseshoe magnet)
        ctx.strokeStyle = '#FF5252';
        ctx.lineWidth = 8;
        ctx.lineCap = 'round';
        ctx.beginPath();
        ctx.moveTo(40, 40);
        ctx.lineTo(40, 80);
        ctx.quadraticCurveTo(75, 110, 110, 80);
        ctx.lineTo(110, 40);
        ctx.stroke();
        
        // Head
        ctx.fillStyle = '#FF5252';
        ctx.beginPath();
        ctx.arc(75, 30, 18, 0, Math.PI * 2);
        ctx.fill();
        
        // Eyes
        ctx.fillStyle = 'white';
        ctx.beginPath();
        ctx.arc(67, 25, 4, 0, Math.PI * 2);
        ctx.arc(83, 25, 4, 0, Math.PI * 2);
        ctx.fill();
        
        ctx.fillStyle = 'black';
        ctx.beginPath();
        ctx.arc(67, 25, 2, 0, Math.PI * 2);
        ctx.arc(83, 25, 2, 0, Math.PI * 2);
        ctx.fill();
        
        // Smile
        ctx.strokeStyle = 'black';
        ctx.lineWidth = 1.5;
        ctx.beginPath();
        ctx.moveTo(65, 35);
        ctx.quadraticCurveTo(75, 45, 85, 35);
        ctx.stroke();
        
        // N and S poles
        ctx.fillStyle = 'white';
        ctx.font = '16px Arial, sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('N', 40, 55);
        ctx.fillText('S', 110, 55);
        
        // Arms
        ctx.strokeStyle = '#FF5252';
        ctx.lineWidth = 5;
        ctx.beginPath();
        ctx.moveTo(45, 50);
        ctx.lineTo(30, 55);
        ctx.moveTo(105, 50);
        ctx.lineTo(120, 55);
        ctx.stroke();
    }
    
    return canvas;
}

// Draw medal
function drawMedal(ctx, x, y) {
    // Medal Circle
    ctx.fillStyle = '#FFD700';
    ctx.beginPath();
    ctx.arc(x, y, 40, 0, Math.PI * 2);
    ctx.fill();
    
    // Rim
    ctx.strokeStyle = '#FFA000';
    ctx.lineWidth = 5;
    ctx.beginPath();
    ctx.arc(x, y, 40, 0, Math.PI * 2);
    ctx.stroke();
    
    // Ribbon
    ctx.fillStyle = '#F44336';
    ctx.beginPath();
    ctx.moveTo(x - 15, y + 40);
    ctx.lineTo(x - 25, y + 100);
    ctx.lineTo(x, y + 80);
    ctx.lineTo(x + 25, y + 100);
    ctx.lineTo(x + 15, y + 40);
    ctx.fill();
    
    // Magnet Symbol
    ctx.strokeStyle = '#1E88E5';
    ctx.lineWidth = 6;
    ctx.lineCap = 'round';
    ctx.beginPath();
    ctx.moveTo(x - 15, y - 10);
    ctx.lineTo(x - 15, y + 10);
    ctx.quadraticCurveTo(x, y + 20, x + 15, y + 10);
    ctx.lineTo(x + 15, y - 10);
    ctx.stroke();
    
    // Text
    ctx.fillStyle = '#1E88E5';
    ctx.font = '12px Arial, sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('MAGNET', x, y - 5);
    ctx.fillText('MASTER', x, y + 7);
}

// Sound functions
function playButtonSound() {
    if (audioContext && gameState.settings.soundVolume > 0) {
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
        
        gainNode.gain.setValueAtTime(gameState.settings.soundVolume / 10, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.3);
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.start();
        oscillator.stop(audioContext.currentTime + 0.3);
    }
}

function playTickSound() {
    if (audioContext && gameState.settings.soundVolume > 0) {
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(880, audioContext.currentTime);
        
        gainNode.gain.setValueAtTime(gameState.settings.soundVolume * 0.03, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.1);
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.start();
        oscillator.stop(audioContext.currentTime + 0.1);
    }
}

function playSelectSound() {
    if (audioContext && gameState.settings.soundVolume > 0) {
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(660, audioContext.currentTime);
        oscillator.frequency.exponentialRampToValueAtTime(880, audioContext.currentTime + 0.1);
        
        gainNode.gain.setValueAtTime(gameState.settings.soundVolume * 0.05, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.2);
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.start();
        oscillator.stop(audioContext.currentTime + 0.2);
    }
}

function playSuccessSound() {
    if (audioContext && gameState.settings.soundVolume > 0) {
        const notes = [523.25, 659.25, 783.99, 1046.50]; // C5, E5, G5, C6
        
        notes.forEach((frequency, index) => {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime + index * 0.1);
            
            gainNode.gain.setValueAtTime(0, audioContext.currentTime + index * 0.1);
            gainNode.gain.linearRampToValueAtTime(gameState.settings.soundVolume * 0.05, audioContext.currentTime + index * 0.1 + 0.01);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + index * 0.1 + 0.3);
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.start(audioContext.currentTime + index * 0.1);
            oscillator.stop(audioContext.currentTime + index * 0.1 + 0.3);
        });
    }
}

function playErrorSound() {
    if (audioContext && gameState.settings.soundVolume > 0) {
        const frequencies = [349.23, 329.63, 311.13]; // F4, E4, D#4/Eb4
        
        frequencies.forEach((frequency, index) => {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime + index * 0.15);
            
            gainNode.gain.setValueAtTime(0, audioContext.currentTime + index * 0.15);
            gainNode.gain.linearRampToValueAtTime(gameState.settings.soundVolume * 0.05, audioContext.currentTime + index * 0.15 + 0.01);
            gainNode.gain.linearRampToValueAtTime(0.001, audioContext.currentTime + index * 0.15 + 0.3);
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.start(audioContext.currentTime + index * 0.15);
            oscillator.stop(audioContext.currentTime + index * 0.15 + 0.3);
        });
    }
}

function playCelebrationSound() {
    if (audioContext && gameState.settings.soundVolume > 0) {
        // Major scale ascending and then chord
        const notes = [
            { freq: 523.25, time: 0 },    // C5
            { freq: 587.33, time: 0.15 }, // D5
            { freq: 659.25, time: 0.3 },  // E5
            { freq: 698.46, time: 0.45 }, // F5
            { freq: 783.99, time: 0.6 },  // G5
            { freq: 880.00, time: 0.75 }, // A5
            { freq: 987.77, time: 0.9 },  // B5
            { freq: 1046.50, time: 1.05 }, // C6
            // Final chord
            { freq: 523.25, time: 1.3 }, // C5
            { freq: 659.25, time: 1.3 }, // E5
            { freq: 783.99, time: 1.3 }, // G5
            { freq: 1046.50, time: 1.3 }  // C6
        ];
        
        notes.forEach(note => {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(note.freq, audioContext.currentTime + note.time);
            
            gainNode.gain.setValueAtTime(0, audioContext.currentTime + note.time);
            gainNode.gain.linearRampToValueAtTime(gameState.settings.soundVolume * 0.03, audioContext.currentTime + note.time + 0.01);
            
            // Longer sustain for the final chord
            if (note.time === 1.3) {
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + note.time + 1.0);
                oscillator.start(audioContext.currentTime + note.time);
                oscillator.stop(audioContext.currentTime + note.time + 1.0);
            } else {
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + note.time + 0.2);
                oscillator.start(audioContext.currentTime + note.time);
                oscillator.stop(audioContext.currentTime + note.time + 0.2);
            }
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
        });
    }
}

// Add advanced magnetism explanations
function getAdvancedExplanation(concept) {
    const explanations = {
        'attraction': {
            'kid': "Magnets have special powers to pull some things toward them!",
            'phd': "Magnetic attraction occurs due to the alignment of unpaired electron spins in ferromagnetic materials, creating a net magnetic dipole moment that interacts with external magnetic fields according to Coulomb's law."
        },
        'repulsion': {
            'kid': "Magnets can push each other away like invisible force fields!",
            'phd': "Magnetic repulsion results from the interaction of like magnetic poles, where the parallel alignment of magnetic dipole moments creates opposing force vectors according to the Biot-Savart law."
        },
        'fields': {
            'kid': "Magnets make invisible bubbles of power around them!",
            'phd': "Magnetic fields are vector fields that describe the magnetic influence on moving electric charges, electric currents, and magnetic materials. The field can be defined by the Lorentz force law and represented mathematically as B = ∇ × A, where A is the magnetic vector potential."
        },
        'poles': {
            'kid': "Magnets have two special ends called poles - North and South!",
            'phd': "Magnetic poles are regions where magnetic field lines converge or diverge, representing the dipole nature of magnetism. The divergence of the magnetic field (∇·B = 0) mathematically confirms that isolated magnetic monopoles do not exist in classical electromagnetism."
        },
        'electromagnetism': {
            'kid': "We can make magnets with electricity! Turn it on, and it becomes magnetic!",
            'phd': "Electromagnetism arises from the interaction between electric currents and magnetic fields as described by Maxwell's equations. A current-carrying wire induces a circular magnetic field according to Ampère's law: ∮B·dl = μ₀I, where the magnetic field strength is proportional to the current."
        },
        'earth': {
            'kid': "Earth is like a giant magnet with its own North and South poles!",
            'phd': "Earth's geomagnetic field is generated by the geodynamo process in the outer core, where convection of liquid iron alloys creates electrical currents that produce a self-sustaining magnetic field through the magnetohydrodynamic equations."
        },
        'compass': {
            'kid': "A compass needle is a tiny magnet that points to Earth's North Pole!",
            'phd': "Compass needles align with Earth's magnetic field lines due to the torque exerted on their magnetic moment, orienting to minimize potential energy in accordance with τ = m × B, where m is the magnetic moment and B is the external field."
        },
        'domains': {
            'kid': "Inside magnets are tiny groups called domains that work together!",
            'phd': "Magnetic domains are regions of uniform magnetization in ferromagnetic materials, separated by domain walls where the magnetization rotates from one direction to another, minimizing the total free energy including exchange, anisotropy, and magnetostatic contributions."
        }
    };
    
    const difficulty = gameState.settings.difficulty;
    
    if (difficulty <= 3) {
        return explanations[concept]?.kid || "Let's learn about magnets!";
    } else if (difficulty <= 7) {
        return explanations[concept]?.kid + " " + explanations[concept]?.phd || "Let's explore magnetism in detail!";
    } else {
        return explanations[concept]?.phd || "Let's examine the quantum physics of magnetism!";
    }
}

// Add educational resources
function getEducationalFacts() {
    return [
        "Did you know? If you cut a magnet in half, you get two smaller magnets, each with its own North and South pole!",
        "Magnetic fields are strongest at the poles of a magnet!",
        "The Earth's magnetic poles slowly move over time - the North Magnetic Pole moves about 55 kilometers per year!",
        "Some animals like pigeons, sea turtles, and certain bacteria can detect Earth's magnetic field!",
        "The strongest magnets in the world are made from rare earth elements and can be over 100,000 times stronger than Earth's magnetic field!",
        "Magnets can temporarily or permanently lose their magnetism when heated above a temperature called the Curie point!",
        "MRI machines in hospitals use powerful magnets to create detailed images of the inside of your body!",
        "The ancient Greeks discovered magnetism over 2,500 years ago in a region called Magnesia!",
        "Electric motors use electromagnets to convert electricity into motion!"
    ];
}

        
        
// Initialize the game when the window loads
window.addEventListener('load', initGame);




</script>
</body>
</html>