<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MathQuest: Calculus Adventures</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap');
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: linear-gradient(135deg, #9cecfb, #65c7f7, #0052d4);
            font-family: 'Nunito', 'Arial', sans-serif;
            color: #333;
            transition: background 0.5s;
        }

        #game-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        #header {
            text-align: center;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            position: relative;
            z-index: 10;
        }

        #game-title {
            font-size: 2.2em;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            margin: 0;
            background: linear-gradient(90deg, #FF9A8B, #FF6A88, #FF99AC);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            animation: title-shimmer 2s infinite;
        }

        @keyframes title-shimmer {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        #main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        #nav-bar {
            display: flex;
            justify-content: center;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 5;
        }

        .nav-button {
            background: linear-gradient(135deg, #6a11cb, #2575fc);
            color: white;
            border: none;
            padding: 10px 15px;
            margin: 0 10px;
            border-radius: 50px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        .nav-button:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: 0.5s;
        }

        .nav-button:hover:before {
            left: 100%;
        }

        .nav-button:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 7px 10px rgba(0, 0, 0, 0.2);
        }

        .nav-button.active {
            background: linear-gradient(135deg, #11998e, #38ef7d);
            transform: translateY(-2px);
        }

        #canvas-container {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            padding: 20px;
            min-height: 400px;
            min-width: 600px;
        }

        #game-canvas {
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            background-color: rgba(255, 255, 255, 0.95);
            display: block; /* Remove any default inline spacing */
        }

        /* Make canvas display more consistently */
        canvas {
            max-width: 100%;
            max-height: 100%;
        }

        /* Fix for P5 canvas position */
        canvas.p5Canvas {
            display: block !important;
            margin: 0 auto !important;
        }

        #side-panel {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 300px;
            background-color: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            max-height: 90%;
            overflow-y: auto;
            z-index: 5;
            transition: all 0.3s;
        }

        #side-panel.minimized {
            transform: translateX(calc(100% - 40px)) translateY(-50%);
        }

        #toggle-panel {
            position: absolute;
            left: -20px;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 40px;
            background-color: #6a11cb;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            box-shadow: -3px 0 10px rgba(0, 0, 0, 0.1);
        }

        .panel-section {
            margin-bottom: 20px;
            display: none;
        }

        .panel-section.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .panel-title {
            font-size: 1.3em;
            margin-bottom: 15px;
            color: #6a11cb;
            border-bottom: 2px solid #6a11cb;
            padding-bottom: 5px;
        }

        .slider-container {
            margin: 15px 0;
            position: relative;
        }

        .slider-container label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .slider-container .value-display {
            position: absolute;
            right: 0;
            top: 0;
            background-color: #6a11cb;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.9em;
        }

        input[type="range"] {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            outline: none;
            appearance: none;
            cursor: pointer;
        }

        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #6a11cb;
            cursor: pointer;
            transition: all 0.2s;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            background: #38ef7d;
        }

        select {
            width: 100%;
            padding: 8px 10px;
            border-radius: 8px;
            border: 2px solid #6a11cb;
            background-color: white;
            font-family: 'Nunito', sans-serif;
            cursor: pointer;
            outline: none;
            transition: all 0.2s;
        }

        select:hover {
            border-color: #38ef7d;
        }

        #character-container {
            position: absolute;
            left: 20px;
            bottom: 20px;
            width: 350px;
            z-index: 10;
        }

        .speech-bubble {
            background-color: white;
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            margin-bottom: 15px;
            position: relative;
            min-height: 100px;
            transition: all 0.3s;
        }

        .speech-bubble:after {
            content: '';
            position: absolute;
            bottom: -15px;
            left: 50px;
            border-width: 15px 15px 0;
            border-style: solid;
            border-color: white transparent;
            display: block;
            width: 0;
        }

        .character {
            display: flex;
            justify-content: flex-start;
            align-items: flex-end;
            height: 120px;
        }

        .character-avatar {
            width: 100px;
            height: 100px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
        }

        .character-avatar:hover {
            transform: translateY(-10px);
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        #reward-container {
            position: absolute;
            top: 70px;
            right: 20px;
            background-color: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .star {
            width: 30px;
            height: 30px;
            margin: 0 5px;
            filter: grayscale(100%);
            transition: all 0.3s;
        }

        .star.earned {
            filter: grayscale(0%);
            animation: star-pulse 0.5s;
        }

        @keyframes star-pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.5); }
            100% { transform: scale(1); }
        }

        .progress-bar-container {
            width: 100%;
            height: 15px;
            background-color: #e0e0e0;
            border-radius: 7.5px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #11998e, #38ef7d);
            width: 0%;
            border-radius: 7.5px;
            transition: width 0.5s;
        }

        .badge {
            width: 60px;
            height: 60px;
            margin: 5px;
            border-radius: 50%;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            color: #ccc;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }

        .badge.earned {
            background: linear-gradient(135deg, #ff9a8b, #ff6a88);
            color: white;
            animation: badge-earned 0.7s;
        }

        @keyframes badge-earned {
            0% { transform: scale(1); }
            50% { transform: scale(1.2) rotate(10deg); }
            100% { transform: scale(1); }
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 100;
            justify-content: center;
            align-items: center;
            perspective: 1000px;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative;
            transform-style: preserve-3d;
            transform: rotateX(0deg);
            transition: transform 0.5s;
        }

        .modal-overlay.closing .modal-content {
            transform: rotateX(90deg);
        }

        .modal-title {
            font-size: 2em;
            margin-bottom: 20px;
            color: #6a11cb;
        }

        .modal-button {
            background: linear-gradient(135deg, #6a11cb, #2575fc);
            color: white;
            border: none;
            padding: 12px 24px;
            margin-top: 20px;
            border-radius: 50px;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .modal-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 15px rgba(0, 0, 0, 0.3);
        }

        .quiz-container {
            margin-top: 20px;
            text-align: left;
        }

        .quiz-question {
            font-size: 1.2em;
            margin-bottom: 15px;
        }

        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .quiz-option {
            background-color: rgba(255, 255, 255, 0.9);
            border: 2px solid #e0e0e0;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.1em;
        }

        .quiz-option:hover {
            background-color: #f5f5f5;
            transform: translateX(5px);
        }

        .quiz-option.selected {
            border-color: #6a11cb;
            background-color: rgba(106, 17, 203, 0.1);
        }

        .quiz-option.correct {
            border-color: #38ef7d;
            background-color: rgba(56, 239, 125, 0.2);
        }

        .quiz-option.wrong {
            border-color: #ff6a88;
            background-color: rgba(255, 106, 136, 0.2);
        }

        .mini-game-container {
            height: 300px;
            width: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            margin: 20px 0;
            position: relative;
            overflow: hidden;
        }

        #confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }

        #menu-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #c33764, #1d2671);
            z-index: 50;
            transition: opacity 0.5s, transform 0.5s;
        }

        .menu-buttons {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 30px;
        }

        .big-button {
            background: linear-gradient(135deg, #ff9a8b, #ff6a88);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.5em;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 250px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .big-button:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: 0.5s;
        }

        .big-button:hover:before {
            left: 100%;
        }

        .big-button:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }

        .menu-title {
            font-size: 3em;
            color: white;
            text-shadow: 0 5px 10px rgba(0, 0, 0, 0.5);
            margin-bottom: 20px;
            background: linear-gradient(90deg, #FF9A8B, #FF6A88, #FF99AC);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .level-selection {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 30px 0;
            max-width: 600px;
            justify-content: center;
        }

        .level-button {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: 3px solid white;
            color: white;
            font-size: 1.5em;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .level-button:hover {
            transform: scale(1.1);
            background: rgba(255, 255, 255, 0.4);
        }

        .level-button.locked {
            background: rgba(100, 100, 100, 0.3);
            cursor: not-allowed;
        }

        .level-button.locked:after {
            content: '🔒';
            position: absolute;
            font-size: 1.5em;
        }

        .level-button.completed:after {
            content: '✓';
            position: absolute;
            bottom: -10px;
            right: -10px;
            background: #38ef7d;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.7em;
            color: white;
        }

        .back-button {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.3);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .back-button:hover {
            background: white;
            color: #6a11cb;
            transform: scale(1.1);
        }

        .adventure-map {
            width: 80%;
            height: 70%;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="500" height="500" viewBox="0 0 500 500"><path d="M50,250 Q125,150 250,250 T450,250" stroke="white" stroke-width="8" fill="none" stroke-dasharray="1,15" stroke-linecap="round"/></svg>') no-repeat center center;
            background-size: contain;
            position: relative;
            margin-top: 50px;
        }

        .map-node {
            position: absolute;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            border: 3px solid white;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
            font-size: 1.2em;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .map-node:hover {
            transform: scale(1.2);
            background: rgba(255, 255, 255, 0.5);
        }

        .map-node.locked {
            background: rgba(100, 100, 100, 0.3);
            cursor: not-allowed;
        }

        .map-node.locked:after {
            content: '🔒';
            position: absolute;
            font-size: 1.5em;
        }

        .map-node.completed {
            background: rgba(56, 239, 125, 0.5);
        }

        .map-node:nth-child(1) { top: 80%; left: 10%; }
        .map-node:nth-child(2) { top: 40%; left: 25%; }
        .map-node:nth-child(3) { top: 60%; left: 50%; }
        .map-node:nth-child(4) { top: 30%; left: 70%; }
        .map-node:nth-child(5) { top: 50%; left: 90%; }

        #game-levels {
            display: none;
        }

        #challenge-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            max-width: 80%;
        }

        .challenge-card {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 20px;
            width: 100%;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .challenge-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .challenge-card h3 {
            margin-bottom: 10px;
            font-size: 1.4em;
        }

        .level-description {
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            max-width: 80%;
            text-align: center;
        }

        .game-world {
            width: 100%;
            height: 100%;
            position: relative;
            display: block; /* Override display: none */
        }

        #level-completion {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 100;
            text-align: center;
            transition: all 0.5s;
        }

        #level-completion.show {
            transform: translate(-50%, -50%) scale(1);
        }

        .star-container {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }

        .completion-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .loading-spinner {
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 5px solid #6a11cb;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #c33764, #1d2671);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            transition: opacity 0.5s;
        }

        #loading-screen.hide {
            opacity: 0;
            pointer-events: none;
        }

        .loading-text {
            color: white;
            font-size: 1.5em;
            margin-top: 20px;
        }

        .tooltip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9em;
            z-index: 100;
            max-width: 200px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        /* Responsive adjustments for small screens */
        @media screen and (max-width: 768px) {
            #canvas-container {
                min-height: 300px;
                min-width: auto;
                padding: 10px;
            }
            
            #side-panel {
                width: 250px;
                max-height: 80%;
            }
            
            #game-title {
                font-size: 1.8em;
            }
            
            .nav-button {
                padding: 8px 12px;
                margin: 0 5px;
                font-size: 0.9em;
            }
            
            #character-container {
                width: 280px;
            }
        }
    </style>
</head>
<body>
    <div id="loading-screen">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading MathQuest...</div>
    </div>

    <div id="game-container">
        <div id="header">
            <h1 id="game-title">MathQuest: Calculus Adventures</h1>
        </div>

        <div id="main-content">
            <div id="nav-bar">
                <button class="nav-button" id="menu-button">Main Menu</button>
                <button class="nav-button" id="area-button">Area Explorer</button>
                <button class="nav-button" id="slope-button">Slope Detective</button>
                <button class="nav-button" id="challenge-button">Challenges</button>
                <button class="nav-button" id="badge-button">Badges</button>
            </div>

            <div id="canvas-container">
                <div id="game-canvas"></div>
                
                <div id="side-panel">
                    <button id="toggle-panel">≪</button>
                    
                    <div id="area-controls" class="panel-section">
                        <h3 class="panel-title">Area Explorer Controls</h3>
                        
                        <div class="slider-container">
                            <label for="shape-count">Number of Rectangles:</label>
                            <span class="value-display" id="shape-count-value">10</span>
                            <input type="range" id="shape-count" min="1" max="100" value="10">
                        </div>
                        
                        <div class="slider-container">
                            <label for="function-type">Function Type:</label>
                            <select id="function-type">
                                <option value="linear">Linear (y = mx + b)</option>
                                <option value="quadratic">Quadratic (y = ax² + b)</option>
                                <option value="cubic">Cubic (y = ax³ + b)</option>
                                <option value="sine">Sine Wave (y = sin(x))</option>
                                <option value="exponential">Exponential (y = eˣ)</option>
                            </select>
                        </div>
                        
                        <div class="slider-container" id="m-param-container">
                            <label for="m-param">Slope (m):</label>
                            <span class="value-display" id="m-param-value">1</span>
                            <input type="range" id="m-param" min="-3" max="3" step="0.1" value="1">
                        </div>
                        
                        <div class="slider-container" id="b-param-container">
                            <label for="b-param">y-intercept (b):</label>
                            <span class="value-display" id="b-param-value">0</span>
                            <input type="range" id="b-param" min="-3" max="3" step="0.1" value="0">
                        </div>
                        
                        <div class="slider-container" id="a-param-container" style="display: none;">
                            <label for="a-param">Coefficient (a):</label>
                            <span class="value-display" id="a-param-value">0.5</span>
                            <input type="range" id="a-param" min="-1" max="1" step="0.1" value="0.5">
                        </div>
                    </div>
                    
                    <div id="slope-controls" class="panel-section">
                        <h3 class="panel-title">Slope Detective Controls</h3>
                        
                        <div class="slider-container">
                            <label for="point-x">Point Position (x):</label>
                            <span class="value-display" id="point-x-value">0.5</span>
                            <input type="range" id="point-x" min="0" max="1" step="0.01" value="0.5">
                        </div>
                        
                        <div class="slider-container">
                            <label for="derivative-function">Function:</label>
                            <select id="derivative-function">
                                <option value="linear">Linear (y = mx + b)</option>
                                <option value="quadratic">Quadratic (y = ax² + b)</option>
                                <option value="cubic">Cubic (y = ax³ + b)</option>
                                <option value="sine">Sine Wave (y = sin(x))</option>
                                <option value="exponential">Exponential (y = eˣ)</option>
                            </select>
                        </div>
                        
                        <div class="slider-container" id="slope-m-param-container">
                            <label for="slope-m-param">Slope (m):</label>
                            <span class="value-display" id="slope-m-param-value">1</span>
                            <input type="range" id="slope-m-param" min="-3" max="3" step="0.1" value="1">
                        </div>
                        
                        <div class="slider-container" id="slope-b-param-container">
                            <label for="slope-b-param">y-intercept (b):</label>
                            <span class="value-display" id="slope-b-param-value">0</span>
                            <input type="range" id="slope-b-param" min="-3" max="3" step="0.1" value="0">
                        </div>
                        
                        <div class="slider-container" id="slope-a-param-container" style="display: none;">
                            <label for="slope-a-param">Coefficient (a):</label>
                            <span class="value-display" id="slope-a-param-value">0.5</span>
                            <input type="range" id="slope-a-param" min="-1" max="1" step="0.1" value="0.5">
                        </div>
                    </div>
                    
                    <div id="challenge-controls" class="panel-section">
                        <h3 class="panel-title">Challenge Info</h3>
                        <div id="challenge-description">
                            <p>Select a challenge to begin!</p>
                        </div>
                        
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="challenge-progress"></div>
                        </div>
                        
                        <p>Score: <span id="challenge-score">0</span> / <span id="challenge-total">10</span></p>
                    </div>
                    
                    <div id="badge-controls" class="panel-section">
                        <h3 class="panel-title">Your Badges</h3>
                        <div id="badges-container">
                            <div class="badge" id="explorer-badge" title="Area Explorer - Complete 5 area challenges">🔍</div>
                            <div class="badge" id="detective-badge" title="Slope Detective - Complete 5 slope challenges">🕵️</div>
                            <div class="badge" id="master-badge" title="Math Master - Get a perfect score on a challenge">🏆</div>
                            <div class="badge" id="creative-badge" title="Creative Genius - Create a custom function with 5 parameters">💡</div>
                            <div class="badge" id="quick-badge" title="Quick Thinker - Complete a challenge in under 2 minutes">⚡</div>
                        </div>
                        
                        <h3 class="panel-title" style="margin-top: 20px;">Your Progress</h3>
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="overall-progress"></div>
                        </div>
                        <p>Level: <span id="player-level">1</span></p>
                    </div>
                </div>
                
                <div id="character-container">
                    <div class="speech-bubble">
                        <p id="character-speech">Hi there! I'm Professor X. Ready to explore the exciting world of calculus? Choose a mode from the navigation bar to get started!</p>
                    </div>
                    <div class="character">
                        <div class="character-avatar" id="professor-x"></div>
                    </div>
                </div>
                
                <div id="reward-container" style="display: none;">
                    <h3>Rewards</h3>
                    <div class="star-container">
                        <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24' height='24'><path fill='%23FFD700' d='M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z'/></svg>" class="star" id="star-1">
                        <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24' height='24'><path fill='%23FFD700' d='M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z'/></svg>" class="star" id="star-2">
                        <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24' height='24'><path fill='%23FFD700' d='M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z'/></svg>" class="star" id="star-3">
                    </div>
                </div>
                
                <div id="confetti-container"></div>
                
                <div id="menu-container">
                    <h1 class="menu-title">MathQuest: Calculus Adventures</h1>
                    
                    <div class="menu-buttons">
                        <button class="big-button" id="start-adventure">Start Adventure</button>
                        <button class="big-button" id="free-play">Free Play</button>
                        <button class="big-button" id="mini-games">Mini Games</button>
                    </div>
                    
                    <div id="game-levels">
                        <h2 style="color: white; margin-bottom: 20px;">Select a Level</h2>
                        
                        <div class="adventure-map">
                            <div class="map-node" data-level="1">1</div>
                            <div class="map-node locked" data-level="2">2</div>
                            <div class="map-node locked" data-level="3">3</div>
                            <div class="map-node locked" data-level="4">4</div>
                            <div class="map-node locked" data-level="5">5</div>
                        </div>
                        
                        <button class="back-button" id="back-to-menu">↩</button>
                    </div>
                    
                    <div id="challenge-container" style="display: none;">
                        <h2 style="color: white; margin-bottom: 20px;">Select a Challenge</h2>
                        
                        <div class="challenge-card" data-challenge="area-basics">
                            <h3>Area Basics</h3>
                            <p>Learn how integrals calculate area under curves</p>
                        </div>
                        
                        <div class="challenge-card" data-challenge="slope-basics">
                            <h3>Slope Detective</h3>
                            <p>Discover the power of derivatives</p>
                        </div>
                        
                        <div class="challenge-card" data-challenge="function-factory">
                            <h3>Function Factory</h3>
                            <p>Create functions and explore their properties</p>
                        </div>
                        
                        <div class="challenge-card" data-challenge="integral-quiz">
                            <h3>Integral Quiz</h3>
                            <p>Test your knowledge about integrals</p>
                        </div>
                        
                        <button class="back-button" id="back-from-challenges">↩</button>
                    </div>
                </div>
                
                <div id="level-completion">
                    <h2>Level Complete!</h2>
                    <p>You've mastered the basics of area calculation!</p>
                    
                    <div class="star-container">
                        <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24' height='24'><path fill='%23FFD700' d='M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z'/></svg>" class="star earned">
                        <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24' height='24'><path fill='%23FFD700' d='M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z'/></svg>" class="star earned">
                        <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24' height='24'><path fill='%23FFD700' d='M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z'/></svg>" class="star">
                    </div>
                    
                    <div class="completion-buttons">
                        <button class="modal-button" id="next-level">Next Level</button>
                        <button class="modal-button" id="replay-level">Replay</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal">
        <div class="modal-content">
            <h2 class="modal-title" id="modal-title">Welcome to MathQuest!</h2>
            <p id="modal-text">Embark on an exciting adventure through the world of calculus! You'll explore areas under curves with integrals, investigate slopes with derivatives, and solve challenging puzzles along the way.</p>
            <div id="modal-quiz-container" style="display: none;"></div>
            <button class="modal-button" id="modal-close">Let's Go!</button>
        </div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <!-- Load P5.js with integrity check for better security and reliability -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js" 
            integrity="sha512-N4kV7GkNv7QR7RX9YF/olywyIgIwNvfEe2nZtfyj73HdjCUkAfOBDbcuJ/cTaN04JKRnw1YG1wnUyNKMsNgg3g==" 
            crossorigin="anonymous" 
            referrerpolicy="no-referrer"></script>

    <!-- Add a fallback for loading P5.js if the CDN fails -->
    <script>
        // Check if P5.js loaded properly
        window.addEventListener('load', function() {
            if (typeof p5 === 'undefined') {
                console.error('P5.js failed to load from CDN, attempting fallback...');
                
                // Create a new script element for fallback
                const fallbackScript = document.createElement('script');
                fallbackScript.src = 'https://cdn.jsdelivr.net/npm/p5@1.4.0/lib/p5.min.js';
                fallbackScript.onload = function() {
                    console.log('P5.js loaded from fallback CDN');
                    if (window.initializeGame) {
                        window.initializeGame();
                    }
                };
                fallbackScript.onerror = function() {
                    console.error('Failed to load P5.js from fallback CDN');
                    alert('Failed to load required graphics library. Please check your internet connection and reload the page.');
                };
                
                // Add fallback script to document
                document.body.appendChild(fallbackScript);
            }
        });
    </script>

    <script>
        // Debug flag - set to true during development
        const DEBUG = true;

        // Enhanced logging function
        function debugLog(message, data) {
            if (!DEBUG) return;
            
            if (data !== undefined) {
                console.log(`%c[MathQuest Debug] ${message}`, 'color: #6a11cb; font-weight: bold;', data);
            } else {
                console.log(`%c[MathQuest Debug] ${message}`, 'color: #6a11cb; font-weight: bold;');
            }
        }

        // Function to check if canvas is properly created
        function checkCanvas() {
            const canvas = document.querySelector('canvas');
            if (!canvas) {
                debugLog('ERROR: Canvas element not found!');
                return false;
            }
            
            const width = canvas.width;
            const height = canvas.height;
            
            if (width <= 0 || height <= 0) {
                debugLog('ERROR: Canvas has invalid dimensions', { width, height });
                return false;
            }
            
            debugLog('Canvas check passed', { width, height });
            return true;
        }

        // Function to check game state validity
        function checkGameState() {
            if (!gameState) {
                debugLog('ERROR: gameState is undefined!');
                return false;
            }
            
            debugLog('Current game state', {
                mode: gameState.mode,
                areaParams: { ...gameState.areaParams },
                slopeParams: { ...gameState.slopeParams }
            });
            
            return true;
        }

        // Function to check if all required DOM elements exist
        function checkElements() {
            const requiredElements = [
                'game-canvas',
                'side-panel',
                'area-controls',
                'slope-controls',
                'loading-screen'
            ];
            
            const missingElements = [];
            
            requiredElements.forEach(id => {
                if (!document.getElementById(id)) {
                    missingElements.push(id);
                }
            });
            
            if (missingElements.length > 0) {
                debugLog('ERROR: Missing required DOM elements', missingElements);
                return false;
            }
            
            debugLog('All required DOM elements found');
            return true;
        }

        // Function to validate P5.js is loaded correctly
        function checkP5() {
            if (typeof p5 === 'undefined') {
                debugLog('ERROR: P5.js library not loaded!');
                return false;
            }
            
            if (!window.p5Instance) {
                debugLog('WARNING: P5 instance not created yet');
            } else {
                debugLog('P5 instance exists');
            }
            
            return typeof p5 !== 'undefined';
        }

        // Run all checks at once
        function runDiagnostics() {
            debugLog('Running diagnostics...');
            const results = {
                elementsOK: checkElements(),
                p5OK: checkP5(),
                canvasOK: checkCanvas(),
                gameStateOK: checkGameState()
            };
            
            const allPassed = Object.values(results).every(result => result === true);
            
            if (allPassed) {
                debugLog('All diagnostics passed! ✅');
            } else {
                debugLog('Some diagnostics failed! ❌', results);
            }
            
            return results;
        }

        /******************************************
         * GAME DATA AND STATE
         ******************************************/
        const gameState = {
            mode: 'menu', // 'menu', 'area', 'slope', 'challenge', 'badges', 'adventure'
            currentLevel: 1,
            unlockedLevels: [1],
            completedLevels: [],
            stars: 0,
            badges: {
                explorer: false,
                detective: false,
                master: false,
                creative: false,
                quick: false
            },
            playerLevel: 1,
            playerXP: 0,
            areaParams: {
                shapeCount: 10,
                functionType: 'linear',
                m: 1,
                b: 0,
                a: 0.5
            },
            slopeParams: {
                x: 0.5,
                functionType: 'linear',
                m: 1,
                b: 0,
                a: 0.5
            },
            challengeState: {
                currentChallenge: null,
                currentStep: 0,
                totalSteps: 0,
                score: 0,
                startTime: 0,
                selectedOption: null
            },
            showingConfetti: false,
            panelMinimized: false,
            tooltipVisible: false,
            soundEnabled: true,
            currentSubmenu: null,
            loadingComplete: false,
            audioInitialized: false
        };

        // Simple audio context for sound effects
        let audioContext;
        
        // Quiz/challenge questions
        const challenges = {
            'area-basics': {
                title: 'Area Basics',
                description: 'Learn how integrals help us calculate the area under curves!',
                steps: [
                    {
                        type: 'tutorial',
                        title: 'Welcome to Area Explorer!',
                        content: 'In this challenge, you\'ll learn how mathematicians use integrals to find the area under curves. An integral is like adding up lots of tiny shapes to get the total area!'
                    },
                    {
                        type: 'interactive',
                        title: 'Rectangle Method',
                        task: 'Adjust the number of rectangles to at least 20 to see how more rectangles give a better approximation of the area.',
                        checkCondition: () => gameState.areaParams.shapeCount >= 20,
                        hint: 'Use the "Number of Rectangles" slider to increase the number of rectangles.'
                    },
                    {
                        type: 'interactive',
                        title: 'Changing Functions',
                        task: 'Change the function to a quadratic function (y = ax² + b) and observe how the area changes.',
                        checkCondition: () => gameState.areaParams.functionType === 'quadratic',
                        hint: 'Use the "Function Type" dropdown to select the quadratic function.'
                    },
                    {
                        type: 'quiz',
                        question: 'What happens to our area calculation as we increase the number of rectangles?',
                        options: [
                            'It gets less accurate',
                            'It stays exactly the same',
                            'It gets more accurate',
                            'It always equals zero'
                        ],
                        correctIndex: 2,
                        explanation: 'More rectangles means a more accurate area calculation because the rectangles follow the curve more closely.'
                    },
                    {
                        type: 'quiz',
                        question: 'The integral of a function f(x) represents:',
                        options: [
                            'The slope of the function',
                            'The area under the curve of the function',
                            'The height of the function',
                            'The color of the function'
                        ],
                        correctIndex: 1,
                        explanation: 'An integral helps us find the area under a curve. Think of it as counting up all the tiny rectangles that fit under the curve!'
                    },
                    {
                        type: 'success',
                        title: 'Challenge Complete!',
                        content: 'Great job! You\'ve learned how integrals help us find the area under curves. The more rectangles we use, the more accurate our calculation becomes. In calculus, we use an infinite number of infinitely thin rectangles to get the exact area!'
                    }
                ]
            },
            'slope-basics': {
                title: 'Slope Detective',
                description: 'Discover how derivatives help us find the slope of curves at any point!',
                steps: [
                    {
                        type: 'tutorial',
                        title: 'Welcome to Slope Detective!',
                        content: 'In this challenge, you\'ll learn how mathematicians use derivatives to find the slope of curves at any point. A derivative tells us how quickly a function is changing!'
                    },
                    {
                        type: 'interactive',
                        title: 'Moving the Point',
                        task: 'Move the point along the curve to see how the slope changes at different positions.',
                        checkCondition: () => true, // Auto-complete after viewing
                        hint: 'Use the "Point Position" slider to move the point along the curve.'
                    },
                    {
                        type: 'interactive',
                        title: 'Different Functions',
                        task: 'Change the function to a quadratic function (y = ax² + b) and observe how the slope changes as you move the point.',
                        checkCondition: () => gameState.slopeParams.functionType === 'quadratic',
                        hint: 'Use the "Function" dropdown to select the quadratic function.'
                    },
                    {
                        type: 'quiz',
                        question: 'At what point does a quadratic function (y = x²) have a slope of 0?',
                        options: [
                            'x = 1',
                            'x = 0',
                            'x = -1',
                            'There is no such point'
                        ],
                        correctIndex: 1,
                        explanation: 'The derivative of y = x² is 2x, which equals 0 when x = 0. This is the lowest point of the parabola where the tangent line is horizontal.'
                    },
                    {
                        type: 'quiz',
                        question: 'The derivative of a function f(x) represents:',
                        options: [
                            'The area under the function',
                            'The slope (rate of change) of the function at a point',
                            'The total value of the function',
                            'The average of the function'
                        ],
                        correctIndex: 1,
                        explanation: 'The derivative tells us the slope (or rate of change) of a function at any point. It\'s like measuring how steep a hill is at different spots!'
                    },
                    {
                        type: 'success',
                        title: 'Challenge Complete!',
                        content: 'Excellent work! You\'ve learned how derivatives help us find the slope of curves at any point. The derivative of a function tells us how quickly the function is changing, which is incredibly useful in physics, economics, and many other fields!'
                    }
                ]
            },
            'function-factory': {
                title: 'Function Factory',
                description: 'Create your own functions and explore their properties!',
                steps: [
                    {
                        type: 'tutorial',
                        title: 'Welcome to Function Factory!',
                        content: 'In this challenge, you\'ll create your own functions and explore how changing their parameters affects their shape, area, and slope.'
                    },
                    {
                        type: 'interactive',
                        title: 'Linear Functions',
                        task: 'Create a linear function with a slope of 2 and a y-intercept of 1.',
                        checkCondition: () => gameState.areaParams.functionType === 'linear' && 
                                              Math.abs(gameState.areaParams.m - 2) < 0.1 && 
                                              Math.abs(gameState.areaParams.b - 1) < 0.1,
                        hint: 'Set the Function Type to linear, then adjust the Slope (m) to 2 and y-intercept (b) to 1.'
                    },
                    {
                        type: 'interactive',
                        title: 'Quadratic Functions',
                        task: 'Create a quadratic function with a coefficient of -0.5.',
                        checkCondition: () => gameState.areaParams.functionType === 'quadratic' && 
                                              Math.abs(gameState.areaParams.a + 0.5) < 0.1,
                        hint: 'Set the Function Type to quadratic, then adjust the Coefficient (a) to -0.5.'
                    },
                    {
                        type: 'quiz',
                        question: 'What happens to the parabola when the coefficient (a) is negative?',
                        options: [
                            'It opens upward',
                            'It opens downward',
                            'It becomes a straight line',
                            'It disappears'
                        ],
                        correctIndex: 1,
                        explanation: 'When the coefficient (a) is negative, the parabola opens downward instead of upward.'
                    },
                    {
                        type: 'interactive',
                        title: 'Sine Functions',
                        task: 'Switch to a sine function and observe its derivative as you move the point.',
                        checkCondition: () => gameState.slopeParams.functionType === 'sine',
                        hint: 'Go to Slope Detective mode and set the Function Type to sine.'
                    },
                    {
                        type: 'quiz',
                        question: 'What is the derivative of sin(x)?',
                        options: [
                            'cos(x)',
                            '-sin(x)',
                            'tan(x)',
                            '1/sin(x)'
                        ],
                        correctIndex: 0,
                        explanation: 'The derivative of sin(x) is cos(x). This is why when you move the point on a sine curve, the slope follows a cosine pattern!'
                    },
                    {
                        type: 'success',
                        title: 'Challenge Complete!',
                        content: 'Amazing job! You\'ve created various functions and explored their derivatives and integrals. Understanding how changing parameters affects functions is a crucial skill in calculus and many real-world applications!'
                    }
                ]
            },
            'integral-quiz': {
                title: 'Integral Quiz',
                description: 'Test your knowledge about integrals and area calculations!',
                steps: [
                    {
                        type: 'tutorial',
                        title: 'Integral Quiz Challenge',
                        content: 'Let\'s test your knowledge about integrals and area calculations! Answer the following questions to show what you\'ve learned.'
                    },
                    {
                        type: 'quiz',
                        question: 'What does ∫f(x)dx represent?',
                        options: [
                            'The derivative of f(x)',
                            'The area under the curve of f(x)',
                            'The slope of f(x)',
                            'The value of f(x)'
                        ],
                        correctIndex: 1,
                        explanation: 'The integral ∫f(x)dx represents the area under the curve of the function f(x).'
                    },
                    {
                        type: 'quiz',
                        question: 'If f(x) = 4, what is ∫f(x)dx?',
                        options: [
                            '4x + C',
                            '4',
                            '0',
                            '4/x + C'
                        ],
                        correctIndex: 0,
                        explanation: 'When integrating a constant like 4, we get 4x + C, where C is the constant of integration. This is because the derivative of 4x + C is 4.'
                    },
                    {
                        type: 'quiz',
                        question: 'What is the integral of x²?',
                        options: [
                            'x³/3 + C',
                            '2x + C',
                            '2x³ + C',
                            'x³ + C'
                        ],
                        correctIndex: 0,
                        explanation: 'The integral of x² is x³/3 + C. The power rule for integration says we add 1 to the exponent and divide by the new exponent: ∫x^n dx = x^(n+1)/(n+1) + C.'
                    },
                    {
                        type: 'quiz',
                        question: 'Which method provides an exact area under a linear function?',
                        options: [
                            'Using 10 rectangles',
                            'Using 100 rectangles',
                            'Using trapezoids',
                            'Using circles'
                        ],
                        correctIndex: 2,
                        explanation: 'Trapezoids calculate the area under a linear function exactly! This is because they perfectly match the slant of the line.'
                    },
                    {
                        type: 'quiz',
                        question: 'What is the relationship between derivatives and integrals?',
                        options: [
                            'They are unrelated concepts',
                            'They are the same thing',
                            'Integrals are the opposite of derivatives',
                            'Derivatives are always bigger than integrals'
                        ],
                        correctIndex: 2,
                        explanation: 'Integrals and derivatives are opposite operations - they undo each other! This is known as the Fundamental Theorem of Calculus.'
                    },
                    {
                        type: 'success',
                        title: 'Quiz Complete!',
                        content: 'Outstanding! You\'ve demonstrated a solid understanding of integrals and area calculations. These concepts are fundamental to calculus and have countless applications in science, engineering, and economics!'
                    }
                ]
            }
        };

        // Adventure levels
        const adventureLevels = [
            {
                id: 1,
                title: 'The Beginning',
                description: 'Start your calculus adventure by learning about areas under curves!',
                challenge: 'area-basics'
            },
            {
                id: 2,
                title: 'Slope Mountain',
                description: 'Climb the mountain of derivatives and discover the power of slopes!',
                challenge: 'slope-basics'
            },
            {
                id: 3,
                title: 'Function Forest',
                description: 'Navigate through the forest of functions and learn to create your own!',
                challenge: 'function-factory'
            },
            {
                id: 4,
                title: 'Integration Island',
                description: 'Explore the mysterious island of integrals and master area calculations!',
                challenge: 'integral-quiz'
            },
            {
                id: 5,
                title: 'Calculus Castle',
                description: 'Reach the final castle and prove your mastery of calculus!',
                challenge: 'final-challenge'
            }
        ];

        // Character speeches for different modes and interactions
        const characterSpeeches = {
            welcome: "Hi there! I'm Professor X, your calculus guide! Choose a mode from the navigation bar to start exploring the exciting world of calculus!",
            areaMode: "Welcome to Area Explorer! Here, we'll discover how integrals help us find the area under curves. Try changing the number of rectangles with the slider to see how our approximation gets better!",
            slopeMode: "Welcome to Slope Detective! Here, we'll investigate how derivatives give us the slope of a curve at any point. Move the point along the curve to see how the slope changes!",
            challengeMode: "Ready for a challenge? Select one of our exciting challenges to test your understanding of calculus concepts!",
            badgeMode: "Here are all the badges you can earn on your calculus adventure! Complete challenges and learn new concepts to collect them all!",
            manyRectangles: "Wow! With so many rectangles, our area calculation is getting super accurate! This is exactly how calculus works - with infinitely many, infinitely thin rectangles!",
            fewRectangles: "With just a few rectangles, we get a rough estimate of the area. Adding more rectangles makes our calculation more precise!",
            steepSlope: "Look at that steep slope! The derivative (slope) has a large value when the curve changes quickly. Think about a roller coaster's steepest part!",
            flatSlope: "The slope is almost flat here! When the derivative (slope) is close to zero, the curve barely changes - like a small hill on a hiking trail!",
            correctAnswer: "Amazing! That's correct! You're understanding calculus concepts like a young genius!",
            wrongAnswer: "Not quite, but that's okay! Learning math is about trying different ideas. Let's look at why this answer works.",
            challengeComplete: "Incredible! You've completed the challenge. You're really understanding these advanced calculus concepts!",
            functionChange: "You've changed the function! Notice how the shape, area, and slope all change too. This is why mathematicians study different types of functions!",
            adventure: "Welcome to your calculus adventure! Journey through different levels, solve challenges, and become a calculus master!",
            levelComplete: "Level complete! You're making fantastic progress on your calculus journey!",
            newBadge: "Congratulations! You've earned a new badge for your accomplishments!",
            tip: "Pro tip: Try experimenting with different functions and parameters to see how they affect the area and slope!"
        };

        // DOM Elements
        let elements = {};
        
        // Add this to your document ready function
        document.addEventListener('DOMContentLoaded', () => {
            // Run initial diagnostics after a slight delay to let things initialize
            setTimeout(runDiagnostics, 2000);
            
            // Add a global diagnostics command for the console
            window.diagnose = runDiagnostics;
            debugLog('Debugging initialized. Type "diagnose()" in console to run diagnostics.');
        });

        // Add error tracking for redraw calls
        window.redraw = function() {
            try {
                debugLog('Redraw called');
                if (window.p5Instance && window.p5Instance.redraw) {
                    window.p5Instance.redraw();
                } else if (typeof draw === 'function') {
                    draw();
                } else {
                    throw new Error('No redraw method available');
                }
            } catch (error) {
                debugLog('ERROR in redraw', error);
                console.error(error);
            }
        };

        /******************************************
         * GAME INITIALIZATION
         ******************************************/
        document.addEventListener('DOMContentLoaded', () => {
            // Get DOM elements
            getElements();
            
            // Add event listeners
            setupEventListeners();
            
            // Draw character
            drawCharacter();
            
            // Try to initialize P5 instance before showing welcome (P5 is loaded from CDN)
            if (typeof p5 !== 'undefined') {
                // P5 is already loaded, initialize immediately
                setTimeout(initializeGame, 1000);
                
                // Show welcome modal after initialization
                setTimeout(() => {
                    showModal('Welcome to MathQuest!', 
                            'Embark on an exciting adventure through the world of calculus! You\'ll explore areas under curves with integrals, investigate slopes with derivatives, and solve challenging puzzles along the way.', 
                            'Let\'s Go!');
                }, 1500);
            } else {
                // P5 isn't loaded yet, wait a bit longer
                console.warn("P5.js library not loaded yet, waiting...");
                let checkCount = 0;
                
                const checkInterval = setInterval(() => {
                    checkCount++;
                    if (typeof p5 !== 'undefined') {
                        clearInterval(checkInterval);
                        console.log("P5.js library loaded successfully!");
                        initializeGame();
                        
                        // Show welcome modal
                        showModal('Welcome to MathQuest!', 
                                'Embark on an exciting adventure through the world of calculus! You\'ll explore areas under curves with integrals, investigate slopes with derivatives, and solve challenging puzzles along the way.', 
                                'Let\'s Go!');
                    } else if (checkCount > 10) {
                        // After 10 attempts (5 seconds), show error
                        clearInterval(checkInterval);
                        console.error("Failed to load P5.js library!");
                        alert("Failed to load required graphics library. Please check your internet connection and reload the page.");
                    }
                }, 500);
            }
            
            // Initialize audio on first user interaction
            document.body.addEventListener('click', initAudio, { once: true });
        });

        function initializeGame() {
            // Ensure loading screen is properly hidden
            document.getElementById('loading-screen').classList.add('hide');
            gameState.loadingComplete = true;
            
            // Force a redraw to make sure graphs appear
            if (window.redraw) {
                window.redraw();
            }
            
            // Make sure side panel displays correctly for current mode
            switchMode(gameState.mode);
        }

        function initAudio() {
            // Only initialize once
            if (gameState.audioInitialized) return;
            
            try {
                // Create audio context
                window.AudioContext = window.AudioContext || window.webkitAudioContext;
                audioContext = new AudioContext();
                gameState.audioInitialized = true;
            } catch (e) {
                console.warn('Web Audio API not supported in this browser');
                gameState.soundEnabled = false;
            }
        }

        function getElements() {
            elements = {
                // Main containers
                gameCanvas: document.getElementById('game-canvas'),
                sidePanel: document.getElementById('side-panel'),
                characterSpeech: document.getElementById('character-speech'),
                professorX: document.getElementById('professor-x'),
                menuContainer: document.getElementById('menu-container'),
                gameLevels: document.getElementById('game-levels'),
                challengeContainer: document.getElementById('challenge-container'),
                
                // Navigation buttons
                menuButton: document.getElementById('menu-button'),
                areaButton: document.getElementById('area-button'),
                slopeButton: document.getElementById('slope-button'),
                challengeButton: document.getElementById('challenge-button'),
                badgeButton: document.getElementById('badge-button'),
                
                // Area controls
                areaControls: document.getElementById('area-controls'),
                shapeCount: document.getElementById('shape-count'),
                shapeCountValue: document.getElementById('shape-count-value'),
                functionType: document.getElementById('function-type'),
                mParam: document.getElementById('m-param'),
                mParamValue: document.getElementById('m-param-value'),
                bParam: document.getElementById('b-param'),
                bParamValue: document.getElementById('b-param-value'),
                aParam: document.getElementById('a-param'),
                aParamValue: document.getElementById('a-param-value'),
                aParamContainer: document.getElementById('a-param-container'),
                mParamContainer: document.getElementById('m-param-container'),
                bParamContainer: document.getElementById('b-param-container'),
                
                // Slope controls
                slopeControls: document.getElementById('slope-controls'),
                pointX: document.getElementById('point-x'),
                pointXValue: document.getElementById('point-x-value'),
                derivativeFunction: document.getElementById('derivative-function'),
                slopeMParam: document.getElementById('slope-m-param'),
                slopeMParamValue: document.getElementById('slope-m-param-value'),
                slopeBParam: document.getElementById('slope-b-param'),
                slopeBParamValue: document.getElementById('slope-b-param-value'),
                slopeAParam: document.getElementById('slope-a-param'),
                slopeAParamValue: document.getElementById('slope-a-param-value'),
                slopeAParamContainer: document.getElementById('slope-a-param-container'),
                slopeMParamContainer: document.getElementById('slope-m-param-container'),
                slopeBParamContainer: document.getElementById('slope-b-param-container'),
                
                // Challenge controls
                challengeControls: document.getElementById('challenge-controls'),
                challengeDescription: document.getElementById('challenge-description'),
                challengeProgress: document.getElementById('challenge-progress'),
                challengeScore: document.getElementById('challenge-score'),
                challengeTotal: document.getElementById('challenge-total'),
                
                // Badge controls
                badgeControls: document.getElementById('badge-controls'),
                explorerBadge: document.getElementById('explorer-badge'),
                detectiveBadge: document.getElementById('detective-badge'),
                masterBadge: document.getElementById('master-badge'),
                creativeBadge: document.getElementById('creative-badge'),
                quickBadge: document.getElementById('quick-badge'),
                overallProgress: document.getElementById('overall-progress'),
                playerLevel: document.getElementById('player-level'),
                
                // Modal
                modal: document.getElementById('modal'),
                modalTitle: document.getElementById('modal-title'),
                modalText: document.getElementById('modal-text'),
                modalClose: document.getElementById('modal-close'),
                modalQuizContainer: document.getElementById('modal-quiz-container'),
                
                // Menu buttons
                startAdventure: document.getElementById('start-adventure'),
                freePlay: document.getElementById('free-play'),
                miniGames: document.getElementById('mini-games'),
                backToMenu: document.getElementById('back-to-menu'),
                backFromChallenges: document.getElementById('back-from-challenges'),
                
                // Level completion
                levelCompletion: document.getElementById('level-completion'),
                nextLevel: document.getElementById('next-level'),
                replayLevel: document.getElementById('replay-level'),
                
                // Other controls
                togglePanel: document.getElementById('toggle-panel'),
                mapNodes: document.querySelectorAll('.map-node'),
                challengeCards: document.querySelectorAll('.challenge-card'),
                tooltip: document.getElementById('tooltip'),
                confettiContainer: document.getElementById('confetti-container')
            };
        }

        function setupEventListeners() {
            // Navigation buttons
            elements.menuButton.addEventListener('click', () => switchMode('menu'));
            elements.areaButton.addEventListener('click', () => switchMode('area'));
            elements.slopeButton.addEventListener('click', () => switchMode('slope'));
            elements.challengeButton.addEventListener('click', () => switchMode('challenge'));
            elements.badgeButton.addEventListener('click', () => switchMode('badges'));
            
            // Area controls
            elements.shapeCount.addEventListener('input', () => {
                const value = elements.shapeCount.value;
                elements.shapeCountValue.textContent = value;
                gameState.areaParams.shapeCount = parseInt(value);
                
                if (value > 30) {
                    updateCharacterSpeech(characterSpeeches.manyRectangles);
                } else if (value < 10) {
                    updateCharacterSpeech(characterSpeeches.fewRectangles);
                }
                
                playSound('slider');
                redraw(); // Redraw the canvas
                
                // Check for challenge completion
                if (gameState.mode === 'challenge' && gameState.challengeState.currentChallenge) {
                    checkChallengeStep();
                }
            });
            
            elements.functionType.addEventListener('change', () => {
                gameState.areaParams.functionType = elements.functionType.value;
                updateFunctionParamDisplays();
                updateCharacterSpeech(characterSpeeches.functionChange);
                playSound('select');
                redraw(); // Redraw the canvas
                
                // Check for challenge completion
                if (gameState.mode === 'challenge' && gameState.challengeState.currentChallenge) {
                    checkChallengeStep();
                }
            });
            
            elements.mParam.addEventListener('input', () => {
                const value = elements.mParam.value;
                elements.mParamValue.textContent = value;
                gameState.areaParams.m = parseFloat(value);
                playSound('slider');
                redraw(); // Redraw the canvas
                
                // Check for challenge completion
                if (gameState.mode === 'challenge' && gameState.challengeState.currentChallenge) {
                    checkChallengeStep();
                }
            });
            
            elements.bParam.addEventListener('input', () => {
                const value = elements.bParam.value;
                elements.bParamValue.textContent = value;
                gameState.areaParams.b = parseFloat(value);
                playSound('slider');
                redraw(); // Redraw the canvas
                
                // Check for challenge completion
                if (gameState.mode === 'challenge' && gameState.challengeState.currentChallenge) {
                    checkChallengeStep();
                }
            });
            
            elements.aParam.addEventListener('input', () => {
                const value = elements.aParam.value;
                elements.aParamValue.textContent = value;
                gameState.areaParams.a = parseFloat(value);
                playSound('slider');
                redraw(); // Redraw the canvas
                
                // Check for challenge completion
                if (gameState.mode === 'challenge' && gameState.challengeState.currentChallenge) {
                    checkChallengeStep();
                }
            });
            
            // Slope controls
            elements.pointX.addEventListener('input', () => {
                const value = elements.pointX.value;
                elements.pointXValue.textContent = value;
                gameState.slopeParams.x = parseFloat(value);
                
                // Calculate the derivative at this point for speech updates
                const x = map(parseFloat(value), 0, 1, -5, 5);
                
                let derivative;
                if (gameState.slopeParams.functionType === 'linear') {
                    derivative = gameState.slopeParams.m;
                } else if (gameState.slopeParams.functionType === 'quadratic') {
                    derivative = 2 * gameState.slopeParams.a * x;
                } else if (gameState.slopeParams.functionType === 'cubic') {
                    derivative = 3 * gameState.slopeParams.a * x * x;
                } else if (gameState.slopeParams.functionType === 'sine') {
                    derivative = Math.cos(x) * 2;
                } else if (gameState.slopeParams.functionType === 'exponential') {
                    derivative = Math.exp(x / 2) * 0.5;
                }
                
                // Update character speech based on slope
                if (Math.abs(derivative) > 2) {
                    updateCharacterSpeech(characterSpeeches.steepSlope);
                } else if (Math.abs(derivative) < 0.5) {
                    updateCharacterSpeech(characterSpeeches.flatSlope);
                }
                
                playSound('slider');
                redraw(); // Redraw the canvas
                
                // Check for challenge completion
                if (gameState.mode === 'challenge' && gameState.challengeState.currentChallenge) {
                    checkChallengeStep();
                }
            });
            
            elements.derivativeFunction.addEventListener('change', () => {
                gameState.slopeParams.functionType = elements.derivativeFunction.value;
                updateDerivativeFunctionParamDisplays();
                updateCharacterSpeech(characterSpeeches.functionChange);
                playSound('select');
                redraw(); // Redraw the canvas
                
                // Check for challenge completion
                if (gameState.mode === 'challenge' && gameState.challengeState.currentChallenge) {
                    checkChallengeStep();
                }
            });
            
            elements.slopeMParam.addEventListener('input', () => {
                const value = elements.slopeMParam.value;
                elements.slopeMParamValue.textContent = value;
                gameState.slopeParams.m = parseFloat(value);
                playSound('slider');
                redraw(); // Redraw the canvas
                
                // Check for challenge completion
                if (gameState.mode === 'challenge' && gameState.challengeState.currentChallenge) {
                    checkChallengeStep();
                }
            });
            
            elements.slopeBParam.addEventListener('input', () => {
                const value = elements.slopeBParam.value;
                elements.slopeBParamValue.textContent = value;
                gameState.slopeParams.b = parseFloat(value);
                playSound('slider');
                redraw(); // Redraw the canvas
                
                // Check for challenge completion
                if (gameState.mode === 'challenge' && gameState.challengeState.currentChallenge) {
                    checkChallengeStep();
                }
            });
            
            elements.slopeAParam.addEventListener('input', () => {
                const value = elements.slopeAParam.value;
                elements.slopeAParamValue.textContent = value;
                gameState.slopeParams.a = parseFloat(value);
                playSound('slider');
                redraw(); // Redraw the canvas
                
                // Check for challenge completion
                if (gameState.mode === 'challenge' && gameState.challengeState.currentChallenge) {
                    checkChallengeStep();
                }
            });
            
            // Menu buttons
            elements.startAdventure.addEventListener('click', () => {
                gameState.currentSubmenu = 'adventure';
                elements.menuContainer.style.background = 'linear-gradient(135deg, #4b6cb7, #182848)';
                elements.gameLevels.style.display = 'block';
                elements.challengeContainer.style.display = 'none';
                playSound('click');
            });
            
            elements.freePlay.addEventListener('click', () => {
                elements.menuContainer.style.display = 'none';
                switchMode('area');
                playSound('click');
            });
            
            elements.miniGames.addEventListener('click', () => {
                gameState.currentSubmenu = 'challenges';
                elements.menuContainer.style.background = 'linear-gradient(135deg, #834d9b, #d04ed6)';
                elements.gameLevels.style.display = 'none';
                elements.challengeContainer.style.display = 'flex';
                playSound('click');
            });
            
            elements.backToMenu.addEventListener('click', () => {
                gameState.currentSubmenu = null;
                elements.menuContainer.style.background = 'linear-gradient(135deg, #c33764, #1d2671)';
                elements.gameLevels.style.display = 'none';
                playSound('click');
            });
            
            elements.backFromChallenges.addEventListener('click', () => {
                gameState.currentSubmenu = null;
                elements.menuContainer.style.background = 'linear-gradient(135deg, #c33764, #1d2671)';
                elements.challengeContainer.style.display = 'none';
                playSound('click');
            });
            
            // Level nodes
            elements.mapNodes.forEach(node => {
                node.addEventListener('click', () => {
                    const level = parseInt(node.dataset.level);
                    if (gameState.unlockedLevels.includes(level)) {
                        startLevel(level);
                        playSound('click');
                    } else {
                        playSound('error');
                        showTooltip(node, 'This level is locked! Complete the previous levels first.');
                    }
                });
                
                // Add hover sound
                node.addEventListener('mouseenter', () => {
                    if (gameState.unlockedLevels.includes(parseInt(node.dataset.level))) {
                        playSound('hover');
                    }
                });
            });
            
            // Challenge cards
            elements.challengeCards.forEach(card => {
                card.addEventListener('click', () => {
                    const challenge = card.dataset.challenge;
                    startChallenge(challenge);
                    elements.menuContainer.style.display = 'none';
                    playSound('click');
                });
                
                // Add hover sound
                card.addEventListener('mouseenter', () => {
                    playSound('hover');
                });
            });
            
            // Modal close button
            elements.modalClose.addEventListener('click', () => {
                if (gameState.mode === 'challenge' && elements.modalQuizContainer.style.display === 'block') {
                    checkChallengeQuizAnswer();
                } else {
                    hideModal();
                }
                playSound('click');
            });
            
            // Level completion buttons
            elements.nextLevel.addEventListener('click', () => {
                elements.levelCompletion.classList.remove('show');
                startLevel(gameState.currentLevel + 1);
                playSound('click');
            });
            
            elements.replayLevel.addEventListener('click', () => {
                elements.levelCompletion.classList.remove('show');
                startLevel(gameState.currentLevel);
                playSound('click');
            });
            
            // Toggle panel button
            elements.togglePanel.addEventListener('click', () => {
                togglePanel();
                playSound('click');
            });
            
            // Character interaction
            elements.professorX.addEventListener('click', () => {
                makeCharacterJump();
                showRandomTip();
                playSound('character');
            });
            
            // Add hover sound to all buttons
            const buttons = document.querySelectorAll('button');
            buttons.forEach(button => {
                button.addEventListener('mouseenter', () => {
                    playSound('hover');
                });
            });
        }

        function drawCharacter() {
            const characterEl = elements.professorX;
            
            // Create a more engaging character using CSS
            characterEl.innerHTML = `
                <div style="position: absolute; width: 100%; height: 100%; border-radius: 50% 50% 20% 20%; background: linear-gradient(135deg, #6a11cb, #2575fc); overflow: hidden;">
                    <div style="position: absolute; width: 30px; height: 30px; background: white; border-radius: 50%; top: 20px; left: 15px; border: 3px solid #333; overflow: hidden;">
                        <div style="position: absolute; width: 15px; height: 15px; background: #333; border-radius: 50%; top: 5px; left: 5px;"></div>
                    </div>
                    <div style="position: absolute; width: 30px; height: 30px; background: white; border-radius: 50%; top: 20px; right: 15px; border: 3px solid #333; overflow: hidden;">
                        <div style="position: absolute; width: 15px; height: 15px; background: #333; border-radius: 50%; top: 5px; left: 5px;"></div>
                    </div>
                    <div style="position: absolute; width: 40px; height: 15px; background: white; border-radius: 10px; bottom: 25px; left: 30px;">
                        <div style="position: absolute; width: 30px; height: 5px; background: #ff6b6b; border-radius: 5px; bottom: 5px; left: 5px;"></div>
                    </div>
                    <div style="position: absolute; width: 60px; height: 15px; border-radius: 50%; border-top: 5px solid #333; top: 10px; left: 20px; border-left: none; border-right: none; border-bottom: none;"></div>
                </div>
            `;
        }

        /******************************************
         * GAME MODES AND NAVIGATION
         ******************************************/
        function switchMode(mode) {
            gameState.mode = mode;
            
            // Reset active button states
            document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
            
            // Hide all control panels
            document.querySelectorAll('.panel-section').forEach(panel => panel.classList.remove('active'));
            
            // Handle mode-specific setup
            if (mode === 'menu') {
                elements.menuContainer.style.display = 'flex';
                elements.menuButton.classList.add('active');
                updateCharacterSpeech(characterSpeeches.welcome);
            } else {
                elements.menuContainer.style.display = 'none';
                
                if (mode === 'area') {
                    elements.areaControls.classList.add('active');
                    elements.areaButton.classList.add('active');
                    updateCharacterSpeech(characterSpeeches.areaMode);
                    
                    // Adjust parameter display based on function type
                    updateFunctionParamDisplays();
                } else if (mode === 'slope') {
                    elements.slopeControls.classList.add('active');
                    elements.slopeButton.classList.add('active');
                    updateCharacterSpeech(characterSpeeches.slopeMode);
                    
                    // Adjust parameter display based on function type
                    updateDerivativeFunctionParamDisplays();
                } else if (mode === 'challenge') {
                    elements.challengeControls.classList.add('active');
                    elements.challengeButton.classList.add('active');
                    updateCharacterSpeech(characterSpeeches.challengeMode);
                    
                    // If no challenge is active, show modal with challenge options
                    if (!gameState.challengeState.currentChallenge) {
                        showModal('Choose a Challenge', 
                                 'Select a challenge to test your knowledge and earn badges!',
                                 'Back to Menu');
                        
                        elements.modalClose.onclick = () => {
                            hideModal();
                            switchMode('menu');
                        };
                    }
                } else if (mode === 'badges') {
                    elements.badgeControls.classList.add('active');
                    elements.badgeButton.classList.add('active');
                    updateCharacterSpeech(characterSpeeches.badgeMode);
                    
                    // Update badge display
                    updateBadgeDisplay();
                }
            }
            
            playSound('mode');
            
            // Redraw canvas with the new mode
            redraw();
        }

        function updateFunctionParamDisplays() {
            const functionType = elements.functionType.value;
            
            // Hide all parameter containers first
            elements.mParamContainer.style.display = 'none';
            elements.bParamContainer.style.display = 'none';
            elements.aParamContainer.style.display = 'none';
            
            if (functionType === 'linear') {
                elements.mParamContainer.style.display = 'block';
                elements.bParamContainer.style.display = 'block';
            } else if (functionType === 'quadratic' || functionType === 'cubic') {
                elements.aParamContainer.style.display = 'block';
                elements.bParamContainer.style.display = 'block';
            } else if (functionType === 'sine') {
                elements.bParamContainer.style.display = 'block';
            } else if (functionType === 'exponential') {
                elements.bParamContainer.style.display = 'block';
            }
        }

        function updateDerivativeFunctionParamDisplays() {
            const functionType = elements.derivativeFunction.value;
            
            // Hide all parameter containers first
            elements.slopeMParamContainer.style.display = 'none';
            elements.slopeBParamContainer.style.display = 'none';
            elements.slopeAParamContainer.style.display = 'none';
            
            if (functionType === 'linear') {
                elements.slopeMParamContainer.style.display = 'block';
                elements.slopeBParamContainer.style.display = 'block';
            } else if (functionType === 'quadratic' || functionType === 'cubic') {
                elements.slopeAParamContainer.style.display = 'block';
                elements.slopeBParamContainer.style.display = 'block';
            } else if (functionType === 'sine') {
                elements.slopeBParamContainer.style.display = 'block';
            } else if (functionType === 'exponential') {
                elements.slopeBParamContainer.style.display = 'block';
            }
        }

        function updateCharacterSpeech(text) {
            elements.characterSpeech.textContent = text;
            makeCharacterJump();
        }

        function makeCharacterJump() {
            elements.professorX.style.animation = 'bounce 0.5s';
            
            setTimeout(() => {
                elements.professorX.style.animation = '';
            }, 500);
        }

        function showModal(title, text, buttonText = 'Continue', showQuiz = false, questionIndex = null) {
            elements.modalTitle.textContent = title;
            elements.modalText.textContent = text;
            elements.modalClose.textContent = buttonText;
            
            if (showQuiz && questionIndex !== null) {
                // Set up quiz question
                const currentChallenge = challenges[gameState.challengeState.currentChallenge];
                const step = currentChallenge.steps[gameState.challengeState.currentStep];
                
                elements.modalQuizContainer.style.display = 'block';
                elements.modalQuizContainer.innerHTML = `
                    <div class="quiz-question">${step.question}</div>
                    <div class="quiz-options">
                        ${step.options.map((option, index) => `
                            <div class="quiz-option" data-index="${index}">${option}</div>
                        `).join('')}
                    </div>
                `;
                
                // Add event listeners to quiz options
                const optionElements = elements.modalQuizContainer.querySelectorAll('.quiz-option');
                optionElements.forEach(option => {
                    option.addEventListener('click', () => {
                        // Clear previous selections
                        optionElements.forEach(opt => opt.classList.remove('selected'));
                        
                        // Select this option
                        option.classList.add('selected');
                        gameState.challengeState.selectedOption = parseInt(option.dataset.index);
                        
                        playSound('select');
                    });
                    
                    // Add hover sound
                    option.addEventListener('mouseenter', () => {
                        playSound('hover');
                    });
                });
            } else {
                elements.modalQuizContainer.style.display = 'none';
            }
            
            elements.modal.style.display = 'flex';
        }

        function hideModal() {
            elements.modal.classList.add('closing');
            
            setTimeout(() => {
                elements.modal.style.display = 'none';
                elements.modal.classList.remove('closing');
            }, 500);
        }

        function togglePanel() {
            gameState.panelMinimized = !gameState.panelMinimized;
            
            if (gameState.panelMinimized) {
                elements.sidePanel.classList.add('minimized');
                elements.togglePanel.textContent = '≫';
            } else {
                elements.sidePanel.classList.remove('minimized');
                elements.togglePanel.textContent = '≪';
            }
        }

        function showTooltip(element, text) {
            const tooltip = elements.tooltip;
            tooltip.textContent = text;
            
            const rect = element.getBoundingClientRect();
            tooltip.style.left = `${rect.left + rect.width / 2 - 100}px`;
            tooltip.style.top = `${rect.bottom + 10}px`;
            tooltip.style.opacity = '1';
            
            // Hide the tooltip after 2 seconds
            setTimeout(() => {
                tooltip.style.opacity = '0';
            }, 2000);
        }

        function showRandomTip() {
            const tips = [
                "Try adjusting the number of rectangles to see how the area calculation becomes more accurate!",
                "Did you know? The derivative of a function tells you how quickly it's changing at any point.",
                "The integral of a constant c is c*x + C, where C is another constant.",
                "The more rectangles we use, the closer we get to the true area under a curve!",
                "Try different function types to see how their derivatives and integrals behave.",
                "The derivative of sin(x) is cos(x), and the derivative of cos(x) is -sin(x)!",
                "Complete challenges to earn cool badges and unlock new levels!",
                "Click on me anytime for helpful tips and facts about calculus!",
                "The slope of a curve at a point is exactly the same as the derivative at that point.",
                "Calculus is used in physics, engineering, economics, and many other fields!"
            ];
            
            const randomTip = tips[Math.floor(Math.random() * tips.length)];
            updateCharacterSpeech(randomTip);
        }

        /******************************************
         * CHALLENGE AND LEVEL MANAGEMENT
         ******************************************/
        function startChallenge(challengeId) {
            const challenge = challenges[challengeId];
            
            if (!challenge) {
                console.error(`Challenge ${challengeId} not found!`);
                return;
            }
            
            // Reset challenge state
            gameState.challengeState.currentChallenge = challengeId;
            gameState.challengeState.currentStep = 0;
            gameState.challengeState.totalSteps = challenge.steps.length;
            gameState.challengeState.score = 0;
            gameState.challengeState.startTime = Date.now();
            
            // Update UI
            elements.challengeDescription.innerHTML = `<h4>${challenge.title}</h4><p>${challenge.description}</p>`;
            elements.challengeProgress.style.width = '0%';
            elements.challengeScore.textContent = '0';
            elements.challengeTotal.textContent = challenge.steps.length;
            
            // Switch to appropriate mode based on challenge type
            if (challengeId.includes('area')) {
                switchMode('area');
            } else if (challengeId.includes('slope')) {
                switchMode('slope');
            } else {
                switchMode('area'); // Default to area mode
            }
            
            // Show the first step
            showChallengeStep();
        }

        function showChallengeStep() {
            const challenge = challenges[gameState.challengeState.currentChallenge];
            const step = challenge.steps[gameState.challengeState.currentStep];
            
            if (!step) {
                console.error('No step found!');
                return;
            }
            
            // Handle different step types
            if (step.type === 'tutorial') {
                showModal(step.title, step.content, 'Continue');
                elements.modalClose.onclick = () => {
                    hideModal();
                    advanceChallengeStep();
                };
            } else if (step.type === 'interactive') {
                showModal(step.title, step.task, 'I\'ll try it!');
                elements.modalClose.onclick = () => {
                    hideModal();
                    
                    // Update character speech with hint
                    updateCharacterSpeech(step.hint);
                };
            } else if (step.type === 'quiz') {
                showModal(step.title || 'Quiz Question', step.question, 'Submit Answer', true, gameState.challengeState.currentStep);
            } else if (step.type === 'success') {
                showModal(step.title, step.content, 'Awesome!');
                elements.modalClose.onclick = () => {
                    hideModal();
                    completeChallenge();
                };
            }
        }

        function checkChallengeStep() {
            const challenge = challenges[gameState.challengeState.currentChallenge];
            const step = challenge.steps[gameState.challengeState.currentStep];
            
            if (step.type === 'interactive' && step.checkCondition()) {
                playSound('success');
                updateCharacterSpeech(characterSpeeches.correctAnswer);
                
                // Delay before showing completion message
                setTimeout(() => {
                    showConfetti();
                    showModal('Great job!', 'You\'ve completed this task successfully!', 'Continue');
                    elements.modalClose.onclick = () => {
                        hideModal();
                        advanceChallengeStep();
                    };
                }, 1000);
            }
        }

        function showConfetti() {
            gameState.showingConfetti = true;
            
            // Clear any existing confetti
            elements.confettiContainer.innerHTML = '';
            
            // Create and animate confetti particles
            for (let i = 0; i < 100; i++) {
                const confetti = document.createElement('div');
                
                // Random color
                const hue = Math.floor(Math.random() * 360);
                const color = `hsl(${hue}, 90%, 65%)`;
                
                // Random size and shape
                const size = Math.random() * 10 + 5;
                const shape = Math.random() > 0.5 ? '50%' : '0%';
                
                // Style the confetti
                confetti.style.position = 'absolute';
                confetti.style.backgroundColor = color;
                confetti.style.width = `${size}px`;
                confetti.style.height = `${size}px`;
                confetti.style.borderRadius = shape;
                confetti.style.top = '-20px';
                confetti.style.left = `${Math.random() * 100}%`;
                confetti.style.opacity = '1';
                
                // Add to container
                elements.confettiContainer.appendChild(confetti);
                
                // Animate the confetti
                const animationDuration = Math.random() * 3 + 2; // 2-5 seconds
                const finalX = (Math.random() - 0.5) * 100; // -50% to 50% horizontal drift
                const finalRotation = Math.random() * 720 - 360; // -360 to 360 degrees rotation
                
                confetti.animate([
                    { transform: 'translate(0, 0) rotate(0deg)', opacity: 1 },
                    { transform: `translate(${finalX}px, ${window.innerHeight}px) rotate(${finalRotation}deg)`, opacity: 0 }
                ], {
                    duration: animationDuration * 1000,
                    easing: 'cubic-bezier(0, 1, 1, 1)'
                });
                
                // Remove confetti after animation
                setTimeout(() => {
                    confetti.remove();
                }, animationDuration * 1000);
            }
            
            // Play celebration sound
            playSound('win');
            
            // Reset confetti state after animation
            setTimeout(() => {
                gameState.showingConfetti = false;
            }, 5000);
        }

        function checkChallengeQuizAnswer() {
            const challenge = challenges[gameState.challengeState.currentChallenge];
            const step = challenge.steps[gameState.challengeState.currentStep];
            
            if (gameState.challengeState.selectedOption === null) {
                // No answer selected
                playSound('error');
                showTooltip(elements.modalClose, 'Please select an answer first!');
                return;
            }
            
            const isCorrect = gameState.challengeState.selectedOption === step.correctIndex;
            
            // Mark the options as correct/wrong
            const optionElements = elements.modalQuizContainer.querySelectorAll('.quiz-option');
            optionElements.forEach((option, index) => {
                if (index === step.correctIndex) {
                    option.classList.add('correct');
                } else if (index === gameState.challengeState.selectedOption && !isCorrect) {
                    option.classList.add('wrong');
                }
            });
            
            // Update game state
            if (isCorrect) {
                gameState.challengeState.score++;
                elements.challengeScore.textContent = gameState.challengeState.score;
                updateCharacterSpeech(characterSpeeches.correctAnswer);
                playSound('correct');
                showConfetti();
            } else {
                updateCharacterSpeech(characterSpeeches.wrongAnswer);
                playSound('wrong');
            }
            
            // Show explanation
            elements.modalText.textContent = step.explanation;
            elements.modalClose.textContent = 'Next';
            
            // Remove click handlers from options
            optionElements.forEach(option => {
                option.style.pointerEvents = 'none';
            });
            
            // Update progress bar
            const progress = ((gameState.challengeState.currentStep + 1) / gameState.challengeState.totalSteps) * 100;
            elements.challengeProgress.style.width = `${progress}%`;
            
            // Change modal button to go to next step
            elements.modalClose.onclick = () => {
                hideModal();
                advanceChallengeStep();
            };
        }

        function advanceChallengeStep() {
            gameState.challengeState.currentStep++;
            
            if (gameState.challengeState.currentStep < challenges[gameState.challengeState.currentChallenge].steps.length) {
                showChallengeStep();
            } else {
                completeChallenge();
            }
        }

        function completeChallenge() {
            const challenge = challenges[gameState.challengeState.currentChallenge];
            const timeTaken = (Date.now() - gameState.challengeState.startTime) / 1000; // in seconds
            
            // Award stars based on performance
            let stars = 0;
            const percentCorrect = (gameState.challengeState.score / (challenge.steps.filter(step => step.type === 'quiz').length)) * 100;
            
            if (percentCorrect >= 50) stars++;
            if (percentCorrect >= 75) stars++;
            if (percentCorrect === 100) stars++;
            
            // Award badges
            let newBadgesEarned = false;
            
            if (gameState.challengeState.currentChallenge.includes('area') && !gameState.badges.explorer) {
                gameState.badges.explorer = true;
                newBadgesEarned = true;
            }
            
            if (gameState.challengeState.currentChallenge.includes('slope') && !gameState.badges.detective) {
                gameState.badges.detective = true;
                newBadgesEarned = true;
            }
            
            if (percentCorrect === 100 && !gameState.badges.master) {
                gameState.badges.master = true;
                newBadgesEarned = true;
            }
            
            if (timeTaken < 120 && !gameState.badges.quick) { // Less than 2 minutes
                gameState.badges.quick = true;
                newBadgesEarned = true;
            }
            
            // Update adventure mode if applicable
            if (gameState.mode === 'adventure') {
                // Mark level as completed
                if (!gameState.completedLevels.includes(gameState.currentLevel)) {
                    gameState.completedLevels.push(gameState.currentLevel);
                }
                
                // Unlock next level
                if (gameState.currentLevel < 5 && !gameState.unlockedLevels.includes(gameState.currentLevel + 1)) {
                    gameState.unlockedLevels.push(gameState.currentLevel + 1);
                }
                
                // Show level completion message
                elements.levelCompletion.querySelector('h2').textContent = `Level ${gameState.currentLevel} Complete!`;
                elements.levelCompletion.querySelector('p').textContent = `You've mastered ${challenge.title}!`;
                
                // Update stars
                const starElements = elements.levelCompletion.querySelectorAll('.star');
                starElements.forEach((star, index) => {
                    if (index < stars) {
                        star.classList.add('earned');
                    } else {
                        star.classList.remove('earned');
                    }
                });
                
                // Show level completion modal
                elements.levelCompletion.classList.add('show');
                
                // Update map nodes
                updateMapNodes();
            } else {
                // Show completion message
                showModal('Challenge Complete!', 
                          `Congratulations! You've completed the ${challenge.title} challenge with ${stars} stars! ${newBadgesEarned ? 'You\'ve earned new badges!' : ''}`, 
                          'Back to Menu');
                
                elements.modalClose.onclick = () => {
                    hideModal();
                    switchMode('menu');
                    
                    // Reset challenge state
                    gameState.challengeState.currentChallenge = null;
                };
            }
            
            // Update badge display
            updateBadgeDisplay();
            
            // Show confetti
            showConfetti();
        }

        function startLevel(level) {
            if (level > 5) return; // Max 5 levels
            
            gameState.currentLevel = level;
            const levelData = adventureLevels.find(l => l.id === level);
            
            if (!levelData) return;
            
            // Start the associated challenge
            startChallenge(levelData.challenge);
            
            // Switch to adventure mode
            gameState.mode = 'adventure';
            
            // Hide menu
            elements.menuContainer.style.display = 'none';
            
            // Update character speech
            updateCharacterSpeech(characterSpeeches.adventure);
        }

        function updateMapNodes() {
            elements.mapNodes.forEach(node => {
                const level = parseInt(node.dataset.level);
                
                // Reset classes
                node.classList.remove('locked', 'completed');
                
                // Set appropriate class
                if (gameState.completedLevels.includes(level)) {
                    node.classList.add('completed');
                } else if (!gameState.unlockedLevels.includes(level)) {
                    node.classList.add('locked');
                }
            });
        }

        function updateBadgeDisplay() {
            // Update badges
            if (gameState.badges.explorer) elements.explorerBadge.classList.add('earned');
            if (gameState.badges.detective) elements.detectiveBadge.classList.add('earned');
            if (gameState.badges.master) elements.masterBadge.classList.add('earned');
            if (gameState.badges.quick) elements.quickBadge.classList.add('earned');
            if (gameState.badges.creative) elements.creativeBadge.classList.add('earned');
            
            // Update progress bar and level
            const totalBadges = Object.values(gameState.badges).filter(badge => badge).length;
            const progress = (totalBadges / 5) * 100;
            elements.overallProgress.style.width = `${progress}%`;
            
            // Update player level based on badges
            gameState.playerLevel = 1 + Math.floor(totalBadges / 2);
            elements.playerLevel.textContent = gameState.playerLevel;
        }

        function playSound(type) {
            if (!gameState.soundEnabled || !gameState.audioInitialized) return;
            
            try {
                // Only continue if audio context is available
                if (!audioContext) return;
                
                // Create a gain node for volume control
                const gainNode = audioContext.createGain();
                gainNode.gain.value = 0.3; // Reduce volume to 30%
                gainNode.connect(audioContext.destination);
                
                // Create oscillator
                const oscillator = audioContext.createOscillator();
                
                // Configure sound based on type
                switch (type) {
                    case 'click':
                        oscillator.type = 'sine';
                        oscillator.frequency.value = 523.25; // C5
                        playTone(oscillator, gainNode, 0.1);
                        break;
                    case 'hover':
                        oscillator.type = 'sine';
                        oscillator.frequency.value = 392.00; // G4
                        playTone(oscillator, gainNode, 0.05);
                        break;
                    case 'mode':
                        playChord([261.63, 329.63, 392.00], 0.2); // C4, E4, G4
                        break;
                    case 'slider':
                        oscillator.type = 'sine';
                        oscillator.frequency.value = 659.25; // E5
                        playTone(oscillator, gainNode, 0.05);
                        break;
                    case 'select':
                        oscillator.type = 'sine';
                        oscillator.frequency.value = 440.00; // A4
                        playTone(oscillator, gainNode, 0.1);
                        break;
                    case 'correct':
                        playArpeggio([523.25, 659.25, 783.99], 0.15); // C5, E5, G5
                        break;
                    case 'wrong':
                        oscillator.type = 'sawtooth';
                        oscillator.frequency.value = 196.00; // G3
                        playTone(oscillator, gainNode, 0.2);
                        setTimeout(() => {
                            const osc2 = audioContext.createOscillator();
                            osc2.type = 'sawtooth';
                            osc2.frequency.value = 185.00; // F#3
                            playTone(osc2, gainNode, 0.2);
                        }, 200);
                        break;
                    case 'success':
                        playArpeggio([523.25, 659.25, 783.99, 1046.50], 0.2); // C5, E5, G5, C6
                        break;
                    case 'error':
                        oscillator.type = 'sawtooth';
                        oscillator.frequency.value = 277.18; // C#4
                        playTone(oscillator, gainNode, 0.1);
                        setTimeout(() => {
                            const osc2 = audioContext.createOscillator();
                            osc2.type = 'sawtooth';
                            osc2.frequency.value = 207.65; // G#3
                            playTone(osc2, gainNode, 0.2);
                        }, 100);
                        break;
                    case 'win':
                        playFanfare();
                        break;
                    case 'character':
                        playChord([392.00, 493.88, 587.33], 0.2); // G4, B4, D5
                        break;
                }
            } catch (e) {
                console.warn('Sound playback error:', e);
                gameState.soundEnabled = false;
            }
        }

        function playTone(oscillator, gainNode, duration) {
            oscillator.connect(gainNode);
            oscillator.start();
            
            // Fade out for smoother sound
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
            
            // Stop after duration
            setTimeout(() => {
                oscillator.stop();
            }, duration * 1000);
        }

        function playChord(frequencies, duration) {
            if (!audioContext) return;
            
            const masterGain = audioContext.createGain();
            masterGain.gain.value = 0.3;
            masterGain.connect(audioContext.destination);
            
            frequencies.forEach(freq => {
                const osc = audioContext.createOscillator();
                osc.type = 'sine';
                osc.frequency.value = freq;
                osc.connect(masterGain);
                osc.start();
                
                setTimeout(() => {
                    osc.stop();
                }, duration * 1000);
            });
            
            masterGain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
        }

        function playArpeggio(frequencies, noteDelay) {
            if (!audioContext) return;
            
            const masterGain = audioContext.createGain();
            masterGain.gain.value = 0.3;
            masterGain.connect(audioContext.destination);
            
            frequencies.forEach((freq, index) => {
                setTimeout(() => {
                    const osc = audioContext.createOscillator();
                    osc.type = 'sine';
                    osc.frequency.value = freq;
                    osc.connect(masterGain);
                    osc.start();
                    
                    setTimeout(() => {
                        osc.stop();
                    }, 300);
                }, index * noteDelay * 1000);
            });
        }

        function playFanfare() {
            if (!audioContext) return;
            
            // Play a victory fanfare
            const melody = [
                { note: 523.25, duration: 0.2 },  // C5
                { note: 659.25, duration: 0.2 },  // E5
                { note: 783.99, duration: 0.2 },  // G5
                { note: 1046.50, duration: 0.5 }, // C6
            ];
            
            const masterGain = audioContext.createGain();
            masterGain.gain.value = 0.3;
            masterGain.connect(audioContext.destination);
            
            let timeOffset = 0;
            melody.forEach(({ note, duration }) => {
                setTimeout(() => {
                    const osc = audioContext.createOscillator();
                    const noteGain = audioContext.createGain();
                    
                    osc.type = 'triangle';
                    osc.frequency.value = note;
                    osc.connect(noteGain);
                    noteGain.connect(masterGain);
                    
                    noteGain.gain.value = 0.5;
                    osc.start();
                    noteGain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
                    
                    setTimeout(() => {
                        osc.stop();
                    }, duration * 1000);
                }, timeOffset * 1000);
                
                timeOffset += duration;
            });
        }

        // Helper math function for when p5.js map isn't available
        function map(value, fromLow, fromHigh, toLow, toHigh) {
            return toLow + (toHigh - toLow) * ((value - fromLow) / (fromHigh - fromLow));
        }

        /******************************************
         * P5.JS CANVAS RENDERING
         ******************************************/
        // Create a namespace for our P5 instance
        let sketch = function(p) {
            // P5 setup function
            p.setup = function() {
                const canvasContainer = document.getElementById('canvas-container');
                const canvasWidth = Math.min(canvasContainer.clientWidth - 100, 800);
                const canvasHeight = Math.min(canvasContainer.clientHeight - 100, 600);
                
                p.createCanvas(canvasWidth, canvasHeight);
                p.frameRate(30);
                p.colorMode(p.RGB, 255, 255, 255, 1);
                p.textAlign(p.CENTER, p.CENTER);
                p.textFont('Nunito, Arial, sans-serif');
                
                p.noLoop(); // Only draw when needed
                debugLog('Canvas created with dimensions:', { width: canvasWidth, height: canvasHeight });
            };

            // P5 draw function
            p.draw = function() {
                p.background(255, 255, 255, 0.95);
                
                // Draw coordinate system
                drawCoordinateSystem(p);
                
                // Draw based on current mode
                if (gameState.mode === 'area') {
                    drawAreaMode(p);
                } else if (gameState.mode === 'slope') {
                    drawSlopeMode(p);
                } else {
                    // Just show the coordinate system and welcome text for other modes
                    drawWelcomeGraphics(p);
                }
                
                debugLog('Canvas rendered in mode:', gameState.mode);
            };
            
            // Helper functions (all take p as first parameter)
            function drawCoordinateSystem(p) {
                // Draw grid
                p.stroke(230);
                p.strokeWeight(1);
                
                // Vertical grid lines
                const gridSpacingX = p.width / 10;
                for (let x = 0; x <= p.width; x += gridSpacingX) {
                    p.line(x, 0, x, p.height);
                }
                
                // Horizontal grid lines
                const gridSpacingY = p.height / 10;
                for (let y = 0; y <= p.height; y += gridSpacingY) {
                    p.line(0, y, p.width, y);
                }
                
                // Draw axes
                p.stroke(80);
                p.strokeWeight(2);
                
                // x-axis
                p.line(0, p.height/2, p.width, p.height/2);
                
                // y-axis
                p.line(p.width/2, 0, p.width/2, p.height);
                
                // Add ticks and labels
                p.textSize(12);
                p.fill(80);
                p.noStroke();
                
                // x-axis ticks and labels
                for (let i = -4; i <= 4; i++) {
                    if (i === 0) continue; // Skip origin
                    
                    const x = p.width/2 + i * gridSpacingX;
                    
                    // Draw tick
                    p.stroke(80);
                    p.strokeWeight(1);
                    p.line(x, p.height/2 - 5, x, p.height/2 + 5);
                    
                    // Draw label
                    p.noStroke();
                    p.text(i, x, p.height/2 + 20);
                }
                
                // y-axis ticks and labels
                for (let i = -4; i <= 4; i++) {
                    if (i === 0) continue; // Skip origin
                    
                    const y = p.height/2 - i * gridSpacingY;
                    
                    // Draw tick
                    p.stroke(80);
                    p.strokeWeight(1);
                    p.line(p.width/2 - 5, y, p.width/2 + 5, y);
                    
                    // Draw label
                    p.noStroke();
                    p.text(i, p.width/2 - 20, y);
                }
                
                // Draw origin label
                p.text("0", p.width/2 - 15, p.height/2 + 15);
                
                // Add axis labels
                p.textSize(14);
                p.textStyle(p.BOLD);
                p.text("x", p.width - 15, p.height/2 + 25);
                p.text("y", p.width/2 - 20, 15);
                p.textStyle(p.NORMAL);
            }

            function drawWelcomeGraphics(p) {
                // Draw a simple animated function
                const time = p.millis() / 1000;
                
                // Draw sinusoidal function
                p.stroke(65, 105, 225); // Royal blue
                p.strokeWeight(3);
                p.noFill();
                
                p.beginShape();
                for (let x = 0; x < p.width; x += 4) {
                    const t = p.map(x, 0, p.width, -p.PI, p.PI);
                    const y = p.height/2 - 80 * p.sin(t + time) * p.cos(t * 0.5);
                    p.vertex(x, y);
                }
                p.endShape();
                
                // Draw a quadratic function
                p.stroke(76, 175, 80); // Green
                p.strokeWeight(3);
                
                p.beginShape();
                for (let x = 0; x < p.width; x += 4) {
                    const t = p.map(x, 0, p.width, -3, 3);
                    const y = p.height/2 - 20 * t * t;
                    p.vertex(x, y);
                }
                p.endShape();
                
                // Welcome text
                p.textSize(24);
                p.fill(80, 80, 80);
                p.text("Welcome to MathQuest!", p.width/2, 60);
                
                p.textSize(18);
                p.text("Choose a mode from the navigation bar to get started!", p.width/2, p.height - 40);
                
                // Mode explanations
                p.textSize(14);
                p.fill(65, 105, 225);
                p.text("Area Explorer: Learn about integrals and the area under curves", p.width/2, p.height - 80);
                
                p.fill(76, 175, 80);
                p.text("Slope Detective: Discover derivatives and the slope of functions", p.width/2, p.height - 60);
            }

            function drawAreaMode(p) {
                const { shapeCount, functionType, m, b, a } = gameState.areaParams;
                
                // Define the domain and range for graphing
                const xMin = -5;
                const xMax = 5;
                const yMin = -5;
                const yMax = 5;
                
                // Function to convert from math coordinates to pixel coordinates
                const toPixelX = x => p.map(x, xMin, xMax, 0, p.width);
                const toPixelY = y => p.map(y, yMin, yMax, p.height, 0); // Flip y-axis
                
                // Function to evaluate the current function
                const evaluateFunction = x => {
                    switch (functionType) {
                        case 'linear':
                            return m * x + b;
                        case 'quadratic':
                            return a * x * x + b;
                        case 'cubic':
                            return a * x * x * x + b;
                        case 'sine':
                            return Math.sin(x) * 2 + b;
                        case 'exponential':
                            return Math.exp(x/2) + b - 1;
                        default:
                            return 0;
                    }
                };
                
                // Draw the function curve
                p.stroke(65, 105, 225, 0.9); // Royal blue
                p.strokeWeight(3);
                p.noFill();
                
                p.beginShape();
                for (let px = 0; px <= p.width; px += 2) {
                    const x = p.map(px, 0, p.width, xMin, xMax);
                    const y = evaluateFunction(x);
                    
                    // Check if y is within range to avoid drawing extreme values
                    if (y >= yMin - 1 && y <= yMax + 1) {
                        const py = toPixelY(y);
                        p.vertex(px, py);
                    }
                }
                p.endShape();
                
                // Draw rectangles under the curve
                const rectWidth = p.width / shapeCount;
                const dx = (xMax - xMin) / shapeCount;
                let totalArea = 0;
                
                for (let i = 0; i < shapeCount; i++) {
                    const x = xMin + (i + 0.5) * dx; // Sample at midpoint of each rectangle
                    const y = evaluateFunction(x);
                    
                    // Convert to pixel coordinates
                    const px = toPixelX(xMin + i * dx);
                    const py = toPixelY(y);
                    const originY = toPixelY(0);
                    
                    // Determine rectangle height and position
                    const rectHeight = Math.abs(py - originY);
                    
                    // Draw the rectangle
                    p.fill(255, 105, 97, 0.6); // Light red with transparency
                    p.stroke(255, 65, 54, 0.8); // Red outline
                    p.strokeWeight(1);
                    
                    if (y >= 0) {
                        p.rect(px, py, rectWidth, originY - py);
                        totalArea += y * dx;
                    } else {
                        p.rect(px, originY, rectWidth, py - originY);
                        totalArea -= y * dx; // Negative y values give negative area
                    }
                }
                
                // Take absolute value of area for display
                totalArea = Math.abs(totalArea);
                
                // Draw area calculation text
                p.textSize(18);
                p.fill(80);
                p.noStroke();
                
                // Draw function equation
                let equation;
                switch (functionType) {
                    case 'linear':
                        equation = `f(x) = ${m.toFixed(1)}x + ${b.toFixed(1)}`;
                        break;
                    case 'quadratic':
                        equation = `f(x) = ${a.toFixed(1)}x² + ${b.toFixed(1)}`;
                        break;
                    case 'cubic':
                        equation = `f(x) = ${a.toFixed(1)}x³ + ${b.toFixed(1)}`;
                        break;
                    case 'sine':
                        equation = `f(x) = sin(x) × 2 + ${b.toFixed(1)}`;
                        break;
                    case 'exponential':
                        equation = `f(x) = e^(x/2) + ${b.toFixed(1)} - 1`;
                        break;
                }
                
                // Calculate exact area for simple functions when possible
                let exactArea = null;
                if (functionType === 'linear' && m !== 0) {
                    // Area of trapezoid for linear function over [xMin, xMax]
                    const y1 = m * xMin + b;
                    const y2 = m * xMax + b;
                    exactArea = Math.abs((y1 + y2) * (xMax - xMin) / 2);
                }
                
                // Draw function equation and area information
                p.fill(65, 105, 225);
                p.textSize(20);
                p.text(equation, p.width/2, 30);
                
                // Draw integral notation
                p.fill(255, 65, 54);
                p.textSize(16);
                p.text(`∫f(x)dx = Area under the curve`, p.width/2, 60);
                
                // Draw area value
                p.fill(80);
                p.textSize(18);
                p.text(`Approximate Area with ${shapeCount} rectangles: ${totalArea.toFixed(2)} square units`, p.width/2, p.height - 40);
                
                if (exactArea !== null) {
                    p.text(`Exact Area: ${exactArea.toFixed(2)} square units`, p.width/2, p.height - 15);
                }
            }

            function drawSlopeMode(p) {
                const { x, functionType, m, b, a } = gameState.slopeParams;
                
                // Define the domain and range for graphing
                const xMin = -5;
                const xMax = 5;
                const yMin = -5;
                const yMax = 5;
                
                // Function to convert from math coordinates to pixel coordinates
                const toPixelX = x => p.map(x, xMin, xMax, 0, p.width);
                const toPixelY = y => p.map(y, yMin, yMax, p.height, 0); // Flip y-axis
                
                // Function to evaluate the current function
                const evaluateFunction = x => {
                    switch (functionType) {
                        case 'linear':
                            return m * x + b;
                        case 'quadratic':
                            return a * x * x + b;
                        case 'cubic':
                            return a * x * x * x + b;
                        case 'sine':
                            return Math.sin(x) * 2 + b;
                        case 'exponential':
                            return Math.exp(x/2) + b - 1;
                        default:
                            return 0;
                    }
                };
                
                // Function to evaluate the derivative
                const evaluateDerivative = x => {
                    switch (functionType) {
                        case 'linear':
                            return m;
                        case 'quadratic':
                            return 2 * a * x;
                        case 'cubic':
                            return 3 * a * x * x;
                        case 'sine':
                            return Math.cos(x) * 2;
                        case 'exponential':
                            return Math.exp(x/2) * 0.5;
                        default:
                            return 0;
                    }
                };
                
                // Draw the function curve
                p.stroke(65, 105, 225, 0.9); // Royal blue
                p.strokeWeight(3);
                p.noFill();
                
                p.beginShape();
                for (let px = 0; px <= p.width; px += 2) {
                    const x = p.map(px, 0, p.width, xMin, xMax);
                    const y = evaluateFunction(x);
                    
                    // Check if y is within range to avoid drawing extreme values
                    if (y >= yMin - 1 && y <= yMax + 1) {
                        const py = toPixelY(y);
                        p.vertex(px, py);
                    }
                }
                p.endShape();
                
                // Calculate the point on the curve
                const xValue = p.map(x, 0, 1, xMin, xMax);
                const yValue = evaluateFunction(xValue);
                
                // Convert to pixel coordinates
                const px = toPixelX(xValue);
                const py = toPixelY(yValue);
                
                // Calculate the derivative at this point
                const derivative = evaluateDerivative(xValue);
                
                // Draw the tangent line
                p.stroke(255, 140, 0, 0.9); // Orange
                p.strokeWeight(2);
                
                // Calculate tangent line points
                const tangentLength = p.width * 0.8; // Length of tangent line in pixels
                const deltaX = tangentLength / 2;
                const slope = -derivative * (p.height / (yMax - yMin)) / (p.width / (xMax - xMin));
                
                const x1 = px - deltaX;
                const y1 = py - slope * deltaX;
                const x2 = px + deltaX;
                const y2 = py + slope * deltaX;
                
                // Draw the tangent line if it's within reasonable bounds
                if (Math.abs(slope) < 50) {
                    p.line(x1, y1, x2, y2);
                } else {
                    // Draw a more vertical line for very steep slopes
                    const vertDelta = p.height * 0.4;
                    p.line(px, py - vertDelta, px, py + vertDelta);
                }
                
                // Draw the point on the curve
                p.fill(255, 105, 97);
                p.stroke(255, 65, 54);
                p.strokeWeight(2);
                p.ellipse(px, py, 12, 12);
                
                // Draw function equation and derivative info
                p.fill(65, 105, 225);
                p.textSize(20);
                p.noStroke();
                
                let equation;
                switch (functionType) {
                    case 'linear':
                        equation = `f(x) = ${m.toFixed(1)}x + ${b.toFixed(1)}`;
                        break;
                    case 'quadratic':
                        equation = `f(x) = ${a.toFixed(1)}x² + ${b.toFixed(1)}`;
                        break;
                    case 'cubic':
                        equation = `f(x) = ${a.toFixed(1)}x³ + ${b.toFixed(1)}`;
                        break;
                    case 'sine':
                        equation = `f(x) = sin(x) × 2 + ${b.toFixed(1)}`;
                        break;
                    case 'exponential':
                        equation = `f(x) = e^(x/2) + ${b.toFixed(1)} - 1`;
                        break;
                }
                
                p.text(equation, p.width/2, 30);
                
                // Draw derivative notation and value
                p.fill(255, 140, 0);
                p.textSize(16);
                
                let derivativeEquation;
                switch (functionType) {
                    case 'linear':
                        derivativeEquation = `f'(x) = ${m.toFixed(1)}`;
                        break;
                    case 'quadratic':
                        derivativeEquation = `f'(x) = ${(2 * a).toFixed(1)}x`;
                        break;
                    case 'cubic':
                        derivativeEquation = `f'(x) = ${(3 * a).toFixed(1)}x²`;
                        break;
                    case 'sine':
                        derivativeEquation = `f'(x) = 2cos(x)`;
                        break;
                    case 'exponential':
                        derivativeEquation = `f'(x) = 0.5e^(x/2)`;
                        break;
                }
                
                p.text(`${derivativeEquation} = Slope of the tangent line`, p.width/2, 60);
                
                // Draw point and slope information
                p.fill(80);
                p.textSize(16);
                p.text(`Point: (${xValue.toFixed(2)}, ${yValue.toFixed(2)})`, p.width/2, p.height - 40);
                p.text(`Slope at this point: ${derivative.toFixed(2)}`, p.width/2, p.height - 15);
            }
        };

        // Create the P5 instance once the document is loaded
        document.addEventListener('DOMContentLoaded', () => {
            // Create our P5 instance
            window.p5Instance = new p5(sketch, 'game-canvas');
            
            // Store reference for global usage
            debugLog('P5 instance created and attached to #game-canvas');
        });
    </script>
</body>
</html>