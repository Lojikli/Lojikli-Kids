<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MathQuest: Calculus Adventures</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap');
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: linear-gradient(135deg, #9cecfb, #65c7f7, #0052d4);
            font-family: 'Nunito', 'Arial', sans-serif;
            color: #333;
            transition: background 0.5s;
        }

        #game-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        #header {
            text-align: center;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            position: relative;
            z-index: 10;
        }

        #game-title {
            font-size: 2.2em;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            margin: 0;
            background: linear-gradient(90deg, #FF9A8B, #FF6A88, #FF99AC);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            animation: title-shimmer 2s infinite;
        }

        @keyframes title-shimmer {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        #main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        #nav-bar {
            display: flex;
            justify-content: center;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 5;
        }

        .nav-button {
            background: linear-gradient(135deg, #6a11cb, #2575fc);
            color: white;
            border: none;
            padding: 10px 15px;
            margin: 0 10px;
            border-radius: 50px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        .nav-button:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: 0.5s;
        }

        .nav-button:hover:before {
            left: 100%;
        }

        .nav-button:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 7px 10px rgba(0, 0, 0, 0.2);
        }

        .nav-button.active {
            background: linear-gradient(135deg, #11998e, #38ef7d);
            transform: translateY(-2px);
        }

        #canvas-container {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            padding: 20px;
        }

        #game-canvas {
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            background-color: rgba(255, 255, 255, 0.95);
        }

        #side-panel {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 300px;
            background-color: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            max-height: 90%;
            overflow-y: auto;
            z-index: 5;
            transition: all 0.3s;
        }

        #side-panel.minimized {
            transform: translateX(calc(100% - 40px)) translateY(-50%);
        }

        #toggle-panel {
            position: absolute;
            left: -20px;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 40px;
            background-color: #6a11cb;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            box-shadow: -3px 0 10px rgba(0, 0, 0, 0.1);
        }

        .panel-section {
            margin-bottom: 20px;
            display: none;
        }

        .panel-section.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .panel-title {
            font-size: 1.3em;
            margin-bottom: 15px;
            color: #6a11cb;
            border-bottom: 2px solid #6a11cb;
            padding-bottom: 5px;
        }

        .slider-container {
            margin: 15px 0;
            position: relative;
        }

        .slider-container label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .slider-container .value-display {
            position: absolute;
            right: 0;
            top: 0;
            background-color: #6a11cb;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.9em;
        }

        input[type="range"] {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            outline: none;
            appearance: none;
            cursor: pointer;
        }

        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #6a11cb;
            cursor: pointer;
            transition: all 0.2s;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            background: #38ef7d;
        }

        select {
            width: 100%;
            padding: 8px 10px;
            border-radius: 8px;
            border: 2px solid #6a11cb;
            background-color: white;
            font-family: 'Nunito', sans-serif;
            cursor: pointer;
            outline: none;
            transition: all 0.2s;
        }

        select:hover {
            border-color: #38ef7d;
        }

        #character-container {
            position: absolute;
            left: 20px;
            bottom: 20px;
            width: 350px;
            z-index: 10;
        }

        .speech-bubble {
            background-color: white;
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            margin-bottom: 15px;
            position: relative;
            min-height: 100px;
            transition: all 0.3s;
        }

        .speech-bubble:after {
            content: '';
            position: absolute;
            bottom: -15px;
            left: 50px;
            border-width: 15px 15px 0;
            border-style: solid;
            border-color: white transparent;
            display: block;
            width: 0;
        }

        .character {
            display: flex;
            justify-content: flex-start;
            align-items: flex-end;
            height: 120px;
        }

        .character-avatar {
            width: 100px;
            height: 100px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
        }

        .character-avatar:hover {
            transform: translateY(-10px);
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        #reward-container {
            position: absolute;
            top: 70px;
            right: 20px;
            background-color: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .star {
            width: 30px;
            height: 30px;
            margin: 0 5px;
            filter: grayscale(100%);
            transition: all 0.3s;
        }

        .star.earned {
            filter: grayscale(0%);
            animation: star-pulse 0.5s;
        }

        @keyframes star-pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.5); }
            100% { transform: scale(1); }
        }

        .progress-bar-container {
            width: 100%;
            height: 15px;
            background-color: #e0e0e0;
            border-radius: 7.5px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #11998e, #38ef7d);
            width: 0%;
            border-radius: 7.5px;
            transition: width 0.5s;
        }

        .badge {
            width: 60px;
            height: 60px;
            margin: 5px;
            border-radius: 50%;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            color: #ccc;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }

        .badge.earned {
            background: linear-gradient(135deg, #ff9a8b, #ff6a88);
            color: white;
            animation: badge-earned 0.7s;
        }

        @keyframes badge-earned {
            0% { transform: scale(1); }
            50% { transform: scale(1.2) rotate(10deg); }
            100% { transform: scale(1); }
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 100;
            justify-content: center;
            align-items: center;
            perspective: 1000px;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative;
            transform-style: preserve-3d;
            transform: rotateX(0deg);
            transition: transform 0.5s;
        }

        .modal-overlay.closing .modal-content {
            transform: rotateX(90deg);
        }

        .modal-title {
            font-size: 2em;
            margin-bottom: 20px;
            color: #6a11cb;
        }

        .modal-button {
            background: linear-gradient(135deg, #6a11cb, #2575fc);
            color: white;
            border: none;
            padding: 12px 24px;
            margin-top: 20px;
            border-radius: 50px;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .modal-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 15px rgba(0, 0, 0, 0.3);
        }

        .quiz-container {
            margin-top: 20px;
            text-align: left;
        }

        .quiz-question {
            font-size: 1.2em;
            margin-bottom: 15px;
        }

        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .quiz-option {
            background-color: rgba(255, 255, 255, 0.9);
            border: 2px solid #e0e0e0;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.1em;
        }

        .quiz-option:hover {
            background-color: #f5f5f5;
            transform: translateX(5px);
        }

        .quiz-option.selected {
            border-color: #6a11cb;
            background-color: rgba(106, 17, 203, 0.1);
        }

        .quiz-option.correct {
            border-color: #38ef7d;
            background-color: rgba(56, 239, 125, 0.2);
        }

        .quiz-option.wrong {
            border-color: #ff6a88;
            background-color: rgba(255, 106, 136, 0.2);
        }

        .mini-game-container {
            height: 300px;
            width: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            margin: 20px 0;
            position: relative;
            overflow: hidden;
        }

        #confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }

        #menu-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #c33764, #1d2671);
            z-index: 50;
            transition: opacity 0.5s, transform 0.5s;
        }

        .menu-buttons {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 30px;
        }

        .big-button {
            background: linear-gradient(135deg, #ff9a8b, #ff6a88);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.5em;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 250px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .big-button:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: 0.5s;
        }

        .big-button:hover:before {
            left: 100%;
        }

        .big-button:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }

        .menu-title {
            font-size: 3em;
            color: white;
            text-shadow: 0 5px 10px rgba(0, 0, 0, 0.5);
            margin-bottom: 20px;
            background: linear-gradient(90deg, #FF9A8B, #FF6A88, #FF99AC);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .level-selection {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 30px 0;
            max-width: 600px;
            justify-content: center;
        }

        .level-button {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: 3px solid white;
            color: white;
            font-size: 1.5em;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .level-button:hover {
            transform: scale(1.1);
            background: rgba(255, 255, 255, 0.4);
        }

        .level-button.locked {
            background: rgba(100, 100, 100, 0.3);
            cursor: not-allowed;
        }

        .level-button.locked:after {
            content: 'üîí';
            position: absolute;
            font-size: 1.5em;
        }

        .level-button.completed:after {
            content: '‚úì';
            position: absolute;
            bottom: -10px;
            right: -10px;
            background: #38ef7d;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.7em;
            color: white;
        }

        .back-button {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.3);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .back-button:hover {
            background: white;
            color: #6a11cb;
            transform: scale(1.1);
        }

        .adventure-map {
            width: 80%;
            height: 70%;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="500" height="500" viewBox="0 0 500 500"><path d="M50,250 Q125,150 250,250 T450,250" stroke="white" stroke-width="8" fill="none" stroke-dasharray="1,15" stroke-linecap="round"/></svg>') no-repeat center center;
            background-size: contain;
            position: relative;
            margin-top: 50px;
        }

        .map-node {
            position: absolute;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            border: 3px solid white;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
            font-size: 1.2em;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .map-node:hover {
            transform: scale(1.2);
            background: rgba(255, 255, 255, 0.5);
        }

        .map-node.locked {
            background: rgba(100, 100, 100, 0.3);
            cursor: not-allowed;
        }

        .map-node.locked:after {
            content: 'üîí';
            position: absolute;
            font-size: 1.5em;
        }

        .map-node.completed {
            background: rgba(56, 239, 125, 0.5);
        }

        .map-node:nth-child(1) { top: 80%; left: 10%; }
        .map-node:nth-child(2) { top: 40%; left: 25%; }
        .map-node:nth-child(3) { top: 60%; left: 50%; }
        .map-node:nth-child(4) { top: 30%; left: 70%; }
        .map-node:nth-child(5) { top: 50%; left: 90%; }

        #game-levels {
            display: none;
        }

        #challenge-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            max-width: 80%;
        }

        .challenge-card {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 20px;
            width: 100%;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .challenge-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .challenge-card h3 {
            margin-bottom: 10px;
            font-size: 1.4em;
        }

        .level-description {
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            max-width: 80%;
            text-align: center;
        }

        .game-world {
            width: 100%;
            height: 100%;
            position: relative;
            display: none;
        }

        #level-completion {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 100;
            text-align: center;
            transition: all 0.5s;
        }

        #level-completion.show {
            transform: translate(-50%, -50%) scale(1);
        }

        .star-container {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }

        .completion-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .loading-spinner {
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 5px solid #6a11cb;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #c33764, #1d2671);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s;
        }

        #loading-screen.hide {
            opacity: 0;
            pointer-events: none;
        }

        .loading-text {
            color: white;
            font-size: 1.5em;
            margin-top: 20px;
        }

        .tooltip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9em;
            z-index: 100;
            max-width: 200px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
    </style>
</head>
<body>
    <div id="loading-screen">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading MathQuest...</div>
    </div>

    <div id="game-container">
        <div id="header">
            <h1 id="game-title">MathQuest: Calculus Adventures</h1>
        </div>

        <div id="main-content">
            <div id="nav-bar">
                <button class="nav-button" id="menu-button">Main Menu</button>
                <button class="nav-button" id="area-button">Area Explorer</button>
                <button class="nav-button" id="slope-button">Slope Detective</button>
                <button class="nav-button" id="challenge-button">Challenges</button>
                <button class="nav-button" id="badge-button">Badges</button>
            </div>

            <div id="canvas-container">
                <canvas id="game-canvas"></canvas>
                
                <div id="side-panel">
                    <button id="toggle-panel">‚â™</button>
                    
                    <div id="area-controls" class="panel-section">
                        <h3 class="panel-title">Area Explorer Controls</h3>
                        
                        <div class="slider-container">
                            <label for="shape-count">Number of Rectangles:</label>
                            <span class="value-display" id="shape-count-value">10</span>
                            <input type="range" id="shape-count" min="1" max="100" value="10">
                        </div>
                        
                        <div class="slider-container">
                            <label for="function-type">Function Type:</label>
                            <select id="function-type">
                                <option value="linear">Linear (y = mx + b)</option>
                                <option value="quadratic">Quadratic (y = ax¬≤ + b)</option>
                                <option value="cubic">Cubic (y = ax¬≥ + b)</option>
                                <option value="sine">Sine Wave (y = sin(x))</option>
                                <option value="exponential">Exponential (y = eÀ£)</option>
                            </select>
                        </div>
                        
                        <div class="slider-container" id="m-param-container">
                            <label for="m-param">Slope (m):</label>
                            <span class="value-display" id="m-param-value">1</span>
                            <input type="range" id="m-param" min="-3" max="3" step="0.1" value="1">
                        </div>
                        
                        <div class="slider-container" id="b-param-container">
                            <label for="b-param">y-intercept (b):</label>
                            <span class="value-display" id="b-param-value">0</span>
                            <input type="range" id="b-param" min="-3" max="3" step="0.1" value="0">
                        </div>
                        
                        <div class="slider-container" id="a-param-container" style="display: none;">
                            <label for="a-param">Coefficient (a):</label>
                            <span class="value-display" id="a-param-value">0.5</span>
                            <input type="range" id="a-param" min="-1" max="1" step="0.1" value="0.5">
                        </div>
                    </div>
                    
                    <div id="slope-controls" class="panel-section">
                        <h3 class="panel-title">Slope Detective Controls</h3>
                        
                        <div class="slider-container">
                            <label for="point-x">Point Position (x):</label>
                            <span class="value-display" id="point-x-value">0.5</span>
                            <input type="range" id="point-x" min="0" max="1" step="0.01" value="0.5">
                        </div>
                        
                        <div class="slider-container">
                            <label for="derivative-function">Function:</label>
                            <select id="derivative-function">
                                <option value="linear">Linear (y = mx + b)</option>
                                <option value="quadratic">Quadratic (y = ax¬≤ + b)</option>
                                <option value="cubic">Cubic (y = ax¬≥ + b)</option>
                                <option value="sine">Sine Wave (y = sin(x))</option>
                                <option value="exponential">Exponential (y = eÀ£)</option>
                            </select>
                        </div>
                        
                        <div class="slider-container" id="slope-m-param-container">
                            <label for="slope-m-param">Slope (m):</label>
                            <span class="value-display" id="slope-m-param-value">1</span>
                            <input type="range" id="slope-m-param" min="-3" max="3" step="0.1" value="1">
                        </div>
                        
                        <div class="slider-container" id="slope-b-param-container">
                            <label for="slope-b-param">y-intercept (b):</label>
                            <span class="value-display" id="slope-b-param-value">0</span>
                            <input type="range" id="slope-b-param" min="-3" max="3" step="0.1" value="0">
                        </div>
                        
                        <div class="slider-container" id="slope-a-param-container" style="display: none;">
                            <label for="slope-a-param">Coefficient (a):</label>
                            <span class="value-display" id="slope-a-param-value">0.5</span>
                            <input type="range" id="slope-a-param" min="-1" max="1" step="0.1" value="0.5">
                        </div>
                    </div>
                    
                    <div id="challenge-controls" class="panel-section">
                        <h3 class="panel-title">Challenge Info</h3>
                        <div id="challenge-description">
                            <p>Select a challenge to begin!</p>
                        </div>
                        
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="challenge-progress"></div>
                        </div>
                        
                        <p>Score: <span id="challenge-score">0</span> / <span id="challenge-total">10</span></p>
                    </div>
                    
                    <div id="badge-controls" class="panel-section">
                        <h3 class="panel-title">Your Badges</h3>
                        <div id="badges-container">
                            <div class="badge" id="explorer-badge" title="Area Explorer - Complete 5 area challenges">üîç</div>
                            <div class="badge" id="detective-badge" title="Slope Detective - Complete 5 slope challenges">üïµÔ∏è</div>
                            <div class="badge" id="master-badge" title="Math Master - Get a perfect score on a challenge">üèÜ</div>
                            <div class="badge" id="creative-badge" title="Creative Genius - Create a custom function with 5 parameters">üí°</div>
                            <div class="badge" id="quick-badge" title="Quick Thinker - Complete a challenge in under 2 minutes">‚ö°</div>
                        </div>
                        
                        <h3 class="panel-title" style="margin-top: 20px;">Your Progress</h3>
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="overall-progress"></div>
                        </div>
                        <p>Level: <span id="player-level">1</span></p>
                    </div>
                </div>
                
                <div id="character-container">
                    <div class="speech-bubble">
                        <p id="character-speech">Hi there! I'm Professor X. Ready to explore the exciting world of calculus? Choose a mode from the navigation bar to get started!</p>
                    </div>
                    <div class="character">
                        <div class="character-avatar" id="professor-x"></div>
                    </div>
                </div>
                
                <div id="reward-container" style="display: none;">
                    <h3>Rewards</h3>
                    <div class="star-container">
                        <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24' height='24'><path fill='%23FFD700' d='M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z'/></svg>" class="star" id="star-1">
                        <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24' height='24'><path fill='%23FFD700' d='M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z'/></svg>" class="star" id="star-2">
                        <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24' height='24'><path fill='%23FFD700' d='M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z'/></svg>" class="star" id="star-3">
                    </div>
                </div>
                
                <div id="confetti-container"></div>
                
                <div id="menu-container">
                    <h1 class="menu-title">MathQuest: Calculus Adventures</h1>
                    
                    <div class="menu-buttons">
                        <button class="big-button" id="start-adventure">Start Adventure</button>
                        <button class="big-button" id="free-play">Free Play</button>
                        <button class="big-button" id="mini-games">Mini Games</button>
                    </div>
                    
                    <div id="game-levels">
                        <h2 style="color: white; margin-bottom: 20px;">Select a Level</h2>
                        
                        <div class="adventure-map">
                            <div class="map-node" data-level="1">1</div>
                            <div class="map-node locked" data-level="2">2</div>
                            <div class="map-node locked" data-level="3">3</div>
                            <div class="map-node locked" data-level="4">4</div>
                            <div class="map-node locked" data-level="5">5</div>
                        </div>
                        
                        <button class="back-button" id="back-to-menu">‚Ü©</button>
                    </div>
                    
                    <div id="challenge-container" style="display: none;">
                        <h2 style="color: white; margin-bottom: 20px;">Select a Challenge</h2>
                        
                        <div class="challenge-card" data-challenge="area-basics">
                            <h3>Area Basics</h3>
                            <p>Learn how integrals calculate area under curves</p>
                        </div>
                        
                        <div class="challenge-card" data-challenge="slope-basics">
                            <h3>Slope Detective</h3>
                            <p>Discover the power of derivatives</p>
                        </div>
                        
                        <div class="challenge-card" data-challenge="function-factory">
                            <h3>Function Factory</h3>
                            <p>Create functions and explore their properties</p>
                        </div>
                        
                        <div class="challenge-card" data-challenge="integral-quiz">
                            <h3>Integral Quiz</h3>
                            <p>Test your knowledge about integrals</p>
                        </div>
                        
                        <button class="back-button" id="back-from-challenges">‚Ü©</button>
                    </div>
                </div>
                
                <div id="level-completion">
                    <h2>Level Complete!</h2>
                    <p>You've mastered the basics of area calculation!</p>
                    
                    <div class="star-container">
                        <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24' height='24'><path fill='%23FFD700' d='M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z'/></svg>" class="star earned">
                        <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24' height='24'><path fill='%23FFD700' d='M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z'/></svg>" class="star earned">
                        <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24' height='24'><path fill='%23FFD700' d='M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z'/></svg>" class="star">
                    </div>
                    
                    <div class="completion-buttons">
                        <button class="modal-button" id="next-level">Next Level</button>
                        <button class="modal-button" id="replay-level">Replay</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal">
        <div class="modal-content">
            <h2 class="modal-title" id="modal-title">Welcome to MathQuest!</h2>
            <p id="modal-text">Embark on an exciting adventure through the world of calculus! You'll explore areas under curves with integrals, investigate slopes with derivatives, and solve challenging puzzles along the way.</p>
            <div id="modal-quiz-container" style="display: none;"></div>
            <button class="modal-button" id="modal-close">Let's Go!</button>
        </div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"></script>
    <script>
        /******************************************
         * GAME DATA AND STATE
         ******************************************/
        const gameState = {
            mode: 'menu', // 'menu', 'area', 'slope', 'challenge', 'badges', 'adventure'
            currentLevel: 1,
            unlockedLevels: [1],
            completedLevels: [],
            stars: 0,
            badges: {
                explorer: false,
                detective: false,
                master: false,
                creative: false,
                quick: false
            },
            playerLevel: 1,
            playerXP: 0,
            areaParams: {
                shapeCount: 10,
                functionType: 'linear',
                m: 1,
                b: 0,
                a: 0.5
            },
            slopeParams: {
                x: 0.5,
                functionType: 'linear',
                m: 1,
                b: 0,
                a: 0.5
            },
            challengeState: {
                currentChallenge: null,
                currentStep: 0,
                totalSteps: 0,
                score: 0,
                startTime: 0,
                selectedOption: null
            },
            showingConfetti: false,
            panelMinimized: false,
            tooltipVisible: false,
            soundEnabled: true,
            currentSubmenu: null,
            loadingComplete: false,
            audioInitialized: false
        };

        // Simple audio context for sound effects
        let audioContext;
        
        // Quiz/challenge questions
        const challenges = {
            'area-basics': {
                title: 'Area Basics',
                description: 'Learn how integrals help us calculate the area under curves!',
                steps: [
                    {
                        type: 'tutorial',
                        title: 'Welcome to Area Explorer!',
                        content: 'In this challenge, you\'ll learn how mathematicians use integrals to find the area under curves. An integral is like adding up lots of tiny shapes to get the total area!'
                    },
                    {
                        type: 'interactive',
                        title: 'Rectangle Method',
                        task: 'Adjust the number of rectangles to at least 20 to see how more rectangles give a better approximation of the area.',
                        checkCondition: () => gameState.areaParams.shapeCount >= 20,
                        hint: 'Use the "Number of Rectangles" slider to increase the number of rectangles.'
                    },
                    {
                        type: 'interactive',
                        title: 'Changing Functions',
                        task: 'Change the function to a quadratic function (y = ax¬≤ + b) and observe how the area changes.',
                        checkCondition: () => gameState.areaParams.functionType === 'quadratic',
                        hint: 'Use the "Function Type" dropdown to select the quadratic function.'
                    },
                    {
                        type: 'quiz',
                        question: 'What happens to our area calculation as we increase the number of rectangles?',
                        options: [
                            'It gets less accurate',
                            'It stays exactly the same',
                            'It gets more accurate',
                            'It always equals zero'
                        ],
                        correctIndex: 2,
                        explanation: 'More rectangles means a more accurate area calculation because the rectangles follow the curve more closely.'
                    },
                    {
                        type: 'quiz',
                        question: 'The integral of a function f(x) represents:',
                        options: [
                            'The slope of the function',
                            'The area under the curve of the function',
                            'The height of the function',
                            'The color of the function'
                        ],
                        correctIndex: 1,
                        explanation: 'An integral helps us find the area under a curve. Think of it as counting up all the tiny rectangles that fit under the curve!'
                    },
                    {
                        type: 'success',
                        title: 'Challenge Complete!',
                        content: 'Great job! You\'ve learned how integrals help us find the area under curves. The more rectangles we use, the more accurate our calculation becomes. In calculus, we use an infinite number of infinitely thin rectangles to get the exact area!'
                    }
                ]
            },
            'slope-basics': {
                title: 'Slope Detective',
                description: 'Discover how derivatives help us find the slope of curves at any point!',
                steps: [
                    {
                        type: 'tutorial',
                        title: 'Welcome to Slope Detective!',
                        content: 'In this challenge, you\'ll learn how mathematicians use derivatives to find the slope of curves at any point. A derivative tells us how quickly a function is changing!'
                    },
                    {
                        type: 'interactive',
                        title: 'Moving the Point',
                        task: 'Move the point along the curve to see how the slope changes at different positions.',
                        checkCondition: () => true, // Auto-complete after viewing
                        hint: 'Use the "Point Position" slider to move the point along the curve.'
                    },
                    {
                        type: 'interactive',
                        title: 'Different Functions',
                        task: 'Change the function to a quadratic function (y = ax¬≤ + b) and observe how the slope changes as you move the point.',
                        checkCondition: () => gameState.slopeParams.functionType === 'quadratic',
                        hint: 'Use the "Function" dropdown to select the quadratic function.'
                    },
                    {
                        type: 'quiz',
                        question: 'At what point does a quadratic function (y = x¬≤) have a slope of 0?',
                        options: [
                            'x = 1',
                            'x = 0',
                            'x = -1',
                            'There is no such point'
                        ],
                        correctIndex: 1,
                        explanation: 'The derivative of y = x¬≤ is 2x, which equals 0 when x = 0. This is the lowest point of the parabola where the tangent line is horizontal.'
                    },
                    {
                        type: 'quiz',
                        question: 'The derivative of a function f(x) represents:',
                        options: [
                            'The area under the function',
                            'The slope (rate of change) of the function at a point',
                            'The total value of the function',
                            'The average of the function'
                        ],
                        correctIndex: 1,
                        explanation: 'The derivative tells us the slope (or rate of change) of a function at any point. It\'s like measuring how steep a hill is at different spots!'
                    },
                    {
                        type: 'success',
                        title: 'Challenge Complete!',
                        content: 'Excellent work! You\'ve learned how derivatives help us find the slope of curves at any point. The derivative of a function tells us how quickly the function is changing, which is incredibly useful in physics, economics, and many other fields!'
                    }
                ]
            },
            'function-factory': {
                title: 'Function Factory',
                description: 'Create your own functions and explore their properties!',
                steps: [
                    {
                        type: 'tutorial',
                        title: 'Welcome to Function Factory!',
                        content: 'In this challenge, you\'ll create your own functions and explore how changing their parameters affects their shape, area, and slope.'
                    },
                    {
                        type: 'interactive',
                        title: 'Linear Functions',
                        task: 'Create a linear function with a slope of 2 and a y-intercept of 1.',
                        checkCondition: () => gameState.areaParams.functionType === 'linear' && 
                                              Math.abs(gameState.areaParams.m - 2) < 0.1 && 
                                              Math.abs(gameState.areaParams.b - 1) < 0.1,
                        hint: 'Set the Function Type to linear, then adjust the Slope (m) to 2 and y-intercept (b) to 1.'
                    },
                    {
                        type: 'interactive',
                        title: 'Quadratic Functions',
                        task: 'Create a quadratic function with a coefficient of -0.5.',
                        checkCondition: () => gameState.areaParams.functionType === 'quadratic' && 
                                              Math.abs(gameState.areaParams.a + 0.5) < 0.1,
                        hint: 'Set the Function Type to quadratic, then adjust the Coefficient (a) to -0.5.'
                    },
                    {
                        type: 'quiz',
                        question: 'What happens to the parabola when the coefficient (a) is negative?',
                        options: [
                            'It opens upward',
                            'It opens downward',
                            'It becomes a straight line',
                            'It disappears'
                        ],
                        correctIndex: 1,
                        explanation: 'When the coefficient (a) is negative, the parabola opens downward instead of upward.'
                    },
                    {
                        type: 'interactive',
                        title: 'Sine Functions',
                        task: 'Switch to a sine function and observe its derivative as you move the point.',
                        checkCondition: () => gameState.slopeParams.functionType === 'sine',
                        hint: 'Go to Slope Detective mode and set the Function Type to sine.'
                    },
                    {
                        type: 'quiz',
                        question: 'What is the derivative of sin(x)?',
                        options: [
                            'cos(x)',
                            '-sin(x)',
                            'tan(x)',
                            '1/sin(x)'
                        ],
                        correctIndex: 0,
                        explanation: 'The derivative of sin(x) is cos(x). This is why when you move the point on a sine curve, the slope follows a cosine pattern!'
                    },
                    {
                        type: 'success',
                        title: 'Challenge Complete!',
                        content: 'Amazing job! You\'ve created various functions and explored their derivatives and integrals. Understanding how changing parameters affects functions is a crucial skill in calculus and many real-world applications!'
                    }
                ]
            },
            'integral-quiz': {
                title: 'Integral Quiz',
                description: 'Test your knowledge about integrals and area calculations!',
                steps: [
                    {
                        type: 'tutorial',
                        title: 'Integral Quiz Challenge',
                        content: 'Let\'s test your knowledge about integrals and area calculations! Answer the following questions to show what you\'ve learned.'
                    },
                    {
                        type: 'quiz',
                        question: 'What does ‚à´f(x)dx represent?',
                        options: [
                            'The derivative of f(x)',
                            'The area under the curve of f(x)',
                            'The slope of f(x)',
                            'The value of f(x)'
                        ],
                        correctIndex: 1,
                        explanation: 'The integral ‚à´f(x)dx represents the area under the curve of the function f(x).'
                    },
                    {
                        type: 'quiz',
                        question: 'If f(x) = 4, what is ‚à´f(x)dx?',
                        options: [
                            '4x + C',
                            '4',
                            '0',
                            '4/x + C'
                        ],
                        correctIndex: 0,
                        explanation: 'When integrating a constant like 4, we get 4x + C, where C is the constant of integration. This is because the derivative of 4x + C is 4.'
                    },
                    {
                        type: 'quiz',
                        question: 'What is the integral of x¬≤?',
                        options: [
                            'x¬≥/3 + C',
                            '2x + C',
                            '2x¬≥ + C',
                            'x¬≥ + C'
                        ],
                        correctIndex: 0,
                        explanation: 'The integral of x¬≤ is x¬≥/3 + C. The power rule for integration says we add 1 to the exponent and divide by the new exponent: ‚à´x^n dx = x^(n+1)/(n+1) + C.'
                    },
                    {
                        type: 'quiz',
                        question: 'Which method provides an exact area under a linear function?',
                        options: [
                            'Using 10 rectangles',
                            'Using 100 rectangles',
                            'Using trapezoids',
                            'Using circles'
                        ],
                        correctIndex: 2,
                        explanation: 'Trapezoids calculate the area under a linear function exactly! This is because they perfectly match the slant of the line.'
                    },
                    {
                        type: 'quiz',
                        question: 'What is the relationship between derivatives and integrals?',
                        options: [
                            'They are unrelated concepts',
                            'They are the same thing',
                            'Integrals are the opposite of derivatives',
                            'Derivatives are always bigger than integrals'
                        ],
                        correctIndex: 2,
                        explanation: 'Integrals and derivatives are opposite operations - they undo each other! This is known as the Fundamental Theorem of Calculus.'
                    },
                    {
                        type: 'success',
                        title: 'Quiz Complete!',
                        content: 'Outstanding! You\'ve demonstrated a solid understanding of integrals and area calculations. These concepts are fundamental to calculus and have countless applications in science, engineering, and economics!'
                    }
                ]
            }
        };

        // Adventure levels
        const adventureLevels = [
            {
                id: 1,
                title: 'The Beginning',
                description: 'Start your calculus adventure by learning about areas under curves!',
                challenge: 'area-basics'
            },
            {
                id: 2,
                title: 'Slope Mountain',
                description: 'Climb the mountain of derivatives and discover the power of slopes!',
                challenge: 'slope-basics'
            },
            {
                id: 3,
                title: 'Function Forest',
                description: 'Navigate through the forest of functions and learn to create your own!',
                challenge: 'function-factory'
            },
            {
                id: 4,
                title: 'Integration Island',
                description: 'Explore the mysterious island of integrals and master area calculations!',
                challenge: 'integral-quiz'
            },
            {
                id: 5,
                title: 'Calculus Castle',
                description: 'Reach the final castle and prove your mastery of calculus!',
                challenge: 'final-challenge'
            }
        ];

        // Character speeches for different modes and interactions
        const characterSpeeches = {
            welcome: "Hi there! I'm Professor X, your calculus guide! Choose a mode from the navigation bar to start exploring the exciting world of calculus!",
            areaMode: "Welcome to Area Explorer! Here, we'll discover how integrals help us find the area under curves. Try changing the number of rectangles with the slider to see how our approximation gets better!",
            slopeMode: "Welcome to Slope Detective! Here, we'll investigate how derivatives give us the slope of a curve at any point. Move the point along the curve to see how the slope changes!",
            challengeMode: "Ready for a challenge? Select one of our exciting challenges to test your understanding of calculus concepts!",
            badgeMode: "Here are all the badges you can earn on your calculus adventure! Complete challenges and learn new concepts to collect them all!",
            manyRectangles: "Wow! With so many rectangles, our area calculation is getting super accurate! This is exactly how calculus works - with infinitely many, infinitely thin rectangles!",
            fewRectangles: "With just a few rectangles, we get a rough estimate of the area. Adding more rectangles makes our calculation more precise!",
            steepSlope: "Look at that steep slope! The derivative (slope) has a large value when the curve changes quickly. Think about a roller coaster's steepest part!",
            flatSlope: "The slope is almost flat here! When the derivative (slope) is close to zero, the curve barely changes - like a small hill on a hiking trail!",
            correctAnswer: "Amazing! That's correct! You're understanding calculus concepts like a young genius!",
            wrongAnswer: "Not quite, but that's okay! Learning math is about trying different ideas. Let's look at why this answer works.",
            challengeComplete: "Incredible! You've completed the challenge. You're really understanding these advanced calculus concepts!",
            functionChange: "You've changed the function! Notice how the shape, area, and slope all change too. This is why mathematicians study different types of functions!",
            adventure: "Welcome to your calculus adventure! Journey through different levels, solve challenges, and become a calculus master!",
            levelComplete: "Level complete! You're making fantastic progress on your calculus journey!",
            newBadge: "Congratulations! You've earned a new badge for your accomplishments!",
            tip: "Pro tip: Try experimenting with different functions and parameters to see how they affect the area and slope!"
        };

        // DOM Elements
        let elements = {};
        
        /******************************************
         * GAME INITIALIZATION
         ******************************************/
        document.addEventListener('DOMContentLoaded', () => {
            // Get DOM elements
            getElements();
            
            // Add event listeners
            setupEventListeners();
            
            // Draw character
            drawCharacter();
            
            // Show welcome modal
            setTimeout(() => {
                showModal('Welcome to MathQuest!', 
                          'Embark on an exciting adventure through the world of calculus! You\'ll explore areas under curves with integrals, investigate slopes with derivatives, and solve challenging puzzles along the way.', 
                          'Let\'s Go!');
                
                // Hide loading screen
                document.getElementById('loading-screen').classList.add('hide');
                gameState.loadingComplete = true;
            }, 1500);
            
            // Initialize audio on first user interaction
            document.body.addEventListener('click', initAudio, { once: true });
        });

        function initAudio() {
            // Only initialize once
            if (gameState.audioInitialized) return;
            
            try {
                // Create audio context
                window.AudioContext = window.AudioContext || window.webkitAudioContext;
                audioContext = new AudioContext();
                gameState.audioInitialized = true;
            } catch (e) {
                console.warn('Web Audio API not supported in this browser');
                gameState.soundEnabled = false;
            }
        }

        function getElements() {
            elements = {
                // Main containers
                gameCanvas: document.getElementById('game-canvas'),
                sidePanel: document.getElementById('side-panel'),
                characterSpeech: document.getElementById('character-speech'),
                professorX: document.getElementById('professor-x'),
                menuContainer: document.getElementById('menu-container'),
                gameLevels: document.getElementById('game-levels'),
                challengeContainer: document.getElementById('challenge-container'),
                
                // Navigation buttons
                menuButton: document.getElementById('menu-button'),
                areaButton: document.getElementById('area-button'),
                slopeButton: document.getElementById('slope-button'),
                challengeButton: document.getElementById('challenge-button'),
                badgeButton: document.getElementById('badge-button'),
                
                // Area controls
                areaControls: document.getElementById('area-controls'),
                shapeCount: document.getElementById('shape-count'),
                shapeCountValue: document.getElementById('shape-count-value'),
                functionType: document.getElementById('function-type'),
                mParam: document.getElementById('m-param'),
                mParamValue: document.getElementById('m-param-value'),
                bParam: document.getElementById('b-param'),
                bParamValue: document.getElementById('b-param-value'),
                aParam: document.getElementById('a-param'),
                aParamValue: document.getElementById('a-param-value'),
                aParamContainer: document.getElementById('a-param-container'),
                mParamContainer: document.getElementById('m-param-container'),
                bParamContainer: document.getElementById('b-param-container'),
                
                // Slope controls
                slopeControls: document.getElementById('slope-controls'),
                pointX: document.getElementById('point-x'),
                pointXValue: document.getElementById('point-x-value'),
                derivativeFunction: document.getElementById('derivative-function'),
                slopeMParam: document.getElementById('slope-m-param'),
                slopeMParamValue: document.getElementById('slope-m-param-value'),
                slopeBParam: document.getElementById('slope-b-param'),
                slopeBParamValue: document.getElementById('slope-b-param-value'),
                slopeAParam: document.getElementById('slope-a-param'),
                slopeAParamValue: document.getElementById('slope-a-param-value'),
                slopeAParamContainer: document.getElementById('slope-a-param-container'),
                slopeMParamContainer: document.getElementById('slope-m-param-container'),
                slopeBParamContainer: document.getElementById('slope-b-param-container'),
                
                // Challenge controls
                challengeControls: document.getElementById('challenge-controls'),
                challengeDescription: document.getElementById('challenge-description'),
                challengeProgress: document.getElementById('challenge-progress'),
                challengeScore: document.getElementById('challenge-score'),
                challengeTotal: document.getElementById('challenge-total'),
                
                // Badge controls
                badgeControls: document.getElementById('badge-controls'),
                explorerBadge: document.getElementById('explorer-badge'),
                detectiveBadge: document.getElementById('detective-badge'),
                masterBadge: document.getElementById('master-badge'),
                creativeBadge: document.getElementById('creative-badge'),
                quickBadge: document.getElementById('quick-badge'),
                overallProgress: document.getElementById('overall-progress'),
                playerLevel: document.getElementById('player-level'),
                
                // Modal
                modal: document.getElementById('modal'),
                modalTitle: document.getElementById('modal-title'),
                modalText: document.getElementById('modal-text'),
                modalClose: document.getElementById('modal-close'),
                modalQuizContainer: document.getElementById('modal-quiz-container'),
                
                // Menu buttons
                startAdventure: document.getElementById('start-adventure'),
                freePlay: document.getElementById('free-play'),
                miniGames: document.getElementById('mini-games'),
                backToMenu: document.getElementById('back-to-menu'),
                backFromChallenges: document.getElementById('back-from-challenges'),
                
                // Level completion
                levelCompletion: document.getElementById('level-completion'),
                nextLevel: document.getElementById('next-level'),
                replayLevel: document.getElementById('replay-level'),
                
                // Other controls
                togglePanel: document.getElementById('toggle-panel'),
                mapNodes: document.querySelectorAll('.map-node'),
                challengeCards: document.querySelectorAll('.challenge-card'),
                tooltip: document.getElementById('tooltip'),
                confettiContainer: document.getElementById('confetti-container')
            };
        }

        function setupEventListeners() {
            // Navigation buttons
            elements.menuButton.addEventListener('click', () => switchMode('menu'));
            elements.areaButton.addEventListener('click', () => switchMode('area'));
            elements.slopeButton.addEventListener('click', () => switchMode('slope'));
            elements.challengeButton.addEventListener('click', () => switchMode('challenge'));
            elements.badgeButton.addEventListener('click', () => switchMode('badges'));
            
            // Area controls
            elements.shapeCount.addEventListener('input', () => {
                const value = elements.shapeCount.value;
                elements.shapeCountValue.textContent = value;
                gameState.areaParams.shapeCount = parseInt(value);
                
                if (value > 30) {
                    updateCharacterSpeech(characterSpeeches.manyRectangles);
                } else if (value < 10) {
                    updateCharacterSpeech(characterSpeeches.fewRectangles);
                }
                
                playSound('slider');
                redraw(); // Redraw the canvas
                
                // Check for challenge completion
                if (gameState.mode === 'challenge' && gameState.challengeState.currentChallenge) {
                    checkChallengeStep();
                }
            });
            
            elements.functionType.addEventListener('change', () => {
                gameState.areaParams.functionType = elements.functionType.value;
                updateFunctionParamDisplays();
                updateCharacterSpeech(characterSpeeches.functionChange);
                playSound('select');
                redraw(); // Redraw the canvas
                
                // Check for challenge completion
                if (gameState.mode === 'challenge' && gameState.challengeState.currentChallenge) {
                    checkChallengeStep();
                }
            });
            
            elements.mParam.addEventListener('input', () => {
                const value = elements.mParam.value;
                elements.mParamValue.textContent = value;
                gameState.areaParams.m = parseFloat(value);
                playSound('slider');
                redraw(); // Redraw the canvas
                
                // Check for challenge completion
                if (gameState.mode === 'challenge' && gameState.challengeState.currentChallenge) {
                    checkChallengeStep();
                }
            });
            
            elements.bParam.addEventListener('input', () => {
                const value = elements.bParam.value;
                elements.bParamValue.textContent = value;
                gameState.areaParams.b = parseFloat(value);
                playSound('slider');
                redraw(); // Redraw the canvas
                
                // Check for challenge completion
                if (gameState.mode === 'challenge' && gameState.challengeState.currentChallenge) {
                    checkChallengeStep();
                }
            });
            
            elements.aParam.addEventListener('input', () => {
                const value = elements.aParam.value;
                elements.aParamValue.textContent = value;
                gameState.areaParams.a = parseFloat(value);
                playSound('slider');
                redraw(); // Redraw the canvas
                
                // Check for challenge completion
                if (gameState.mode === 'challenge' && gameState.challengeState.currentChallenge) {
                    checkChallengeStep();
                }
            });
            
            // Slope controls
            elements.pointX.addEventListener('input', () => {
                const value = elements.pointX.value;
                elements.pointXValue.textContent = value;
                gameState.slopeParams.x = parseFloat(value);
                
                // Calculate the derivative at this point for speech updates
                const x = map(parseFloat(value), 0, 1, -5, 5);
                
                let derivative;
                if (gameState.slopeParams.functionType === 'linear') {
                    derivative = gameState.slopeParams.m;
                } else if (gameState.slopeParams.functionType === 'quadratic') {
                    derivative = 2 * gameState.slopeParams.a * x;
                } else if (gameState.slopeParams.functionType === 'cubic') {
                    derivative = 3 * gameState.slopeParams.a * x * x;
                } else if (gameState.slopeParams.functionType === 'sine') {
                    derivative = Math.cos(x) * 2;
                } else if (gameState.slopeParams.functionType === 'exponential') {
                    derivative = Math.exp(x / 2) * 0.5;
                }
                
                // Update character speech based on slope
                if (Math.abs(derivative) > 2) {
                    updateCharacterSpeech(characterSpeeches.steepSlope);
                } else if (Math.abs(derivative) < 0.5) {
                    updateCharacterSpeech(characterSpeeches.flatSlope);
                }
                
                playSound('slider');
                redraw(); // Redraw the canvas
                
                // Check for challenge completion
                if (gameState.mode === 'challenge' && gameState.challengeState.currentChallenge) {
                    checkChallengeStep();
                }
            });
            
            elements.derivativeFunction.addEventListener('change', () => {
                gameState.slopeParams.functionType = elements.derivativeFunction.value;
                updateDerivativeFunctionParamDisplays();
                updateCharacterSpeech(characterSpeeches.functionChange);
                playSound('select');
                redraw(); // Redraw the canvas
                
                // Check for challenge completion
                if (gameState.mode === 'challenge' && gameState.challengeState.currentChallenge) {
                    checkChallengeStep();
                }
            });
            
            elements.slopeMParam.addEventListener('input', () => {
                const value = elements.slopeMParam.value;
                elements.slopeMParamValue.textContent = value;
                gameState.slopeParams.m = parseFloat(value);
                playSound('slider');
                redraw(); // Redraw the canvas
                
                // Check for challenge completion
                if (gameState.mode === 'challenge' && gameState.challengeState.currentChallenge) {
                    checkChallengeStep();
                }
            });
            
            elements.slopeBParam.addEventListener('input', () => {
                const value = elements.slopeBParam.value;
                elements.slopeBParamValue.textContent = value;
                gameState.slopeParams.b = parseFloat(value);
                playSound('slider');
                redraw(); // Redraw the canvas
                
                // Check for challenge completion
                if (gameState.mode === 'challenge' && gameState.challengeState.currentChallenge) {
                    checkChallengeStep();
                }
            });
            
            elements.slopeAParam.addEventListener('input', () => {
                const value = elements.slopeAParam.value;
                elements.slopeAParamValue.textContent = value;
                gameState.slopeParams.a = parseFloat(value);
                playSound('slider');
                redraw(); // Redraw the canvas
                
                // Check for challenge completion
                if (gameState.mode === 'challenge' && gameState.challengeState.currentChallenge) {
                    checkChallengeStep();
                }
            });
            
            // Menu buttons
            elements.startAdventure.addEventListener('click', () => {
                gameState.currentSubmenu = 'adventure';
                elements.menuContainer.style.background = 'linear-gradient(135deg, #4b6cb7, #182848)';
                elements.gameLevels.style.display = 'block';
                elements.challengeContainer.style.display = 'none';
                playSound('click');
            });
            
            elements.freePlay.addEventListener('click', () => {
                elements.menuContainer.style.display = 'none';
                switchMode('area');
                playSound('click');
            });
            
            elements.miniGames.addEventListener('click', () => {
                gameState.currentSubmenu = 'challenges';
                elements.menuContainer.style.background = 'linear-gradient(135deg, #834d9b, #d04ed6)';
                elements.gameLevels.style.display = 'none';
                elements.challengeContainer.style.display = 'flex';
                playSound('click');
            });
            
            elements.backToMenu.addEventListener('click', () => {
                gameState.currentSubmenu = null;
                elements.menuContainer.style.background = 'linear-gradient(135deg, #c33764, #1d2671)';
                elements.gameLevels.style.display = 'none';
                playSound('click');
            });
            
            elements.backFromChallenges.addEventListener('click', () => {
                gameState.currentSubmenu = null;
                elements.menuContainer.style.background = 'linear-gradient(135deg, #c33764, #1d2671)';
                elements.challengeContainer.style.display = 'none';
                playSound('click');
            });
            
            // Level nodes
            elements.mapNodes.forEach(node => {
                node.addEventListener('click', () => {
                    const level = parseInt(node.dataset.level);
                    if (gameState.unlockedLevels.includes(level)) {
                        startLevel(level);
                        playSound('click');
                    } else {
                        playSound('error');
                        showTooltip(node, 'This level is locked! Complete the previous levels first.');
                    }
                });
                
                // Add hover sound
                node.addEventListener('mouseenter', () => {
                    if (gameState.unlockedLevels.includes(parseInt(node.dataset.level))) {
                        playSound('hover');
                    }
                });
            });
            
            // Challenge cards
            elements.challengeCards.forEach(card => {
                card.addEventListener('click', () => {
                    const challenge = card.dataset.challenge;
                    startChallenge(challenge);
                    elements.menuContainer.style.display = 'none';
                    playSound('click');
                });
                
                // Add hover sound
                card.addEventListener('mouseenter', () => {
                    playSound('hover');
                });
            });
            
            // Modal close button
            elements.modalClose.addEventListener('click', () => {
                if (gameState.mode === 'challenge' && elements.modalQuizContainer.style.display === 'block') {
                    checkChallengeQuizAnswer();
                } else {
                    hideModal();
                }
                playSound('click');
            });
            
            // Level completion buttons
            elements.nextLevel.addEventListener('click', () => {
                elements.levelCompletion.classList.remove('show');
                startLevel(gameState.currentLevel + 1);
                playSound('click');
            });
            
            elements.replayLevel.addEventListener('click', () => {
                elements.levelCompletion.classList.remove('show');
                startLevel(gameState.currentLevel);
                playSound('click');
            });
            
            // Toggle panel button
            elements.togglePanel.addEventListener('click', () => {
                togglePanel();
                playSound('click');
            });
            
            // Character interaction
            elements.professorX.addEventListener('click', () => {
                makeCharacterJump();
                showRandomTip();
                playSound('character');
            });
            
            // Add hover sound to all buttons
            const buttons = document.querySelectorAll('button');
            buttons.forEach(button => {
                button.addEventListener('mouseenter', () => {
                    playSound('hover');
                });
            });
        }

        function drawCharacter() {
            const characterEl = elements.professorX;
            
            // Create a more engaging character using CSS
            characterEl.innerHTML = `
                <div style="position: absolute; width: 100%; height: 100%; border-radius: 50% 50% 20% 20%; background: linear-gradient(135deg, #6a11cb, #2575fc); overflow: hidden;">
                    <div style="position: absolute; width: 30px; height: 30px; background: white; border-radius: 50%; top: 20px; left: 15px; border: 3px solid #333; overflow: hidden;">
                        <div style="position: absolute; width: 15px; height: 15px; background: #333; border-radius: 50%; top: 5px; left: 5px;"></div>
                    </div>
                    <div style="position: absolute; width: 30px; height: 30px; background: white; border-radius: 50%; top: 20px; right: 15px; border: 3px solid #333; overflow: hidden;">
                        <div style="position: absolute; width: 15px; height: 15px; background: #333; border-radius: 50%; top: 5px; left: 5px;"></div>
                    </div>
                    <div style="position: absolute; width: 40px; height: 15px; background: white; border-radius: 10px; bottom: 25px; left: 30px;">
                        <div style="position: absolute; width: 30px; height: 5px; background: #ff6b6b; border-radius: 5px; bottom: 5px; left: 5px;"></div>
                    </div>
                    <div style="position: absolute; width: 60px; height: 15px; border-radius: 50%; border-top: 5px solid #333; top: 10px; left: 20px; border-left: none; border-right: none; border-bottom: none;"></div>
                </div>
            `;
        }

        /******************************************
         * GAME MODES AND NAVIGATION
         ******************************************/
        function switchMode(mode) {
            gameState.mode = mode;
            
            // Reset active button states
            document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
            
            // Hide all control panels
            document.querySelectorAll('.panel-section').forEach(panel => panel.classList.remove('active'));
            
            // Handle mode-specific setup
            if (mode === 'menu') {
                elements.menuContainer.style.display = 'flex';
                elements.menuButton.classList.add('active');
                updateCharacterSpeech(characterSpeeches.welcome);
            } else {
                elements.menuContainer.style.display = 'none';
                
                if (mode === 'area') {
                    elements.areaControls.classList.add('active');
                    elements.areaButton.classList.add('active');
                    updateCharacterSpeech(characterSpeeches.areaMode);
                    
                    // Adjust parameter display based on function type
                    updateFunctionParamDisplays();
                } else if (mode === 'slope') {
                    elements.slopeControls.classList.add('active');
                    elements.slopeButton.classList.add('active');
                    updateCharacterSpeech(characterSpeeches.slopeMode);
                    
                    // Adjust parameter display based on function type
                    updateDerivativeFunctionParamDisplays();
                } else if (mode === 'challenge') {
                    elements.challengeControls.classList.add('active');
                    elements.challengeButton.classList.add('active');
                    updateCharacterSpeech(characterSpeeches.challengeMode);
                    
                    // If no challenge is active, show modal with challenge options
                    if (!gameState.challengeState.currentChallenge) {
                        showModal('Choose a Challenge', 
                                 'Select a challenge to test your knowledge and earn badges!',
                                 'Back to Menu');
                        
                        elements.modalClose.onclick = () => {
                            hideModal();
                            switchMode('menu');
                        };
                    }
                } else if (mode === 'badges') {
                    elements.badgeControls.classList.add('active');
                    elements.badgeButton.classList.add('active');
                    updateCharacterSpeech(characterSpeeches.badgeMode);
                    
                    // Update badge display
                    updateBadgeDisplay();
                }
            }
            
            playSound('mode');
            
            // Redraw canvas with the new mode
            redraw();
        }

        function updateFunctionParamDisplays() {
            const functionType = elements.functionType.value;
            
            // Hide all parameter containers first
            elements.mParamContainer.style.display = 'none';
            elements.bParamContainer.style.display = 'none';
            elements.aParamContainer.style.display = 'none';
            
            if (functionType === 'linear') {
                elements.mParamContainer.style.display = 'block';
                elements.bParamContainer.style.display = 'block';
            } else if (functionType === 'quadratic' || functionType === 'cubic') {
                elements.aParamContainer.style.display = 'block';
                elements.bParamContainer.style.display = 'block';
            } else if (functionType === 'sine') {
                elements.bParamContainer.style.display = 'block';
            } else if (functionType === 'exponential') {
                elements.bParamContainer.style.display = 'block';
            }
        }

        function updateDerivativeFunctionParamDisplays() {
            const functionType = elements.derivativeFunction.value;
            
            // Hide all parameter containers first
            elements.slopeMParamContainer.style.display = 'none';
            elements.slopeBParamContainer.style.display = 'none';
            elements.slopeAParamContainer.style.display = 'none';
            
            if (functionType === 'linear') {
                elements.slopeMParamContainer.style.display = 'block';
                elements.slopeBParamContainer.style.display = 'block';
            } else if (functionType === 'quadratic' || functionType === 'cubic') {
                elements.slopeAParamContainer.style.display = 'block';
                elements.slopeBParamContainer.style.display = 'block';
            } else if (functionType === 'sine') {
                elements.slopeBParamContainer.style.display = 'block';
            } else if (functionType === 'exponential') {
                elements.slopeBParamContainer.style.display = 'block';
            }
        }

        function updateCharacterSpeech(text) {
            elements.characterSpeech.textContent = text;
            makeCharacterJump();
        }

        function makeCharacterJump() {
            elements.professorX.style.animation = 'bounce 0.5s';
            
            setTimeout(() => {
                elements.professorX.style.animation = '';
            }, 500);
        }

        function showModal(title, text, buttonText = 'Continue', showQuiz = false, questionIndex = null) {
            elements.modalTitle.textContent = title;
            elements.modalText.textContent = text;
            elements.modalClose.textContent = buttonText;
            
            if (showQuiz && questionIndex !== null) {
                // Set up quiz question
                const currentChallenge = challenges[gameState.challengeState.currentChallenge];
                const step = currentChallenge.steps[gameState.challengeState.currentStep];
                
                elements.modalQuizContainer.style.display = 'block';
                elements.modalQuizContainer.innerHTML = `
                    <div class="quiz-question">${step.question}</div>
                    <div class="quiz-options">
                        ${step.options.map((option, index) => `
                            <div class="quiz-option" data-index="${index}">${option}</div>
                        `).join('')}
                    </div>
                `;
                
                // Add event listeners to quiz options
                const optionElements = elements.modalQuizContainer.querySelectorAll('.quiz-option');
                optionElements.forEach(option => {
                    option.addEventListener('click', () => {
                        // Clear previous selections
                        optionElements.forEach(opt => opt.classList.remove('selected'));
                        
                        // Select this option
                        option.classList.add('selected');
                        gameState.challengeState.selectedOption = parseInt(option.dataset.index);
                        
                        playSound('select');
                    });
                    
                    // Add hover sound
                    option.addEventListener('mouseenter', () => {
                        playSound('hover');
                    });
                });
            } else {
                elements.modalQuizContainer.style.display = 'none';
            }
            
            elements.modal.style.display = 'flex';
        }

        function hideModal() {
            elements.modal.classList.add('closing');
            
            setTimeout(() => {
                elements.modal.style.display = 'none';
                elements.modal.classList.remove('closing');
            }, 500);
        }

        function togglePanel() {
            gameState.panelMinimized = !gameState.panelMinimized;
            
            if (gameState.panelMinimized) {
                elements.sidePanel.classList.add('minimized');
                elements.togglePanel.textContent = '‚â´';
            } else {
                elements.sidePanel.classList.remove('minimized');
                elements.togglePanel.textContent = '‚â™';
            }
        }

        function showTooltip(element, text) {
            const tooltip = elements.tooltip;
            tooltip.textContent = text;
            
            const rect = element.getBoundingClientRect();
            tooltip.style.left = `${rect.left + rect.width / 2 - 100}px`;
            tooltip.style.top = `${rect.bottom + 10}px`;
            tooltip.style.opacity = '1';
            
            // Hide the tooltip after 2 seconds
            setTimeout(() => {
                tooltip.style.opacity = '0';
            }, 2000);
        }

        function showRandomTip() {
            const tips = [
                "Try adjusting the number of rectangles to see how the area calculation becomes more accurate!",
                "Did you know? The derivative of a function tells you how quickly it's changing at any point.",
                "The integral of a constant c is c*x + C, where C is another constant.",
                "The more rectangles we use, the closer we get to the true area under a curve!",
                "Try different function types to see how their derivatives and integrals behave.",
                "The derivative of sin(x) is cos(x), and the derivative of cos(x) is -sin(x)!",
                "Complete challenges to earn cool badges and unlock new levels!",
                "Click on me anytime for helpful tips and facts about calculus!",
                "The slope of a curve at a point is exactly the same as the derivative at that point.",
                "Calculus is used in physics, engineering, economics, and many other fields!"
            ];
            
            const randomTip = tips[Math.floor(Math.random() * tips.length)];
            updateCharacterSpeech(randomTip);
        }

        /******************************************
         * CHALLENGE AND LEVEL MANAGEMENT
         ******************************************/
        function startChallenge(challengeId) {
            const challenge = challenges[challengeId];
            
            if (!challenge) {
                console.error(`Challenge ${challengeId} not found!`);
                return;
            }
            
            // Reset challenge state
            gameState.challengeState.currentChallenge = challengeId;
            gameState.challengeState.currentStep = 0;
            gameState.challengeState.totalSteps = challenge.steps.length;
            gameState.challengeState.score = 0;
            gameState.challengeState.startTime = Date.now();
            
            // Update UI
            elements.challengeDescription.innerHTML = `<h4>${challenge.title}</h4><p>${challenge.description}</p>`;
            elements.challengeProgress.style.width = '0%';
            elements.challengeScore.textContent = '0';
            elements.challengeTotal.textContent = challenge.steps.length;
            
            // Switch to appropriate mode based on challenge type
            if (challengeId.includes('area')) {
                switchMode('area');
            } else if (challengeId.includes('slope')) {
                switchMode('slope');
            } else {
                switchMode('area'); // Default to area mode
            }
            
            // Show the first step
            showChallengeStep();
        }

        function showChallengeStep() {
            const challenge = challenges[gameState.challengeState.currentChallenge];
            const step = challenge.steps[gameState.challengeState.currentStep];
            
            if (!step) {
                console.error('No step found!');
                return;
            }
            
            // Handle different step types
            if (step.type === 'tutorial') {
                showModal(step.title, step.content, 'Continue');
                elements.modalClose.onclick = () => {
                    hideModal();
                    advanceChallengeStep();
                };
            } else if (step.type === 'interactive') {
                showModal(step.title, step.task, 'I\'ll try it!');
                elements.modalClose.onclick = () => {
                    hideModal();
                    
                    // Update character speech with hint
                    updateCharacterSpeech(step.hint);
                };
            } else if (step.type === 'quiz') {
                showModal(step.title || 'Quiz Question', step.question, 'Submit Answer', true, gameState.challengeState.currentStep);
            } else if (step.type === 'success') {
                showModal(step.title, step.content, 'Awesome!');
                elements.modalClose.onclick = () => {
                    hideModal();
                    completeChallenge();
                };
            }
        }

        function checkChallengeStep() {
            const challenge = challenges[gameState.challengeState.currentChallenge];
            const step = challenge.steps[gameState.challengeState.currentStep];
            
            if (step.type === 'interactive' && step.checkCondition()) {
                playSound('success');
                updateCharacterSpeech(characterSpeeches.correctAnswer);
                
                // Delay before showing completion message
                setTimeout(() => {
                    showConfetti