<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shape Math Adventure: Discover Integrals & Derivatives</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #f0f8ff;
            font-family: 'Comic Sans MS', 'Chalkboard SE', sans-serif;
            color: #333;
        }
        #game-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        #header {
            text-align: center;
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            border-radius: 0 0 15px 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        #canvas-container {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        #game-canvas {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-radius: 15px;
        }
        #controls {
            position: absolute;
            right: 20px;
            top: 20px;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            max-width: 250px;
        }
        #character-speech {
            position: absolute;
            left: 20px;
            bottom: 20px;
            background-color: white;
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            max-width: 300px;
            min-height: 100px;
        }
        #modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }
        #modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 80%;
            max-height: 80%;
            overflow: auto;
            text-align: center;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            margin: 5px;
            border-radius: 10px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
        }
        button:hover {
            background-color: #45a049;
            transform: scale(1.05);
        }
        .slider-container {
            margin: 15px 0;
        }
        .slider-container label {
            display: block;
            margin-bottom: 5px;
        }
        input[type="range"] {
            width: 100%;
        }
        h1, h2, h3 {
            margin-top: 0;
        }
        h1 {
            font-size: 1.8em;
        }
        h2 {
            font-size: 1.5em;
        }
        .mode-button {
            margin-bottom: 10px;
            width: 100%;
        }
        .character {
            position: absolute;
            bottom: 130px;
            left: 40px;
            width: 100px;
            height: 100px;
            transition: all 0.3s;
        }
        #confetti-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 50;
        }
        .quiz-option {
            background-color: #f1f1f1;
            border: 2px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .quiz-option:hover {
            background-color: #e9e9e9;
            transform: scale(1.02);
        }
        .quiz-option.selected {
            background-color: #d4edda;
            border-color: #4CAF50;
        }
        .quiz-option.correct {
            background-color: #d4edda;
            border-color: #28a745;
        }
        .quiz-option.wrong {
            background-color: #f8d7da;
            border-color: #dc3545;
        }
        .progress-container {
            width: 100%;
            background-color: #ddd;
            border-radius: 10px;
            margin: 10px 0;
        }
        .progress-bar {
            width: 0%;
            height: 20px;
            background-color: #4CAF50;
            border-radius: 10px;
            transition: width 0.5s;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="header">
            <h1>Shape Math Adventure: Discover Integrals & Derivatives</h1>
        </div>
        <div id="canvas-container">
            <canvas id="game-canvas"></canvas>
            <div id="controls">
                <h2>Controls</h2>
                <div id="mode-controls">
                    <button class="mode-button" id="area-mode">Area Mode</button>
                    <button class="mode-button" id="slope-mode">Slope Mode</button>
                    <button class="mode-button" id="quiz-mode">Quiz Mode</button>
                </div>
                <div id="area-controls" style="display: none;">
                    <div class="slider-container">
                        <label for="shape-count">Number of Rectangles:</label>
                        <input type="range" id="shape-count" min="1" max="50" value="10">
                        <span id="shape-count-value">10</span>
                    </div>
                    <div class="slider-container">
                        <label for="function-type">Function Type:</label>
                        <select id="function-type">
                            <option value="linear">Linear (y = mx + b)</option>
                            <option value="quadratic">Quadratic (y = ax² + b)</option>
                            <option value="sine">Sine Wave (y = sin(x))</option>
                        </select>
                    </div>
                    <div class="slider-container" id="m-param-container">
                        <label for="m-param">Slope (m):</label>
                        <input type="range" id="m-param" min="-2" max="2" step="0.1" value="1">
                        <span id="m-param-value">1</span>
                    </div>
                    <div class="slider-container" id="b-param-container">
                        <label for="b-param">y-intercept (b):</label>
                        <input type="range" id="b-param" min="-3" max="3" step="0.1" value="0">
                        <span id="b-param-value">0</span>
                    </div>
                    <div class="slider-container" id="a-param-container" style="display: none;">
                        <label for="a-param">Quadratic coefficient (a):</label>
                        <input type="range" id="a-param" min="-1" max="1" step="0.1" value="0.5">
                        <span id="a-param-value">0.5</span>
                    </div>
                </div>
                <div id="slope-controls" style="display: none;">
                    <div class="slider-container">
                        <label for="point-x">Point Position (x):</label>
                        <input type="range" id="point-x" min="0" max="1" step="0.01" value="0.5">
                        <span id="point-x-value">0.5</span>
                    </div>
                    <div class="slider-container">
                        <label for="derivative-function">Function:</label>
                        <select id="derivative-function">
                            <option value="linear">Linear (y = mx + b)</option>
                            <option value="quadratic">Quadratic (y = ax² + b)</option>
                            <option value="sine">Sine Wave (y = sin(x))</option>
                        </select>
                    </div>
                    <div class="slider-container" id="slope-m-param-container">
                        <label for="slope-m-param">Slope (m):</label>
                        <input type="range" id="slope-m-param" min="-2" max="2" step="0.1" value="1">
                        <span id="slope-m-param-value">1</span>
                    </div>
                    <div class="slider-container" id="slope-b-param-container">
                        <label for="slope-b-param">y-intercept (b):</label>
                        <input type="range" id="slope-b-param" min="-3" max="3" step="0.1" value="0">
                        <span id="slope-b-param-value">0</span>
                    </div>
                    <div class="slider-container" id="slope-a-param-container" style="display: none;">
                        <label for="slope-a-param">Quadratic coefficient (a):</label>
                        <input type="range" id="slope-a-param" min="-1" max="1" step="0.1" value="0.5">
                        <span id="slope-a-param-value">0.5</span>
                    </div>
                </div>
                <div id="quiz-controls" style="display: none;">
                    <div class="progress-container">
                        <div class="progress-bar" id="quiz-progress"></div>
                    </div>
                    <p>Correct: <span id="correct-count">0</span> / <span id="total-questions">10</span></p>
                </div>
            </div>
            <div id="character-speech">
                <p>Hi! I'm Professor Pixel! I'm going to help you learn about area and slopes with shapes. Click on one of the mode buttons to get started!</p>
            </div>
            <div class="character" id="professor-pixel"></div>
            <div id="confetti-container"></div>
        </div>
    </div>

    <div id="modal">
        <div id="modal-content">
            <h2 id="modal-title">Welcome!</h2>
            <p id="modal-text">Let's learn about shapes, areas, and slopes!</p>
            <div id="modal-quiz-container" style="display: none;"></div>
            <button id="modal-close">Continue</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"></script>
    <script>
        // Sound effects system
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();

        // Create basic oscillator sounds
        function createOscillator(type, frequency, duration) {
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            
            oscillator.type = type;
            oscillator.frequency.value = frequency;
            gainNode.gain.value = 0.3;
            
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            oscillator.start();
            
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
            oscillator.stop(audioCtx.currentTime + duration);
        }

        // Different sound effects
        const sounds = {
            correct: () => {
                createOscillator('sine', 523.25, 0.2); // C5
                setTimeout(() => createOscillator('sine', 659.25, 0.3), 200); // E5
                setTimeout(() => createOscillator('sine', 783.99, 0.5), 500); // G5
            },
            wrong: () => {
                createOscillator('sawtooth', 196.00, 0.3); // G3
                setTimeout(() => createOscillator('sawtooth', 185.00, 0.5), 300); // F#3
            },
            click: () => {
                createOscillator('sine', 440, 0.1); // A4
            },
            hover: () => {
                createOscillator('sine', 330, 0.05); // E4
            },
            celebration: () => {
                createOscillator('sine', 523.25, 0.2); // C5
                setTimeout(() => createOscillator('sine', 659.25, 0.2), 200); // E5
                setTimeout(() => createOscillator('sine', 783.99, 0.2), 400); // G5
                setTimeout(() => createOscillator('sine', 1046.50, 0.5), 600); // C6
            }
        };

        // Game state
        const gameState = {
            mode: 'welcome', // 'welcome', 'area', 'slope', 'quiz'
            areaParams: {
                shapeCount: 10,
                functionType: 'linear',
                m: 1,
                b: 0,
                a: 0.5
            },
            slopeParams: {
                x: 0.5,
                functionType: 'linear',
                m: 1,
                b: 0,
                a: 0.5
            },
            quizState: {
                currentQuestion: 0,
                correctAnswers: 0,
                totalQuestions: 10,
                selectedOption: null
            },
            showingConfetti: false
        };

        // Quiz questions
        const quizQuestions = [
            {
                question: "What does a derivative tell us about a function?",
                options: [
                    "The area under the function",
                    "The slope of the function at a point",
                    "The total value of the function",
                    "The color of the function"
                ],
                correctIndex: 1,
                explanation: "The derivative tells us the slope (or rate of change) of a function at any point. It's like measuring how steep a hill is at different spots!"
            },
            {
                question: "What does an integral help us find?",
                options: [
                    "The area under a curve",
                    "The height of a curve",
                    "The width of a curve",
                    "The color of a curve"
                ],
                correctIndex: 0,
                explanation: "An integral helps us find the area under a curve. Think of it as counting up all the tiny rectangles that fit under the curve!"
            },
            {
                question: "If we have more rectangles under a curve, what happens to our area calculation?",
                options: [
                    "It gets less accurate",
                    "It stays the same",
                    "It gets more accurate",
                    "It becomes blue"
                ],
                correctIndex: 2,
                explanation: "More rectangles means a more accurate area calculation because the rectangles follow the curve more closely."
            },
            {
                question: "The slope of a line y = mx + b is:",
                options: [
                    "x",
                    "y",
                    "m",
                    "b"
                ],
                correctIndex: 2,
                explanation: "In the equation y = mx + b, the m value tells us the slope of the line!"
            },
            {
                question: "What is the derivative of the function y = x²?",
                options: [
                    "y = 2x",
                    "y = x",
                    "y = x³",
                    "y = 0"
                ],
                correctIndex: 0,
                explanation: "The derivative of x² is 2x! This tells us the slope at any point on the curve y = x²."
            },
            {
                question: "If a car's position is given by s = t², its velocity (the derivative) is:",
                options: [
                    "v = t",
                    "v = 2t",
                    "v = t²",
                    "v = 0"
                ],
                correctIndex: 1,
                explanation: "Velocity is the derivative of position with respect to time. The derivative of t² is 2t!"
            },
            {
                question: "The integral of a constant function f(x) = 4 is:",
                options: [
                    "F(x) = 4x + C",
                    "F(x) = 4",
                    "F(x) = 0",
                    "F(x) = 8x"
                ],
                correctIndex: 0,
                explanation: "When we integrate a constant like 4, we get 4x + C, where C is a constant. This is because the derivative of 4x + C is 4!"
            },
            {
                question: "What shape calculates the area under a linear function most accurately?",
                options: [
                    "Circles",
                    "Triangles",
                    "Rectangles with equal width",
                    "Trapezoids"
                ],
                correctIndex: 3,
                explanation: "Trapezoids calculate the area under a linear function exactly! This is because they perfectly match the slant of the line."
            },
            {
                question: "If we know the derivative of a function at every point, we can find the original function by:",
                options: [
                    "Differentiation",
                    "Integration",
                    "Multiplication",
                    "Division"
                ],
                correctIndex: 1,
                explanation: "Integration is the reverse process of differentiation. If we know the derivative, we can find the original function by integrating!"
            },
            {
                question: "What happens to the slope of y = x² as x gets bigger?",
                options: [
                    "The slope decreases",
                    "The slope stays the same",
                    "The slope increases",
                    "The slope becomes zero"
                ],
                correctIndex: 2,
                explanation: "The slope of y = x² is 2x, which gets bigger as x increases. That's why the parabola gets steeper as you move away from the origin!"
            }
        ];

        // Character speeches for different modes and interactions
        const characterSpeeches = {
            welcome: "Hi! I'm Professor Pixel! I'm going to help you learn about area and slopes with shapes. Click on one of the mode buttons to get started!",
            areaIntro: "In Area Mode, we're exploring integrals! An integral helps us find the area under a curve by adding up lots of tiny shapes. Try changing the number of rectangles with the slider!",
            slopeIntro: "In Slope Mode, we're exploring derivatives! A derivative tells us the slope of a curve at any point. Move the point along the curve to see how the slope changes!",
            quizIntro: "Let's test what you've learned with a fun quiz! Answer the questions about integrals and derivatives to show your knowledge!",
            manyRectangles: "Wow! Look at all those rectangles! The more rectangles we use, the more accurate our area calculation becomes. This is getting close to a perfect integral!",
            fewRectangles: "With just a few rectangles, we get a rough estimate of the area. Adding more rectangles makes our calculation more accurate!",
            steepSlope: "The slope is really steep here! The derivative (slope) has a large value when the curve changes quickly.",
            flatSlope: "The slope is almost flat here! When the derivative (slope) is close to zero, the curve barely changes at that point.",
            correctAnswer: "Great job! That's correct! You're understanding integrals and derivatives like a mathematician!",
            wrongAnswer: "Not quite, but that's okay! Learning math is about trying different ideas. Let's look at why this answer works.",
            quizComplete: "Amazing! You've completed the quiz. You're really getting the hang of these calculus concepts!"
        };

        // DOM Elements
        const elements = {
            areaMode: document.getElementById('area-mode'),
            slopeMode: document.getElementById('slope-mode'),
            quizMode: document.getElementById('quiz-mode'),
            areaControls: document.getElementById('area-controls'),
            slopeControls: document.getElementById('slope-controls'),
            quizControls: document.getElementById('quiz-controls'),
            characterSpeech: document.getElementById('character-speech'),
            professorPixel: document.getElementById('professor-pixel'),
            shapeCount: document.getElementById('shape-count'),
            shapeCountValue: document.getElementById('shape-count-value'),
            functionType: document.getElementById('function-type'),
            mParam: document.getElementById('m-param'),
            mParamValue: document.getElementById('m-param-value'),
            bParam: document.getElementById('b-param'),
            bParamValue: document.getElementById('b-param-value'),
            aParam: document.getElementById('a-param'),
            aParamValue: document.getElementById('a-param-value'),
            aParamContainer: document.getElementById('a-param-container'),
            pointX: document.getElementById('point-x'),
            pointXValue: document.getElementById('point-x-value'),
            derivativeFunction: document.getElementById('derivative-function'),
            slopeMParam: document.getElementById('slope-m-param'),
            slopeMParamValue: document.getElementById('slope-m-param-value'),
            slopeBParam: document.getElementById('slope-b-param'),
            slopeBParamValue: document.getElementById('slope-b-param-value'),
            slopeAParam: document.getElementById('slope-a-param'),
            slopeAParamValue: document.getElementById('slope-a-param-value'),
            slopeAParamContainer: document.getElementById('slope-a-param-container'),
            quizProgress: document.getElementById('quiz-progress'),
            correctCount: document.getElementById('correct-count'),
            totalQuestions: document.getElementById('total-questions'),
            modal: document.getElementById('modal'),
            modalTitle: document.getElementById('modal-title'),
            modalText: document.getElementById('modal-text'),
            modalClose: document.getElementById('modal-close'),
            modalQuizContainer: document.getElementById('modal-quiz-container'),
            mParamContainer: document.getElementById('m-param-container'),
            bParamContainer: document.getElementById('b-param-container'),
            slopeMParamContainer: document.getElementById('slope-m-param-container'),
            slopeBParamContainer: document.getElementById('slope-b-param-container')
        };

        // Set up the canvas and p5.js
        let mainCanvas;

        function setup() {
            const canvasContainer = document.getElementById('canvas-container');
            const w = Math.min(canvasContainer.clientWidth, canvasContainer.clientHeight) * 0.8;
            const h = w;
            
            mainCanvas = createCanvas(w, h);
            mainCanvas.parent('game-canvas');
            
            frameRate(30);
            colorMode(RGB, 255, 255, 255, 1);
            textAlign(CENTER, CENTER);
            textFont('Comic Sans MS, Chalkboard SE, sans-serif');
            
            // Initialize character
            drawCharacter();

            // Show welcome message
            showModal('Welcome to Shape Math Adventure!', 
                      'Hi there, young mathematician! I\'m Professor Pixel, and I\'m excited to teach you about some really cool math concepts called derivatives and integrals. Don\'t worry if these words sound big - we\'ll make them super fun and easy to understand with shapes and colors! Ready to become a math wizard?', 
                      'Let\'s Go!');
        }

        function draw() {
            background(240, 248, 255);
            
            // Draw coordinate system
            drawCoordinateSystem();
            
            // Draw based on current mode
            switch(gameState.mode) {
                case 'area':
                    drawAreaMode();
                    break;
                case 'slope':
                    drawSlopeMode();
                    break;
                case 'quiz':
                    drawQuizMode();
                    break;
                default:
                    // Just show the coordinate system for welcome mode
                    break;
            }
            
            // Draw confetti if active
            if (gameState.showingConfetti) {
                drawConfetti();
            }
        }

        function drawCoordinateSystem() {
            // Draw axes
            stroke(100);
            strokeWeight(2);
            
            // x-axis
            line(0, height/2, width, height/2);
            
            // y-axis
            line(width/2, 0, width/2, height);
            
            // Draw grid lines
            strokeWeight(0.5);
            stroke(200);
            
            // Horizontal grid lines
            for (let y = 0; y < height; y += height/10) {
                line(0, y, width, y);
            }
            
            // Vertical grid lines
            for (let x = 0; x < width; x += width/10) {
                line(x, 0, x, height);
            }
            
            // Label axes
            noStroke();
            fill(50);
            textSize(16);
            text("x", width - 15, height/2 + 20);
            text("y", width/2 + 20, 15);
        }

        function drawAreaMode() {
            const { shapeCount, functionType, m, b, a } = gameState.areaParams;
            
            // Draw the function curve
            stroke(0, 100, 200);
            strokeWeight(3);
            noFill();
            
            beginShape();
            for (let px = 0; px <= width; px += 2) {
                const x = map(px, 0, width, -5, 5);
                let y;
                
                if (functionType === 'linear') {
                    y = m * x + b;
                } else if (functionType === 'quadratic') {
                    y = a * x * x + b;
                } else if (functionType === 'sine') {
                    y = sin(x) * 2 + b;
                }
                
                const py = map(y, 5, -5, 0, height);
                vertex(px, py);
            }
            endShape();
            
            // Draw the rectangles under the curve
            const rectWidth = width / shapeCount;
            
            for (let i = 0; i < shapeCount; i++) {
                const px = i * rectWidth;
                const x = map(px + rectWidth/2, 0, width, -5, 5);
                
                let y;
                if (functionType === 'linear') {
                    y = m * x + b;
                } else if (functionType === 'quadratic') {
                    y = a * x * x + b;
                } else if (functionType === 'sine') {
                    y = sin(x) * 2 + b;
                }
                
                const py = map(y, 5, -5, 0, height);
                const rectHeight = abs(py - height/2);
                
                fill(255, 200, 200, 0.6);
                stroke(200, 0, 0);
                strokeWeight(1);
                
                if (y > 0) {
                    rect(px, py, rectWidth, height/2 - py);
                } else {
                    rect(px, height/2, rectWidth, py - height/2);
                }
            }
            
            // Draw area calculation text
            textSize(18);
            fill(50);
            noStroke();
            
            let totalArea = 0;
            const dx = 10 / shapeCount;
            
            for (let i = 0; i < shapeCount; i++) {
                const x = map(i, 0, shapeCount, -5, 5);
                
                let y;
                if (functionType === 'linear') {
                    y = m * x + b;
                } else if (functionType === 'quadratic') {
                    y = a * x * x + b;
                } else if (functionType === 'sine') {
                    y = sin(x) * 2 + b;
                }
                
                totalArea += y * dx;
            }
            
            text(`Approximate Area: ${abs(totalArea).toFixed(2)} square units`, width/2, height - 20);
            
            // Draw function equation
            textSize(16);
            fill(0, 100, 200);
            noStroke();
            
            let equation;
            if (functionType === 'linear') {
                equation = `f(x) = ${m.toFixed(1)}x + ${b.toFixed(1)}`;
            } else if (functionType === 'quadratic') {
                equation = `f(x) = ${a.toFixed(1)}x² + ${b.toFixed(1)}`;
            } else if (functionType === 'sine') {
                equation = `f(x) = sin(x) * 2 + ${b.toFixed(1)}`;
            }
            
            text(equation, width/2, 30);
            
            // Draw integral notation
            textSize(16);
            fill(200, 0, 0);
            text(`∫f(x)dx = Area under the curve`, width/2, 55);
        }

        function drawSlopeMode() {
            const { x, functionType, m, b, a } = gameState.slopeParams;
            
            // Draw the function curve
            stroke(0, 100, 200);
            strokeWeight(3);
            noFill();
            
            beginShape();
            for (let px = 0; px <= width; px += 2) {
                const x = map(px, 0, width, -5, 5);
                let y;
                
                if (functionType === 'linear') {
                    y = m * x + b;
                } else if (functionType === 'quadratic') {
                    y = a * x * x + b;
                } else if (functionType === 'sine') {
                    y = sin(x) * 2 + b;
                }
                
                const py = map(y, 5, -5, 0, height);
                vertex(px, py);
            }
            endShape();
            
            // Calculate the point on the curve
            const px = map(x, 0, 1, 0, width);
            const xValue = map(px, 0, width, -5, 5);
            
            let yValue;
            if (functionType === 'linear') {
                yValue = m * xValue + b;
            } else if (functionType === 'quadratic') {
                yValue = a * xValue * xValue + b;
            } else if (functionType === 'sine') {
                yValue = sin(xValue) * 2 + b;
            }
            
            const py = map(yValue, 5, -5, 0, height);
            
            // Calculate the derivative at the point
            let derivative;
            if (functionType === 'linear') {
                derivative = m;
            } else if (functionType === 'quadratic') {
                derivative = 2 * a * xValue;
            } else if (functionType === 'sine') {
                derivative = cos(xValue) * 2;
            }
            
            // Draw the tangent line
            stroke(200, 100, 0);
            strokeWeight(2);
            
            const x1 = px - 50;
            const y1 = py - derivative * 50 * 10 / width;
            const x2 = px + 50;
            const y2 = py + derivative * 50 * 10 / width;
            
            line(x1, y1, x2, y2);
            
            // Draw the point on the curve
            fill(255, 0, 0);
            stroke(150, 0, 0);
            strokeWeight(1);
            ellipse(px, py, 10, 10);
            
            // Draw slope calculation text
            textSize(18);
            fill(50);
            noStroke();
            
            text(`Slope at x = ${xValue.toFixed(2)}: ${derivative.toFixed(2)}`, width/2, height - 20);
            
            // Draw function equation
            textSize(16);
            fill(0, 100, 200);
            noStroke();
            
            let equation;
            if (functionType === 'linear') {
                equation = `f(x) = ${m.toFixed(1)}x + ${b.toFixed(1)}`;
            } else if (functionType === 'quadratic') {
                equation = `f(x) = ${a.toFixed(1)}x² + ${b.toFixed(1)}`;
            } else if (functionType === 'sine') {
                equation = `f(x) = sin(x) * 2 + ${b.toFixed(1)}`;
            }
            
            text(equation, width/2, 30);
            
            // Draw derivative notation
            textSize(16);
            fill(200, 100, 0);
            
            let derivativeEquation;
            if (functionType === 'linear') {
                derivativeEquation = `f'(x) = ${m.toFixed(1)}`;
            } else if (functionType === 'quadratic') {
                derivativeEquation = `f'(x) = ${(2 * a).toFixed(1)}x`;
            } else if (functionType === 'sine') {
                derivativeEquation = `f'(x) = 2cos(x)`;
            }
            
            text(`${derivativeEquation} = Slope of the tangent line`, width/2, 55);
        }

        function drawQuizMode() {
            // Quiz mode is handled by the HTML, nothing to draw in canvas
            textSize(24);
            fill(50);
            noStroke();
            text("Quiz Mode Active!", width/2, height/2);
            
            textSize(18);
            text("Answer the questions in the quiz box!", width/2, height/2 + 40);
        }

        function drawCharacter() {
            const characterEl = document.getElementById('professor-pixel');
            
            // Create a character using CSS
            characterEl.style.backgroundColor = '#4CAF50';
            characterEl.style.borderRadius = '50% 50% 0 0';
            characterEl.innerHTML = `
                <div style="position: absolute; width: 25px; height: 25px; background-color: white; border-radius: 50%; top: 20px; left: 20px; border: 2px solid #333;"></div>
                <div style="position: absolute; width: 25px; height: 25px; background-color: white; border-radius: 50%; top: 20px; right: 20px; border: 2px solid #333;"></div>
                <div style="position: absolute; width: 10px; height: 10px; background-color: #333; border-radius: 50%; top: 25px; left: 27px;"></div>
                <div style="position: absolute; width: 10px; height: 10px; background-color: #333; border-radius: 50%; top: 25px; right: 27px;"></div>
                <div style="position: absolute; width: 40px; height: 15px; background-color: #FFF; border-radius: 10px; bottom: 25px; left: 30px; border: 2px solid #333;"></div>
                <div style="position: absolute; width: 20px; height: 7px; background-color: #4CAF50; border-radius: 10px; bottom: 15px; left: 40px;"></div>
            `;
        }

        function makeCharacterJump() {
            const characterEl = document.getElementById('professor-pixel');
            characterEl.style.transform = 'translateY(-20px)';
            
            setTimeout(() => {
                characterEl.style.transform = 'translateY(0)';
            }, 300);
        }

        function updateCharacterSpeech(text) {
            const speechEl = document.getElementById('character-speech');
            speechEl.innerHTML = `<p>${text}</p>`;
            makeCharacterJump();
        }

        function showModal(title, text, buttonText = 'Continue', showQuiz = false, questionIndex = 0) {
            elements.modalTitle.textContent = title;
            elements.modalText.textContent = text;
            elements.modalClose.textContent = buttonText;
            
            if (showQuiz) {
                // Set up quiz question
                const question = quizQuestions[questionIndex];
                elements.modalQuizContainer.style.display = 'block';
                elements.modalQuizContainer.innerHTML = `
                    <h3>${question.question}</h3>
                    <div class="quiz-options">
                        ${question.options.map((option, index) => `
                            <div class="quiz-option" data-index="${index}">${option}</div>
                        `).join('')}
                    </div>
                `;
                
                // Add event listeners to quiz options
                const optionElements = elements.modalQuizContainer.querySelectorAll('.quiz-option');
                optionElements.forEach(option => {
                    option.addEventListener('click', () => {
                        // Clear previous selections
                        optionElements.forEach(opt => opt.classList.remove('selected'));
                        
                        // Select this option
                        option.classList.add('selected');
                        gameState.quizState.selectedOption = parseInt(option.dataset.index);
                    });
                    
                    // Add sound effects on hover
                    option.addEventListener('mouseenter', () => {
                        sounds.hover();
                    });
                });
                
                // Change button text
                elements.modalClose.textContent = 'Submit Answer';
            } else {
                elements.modalQuizContainer.style.display = 'none';
            }
            
            elements.modal.style.display = 'flex';
        }

        function hideModal() {
            elements.modal.style.display = 'none';
        }

        function showConfetti() {
            gameState.showingConfetti = true;
            sounds.celebration();
            
            setTimeout(() => {
                gameState.showingConfetti = false;
            }, 3000);
        }

        function drawConfetti() {
            for (let i = 0; i < 100; i++) {
                const x = random(width);
                const y = random(height);
                const size = random(5, 15);
                const r = random(100, 255);
                const g = random(100, 255);
                const b = random(100, 255);
                
                fill(r, g, b);
                noStroke();
                
                const shapeType = floor(random(3));
                if (shapeType === 0) {
                    ellipse(x, y, size, size);
                } else if (shapeType === 1) {
                    rect(x, y, size, size);
                } else {
                    triangle(x, y, x + size/2, y - size, x + size, y);
                }
            }
        }

        function switchMode(mode) {
            gameState.mode = mode;
            
            // Hide all control panels
            elements.areaControls.style.display = 'none';
            elements.slopeControls.style.display = 'none';
            elements.quizControls.style.display = 'none';
            
            // Show appropriate controls
            if (mode === 'area') {
                elements.areaControls.style.display = 'block';
                updateCharacterSpeech(characterSpeeches.areaIntro);
                
                // Adjust parameter display based on function type
                updateFunctionParamDisplays();
            } else if (mode === 'slope') {
                elements.slopeControls.style.display = 'block';
                updateCharacterSpeech(characterSpeeches.slopeIntro);
                
                // Adjust parameter display based on function type
                updateDerivativeFunctionParamDisplays();
            } else if (mode === 'quiz') {
                elements.quizControls.style.display = 'block';
                updateCharacterSpeech(characterSpeeches.quizIntro);
                
                // Reset quiz state
                gameState.quizState.currentQuestion = 0;
                gameState.quizState.correctAnswers = 0;
                elements.correctCount.textContent = '0';
                elements.quizProgress.style.width = '0%';
                
                // Show first question
                showQuizQuestion(0);
            }
            
            sounds.click();
        }

        function updateFunctionParamDisplays() {
            const functionType = elements.functionType.value;
            
            if (functionType === 'linear') {
                elements.mParamContainer.style.display = 'block';
                elements.bParamContainer.style.display = 'block';
                elements.aParamContainer.style.display = 'none';
            } else if (functionType === 'quadratic') {
                elements.mParamContainer.style.display = 'none';
                elements.bParamContainer.style.display = 'block';
                elements.aParamContainer.style.display = 'block';
            } else if (functionType === 'sine') {
                elements.mParamContainer.style.display = 'none';
                elements.bParamContainer.style.display = 'block';
                elements.aParamContainer.style.display = 'none';
            }
        }

        function updateDerivativeFunctionParamDisplays() {
            const functionType = elements.derivativeFunction.value;
            
            if (functionType === 'linear') {
                elements.slopeMParamContainer.style.display = 'block';
                elements.slopeBParamContainer.style.display = 'block';
                elements.slopeAParamContainer.style.display = 'none';
            } else if (functionType === 'quadratic') {
                elements.slopeMParamContainer.style.display = 'none';
                elements.slopeBParamContainer.style.display = 'block';
                elements.slopeAParamContainer.style.display = 'block';
            } else if (functionType === 'sine') {
                elements.slopeMParamContainer.style.display = 'none';
                elements.slopeBParamContainer.style.display = 'block';
                elements.slopeAParamContainer.style.display = 'none';
            }
        }

        function showQuizQuestion(index) {
            const question = quizQuestions[index];
            showModal(
                `Question ${index + 1} of ${quizQuestions.length}`,
                question.question,
                'Submit Answer',
                true,
                index
            );
        }

        function checkQuizAnswer() {
            const currentQuestion = quizQuestions[gameState.quizState.currentQuestion];
            const selectedOption = gameState.quizState.selectedOption;
            
            if (selectedOption === null) {
                // No answer selected
                return;
            }
            
            const isCorrect = selectedOption === currentQuestion.correctIndex;
            
            // Mark the options as correct/wrong
            const optionElements = elements.modalQuizContainer.querySelectorAll('.quiz-option');
            optionElements.forEach((option, index) => {
                if (index === currentQuestion.correctIndex) {
                    option.classList.add('correct');
                } else if (index === selectedOption && !isCorrect) {
                    option.classList.add('wrong');
                }
            });
            
            // Update quiz state
            if (isCorrect) {
                gameState.quizState.correctAnswers++;
                elements.correctCount.textContent = gameState.quizState.correctAnswers;
                updateCharacterSpeech(characterSpeeches.correctAnswer);
                sounds.correct();
            } else {
                updateCharacterSpeech(characterSpeeches.wrongAnswer);
                sounds.wrong();
            }
            
            // Show explanation
            elements.modalText.textContent = currentQuestion.explanation;
            elements.modalClose.textContent = 'Next Question';
            
            // Remove click handlers from options
            optionElements.forEach(option => {
                option.style.pointerEvents = 'none';
            });
            
            // Update progress bar
            const progress = ((gameState.quizState.currentQuestion + 1) / gameState.quizState.totalQuestions) * 100;
            elements.quizProgress.style.width = `${progress}%`;
            
            // Change modal button to go to next question
            elements.modalClose.onclick = () => {
                gameState.quizState.currentQuestion++;
                gameState.quizState.selectedOption = null;
                
                if (gameState.quizState.currentQuestion < quizQuestions.length) {
                    showQuizQuestion(gameState.quizState.currentQuestion);
                } else {
                    // Quiz complete
                    completeQuiz();
                }
            };
        }

        function completeQuiz() {
            const score = gameState.quizState.correctAnswers;
            const total = quizQuestions.length;
            const percentage = Math.round((score / total) * 100);
            
            let resultMessage;
            
            if (percentage >= 90) {
                resultMessage = `Incredible! You got ${score} out of ${total} correct (${percentage}%)! You're a calculus prodigy!`;
                showConfetti();
            } else if (percentage >= 70) {
                resultMessage = `Great job! You got ${score} out of ${total} correct (${percentage}%)! You've learned a lot about derivatives and integrals!`;
            } else {
                resultMessage = `You got ${score} out of ${total} correct (${percentage}%). Learning calculus takes time - keep exploring the area and slope modes to understand better!`;
            }
            
            showModal('Quiz Complete!', resultMessage, 'Play Again');
            updateCharacterSpeech(characterSpeeches.quizComplete);
            
            elements.modalClose.onclick = () => {
                hideModal();
                switchMode('welcome');
            };
        }

        // Event listeners
        window.addEventListener('load', () => {
            // Mode buttons
            elements.areaMode.addEventListener('click', () => switchMode('area'));
            elements.slopeMode.addEventListener('click', () => switchMode('slope'));
            elements.quizMode.addEventListener('click', () => switchMode('quiz'));
            
            // Area controls
            elements.shapeCount.addEventListener('input', () => {
                const value = elements.shapeCount.value;
                elements.shapeCountValue.textContent = value;
                gameState.areaParams.shapeCount = parseInt(value);
                
                if (value > 30) {
                    updateCharacterSpeech(characterSpeeches.manyRectangles);
                } else if (value < 10) {
                    updateCharacterSpeech(characterSpeeches.fewRectangles);
                }
                
                sounds.hover();
            });
            
            elements.functionType.addEventListener('change', () => {
                gameState.areaParams.functionType = elements.functionType.value;
                updateFunctionParamDisplays();
                sounds.click();
            });
            
            elements.mParam.addEventListener('input', () => {
                const value = elements.mParam.value;
                elements.mParamValue.textContent = value;
                gameState.areaParams.m = parseFloat(value);
                sounds.hover();
            });
            
            elements.bParam.addEventListener('input', () => {
                const value = elements.bParam.value;
                elements.bParamValue.textContent = value;
                gameState.areaParams.b = parseFloat(value);
                sounds.hover();
            });
            
            elements.aParam.addEventListener('input', () => {
                const value = elements.aParam.value;
                elements.aParamValue.textContent = value;
                gameState.areaParams.a = parseFloat(value);
                sounds.hover();
            });
            
            // Slope controls
            elements.pointX.addEventListener('input', () => {
                const value = elements.pointX.value;
                elements.pointXValue.textContent = value;
                gameState.slopeParams.x = parseFloat(value);
                
                // Calculate the derivative at this point
                const x = parseFloat(value);
                const xValue = map(x, 0, 1, -5, 5);
                
                let derivative;
                if (gameState.slopeParams.functionType === 'linear') {
                    derivative = gameState.slopeParams.m;
                } else if (gameState.slopeParams.functionType === 'quadratic') {
                    derivative = 2 * gameState.slopeParams.a * xValue;
                } else if (gameState.slopeParams.functionType === 'sine') {
                    derivative = cos(xValue) * 2;
                }
                
                // Update character speech based on slope
                if (abs(derivative) > 2) {
                    updateCharacterSpeech(characterSpeeches.steepSlope);
                } else if (abs(derivative) < 0.5) {
                    updateCharacterSpeech(characterSpeeches.flatSlope);
                }
                
                sounds.hover();
            });
            
            elements.derivativeFunction.addEventListener('change', () => {
                gameState.slopeParams.functionType = elements.derivativeFunction.value;
                updateDerivativeFunctionParamDisplays();
                sounds.click();
            });
            
            elements.slopeMParam.addEventListener('input', () => {
                const value = elements.slopeMParam.value;
                elements.slopeMParamValue.textContent = value;
                gameState.slopeParams.m = parseFloat(value);
                sounds.hover();
            });
            
            elements.slopeBParam.addEventListener('input', () => {
                const value = elements.slopeBParam.value;
                elements.slopeBParamValue.textContent = value;
                gameState.slopeParams.b = parseFloat(value);
                sounds.hover();
            });
            
            elements.slopeAParam.addEventListener('input', () => {
                const value = elements.slopeAParam.value;
                elements.slopeAParamValue.textContent = value;
                gameState.slopeParams.a = parseFloat(value);
                sounds.hover();
            });
            
            // Modal
            elements.modalClose.addEventListener('click', () => {
                if (gameState.mode === 'quiz' && elements.modalQuizContainer.style.display === 'block') {
                    checkQuizAnswer();
                } else {
                    hideModal();
                }
                sounds.click();
            });
            
            // Add sound effects to buttons
            const buttons = document.querySelectorAll('button');
            buttons.forEach(button => {
                button.addEventListener('mouseenter', () => {
                    sounds.hover();
                });
            });
        });

        // Helper functions
        function map(value, start1, stop1, start2, stop2) {
            return start2 + (stop2 - start2) * ((value - start1) / (stop1 - start1));
        }

        function random(min, max) {
            if (max === undefined) {
                max = min;
                min = 0;
            }
            return min + Math.random() * (max - min);
        }

        function floor(value) {
            return Math.floor(value);
        }

        function sin(angle) {
            return Math.sin(angle);
        }

        function cos(angle) {
            return Math.cos(angle);
        }

        function abs(value) {
            return Math.abs(value);
        }

        // Start the p5.js sketch
        new p5(null, document.getElementById('canvas-container'));
    </script>
</body>
</html>