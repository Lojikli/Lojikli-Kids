<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multiplication Masters</title>
    <style>
        /* Base styles with colorful theme for children */
        body {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #f8d568 0%, #ffb347 100%);
            color: #333;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        /* Header & Game Info */
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .game-title {
            color: #ff6b6b;
            font-size: 32px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        .game-info {
            display: flex;
            gap: 20px;
        }
        
        .score, .level {
            background-color: #ff6b6b;
            color: white;
            padding: 10px 20px;
            border-radius: 50px;
            font-size: 18px;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        /* Problem Display Area */
        .problem-display {
            position: relative;
            margin: 40px auto;
            max-width: 500px;
            background-color: #f9f9f9;
            border-radius: 15px;
            padding: 20px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
        }
        
        .multiplication-problem {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            font-family: monospace;
            font-size: 40px;
            font-weight: bold;
            color: #ff6b6b;
        }
        
        .problem-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            position: relative;
        }
        
        .operator {
            margin-right: 10px;
        }
        
        .number-container {
            display: flex;
        }
        
        .digit {
            width: 40px;
            height: 50px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            margin: 0 5px;
        }
        
        .digit.operand {
            color: #ff6b6b;
        }
        
        .digit.result {
            color: #5b6afd;
        }
        
        .carry {
            position: absolute;
            top: -20px;
            right: 5px;
            font-size: 20px;
            color: #ff9e7d;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .carry.visible {
            opacity: 1;
        }
        
        .line {
            height: 3px;
            background-color: #5b6afd;
            margin: 10px 0;
            width: 100%;
        }
        
        /* Work Area */
        .work-area {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }
        
        .partial-product {
            display: flex;
            margin: 5px 0;
            color: #5b6afd;
            font-family: monospace;
            font-size: 30px;
        }
        
        /* Current step input */
        .current-step {
            display: flex;
            flex-direction: column;
            margin-top: 30px;
            align-items: center;
            background-color: rgba(255, 107, 107, 0.1);
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        
        .step-prompt {
            font-size: 20px;
            font-weight: bold;
            color: #ff6b6b;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .step-input-container {
            display: flex;
        }
        
        .step-input {
            width: 40px;
            height: 40px;
            font-size: 28px;
            text-align: center;
            border: 2px solid #ff6b6b;
            border-radius: 8px;
            margin-right: 5px;
            background-color: #fff9f0;
            color: #ff6b6b;
            font-family: monospace;
        }
        
        .step-input:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.3);
            transform: scale(1.05);
        }
        
        .step-input.highlight {
            animation: pulse 1s infinite;
            border-color: gold;
            box-shadow: 0 0 15px 5px rgba(255, 215, 0, 0.5);
        }
        
        .carry-input {
            width: 30px;
            height: 30px;
            font-size: 18px;
            position: absolute;
            top: -25px;
            border: 2px solid #ff9e7d;
            border-radius: 8px;
            text-align: center;
            background-color: #fff9f0;
            color: #ff9e7d;
        }
        
        .carry-input:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(255, 158, 125, 0.3);
        }
        
        /* Feedback area */
        .feedback {
            text-align: center;
            font-size: 24px;
            margin: 20px 0;
            min-height: 30px;
            transition: all 0.3s ease;
        }
        
        .feedback.correct {
            color: #2ecc71;
        }
        
        .feedback.incorrect {
            color: #e74c3c;
        }
        
        /* Navigation buttons */
        .navigation {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }
        
        .nav-button {
            padding: 12px 30px;
            font-size: 18px;
            font-weight: bold;
            background-color: #ff6b6b;
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .nav-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 10px rgba(0,0,0,0.2);
        }
        
        .nav-button:active {
            transform: translateY(1px);
            box-shadow: 0 2px 3px rgba(0,0,0,0.2);
        }
        
        .nav-button:disabled {
            background-color: #ffb5b5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .help-button {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background-color: #ff6b6b;
            color: white;
            font-size: 24px;
            font-weight: bold;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        /* Achievement badges */
        .awards {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }
        
        .award {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            opacity: 0.3;
            transition: all 0.3s ease;
        }
        
        .award.earned {
            opacity: 1;
            background-color: gold;
            animation: pulse 0.5s ease;
        }
        
        /* Help modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            position: relative;
        }
        
        .modal-title {
            font-size: 24px;
            color: #ff6b6b;
            margin-bottom: 20px;
        }
        
        .close-button {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 24px;
            cursor: pointer;
            color: #ff6b6b;
        }
        
        /* Animations */
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .celebrating {
            animation: pulse 0.5s ease infinite;
        }
        
        /* Confetti animation */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background-color: #f0f;
            clip-path: polygon(50% 0%, 90% 20%, 100% 60%, 75% 100%, 25% 100%, 0% 60%, 10% 20%);
            animation: fall 5s linear forwards;
            z-index: 1000;
        }
        
        @keyframes fall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
        }
        
        .red { background-color: #ff6b6b; }
        .blue { background-color: #5b6afd; }
        .green { background-color: #2ecc71; }
        .yellow { background-color: #f1c40f; }
        .purple { background-color: #9b59b6; }
        
        /* Special case for highlight */
        .highlight {
            box-shadow: 0 0 10px 3px gold;
            animation: pulse 1s infinite;
        }

        /* NEW STYLES FOR FIXED VERSION */
        
        /* Input group styling */
        .input-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0 8px;
        }

        .inputs-row {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 15px;
        }

        .inputs-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }

        .input-label {
            font-size: 14px;
            font-weight: bold;
            color: #ff6b6b;
            margin-bottom: 5px;
            text-align: center;
        }

        .product-hint {
            font-size: 16px;
            color: #5b6afd;
            margin-top: 10px;
            background-color: rgba(91, 106, 253, 0.1);
            padding: 5px 10px;
            border-radius: 10px;
        }

        /* Special input styles for result vs carry */
        .step-input.result-digit {
            border-color: #ff6b6b;
            background-color: #fff0f0;
        }

        .carry-input {
            width: 30px;
            height: 30px;
            font-size: 18px;
            border: 2px solid #ff9e7d;
            border-radius: 8px;
            text-align: center;
            background-color: #fff9f0;
            color: #ff9e7d;
            position: relative;
        }

        /* Instruction text */
        .instruction {
            font-size: 14px;
            font-style: italic;
            color: #5b6afd;
            margin-top: 5px;
        }

        /* Addition step specific styles */
        .addition-inputs-container {
            display: flex;
            flex-direction: row;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .addition-input-group {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .position-label {
            font-size: 12px;
            color: #5b6afd;
            margin-bottom: 5px;
        }

        /* Improve carry display */
        .carry {
            position: absolute;
            top: -20px;
            right: 5px;
            font-size: 18px;
            color: #ff9e7d;
            opacity: 0;
            transition: opacity 0.3s ease;
            background-color: rgba(255, 248, 240, 0.7);
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
        }

        /* Improve the step prompt area */
        .current-step {
            display: flex;
            flex-direction: column;
            margin-top: 30px;
            align-items: center;
            background-color: rgba(255, 107, 107, 0.1);
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        /* Better highlighting for active elements */
        .highlight {
            box-shadow: 0 0 15px 5px rgba(255, 215, 0, 0.7);
            animation: pulse 1.5s infinite;
            position: relative;
            z-index: 5;
        }

        /* Help modal improvements */
        .modal-content ol li {
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .modal-content h3 {
            color: #ff6b6b;
            margin-top: 20px;
            margin-bottom: 10px;
        }

        /* Add a section about right-to-left order to the help modal */
        .multiplication-order-tip {
            background-color: #f0f8ff;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #5b6afd;
        }

        /* Make sure digit displays are correctly aligned */
        .work-area {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            width: 100%;
            margin-top: 15px;
        }
        
        /* Quick Tips */
        .quick-tips {
            background-color: #fff0f0;
            padding: 12px;
            border-radius: 10px;
            margin-top: 10px;
            font-size: 14px;
            line-height: 1.4;
        }
        
        /* Quick Start Modal */
        .quick-start-modal {
            text-align: center;
        }
        
        .quick-start-modal p {
            margin-bottom: 15px;
            font-size: 16px;
        }
        
        .quick-start-button {
            font-size: 20px;
            padding: 15px 40px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <!-- Main game container -->
    <div class="container">
        <!-- Game header with title and score -->
        <div class="game-header">
            <div class="game-title">Multiplication Masters</div>
            <div class="game-info">
                <div class="level">Level: <span id="level">1</span></div>
                <div class="score">Score: <span id="score">0</span></div>
            </div>
        </div>
        
        <!-- Help button -->
        <button class="help-button" id="help-button">?</button>
        
        <!-- Problem display area -->
        <div class="problem-display">
            <div class="multiplication-problem" id="multiplication-problem">
                <!-- Problem will be generated here by JavaScript -->
            </div>
            
            <!-- Current step input -->
            <div class="current-step" id="current-step">
                <div class="step-prompt" id="step-prompt">Multiply the digits:</div>
                <div class="step-input-container" id="step-input-container">
                    <!-- Step inputs will be generated here -->
                </div>
            </div>
        </div>
        
        <!-- Feedback display -->
        <div class="feedback" id="feedback"></div>
        
        <!-- Navigation buttons -->
        <div class="navigation">
            <button class="nav-button" id="check-button">Check</button>
            <button class="nav-button" id="next-button">Next Step</button>
            <button class="nav-button" id="new-problem-button">New Problem</button>
        </div>
        
        <!-- Achievement badges -->
        <div class="awards">
            <div class="award" id="award-speed" title="Speed Multiplier">⚡</div>
            <div class="award" id="award-streak" title="Streak Master">🔥</div>
            <div class="award" id="award-perfect" title="Perfect Solution">🌟</div>
            <div class="award" id="award-level" title="Level Master">🏆</div>
        </div>
    </div>
    
    <!-- Quick Start Modal -->
    <div class="modal" id="quick-start-modal">
        <div class="modal-content quick-start-modal">
            <div class="modal-title">Welcome to Multiplication Masters!</div>
            <p>Practice long multiplication step by step. You'll solve problems by entering one digit at a time.</p>
            <div class="quick-tips">
                <strong>Quick Tips:</strong>
                <ul>
                    <li>Work from right to left</li>
                    <li>For products over 9, write the ones digit and carry the tens digit</li>
                    <li>Press '?' anytime for more help</li>
                </ul>
            </div>
            <button class="nav-button quick-start-button" id="start-game-button">Start Game</button>
        </div>
    </div>
    
    <!-- Help modal -->
    <div class="modal" id="help-modal">
        <div class="modal-content">
            <div class="modal-title">How to Play Multiplication Masters</div>
            <span class="close-button" id="close-button">&times;</span>
            
            <p>Welcome to Multiplication Masters! This game will help you practice long multiplication step-by-step.</p>
            
            <h3>How to Solve Multiplication Problems</h3>
            <ol>
                <li><strong>Right-to-Left Order:</strong> In multiplication, we always work from right to left, starting with the rightmost digit of each number.</li>
                <li><strong>Multiply each digit:</strong> For each digit in the bottom number, multiply it by each digit in the top number (starting from the right).</li>
                <li><strong>Write down results:</strong> After multiplying two digits, write down the ones place digit and carry the tens place digit to the next column.</li>
                <li><strong>Create partial products:</strong> When multiplying by multi-digit numbers, each row creates a "partial product" that gets shifted based on place value.</li>
                <li><strong>Add up partial products:</strong> After all the multiplication steps, add the partial products to get your final answer.</li>
            </ol>
            
            <div class="multiplication-order-tip">
                <strong>Remember:</strong> Long multiplication always works from right to left. When you have a two-digit product (like 7×8=56), write down the 6 and carry the 5 to the next column.
            </div>
            
            <h3>Game Controls</h3>
            <ul>
                <li><strong>Enter key:</strong> Check your current answer</li>
                <li><strong>Space key:</strong> Start a new problem (when current one is complete)</li>
                <li><strong>Check button:</strong> Verify your current step</li>
                <li><strong>Next Step button:</strong> Skip to the next step</li>
                <li><strong>New Problem button:</strong> Generate a new multiplication problem</li>
            </ul>
            
            <p>Earn badges for speed, accuracy, and completing multiple problems in a row!</p>
            <p>Need help anytime? Just click the "?" button.</p>
            
            <button class="nav-button" id="start-tutorial">Start Tutorial</button>
        </div>
    </div>

    <script>
        class MultiplicationGame {
            constructor() {
                // Game state
                this.score = 0;
                this.level = 1;
                this.streak = 0;
                this.multiplier = 0;  // First number (top)
                this.multiplicand = 0; // Second number (bottom)
                this.currentStep = 0;
                this.currentDigit = 0;
                this.currentRow = 0;
                this.steps = [];
                this.solution = [];
                this.stepInputs = [];
                this.carryInputs = [];
                this.tutorialMode = false;
                this.perfectSolution = true;
                this.awards = {
                    speed: false,
                    streak: false,
                    perfect: false,
                    level: false
                };
                
                // Timing for speed award
                this.startTime = null;
                
                // Get DOM elements
                this.elements = {
                    multiplicationProblem: document.getElementById('multiplication-problem'),
                    feedback: document.getElementById('feedback'),
                    score: document.getElementById('score'),
                    level: document.getElementById('level'),
                    checkButton: document.getElementById('check-button'),
                    nextButton: document.getElementById('next-button'),
                    newProblemButton: document.getElementById('new-problem-button'),
                    awardSpeed: document.getElementById('award-speed'),
                    awardStreak: document.getElementById('award-streak'),
                    awardPerfect: document.getElementById('award-perfect'),
                    awardLevel: document.getElementById('award-level'),
                    helpButton: document.getElementById('help-button'),
                    modal: document.getElementById('help-modal'),
                    quickStartModal: document.getElementById('quick-start-modal'),
                    closeButton: document.getElementById('close-button'),
                    startTutorial: document.getElementById('start-tutorial'),
                    startGameButton: document.getElementById('start-game-button'),
                    stepPrompt: document.getElementById('step-prompt'),
                    stepInputContainer: document.getElementById('step-input-container'),
                    currentStep: document.getElementById('current-step')
                };
                
                // Initialize the game
                this.setupEventListeners();
                
                // Show quick start instead of full help
                this.showQuickStart();
            }
            
            // Setup event listeners for buttons and inputs
            setupEventListeners() {
                this.elements.checkButton.addEventListener('click', () => this.checkCurrentStep());
                this.elements.nextButton.addEventListener('click', () => this.navigateToNextStep());
                this.elements.newProblemButton.addEventListener('click', () => this.generateProblem());
                this.elements.helpButton.addEventListener('click', () => this.showHelp());
                this.elements.closeButton.addEventListener('click', () => this.closeHelp());
                this.elements.startTutorial.addEventListener('click', () => this.startTutorial());
                this.elements.startGameButton.addEventListener('click', () => this.startGame());
                
                // Add keyboard support
                document.addEventListener('keydown', (e) => {
                    // Enter key - check answer
                    if (e.key === 'Enter') {
                        this.checkCurrentStep();
                    }
                    // Space key - new problem when complete
                    else if (e.key === ' ' && this.currentStep >= this.solution.length) {
                        this.generateProblem();
                    }
                });
                
                // Disable the next button initially
                this.elements.nextButton.disabled = true;
            }
            
            // Show quick start modal
            showQuickStart() {
                this.elements.quickStartModal.style.display = 'flex';
            }
            
            // Start the game from quick start
            startGame() {
                this.elements.quickStartModal.style.display = 'none';
                this.generateProblem();
            }
            
            // Show help modal
            showHelp() {
                this.elements.modal.style.display = 'flex';
            }
            
            // Close help modal
            closeHelp() {
                this.elements.modal.style.display = 'none';
            }
            
            // Start tutorial mode
            startTutorial() {
                this.tutorialMode = true;
                this.closeHelp();
                this.generateProblem(true); // Generate a simple problem for tutorial
                
                // Tutorial sequence
                const problem = this.elements.multiplicationProblem;
                const topRow = problem.querySelector('.problem-row:nth-child(1)');
                const bottomRow = problem.querySelector('.problem-row:nth-child(2)');
                
                // Highlight first number
                topRow.classList.add('highlight');
                this.elements.feedback.textContent = "This is the first number we're multiplying";
                this.elements.feedback.className = 'feedback correct';
                
                setTimeout(() => {
                    topRow.classList.remove('highlight');
                    bottomRow.classList.add('highlight');
                    this.elements.feedback.textContent = "This is the second number - we'll multiply each of its digits by the first number";
                    
                    setTimeout(() => {
                        bottomRow.classList.remove('highlight');
                        this.elements.currentStep.classList.add('highlight');
                        this.elements.feedback.textContent = "We start by multiplying the rightmost digit of the second number by each digit of the first number, from right to left";
                        
                        setTimeout(() => {
                            this.elements.currentStep.classList.remove('highlight');
                            this.elements.checkButton.classList.add('highlight');
                            this.elements.feedback.textContent = "After entering each result, click 'Check' to see if you're right";
                            
                            setTimeout(() => {
                                this.elements.checkButton.classList.remove('highlight');
                                this.elements.feedback.textContent = "Try solving the problem! Click '?' if you need help.";
                            }, 3000);
                        }, 4000);
                    }, 4000);
                }, 3000);
            }
            
            // Generate a new multiplication problem
            generateProblem(isTutorial = false) {
                // Reset game state
                this.currentStep = 0;
                this.currentDigit = 0;
                this.currentRow = 0;
                this.steps = [];
                this.solution = [];
                this.stepInputs = [];
                this.carryInputs = [];
                
                // Generate numbers based on level
                if (isTutorial) {
                    // Simple tutorial problem
                    this.multiplier = 23;
                    this.multiplicand = 4;
                } else {
                    // Level 1: 1-digit x 1-digit
                    // Level 2-3: 1-digit x 2-digit
                    // Level 4-5: 2-digit x 2-digit
                    // Level 6+: 2-digit x 3-digit or 3-digit x 2-digit
                    
                    let multiplierDigits = 1;
                    let multiplicandDigits = 1;
                    
                    if (this.level <= 1) {
                        // 1-digit x 1-digit
                        multiplierDigits = 1;
                        multiplicandDigits = 1;
                    } else if (this.level <= 3) {
                        // 1-digit x 2-digit
                        multiplierDigits = 2;
                        multiplicandDigits = 1;
                    } else if (this.level <= 5) {
                        // 2-digit x 2-digit
                        multiplierDigits = 2;
                        multiplicandDigits = 2;
                    } else {
                        // 2-digit x 3-digit or 3-digit x 2-digit (randomly choose)
                        if (Math.random() < 0.5) {
                            multiplierDigits = 3;
                            multiplicandDigits = 2;
                        } else {
                            multiplierDigits = 2;
                            multiplicandDigits = 3;
                        }
                    }
                    
                    // Generate random numbers with appropriate number of digits
                    this.multiplier = this.generateRandomNumber(multiplierDigits);
                    this.multiplicand = this.generateRandomNumber(multiplicandDigits);
                }
                
                // Set up the problem display
                this.setupProblemDisplay();
                
                // Calculate solution steps
                this.calculateSolution();
                
                // Reset buttons
                this.elements.nextButton.disabled = true;
                
                // Update step inputs for first step
                this.updateStepInputs();
                
                // Start the timer for speed award
                this.startTime = new Date().getTime();
                
                // Reset perfect solution tracker
                this.perfectSolution = true;
                
                // Focus on first input
                if (this.stepInputs.length > 0) {
                    setTimeout(() => this.stepInputs[0].focus(), 100);
                }
            }
            
            // Generate a random number with specified number of digits
            generateRandomNumber(digits) {
                const min = Math.pow(10, digits - 1);
                const max = Math.pow(10, digits) - 1;
                return Math.floor(Math.random() * (max - min + 1)) + min;
            }
            
            // Setup the problem display
            setupProblemDisplay() {
                // Clear previous problem
                this.elements.multiplicationProblem.innerHTML = '';
                
                // Create top row (multiplier)
                const topRow = document.createElement('div');
                topRow.className = 'problem-row';
                this.elements.multiplicationProblem.appendChild(topRow);
                
                // Create multiplication operator and container for top number
                const operator = document.createElement('div');
                operator.className = 'operator';
                operator.innerText = '';
                topRow.appendChild(operator);
                
                const topNumberContainer = document.createElement('div');
                topNumberContainer.className = 'number-container';
                topRow.appendChild(topNumberContainer);
                
                // Add digits for top number
                const multiplierStr = this.multiplier.toString();
                for (let i = 0; i < multiplierStr.length; i++) {
                    const digitDiv = document.createElement('div');
                    digitDiv.className = 'digit operand';
                    digitDiv.innerText = multiplierStr[i];
                    topNumberContainer.appendChild(digitDiv);
                }
                
                // Create bottom row (multiplicand)
                const bottomRow = document.createElement('div');
                bottomRow.className = 'problem-row';
                this.elements.multiplicationProblem.appendChild(bottomRow);
                
                // Create multiplication operator and container for bottom number
                const bottomOperator = document.createElement('div');
                bottomOperator.className = 'operator';
                bottomOperator.innerText = '×';
                bottomRow.appendChild(bottomOperator);
                
                const bottomNumberContainer = document.createElement('div');
                bottomNumberContainer.className = 'number-container';
                bottomRow.appendChild(bottomNumberContainer);
                
                // Add digits for bottom number
                const multiplicandStr = this.multiplicand.toString();
                for (let i = 0; i < multiplicandStr.length; i++) {
                    const digitDiv = document.createElement('div');
                    digitDiv.className = 'digit operand';
                    digitDiv.innerText = multiplicandStr[i];
                    bottomNumberContainer.appendChild(digitDiv);
                }
                
                // Add multiplication line
                const line = document.createElement('div');
                line.className = 'line';
                this.elements.multiplicationProblem.appendChild(line);
                
                // Create work area for partial products
                const workArea = document.createElement('div');
                workArea.className = 'work-area';
                workArea.id = 'work-area';
                this.elements.multiplicationProblem.appendChild(workArea);
            }
            
            // Calculate all steps for the solution
            calculateSolution() {
                this.solution = [];
                
                // Convert numbers to strings for easier digit manipulation
                const multiplierStr = this.multiplier.toString();
                const multiplicandStr = this.multiplicand.toString();
                
                // For each digit in the multiplicand (from right to left)
                for (let i = multiplicandStr.length - 1; i >= 0; i--) {
                    const multiplicandDigit = parseInt(multiplicandStr[i]);
                    let carry = 0;
                    let partialProduct = [];
                    
                    // For each digit in the multiplier (from right to left)
                    for (let j = multiplierStr.length - 1; j >= 0; j--) {
                        const multiplierDigit = parseInt(multiplierStr[j]);
                        
                        // Multiply the digits and add any carry
                        const product = multiplierDigit * multiplicandDigit + carry;
                        
                        // The result digit is the ones place
                        const resultDigit = product % 10;
                        
                        // The new carry is the tens place (if any)
                        carry = Math.floor(product / 10);
                        
                        // Add this step to partial product (in reverse order)
                        partialProduct.unshift({
                            multiplierPosition: j,
                            multiplicandPosition: i,
                            multiplierDigit: multiplierDigit,
                            multiplicandDigit: multiplicandDigit,
                            product: product,
                            resultDigit: resultDigit,
                            carry: carry
                        });
                    }
                    
                    // If there's still a carry, add it as the leftmost digit
                    if (carry > 0) {
                        partialProduct.unshift({
                            multiplierPosition: -1, // Beyond leftmost position
                            multiplicandPosition: i,
                            multiplierDigit: 0,
                            multiplicandDigit: multiplicandDigit,
                            product: carry,
                            resultDigit: carry,
                            carry: 0
                        });
                    }
                    
                    // Add partial product row to solution
                    this.solution.push({
                        multiplicandPosition: i,
                        multiplicandDigit: multiplicandDigit,
                        partialProduct: partialProduct,
                        shifts: multiplicandStr.length - 1 - i // Number of right shifts
                    });
                }
                
                // Add the final addition step if there's more than one multiplicand digit
                if (multiplicandStr.length > 1) {
                    // Calculate final addition of partial products
                    // This would be done in the UI in steps
                    const finalResult = this.multiplier * this.multiplicand;
                    this.solution.push({
                        type: 'addition',
                        result: finalResult.toString()
                    });
                }
                
                console.log('Solution steps:', this.solution);
            }
            
            // Update the step inputs based on current step
            updateStepInputs() {
                // Clear previous inputs
                this.elements.stepInputContainer.innerHTML = '';
                this.stepInputs = [];
                this.carryInputs = [];
                
                if (this.currentStep >= this.solution.length) {
                    // All steps complete
                    this.elements.stepPrompt.textContent = "Multiplication complete!";
                    return;
                }
                
                const currentSolution = this.solution[this.currentStep];
                
                // Check if it's the final addition step
                if (currentSolution.type === 'addition') {
                    this.updateAdditionStepInputs();
                    return;
                }
                
                // Single-digit multiplication of partial product
                const currentPartialProduct = currentSolution.partialProduct;
                
                if (this.currentDigit >= currentPartialProduct.length) {
                    // All digits in current partial product are done
                    // Move to next partial product
                    this.currentStep++;
                    this.currentDigit = 0;
                    this.updateStepInputs();
                    return;
                }
                
                // Get the current digit step
                // Important: We need to access from the end to go right-to-left
                const digitStepIndex = currentPartialProduct.length - 1 - this.currentDigit;
                const digitStep = currentPartialProduct[digitStepIndex];
                
                // Create step prompt
                const multiplicandPosition = currentSolution.multiplicandPosition;
                const multiplicandDigit = currentSolution.multiplicandDigit;
                const multiplierPosition = digitStep.multiplierPosition;
                
                // If it's a valid position (not a carry-only step)
                if (multiplierPosition >= 0) {
                    const multiplierDigit = digitStep.multiplierDigit;
                    this.elements.stepPrompt.textContent = `Multiply ${multiplierDigit} × ${multiplicandDigit}:`;
                    
                    // Add small instruction for clarity
                    const instruction = document.createElement('div');
                    instruction.className = 'instruction';
                    instruction.textContent = 'Working right to left';
                    this.elements.stepPrompt.appendChild(instruction);
                    
                    // Create input for result (1 or 2 digits)
                    const product = digitStep.product;
                    
                    // Create a container to hold the input groups
                    const inputsContainer = document.createElement('div');
                    inputsContainer.className = 'inputs-container';
                    this.elements.stepInputContainer.appendChild(inputsContainer);
                    
                    // For single digit product
                    if (product < 10) {
                        // Create container for result input with label
                        const resultContainer = document.createElement('div');
                        resultContainer.className = 'input-group';
                        
                        const resultLabel = document.createElement('div');
                        resultLabel.className = 'input-label';
                        resultLabel.textContent = 'Result:';
                        
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.className = 'step-input';
                        input.maxLength = 1;
                        input.placeholder = "?";
                        
                        input.addEventListener('input', (e) => {
                            e.target.value = e.target.value.replace(/\D/g, '');
                            if (e.target.value) {
                                // Auto-check when digit is entered
                                setTimeout(() => this.checkCurrentStep(), 300);
                            }
                        });
                        
                        resultContainer.appendChild(resultLabel);
                        resultContainer.appendChild(input);
                        inputsContainer.appendChild(resultContainer);
                        
                        this.stepInputs.push(input);
                    } 
                    // For double digit product
                    else {
                        // Create a flex container for both inputs
                        const inputsRow = document.createElement('div');
                        inputsRow.className = 'inputs-row';
                        
                        // Create container for result digit input
                        const resultContainer = document.createElement('div');
                        resultContainer.className = 'input-group';
                        
                        const resultLabel = document.createElement('div');
                        resultLabel.className = 'input-label';
                        resultLabel.textContent = 'Write down:';
                        
                        // Input for ones place (result digit)
                        const resultInput = document.createElement('input');
                        resultInput.type = 'text';
                        resultInput.className = 'step-input result-digit';
                        resultInput.maxLength = 1;
                        resultInput.placeholder = "?";
                        
                        resultContainer.appendChild(resultLabel);
                        resultContainer.appendChild(resultInput);
                        
                        // Create container for carry digit input
                        const carryContainer = document.createElement('div');
                        carryContainer.className = 'input-group';
                        
                        const carryLabel = document.createElement('div');
                        carryLabel.className = 'input-label';
                        carryLabel.textContent = 'Carry:';
                        
                        // Input for carry (tens place)
                        const carryInput = document.createElement('input');
                        carryInput.type = 'text';
                        carryInput.className = 'carry-input';
                        carryInput.maxLength = 1;
                        carryInput.placeholder = "?";
                        
                        carryContainer.appendChild(carryLabel);
                        carryContainer.appendChild(carryInput);
                        
                        // Event listeners for inputs
                        resultInput.addEventListener('input', (e) => {
                            e.target.value = e.target.value.replace(/\D/g, '');
                            if (e.target.value) {
                                carryInput.focus();
                            }
                        });
                        
                        carryInput.addEventListener('input', (e) => {
                            e.target.value = e.target.value.replace(/\D/g, '');
                            if (e.target.value) {
                                // Auto-check when carry is entered
                                setTimeout(() => this.checkCurrentStep(), 300);
                            }
                        });
                        
                        // Add both input groups to the row
                        inputsRow.appendChild(resultContainer);
                        inputsRow.appendChild(carryContainer);
                        
                        // Add the row to the container
                        inputsContainer.appendChild(inputsRow);
                        
                        // Add a hint about the product
                        const productHint = document.createElement('div');
                        productHint.className = 'product-hint';
                        productHint.textContent = `${multiplierDigit} × ${multiplicandDigit} = ?`;
                        inputsContainer.appendChild(productHint);
                        
                        this.stepInputs.push(resultInput);
                        this.carryInputs.push(carryInput);
                    }
                } else {
                    // This is just placing the final carry
                    this.elements.stepPrompt.textContent = `Write the final carry:`;
                    
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'step-input';
                    input.maxLength = 1;
                    input.placeholder = "?";
                    
                    input.addEventListener('input', (e) => {
                        e.target.value = e.target.value.replace(/\D/g, '');
                        if (e.target.value) {
                            // Auto-check when digit is entered
                            setTimeout(() => this.checkCurrentStep(), 300);
                        }
                    });
                    
                    this.elements.stepInputContainer.appendChild(input);
                    this.stepInputs.push(input);
                }
                
                // Focus on first input
                if (this.stepInputs.length > 0) {
                    setTimeout(() => this.stepInputs[0].focus(), 100);
                }
            }
            
            // Update inputs for the final addition step
            updateAdditionStepInputs() {
                this.elements.stepPrompt.textContent = "Add the partial products to get the final answer:";
                
                // Create a small instruction for clarity
                const instruction = document.createElement('div');
                instruction.className = 'instruction';
                instruction.textContent = 'Work from right to left';
                this.elements.stepPrompt.appendChild(instruction);
                
                // Create a container to hold the inputs
                const inputsContainer = document.createElement('div');
                inputsContainer.className = 'addition-inputs-container';
                this.elements.stepInputContainer.appendChild(inputsContainer);
                
                // Create input for each digit of the result
                const finalResult = this.solution[this.currentStep].result;
                
                // Create inputs in reverse order (right to left)
                for (let i = finalResult.length - 1; i >= 0; i--) {
                    const inputGroup = document.createElement('div');
                    inputGroup.className = 'addition-input-group';
                    
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'step-input';
                    input.maxLength = 1;
                    input.placeholder = "?";
                    input.dataset.position = i;
                    
                    // Add position label
                    const positionLabel = document.createElement('div');
                    positionLabel.className = 'position-label';
                    positionLabel.textContent = `Digit ${finalResult.length - i}`;
                    
                    inputGroup.appendChild(positionLabel);
                    inputGroup.appendChild(input);
                    inputsContainer.appendChild(inputGroup);
                    
                    input.addEventListener('input', (e) => {
                        e.target.value = e.target.value.replace(/\D/g, '');
                        if (e.target.value) {
                            // Find previous input (going right to left)
                            const prevPosition = parseInt(e.target.dataset.position) - 1;
                            if (prevPosition >= 0) {
                                const prevInput = document.querySelector(`.step-input[data-position="${prevPosition}"]`);
                                if (prevInput) {
                                    prevInput.focus();
                                }
                            } else {
                                // Auto-check when last digit is entered
                                setTimeout(() => this.checkCurrentStep(), 300);
                            }
                        }
                    });
                    
                    this.stepInputs.push(input);
                }
                
                // Focus on rightmost input (first to fill)
                if (this.stepInputs.length > 0) {
                    setTimeout(() => this.stepInputs[0].focus(), 100);
                }
            }
            
            // Check current step input
            checkCurrentStep() {
                if (this.currentStep >= this.solution.length) {
                    return;
                }
                
                const currentSolution = this.solution[this.currentStep];
                let isCorrect = false;
                
                // Check if it's the final addition step
                if (currentSolution.type === 'addition') {
                    // For addition, we need to get the user inputs and compare with expected result
                    const finalResult = currentSolution.result;
                    let userAnswer = '';
                    
                    // Build the user answer by getting input values from right to left
                    for (let i = this.stepInputs.length - 1; i >= 0; i--) {
                        userAnswer += this.stepInputs[i].value || '';
                    }
                    
                    isCorrect = userAnswer === finalResult;
                    
                    if (isCorrect) {
                        // Show final answer in work area
                        this.showFinalAnswer(finalResult);
                        
                        // Move to next step (completion)
                        this.currentStep++;
                        this.showFeedback("Great job! You've completed the multiplication!", true);
                        
                        // Complete the problem
                        this.completeProblem();
                    } else {
                        this.showFeedback("Try again! Check your addition.", false);
                        this.perfectSolution = false;
                        
                        // Shake the inputs
                        this.shakeInputs(this.stepInputs);
                    }
                } 
                else {
                    // Check partial product step
                    const currentPartialProduct = currentSolution.partialProduct;
                    const digitStepIndex = currentPartialProduct.length - 1 - this.currentDigit;
                    const digitStep = currentPartialProduct[digitStepIndex];
                    
                    if (this.stepInputs.length === 1 && this.carryInputs.length === 0) {
                        // Single digit result
                        isCorrect = parseInt(this.stepInputs[0].value || '0') === digitStep.resultDigit;
                    } else {
                        // Double digit result with carry
                        const resultDigit = parseInt(this.stepInputs[0].value || '0');
                        const carryDigit = parseInt(this.carryInputs[0].value || '0');
                        
                        isCorrect = (resultDigit === digitStep.resultDigit && carryDigit === digitStep.carry);
                    }
                    
                    if (isCorrect) {
                        // If this is the first digit in a partial product, create a new row
                        if (this.currentDigit === 0) {
                            this.createPartialProductRow(currentSolution);
                        }
                        
                        // Show the correct digit in the work area
                        this.showDigitInPartialProduct(currentSolution, digitStep);
                        
                        // Move to next digit
                        this.currentDigit++;
                        
                        // Enable next button
                        this.elements.nextButton.disabled = false;
                        
                        // Update inputs for next digit
                        this.updateStepInputs();
                        
                        // Show success feedback
                        this.showFeedback("Correct! Keep going.", true);
                    } else {
                        this.showFeedback("Try again! Check your multiplication.", false);
                        this.perfectSolution = false;
                        
                        // Shake the inputs
                        if (this.carryInputs.length === 0) {
                            this.shakeInputs(this.stepInputs);
                        } else {
                            this.shakeInputs([...this.stepInputs, ...this.carryInputs]);
                        }
                    }
                }
            }
            
            // Create a new row for partial product
            createPartialProductRow(stepSolution) {
                const workArea = document.getElementById('work-area');
                const rowIndex = this.solution.indexOf(stepSolution);
                
                const partialProductRow = document.createElement('div');
                partialProductRow.className = 'partial-product';
                partialProductRow.id = `partial-product-${rowIndex}`;
                
                // Add the correct spacing based on shift value
                const shifts = stepSolution.shifts;
                for (let i = 0; i < shifts; i++) {
                    const spacer = document.createElement('div');
                    spacer.className = 'digit';
                    spacer.innerHTML = '&nbsp;';
                    partialProductRow.appendChild(spacer);
                }
                
                workArea.appendChild(partialProductRow);
                
                // If it's a multi-row multiplication, add a line before final answer
                if (rowIndex === this.solution.length - 2 && this.solution[this.solution.length - 1].type === 'addition') {
                    const line = document.createElement('div');
                    line.className = 'line';
                    workArea.appendChild(line);
                }
            }
            
            // Show a digit in the partial product
            showDigitInPartialProduct(stepSolution, digitStep) {
                const rowIndex = this.solution.indexOf(stepSolution);
                const partialProductRow = document.getElementById(`partial-product-${rowIndex}`);
                
                // Create digit div for this result
                const digitDiv = document.createElement('div');
                digitDiv.className = 'digit result';
                digitDiv.textContent = digitStep.resultDigit;
                
                // Add to beginning of row (partial products go right-to-left)
                partialProductRow.insertBefore(digitDiv, partialProductRow.firstChild);
                
                // If there's a carry, show it above
                if (digitStep.carry > 0) {
                    const carryDiv = document.createElement('div');
                    carryDiv.className = 'carry';
                    carryDiv.textContent = digitStep.carry;
                    digitDiv.appendChild(carryDiv);
                    
                    // Make carry visible with slight delay for animation
                    setTimeout(() => {
                        carryDiv.classList.add('visible');
                    }, 300);
                }
            }
            
            // Show final answer
            showFinalAnswer(result) {
                const workArea = document.getElementById('work-area');
                
                const finalRow = document.createElement('div');
                finalRow.className = 'partial-product';
                
                // Add each digit of the result (right to left)
                for (let i = result.length - 1; i >= 0; i--) {
                    const digitDiv = document.createElement('div');
                    digitDiv.className = 'digit result';
                    digitDiv.textContent = result[i];
                    finalRow.insertBefore(digitDiv, finalRow.firstChild);
                }
                
                workArea.appendChild(finalRow);
            }
            
            // Show feedback with animation
            showFeedback(message, isCorrect) {
                this.elements.feedback.textContent = message;
                this.elements.feedback.className = isCorrect ? 'feedback correct' : 'feedback incorrect';
                
                // Add animation
                this.elements.feedback.style.animation = 'none';
                setTimeout(() => {
                    this.elements.feedback.style.animation = 'bounce 0.5s';
                }, 10);
            }
            
            // Shake inputs to indicate error
            shakeInputs(inputs) {
                inputs.forEach(input => {
                    input.style.animation = 'none';
                    setTimeout(() => {
                        input.style.animation = 'shake 0.5s';
                    }, 10);
                });
            }
            
            // Navigate to next step
            navigateToNextStep() {
                if (this.currentDigit < this.solution[this.currentStep].partialProduct.length) {
                    // Complete current partial product
                    this.currentDigit = this.solution[this.currentStep].partialProduct.length;
                    this.updateStepInputs();
                } else {
                    // Move to next step
                    this.currentStep++;
                    this.currentDigit = 0;
                    this.updateStepInputs();
                }
            }
            
            // Complete the problem
            completeProblem() {
                // Update score and streak
                this.score += this.level;
                this.streak++;
                this.elements.score.textContent = this.score;
                
                // Calculate time taken
                const endTime = new Date().getTime();
                const timeTaken = (endTime - this.startTime) / 1000; // in seconds
                
                // Check for awards
                this.checkAwards(timeTaken);
                
                // Show completion feedback
                this.elements.feedback.textContent = `Excellent! You solved it in ${Math.round(timeTaken)} seconds! 🎉`;
                this.elements.feedback.className = 'feedback correct celebrating';
                
                // Create celebration effects
                this.createConfetti();
                
                // Check for level up
                if (this.score >= this.level * 3) {
                    this.levelUp();
                }
                
                // Enable new problem button and highlight it
                this.elements.newProblemButton.disabled = false;
                this.elements.newProblemButton.classList.add('celebrating');
                
                // Disable check and next buttons
                this.elements.checkButton.disabled = true;
                this.elements.nextButton.disabled = true;
                
                // Auto-generate new problem after 5 seconds
                const autoNewTimeout = setTimeout(() => {
                    if (this.currentStep >= this.solution.length) {
                        this.generateProblem();
                        
                        // Reset button states
                        this.elements.newProblemButton.classList.remove('celebrating');
                        this.elements.checkButton.disabled = false;
                        this.elements.nextButton.disabled = true;
                    }
                }, 5000);
                
                // Clear timeout if user clicks button
                this.elements.newProblemButton.addEventListener('click', () => {
                    clearTimeout(autoNewTimeout);
                    this.elements.checkButton.disabled = false;
                    this.elements.newProblemButton.classList.remove('celebrating');
                }, { once: true });
                
                // Give a hint about keyboard shortcut
                setTimeout(() => {
                    this.showFeedback('Press SPACE for a new problem!', true);
                }, 3000);
            }
            
            // Level up
            levelUp() {
                this.level++;
                this.elements.level.textContent = this.level;
                this.elements.level.parentElement.classList.add('celebrating');
                
                // Show level up message
                this.elements.feedback.textContent = `Level Up! You're now at level ${this.level}! 🚀`;
                
                // Reset celebration after a delay
                setTimeout(() => {
                    this.elements.level.parentElement.classList.remove('celebrating');
                }, 3000);
                
                // Award level badge every 5 levels
                if (this.level % 5 === 0) {
                    this.awardBadge('level');
                }
            }
            
            // Check for awards
            checkAwards(timeTaken) {
                // Speed award - complete within level-appropriate time
                const timeLimit = 30 + (this.level * 5); // More time for higher levels
                if (timeTaken < timeLimit && !this.awards.speed) {
                    this.awardBadge('speed');
                }
                
                // Streak award - 5 consecutive correct solutions
                if (this.streak >= 5 && !this.awards.streak) {
                    this.awardBadge('streak');
                }
                
                // Perfect solution award - no mistakes
                if (this.perfectSolution && !this.awards.perfect) {
                    this.awardBadge('perfect');
                }
            }
            
            // Award a badge
            awardBadge(type) {
                this.awards[type] = true;
                const badge = this.elements[`award${type.charAt(0).toUpperCase() + type.slice(1)}`];
                
                badge.classList.add('earned');
                
                // Show award message
                let message = '';
                switch(type) {
                    case 'speed':
                        message = 'Speed Multiplier Award Earned! ⚡';
                        break;
                    case 'streak':
                        message = '5 in a Row! Streak Master Award Earned! 🔥';
                        break;
                    case 'perfect':
                        message = 'Perfect Solution Award Earned! 🌟';
                        break;
                    case 'level':
                        message = 'Level Master Award Earned! 🏆';
                        break;
                }
                
                // Add award message with delay
                setTimeout(() => {
                    this.elements.feedback.textContent = message;
                }, 2000);
            }
            
            // Create celebration confetti
            createConfetti() {
                const colors = ['red', 'blue', 'green', 'yellow', 'purple'];
                const confettiCount = 100;
                
                for (let i = 0; i < confettiCount; i++) {
                    const confetti = document.createElement('div');
                    confetti.className = `confetti ${colors[Math.floor(Math.random() * colors.length)]}`;
                    
                    // Random position
                    confetti.style.left = Math.random() * 100 + 'vw';
                    
                    // Random size
                    const size = Math.random() * 10 + 5;
                    confetti.style.width = size + 'px';
                    confetti.style.height = size + 'px';
                    
                    // Random rotation
                    confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                    
                    // Random delay
                    confetti.style.animationDelay = Math.random() * 2 + 's';
                    
                    document.body.appendChild(confetti);
                    
                    // Remove after animation
                    setTimeout(() => {
                        confetti.remove();
                    }, 5000);
                }
            }
        }
        
        // Initialize the game when the page loads
        window.addEventListener('load', () => new MultiplicationGame());
    </script>
</body>
</html>