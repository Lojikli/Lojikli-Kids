<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Musical Maestro's Adventure</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        :root {
            --primary: #FF9A8B;
            --primary-light: #FFD3CD;
            --secondary: #74EBD5;
            --secondary-light: #ACF7E1;
            --accent: #6A5ACD;
            --text: #333333;
            --background: #FFFFFF;
            --success: #4CAF50;
            --warning: #FF9800;
            --error: #F44336;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Comic Sans MS', cursive, sans-serif;
        }

        body {
            background: linear-gradient(135deg, var(--primary-light), var(--secondary-light));
            color: var(--text);
            overflow: hidden;
            height: 100vh;
            transition: background 1s ease;
        }

        #app {
            display: flex;
            flex-direction: column;
            height: 100vh;
            position: relative;
            overflow: hidden;
        }

        #welcome-screen, #adventure-map, #lesson-screen, #quiz-screen, #practice-screen, #settings-screen, #achievements-screen {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            z-index: 10;
        }

        .hidden {
            transform: translateY(100%);
            opacity: 0;
            pointer-events: none;
        }

        .visible {
            transform: translateY(0);
            opacity: 1;
            pointer-events: all;
        }

        h1, h2, h3 {
            color: var(--accent);
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        h1 {
            font-size: 3em;
            margin-top: 0;
            animation: bounce 1s infinite alternate;
        }

        @keyframes bounce {
            from { transform: translateY(0); }
            to { transform: translateY(-10px); }
        }

        button {
            background-color: var(--accent);
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 10px;
            border-radius: 50px;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        button:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
        }

        button:active {
            transform: scale(0.95);
        }

        button::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }

        button:focus::after {
            animation: ripple 1s ease-out;
        }

        @keyframes ripple {
            0% { transform: scale(0, 0); opacity: 1; }
            20% { transform: scale(25, 25); opacity: 0.8; }
            100% { opacity: 0; transform: scale(40, 40); }
        }

        .title-container {
            text-align: center;
            margin-bottom: 40px;
        }

        .button-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }

        #adventure-map {
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="800" height="600" viewBox="0 0 800 600"><defs><linearGradient id="grass" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stop-color="%2361D095"/><stop offset="100%" stop-color="%234CAF50"/></linearGradient><linearGradient id="path" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stop-color="%23FFD700"/><stop offset="100%" stop-color="%23FFA500"/></linearGradient><linearGradient id="water" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stop-color="%2374EBD5"/><stop offset="100%" stop-color="%234B7BEC"/></linearGradient></defs><rect width="800" height="600" fill="url(%23grass)" /><ellipse cx="200" cy="150" rx="100" ry="50" fill="url(%23water)" /><ellipse cx="600" cy="400" rx="120" ry="70" fill="url(%23water)" /><path d="M100,300 Q250,250 300,350 T500,400 T700,300" stroke="url(%23path)" stroke-width="30" fill="none" stroke-linecap="round" /></svg>') center/cover no-repeat;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 20px;
            padding: 50px;
            align-items: center;
            justify-items: center;
        }

        .map-node {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .map-node.locked {
            background-color: #888;
            cursor: not-allowed;
        }

        .map-node:not(.locked):hover {
            transform: scale(1.1);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .map-node::before {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 110%;
            left: 50%;
            transform: translateX(-50%);
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 8px;
            font-size: 0.7em;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            white-space: nowrap;
            z-index: 1;
        }

        .map-node:hover::before {
            opacity: 1;
            visibility: visible;
        }

        .map-node.completed::after {
            content: '‚úì';
            position: absolute;
            top: -10px;
            right: -10px;
            background: var(--success);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            font-weight: bold;
        }

        .nav-buttons {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 100;
        }

        .nav-button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--accent);
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .nav-button:hover {
            transform: scale(1.1);
        }

        #canvas-container {
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .character {
            position: absolute;
            width: 150px;
            height: 150px;
            z-index: 5;
            pointer-events: none;
            transition: all 0.5s ease;
        }

        .character img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .speech-bubble {
            position: absolute;
            background: white;
            border-radius: 20px;
            padding: 15px;
            max-width: 300px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            z-index: 10;
            transition: all 0.3s ease;
            opacity: 0;
            transform: translateY(20px);
        }

        .speech-bubble.active {
            opacity: 1;
            transform: translateY(0);
        }

        .speech-bubble::after {
            content: '';
            position: absolute;
            bottom: -15px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 15px 15px 0;
            border-style: solid;
            border-color: white transparent transparent;
        }

        #piano-container {
            width: 100%;
            max-width: 800px;
            height: 200px;
            display: flex;
            position: relative;
            margin: 20px auto;
        }

        .piano-key {
            flex-grow: 1;
            position: relative;
            margin: 0 1px;
            border-radius: 0 0 5px 5px;
            background-color: white;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.1s ease;
            cursor: pointer;
        }

        .piano-key.black {
            background-color: #333;
            position: absolute;
            width: 6%;
            height: 60%;
            transform: translateX(-50%);
            z-index: 1;
        }

        .piano-key.highlight {
            background-color: var(--secondary);
            box-shadow: 0 0 15px var(--secondary);
        }

        .piano-key.correct {
            background-color: var(--success);
            animation: correct-pulse 0.5s ease-in-out;
        }

        .piano-key.wrong {
            background-color: var(--error);
            animation: wrong-pulse 0.5s ease-in-out;
        }

        @keyframes correct-pulse {
            0%, 100% { transform: scale(1); background-color: var(--success); }
            50% { transform: scale(1.05); background-color: var(--success); }
        }

        @keyframes wrong-pulse {
            0%, 100% { transform: scale(1); background-color: var(--error); }
            50% { transform: scale(1.05); background-color: var(--error); }
        }

        .note-target {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            animation: float 2s infinite alternate ease-in-out;
        }

        @keyframes float {
            from { transform: translateY(0); }
            to { transform: translateY(-10px); }
        }

        .note-rain {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2;
        }

        .note {
            position: absolute;
            width: 30px;
            height: 30px;
            background-size: contain;
            background-repeat: no-repeat;
            animation: fall linear;
        }

        @keyframes fall {
            from { transform: translateY(-50px) rotate(0deg); }
            to { transform: translateY(calc(100vh + 50px)) rotate(360deg); }
        }

        .settings-group {
            background-color: rgba(255, 255, 255, 0.8);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            width: 100%;
            max-width: 600px;
        }

        .settings-row {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .settings-row label {
            flex: 1;
            font-size: 1.2em;
        }

        .settings-row input[type="range"] {
            flex: 2;
            height: 20px;
            -webkit-appearance: none;
            border-radius: 10px;
            background: linear-gradient(to right, var(--primary), var(--secondary));
        }

        .settings-row input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .settings-row .value {
            width: 50px;
            text-align: center;
            font-weight: bold;
        }

        .quiz-container {
            width: 100%;
            max-width: 800px;
        }

        .quiz-question {
            background-color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .quiz-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .quiz-option {
            padding: 15px;
            border-radius: 10px;
            background-color: #f5f5f5;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .quiz-option:hover {
            background-color: var(--primary-light);
        }

        .quiz-option.selected {
            background-color: var(--accent);
            color: white;
        }

        .quiz-feedback {
            font-size: 1.2em;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
            height: 30px;
        }

        .lesson-content {
            background-color: rgba(255, 255, 255, 0.8);
            padding: 30px;
            border-radius: 15px;
            max-width: 800px;
            width: 100%;
            text-align: center;
        }

        .lesson-image {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            margin: 20px 0;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .lesson-navigation {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-top: 20px;
        }

        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            max-width: 800px;
            width: 100%;
        }

        .achievement-card {
            background-color: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .achievement-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        .achievement-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .achievement-card.locked {
            filter: grayscale(1);
            opacity: 0.7;
        }

        .achievement-card.locked:hover {
            transform: none;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .practice-container {
            width: 100%;
            max-width: 800px;
            text-align: center;
        }

        .score-display {
            font-size: 2em;
            font-weight: bold;
            margin: 20px 0;
        }

        .progress-container {
            width: 100%;
            height: 30px;
            background-color: #f5f5f5;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            transition: width 0.3s ease;
        }

        .note-display {
            margin: 20px 0;
            font-size: 6em;
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            visibility: hidden;
            opacity: 0;
            transition: all 0.3s ease-in-out;
        }

        .modal.active {
            visibility: visible;
            opacity: 1;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            transform: scale(0.8);
            transition: all 0.3s ease-in-out;
        }

        .modal.active .modal-content {
            transform: scale(1);
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: var(--primary);
            opacity: 0.7;
            animation: confetti-fall linear forwards;
        }

        @keyframes confetti-fall {
            from { transform: translateY(-50px) rotate(0deg); }
            to { transform: translateY(calc(100vh + 50px)) rotate(720deg); }
        }

        /* Character images created with CSS */
        .maestro-img {
            background-color: var(--accent);
            width: 100px;
            height: 100px;
            border-radius: 50%;
            position: relative;
            overflow: hidden;
        }

        .maestro-img::before {
            content: "";
            position: absolute;
            width: 50px;
            height: 20px;
            background-color: white;
            border-radius: 10px;
            bottom: 25px;
            left: 25px;
        }

        .maestro-img::after {
            content: "";
            position: absolute;
            width: 20px;
            height: 20px;
            background-color: black;
            border-radius: 50%;
            top: 30px;
            left: 25px;
            box-shadow: 30px 0 0 0 black;
        }

        .beato-img {
            background-color: var(--primary);
            width: 90px;
            height: 90px;
            border-radius: 50%;
            position: relative;
            overflow: hidden;
        }

        .beato-img::before {
            content: "";
            position: absolute;
            width: 40px;
            height: 15px;
            background-color: white;
            border-radius: 7px;
            bottom: 20px;
            left: 25px;
        }

        .beato-img::after {
            content: "";
            position: absolute;
            width: 15px;
            height: 15px;
            background-color: black;
            border-radius: 50%;
            top: 25px;
            left: 20px;
            box-shadow: 35px 0 0 0 black;
        }

        .melody-img {
            background-color: var(--secondary);
            width: 80px;
            height: 80px;
            border-radius: 50%;
            position: relative;
            overflow: hidden;
        }

        .melody-img::before {
            content: "";
            position: absolute;
            width: 35px;
            height: 12px;
            background-color: white;
            border-radius: 6px;
            bottom: 18px;
            left: 22px;
        }

        .melody-img::after {
            content: "";
            position: absolute;
            width: 12px;
            height: 12px;
            background-color: black;
            border-radius: 50%;
            top: 22px;
            left: 18px;
            box-shadow: 32px 0 0 0 black;
        }

        /* Responsive styling */
        @media (max-width: 768px) {
            h1 {
                font-size: 2em;
            }

            .button-container {
                flex-direction: column;
            }

            .achievements-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 1.5em;
            }

            button {
                padding: 10px 20px;
                font-size: 1em;
            }

            .quiz-options {
                grid-template-columns: 1fr;
            }

            .achievements-grid {
                grid-template-columns: 1fr;
            }

            .piano-key.black {
                height: 50%;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <div id="canvas-container"></div>

        <div id="welcome-screen" class="visible">
            <div class="title-container">
                <h1>Musical Maestro's Adventure</h1>
                <p>A magical journey to learn piano for genius 5-year-olds!</p>
            </div>
            <div class="character" style="bottom: 50px; left: 20%;">
                <div class="maestro-img"></div>
            </div>
            <div class="character" style="bottom: 70px; right: 20%;">
                <div class="beato-img"></div>
            </div>
            <div class="button-container">
                <button id="start-button">Start Adventure</button>
                <button id="settings-button">Settings</button>
            </div>
        </div>

        <div id="adventure-map" class="hidden">
            <h2>Musical Adventure Map</h2>
            <div class="map-node" data-level="1" data-tooltip="Note Names">1</div>
            <div class="map-node locked" data-level="2" data-tooltip="Rhythm Basics">2</div>
            <div class="map-node locked" data-level="3" data-tooltip="Musical Scales">3</div>
            <div class="map-node locked" data-level="4" data-tooltip="Simple Melodies">4</div>
            <div class="map-node locked" data-level="5" data-tooltip="Finger Positions">5</div>
            <div class="map-node locked" data-level="6" data-tooltip="Reading Sheet Music">6</div>
            <div class="map-node locked" data-level="7" data-tooltip="Chords">7</div>
            <div class="map-node locked" data-level="8" data-tooltip="Music Theory">8</div>
            <div class="map-node locked" data-level="9" data-tooltip="Master Performance">9</div>
        </div>

        <div id="lesson-screen" class="hidden">
            <div class="lesson-content">
                <h2>Lesson Title</h2>
                <div id="lesson-body">
                    <!-- Lesson content will be dynamically inserted here -->
                </div>
                <div class="lesson-navigation">
                    <button id="prev-lesson">Previous</button>
                    <button id="next-lesson">Next</button>
                </div>
            </div>
        </div>

        <div id="quiz-screen" class="hidden">
            <h2>Music Quiz</h2>
            <div class="quiz-container">
                <div class="quiz-question">
                    <h3 id="quiz-question-text">Question text will appear here</h3>
                    <div class="quiz-options" id="quiz-options">
                        <!-- Options will be dynamically inserted here -->
                    </div>
                </div>
                <div class="quiz-feedback" id="quiz-feedback"></div>
                <button id="submit-quiz">Submit Answer</button>
            </div>
        </div>

        <div id="practice-screen" class="hidden">
            <h2>Play Along Practice</h2>
            <div class="practice-container">
                <div class="score-display">Score: <span id="practice-score">0</span></div>
                <div class="progress-container">
                    <div class="progress-bar" id="practice-progress" style="width: 0%"></div>
                </div>
                <div class="note-display" id="note-to-play"></div>
                <div id="piano-container">
                    <!-- Piano keys will be dynamically inserted here -->
                </div>
                <div class="button-container">
                    <button id="start-practice">Start Practice</button>
                    <button id="end-practice">End Practice</button>
                </div>
            </div>
        </div>

        <div id="settings-screen" class="hidden">
            <h2>Settings</h2>
            <div class="settings-group">
                <h3>Difficulty Level</h3>
                <div class="settings-row">
                    <label for="difficulty">Overall Difficulty</label>
                    <input type="range" id="difficulty" min="1" max="5" value="2">
                    <div class="value" id="difficulty-value">2</div>
                </div>
                <div class="settings-row">
                    <label for="note-speed">Note Speed</label>
                    <input type="range" id="note-speed" min="1" max="5" value="2">
                    <div class="value" id="note-speed-value">2</div>
                </div>
            </div>
            <div class="settings-group">
                <h3>Educational Focus</h3>
                <div class="settings-row">
                    <label for="theory-focus">Music Theory Depth</label>
                    <input type="range" id="theory-focus" min="1" max="5" value="3">
                    <div class="value" id="theory-focus-value">3</div>
                </div>
                <div class="settings-row">
                    <label for="practice-focus">Practice Intensity</label>
                    <input type="range" id="practice-focus" min="1" max="5" value="3">
                    <div class="value" id="practice-focus-value">3</div>
                </div>
            </div>
            <div class="settings-group">
                <h3>Appearance</h3>
                <div class="settings-row">
                    <label for="color-theme">Color Theme</label>
                    <input type="range" id="color-theme" min="1" max="4" value="1">
                    <div class="value" id="color-theme-value">1</div>
                </div>
            </div>
            <button id="save-settings">Save Settings</button>
        </div>

        <div id="achievements-screen" class="hidden">
            <h2>Your Achievements</h2>
            <div class="achievements-grid">
                <div class="achievement-card locked">
                    <div class="achievement-icon">üéµ</div>
                    <h3>Note Master</h3>
                    <p>Learn all the note names</p>
                </div>
                <div class="achievement-card locked">
                    <div class="achievement-icon">üéº</div>
                    <h3>Rhythm Wizard</h3>
                    <p>Perfect timing in practice mode</p>
                </div>
                <div class="achievement-card locked">
                    <div class="achievement-icon">üéπ</div>
                    <h3>Piano Prodigy</h3>
                    <p>Play 50 notes correctly</p>
                </div>
                <div class="achievement-card locked">
                    <div class="achievement-icon">üìö</div>
                    <h3>Theory Champion</h3>
                    <p>Score perfect on all quizzes</p>
                </div>
                <div class="achievement-card locked">
                    <div class="achievement-icon">üåà</div>
                    <h3>Scale Explorer</h3>
                    <p>Master all the musical scales</p>
                </div>
                <div class="achievement-card locked">
                    <div class="achievement-icon">üèÜ</div>
                    <h3>Musical Genius</h3>
                    <p>Complete all levels</p>
                </div>
            </div>
            <button id="back-to-map">Back to Map</button>
        </div>

        <div class="nav-buttons">
            <div class="nav-button" id="home-button">üè†</div>
            <div class="nav-button" id="achievements-button">üèÜ</div>
            <div class="nav-button" id="help-button">‚ùì</div>
        </div>

        <div class="character" id="maestro" style="bottom: -150px; left: 20%;">
            <div class="maestro-img"></div>
            <div class="speech-bubble" id="maestro-speech">
                Hello! I'm Professor Maestro! Let's learn music together!
            </div>
        </div>

        <div class="character" id="beato" style="bottom: -150px; right: 20%;">
            <div class="beato-img"></div>
            <div class="speech-bubble" id="beato-speech">
                Hi! I'm Beato! I'll help you keep the beat!
            </div>
        </div>

        <div class="modal" id="level-complete-modal">
            <div class="modal-content">
                <h2>Level Complete!</h2>
                <p id="level-complete-message">You've completed this level!</p>
                <div class="score-display">Score: <span id="final-score">0</span></div>
                <button id="continue-button">Continue to Next Level</button>
            </div>
        </div>
    </div>

    <script>
        // Main Application
        class MusicalMaestro {
            constructor() {
                this.currentScreen = 'welcome';
                this.currentLevel = 1;
                this.unlockedLevels = [1];
                this.achievements = {};
                this.score = 0;
                this.practiceScore = 0;
                this.settings = {
                    difficulty: 2,
                    noteSpeed: 2,
                    theoryFocus: 3,
                    practiceFocus: 3,
                    colorTheme: 1
                };
                this.userProgress = {
                    completedLessons: [],
                    quizScores: {},
                    practiceScores: {},
                    notesPlayed: 0,
                    correctNotes: 0
                };

                this.audioContext = null;
                this.analyser = null;
                this.microphone = null;
                this.noteDetector = null;

                this.currentNote = null;
                this.isListening = false;
                
                this.lessons = this.setupLessons();
                this.quizzes = this.setupQuizzes();
                this.practiceExercises = this.setupPracticeExercises();
                
                this.setupEventListeners();
                this.initializeP5();
                this.showCharacters();
                this.applyColorTheme();
            }

            setupLessons() {
                return [
                    {
                        level: 1,
                        title: "Note Names - Meet the Musical Alphabet",
                        pages: [
                            {
                                title: "The Musical Alphabet",
                                content: `
                                    <p>Music has its own special alphabet! Instead of 26 letters, we only use 7:</p>
                                    <h3>A B C D E F G</h3>
                                    <p>These letters are the names of our musical notes. After G, we start back at A again!</p>
                                    <div style="display: flex; justify-content: center; margin: 20px 0;">
                                        <div style="display: flex; align-items: center; justify-content: center; width: 50px; height: 50px; background-color: var(--primary); border-radius: 50%; margin: 0 5px;">A</div>
                                        <div style="display: flex; align-items: center; justify-content: center; width: 50px; height: 50px; background-color: var(--primary); border-radius: 50%; margin: 0 5px;">B</div>
                                        <div style="display: flex; align-items: center; justify-content: center; width: 50px; height: 50px; background-color: var(--primary); border-radius: 50%; margin: 0 5px;">C</div>
                                        <div style="display: flex; align-items: center; justify-content: center; width: 50px; height: 50px; background-color: var(--primary); border-radius: 50%; margin: 0 5px;">D</div>
                                        <div style="display: flex; align-items: center; justify-content: center; width: 50px; height: 50px; background-color: var(--primary); border-radius: 50%; margin: 0 5px;">E</div>
                                        <div style="display: flex; align-items: center; justify-content: center; width: 50px; height: 50px; background-color: var(--primary); border-radius: 50%; margin: 0 5px;">F</div>
                                        <div style="display: flex; align-items: center; justify-content: center; width: 50px; height: 50px; background-color: var(--primary); border-radius: 50%; margin: 0 5px;">G</div>
                                    </div>
                                    <p>These letters name the white keys on the piano.</p>
                                `
                            },
                            {
                                title: "Finding Notes on the Piano",
                                content: `
                                    <p>On the piano, we can find all these notes!</p>
                                    <p>The pattern of black and white keys helps us find our way.</p>
                                    <div style="margin: 20px 0;">
                                        <div style="display: flex; justify-content: center; height: 100px; max-width: 500px; margin: 0 auto;">
                                            <div style="flex-grow: 1; height: 100%; background-color: white; border: 1px solid black; position: relative; display: flex; align-items: flex-end; justify-content: center; padding-bottom: 10px;">C</div>
                                            <div style="flex-grow: 1; height: 100%; background-color: white; border: 1px solid black; position: relative; display: flex; align-items: flex-end; justify-content: center; padding-bottom: 10px;">D</div>
                                            <div style="flex-grow: 1; height: 100%; background-color: white; border: 1px solid black; position: relative; display: flex; align-items: flex-end; justify-content: center; padding-bottom: 10px;">E</div>
                                            <div style="flex-grow: 1; height: 100%; background-color: white; border: 1px solid black; position: relative; display: flex; align-items: flex-end; justify-content: center; padding-bottom: 10px;">F</div>
                                            <div style="flex-grow: 1; height: 100%; background-color: white; border: 1px solid black; position: relative; display: flex; align-items: flex-end; justify-content: center; padding-bottom: 10px;">G</div>
                                            <div style="flex-grow: 1; height: 100%; background-color: white; border: 1px solid black; position: relative; display: flex; align-items: flex-end; justify-content: center; padding-bottom: 10px;">A</div>
                                            <div style="flex-grow: 1; height: 100%; background-color: white; border: 1px solid black; position: relative; display: flex; align-items: flex-end; justify-content: center; padding-bottom: 10px;">B</div>
                                            <div style="position: absolute; width: 30px; height: 60px; background-color: black; margin-left: -15px; left: calc(500px/7 * 0.75); top: 0; z-index: 1;"></div>
                                            <div style="position: absolute; width: 30px; height: 60px; background-color: black; margin-left: -15px; left: calc(500px/7 * 1.75); top: 0; z-index: 1;"></div>
                                            <div style="position: absolute; width: 30px; height: 60px; background-color: black; margin-left: -15px; left: calc(500px/7 * 3.75); top: 0; z-index: 1;"></div>
                                            <div style="position: absolute; width: 30px; height: 60px; background-color: black; margin-left: -15px; left: calc(500px/7 * 4.75); top: 0; z-index: 1;"></div>
                                            <div style="position: absolute; width: 30px; height: 60px; background-color: black; margin-left: -15px; left: calc(500px/7 * 5.75); top: 0; z-index: 1;"></div>
                                        </div>
                                    </div>
                                    <p>The note C is always just to the left of a group of two black keys.</p>
                                    <p>Once you find C, you can count up the alphabet to find the other notes!</p>
                                `
                            },
                            {
                                title: "How Notes Sound",
                                content: `
                                    <p>Each note has its own special sound!</p>
                                    <p>The notes go from low sounds to high sounds as we move from left to right on the piano.</p>
                                    <div style="margin: 20px 0; text-align: center;">
                                        <div style="display: inline-block; animation: float 2s infinite alternate ease-in-out; transform-origin: center;">
                                            <div style="width: 0; height: 0; border-left: 20px solid transparent; border-right: 20px solid transparent; border-bottom: 40px solid var(--primary);"></div>
                                            <div style="background-color: var(--primary); width: 40px; height: 20px; border-radius: 0 0 20px 20px;"></div>
                                        </div>
                                    </div>
                                    <p>Low notes sound deep, like a bear's growl.</p>
                                    <p>High notes sound tiny, like a bird's tweet!</p>
                                    <p>Let's practice hearing different notes in the next activity!</p>
                                `
                            }
                        ]
                    },
                    {
                        level: 2,
                        title: "Rhythm Basics - The Heartbeat of Music",
                        pages: [
                            {
                                title: "What is Rhythm?",
                                content: `
                                    <p>Rhythm is the pattern of long and short sounds and silences in music.</p>
                                    <p>It's like the heartbeat of a song!</p>
                                    <div style="margin: 20px 0; text-align: center;">
                                        <div style="display: inline-block; animation: pulse 1s infinite;">
                                            <div style="width: 50px; height: 50px; background-color: var(--error); border-radius: 50%;"></div>
                                        </div>
                                    </div>
                                    <p>We can count rhythm like this: "1, 2, 3, 4, 1, 2, 3, 4"</p>
                                    <p>Try clapping along with the counting pattern!</p>
                                `
                            }
                        ]
                    }
                    // More lessons would be added here
                ];
            }

            setupQuizzes() {
                return [
                    {
                        level: 1,
                        questions: [
                            {
                                question: "How many letters are in the musical alphabet?",
                                options: ["5", "7", "12", "26"],
                                answer: 1
                            },
                            {
                                question: "What note comes after G in the musical alphabet?",
                                options: ["H", "A", "There is no note after G", "G sharp"],
                                answer: 1
                            },
                            {
                                question: "Which key on the piano is C?",
                                options: [
                                    "The white key just to the left of two black keys",
                                    "The white key just to the right of two black keys",
                                    "Any white key",
                                    "The first key on the piano"
                                ],
                                answer: 0
                            },
                            {
                                question: "If you play the white keys from left to right, which order of notes will you hear?",
                                options: [
                                    "A B C D E F G",
                                    "C D E F G A B",
                                    "Do Re Mi Fa Sol La Ti",
                                    "1 2 3 4 5 6 7"
                                ],
                                answer: 1
                            },
                            {
                                question: "What happens when you move from left to right on the piano?",
                                options: [
                                    "The notes get lower",
                                    "The notes get higher",
                                    "The notes stay the same",
                                    "The notes get louder"
                                ],
                                answer: 1
                            }
                        ]
                    },
                    // More quizzes would be added here
                    {
                        level: 2,
                        questions: [
                            {
                                question: "What is rhythm in music?",
                                options: [
                                    "The volume of the music",
                                    "The pattern of long and short sounds and silences",
                                    "The pitch of the notes",
                                    "The instruments used"
                                ],
                                answer: 1
                            }
                        ]
                    }
                ];
            }

            setupPracticeExercises() {
                return [
                    {
                        level: 1,
                        exercises: [
                            {
                                title: "Find Middle C",
                                description: "Find and play Middle C on the piano!",
                                notes: ["C4"],
                                duration: 30,
                                targetScore: 5
                            },
                            {
                                title: "Play the C-D-E Sequence",
                                description: "Play the notes C, D, and E in order!",
                                notes: ["C4", "D4", "E4"],
                                duration: 30,
                                targetScore: 10
                            },
                            {
                                title: "Musical Alphabet Challenge",
                                description: "Play all the white keys from C to B in order!",
                                notes: ["C4", "D4", "E4", "F4", "G4", "A4", "B4"],
                                duration: 60,
                                targetScore: 20
                            }
                        ]
                    }
                    // More practice exercises would be added here
                ];
            }

            setupEventListeners() {
                // Navigation buttons
                document.getElementById('start-button').addEventListener('click', () => this.showScreen('adventure-map'));
                document.getElementById('settings-button').addEventListener('click', () => this.showScreen('settings'));
                document.getElementById('home-button').addEventListener('click', () => this.showScreen('adventure-map'));
                document.getElementById('achievements-button').addEventListener('click', () => this.showScreen('achievements'));
                document.getElementById('help-button').addEventListener('click', () => this.showTutorial());
                document.getElementById('back-to-map').addEventListener('click', () => this.showScreen('adventure-map'));
                
                // Settings controls
                document.getElementById('difficulty').addEventListener('input', (e) => {
                    document.getElementById('difficulty-value').textContent = e.target.value;
                    this.settings.difficulty = parseInt(e.target.value);
                });
                document.getElementById('note-speed').addEventListener('input', (e) => {
                    document.getElementById('note-speed-value').textContent = e.target.value;
                    this.settings.noteSpeed = parseInt(e.target.value);
                });
                document.getElementById('theory-focus').addEventListener('input', (e) => {
                    document.getElementById('theory-focus-value').textContent = e.target.value;
                    this.settings.theoryFocus = parseInt(e.target.value);
                });
                document.getElementById('practice-focus').addEventListener('input', (e) => {
                    document.getElementById('practice-focus-value').textContent = e.target.value;
                    this.settings.practiceFocus = parseInt(e.target.value);
                });
                document.getElementById('color-theme').addEventListener('input', (e) => {
                    document.getElementById('color-theme-value').textContent = e.target.value;
                    this.settings.colorTheme = parseInt(e.target.value);
                    this.applyColorTheme();
                });
                document.getElementById('save-settings').addEventListener('click', () => {
                    this.saveSettings();
                    this.showScreen('adventure-map');
                });
                
                // Lesson navigation
                document.getElementById('prev-lesson').addEventListener('click', () => this.navigateLesson(-1));
                document.getElementById('next-lesson').addEventListener('click', () => this.navigateLesson(1));
                
                // Quiz interactions
                document.getElementById('submit-quiz').addEventListener('click', () => this.submitQuizAnswer());
                
                // Practice interactions
                document.getElementById('start-practice').addEventListener('click', () => this.startPracticeSession());
                document.getElementById('end-practice').addEventListener('click', () => this.endPracticeSession());
                
                // Map interactions
                document.querySelectorAll('.map-node').forEach(node => {
                    node.addEventListener('click', (e) => {
                        const level = parseInt(e.target.dataset.level);
                        if (!e.target.classList.contains('locked')) {
                            this.selectLevel(level);
                        }
                    });
                });
                
                // Modal interactions
                document.getElementById('continue-button').addEventListener('click', () => {
                    document.getElementById('level-complete-modal').classList.remove('active');
                    this.showScreen('adventure-map');
                    this.unlockNextLevel();
                });
            }

            initializeP5() {
                try {
                    // Manually create background particles without relying on p5.sound
                    const particlesCanvas = document.createElement('canvas');
                    particlesCanvas.width = window.innerWidth;
                    particlesCanvas.height = window.innerHeight;
                    document.getElementById('canvas-container').appendChild(particlesCanvas);
                    
                    const ctx = particlesCanvas.getContext('2d');
                    const particles = [];
                    
                    // Create initial particles
                    for (let i = 0; i < 50; i++) {
                        particles.push({
                            x: Math.random() * particlesCanvas.width,
                            y: Math.random() * particlesCanvas.height,
                            size: Math.random() * 5 + 3,
                            color: `rgb(${Math.random() * 55 + 200}, ${Math.random() * 55 + 200}, ${Math.random() * 55 + 200})`,
                            speed: Math.random() * 0.8 + 0.2
                        });
                    }
                    
                    // Animation loop
                    function animate() {
                        ctx.clearRect(0, 0, particlesCanvas.width, particlesCanvas.height);
                        
                        for (let i = 0; i < particles.length; i++) {
                            const particle = particles[i];
                            
                            ctx.fillStyle = particle.color;
                            ctx.beginPath();
                            ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
                            ctx.fill();
                            
                            particle.y += particle.speed;
                            
                            if (particle.y > particlesCanvas.height) {
                                particle.y = -10;
                                particle.x = Math.random() * particlesCanvas.width;
                            }
                        }
                        
                        requestAnimationFrame(animate);
                    }
                    
                    // Handle window resize
                    window.addEventListener('resize', () => {
                        particlesCanvas.width = window.innerWidth;
                        particlesCanvas.height = window.innerHeight;
                    });
                    
                    // Start animation
                    animate();
                    
                    console.log("Background animation initialized successfully");
                } catch (error) {
                    console.error("Error initializing background animation:", error);
                    // Provide a fallback color instead of animation
                    document.getElementById('app').style.background = 'linear-gradient(135deg, var(--primary-light), var(--secondary-light))';
                }
            }

            showCharacters() {
                setTimeout(() => {
                    document.getElementById('maestro').style.bottom = '20px';
                    setTimeout(() => {
                        document.getElementById('maestro-speech').classList.add('active');
                    }, 500);
                }, 1000);
                
                setTimeout(() => {
                    document.getElementById('beato').style.bottom = '20px';
                    setTimeout(() => {
                        document.getElementById('beato-speech').classList.add('active');
                    }, 500);
                }, 2000);
                
                setTimeout(() => {
                    document.getElementById('maestro-speech').classList.remove('active');
                    document.getElementById('beato-speech').classList.remove('active');
                }, 5000);
            }

            showCharacterSpeech(character, message, duration = 3000) {
                const speechBubble = document.getElementById(`${character}-speech`);
                speechBubble.textContent = message;
                speechBubble.classList.add('active');
                
                setTimeout(() => {
                    speechBubble.classList.remove('active');
                }, duration);
            }

            applyColorTheme() {
                const themes = [
                    {
                        primary: '#FF9A8B',
                        primaryLight: '#FFD3CD',
                        secondary: '#74EBD5',
                        secondaryLight: '#ACF7E1',
                        accent: '#6A5ACD'
                    },
                    {
                        primary: '#A18CD1',
                        primaryLight: '#C2A8FF',
                        secondary: '#FBC2EB',
                        secondaryLight: '#FFD1F9',
                        accent: '#FF6B6B'
                    },
                    {
                        primary: '#FF8C00',
                        primaryLight: '#FFC04D',
                        secondary: '#4ECDC4',
                        secondaryLight: '#92E3DD',
                        accent: '#9370DB'
                    },
                    {
                        primary: '#43CBFF',
                        primaryLight: '#9CEBFF',
                        secondary: '#9708CC',
                        secondaryLight: '#C174E8',
                        accent: '#FF5F6D'
                    }
                ];
                
                const theme = themes[this.settings.colorTheme - 1];
                document.documentElement.style.setProperty('--primary', theme.primary);
                document.documentElement.style.setProperty('--primary-light', theme.primaryLight);
                document.documentElement.style.setProperty('--secondary', theme.secondary);
                document.documentElement.style.setProperty('--secondary-light', theme.secondaryLight);
                document.documentElement.style.setProperty('--accent', theme.accent);
            }

            showScreen(screenId) {
                const screens = ['welcome-screen', 'adventure-map', 'lesson-screen', 'quiz-screen', 'practice-screen', 'settings-screen', 'achievements-screen'];
                
                screens.forEach(screen => {
                    document.getElementById(screen).classList.add('hidden');
                    document.getElementById(screen).classList.remove('visible');
                });
                
                document.getElementById(screenId).classList.remove('hidden');
                document.getElementById(screenId).classList.add('visible');
                
                this.currentScreen = screenId;
                
                if (screenId === 'adventure-map') {
                    this.updateMapNodes();
                }
                
                if (screenId === 'achievements-screen') {
                    this.updateAchievements();
                }
            }

            updateMapNodes() {
                document.querySelectorAll('.map-node').forEach(node => {
                    const level = parseInt(node.dataset.level);
                    
                    if (this.unlockedLevels.includes(level)) {
                        node.classList.remove('locked');
                    } else {
                        node.classList.add('locked');
                    }
                    
                    if (this.userProgress.completedLessons.includes(level)) {
                        node.classList.add('completed');
                    } else {
                        node.classList.remove('completed');
                    }
                });
            }

            selectLevel(level) {
                this.currentLevel = level;
                this.showLessonContent();
            }

            showLessonContent() {
                const lesson = this.lessons.find(l => l.level === this.currentLevel);
                if (!lesson) return;
                
                this.currentLessonPage = 0;
                this.renderLessonPage();
                this.showScreen('lesson-screen');
                
                this.showCharacterSpeech('maestro', `Welcome to ${lesson.title}! Let's learn something new!`);
            }

            renderLessonPage() {
                const lesson = this.lessons.find(l => l.level === this.currentLevel);
                if (!lesson) return;
                
                const page = lesson.pages[this.currentLessonPage];
                
                document.querySelector('#lesson-screen h2').textContent = page.title;
                document.getElementById('lesson-body').innerHTML = page.content;
                
                // Update navigation buttons
                if (this.currentLessonPage === 0) {
                    document.getElementById('prev-lesson').style.visibility = 'hidden';
                } else {
                    document.getElementById('prev-lesson').style.visibility = 'visible';
                }
                
                if (this.currentLessonPage === lesson.pages.length - 1) {
                    document.getElementById('next-lesson').textContent = 'Continue to Quiz';
                } else {
                    document.getElementById('next-lesson').textContent = 'Next';
                }
            }

            navigateLesson(direction) {
                const lesson = this.lessons.find(l => l.level === this.currentLevel);
                if (!lesson) return;
                
                this.currentLessonPage += direction;
                
                if (this.currentLessonPage < 0) {
                    this.currentLessonPage = 0;
                }
                
                if (this.currentLessonPage >= lesson.pages.length) {
                    // Move to quiz if we've reached the end of the lesson
                    this.startQuiz();
                    return;
                }
                
                this.renderLessonPage();
            }

            startQuiz() {
                const quiz = this.quizzes.find(q => q.level === this.currentLevel);
                if (!quiz) return;
                
                this.currentQuizQuestion = 0;
                this.quizScore = 0;
                this.renderQuizQuestion();
                this.showScreen('quiz-screen');
                
                this.showCharacterSpeech('beato', "Time for a quiz! Let's see what you've learned!");
            }

            renderQuizQuestion() {
                const quiz = this.quizzes.find(q => q.level === this.currentLevel);
                if (!quiz) return;
                
                const question = quiz.questions[this.currentQuizQuestion];
                document.getElementById('quiz-question-text').textContent = question.question;
                
                const optionsContainer = document.getElementById('quiz-options');
                optionsContainer.innerHTML = '';
                
                question.options.forEach((option, index) => {
                    const optionEl = document.createElement('div');
                    optionEl.className = 'quiz-option';
                    optionEl.textContent = option;
                    optionEl.dataset.index = index;
                    optionEl.addEventListener('click', () => this.selectQuizOption(index));
                    optionsContainer.appendChild(optionEl);
                });
                
                document.getElementById('quiz-feedback').textContent = '';
                document.getElementById('submit-quiz').disabled = true;
                
                this.selectedQuizOption = null;
            }

            selectQuizOption(index) {
                document.querySelectorAll('.quiz-option').forEach(option => {
                    option.classList.remove('selected');
                });
                
                document.querySelectorAll('.quiz-option')[index].classList.add('selected');
                document.getElementById('submit-quiz').disabled = false;
                
                this.selectedQuizOption = index;
            }

            submitQuizAnswer() {
                if (this.selectedQuizOption === null) return;
                
                const quiz = this.quizzes.find(q => q.level === this.currentLevel);
                const question = quiz.questions[this.currentQuizQuestion];
                
                const isCorrect = this.selectedQuizOption === question.answer;
                
                const feedbackEl = document.getElementById('quiz-feedback');
                if (isCorrect) {
                    feedbackEl.textContent = "Correct! Great job!";
                    feedbackEl.style.color = 'var(--success)';
                    this.quizScore++;
                    this.createConfetti(10);
                } else {
                    feedbackEl.textContent = "Not quite. The correct answer is: " + question.options[question.answer];
                    feedbackEl.style.color = 'var(--error)';
                }
                
                setTimeout(() => {
                    this.currentQuizQuestion++;
                    
                    if (this.currentQuizQuestion >= quiz.questions.length) {
                        // Quiz is complete
                        this.finishQuiz();
                    } else {
                        this.renderQuizQuestion();
                    }
                }, 2000);
            }

            finishQuiz() {
                const quiz = this.quizzes.find(q => q.level === this.currentLevel);
                const percentage = Math.round((this.quizScore / quiz.questions.length) * 100);
                
                // Save quiz score
                this.userProgress.quizScores[this.currentLevel] = percentage;
                
                // Show level complete modal
                document.getElementById('level-complete-message').textContent = `You scored ${percentage}% on the quiz!`;
                document.getElementById('level-complete-modal').classList.add('active');
                
                if (percentage >= 80) {
                    this.showCharacterSpeech('maestro', "Excellent work! You're a musical genius!");
                    this.createConfetti(30);
                    
                    // Mark level as completed
                    if (!this.userProgress.completedLessons.includes(this.currentLevel)) {
                        this.userProgress.completedLessons.push(this.currentLevel);
                    }
                } else {
                    this.showCharacterSpeech('beato', "You're learning! Try again to get an even better score!");
                }
            }

            unlockNextLevel() {
                const nextLevel = this.currentLevel + 1;
                if (!this.unlockedLevels.includes(nextLevel) && nextLevel <= 9) {
                    this.unlockedLevels.push(nextLevel);
                    this.showCharacterSpeech('maestro', `You've unlocked Level ${nextLevel}!`);
                }
            }

            startPracticeSession() {
                // Set up piano keys
                this.setupPiano();
                
                // Try to initialize audio (wrapped in try-catch to handle potential issues)
                try {
                    this.initAudioContext();
                    
                    // If using Tone.js, ensure it's started
                    if (typeof Tone !== 'undefined' && Tone.context.state !== 'running') {
                        Tone.start();
                    }
                } catch (e) {
                    console.warn("Audio initialization issue in practice session:", e);
                    // We'll continue with visual-only mode
                }
                
                // Reset practice statistics
                this.practiceScore = 0;
                this.practiceTime = 30; // 30 seconds practice
                this.practiceTotalNotes = 10;
                this.practiceNotesHit = 0;
                
                // Update UI
                document.getElementById('practice-score').textContent = this.practiceScore;
                document.getElementById('practice-progress').style.width = `${(this.practiceNotesHit / this.practiceTotalNotes) * 100}%`;
                
                // Generate first note to play
                this.generateNewNote();
                this.startListening();
                
                // Update button visibility
                document.getElementById('start-practice').style.display = 'none';
                document.getElementById('end-practice').style.display = 'inline-block';
                
                // Display character speech bubble
                this.showCharacterSpeech('beato', "Let's practice! Play the notes when they appear!");
                
                console.log("Practice session started successfully");
            }

            setupPiano() {
                const pianoContainer = document.getElementById('piano-container');
                pianoContainer.innerHTML = '';
                
                const notes = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
                const octave = 4; // Middle C octave
                
                for (let i = 0; i < notes.length; i++) {
                    const key = document.createElement('div');
                    key.className = 'piano-key';
                    key.dataset.note = notes[i] + octave;
                    key.dataset.index = i;
                    key.innerHTML = `<div style="position: absolute; bottom: 10px; width: 100%; text-align: center;">${notes[i]}</div>`;
                    
                    key.addEventListener('click', () => this.pianoKeyClicked(notes[i] + octave));
                    
                    pianoContainer.appendChild(key);
                    
                    // Add black keys (except between E-F and B-C)
                    if (i !== 2 && i !== 6) {
                        const blackKey = document.createElement('div');
                        blackKey.className = 'piano-key black';
                        blackKey.style.left = `${(i + 0.5) * (100 / notes.length)}%`;
                        blackKey.dataset.note = notes[i] + '#' + octave;
                        
                        blackKey.addEventListener('click', () => this.pianoKeyClicked(notes[i] + '#' + octave));
                        
                        pianoContainer.appendChild(blackKey);
                    }
                }
            }

            pianoKeyClicked(note) {
                // Simulate playing a note
                this.playNote(note);
                
                // Check if it matches the target note
                if (note === this.currentNote) {
                    this.practiceScore += 10;
                    document.getElementById('practice-score').textContent = this.practiceScore;
                    
                    this.practiceNotesHit++;
                    document.getElementById('practice-progress').style.width = `${(this.practiceNotesHit / this.practiceTotalNotes) * 100}%`;
                    
                    this.showCharacterSpeech('maestro', "Great job! That's correct!", 1000);
                    this.createConfetti(5);
                    
                    if (this.practiceNotesHit >= this.practiceTotalNotes) {
                        this.completePractice();
                    } else {
                        this.generateNewNote();
                    }
                } else {
                    this.showCharacterSpeech('beato', "Not quite! Try again.", 1000);
                    
                    // Highlight the correct key
                    const correctKey = Array.from(document.querySelectorAll('.piano-key')).find(key => key.dataset.note === this.currentNote);
                    if (correctKey) {
                        correctKey.classList.add('highlight');
                        setTimeout(() => correctKey.classList.remove('highlight'), 1000);
                    }
                }
            }

            generateNewNote() {
                const notes = ['C4', 'D4', 'E4', 'F4', 'G4', 'A4', 'B4'];
                const randomIndex = Math.floor(Math.random() * notes.length);
                this.currentNote = notes[randomIndex];
                
                document.getElementById('note-to-play').textContent = this.currentNote.charAt(0);
                
                // Clear all highlights
                document.querySelectorAll('.piano-key').forEach(key => {
                    key.classList.remove('highlight');
                });
            }

            completePractice() {
                this.stopListening();
                
                document.getElementById('level-complete-message').textContent = `You scored ${this.practiceScore} points in practice!`;
                document.getElementById('level-complete-modal').classList.add('active');
                
                document.getElementById('start-practice').style.display = 'inline-block';
                document.getElementById('end-practice').style.display = 'none';
                
                this.showCharacterSpeech('maestro', "Fantastic practice session! You're becoming a true musician!");
                this.createConfetti(20);
                
                // Update user progress
                this.userProgress.practiceScores[this.currentLevel] = Math.max(this.userProgress.practiceScores[this.currentLevel] || 0, this.practiceScore);
                this.userProgress.notesPlayed += this.practiceTotalNotes;
                this.userProgress.correctNotes += this.practiceNotesHit;
                
                this.checkAchievements();
            }

            endPracticeSession() {
                this.stopListening();
                
                document.getElementById('start-practice').style.display = 'inline-block';
                document.getElementById('end-practice').style.display = 'none';
                
                this.showCharacterSpeech('beato', "Practice makes perfect! Come back soon!");
                
                // Update user progress
                this.userProgress.notesPlayed += this.practiceNotesHit;
                this.userProgress.correctNotes += this.practiceNotesHit;
                
                this.checkAchievements();
            }

            initAudioContext() {
                if (this.audioContext) return;
                
                try {
                    // Use Tone.js instead of raw Web Audio API for better compatibility
                    if (typeof Tone !== 'undefined') {
                        // Tone.js is available
                        Tone.start();
                        this.audioContext = Tone.context;
                        console.log("Tone.js audio context initialized successfully");
                    } else {
                        // Fallback to standard Web Audio API
                        const AudioContext = window.AudioContext || window.webkitAudioContext;
                        this.audioContext = new AudioContext();
                        console.log("Standard audio context initialized successfully");
                    }
                    
                    // Create basic analyzer
                    this.analyser = this.audioContext.createAnalyser();
                    this.analyser.fftSize = 1024; // Smaller FFT size to avoid performance issues
                    
                    // For demonstration purposes, we'll use simulated microphone input
                    // In a real application, you would implement actual microphone access
                } catch (e) {
                    console.error("Audio initialization error:", e);
                    // Set a flag so we can provide fallback behavior
                    this.audioAvailable = false;
                }
            }

            startListening() {
                this.isListening = true;
                // In a real implementation, this would start analyzing microphone input
            }

            stopListening() {
                this.isListening = false;
                // In a real implementation, this would stop analyzing microphone input
            }

            playNote(note) {
                try {
                    // Initialize audio context if not already created
                    if (!this.audioContext) {
                        this.initAudioContext();
                    }
                    
                    // Map note to frequency (simplified for demo)
                    const noteToFreq = {
                        'C4': 261.63, 'C#4': 277.18, 'D4': 293.66, 'D#4': 311.13, 'E4': 329.63,
                        'F4': 349.23, 'F#4': 369.99, 'G4': 392.00, 'G#4': 415.30, 'A4': 440.00,
                        'A#4': 466.16, 'B4': 493.88
                    };
                    
                    const freq = noteToFreq[note] || 440;
                    
                    // Use Tone.js if available (more reliable across browsers)
                    if (typeof Tone !== 'undefined') {
                        // Make sure Tone.js is started (needed for audio playback)
                        if (Tone.context.state !== 'running') {
                            Tone.start();
                        }
                        
                        // Create and configure a synth
                        const synth = new Tone.Synth({
                            oscillator: {
                                type: 'sine'
                            },
                            envelope: {
                                attack: 0.005,
                                decay: 0.1,
                                sustain: 0.3,
                                release: 0.8
                            }
                        }).toDestination();
                        
                        // Play the note
                        synth.triggerAttackRelease(note, '0.8s');
                        console.log(`Playing note with Tone.js: ${note}`);
                    } 
                    // Fallback to basic Web Audio API if Tone.js is not available
                    else if (this.audioContext) {
                        // Resume audio context if it's suspended (browser autoplay policy)
                        if (this.audioContext.state === 'suspended') {
                            this.audioContext.resume();
                        }
                        
                        // Create audio nodes
                        const oscillator = this.audioContext.createOscillator();
                        const gainNode = this.audioContext.createGain();
                        
                        // Configure oscillator
                        oscillator.type = 'sine';
                        oscillator.frequency.setValueAtTime(freq, this.audioContext.currentTime);
                        
                        // Configure amplitude envelope
                        gainNode.gain.setValueAtTime(0.3, this.audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 1);
                        
                        // Connect audio graph
                        oscillator.connect(gainNode);
                        gainNode.connect(this.audioContext.destination);
                        
                        // Play sound
                        oscillator.start();
                        oscillator.stop(this.audioContext.currentTime + 1);
                        
                        console.log(`Playing note with Web Audio API: ${note} at frequency: ${freq} Hz`);
                    } else {
                        console.log("Audio is not available - visual feedback only");
                    }
                    
                    // Always provide visual feedback, even if audio fails
                    const pianoKey = Array.from(document.querySelectorAll('.piano-key')).find(key => key.dataset.note === note);
                    if (pianoKey) {
                        // Add visual feedback
                        pianoKey.classList.add('highlight');
                        setTimeout(() => pianoKey.classList.remove('highlight'), 500);
                    }
                } catch (error) {
                    console.error("Error playing note:", error);
                    
                    // Still provide visual feedback even if audio fails
                    const pianoKey = Array.from(document.querySelectorAll('.piano-key')).find(key => key.dataset.note === note);
                    if (pianoKey) {
                        pianoKey.classList.add('highlight');
                        setTimeout(() => pianoKey.classList.remove('highlight'), 500);
                    }
                }
            }

            checkAchievements() {
                const completedLevels = this.userProgress.completedLessons.length;
                const notesPlayed = this.userProgress.notesPlayed;
                const correctNotes = this.userProgress.correctNotes;
                
                const achievements = document.querySelectorAll('.achievement-card');
                
                // Note Master
                if (completedLevels >= 1) {
                    achievements[0].classList.remove('locked');
                }
                
                // Rhythm Wizard
                if (correctNotes >= 20 && (correctNotes / notesPlayed) >= 0.9) {
                    achievements[1].classList.remove('locked');
                }
                
                // Piano Prodigy
                if (correctNotes >= 50) {
                    achievements[2].classList.remove('locked');
                }
                
                // Theory Champion
                const perfectQuizzes = Object.values(this.userProgress.quizScores).filter(score => score === 100).length;
                if (perfectQuizzes >= 3) {
                    achievements[3].classList.remove('locked');
                }
                
                // Scale Explorer
                if (completedLevels >= 3) {
                    achievements[4].classList.remove('locked');
                }
                
                // Musical Genius
                if (completedLevels >= 9) {
                    achievements[5].classList.remove('locked');
                }
            }

            updateAchievements() {
                this.checkAchievements();
            }

            createConfetti(count) {
                const confettiContainer = document.body;
                const colors = ['#FF9A8B', '#74EBD5', '#6A5ACD', '#FFEB3B', '#4CAF50'];
                
                for (let i = 0; i < count; i++) {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.left = `${Math.random() * 100}%`;
                    confetti.style.animationDuration = `${Math.random() * 3 + 2}s`;
                    
                    confettiContainer.appendChild(confetti);
                    
                    setTimeout(() => {
                        confetti.remove();
                    }, 5000);
                }
            }

            saveSettings() {
                // In a real application, you might save to localStorage or a server
                console.log('Settings saved:', this.settings);
                
                this.showCharacterSpeech('maestro', "Your settings have been saved!");
            }

            showTutorial() {
                this.showCharacterSpeech('maestro', "Welcome to Musical Maestro's Adventure! Click on the map to start learning music!");
                setTimeout(() => {
                    this.showCharacterSpeech('beato', "Practice your piano skills, learn about notes, and become a musical genius!");
                }, 3000);
            }
        }

        // Start the application when the DOM is loaded
        // Wait for the window to fully load before initializing
window.addEventListener('load', () => {
    try {
        // Create a button to enable audio (needed for browsers with strict autoplay policies)
        const audioSetupContainer = document.createElement('div');
        audioSetupContainer.style.position = 'fixed';
        audioSetupContainer.style.top = '10px';
        audioSetupContainer.style.left = '10px';
        audioSetupContainer.style.zIndex = '1000';
        
        const audioSetupButton = document.createElement('button');
        audioSetupButton.textContent = 'üîä Enable Sound';
        audioSetupButton.style.padding = '10px';
        audioSetupButton.style.borderRadius = '10px';
        audioSetupButton.style.background = '#6A5ACD';
        audioSetupButton.style.color = 'white';
        audioSetupButton.style.border = 'none';
        audioSetupButton.style.cursor = 'pointer';
        
        audioSetupContainer.appendChild(audioSetupButton);
        document.body.appendChild(audioSetupContainer);
        
        // Initialize the application
        const app = new MusicalMaestro();
        console.log('Application initialized successfully');
        
        // Set up audio when button is clicked
        audioSetupButton.addEventListener('click', () => {
            // Try to initialize Tone.js
            if (typeof Tone !== 'undefined') {
                Tone.start().then(() => {
                    console.log('Tone.js started successfully');
                    audioSetupButton.textContent = 'üîä Sound Enabled';
                    audioSetupButton.style.background = '#4CAF50';
                    
                    // Play a short sound to confirm audio is working
                    const synth = new Tone.Synth().toDestination();
                    synth.triggerAttackRelease('C4', '0.1');
                    
                    // Hide the button after a delay
                    setTimeout(() => {
                        audioSetupContainer.style.opacity = '0';
                        audioSetupContainer.style.transition = 'opacity 1s';
                        setTimeout(() => {
                            audioSetupContainer.remove();
                        }, 1000);
                    }, 2000);
                }).catch(e => {
                    console.error('Failed to start Tone.js:', e);
                    audioSetupButton.textContent = '‚ö†Ô∏è Sound Failed';
                    audioSetupButton.style.background = '#F44336';
                });
            } else {
                // Fallback to standard Web Audio API
                try {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    const audioCtx = new AudioContext();
                    
                    // Play a short beep
                    const oscillator = audioCtx.createOscillator();
                    const gainNode = audioCtx.createGain();
                    oscillator.connect(gainNode);
                    gainNode.connect(audioCtx.destination);
                    oscillator.frequency.value = 440;
                    gainNode.gain.value = 0.1;
                    oscillator.start();
                    oscillator.stop(audioCtx.currentTime + 0.1);
                    
                    audioSetupButton.textContent = 'üîä Sound Enabled';
                    audioSetupButton.style.background = '#4CAF50';
                    
                    // Hide the button after a delay
                    setTimeout(() => {
                        audioSetupContainer.style.opacity = '0';
                        audioSetupContainer.style.transition = 'opacity 1s';
                        setTimeout(() => {
                            audioSetupContainer.remove();
                        }, 1000);
                    }, 2000);
                } catch (e) {
                    console.error('Failed to initialize Web Audio API:', e);
                    audioSetupButton.textContent = '‚ö†Ô∏è Sound Failed';
                    audioSetupButton.style.background = '#F44336';
                }
            }
        });
    } catch (error) {
        console.error('Error initializing application:', error);
        // Show error message to user
        const errorMsg = document.createElement('div');
        errorMsg.style.position = 'fixed';
        errorMsg.style.top = '50%';
        errorMsg.style.left = '50%';
        errorMsg.style.transform = 'translate(-50%, -50%)';
        errorMsg.style.background = 'rgba(244, 67, 54, 0.9)';
        errorMsg.style.color = 'white';
        errorMsg.style.padding = '20px';
        errorMsg.style.borderRadius = '10px';
        errorMsg.style.zIndex = '9999';
        errorMsg.innerHTML = `<h3>Oops! Something went wrong</h3><p>Error details: ${error.message}</p><p>Try refreshing the page.</p>`;
        document.body.appendChild(errorMsg);
    }
});
    </script>
</body>
</html>